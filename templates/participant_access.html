{% extends "base.html" %}

{% block title %}Acceso Participante - Assessment Platform{% endblock %}

{% block extra_css %}
<style>
    .evaluation-container {
        min-height: calc(100vh - 200px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem 0;
    }

    .evaluation-card {
        background: var(--glass-card);
        backdrop-filter: var(--glass-backdrop);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-strong);
        overflow: hidden;
        max-width: 480px;
        width: 100%;
    }

    .evaluation-header {
        background: linear-gradient(135deg, var(--calm-primary), var(--calm-primary-hover));
        padding: 2.5rem 2rem;
        text-align: center;
        color: var(--pure-white);
        position: relative;
    }

    .evaluation-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
    }

    .evaluation-header .icon-wrapper {
        width: 80px;
        height: 80px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        backdrop-filter: blur(10px);
        position: relative;
        z-index: 1;
    }

    .evaluation-header i {
        font-size: 2.5rem;
        color: var(--pure-white);
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .evaluation-header h2 {
        font-weight: 700;
        margin-bottom: 0.5rem;
        position: relative;
        z-index: 1;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .evaluation-header p {
        opacity: 0.9;
        margin: 0;
        font-size: 1.05rem;
        position: relative;
        z-index: 1;
        font-weight: 500;
    }

    .evaluation-body {
        padding: 2.5rem 2rem;
        background: rgba(255, 255, 255, 0.05);
    }

    .process-info {
        background: rgba(255, 255, 255, 0.1);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin-bottom: 2rem;
        border-left: 4px solid var(--calm-primary);
        backdrop-filter: blur(10px);
    }

    .process-info h4 {
        color: var(--pure-white);
        font-weight: 600;
        margin-bottom: 1rem;
        font-size: 1.1rem;
    }

    .process-steps {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .process-steps li {
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.95rem;
    }

    .process-steps li i {
        color: var(--calm-primary);
        margin-right: 0.75rem;
        width: 16px;
    }

    .access-options {
        display: grid;
        gap: 1rem;
    }

    .access-option {
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.08);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: var(--radius-lg);
        text-align: center;
        transition: var(--transition-normal);
        cursor: pointer;
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(10px);
    }

    .access-option:hover {
        border-color: var(--calm-primary);
        transform: translateY(-2px);
        box-shadow: 0 8px 32px rgba(98, 130, 227, 0.25);
        background: rgba(255, 255, 255, 0.12);
    }

    .access-option.active {
        border-color: var(--calm-primary);
        background: rgba(98, 130, 227, 0.15);
    }

    .access-option h5 {
        color: var(--pure-white);
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
    }

    .access-option p {
        color: var(--medium-gray);
        margin: 0;
        font-size: 0.9rem;
    }

    .form-section {
        margin-top: 1.5rem;
        display: none;
    }

    .form-section.active {
        display: block;
        animation: fadeInUp 0.3s ease;
    }

    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .form-floating {
        margin-bottom: 1.5rem;
    }

    .form-floating .form-control {
        border: 2px solid rgba(167, 215, 197, 0.3);
        border-radius: 12px;
        height: 58px;
        font-size: 1rem;
    }

    .form-floating .form-control:focus {
        border-color: var(--primary-mint);
        box-shadow: 0 0 0 0.2rem rgba(92, 219, 149, 0.25);
    }

    .form-floating label {
        color: var(--medium-gray);
        font-weight: 500;
    }

    .submit-btn {
        width: 100%;
        padding: 1rem;
        border-radius: 25px;
        font-weight: 600;
        background: linear-gradient(135deg, var(--primary-mint), var(--primary-sky));
        border: none;
        color: var(--dark-gray);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        font-size: 1.05rem;
    }

    .submit-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.6s;
    }

    .submit-btn:hover::before {
        left: 100%;
    }

    .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 32px rgba(92, 219, 149, 0.3);
    }

    .back-link {
        text-align: center;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid rgba(167, 215, 197, 0.2);
    }

    .back-link a {
        color: var(--medium-gray);
        text-decoration: none;
        font-weight: 500;
        transition: color 0.3s ease;
    }

    .back-link a:hover {
        color: var(--primary-mint);
    }

    /* Responsive */
    @media (max-width: 576px) {
        .evaluation-container {
            padding: 1rem;
        }
        
        .evaluation-header {
            padding: 2rem 1.5rem;
        }
        
        .evaluation-body {
            padding: 2rem 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="evaluation-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-sm-10 col-md-8 col-lg-6">
                <div class="evaluation-card fade-in">
                    <div class="evaluation-header">
                        <div class="icon-wrapper">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <h2>Evaluación de Asertividad</h2>
                        <p>Inicia tu journey de desarrollo personal y comunicativo</p>
                    </div>
                    
                    <div class="evaluation-body">
                        <!-- Process Information -->
                        <div class="process-info">
                            <h4><i class="fas fa-info-circle me-2"></i>¿Qué incluye la evaluación?</h4>
                            <ul class="process-steps">
                                <li><i class="fas fa-check"></i>10 preguntas especializadas en asertividad</li>
                                <li><i class="fas fa-check"></i>Análisis detallado de tus fortalezas</li>
                                <li><i class="fas fa-check"></i>Recomendaciones personalizadas</li>
                                <li><i class="fas fa-check"></i>Gráficos interactivos de resultados</li>
                                <li><i class="fas fa-check"></i>Seguimiento de tu progreso</li>
                            </ul>
                        </div>

                        <!-- Demo Credentials Info -->
                        <div class="process-info" style="border-left-color: var(--calm-accent); background: rgba(160, 216, 204, 0.05);">
                            <h4><i class="fas fa-play-circle me-2"></i>Credenciales de Demo</h4>
                            <ul class="process-steps">
                                <li><i class="fas fa-user-circle"></i><strong>Email:</strong> coachee@assessment.com</li>
                                <li><i class="fas fa-key"></i><strong>Contraseña:</strong> coachee123</li>
                            </ul>
                            <button type="button" class="btn btn-sm btn-outline-success mt-2" id="fillDemoCredentials">
                                <i class="fas fa-magic me-1"></i>Usar credenciales de demo
                            </button>
                        </div>

                        <!-- Access Options -->
                        <div class="access-options">
                            <div class="access-option" data-option="existing">
                                <h5><i class="fas fa-user me-2"></i>Ya tengo una cuenta</h5>
                                <p>Accede con tu email y contraseña existente</p>
                            </div>
                            
                            <div class="access-option" data-option="new">
                                <h5><i class="fas fa-user-plus me-2"></i>Crear nueva cuenta</h5>
                                <p>Regístrate para comenzar tu primera evaluación</p>
                            </div>
                            
                            <div class="access-option" data-option="invitation">
                                <h5><i class="fas fa-ticket-alt me-2"></i>Tengo un código de invitación</h5>
                                <p>Acceso directo con código de tu coach</p>
                            </div>
                        </div>

                        <!-- Login Form (Existing User) -->
                        <div class="form-section" id="existingForm">
                            <form id="existingUserForm">
                                <div class="form-floating">
                                    <input type="email" class="form-control" id="loginEmail" name="email" placeholder="Email" required>
                                    <label for="loginEmail"><i class="fas fa-envelope me-2"></i>Email</label>
                                </div>
                                
                                <div class="form-floating">
                                    <input type="password" class="form-control" id="loginPassword" name="password" placeholder="Contraseña" required>
                                    <label for="loginPassword"><i class="fas fa-lock me-2"></i>Contraseña</label>
                                </div>
                                
                                <button type="submit" class="submit-btn">
                                    <i class="fas fa-sign-in-alt me-2"></i>
                                    Iniciar Evaluación
                                </button>
                            </form>
                        </div>

                        <!-- Registration Form (New User) -->
                        <div class="form-section" id="newForm">
                            <form id="newUserForm">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="fullName" name="fullName" placeholder="Nombre completo" required>
                                    <label for="fullName"><i class="fas fa-user me-2"></i>Nombre completo</label>
                                </div>
                                
                                <div class="form-floating">
                                    <input type="email" class="form-control" id="regEmail" name="email" placeholder="Email" required>
                                    <label for="regEmail"><i class="fas fa-envelope me-2"></i>Email</label>
                                </div>
                                
                                <div class="form-floating">
                                    <input type="password" class="form-control" id="regPassword" name="password" placeholder="Contraseña" required>
                                    <label for="regPassword"><i class="fas fa-lock me-2"></i>Contraseña</label>
                                </div>
                                
                                <button type="submit" class="submit-btn">
                                    <i class="fas fa-rocket me-2"></i>
                                    Crear Cuenta y Comenzar
                                </button>
                            </form>
                        </div>

                        <!-- Invitation Form -->
                        <div class="form-section" id="invitationForm">
                            <form id="invitationUserForm">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="invitationCode" name="invitationCode" placeholder="Código de invitación" required>
                                    <label for="invitationCode"><i class="fas fa-ticket-alt me-2"></i>Código de invitación</label>
                                </div>
                                
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="invFullName" name="fullName" placeholder="Nombre completo" required>
                                    <label for="invFullName"><i class="fas fa-user me-2"></i>Nombre completo</label>
                                </div>
                                
                                <div class="form-floating">
                                    <input type="email" class="form-control" id="invEmail" name="email" placeholder="Email" required>
                                    <label for="invEmail"><i class="fas fa-envelope me-2"></i>Email</label>
                                </div>
                                
                                <div class="form-floating">
                                    <input type="password" class="form-control" id="invPassword" name="password" placeholder="Contraseña" required>
                                    <label for="invPassword"><i class="fas fa-lock me-2"></i>Contraseña</label>
                                </div>
                                
                                <button type="submit" class="submit-btn">
                                    <i class="fas fa-user-check me-2"></i>
                                    Registrarse con Invitación
                                </button>
                            </form>
                        </div>
                        
                        <div class="back-link">
                            <a href="{{ url_for('dashboard_selection') }}">
                                <i class="fas fa-arrow-left me-2"></i>Volver a selección de acceso
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const accessOptions = document.querySelectorAll('.access-option');
    const formSections = document.querySelectorAll('.form-section');
    
    // Handle access option selection
    accessOptions.forEach(option => {
        option.addEventListener('click', function() {
            const selectedOption = this.dataset.option;
            
            // Remove active class from all options
            accessOptions.forEach(opt => opt.classList.remove('active'));
            
            // Add active class to selected option
            this.classList.add('active');
            
            // Hide all form sections
            formSections.forEach(form => {
                form.classList.remove('active');
            });
            
            // Show corresponding form
            const targetForm = document.getElementById(selectedOption + 'Form');
            if (targetForm) {
                targetForm.classList.add('active');
            }
        });
    });
    
    // Handle existing user login
    document.getElementById('existingUserForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await handleFormSubmission(this, '/api/login', 'Iniciando sesión...');
    });
    
    // Handle new user registration
    document.getElementById('newUserForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = {
            full_name: formData.get('fullName'),
            email: formData.get('email'),
            password: formData.get('password')
        };
        await handleFormSubmission(this, '/api/register', 'Creando cuenta...', data);
    });
    
    // Handle invitation registration
    document.getElementById('invitationUserForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = {
            full_name: formData.get('fullName'),
            email: formData.get('email'),
            password: formData.get('password'),
            invitation_code: formData.get('invitationCode')
        };
        await handleFormSubmission(this, '/api/register', 'Registrando con invitación...', data);
    });
    
    async function handleFormSubmission(form, endpoint, loadingText, customData = null) {
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        console.log('🔄 Iniciando envío de formulario:', {
            endpoint,
            loadingText,
            customData
        });
        
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${loadingText}`;
        
        try {
            const formData = customData || Object.fromEntries(new FormData(form));
            
            console.log('📤 Enviando datos:', formData);
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });
            
            console.log('📥 Respuesta recibida:', {
                status: response.status,
                statusText: response.statusText,
                ok: response.ok
            });
            
            const result = await response.json();
            console.log('📋 Contenido de respuesta:', result);
            
            if (response.ok) {
                // Success
                submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>¡Acceso concedido!';
                submitBtn.style.background = 'var(--success-green)';
                
                showAlert('¡Perfecto! Redirigiendo a tu evaluación...', 'success');
                
                const redirectUrl = result.redirect || result.redirect_url || '/coachee-dashboard';
                console.log('🔄 Redirigiendo a:', redirectUrl);
                
                setTimeout(() => {
                    window.location.href = redirectUrl;
                }, 1500);
            } else {
                // Error
                console.error('❌ Error en respuesta:', result);
                submitBtn.style.background = 'var(--danger-red)';
                submitBtn.innerHTML = '<i class="fas fa-times me-2"></i>Error';
                
                showAlert(result.error || result.message || 'Ha ocurrido un error. Intenta nuevamente.', 'danger');
                
                setTimeout(() => {
                    resetButton(submitBtn, originalText);
                }, 2000);
            }
        } catch (error) {
            console.error('💥 Error de conexión:', error);
            submitBtn.style.background = 'var(--danger-red)';
            submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error de conexión';
            
            showAlert('Error de conexión. Por favor, intenta nuevamente.', 'danger');
            
            setTimeout(() => {
                resetButton(submitBtn, originalText);
            }, 2000);
        }
    }
    
    function resetButton(button, originalText) {
        button.disabled = false;
        button.style.background = '';
        button.innerHTML = originalText;
    }
    
    function showAlert(message, type) {
        // Remove existing alerts
        const existingAlerts = document.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());
        
        // Create new alert
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insert at the top of evaluation body
        const evaluationBody = document.querySelector('.evaluation-body');
        evaluationBody.insertBefore(alert, evaluationBody.firstChild);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }
    
    // Set default selection to existing user
    document.querySelector('.access-option[data-option="existing"]').click();
    
    // Handle demo credentials button
    document.getElementById('fillDemoCredentials').addEventListener('click', function() {
        // Make sure the existing user form is active
        document.querySelector('.access-option[data-option="existing"]').click();
        
        // Fill demo credentials
        document.getElementById('loginEmail').value = 'coachee@assessment.com';
        document.getElementById('loginPassword').value = 'coachee123';
        
        // Add visual feedback
        this.innerHTML = '<i class="fas fa-check me-1"></i>¡Credenciales listas!';
        this.classList.add('btn-success');
        this.classList.remove('btn-outline-success');
        
        // Reset button after 2 seconds
        setTimeout(() => {
            this.innerHTML = '<i class="fas fa-magic me-1"></i>Usar credenciales de demo';
            this.classList.remove('btn-success');
            this.classList.add('btn-outline-success');
        }, 2000);
    });
});
</script>
{% endblock %}
