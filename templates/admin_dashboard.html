<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InstaCoach - Admin</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Calm.com Color System - Matching Landing Page - VERSION 1756421317 */
        :root {
            /* Color Palette Inspired by Calm.com - Same as Landing */
            --calm-primary: #1E3A8A;        /* Deep Blue */
            --calm-secondary: #3B82F6;      /* Bright Blue */
            --calm-accent: #06B6D4;         /* Cyan */
            --calm-light: #EFF6FF;          /* Very Light Blue */
            --calm-dark: #1E293B;           /* Dark Slate */
            --calm-white: #FFFFFF;
            --calm-gray-50: #F8FAFC;
            --calm-gray-100: #F1F5F9;
            --calm-gray-600: #475569;
            --calm-gray-700: #334155;
            
            /* Admin specific mappings using new system */
            --admin-primary: #1E3A8A;        /* Same as calm-primary */
            --admin-secondary: #3B82F6;      /* Same as calm-secondary */
            --admin-success: #10B981;        /* Success green */
            --admin-info: #06B6D4;           /* Same as calm-accent */
            --admin-warning: #F59E0B;        /* Warning orange */
            --admin-danger: #EF4444;         /* Danger red */
            
            /* Background and surface colors */
            --calm-background: #F8FAFC;      /* Light gray background */
            --calm-surface: #FFFFFF;         /* Clean white surfaces */
            --calm-border: rgba(59, 130, 246, 0.3); /* Blue border */
            --calm-text-primary: #1E293B;    /* Dark slate text */
            --calm-text-secondary: #475569;  /* Gray secondary text */
            
            /* Gradients */
            --calm-gradient-primary: linear-gradient(135deg, #1E3A8A 0%, #3B82F6 100%);
            --calm-gradient-light: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
            --calm-gradient-accent: linear-gradient(135deg, #06B6D4 0%, #0284C7 100%);
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--calm-background);
            color: var(--calm-text-primary);
        }

        /* Header responsivo */
        .admin-header {
            background: var(--calm-gradient-primary);
            color: white;
            box-shadow: 0 2px 4px rgba(30, 58, 138, 0.15);
        }

        /* Stats cards responsivas */
        .stat-card {
            background: var(--calm-surface);
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(30, 58, 138, 0.1);
            border-left: 4px solid var(--admin-success);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.15);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--calm-primary);
            line-height: 1;
        }

        @media (max-width: 768px) {
            .stat-number {
                font-size: 2rem;
            }
        }

        /* Cards principales */
        .admin-card {
            background: var(--calm-surface);
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--calm-border);
        }

        /* Tablas responsivas */
        .table-responsive {
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .admin-table {
            margin-bottom: 0;
        }

        .admin-table th {
            background-color: var(--calm-background);
            font-weight: 600;
            color: var(--calm-text-primary);
            border-bottom: 2px solid var(--calm-border);
            font-size: 0.875rem;
        }

        .admin-table td {
            vertical-align: middle;
            font-size: 0.875rem;
        }

        /* Role badges responsivos */
        .role-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .role-admin {
            background-color: rgba(36, 52, 71, 0.1);
            color: var(--calm-text-primary);
        }

        .role-coach {
            background-color: rgba(74, 108, 133, 0.1);
            color: var(--calm-text-secondary);
        }

        .role-coachee {
            background-color: rgba(160, 216, 204, 0.1);
            color: var(--calm-text-primary);
        }

        .role-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* User Avatar */
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
            overflow: hidden;
            margin-right: 8px;
            vertical-align: middle;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Charts responsivos */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 250px;
            }
        }

        /* Form styles responsivos */
        .form-floating > label {
            padding: 1rem 0.75rem;
        }

        .btn-admin {
            background: linear-gradient(135deg, var(--admin-primary) 0%, #b02a37 100%);
            border: none;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-admin:hover {
            background: linear-gradient(135deg, #b02a37 0%, var(--admin-primary) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
            color: white;
        }

        .btn-admin-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            border: none;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-admin-secondary:hover {
            background: linear-gradient(135deg, #5a6268 0%, #6c757d 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
            color: white;
        }

        /* Loading states */
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--admin-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile optimizations */
        @media (max-width: 576px) {
            .container-fluid {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            .admin-card {
                margin-bottom: 1rem;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .d-flex.gap-2 {
                flex-direction: column;
            }
        }

        /* Accessibility improvements */
        .btn:focus,
        .form-control:focus,
        .form-select:focus {
            box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
            border-color: var(--admin-primary);
        }
    </style>
</head>
<body>
    <!-- Header responsivo -->
    <header class="admin-header">
        <div class="container-fluid">
            <div class="row align-items-center py-3">
                <div class="col-12 col-md-8">
                    <h1 class="h3 h2-md mb-0">
                        <i class="fas fa-shield-alt me-2"></i>
                        Panel de Administración
                    </h1>
                </div>
                <div class="col-12 col-md-4 text-md-end mt-2 mt-md-0">
                    <div class="d-flex align-items-center justify-content-md-end gap-2">
                        <span class="d-none d-sm-inline text-white-50">
                            <i class="fas fa-user-shield me-1"></i>
                            Administrador
                        </span>
                        <button class="btn btn-outline-light btn-sm" onclick="openEditProfileModal()">
                            <i class="fas fa-user-edit me-1"></i>
                            <span class="d-none d-sm-inline">Editar Perfil</span>
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="openChangePasswordModal()">
                            <i class="fas fa-key me-1"></i>
                            <span class="d-none d-sm-inline">Cambiar Contraseña</span>
                        </button>
                        <button onclick="adminLogout()" class="btn btn-outline-light btn-sm">
                            <i class="fas fa-sign-out-alt me-1"></i>
                            <span class="d-none d-sm-inline">Cerrar Sesión</span>
                            <span class="d-sm-none">Salir</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main content -->
    <main class="container-fluid py-4">
        
        <!-- Estadísticas Generales - Grid responsivo -->
        <div class="row g-3 g-md-4 mb-4">
            <div class="col-6 col-lg-3">
                <div class="stat-card p-3 p-md-4 h-100">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="stat-number" id="totalUsers">-</div>
                            <div class="text-muted small fw-medium">Total Usuarios</div>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-users fa-2x text-primary opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-6 col-lg-3">
                <div class="stat-card p-3 p-md-4 h-100">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="stat-number" id="totalCoaches">-</div>
                            <div class="text-muted small fw-medium">Coaches</div>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-user-tie fa-2x text-info opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-6 col-lg-3">
                <div class="stat-card p-3 p-md-4 h-100">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="stat-number" id="totalCoachees">-</div>
                            <div class="text-muted small fw-medium">Coachees</div>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-user-friends fa-2x text-success opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-6 col-lg-3">
                <div class="stat-card p-3 p-md-4 h-100">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="stat-number" id="totalAssessments">-</div>
                            <div class="text-muted small fw-medium">Evaluaciones</div>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-chart-bar fa-2x text-warning opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Principal - Grid responsivo -->
        <div class="row g-3 g-md-4 mb-4">
            <!-- Lista de Usuarios -->
            <div class="col-12 col-xl-8">
                <div class="admin-card p-3 p-md-4 h-100">
                    <div class="d-flex align-items-center mb-3">
                        <h2 class="h4 mb-0 flex-grow-1">
                            <i class="fas fa-users text-primary me-2"></i>
                            Usuarios del Sistema
                        </h2>
                        <button class="btn btn-outline-primary btn-sm" onclick="loadUsers()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <div id="usersTable">
                            <div class="text-center py-4 text-muted">
                                <div class="loading-spinner me-2"></div>
                                Cargando usuarios...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Actividad -->
            <div class="col-12 col-xl-4">
                <div class="admin-card p-3 p-md-4 h-100">
                    <h2 class="h4 mb-3">
                        <i class="fas fa-chart-pie text-primary me-2"></i>
                        Distribución
                    </h2>
                    <div class="chart-container">
                        <canvas id="userDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gestión de Coaches - Completamente responsiva -->
        <div class="admin-card p-3 p-md-4 mb-4">
            <h2 class="h4 mb-4">
                <i class="fas fa-user-tie text-primary me-2"></i>
                Gestión de Coaches
            </h2>
            
            <!-- Formulario para crear nuevo coach - Mobile optimized -->
            <div class="bg-light rounded-3 p-3 p-md-4 mb-4">
                <h3 class="h5 mb-3 text-primary">
                    <i class="fas fa-plus-circle me-2"></i>
                    Crear Nuevo Coach
                </h3>
                
                <form id="createCoachForm">
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <div class="form-floating">
                                <input type="text" id="coachUsername" class="form-control" placeholder="Username" required>
                                <label for="coachUsername">
                                    <i class="fas fa-user me-1 text-muted"></i>
                                    Nombre de Usuario
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-12 col-md-6">
                            <div class="form-floating">
                                <input type="email" id="coachEmail" class="form-control" placeholder="Email" required>
                                <label for="coachEmail">
                                    <i class="fas fa-envelope me-1 text-muted"></i>
                                    Email
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-12 col-md-6">
                            <div class="form-floating">
                                <input type="text" id="coachFullName" class="form-control" placeholder="Nombre Completo" required>
                                <label for="coachFullName">
                                    <i class="fas fa-id-card me-1 text-muted"></i>
                                    Nombre Completo
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-12 col-md-6">
                            <div class="input-group">
                                <div class="form-floating flex-grow-1">
                                    <input type="password" id="coachPassword" class="form-control" placeholder="Contraseña" required minlength="6">
                                    <label for="coachPassword">
                                        <i class="fas fa-lock me-1 text-muted"></i>
                                        Contraseña
                                    </label>
                                </div>
                                <button type="button" class="btn btn-outline-secondary" onclick="generateRandomPassword()" title="Generar contraseña aleatoria">
                                    <i class="fas fa-dice"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <div class="d-grid">
                                <button type="submit" class="btn btn-admin btn-lg">
                                    <i class="fas fa-plus-circle me-2"></i>
                                    Crear Coach
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Lista de coaches existentes - Responsive table -->
            <div>
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h3 class="h5 mb-0 text-primary">
                        <i class="fas fa-list me-2"></i>
                        Coaches Registrados
                    </h3>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadCoaches()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                
                <div class="table-responsive">
                    <div id="coachesTable">
                        <div class="text-center py-4 text-muted">
                            <div class="loading-spinner me-2"></div>
                            Cargando coaches...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actividad Reciente -->
        <div class="admin-card p-3 p-md-4 mb-4">
            <h2 class="h4 mb-3">
                <i class="fas fa-clock text-primary me-2"></i>
                Actividad Reciente del Sistema
            </h2>
            <div id="recentActivity">
                <div class="text-center py-4 text-muted">
                    <div class="loading-spinner me-2"></div>
                    Cargando actividad...
                </div>
            </div>
        </div>

        <!-- Acciones de Administración - Mobile responsive -->
        <div class="admin-card p-3 p-md-4">
            <h2 class="h4 mb-3">
                <i class="fas fa-cogs text-primary me-2"></i>
                Acciones de Administración
            </h2>
            
            <div class="row g-2 g-md-3">
                <div class="col-12 col-sm-6 col-lg-4">
                    <button class="btn btn-admin w-100" onclick="initializeDatabase()">
                        <i class="fas fa-sync-alt me-2"></i>
                        <span class="d-none d-sm-inline">Reinicializar</span>
                        <span class="d-sm-none">Reinicializar DB</span>
                        Base de Datos
                    </button>
                </div>
                
                <div class="col-12 col-sm-6 col-lg-4">
                    <button class="btn btn-admin-secondary w-100" onclick="exportData()">
                        <i class="fas fa-download me-2"></i>
                        Exportar Datos
                    </button>
                </div>
                
                <div class="col-12 col-sm-6 col-lg-4">
                    <button class="btn btn-admin-secondary w-100" onclick="viewSystemLogs()">
                        <i class="fas fa-file-alt me-2"></i>
                        Ver Logs
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const API_BASE_URL = window.location.origin;
        let userDistributionChart = null;

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            loadPlatformStats();
            loadUsers();
            loadCoaches();
            
            // Event listener para el formulario de crear coach
            document.getElementById('createCoachForm').addEventListener('submit', handleCreateCoach);
        });

        // Cargar estadísticas de la plataforma
        async function loadPlatformStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/platform-stats`);
                const stats = await response.json();
                
                if (response.ok) {
                    // Animar contadores
                    animateCounter('totalUsers', stats.total_users);
                    animateCounter('totalCoaches', stats.total_coaches);
                    animateCounter('totalCoachees', stats.total_coachees);
                    animateCounter('totalAssessments', stats.total_assessments);
                    
                    // Crear gráfico de distribución
                    createUserDistributionChart(stats);
                } else {
                    throw new Error(stats.error);
                }
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
                ['totalUsers', 'totalCoaches', 'totalCoachees', 'totalAssessments'].forEach(id => {
                    document.getElementById(id).textContent = 'Error';
                });
            }
        }

        // Animar contadores con efecto de incremento
        function animateCounter(elementId, finalValue) {
            const element = document.getElementById(elementId);
            const duration = 1000;
            const start = 0;
            const increment = finalValue / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if (current >= finalValue) {
                    element.textContent = finalValue;
                    clearInterval(timer);
                } else {
                    element.textContent = Math.floor(current);
                }
            }, 16);
        }

        // Crear gráfico de distribución de usuarios - Responsive
        function createUserDistributionChart(stats) {
            const ctx = document.getElementById('userDistributionChart').getContext('2d');
            
            if (userDistributionChart) {
                userDistributionChart.destroy();
            }
            
            userDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Administradores', 'Coaches', 'Coachees'],
                    datasets: [{
                        data: [stats.total_admins || 1, stats.total_coaches, stats.total_coachees],
                        backgroundColor: [
                            '#dc3545',
                            '#0dcaf0',
                            '#198754'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: window.innerWidth < 768 ? 'bottom' : 'right',
                            labels: {
                                padding: 15,
                                font: {
                                    size: window.innerWidth < 768 ? 10 : 12
                                }
                            }
                        }
                    }
                }
            });
            
            // Actualizar el gráfico cuando cambie el tamaño de pantalla
            window.addEventListener('resize', () => {
                if (userDistributionChart) {
                    userDistributionChart.options.plugins.legend.position = window.innerWidth < 768 ? 'bottom' : 'right';
                    userDistributionChart.update();
                }
            });
        }

        // Cargar lista de usuarios
        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/users`);
                
                if (response.ok) {
                    const users = await response.json();
                    displayUsers(users);
                } else {
                    // Si no existe el endpoint, mostrar mensaje
                    document.getElementById('usersTable').innerHTML = 
                        '<div class="alert alert-info">Funcionalidad de gestión de usuarios próximamente</div>';
                }
            } catch (error) {
                console.error('Error cargando usuarios:', error);
                document.getElementById('usersTable').innerHTML = 
                    '<div class="alert alert-warning">Usuarios disponibles a través de la base de datos</div>';
            }
        }

        // Mostrar usuarios en tabla responsiva
        function displayUsers(users) {
            if (!users || users.length === 0) {
                document.getElementById('usersTable').innerHTML = 
                    '<div class="alert alert-info">No hay usuarios registrados</div>';
                return;
            }

            const tableHTML = `
                <table class="table admin-table table-hover">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th class="d-none d-md-table-cell">Nombre</th>
                            <th>Rol</th>
                            <th class="d-none d-sm-table-cell">Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>
                                    ${user.avatar_url ? 
                                        `<div class="user-avatar"><img src="${user.avatar_url}" alt="${user.username}"></div>` : 
                                        `<div class="user-avatar">${user.username.charAt(0).toUpperCase()}</div>`
                                    }
                                    <div class="d-inline-block align-middle">
                                        <div class="fw-semibold">${user.username}</div>
                                        <div class="d-md-none small text-muted">${user.full_name}</div>
                                    </div>
                                </td>
                                <td class="d-none d-md-table-cell">${user.full_name}</td>
                                <td>
                                    <span class="role-badge role-${user.role}">
                                        ${getRoleDisplayName(user.role)}
                                    </span>
                                </td>
                                <td class="d-none d-sm-table-cell">
                                    ${user.is_active ? 
                                        '<span class="badge bg-success">Activo</span>' : 
                                        '<span class="badge bg-danger">Inactivo</span>'
                                    }
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('usersTable').innerHTML = tableHTML;
        }

        // Obtener nombre de rol para mostrar
        function getRoleDisplayName(role) {
            const roleNames = {
                'platform_admin': 'Admin',
                'coach': 'Coach',
                'coachee': 'Coachee'
            };
            return roleNames[role] || role;
        }

        // Cargar lista de coaches
        async function loadCoaches() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/coaches`);
                
                if (response.ok) {
                    const data = await response.json();
                    displayCoaches(data.coaches);
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Error cargando coaches');
                }
            } catch (error) {
                console.error('Error cargando coaches:', error);
                document.getElementById('coachesTable').innerHTML = 
                    `<div class="alert alert-danger">Error cargando coaches: ${error.message}</div>`;
            }
        }

        // Mostrar coaches en tabla responsiva
        function displayCoaches(coaches) {
            if (!coaches || coaches.length === 0) {
                document.getElementById('coachesTable').innerHTML = 
                    '<div class="alert alert-info">No hay coaches registrados</div>';
                return;
            }

            const tableHTML = `
                <table class="table admin-table table-hover">
                    <thead>
                        <tr>
                            <th>Coach</th>
                            <th class="d-none d-lg-table-cell">Email</th>
                            <th class="d-none d-md-table-cell">Coachees</th>
                            <th class="d-none d-md-table-cell">Evaluaciones</th>
                            <th class="d-none d-xl-table-cell">Último Login</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${coaches.map(coach => `
                            <tr>
                                <td>
                                    <div class="fw-semibold">${coach.username}</div>
                                    <div class="small text-muted">${coach.full_name}</div>
                                    <div class="d-lg-none small text-muted">${coach.email}</div>
                                </td>
                                <td class="d-none d-lg-table-cell">${coach.email}</td>
                                <td class="d-none d-md-table-cell">
                                    <span class="badge bg-primary">${coach.coachees_count}</span>
                                </td>
                                <td class="d-none d-md-table-cell">
                                    <span class="badge bg-info">${coach.assessments_count}</span>
                                </td>
                                <td class="d-none d-xl-table-cell">
                                    ${coach.last_login ? new Date(coach.last_login).toLocaleDateString() : 'Nunca'}
                                </td>
                                <td>
                                    <span class="role-badge ${coach.is_active ? 'role-coach' : 'role-inactive'}">
                                        ${coach.is_active ? 'Activo' : 'Inactivo'}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('coachesTable').innerHTML = tableHTML;
        }

        // Manejar creación de nuevo coach
        async function handleCreateCoach(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            // Mostrar loading
            submitBtn.innerHTML = '<div class="loading-spinner me-2"></div>Creando...';
            submitBtn.disabled = true;
            
            const formData = {
                username: document.getElementById('coachUsername').value,
                email: document.getElementById('coachEmail').value,
                full_name: document.getElementById('coachFullName').value,
                password: document.getElementById('coachPassword').value
            };

            // Validaciones básicas
            if (formData.password.length < 6) {
                showAlert('La contraseña debe tener al menos 6 caracteres', 'warning');
                resetSubmitButton(submitBtn, originalText);
                return;
            }

            if (!formData.email.includes('@')) {
                showAlert('Por favor ingresa un email válido', 'warning');
                resetSubmitButton(submitBtn, originalText);
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/create-coach`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(
                        `✅ Coach ${formData.full_name} creado exitosamente!\n\nCredenciales:\nUsuario: ${formData.username}\nContraseña: ${formData.password}\n\nEl coach puede cambiar su contraseña desde /coach-login`,
                        'success'
                    );
                    
                    // Limpiar formulario
                    document.getElementById('createCoachForm').reset();
                    
                    // Recargar estadísticas y lista de coaches
                    loadPlatformStats();
                    loadCoaches();
                } else {
                    showAlert('❌ Error creando coach: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('❌ Error de conexión: ' + error.message, 'danger');
            } finally {
                resetSubmitButton(submitBtn, originalText);
            }
        }

        // Resetear botón de submit
        function resetSubmitButton(btn, originalText) {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        // Mostrar alerta con Bootstrap
        function showAlert(message, type) {
            // Usar alert nativo por simplicidad, pero podría implementarse con Bootstrap Toast
            alert(message);
        }

        // Generar contraseña aleatoria
        function generateRandomPassword() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('coachPassword').value = password;
        }

        // Acciones de administración
        async function initializeDatabase() {
            if (confirm('¿Estás seguro de que quieres reinicializar la base de datos? Esto puede afectar los datos existentes.')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/init-db`, {
                        method: 'POST'
                    });
                    const result = await response.json();
                    
                    if (response.ok) {
                        alert('Base de datos reinicializada correctamente');
                        location.reload();
                    } else {
                        alert('Error: ' + result.message);
                    }
                } catch (error) {
                    alert('Error reinicializando base de datos: ' + error.message);
                }
            }
        }

        function exportData() {
            alert('Funcionalidad de exportación próximamente');
        }

        function viewSystemLogs() {
            alert('Logs del sistema disponibles en el panel de Render');
        }

        // ============================================================================
        // FUNCIONES DE EDICIÓN DE PERFIL
        // ============================================================================
        
        async function openEditProfileModal() {
            const modal = new bootstrap.Modal(document.getElementById('editProfileModal'));
            
            // Cargar datos actuales del perfil
            try {
                const response = await fetch('/api/admin/profile');
                const data = await response.json();
                
                if (data.success && data.profile) {
                    document.getElementById('adminFullName').value = data.profile.full_name || '';
                    document.getElementById('adminEmail').value = data.profile.email || '';
                    document.getElementById('adminUsername').value = data.profile.username || '';
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                alert('❌ Error al cargar el perfil');
                return;
            }
            
            modal.show();
        }
        
        async function submitProfileUpdate() {
            const fullName = document.getElementById('adminFullName').value.trim();
            const email = document.getElementById('adminEmail').value.trim();
            
            // Validar campos
            if (!fullName || !email) {
                alert('❌ Todos los campos son requeridos');
                return;
            }
            
            if (fullName.length < 3) {
                alert('❌ El nombre completo debe tener al menos 3 caracteres');
                return;
            }
            
            // Validar formato de email
            const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (!emailPattern.test(email)) {
                alert('❌ Email inválido');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/profile', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        full_name: fullName,
                        email: email
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('✅ Perfil actualizado correctamente');
                    bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
                } else {
                    alert('❌ Error: ' + (data.error || 'No se pudo actualizar el perfil'));
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('❌ Error al actualizar el perfil: ' + error.message);
            }
        }
        
        // ============================================================================
        // FUNCIONES DE CAMBIO DE CONTRASEÑA
        // ============================================================================
        
        function openChangePasswordModal() {
            const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
            modal.show();
            
            // Inicializar listeners de validación en tiempo real
            setTimeout(() => {
                const newPasswordInput = document.getElementById('adminNewPassword');
                const confirmPasswordInput = document.getElementById('adminConfirmPassword');
                
                if (newPasswordInput) {
                    newPasswordInput.addEventListener('input', validatePasswordPolicyAdmin);
                }
                
                if (confirmPasswordInput) {
                    confirmPasswordInput.addEventListener('input', validatePasswordMatchAdmin);
                }
            }, 100);
        }
        
        // Validar política de contraseña en tiempo real
        function validatePasswordPolicyAdmin() {
            const password = document.getElementById('adminNewPassword').value;
            
            // Requisitos
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /[0-9]/.test(password),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
            };
            
            // Actualizar indicadores visuales
            updateRequirementIndicatorAdmin('req-length-admin', requirements.length);
            updateRequirementIndicatorAdmin('req-uppercase-admin', requirements.uppercase);
            updateRequirementIndicatorAdmin('req-lowercase-admin', requirements.lowercase);
            updateRequirementIndicatorAdmin('req-number-admin', requirements.number);
            updateRequirementIndicatorAdmin('req-special-admin', requirements.special);
            
            return Object.values(requirements).every(r => r);
        }
        
        // Actualizar indicador de requisito
        function updateRequirementIndicatorAdmin(elementId, isValid) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const icon = element.querySelector('i');
            
            if (isValid) {
                element.style.color = '#28a745';
                icon.className = 'fas fa-check-circle';
                icon.style.fontSize = '0.875rem';
            } else {
                element.style.color = '#6c757d';
                icon.className = 'fas fa-circle';
                icon.style.fontSize = '0.5rem';
            }
        }
        
        // Validar coincidencia de contraseñas
        function validatePasswordMatchAdmin() {
            const newPassword = document.getElementById('adminNewPassword').value;
            const confirmPassword = document.getElementById('adminConfirmPassword').value;
            const indicator = document.getElementById('passwordMatchIndicatorAdmin');
            
            if (!indicator || !confirmPassword) return;
            
            if (newPassword === confirmPassword) {
                indicator.innerHTML = '<i class="fas fa-check-circle" style="color: #28a745; margin-right: 0.5rem;"></i>Las contraseñas coinciden';
                indicator.style.color = '#28a745';
            } else {
                indicator.innerHTML = '<i class="fas fa-times-circle" style="color: #dc3545; margin-right: 0.5rem;"></i>Las contraseñas no coinciden';
                indicator.style.color = '#dc3545';
            }
        }

        async function submitPasswordChange() {
            const currentPassword = document.getElementById('adminCurrentPassword').value.trim();
            const newPassword = document.getElementById('adminNewPassword').value.trim();
            const confirmPassword = document.getElementById('adminConfirmPassword').value.trim();
            
            // Validar campos
            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('❌ Todos los campos son requeridos');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('❌ Las contraseñas nuevas no coinciden');
                return;
            }
            
            // Validar política completa
            const requirements = {
                length: newPassword.length >= 8,
                uppercase: /[A-Z]/.test(newPassword),
                lowercase: /[a-z]/.test(newPassword),
                number: /[0-9]/.test(newPassword),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(newPassword)
            };
            
            const failedRequirements = [];
            if (!requirements.length) failedRequirements.push('mínimo 8 caracteres');
            if (!requirements.uppercase) failedRequirements.push('al menos 1 letra mayúscula');
            if (!requirements.lowercase) failedRequirements.push('al menos 1 letra minúscula');
            if (!requirements.number) failedRequirements.push('al menos 1 número');
            if (!requirements.special) failedRequirements.push('al menos 1 símbolo especial');
            
            if (failedRequirements.length > 0) {
                alert('❌ La contraseña debe cumplir: ' + failedRequirements.join(', '));
                return;
            }
            
            // ✨ NUEVO: Validar que la nueva contraseña sea diferente a la actual
            if (currentPassword === newPassword) {
                alert('❌ La nueva contraseña debe ser diferente a la contraseña actual');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/change-password', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword,
                        confirm_password: confirmPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('✅ Contraseña actualizada correctamente');
                    bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
                    // Limpiar campos
                    document.getElementById('adminCurrentPassword').value = '';
                    document.getElementById('adminNewPassword').value = '';
                    document.getElementById('adminConfirmPassword').value = '';
                    // Limpiar indicadores
                    document.getElementById('passwordMatchIndicatorAdmin').innerHTML = '';
                    ['req-length-admin', 'req-uppercase-admin', 'req-lowercase-admin', 'req-number-admin', 'req-special-admin'].forEach(id => {
                        updateRequirementIndicatorAdmin(id, false);
                    });
                } else {
                    alert('❌ Error: ' + (data.error || 'No se pudo cambiar la contraseña'));
                }
            } catch (error) {
                alert('❌ Error al cambiar la contraseña: ' + error.message);
            }
        }
    </script>

    <!-- Modal de Editar Perfil -->
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editProfileModalLabel">
                        <i class="fas fa-user-edit me-2"></i>Editar Perfil
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm" onsubmit="event.preventDefault(); submitProfileUpdate();">
                        <div class="mb-3">
                            <label for="adminFullName" class="form-label">
                                <i class="fas fa-user me-1"></i>Nombre Completo
                            </label>
                            <input type="text" class="form-control" id="adminFullName" required minlength="3" placeholder="Ej: Juan Pérez">
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Mínimo 3 caracteres
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="adminEmail" class="form-label">
                                <i class="fas fa-envelope me-1"></i>Email
                            </label>
                            <input type="email" class="form-control" id="adminEmail" required placeholder="admin@ejemplo.com">
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Este email se usará para recuperación de contraseña
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">
                                <i class="fas fa-user-tag me-1"></i>Usuario
                            </label>
                            <input type="text" class="form-control" id="adminUsername" disabled>
                            <div class="form-text">
                                <i class="fas fa-lock me-1"></i>
                                El nombre de usuario no puede modificarse
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="submitProfileUpdate()">
                        <i class="fas fa-save me-1"></i>Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Cambio de Contraseña -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="changePasswordModalLabel">
                        <i class="fas fa-key me-2"></i>Cambiar Contraseña
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm" onsubmit="event.preventDefault(); submitPasswordChange();">
                        <div class="mb-3">
                            <label for="adminCurrentPassword" class="form-label">
                                <i class="fas fa-lock me-1"></i>Contraseña Actual
                            </label>
                            <input type="password" class="form-control" id="adminCurrentPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="adminNewPassword" class="form-label">
                                <i class="fas fa-key me-1"></i>Nueva Contraseña
                            </label>
                            <input type="password" class="form-control" id="adminNewPassword" required minlength="8">
                            
                            <!-- Indicadores de política de contraseña -->
                            <div id="passwordRequirementsAdmin" class="mt-2" style="font-size: 0.875rem;">
                                <div class="password-requirement" id="req-length-admin" style="color: #6c757d; margin-bottom: 0.25rem;">
                                    <i class="fas fa-circle" style="font-size: 0.5rem; margin-right: 0.5rem;"></i>
                                    Mínimo 8 caracteres
                                </div>
                                <div class="password-requirement" id="req-uppercase-admin" style="color: #6c757d; margin-bottom: 0.25rem;">
                                    <i class="fas fa-circle" style="font-size: 0.5rem; margin-right: 0.5rem;"></i>
                                    Al menos 1 letra mayúscula
                                </div>
                                <div class="password-requirement" id="req-lowercase-admin" style="color: #6c757d; margin-bottom: 0.25rem;">
                                    <i class="fas fa-circle" style="font-size: 0.5rem; margin-right: 0.5rem;"></i>
                                    Al menos 1 letra minúscula
                                </div>
                                <div class="password-requirement" id="req-number-admin" style="color: #6c757d; margin-bottom: 0.25rem;">
                                    <i class="fas fa-circle" style="font-size: 0.5rem; margin-right: 0.5rem;"></i>
                                    Al menos 1 número
                                </div>
                                <div class="password-requirement" id="req-special-admin" style="color: #6c757d; margin-bottom: 0.25rem;">
                                    <i class="fas fa-circle" style="font-size: 0.5rem; margin-right: 0.5rem;"></i>
                                    Al menos 1 símbolo especial (!@#$%^&*)
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="adminConfirmPassword" class="form-label">
                                <i class="fas fa-check-circle me-1"></i>Confirmar Nueva Contraseña
                            </label>
                            <input type="password" class="form-control" id="adminConfirmPassword" required minlength="8">
                            <div id="passwordMatchIndicatorAdmin" style="font-size: 0.875rem; margin-top: 0.5rem;"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" onclick="submitPasswordChange()">
                        <i class="fas fa-save me-1"></i>Cambiar Contraseña
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Función de logout seguro para administradores
        async function adminLogout() {
            try {
                // Mostrar indicador de carga
                const logoutBtn = event.target.closest('button');
                const originalHtml = logoutBtn.innerHTML;
                logoutBtn.disabled = true;
                logoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Cerrando...';
                
                const response = await fetch('/api/admin/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Limpiar localStorage y sessionStorage
                    localStorage.clear();
                    sessionStorage.clear();
                    
                    // Mostrar mensaje y redirigir
                    window.location.href = data.redirect_url || '/admin-login';
                } else {
                    // En caso de error, forzar redirección al login
                    console.error('❌ Error cerrando sesión:', data.error);
                    window.location.href = '/admin-login';
                }
            } catch (error) {
                console.error('❌ Error en logout:', error);
                // Forzar redirección incluso si hay error
                window.location.href = '/admin-login';
            }
        }
    </script>

</body>
</html>
