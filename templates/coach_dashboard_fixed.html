<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Coach - Plataforma de Asertividad</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome para íconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #5A67D8 0%, #4C51BF 100%);
            --success-gradient: linear-gradient(135deg, #68D391 0%, #48BB78 100%);
        }
        body {
            background: #F7FAFC;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .custom-header {
            background: var(--primary-gradient);
            box-shadow: 0 4px 20px rgba(90, 103, 216, 0.15);
        }
        .btn-success-gradient {
            background: var(--success-gradient);
            border: none;
            color: white;
        }
        .btn-success-gradient:hover {
            background: linear-gradient(135deg, #48BB78 0%, #38A169 100%);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-expand-lg custom-header">
        <div class="container-fluid">
            <a class="navbar-brand text-white" href="#">
                <i class="fas fa-chart-line me-2"></i>Dashboard Coach
            </a>
            <div class="ms-auto">
                <a class="btn btn-outline-light btn-sm" href="/logout">
                    <i class="fas fa-sign-out-alt me-1"></i>Cerrar Sesión
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid py-4">
        <!-- Mis Coachees -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">
                            <i class="fas fa-users me-2 text-primary"></i>Mis Coachees
                        </h3>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success-gradient btn-sm" onclick="openInvitationModal()">
                                <i class="fas fa-envelope me-1"></i>Invitar Coachee
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="loadCoachees()">
                                <i class="fas fa-refresh me-1"></i>Actualizar
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="coacheesContainer" class="row">
                            <div class="col-12 text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando coachees...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1055;">
        <!-- Toasts will be inserted here -->
    </div>

    <!-- Modal de invitación de coachee -->
    <div class="modal fade" id="invitationModal" tabindex="-1" aria-labelledby="invitationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="invitationModalLabel">
                        <i class="fas fa-envelope me-2"></i>Invitar Coachee
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="invitationForm">
                        <div class="mb-3">
                            <label for="inviteEmail" class="form-label">Correo electrónico del coachee</label>
                            <input type="email" class="form-control" id="inviteEmail" placeholder="coachee@email.com" required>
                        </div>
                        <div class="mb-3">
                            <label for="inviteFullName" class="form-label">Nombre completo</label>
                            <input type="text" class="form-control" id="inviteFullName" placeholder="Nombre del coachee" required>
                        </div>
                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-paper-plane me-2"></i>Enviar Invitación
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let coacheesData = [];

        // Función para mostrar notificaciones toast
        function showToast(message, type = 'info', duration = 5000) {
            const toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                alert(`${type.toUpperCase()}: ${message}`);
                return;
            }

            const toastId = 'toast-' + Date.now();
            const iconMap = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-triangle',
                warning: 'fa-exclamation-circle',
                info: 'fa-info-circle'
            };

            const bgColorMap = {
                success: 'bg-success',
                error: 'bg-danger',
                warning: 'bg-warning',
                info: 'bg-info'
            };

            const toastHtml = `
                <div class="toast align-items-center text-white ${bgColorMap[type]} border-0" role="alert" 
                     aria-live="assertive" aria-atomic="true" id="${toastId}">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas ${iconMap[type]} me-2"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                                data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: duration });
            toast.show();

            toastElement.addEventListener('hidden.bs.toast', function () {
                toastElement.remove();
            });
        }

        // Función para abrir el modal de invitación
        function openInvitationModal() {
            console.log('Abriendo modal de invitación...');
            const modal = new bootstrap.Modal(document.getElementById('invitationModal'));
            document.getElementById('invitationForm').reset();
            modal.show();
        }

        // Función para enviar la invitación
        async function sendInvitation() {
            const email = document.getElementById('inviteEmail').value.trim();
            const fullName = document.getElementById('inviteFullName').value.trim();
            const submitBtn = document.querySelector('#invitationForm button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            if (!email || !fullName) {
                showToast('Completa todos los campos para invitar al coachee', 'error');
                return;
            }

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
                
                const response = await fetch('/api/coach/invite-coachee', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email, full_name: fullName })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Error al enviar invitación');
                }

                showToast('Invitación enviada exitosamente', 'success');
                bootstrap.Modal.getInstance(document.getElementById('invitationModal')).hide();
                loadCoachees();
                
            } catch (error) {
                console.error('Error enviando invitación:', error);
                showToast(error.message || 'Error al enviar invitación', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        // Función para cargar coachees
        async function loadCoachees() {
            try {
                const container = document.getElementById('coacheesContainer');
                container.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando coachees...</span>
                        </div>
                    </div>
                `;

                const response = await fetch('/api/coach/coachees', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Error al cargar coachees');
                }

                const data = await response.json();
                coacheesData = data.coachees || [];
                displayCoachees();
                
            } catch (error) {
                console.error('Error cargando coachees:', error);
                const container = document.getElementById('coacheesContainer');
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error al cargar coachees: ${error.message}
                            <button class="btn btn-sm btn-outline-danger ms-2" onclick="loadCoachees()">
                                <i class="fas fa-refresh me-1"></i>Reintentar
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Función para mostrar coachees
        function displayCoachees() {
            const container = document.getElementById('coacheesContainer');
            
            if (!coacheesData || coacheesData.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <h4>No hay coachees asignados</h4>
                            <p class="text-muted">Los coachees que invites aparecerán aquí.</p>
                            <button class="btn btn-success-gradient" onclick="openInvitationModal()">
                                <i class="fas fa-envelope me-2"></i>Invitar Primer Coachee
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            const html = coacheesData.map(coachee => `
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="card-title">${coachee.full_name}</h6>
                            <p class="card-text text-muted">${coachee.email}</p>
                            <span class="badge bg-${coachee.status === 'active' ? 'success' : 'warning'}">
                                ${coachee.status === 'active' ? 'Activo' : 'Pendiente'}
                            </span>
                        </div>
                        <div class="card-footer bg-transparent">
                            <button class="btn btn-primary btn-sm" onclick="viewCoacheeDetails('${coachee.id}')">
                                <i class="fas fa-eye me-1"></i>Ver Detalles
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // Función placeholder para ver detalles
        function viewCoacheeDetails(coacheeId) {
            showToast('Función en desarrollo', 'info');
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM cargado, inicializando dashboard...');
            
            // Configurar event listener para el formulario de invitación
            const invitationForm = document.getElementById('invitationForm');
            if (invitationForm) {
                invitationForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await sendInvitation();
                });
            }

            // Cargar datos iniciales
            loadCoachees();
        });
    </script>
</body>
</html>
