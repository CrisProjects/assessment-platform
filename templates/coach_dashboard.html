{% extends "base.html" %}

{% block title %}Dashboard Coach - Assessment Platform{% endblock %}

{% block extra_css %}
<!-- Anti-cache meta tags -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<style>
    /* Variables CSS para recomendaciones unificadas - IGUAL QUE COACHEE */
    :root {
        --calm-primary: #1E3A8A;        /* Deep Blue */
        --calm-secondary: #3B82F6;      /* Bright Blue */
        --calm-accent: #06B6D4;         /* Cyan */
        --calm-light: #EFF6FF;          /* Very Light Blue */
        --calm-dark: #1E293B;           /* Dark Slate */
        --calm-white: #FFFFFF;
        --calm-gray-50: #F8FAFC;
        --calm-gray-100: #F1F5F9;
    }
    
    /* ANULAR SISTEMA DE TEMAS PARA SIDEBAR - PROBLEMA ENCONTRADO! */
    .sidebar,
    .sidebar * {
        --theme-card-bg: white !important;
        --theme-card-border: #dee2e6 !important;
        --theme-text-primary: #333 !important;
        --theme-text-secondary: #333 !important;
        --theme-hover-bg: #f8f9fa !important;
    }
    
    /* ESTILOS DE CONTRASTE ALTO - SIN TRANSPARENCIAS - v2.3 */
    body {
        background: #f8f9fa !important;
        color: #333 !important;
    }
    
    /* Cards con fondo blanco sólido */
    .card,
    .glass-card,
    .modal-content {
        background: white !important;
        border: 1px solid #dee2e6 !important;
        color: #333 !important;
        backdrop-filter: none !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        border-radius: 0.5rem !important;
    }
    
    .card.bg-dark {
        background: white !important;
        border: 1px solid #dee2e6 !important;
    }
    
    .card.bg-dark .card-body {
        background: white !important;
    }
    
    /* Textos con contraste */
    .text-white,
    .text-muted,
    .card.bg-dark .text-white,
    .card.bg-dark .text-muted {
        color: #333 !important;
    }
    
    .text-primary {
        color: #0066cc !important;
    }
    
    /* Botones con colores sólidos */
    .btn-outline-light {
        border-color: #dee2e6 !important;
        color: #333 !important;
        background: white !important;
    }
    
    .btn-outline-light:hover {
        background: #f8f9fa !important;
        border-color: #adb5bd !important;
        color: #333 !important;
    }
    
    .btn-primary {
        background: #007bff !important;
        border-color: #007bff !important;
        color: white !important;
    }
    
    .btn-success {
        background: #28a745 !important;
        border-color: #28a745 !important;
        color: white !important;
    }
    
    .btn-info {
        background: #17a2b8 !important;
        border-color: #17a2b8 !important;
        color: white !important;
    }
    
    /* Modal con fondo sólido */
    .modal-content {
        background: white !important;
        color: #333 !important;
    }
    
    .modal-header {
        background: #f8f9fa !important;
        border-bottom: 1px solid #dee2e6 !important;
    }
    
    .modal-title {
        color: #333 !important;
    }
    
    /* Elementos de evaluación */
    .evaluation-item {
        background: white !important;
        border: 1px solid #dee2e6 !important;
        color: #333 !important;
        margin-bottom: 1rem;
        padding: 1rem;
        border-radius: 8px;
    }
    
    .evaluation-item:hover {
        background: #f8f9fa !important;
        border-color: #adb5bd !important;
    }
    
    /* Progress bars */
    .progress {
        background: #e9ecef !important;
    }
    
    .progress-bar {
        background: #007bff !important;
    }
    
    /* Tables */
    .table-dark {
        background: white !important;
        color: #333 !important;
    }
    
    .table-dark th,
    .table-dark td {
        background: white !important;
        color: #333 !important;
        border-color: #dee2e6 !important;
    }
    
    .table-hover tbody tr:hover {
        background: #f8f9fa !important;
        color: #333 !important;
    }
    
    /* Sidebar limpio - FORZAR CACHE REFRESH v2.1 */
    .sidebar,
    .sidebar .card,
    .sidebar .card.bg-dark,
    .sidebar .card.bg-dark.border-secondary {
        background: white !important;
        background-color: white !important;
        border-right: 1px solid #dee2e6 !important;
        border: 1px solid #dee2e6 !important;
    }
    
    .sidebar .card-header,
    .sidebar .card-header.bg-dark,
    .sidebar .card-header.bg-dark.border-secondary {
        background: #f8f9fa !important;
        background-color: #f8f9fa !important;
        border-bottom: 1px solid #dee2e6 !important;
        color: #333 !important;
    }
    
    .sidebar .card-header h6,
    .sidebar .card-header .text-white,
    .sidebar .card-header h6.mb-0 {
        color: #333 !important;
        font-weight: 600 !important;
    }
    
    .sidebar .nav-link,
    .sidebar .list-group-item,
    .sidebar .list-group-item.bg-dark {
        background: white !important;
        color: #333 !important;
        border-color: #dee2e6 !important;
    }
    
    .sidebar .nav-link:hover,
    .sidebar .list-group-item:hover {
        background: #f8f9fa !important;
        color: #333 !important;
    }
    
    .sidebar .nav-link.active,
    .sidebar .list-group-item.active {
        background: #007bff !important;
        color: white !important;
        border-color: #007bff !important;
    }
    
    /* FUERZA ANTI-CACHE ESPECÍFICO PANEL DE CONTROL */
    .sidebar .card[style*="background"] {
        background: white !important;
        background-color: white !important;
    }
    
    .sidebar .card-header[style*="background"] {
        background: #f8f9fa !important;
        background-color: #f8f9fa !important;
        color: #333 !important;
    }
    
    .sidebar h6[style*="color"] {
        color: #333 !important;
    }
    
    /* Timestamp para forzar refresh: 20250831-1135 */
    
    /* MÁXIMA ESPECIFICIDAD PARA PANEL DE CONTROL */
    .sidebar.sidebar-force-white,
    .sidebar.sidebar-force-white.card,
    .sidebar.sidebar-force-white.card.bg-dark,
    .sidebar.sidebar-force-white.card.bg-dark.border-secondary {
        background: white !important;
        background-color: white !important;
        border: 1px solid #dee2e6 !important;
    }
    
    .sidebar .sidebar-header-force,
    .sidebar .sidebar-header-force.card-header,
    .sidebar .sidebar-header-force.card-header.bg-dark {
        background: #f8f9fa !important;
        background-color: #f8f9fa !important;
        color: #333 !important;
        border-bottom: 1px solid #dee2e6 !important;
    }
    
    .sidebar .sidebar-title-force,
    .sidebar .sidebar-title-force.mb-0,
    .sidebar .sidebar-title-force.text-white {
        color: #333 !important;
        font-weight: 600 !important;
    }
    
    /* NUEVA CLASE ULTRA-ESPECÍFICA - ELIMINAR CUALQUIER BG-DARK */
    .sidebar-white,
    .sidebar-white.card,
    .sidebar-white.sidebar,
    .sidebar-white.sidebar.card {
        background: white !important;
        background-color: white !important;
        border: 1px solid #dee2e6 !important;
    }
    
    .sidebar-header-white,
    .sidebar-header-white.card-header {
        background: #f8f9fa !important;
        background-color: #f8f9fa !important;
        color: #333 !important;
        border-bottom: 1px solid #dee2e6 !important;
    }
    
    .sidebar-title-white,
    .sidebar-title-white.mb-0 {
        color: #333 !important;
        font-weight: 600 !important;
    }
    
    /* ENFOQUE NUCLEAR - ANULAR CUALQUIER BG-DARK EN SIDEBAR */
    .sidebar *,
    .sidebar *.bg-dark,
    .sidebar *.bg-secondary,
    .sidebar *.bg-primary,
    .sidebar .card.bg-dark,
    .sidebar .card-header.bg-dark,
    .sidebar .card-body.bg-dark {
        background: white !important;
        background-color: white !important;
    }
    
    .sidebar .card-header *,
    .sidebar .card-header *.bg-dark {
        background: #f8f9fa !important;
        background-color: #f8f9fa !important;
        color: #333 !important;
    }
    
    /* Charts con colores sólidos */
    .chart-container {
        background: white !important;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    
    /* Estilos profesionales para recomendaciones categorizadas - UNIFICADOS */
    .recommendations-container {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 16px;
        border: 2px solid var(--calm-accent);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }
    
    .recommendations-header {
        background: linear-gradient(135deg, var(--calm-primary) 0%, #1D4ED8 100%);
        color: white !important;
        padding: 1.5rem;
        border-bottom: 3px solid var(--calm-accent);
        position: relative;
    }
    
    .recommendations-header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--calm-accent) 0%, #0ea5e9 50%, var(--calm-accent) 100%);
    }
    
    .recommendation-category {
        background: white;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
        overflow: hidden;
        transition: all 0.3s ease;
        animation: fadeInUp 0.6s ease-out;
    }
    
    .recommendation-category:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        border-color: var(--calm-accent);
    }
    
    .category-header {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        border-bottom: 2px solid #e2e8f0;
        padding: 1rem 1.25rem;
        position: relative;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .category-title {
        font-weight: 700;
        color: var(--calm-primary);
        font-size: 1.1rem;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .category-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--calm-accent) 0%, #0ea5e9 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        margin-right: 0.75rem;
        animation: pulse 2s infinite;
    }
    
    .score-badge {
        background: linear-gradient(135deg, var(--calm-secondary) 0%, var(--calm-accent) 100%);
        color: white;
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    .priority-indicator {
        position: absolute;
        top: 0;
        right: 0;
        width: 0;
        height: 0;
        border-left: 15px solid transparent;
        border-top: 15px solid;
    }
    
    .priority-high {
        border-top-color: #ef4444;
    }
    
    .priority-medium {
        border-top-color: #f59e0b;
    }
    
    .priority-low {
        border-top-color: #06b6d4;
    }
    
    .priority-growth {
        border-top-color: #10b981;
    }
    
    .category-content {
        padding: 1.25rem;
    }
    
    .recommendation-item {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 8px;
        padding: 0.75rem 1rem;
        margin-bottom: 0.75rem;
        border-left: 4px solid var(--calm-accent);
        position: relative;
        transition: all 0.3s ease;
        transform: translateY(0);
    }
    
    .recommendation-item:hover {
        background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
        border-left-color: var(--calm-primary);
        transform: translateX(5px) translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-color: var(--bs-primary) !important;
    }
    
    .recommendation-item:before {
        content: "✓";
        position: absolute;
        left: -2px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        background: var(--calm-accent);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .recommendation-text {
        margin-left: 1.5rem;
        line-height: 1.6;
        color: #334155;
        font-weight: 500;
    }
    
    .general-recommendations {
        border: 2px solid var(--calm-primary);
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    }
    
    .general-recommendations .category-header {
        background: linear-gradient(135deg, var(--calm-primary) 0%, #1D4ED8 100%);
        color: white;
        border-bottom-color: var(--calm-primary);
    }
    
    .general-recommendations .category-title {
        color: white;
    }
    
    .strengths-category {
        border: 2px solid #10b981;
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    }
    
    .strengths-category .category-header {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border-bottom-color: #10b981;
    }
    
    .strengths-category .category-title {
        color: white;
    }
    
    .strengths-category .recommendation-item {
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        border-left-color: #10b981;
    }
    
    .strengths-category .recommendation-item:before {
        background: #10b981;
        content: "★";
    }
    
    .final-message {
        border: 2px solid #8b5cf6;
        background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
    }
    
    .final-message .category-header {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        border-bottom-color: #8b5cf6;
    }
    
    .final-message .category-title {
        color: white;
    }
    
    .final-message .recommendation-item {
        background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
        border-left-color: #8b5cf6;
    }
    
    /* Estilos especiales para subcategorías de dimensiones */
    .dimension-subcategory {
        border: 2px solid var(--calm-primary);
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        margin-bottom: 2rem;
    }
    
    .subcategory-header {
        background: linear-gradient(135deg, var(--calm-primary) 0%, #1D4ED8 100%);
        color: white;
        padding: 1.25rem;
        border-bottom: 3px solid var(--calm-accent);
    }
    
    .subcategory-title-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .subcategory-info {
        flex: 1;
    }
    
    .subcategory-title {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 700;
        color: white;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .action-list li {
        position: relative;
        padding-left: 0.5rem;
    }
    
    .action-list li:before {
        content: "→";
        position: absolute;
        left: -0.5rem;
        color: var(--bs-primary);
        font-weight: bold;
    }
    
    .item-number {
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .category-header {
            padding: 1rem !important;
        }
        
        .category-header .d-flex {
            flex-direction: column;
            text-align: center;
        }
        
        .category-icon {
            margin-bottom: 1rem;
        }
        
        .recommendation-item {
            padding: 1rem !important;
        }
        
        /* Mejoras para header en móviles */
        .dashboard-header {
            padding: 1rem !important;
        }
        
        .dashboard-header .d-flex {
            flex-direction: column !important;
            align-items: flex-start !important;
            gap: 1rem !important;
        }
        
        .dashboard-header .btn-group-mobile {
            display: flex !important;
            flex-direction: column !important;
            gap: 0.75rem !important;
            width: 100% !important;
        }
        
        .dashboard-header .btn-group-mobile .btn {
            flex: none !important;
            width: 100% !important;
            min-width: 0 !important;
            font-size: 0.875rem !important;
            padding: 0.75rem 1rem !important;
            justify-content: center !important;
            align-items: center !important;
            text-align: center !important;
            min-height: 44px !important;
        }
        
        /* MOSTRAR TEXTO EN MÓVILES - Forzar que el texto sea visible */
        .dashboard-header .btn-group-mobile .btn .d-none.d-sm-inline {
            display: inline !important;
        }
        
        /* CENTRAR ICONOS Y TEXTO EN MÓVILES */
        .dashboard-header .btn-group-mobile .btn .fas {
            margin-right: 0.5rem !important;
        }
        
        /* Mobile coachees cards */
        .coachee-card-mobile {
            margin-bottom: 1rem !important;
            border: 1px solid #e3e6f0 !important;
            border-radius: 8px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        }
        
        .coachee-card-mobile:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
            transform: translateY(-1px);
            transition: all 0.3s ease;
        }
        
        /* Task management mobile styles */
        #gestion-tareas .row.g-3 {
            margin-bottom: 1rem !important;
        }
        
        #gestion-tareas .col-md-6 {
            margin-bottom: 0.75rem !important;
        }
        
        #gestion-tareas .form-label {
            font-size: 0.875rem !important;
            margin-bottom: 0.25rem !important;
        }
        
        #gestion-tareas .form-control,
        #gestion-tareas .form-select {
            font-size: 0.875rem !important;
            padding: 0.5rem 0.75rem !important;
        }
        
        #gestion-tareas textarea.form-control {
            min-height: 80px !important;
        }
        
        #gestion-tareas .btn {
            padding: 0.5rem 1rem !important;
            font-size: 0.875rem !important;
        }
        
        /* Task cards mobile */
        #tasksCardsContainer .card {
            border: 1px solid #e3e6f0 !important;
            border-radius: 8px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08) !important;
            transition: all 0.3s ease !important;
        }
        
        #tasksCardsContainer .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            transform: translateY(-2px);
        }
        
        #tasksCardsContainer .card-title {
            font-size: 1rem !important;
            line-height: 1.3 !important;
        }
        
        #tasksCardsContainer .card-text {
            font-size: 0.875rem !important;
            line-height: 1.4 !important;
        }
        
        #tasksCardsContainer .btn-group .btn {
            padding: 0.25rem 0.5rem !important;
            font-size: 0.75rem !important;
        }
        
        #tasksCardsContainer .row.g-2 {
            margin-bottom: 0.5rem !important;
        }
        
        #tasksCardsContainer .small {
            font-size: 0.75rem !important;
        }
        
        /* Container fluid para móviles */
        .container-fluid {
            padding-left: 0.75rem !important;
            padding-right: 0.75rem !important;
        }
        
        /* Sidebar en móviles */
        .sidebar .card {
            margin-bottom: 1rem !important;
        }
        
        /* ========== CORRECCIÓN LAYOUT MIS COACHEES ========== */
        
        /* Contenedor principal sin overflow oculto */
        .container-fluid {
            overflow-x: visible !important;
        }
        
        /* Fila principal con mejor distribución */
        .row {
            margin-left: -0.75rem;
            margin-right: -0.75rem;
        }
        
        /* Sidebar optimizado */
        .col-md-3 {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }
        
        /* Área de contenido principal */
        .col-md-9 {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
            overflow: visible !important;
        }
        
        /* Card de Mis Coachees */
        #mis-coachees .card {
            margin-bottom: 1rem;
            border: 1px solid #dee2e6;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        /* Tabla responsiva SIN scroll horizontal */
        #mis-coachees .table-responsive {
            overflow-x: hidden !important;
            overflow-y: visible !important;
            margin: 0;
            padding: 0;
            border: none;
        }
        
        /* Tabla responsiva que se ajusta al contenedor */
        #mis-coachees .table {
            width: 100% !important;
            table-layout: fixed !important;
            margin-bottom: 0;
            font-size: 0.875rem;
            border-collapse: collapse;
        }
        
        /* Headers de tabla */
        #mis-coachees .table thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            padding: 0.75rem 0.5rem;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        /* Celdas de tabla con manejo de overflow */
        #mis-coachees .table tbody td {
            padding: 0.5rem 0.3rem !important;
            vertical-align: middle;
            border-bottom: 1px solid #dee2e6;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            font-size: 0.8rem;
        }
        
        /* Texto específico para celdas críticas */
        #mis-coachees .table td:nth-child(1),
        #mis-coachees .table td:nth-child(2) {
            font-size: 0.8rem !important;
            line-height: 1.2;
        }
        
        /* Columna de contraseña optimizada para mostrar texto completo */
        #mis-coachees .table td:nth-child(3) {
            font-family: monospace !important;
            font-size: 0.8rem !important;
            line-height: 1.3 !important;
            white-space: nowrap !important;
            overflow: visible !important;
            text-overflow: clip !important;
            padding: 0.4rem 0.2rem !important;
        }
        
        /* Asegurar que el texto de contraseña sea visible */
        #mis-coachees .table td:nth-child(3) .password-text {
            font-family: monospace !important;
            font-size: 0.8rem !important;
            min-width: auto !important;
            display: inline-block !important;
        }
        
        /* Headers también compactos */
        #mis-coachees .table thead th {
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
        }
        
        /* Botones ultra compactos sin overflow */
        #mis-coachees .table .btn-sm {
            padding: 0.15rem 0.25rem !important;
            font-size: 0.65rem !important;
            margin: 0 1px !important;
            border-radius: 0.2rem;
            white-space: nowrap;
            line-height: 1.2;
        }
        
        /* Contenedor de botones en columna Acciones sin padding extra */
        #mis-coachees .table td:nth-child(4) {
            padding: 0.3rem 0.2rem !important;
            overflow: visible !important;
        }
        
        #mis-coachees .table td:nth-child(4) .btn-group {
            display: flex;
            flex-direction: column;
            gap: 1px;
            align-items: center;
            width: 100%;
        }
        
        /* Botones específicos más pequeños */
        #mis-coachees .table .btn-success,
        #mis-coachees .table .btn-primary,
        #mis-coachees .table .btn-info,
        #mis-coachees .table .btn-warning {
            padding: 0.1rem 0.2rem !important;
            font-size: 0.6rem !important;
            min-width: auto !important;
            width: 100% !important;
            max-width: 100% !important;
        }
        
        /* Columnas específicas redistribuidas para 4 columnas - SIN ÚLTIMO ACCESO */
        #mis-coachees .table th:nth-child(1), 
        #mis-coachees .table td:nth-child(1) { 
            width: 20% !important;
            max-width: 20% !important;
        }
        
        #mis-coachees .table th:nth-child(2), 
        #mis-coachees .table td:nth-child(2) { 
            width: 30% !important;
            max-width: 30% !important;
        }
        
        #mis-coachees .table th:nth-child(3), 
        #mis-coachees .table td:nth-child(3) { 
            width: 35% !important;
            max-width: 35% !important;
        }
        
        #mis-coachees .table th:nth-child(4), 
        #mis-coachees .table td:nth-child(4) { 
            width: 15% !important;
            max-width: 15% !important;
            text-align: center; 
        }
        
        /* Cards móviles mejoradas */
        #coacheesCardsContainer .unified-card {
            margin-bottom: 1rem;
            border: 1px solid #e3e6f0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        #coacheesCardsContainer .unified-card-footer {
            padding: 0.75rem;
        }
        
        #coacheesCardsContainer .unified-card-footer .d-flex {
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        
        #coacheesCardsContainer .unified-btn-sm {
            font-size: 0.75rem;
            padding: 0.375rem 0.5rem;
            flex: 1 1 calc(50% - 0.25rem);
            min-width: 0;
            text-align: center;
        }
        
        .sidebar .card-body {
            padding: 0.75rem !important;
        }
    }
    
        /* ========== RESPONSIVE MEJORADO PARA COACHEES ========== */
        
        /* Tablets landscape (768px - 1024px) */
        @media (min-width: 768px) and (max-width: 1024px) {
            .col-md-9 {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }
            
            #mis-coachees .table {
                font-size: 0.8rem !important;
            }
            
            #mis-coachees .table th,
            #mis-coachees .table td {
                padding: 0.5rem 0.3rem !important;
            }
            
            #mis-coachees .table .btn-sm {
                padding: 0.15rem 0.3rem !important;
                font-size: 0.65rem !important;
                margin: 0 1px !important;
            }
            
            /* Ajustes específicos para tablets */
            #mis-coachees .table th:nth-child(1), 
            #mis-coachees .table td:nth-child(1) { 
                width: 19% !important;
            }
            
            #mis-coachees .table th:nth-child(2), 
            #mis-coachees .table td:nth-child(2) { 
                width: 32% !important;
            }
            
            #mis-coachees .table th:nth-child(5), 
            #mis-coachees .table td:nth-child(5) { 
                width: 22% !important;
            }
        }
        
        /* Tablets portrait y móviles - Vista de cards */
        @media (max-width: 767px) {
            .col-md-3, .col-md-9 {
                flex: 0 0 100% !important;
                max-width: 100% !important;
                padding-left: 0.75rem !important;
                padding-right: 0.75rem !important;
            }
            
            .col-md-3 {
                margin-bottom: 1rem;
            }
            
            #mis-coachees .card-body {
                padding: 0.75rem !important;
            }
            
            /* Cards móviles mejoradas */
            #coacheesCardsContainer .unified-card {
                margin-bottom: 1rem;
                border: 1px solid #e3e6f0;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            #coacheesCardsContainer .unified-card-footer .d-flex {
                gap: 0.5rem;
                flex-wrap: wrap;
            }
            
            #coacheesCardsContainer .unified-btn-sm {
                font-size: 0.75rem;
                padding: 0.375rem 0.5rem;
                flex: 1 1 calc(50% - 0.25rem);
                min-width: 0;
                text-align: center;
            }
        }
        
        /* Móviles muy pequeños */
        @media (max-width: 575px) {
            #coacheesCardsContainer .unified-card-footer .d-flex {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            #coacheesCardsContainer .unified-btn-sm {
                flex: 1 1 100% !important;
                width: 100%;
            }
            
            #coacheesCardsContainer .meta-item {
                font-size: 0.8rem;
                margin-bottom: 0.5rem;
            }
        }
            
            .col-md-3, .col-md-9 {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            /* Reducir sidebar en tablets para dar más espacio al contenido */
            .col-md-3 {
                flex: 0 0 25%;
                max-width: 25%;
            }
            
            .col-md-9 {
                flex: 0 0 75%;
                max-width: 75%;
            }
        
        
        /* Títulos más pequeños en móvil */
        .dashboard-header h3 {
            font-size: 1.5rem !important;
        }
        
        .dashboard-header p {
            font-size: 0.875rem !important;
        }
        
        /* Ajustes adicionales para textos en móvil */
        .small {
            font-size: 0.75rem !important;
        }
        
        /* Coachees cards para móvil */
        .coachee-card-mobile {
            background-color: white !important;
            border: 1px solid #dee2e6 !important;
            border-radius: 8px !important;
            margin-bottom: 1rem !important;
            padding: 1rem !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        }
        
        .coachee-card-mobile .coachee-header {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 0.75rem !important;
            border-bottom: 1px solid #eee !important;
            padding-bottom: 0.5rem !important;
        }
        
        .coachee-card-mobile .coachee-name {
            font-weight: 600 !important;
            font-size: 1rem !important;
            color: #212529 !important;
            margin: 0 !important;
        }
        
        .coachee-card-mobile .coachee-status {
            font-size: 0.75rem !important;
        }
        
        .coachee-card-mobile .coachee-details {
            margin-bottom: 0.75rem !important;
        }
        
        .coachee-card-mobile .coachee-detail-item {
            display: flex !important;
            justify-content: space-between !important;
            margin-bottom: 0.5rem !important;
            font-size: 0.85rem !important;
        }
        
        .coachee-card-mobile .coachee-detail-label {
            font-weight: 500 !important;
            color: #666 !important;
        }
        
        .coachee-card-mobile .coachee-detail-value {
            color: #212529 !important;
            text-align: right !important;
        }
        
        .coachee-card-mobile .coachee-actions {
            display: flex !important;
            gap: 0.5rem !important;
            justify-content: center !important;
        }
        
        .coachee-card-mobile .btn-sm {
            font-size: 0.75rem !important;
            padding: 0.25rem 0.5rem !important;
        }
        
        /* Estilos para botón de asignar */
        .btn-outline-success:hover {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }
        
        /* Estilos para el modal de asignación */
        #assignModal .nav-tabs .nav-link {
            color: #6c757d;
        }
        
        #assignModal .nav-tabs .nav-link.active {
            color: #28a745;
            border-color: #28a745;
        }
        
        #assignModal .tab-content {
            min-height: 300px;
        }
    
    /* Estilos adicionales para tablets */
    @media (max-width: 992px) {
        .dashboard-header .btn-group-mobile .btn {
            font-size: 0.8rem !important;
            padding: 0.4rem 0.6rem !important;
        }
        
        .stats-card-mobile h4 {
            font-size: 1.3rem !important;
        }
    }
    
    /* Estilos para evaluaciones del coachee */
    .summary-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .summary-icon {
        width: 40px;
        height: 40px;
        background: var(--bs-primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .summary-number {
        font-size: 1.2rem;
        font-weight: bold;
        color: #333;
    }
    
    .summary-label {
        font-size: 0.85rem;
        color: #666;
    }
    
    /* Estilos para evaluaciones disponibles */
    .assessment-card {
        background: white;
        border: 1px solid #e3e6f0;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .assessment-card:hover {
        border-color: #e3e6f0;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.05);
    }
    
    .assessment-card.selected {
        border-color: #4e73df;
        background-color: #f8f9fc;
    }
    
    .assessment-actions {
        border-top: 1px solid #e9ecef;
        padding-top: 1rem;
        margin-top: 1rem;
    }
    
    .assessment-actions .btn {
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .assessment-actions .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.15);
    }
    
    .assessment-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }
    
    .assessment-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
    }
    
    .assessment-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        color: white !important;
        border: none;
    }
    
    .assessment-badge.bg-success {
        background: #28a745 !important;
        color: white !important;
    }
    
    .assessment-badge.bg-primary {
        background: #007bff !important;
        color: white !important;
    }
    
    .assessment-description {
        color: #6c757d;
        font-size: 0.9rem;
        line-height: 1.5;
        margin-bottom: 1rem;
    }
    
    .assessment-stats {
        display: flex;
        gap: 1.5rem;
        align-items: center;
        font-size: 0.85rem;
        color: #8b949e;
    }
    
    .assessment-stat {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .assessment-stat i {
        color: #4e73df;
    }
    
    /* Responsive styles para evaluaciones en móvil */
    @media (max-width: 768px) {
        .assessment-card {
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 8px;
        }
        
        .assessment-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .assessment-title {
            font-size: 1rem;
            line-height: 1.3;
        }
        
        .assessment-badge {
            align-self: flex-start;
            font-size: 0.7rem;
            padding: 0.2rem 0.6rem;
        }
        
        .assessment-badge.bg-success {
            background: #28a745 !important;
            color: white !important;
        }
        
        .assessment-badge.bg-primary {
            background: #007bff !important;
            color: white !important;
        }
        
        .assessment-description {
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }
        
        .assessment-stats {
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.8rem;
        }
        
        .assessment-stat {
            gap: 0.4rem;
            flex: 1;
            min-width: calc(50% - 0.5rem);
        }
        
        .assessment-stat i {
            font-size: 0.9rem;
        }
        
        /* Mejorar el spacing del spinner de carga */
        #assessments-loading {
            padding: 2rem 1rem !important;
        }
        
        /* Mejorar mensaje de no evaluaciones */
        #no-assessments {
            padding: 2rem 1rem !important;
        }
        
        #no-assessments i {
            font-size: 2.5rem !important;
            margin-bottom: 1rem !important;
        }
        
        #no-assessments h6 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        
        #no-assessments p {
            font-size: 0.85rem;
        }
        
        /* Mejorar alertas de error */
        #assessments-error {
            margin: 0;
            font-size: 0.85rem;
            padding: 0.75rem;
        }
    }
    
    /* Extra small devices (portrait phones, less than 576px) */
    @media (max-width: 575.98px) {
        .assessment-card {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .assessment-header {
            margin-bottom: 0.5rem;
        }
        
        .assessment-title {
            font-size: 0.95rem;
        }
        
        .assessment-description {
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }
        
        .assessment-stats {
            gap: 0.75rem;
            font-size: 0.75rem;
        }
        
        .assessment-stat {
            min-width: 100%;
            margin-bottom: 0.25rem;
        }
        
        /* Mejorar card-body padding en móvil */
        #seleccionar-evaluaciones .card-body {
            padding: 0.75rem !important;
        }
        
        /* Header más compacto en móvil */
        #seleccionar-evaluaciones .card-header {
            padding: 0.75rem !important;
        }
        
        #seleccionar-evaluaciones .card-header h5 {
            font-size: 1rem;
        }
        
        #seleccionar-evaluaciones .card-header .small {
            font-size: 0.75rem;
        }
        
        /* STATISTICS CARDS EN MÓVIL - GRILLA 2X2 IGUAL QUE COACHEE */
        .stats-card-mobile {
            margin-bottom: 1rem !important;
            padding: 0 0.5rem !important;
        }
        
        .stats-card-mobile .card {
            margin-bottom: 0 !important;
            min-height: 120px !important;
            border-radius: 1rem !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
        }
        
        .stats-card-mobile .card-body {
            padding: 1rem 0.5rem !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            text-align: center !important;
        }
        
        .stats-card-mobile h4 {
            font-size: 1.5rem !important;
            margin-bottom: 0.3rem !important;
        }
        
        .stats-card-mobile .text-muted {
            font-size: 0.75rem !important;
            line-height: 1.2 !important;
        }
        
        .stats-card-mobile i {
            font-size: 1.2rem !important;
            margin-bottom: 0.5rem !important;
        }
    }
    
    /* RESPONSIVE PARA ESTADÍSTICAS - MÓVIL */
    @media (max-width: 768px) {
        .stats-card-mobile {
            margin-bottom: 1rem !important;
            height: 100% !important;
        }
        
        .stats-card-mobile .card {
            height: 100% !important;
            min-height: 130px !important;
            border-radius: 1rem !important;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08) !important;
        }
        
        .stats-card-mobile .card:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 6px 16px rgba(0,0,0,0.12) !important;
        }
        
        .stats-card-mobile .card-body {
            padding: 1.25rem 1rem !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            text-align: center !important;
        }
        
        .stats-card-mobile h4 {
            font-size: 1.8rem !important;
            margin-bottom: 0.5rem !important;
            font-weight: 700 !important;
        }
        
        .stats-card-mobile .text-muted {
            font-size: 0.8rem !important;
            line-height: 1.3 !important;
            text-align: center !important;
        }
        
        .stats-card-mobile i {
            font-size: 1.8rem !important;
            margin-bottom: 0.75rem !important;
        }
    }
    
    /* Touch-friendly interactions */
    @media (hover: none) and (pointer: coarse) {
        .assessment-card:hover {
            transform: none;
        }
        
        .assessment-card:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }
    }
    
    /* High contrast mode for accessibility */
    @media (prefers-contrast: high) {
        .assessment-card {
            border-width: 2px;
        }
        
        .assessment-badge {
            border: 1px solid #4e73df;
        }
    }
    
    /* Reduced motion preferences */
    @media (prefers-reduced-motion: reduce) {
        .assessment-card {
            transition: none;
        }
        
        .assessment-card:hover {
            transform: none;
        }
    }
    
    /* Estilos adicionales para interacciones móviles */
    .selection-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #28a745;
        color: white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        animation: selectionPulse 0.3s ease-out;
        z-index: 10;
    }
    
    @keyframes selectionPulse {
        0% {
            transform: scale(0);
            opacity: 0;
        }
        50% {
            transform: scale(1.2);
            opacity: 1;
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }
    
    .assessment-card.selected {
        border-color: #28a745;
        box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25);
        background: rgba(40, 167, 69, 0.05);
    }
    
    .assessment-preview-card {
        background: rgba(13, 110, 253, 0.1);
        border: 1px solid rgba(13, 110, 253, 0.3);
        border-radius: 8px;
        padding: 1rem;
    }
    
    /* Mejoras para modales en móvil */
    @media (max-width: 575.98px) {
        .modal-dialog {
            margin: 0.5rem;
        }
        
        .modal-content {
            border-radius: 12px;
        }
        
        .modal-header {
            padding: 1rem;
        }
        
        .modal-title {
            font-size: 1.1rem;
        }
        
        .modal-body {
            padding: 1rem;
        }
        
        .modal-footer {
            padding: 1rem;
            gap: 0.5rem;
        }
        
        .assessment-preview-card {
            padding: 0.75rem;
        }
    }
    
    /* Botones táctiles mejorados */
    @media (hover: none) and (pointer: coarse) {
        .assessment-card {
            transition: background-color 0.2s ease;
        }
        
        .assessment-card:active {
            background: rgba(13, 110, 253, 0.1);
            transform: scale(0.98);
        }
        
        .btn {
            min-height: 44px;
            padding: 0.75rem 1rem;
        }
        
        .btn-sm {
            min-height: 40px;
            padding: 0.5rem 0.75rem;
        }
    }
    
    .evaluation-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        position: relative;
    }
    
    .evaluation-card.recent-evaluation {
        border-left: 4px solid #28a745;
    }
    
    .recent-badge {
        position: absolute;
        top: -8px;
        right: 1rem;
        background: #28a745;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .evaluation-icon {
        width: 45px;
        height: 45px;
        background: var(--bs-primary);
        color: white;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .evaluation-title {
        color: #333;
        font-weight: 600;
        margin: 0;
    }
    
    .evaluation-meta {
        display: flex;
        gap: 1rem;
    }
    
    .meta-item {
        font-size: 0.85rem;
        color: #666;
    }
    
    .score-display {
        text-align: center;
        margin-bottom: 0.5rem;
    }
    
    .score-display.score-low { color: #dc3545; }      /* Rojo - Bajo 40% */
    .score-display.score-medium { color: #007bff; }   /* Azul - 40-79% */
    .score-display.score-high { color: #28a745; }     /* Verde - 80%+ */
    
    .score-number {
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1;
    }
    
    .score-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .section-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }
    
    .interpretation-text {
        font-size: 0.9rem;
        color: #666;
        line-height: 1.5;
        margin: 0;
    }
    
    .dimensions-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .dimension-item {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 0.5rem;
        flex: 1;
        min-width: 120px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .dimension-name {
        font-size: 0.8rem;
        color: #666;
    }
    
    .dimension-score {
        font-weight: 600;
        color: #333;
    }
    
    .evaluation-actions .btn-block {
        width: 100%;
    }
    
    .quick-stats {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
    }
    
    .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .stat-item:last-child {
        margin-bottom: 0;
    }
    
    .stat-label {
        font-size: 0.8rem;
        color: #666;
    }
    
    .stat-value {
        font-weight: 600;
        color: #333;
    }
    
    /* FORZAR GRID 2X2 EN MÓVIL PARA ESTADÍSTICAS - SÚPER ESPECÍFICO */
    @media (max-width: 767.98px) {
        .row.mb-4 > .stats-card-mobile {
            flex: 0 0 50% !important;
            max-width: 50% !important;
            width: 50% !important;
            height: 140px !important;
        }
        
        .stats-card-mobile {
            padding: 0 0.5rem !important;
            height: 140px !important;
        }
        
        .stats-card-mobile .card {
            width: 100% !important;
            height: 140px !important;
            min-height: 140px !important;
            max-height: 140px !important;
            margin-bottom: 1rem !important;
            display: flex !important;
            flex-direction: column !important;
        }
        
        .stats-card-mobile .card-body {
            flex: 1 !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            text-align: center !important;
            padding: 1rem 0.75rem !important;
        }
        
        .stats-card-mobile h4 {
            font-size: 1.5rem !important;
            margin-bottom: 0.25rem !important;
            font-weight: 600 !important;
            line-height: 1.2 !important;
        }
        
        .stats-card-mobile .text-muted,
        .stats-card-mobile .small {
            font-size: 0.75rem !important;
            line-height: 1.1 !important;
            margin-bottom: 0 !important;
        }
        
        .stats-card-mobile i,
        .stats-card-mobile .fa-2x {
            font-size: 1.4rem !important;
            margin-bottom: 0.4rem !important;
        }
    }
    
    /* IGUALAR TAMAÑOS EN DESKTOP TAMBIÉN */
    @media (min-width: 768px) {
        .stats-card-mobile {
            height: 160px !important;
        }
        
        .stats-card-mobile .card {
            height: 160px !important;
            min-height: 160px !important;
            max-height: 160px !important;
            display: flex !important;
            flex-direction: column !important;
        }
        
        .stats-card-mobile .card-body {
            flex: 1 !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            text-align: center !important;
        }
    }
    
    /* ESTILOS ESPECÍFICOS PARA MODAL DE INVITACIÓN */
    #invitationSuccessModal {
        z-index: 10000 !important;
    }
    
    #invitationSuccessModal .modal-backdrop {
        z-index: 9999 !important;
    }
    
    #invitationSuccessModal .modal-dialog {
        z-index: 10001 !important;
    }
    
    #invitationSuccessModal .modal-content {
        border-radius: 12px !important;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2) !important;
    }
    
    #invitationSuccessModal .modal-header {
        border-top-left-radius: 12px !important;
        border-top-right-radius: 12px !important;
    }
    
    #invitationMessage {
        max-height: 300px !important;
        overflow-y: auto !important;
        border: 1px solid #dee2e6 !important;
        border-radius: 6px !important;
        background: #ffffff !important;
    }
    
    .invitation-message-container {
        position: relative !important;
    }
    
    .invitation-message-container:hover {
        border-color: #0d6efd !important;
    }
    
    /* FORZAR ACCESIBILIDAD DEL MODAL - SIN BACKDROP */
    .modal-backdrop {
        display: none !important;
        opacity: 0 !important;
    }
    
    body.modal-open {
        overflow: auto !important;
    }
    
    /* Asegurar que todos los elementos del modal sean clickeables */
    #invitationSuccessModal * {
        pointer-events: auto !important;
    }
    
    #invitationSuccessModal .modal-content {
        pointer-events: auto !important;
        position: relative !important;
        z-index: 10002 !important;
    }
    
    /* Asegurar que los botones del modal siempre sean clickeables */
    #invitationSuccessModal .btn {
        pointer-events: auto !important;
        position: relative !important;
        z-index: 10003 !important;
    }
    
    /* Modal sin backdrop - más prominente */
    #invitationSuccessModal .modal-dialog {
        box-shadow: 0 10px 30px rgba(0,0,0,0.3) !important;
        border: 2px solid #28a745 !important;
        border-radius: 10px !important;
    }
    }
    
    /* Botones del modal siempre accesibles */
    #invitationSuccessModal button {
        cursor: pointer !important;
        pointer-events: auto !important;
        z-index: 10002 !important;
        position: relative !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Chart.js para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/static/js/recommendations.js?v={{ get_file_version('js/recommendations.js') }}"></script>
<link rel="stylesheet" href="/static/css/unified-dashboard.css?v={{ get_file_version('css/unified-dashboard.css') }}">

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-secondary">
                <div class="card-body dashboard-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="header-info">
                            <h3 class="text-white mb-1">Dashboard Coach</h3>
                            <p class="text-muted mb-0">Bienvenido, <span id="coachName">Coach</span></p>
                        </div>
                        <div class="btn-group-mobile d-flex gap-2">
                            <button class="btn btn-outline-light btn-sm" onclick="refreshDashboard()" title="Actualizar">
                                <i class="fas fa-sync-alt me-1"></i><span class="d-none d-sm-inline">Actualizar</span>
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="window.location.href='/'" title="Inicio">
                                <i class="fas fa-home me-1"></i><span class="d-none d-sm-inline">Inicio</span>
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="window.location.href='/coach-login'" title="Salir">
                                <i class="fas fa-sign-out-alt me-1"></i><span class="d-none d-sm-inline">Salir</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-6 col-md-3 stats-card-mobile">
            <div class="card bg-dark border-secondary text-center">
                <div class="card-body">
                    <i class="fas fa-users fa-2x text-primary mb-3"></i>
                    <h4 class="text-white" id="totalCoachees">0</h4>
                    <p class="text-muted mb-0 small">Total Coachees</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 stats-card-mobile">
            <div class="card bg-dark border-secondary text-center">
                <div class="card-body">
                    <i class="fas fa-clipboard-check fa-2x text-success mb-3"></i>
                    <h4 class="text-white" id="completedAssessments">0</h4>
                    <p class="text-muted mb-0 small">Evaluaciones Completadas</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 stats-card-mobile">
            <div class="card bg-dark border-secondary text-center">
                <div class="card-body">
                    <i class="fas fa-hourglass-half fa-2x text-warning mb-3"></i>
                    <h4 class="text-white" id="pendingAssessments">0</h4>
                    <p class="text-muted mb-0 small">Evaluaciones Pendientes</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 stats-card-mobile">
            <div class="card bg-dark border-secondary text-center">
                <div class="card-body">
                    <i class="fas fa-chart-bar fa-2x text-info mb-3"></i>
                    <h4 class="text-white" id="avgScore">0%</h4>
                    <p class="text-muted mb-0 small">Promedio General</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Sidebar Navigation -->
        <div class="col-md-3">
            <div class="card sidebar sidebar-white sidebar-force-white" style="background: white !important; background-color: white !important; border: 1px solid #dee2e6 !important;">
                <div class="card-header sidebar-header-white sidebar-header-force" style="background: #f8f9fa !important; background-color: #f8f9fa !important; color: #333 !important; border-bottom: 1px solid #dee2e6 !important;">
                    <h6 class="mb-0 sidebar-title-white sidebar-title-force" style="color: #333 !important; font-weight: 600 !important;">
                        <i class="fas fa-tachometer-alt me-2" style="color: #333 !important;"></i>Panel de Control
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <a href="javascript:void(0)" class="list-group-item list-group-item-action border-secondary active" 
                           onclick="showModule('mis-coachees'); return false;" data-module="mis-coachees">
                            <i class="fas fa-users me-3"></i>Mis Coachees
                        </a>
                        <a href="javascript:void(0)" class="list-group-item list-group-item-action border-secondary" 
                           onclick="showModule('gestion-tareas'); return false;" data-module="gestion-tareas">
                            <i class="fas fa-tasks me-3"></i>Gestión de Tareas
                        </a>
                        <a href="javascript:void(0)" class="list-group-item list-group-item-action border-secondary" 
                           onclick="showModule('invitar-coachee'); return false;" data-module="invitar-coachee">
                            <i class="fas fa-envelope me-3"></i>Invitar Coachee
                        </a>
                        <a href="javascript:void(0)" class="list-group-item list-group-item-action border-secondary" 
                           onclick="showModule('seleccionar-evaluaciones'); return false;" data-module="seleccionar-evaluaciones">
                            <i class="fas fa-clipboard-list me-3"></i>Evaluaciones
                        </a>
                        <a href="javascript:void(0)" class="list-group-item list-group-item-action border-secondary" 
                           onclick="showModule('agregar-contenido'); return false;" data-module="agregar-contenido">
                            <i class="fas fa-plus-circle me-3"></i>Contenido
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="col-md-9" style="padding-left: 0.75rem; padding-right: 0.75rem; overflow: visible;">
            <!-- Mis Coachees Module -->
            <div id="mis-coachees" class="module-content">
                <div class="card sidebar-white border-secondary" style="--theme-card-bg: white !important; background-color: white !important; margin-bottom: 1rem;">
                    <div class="card-header" style="background-color: white !important; border-bottom: 1px solid #dee2e6;">
                        <h5 class="text-dark mb-0">Mis Coachees</h5>
                    </div>
                    <div class="card-body" style="background-color: white !important; padding: 1rem; overflow: visible;">
        <!-- Vista tabla para desktop -->
        <div class="d-none d-md-block" style="margin: 0; padding: 0; overflow: hidden;">
            <table class="table table-striped table-hover" style="margin-bottom: 0; width: 100%; table-layout: fixed;">
                <thead class="table-light">
                    <tr>
                        <th style="color: #212529; padding: 0.5rem 0.3rem; font-size: 0.85rem;">Nombre</th>
                        <th style="color: #212529; padding: 0.5rem 0.3rem; font-size: 0.85rem;">Email</th>
                        <th style="color: #212529; padding: 0.5rem 0.3rem; font-size: 0.85rem;">Contraseña</th>
                        <th style="color: #212529; padding: 0.5rem 0.3rem; text-align: center; font-size: 0.85rem;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="coacheesTableBody">
                    <tr>
                        <td colspan="4" class="text-center text-muted" style="padding: 2rem;">Cargando coachees...</td>
                    </tr>
                </tbody>
            </table>
        </div>                        <!-- Vista cards para móvil -->
                        <div class="d-block d-md-none" id="coacheesCardsContainer">
                            <div class="text-center text-muted p-3">Cargando coachees...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gestión de Tareas Module -->
            <div id="gestion-tareas" class="module-content" style="display: none;">
                <div class="card sidebar-white border-secondary" style="--theme-card-bg: white !important; background-color: white !important;">
                    <div class="card-header" style="background-color: white !important; border-bottom: 1px solid #dee2e6;">
                        <h5 class="text-dark mb-0">Gestión de Tareas</h5>
                    </div>
                    <div class="card-body" style="background-color: white !important;">
                        
                        <!-- Formulario de Creación de Tareas -->
                        <div class="card mb-4" style="border: 1px solid #e3e6f0; border-radius: 8px;">
                            <div class="card-header bg-light">
                                <h6 class="mb-0 text-dark">
                                    <i class="fas fa-plus-circle me-2"></i>Crear Nueva Tarea
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Formulario responsive -->
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label text-dark small fw-bold">Título de la Tarea</label>
                                        <input type="text" class="form-control border-secondary" 
                                               placeholder="Ingrese el título" id="taskTitle" 
                                               style="background-color: white; color: #212529;">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-dark small fw-bold">Categoría</label>
                                        <select class="form-select border-secondary" id="taskCategory" 
                                                style="background-color: white; color: #212529;">
                                            <option value="">Seleccionar categoría</option>
                                            <option value="coaching">Coaching</option>
                                            <option value="evaluacion">Evaluación</option>
                                            <option value="desarrollo">Desarrollo</option>
                                            <option value="seguimiento">Seguimiento</option>
                                            <option value="planificacion">Planificación</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-dark small fw-bold">Asignar a Coachee</label>
                                        <select class="form-select border-secondary" id="taskCoachee" 
                                                style="background-color: white; color: #212529;">
                                            <option value="">Seleccionar coachee</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-dark small fw-bold">Fecha de Vencimiento</label>
                                        <input type="date" class="form-control border-secondary" 
                                               id="taskDueDate" 
                                               style="background-color: white; color: #212529;">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label text-dark small fw-bold">Descripción</label>
                                        <textarea class="form-control border-secondary" 
                                                  placeholder="Descripción detallada de la tarea" 
                                                  id="taskDescription" rows="3" 
                                                  style="background-color: white; color: #212529;"></textarea>
                                    </div>
                                    <div class="col-12">
                                        <button class="btn btn-primary w-100" onclick="createTask()">
                                            <i class="fas fa-plus me-1"></i>Crear Tarea
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Lista de Tareas -->
                        <div class="card" style="border: 1px solid #e3e6f0; border-radius: 8px;">
                            <div class="card-header bg-light">
                                <h6 class="mb-0 text-dark">
                                    <i class="fas fa-tasks me-2"></i>Lista de Tareas
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <!-- Vista tabla para desktop -->
                                <div class="table-responsive d-none d-md-block">
                                    <table class="table table-striped mb-0">
                                        <thead>
                                            <tr>
                                                <th style="color: #212529;">Tarea</th>
                                                <th style="color: #212529;">Coachee</th>
                                                <th style="color: #212529;">Categoría</th>
                                                <th style="color: #212529;">Estado</th>
                                                <th style="color: #212529;">Progreso</th>
                                                <th style="color: #212529;">Vencimiento</th>
                                                <th style="color: #212529;">Creada</th>
                                                <th style="color: #212529;">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tasksTableBody">
                                            <tr>
                                                <td colspan="8" class="text-center text-muted">No hay tareas creadas</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Vista cards para móvil -->
                                <div class="d-block d-md-none p-3" id="tasksCardsContainer">
                                    <div class="text-center text-muted">No hay tareas creadas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invitar Coachee Module -->
            <div id="invitar-coachee" class="module-content" style="display: none;">
                <div class="card sidebar-white border-secondary" style="--theme-card-bg: white !important; background-color: white !important;">
                    <div class="card-header" style="background-color: white !important; border-bottom: 1px solid #dee2e6;">
                        <h5 class="text-dark mb-0">Invitar Nuevo Coachee</h5>
                        <p class="text-muted small mb-0">Invita a un coachee y asigna una evaluación inicial</p>
                    </div>
                    <div class="card-body" style="background-color: white !important;">
                        <form id="inviteForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-dark">Nombre</label>
                                    <input type="text" class="form-control border-secondary" 
                                           id="coacheeName" required style="background-color: white; color: #212529;">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-dark">Email</label>
                                    <input type="email" class="form-control border-secondary" 
                                           id="coacheeEmail" required style="background-color: white; color: #212529;">
                                </div>
                            </div>
                            
                            <!-- Sección de evaluación -->
                            <div class="mb-3">
                                <label class="form-label text-dark">
                                    <i class="fas fa-clipboard-list me-1 text-primary"></i>
                                    Evaluación a Asignar (Opcional)
                                </label>
                                <select class="form-select border-secondary" id="assignedAssessment" 
                                        style="background-color: white; color: #212529;">
                                    <option value="">Seleccionar evaluación...</option>
                                </select>
                                <div class="form-text text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Si seleccionas una evaluación, se asignará automáticamente al coachee
                                </div>
                            </div>
                            
                            <!-- Mensaje personalizado -->
                            <div class="mb-3">
                                <label class="form-label text-dark">Mensaje Personalizado (Opcional)</label>
                                <textarea class="form-control border-secondary" id="customMessage" rows="3" 
                                          style="background-color: white; color: #212529;" 
                                          placeholder="Mensaje de bienvenida para tu coachee..."></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-paper-plane me-1"></i>Crear Coachee
                            </button>
                        </form>
                        
                        <!-- Modal para mostrar invitación creada -->
                        <div class="modal fade" id="invitationSuccessModal" tabindex="-1" aria-labelledby="invitationSuccessModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header bg-success text-white">
                                        <h5 class="modal-title" id="invitationSuccessModalLabel">
                                            <i class="fas fa-check-circle me-2"></i>¡Coachee Creado Exitosamente!
                                        </h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" onclick="closeInvitationModal()"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6 class="text-primary">
                                                    <i class="fas fa-user me-1"></i>Información del Coachee
                                                </h6>
                                                <div class="bg-light p-3 rounded mb-3">
                                                    <p class="mb-1"><strong>Nombre:</strong> <span id="modalCoacheeName"></span></p>
                                                    <p class="mb-1"><strong>Email:</strong> <span id="modalCoacheeEmail"></span></p>
                                                    <p class="mb-1"><strong>Usuario:</strong> <span id="modalCoacheeUsername" class="text-primary"></span></p>
                                                    <p class="mb-0"><strong>Contraseña:</strong> <span id="modalCoacheePassword" class="text-danger fw-bold"></span></p>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <h6 class="text-primary">
                                                    <i class="fas fa-share-alt me-1"></i>Compartir Invitación
                                                </h6>
                                                <div class="d-grid gap-2">
                                                    <button class="btn btn-outline-primary" onclick="copyInvitationToClipboard()">
                                                        <i class="fas fa-copy me-1"></i>Copiar al Portapapeles
                                                    </button>
                                                    <button class="btn btn-success" onclick="shareViaWhatsApp()">
                                                        <i class="fab fa-whatsapp me-1"></i>Enviar por WhatsApp
                                                    </button>
                                                    <button class="btn btn-info" onclick="shareViaEmail()">
                                                        <i class="fas fa-envelope me-1"></i>Enviar por Email
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <hr>
                                        
                        <h6 class="text-primary">
                            <i class="fas fa-comment-dots me-1"></i>Mensaje de Invitación
                        </h6>
                        <div class="invitation-message-container bg-light p-3 rounded border" style="cursor: text;">
                            <div id="invitationMessage" style="white-space: pre-line; font-family: monospace; font-size: 0.9rem; user-select: text; -webkit-user-select: text; -moz-user-select: text; -ms-user-select: text; cursor: text; line-height: 1.4;"></div>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>Puedes seleccionar y copiar el texto directamente desde aquí
                        </small>                                        <div id="assessmentAssignedInfo" class="alert alert-info mt-3" style="display: none;">
                                            <i class="fas fa-clipboard-check me-1"></i>
                                            <strong>Evaluación Asignada:</strong> <span id="assignedAssessmentName"></span>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" onclick="closeInvitationModal()">
                                            <i class="fas fa-times me-1"></i>Cerrar Modal
                                        </button>
                                        <button type="button" class="btn btn-primary" onclick="copyInvitationToClipboard()">
                                            <i class="fas fa-copy me-1"></i>Copiar Mensaje
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seleccionar Evaluaciones Module -->
            <div id="seleccionar-evaluaciones" class="module-content" style="display: none;">
                <div class="card sidebar-white border-secondary" style="--theme-card-bg: white !important; background-color: white !important;">
                    <div class="card-header d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center" style="background-color: white !important; border-bottom: 1px solid #dee2e6;">
                        <div>
                            <h5 class="text-dark mb-1">
                                <i class="fas fa-clipboard-list me-2 text-primary"></i>
                                Evaluaciones Disponibles
                            </h5>
                            <p class="text-muted mb-0 small">Selecciona evaluaciones para asignar a tus coachees</p>
                        </div>
                        <!-- Botón de actualizar para móvil -->
                        <button class="btn btn-outline-primary btn-sm mt-2 mt-sm-0" onclick="loadAvailableAssessments()" title="Actualizar evaluaciones">
                            <i class="fas fa-sync-alt me-1"></i>
                            <span class="d-none d-sm-inline">Actualizar</span>
                        </button>
                    </div>
                    <div class="card-body" style="background-color: white !important; padding: 1rem;">
                        <!-- Loading spinner -->
                        <div id="assessments-loading" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando evaluaciones...</span>
                            </div>
                            <p class="text-muted small mt-2 mb-0">Cargando evaluaciones disponibles...</p>
                        </div>
                        
                        <!-- Assessments list -->
                        <div id="assessments-list" style="display: none;">
                            <!-- Assessment cards will be populated here -->
                        </div>
                        
                        <!-- Error message -->
                        <div id="assessments-error" class="alert alert-warning d-flex align-items-center" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <div>
                                <strong>Error:</strong> No se pudieron cargar las evaluaciones disponibles.
                                <br><small>Intenta actualizar la página o contacta al administrador.</small>
                            </div>
                        </div>
                        
                        <!-- No assessments message -->
                        <div id="no-assessments" class="text-center py-4" style="display: none;">
                            <div class="mb-3">
                                <i class="fas fa-clipboard-list text-muted" style="font-size: 3rem;"></i>
                            </div>
                            <h6 class="text-muted mb-2">No hay evaluaciones disponibles</h6>
                            <p class="text-muted small mb-3">Las evaluaciones aparecerán aquí cuando estén disponibles.</p>
                            <button class="btn btn-primary btn-sm" onclick="loadAvailableAssessments()">
                                <i class="fas fa-sync-alt me-1"></i>Intentar de nuevo
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agregar Contenido Module -->
            <div id="agregar-contenido" class="module-content" style="display: none;">
                <div class="card sidebar-white border-secondary" style="--theme-card-bg: white !important; background-color: white !important;">
                    <div class="card-header" style="background-color: white !important; border-bottom: 1px solid #dee2e6;">
                        <h5 class="text-dark mb-0">
                            <i class="fas fa-video me-2 text-primary"></i>
                            Gestión de Contenido
                        </h5>
                    </div>
                    <div class="card-body" style="background-color: white !important;">
                        <!-- Pestañas para organizar contenido -->
                        <ul class="nav nav-tabs mb-4" id="contentTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="assign-content-tab" data-bs-toggle="tab" 
                                    data-bs-target="#assign-content-pane" type="button" role="tab">
                                    <i class="fas fa-plus-circle me-1"></i>Asignar Video
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="manage-content-tab" data-bs-toggle="tab" 
                                    data-bs-target="#manage-content-pane" type="button" role="tab">
                                    <i class="fas fa-list me-1"></i>Contenido Asignado
                                </button>
                            </li>
                        </ul>

                        <!-- Contenido de las pestañas -->
                        <div class="tab-content" id="contentTabContent">
                            <!-- Pestaña: Asignar Video -->
                            <div class="tab-pane fade show active" id="assign-content-pane" role="tabpanel">
                                <div class="row">
                                    <div class="col-lg-8">
                                        <form id="assignContentForm">
                                            <div class="mb-3">
                                                <label for="coacheeSelect" class="form-label">
                                                    <i class="fas fa-user me-1"></i>Seleccionar Coachee
                                                </label>
                                                <select class="form-select" id="coacheeSelect" required>
                                                    <option value="">Selecciona un coachee...</option>
                                                </select>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="videoUrl" class="form-label">
                                                    <i class="fab fa-youtube me-1 text-danger"></i>URL del Video de YouTube
                                                </label>
                                                <input type="url" class="form-control" id="videoUrl" 
                                                    placeholder="https://www.youtube.com/watch?v=..." required>
                                                <div class="form-text">
                                                    Ejemplo: https://www.youtube.com/watch?v=b6vozRQhtCc
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="contentTitle" class="form-label">
                                                    <i class="fas fa-heading me-1"></i>Título del Contenido
                                                </label>
                                                <input type="text" class="form-control" id="contentTitle" 
                                                    placeholder="Título descriptivo del video" required>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="contentDescription" class="form-label">
                                                    <i class="fas fa-align-left me-1"></i>Descripción (Opcional)
                                                </label>
                                                <textarea class="form-control" id="contentDescription" rows="3" 
                                                    placeholder="Describe el contenido del video y por qué es relevante para el coachee..."></textarea>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="videoDuration" class="form-label">
                                                    <i class="fas fa-clock me-1"></i>Duración (minutos, opcional)
                                                </label>
                                                <input type="number" class="form-control" id="videoDuration" 
                                                    placeholder="15" min="1" max="999">
                                            </div>
                                            
                                            <div class="d-flex gap-2">
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-paper-plane me-1"></i>
                                                    Asignar Video
                                                </button>
                                                <button type="button" class="btn btn-secondary" onclick="resetAssignForm()">
                                                    <i class="fas fa-undo me-1"></i>
                                                    Limpiar
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                    
                                    <div class="col-lg-4">
                                        <div class="card bg-light">
                                            <div class="card-header">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-lightbulb me-1 text-warning"></i>
                                                    Vista Previa
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="videoPreview" class="text-center text-muted">
                                                    <i class="fas fa-video fa-3x mb-2"></i>
                                                    <p class="small">La vista previa del video aparecerá aquí cuando ingreses una URL válida</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <h6><i class="fas fa-info-circle me-1 text-info"></i>Formatos Soportados</h6>
                                            <ul class="list-unstyled small text-muted">
                                                <li><i class="fab fa-youtube me-1"></i>YouTube videos</li>
                                                <li><i class="fas fa-link me-1"></i>Enlaces directos</li>
                                                <li><i class="fas fa-file-video me-1"></i>Videos embebidos</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pestaña: Contenido Asignado -->
                            <div class="tab-pane fade" id="manage-content-pane" role="tabpanel">
                                <!-- Controles de filtrado -->
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title mb-3">
                                            <i class="fas fa-filter me-2"></i>Filtros y Opciones de Vista
                                        </h6>
                                        <div class="row g-3">
                                            <div class="col-md-3">
                                                <label for="coacheeFilter" class="form-label small">Filtrar por Coachee</label>
                                                <select class="form-select" id="coacheeFilter">
                                                    <option value="">Todos los coachees</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="viewModeFilter" class="form-label small">Modo de Vista</label>
                                                <select class="form-select" id="viewModeFilter">
                                                    <option value="all">Todas las asignaciones</option>
                                                    <option value="unique">Contenido único</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="statusFilter" class="form-label small">Estado</label>
                                                <select class="form-select" id="statusFilter">
                                                    <option value="">Todos los estados</option>
                                                    <option value="viewed">Solo vistos</option>
                                                    <option value="pending">Solo pendientes</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="contentSearch" class="form-label small">Buscar</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="contentSearch" 
                                                        placeholder="Buscar contenido...">
                                                    <button class="btn btn-outline-primary" onclick="applyContentFilters()">
                                                        <i class="fas fa-search"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-12">
                                                <button class="btn btn-sm btn-outline-secondary me-2" onclick="clearContentFilters()">
                                                    <i class="fas fa-times me-1"></i>Limpiar Filtros
                                                </button>
                                                <button class="btn btn-sm btn-outline-primary" onclick="refreshContentList()">
                                                    <i class="fas fa-sync-alt me-1"></i>Actualizar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="assignedContentList">
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando contenido...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver evaluaciones del coachee -->
<div class="modal fade" id="coacheeEvaluationsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Evaluaciones de <span id="modalCoacheeName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="coacheeEvaluationsContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver detalles de evaluación -->
<div class="modal fade" id="evaluationDetailsModal" tabindex="-1" aria-labelledby="evaluationDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header modal-header-dark">
                <h5 class="modal-title" id="evaluationDetailsModalLabel">
                    <i class="fas fa-chart-radar me-2"></i>
                    Detalles de Evaluación
                </h5>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-light btn-sm" onclick="printEvaluationReport()" title="Imprimir Reporte">
                        <i class="fas fa-print me-1"></i>
                        Imprimir
                    </button>
                    <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal" title="Cerrar">
                        <i class="fas fa-times me-1"></i>
                        Cerrar
                    </button>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body" id="evaluationDetailsContent">
                <div class="loading-spinner">
                    <div class="spinner-border spinner-border-custom" role="status">
                        <span class="visually-hidden">Cargando detalles...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-progress" onclick="printEvaluationReport()">
                    <i class="fas fa-print me-2"></i>
                    Imprimir Reporte
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para asignar evaluación/tarea -->
<div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Asignar a <span id="assignModalCoacheeName"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Pestañas -->
                <ul class="nav nav-tabs mb-3" id="assignTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="evaluation-tab" data-bs-toggle="tab" data-bs-target="#evaluation-pane" type="button" role="tab">
                            <i class="fas fa-clipboard-check me-1"></i>Evaluación
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="task-tab" data-bs-toggle="tab" data-bs-target="#task-pane" type="button" role="tab">
                            <i class="fas fa-tasks me-1"></i>Tarea
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="assignTabContent">
                    <!-- Pestaña de Evaluación -->
                    <div class="tab-pane fade show active" id="evaluation-pane" role="tabpanel">
                        <form id="assignEvaluationForm">
                            <input type="hidden" id="targetCoacheeId" value="">
                            
                            <div class="mb-3">
                                <label for="assignAssessmentSelect" class="form-label">Seleccionar evaluación:</label>
                                <select class="form-select" id="assignAssessmentSelect" required>
                                    <option value="">Cargando evaluaciones...</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="assignEvaluationMessage" class="form-label">Mensaje personalizado (opcional):</label>
                                <textarea class="form-control" id="assignEvaluationMessage" rows="3" 
                                    placeholder="Mensaje para el coachee..."></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="assignEvaluationDueDate" class="form-label">Fecha límite (opcional):</label>
                                <input type="date" class="form-control" id="assignEvaluationDueDate">
                            </div>
                        </form>
                    </div>

                    <!-- Pestaña de Tarea -->
                    <div class="tab-pane fade" id="task-pane" role="tabpanel">
                        <form id="assignTaskForm">
                            <div class="mb-3">
                                <label for="assignTaskTitle" class="form-label">Título de la tarea:</label>
                                <input type="text" class="form-control" id="assignTaskTitle" required
                                    placeholder="Ej: Completar ejercicio de reflexión">
                            </div>
                            
                            <div class="mb-3">
                                <label for="assignTaskDescription" class="form-label">Descripción:</label>
                                <textarea class="form-control" id="assignTaskDescription" rows="4" required
                                    placeholder="Describe la tarea que debe realizar el coachee..."></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="assignTaskCategory" class="form-label">Categoría:</label>
                                <select class="form-select" id="assignTaskCategory" required>
                                    <option value="">Seleccionar categoría</option>
                                    <option value="evaluation">Evaluación</option>
                                    <option value="coaching">Coaching</option>
                                    <option value="development">Desarrollo</option>
                                    <option value="feedback">Feedback</option>
                                    <option value="reflection">Reflexión</option>
                                    <option value="goal">Objetivo</option>
                                    <option value="other">Otro</option>
                                </select>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="assignTaskPriority" class="form-label">Prioridad:</label>
                                    <select class="form-select" id="assignTaskPriority">
                                        <option value="medium">Media</option>
                                        <option value="high">Alta</option>
                                        <option value="low">Baja</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="assignTaskDueDate" class="form-label">Fecha límite (opcional):</label>
                                    <input type="date" class="form-control" id="assignTaskDueDate">
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="executeAssignment()">
                    <i class="fas fa-paper-plane me-1"></i>Asignar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para mostrar evaluaciones asignadas -->
<div class="modal fade" id="assignedAssessmentsModal" tabindex="-1" aria-labelledby="assignedAssessmentsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="assignedAssessmentsModalLabel">
                    <i class="fas fa-clipboard-list me-2"></i>Evaluaciones Asignadas
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="assignedAssessmentsContent">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin fa-2x text-info"></i>
                        <p class="mt-2">Cargando evaluaciones asignadas...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar coachee -->
<div class="modal fade" id="editCoacheeModal" tabindex="-1" aria-labelledby="editCoacheeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="editCoacheeModalLabel">
                    <i class="fas fa-edit me-2"></i>Editar Coachee
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editCoacheeForm">
                    <input type="hidden" id="editCoacheeId" name="coacheeId">
                    
                    <div class="mb-3">
                        <label for="editCoacheeName" class="form-label">
                            <i class="fas fa-user me-1"></i>Nombre Completo
                        </label>
                        <input type="text" class="form-control" id="editCoacheeName" name="full_name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editCoacheeEmail" class="form-label">
                            <i class="fas fa-envelope me-1"></i>Email
                        </label>
                        <input type="email" class="form-control" id="editCoacheeEmail" name="email" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editCoacheePassword" class="form-label">
                            <i class="fas fa-lock me-1"></i>Nueva Contraseña
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="editCoacheePassword" name="password" placeholder="Dejar vacío para mantener la actual">
                            <button type="button" class="btn btn-outline-secondary" onclick="toggleEditPassword()">
                                <i class="fas fa-eye" id="editPasswordIcon"></i>
                            </button>
                        </div>
                        <div class="form-text">Mínimo 4 caracteres. Dejar vacío para no cambiar la contraseña.</div>
                    </div>
                </form>
                
                <div id="editCoacheeAlert" class="alert d-none" role="alert"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-warning" onclick="saveCoacheeChanges()" id="saveCoacheeBtn">
                    <i class="fas fa-save me-1"></i>Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let coacheesData = [];
let tasksData = [];

// Función para mostrar módulos
function showModule(moduleId) {
    // Prevenir scroll automático
    if (event) {
        event.preventDefault();
    }
    
    // Ocultar todos los módulos
    document.querySelectorAll('.module-content').forEach(module => {
        module.style.display = 'none';
    });
    
    // Remover clase active de todos los enlaces
    document.querySelectorAll('[data-module]').forEach(link => {
        link.classList.remove('active');
    });
    
    // Mostrar módulo seleccionado
    const selectedModule = document.getElementById(moduleId);
    if (selectedModule) {
        selectedModule.style.display = 'block';
        
        // En móviles, hacer scroll suave hacia el contenido
        if (window.innerWidth <= 768) {
            setTimeout(() => {
                selectedModule.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start',
                    inline: 'nearest'
                });
            }, 100);
        }
    }
    
    // Agregar clase active al enlace seleccionado
    const selectedLink = document.querySelector(`[data-module="${moduleId}"]`);
    if (selectedLink) {
        selectedLink.classList.add('active');
    }
    
    // Cargar datos específicos del módulo si es necesario
    if (moduleId === 'mis-coachees') {
        loadCoachees();
    } else if (moduleId === 'gestion-tareas') {
        loadTasks();
    } else if (moduleId === 'seleccionar-evaluaciones') {
        loadAvailableAssessments();
    } else if (moduleId === 'invitar-coachee') {
        console.log('📋 MODULE-SWITCH: Activando módulo invitar-coachee - cargando evaluaciones');
        loadAssessmentsForInvitation();
    }
    
    return false; // Prevenir comportamiento por defecto
}

// Función para refrescar dashboard
function refreshDashboard() {
    loadCoachees();
    loadTasks();
    loadStats();
}

// Función de logout específica para coach
async function logoutCoach() {
    try {
        const response = await fetch('/api/coach/logout', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            console.log('Coach logout successful');
        } else {
            console.error('Coach logout failed');
        }
        
        // Redirigir al coach login independientemente del resultado
        window.location.href = '/coach-login';
        
    } catch (error) {
        console.error('Error during coach logout:', error);
        // Aún así redirigir en caso de error
        window.location.href = '/coach-login';
    }
}

// Función para cargar estadísticas
function loadStats() {
    console.log('🔄 STATS: Starting to load stats...');
    
    // Verificar que los elementos del DOM existan
    const elements = {
        totalCoachees: document.getElementById('totalCoachees'),
        completedAssessments: document.getElementById('completedAssessments'),
        pendingAssessments: document.getElementById('pendingAssessments'),
        avgScore: document.getElementById('avgScore'),
        coachName: document.getElementById('coachName')
    };
    
    console.log('🔍 STATS: DOM elements check:', elements);
    
    // Verificar elementos faltantes
    const missingElements = Object.keys(elements).filter(key => !elements[key]);
    if (missingElements.length > 0) {
        console.error('❌ STATS: Missing DOM elements:', missingElements);
    }
    
    fetch('/api/coach/profile')
        .then(response => response.json())
        .then(data => {
            console.log('👤 PROFILE: Received profile data:', data);
            if (data.success && elements.coachName) {
                elements.coachName.textContent = data.coach.name || 'Coach';
            }
        })
        .catch(error => console.error('❌ PROFILE: Error loading coach profile:', error));
    
    // Cargar estadísticas generales
    fetch('/api/coach/my-coachees')
        .then(response => response.json())
        .then(data => {
            console.log('📊 STATS: Received data:', data); // Debug log
            
            if (data.success) {
                // Actualizar total de coachees
                if (elements.totalCoachees) {
                    elements.totalCoachees.textContent = data.coachees.length;
                }
                
                let totalEvaluations = 0;
                let totalScore = 0;
                let evaluationsWithScore = 0;
                
                // Calcular estadísticas basado en la nueva estructura
                data.coachees.forEach(coachee => {
                    console.log(`👤 STATS: Processing coachee ${coachee.name}:`, coachee); // Debug log
                    
                    // Contar evaluaciones completadas
                    if (coachee.evaluations_count) {
                        totalEvaluations += coachee.evaluations_count;
                    }
                    
                    // Sumar scores para promedio
                    if (coachee.avg_score) {
                        totalScore += coachee.avg_score * coachee.evaluations_count;
                        evaluationsWithScore += coachee.evaluations_count;
                    }
                });
                
                // Actualizar las tarjetas de estadísticas
                if (elements.completedAssessments) {
                    elements.completedAssessments.textContent = totalEvaluations;
                }
                if (elements.pendingAssessments) {
                    elements.pendingAssessments.textContent = 0; // TODO: Implementar lógica de pendientes
                }
                
                // Calcular promedio general
                const avgScore = evaluationsWithScore > 0 ? Math.round(totalScore / evaluationsWithScore) : 0;
                if (elements.avgScore) {
                    elements.avgScore.textContent = avgScore + '%';
                }
                
                console.log(`📊 STATS: Updated - Coachees: ${data.coachees.length}, Completed: ${totalEvaluations}, Avg: ${avgScore}%`);
            }
        })
        .catch(error => {
            console.error('❌ STATS: Error loading stats:', error);
            // Mostrar valores por defecto en caso de error
            if (elements.totalCoachees) elements.totalCoachees.textContent = '0';
            if (elements.completedAssessments) elements.completedAssessments.textContent = '0';
            if (elements.pendingAssessments) elements.pendingAssessments.textContent = '0';
            if (elements.avgScore) elements.avgScore.textContent = '0%';
        });
}

// Función para cargar evaluaciones disponibles
function loadAvailableAssessments() {
    const loadingElement = document.getElementById('assessments-loading');
    const listElement = document.getElementById('assessments-list');
    const errorElement = document.getElementById('assessments-error');
    const noAssessmentsElement = document.getElementById('no-assessments');
    
    // Mostrar loading y ocultar otros elementos
    loadingElement.style.display = 'block';
    listElement.style.display = 'none';
    errorElement.style.display = 'none';
    noAssessmentsElement.style.display = 'none';
    
    fetch('/api/coach/available-assessments')
        .then(response => response.json())
        .then(data => {
            loadingElement.style.display = 'none';
            
            if (data.success && data.assessments && data.assessments.length > 0) {
                displayAvailableAssessments(data.assessments);
                listElement.style.display = 'block';
            } else {
                noAssessmentsElement.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading assessments:', error);
            loadingElement.style.display = 'none';
            errorElement.style.display = 'block';
        });
}

// Función para mostrar evaluaciones disponibles
function displayAvailableAssessments(assessments) {
    const container = document.getElementById('assessments-list');
    container.innerHTML = '';
    
    if (assessments.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-search text-muted mb-3" style="font-size: 2rem;"></i>
                <h6 class="text-muted">No se encontraron evaluaciones</h6>
                <p class="text-muted small">No hay evaluaciones disponibles en este momento.</p>
            </div>
        `;
        return;
    }
    
    assessments.forEach((assessment, index) => {
        const card = document.createElement('div');
        card.className = 'assessment-card';
        card.setAttribute('data-assessment-id', assessment.id);
        
        // Agregar animación de entrada escalonada
        card.style.animationDelay = `${index * 0.1}s`;
        
        const createdDate = assessment.created_at ? 
            new Date(assessment.created_at).toLocaleDateString('es-ES', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            }) : 'No disponible';
        
        // Determinar color del badge basado en estadísticas
        const badgeClass = assessment.completed_count > 0 ? 'success' : 'primary';
        const badgeIcon = assessment.completed_count > 0 ? 'check-circle' : 'clipboard-list';
        
        card.innerHTML = `
            <div class="assessment-header">
                <h6 class="assessment-title">${assessment.title}</h6>
                <span class="assessment-badge bg-${badgeClass}">
                    <i class="fas fa-${badgeIcon} me-1"></i>
                    ${assessment.completed_count > 0 ? 'Activa' : 'Nueva'}
                </span>
            </div>
            
            <p class="assessment-description">
                ${assessment.description || 'Sin descripción disponible'}
            </p>
            
            <div class="assessment-stats">
                <div class="assessment-stat">
                    <i class="fas fa-question-circle"></i>
                    <span>${assessment.questions_count} ${assessment.questions_count === 1 ? 'pregunta' : 'preguntas'}</span>
                </div>
                <div class="assessment-stat">
                    <i class="fas fa-users"></i>
                    <span>${assessment.completed_count} ${assessment.completed_count === 1 ? 'completada' : 'completadas'}</span>
                </div>
                <div class="assessment-stat">
                    <i class="fas fa-calendar-plus"></i>
                    <span class="d-none d-sm-inline">Creada: </span>${createdDate}</span>
                </div>
            </div>
            
            <!-- Botones de acción -->
            <div class="assessment-actions mt-2">
                <!-- Botón de asignación -->
                <button class="btn btn-outline-success btn-sm w-100" onclick="event.stopPropagation(); openAssignModalFromEvaluation(${assessment.id}, '${assessment.title}')">
                    <i class="fas fa-user-plus me-1"></i>Asignar a Coachee
                </button>
            </div>
        `;
        
        container.appendChild(card);
    });
    
    // Agregar mensaje informativo al final
    const infoMessage = document.createElement('div');
    infoMessage.className = 'alert alert-info mt-3';
    infoMessage.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-info-circle me-2"></i>
            <div>
                <strong>${assessments.length} ${assessments.length === 1 ? 'evaluación disponible' : 'evaluaciones disponibles'}</strong>
                <br><small>Usa el botón "Asignar a Coachee" para asignar evaluaciones a tus coachees.</small>
            </div>
        </div>
    `;
    container.appendChild(infoMessage);
}

// Función para seleccionar una evaluación
function selectAssessment(assessmentId) {
    // Añadir feedback visual inmediato
    const allCards = document.querySelectorAll('.assessment-card');
    const selectedCard = document.querySelector(`[data-assessment-id="${assessmentId}"]`);
    
    // Remover selección previa
    allCards.forEach(card => {
        card.classList.remove('selected');
        card.style.transform = '';
    });
    
    // Añadir selección actual con animación
    if (selectedCard) {
        selectedCard.classList.add('selected');
        
        // Efecto de pulso para feedback táctil en móvil
        selectedCard.style.transform = 'scale(0.98)';
        setTimeout(() => {
            selectedCard.style.transform = 'scale(1)';
        }, 150);
        
        // Añadir indicador visual de selección
        const existingCheck = selectedCard.querySelector('.selection-indicator');
        if (existingCheck) {
            existingCheck.remove();
        }
        
        const selectionIndicator = document.createElement('div');
        selectionIndicator.className = 'selection-indicator';
        selectionIndicator.innerHTML = '<i class="fas fa-check-circle"></i>';
        selectedCard.appendChild(selectionIndicator);
    }
    
    // Mostrar modal de confirmación optimizado para móvil
    const assessmentCard = selectedCard;
    const assessmentTitle = assessmentCard.querySelector('.assessment-title').textContent;
    const assessmentDescription = assessmentCard.querySelector('.assessment-description').textContent;
    
    // Crear modal responsive
    const modalHtml = `
        <div class="modal fade" id="confirmAssessmentModal" tabindex="-1" aria-labelledby="confirmAssessmentModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="confirmAssessmentModalLabel">
                            <i class="fas fa-clipboard-check me-2"></i>Confirmar Evaluación
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-3">
                            <div class="assessment-preview-card">
                                <h6 class="fw-bold text-primary">${assessmentTitle}</h6>
                                <p class="text-muted small mb-0">${assessmentDescription}</p>
                            </div>
                        </div>
                        
                        <div class="alert alert-info d-flex align-items-start">
                            <i class="fas fa-info-circle me-2 mt-1"></i>
                            <div>
                                <strong>¿Deseas asignar esta evaluación?</strong>
                                <br><small>Podrás enviarla a tus coachees para que la completen.</small>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer flex-column flex-sm-row">
                        <button type="button" class="btn btn-outline-secondary mb-2 mb-sm-0 w-100 w-sm-auto" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </button>
                        <button type="button" class="btn btn-primary w-100 w-sm-auto" onclick="confirmAssignAssessment(${assessmentId})">
                            <i class="fas fa-paper-plane me-1"></i>Asignar Evaluación
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal previo si existe
    const existingModal = document.getElementById('confirmAssessmentModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Añadir nuevo modal al DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Mostrar modal con mejor experiencia móvil
    const modal = new bootstrap.Modal(document.getElementById('confirmAssessmentModal'), {
        backdrop: 'static',
        keyboard: true
    });
    
    modal.show();
    
    // Limpiar modal cuando se cierre
    document.getElementById('confirmAssessmentModal').addEventListener('hidden.bs.modal', function () {
        this.remove();
        // Remover selección visual
        if (selectedCard) {
            selectedCard.classList.remove('selected');
            const indicator = selectedCard.querySelector('.selection-indicator');
            if (indicator) {
                indicator.remove();
            }
        }
    });
}

// Función para confirmar la asignación de evaluación
function confirmAssignAssessment(assessmentId) {
    // Cerrar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('confirmAssessmentModal'));
    if (modal) {
        modal.hide();
    }
    
    // Mostrar notificación de éxito con mejor UX móvil
    showNotification('Evaluación asignada exitosamente', 'success');
    
    // Opcional: Aquí se puede agregar lógica para realizar la asignación real
    console.log('Evaluación confirmada:', assessmentId);
    
    // Feedback visual adicional
    setTimeout(() => {
        // Limpiar selecciones
        document.querySelectorAll('.assessment-card').forEach(card => {
            card.classList.remove('selected');
            const indicator = card.querySelector('.selection-indicator');
            if (indicator) {
                indicator.remove();
            }
        });
    }, 1000);
}

// Función para cargar evaluaciones en el selector del formulario de invitación
function loadAssessmentsForInvitation() {
    console.log('🔄 LOAD-ASSESSMENTS: Iniciando carga de evaluaciones para invitación');
    
    const selector = document.getElementById('assignedAssessment');
    if (!selector) {
        console.warn('⚠️ LOAD-ASSESSMENTS: Selector assignedAssessment no encontrado');
        return;
    }
    
    console.log('🧹 LOAD-ASSESSMENTS: Limpiando selector - opciones actuales:', selector.children.length);
    
    // Limpiar opciones existentes (excepto la primera)
    while (selector.children.length > 1) {
        selector.removeChild(selector.lastChild);
    }
    
    console.log('📡 LOAD-ASSESSMENTS: Solicitando evaluaciones del backend');
    
    fetch('/api/coach/available-assessments')
        .then(response => response.json())
        .then(data => {
            console.log('📥 LOAD-ASSESSMENTS: Respuesta recibida', {
                success: data.success,
                assessmentCount: data.assessments ? data.assessments.length : 0,
                assessments: data.assessments ? data.assessments.map(a => ({id: a.id, title: a.title})) : []
            });
            
            if (data.success && data.assessments && data.assessments.length > 0) {
                data.assessments.forEach((assessment, index) => {
                    console.log(`➕ LOAD-ASSESSMENTS: Agregando evaluación ${index + 1}:`, {
                        id: assessment.id, 
                        title: assessment.title, 
                        questions: assessment.questions_count
                    });
                    
                    // Verificar si ya existe una opción con este valor
                    const existingOption = Array.from(selector.options).find(option => option.value === assessment.id.toString());
                    if (existingOption) {
                        console.warn(`⚠️ DUPLICATE-PREVENTION: Evaluación ${assessment.id} ya existe en el selector, omitiendo`);
                        return;
                    }
                    
                    const option = document.createElement('option');
                    option.value = assessment.id;
                    option.textContent = `${assessment.title} (${assessment.questions_count} preguntas)`;
                    selector.appendChild(option);
                });
                
                console.log(`✅ LOAD-ASSESSMENTS: ${data.assessments.length} evaluaciones procesadas. Total opciones en selector:`, selector.children.length);
            } else {
                console.warn('⚠️ LOAD-ASSESSMENTS: No se encontraron evaluaciones o respuesta inválida');
            }
        })
        .catch(error => {
            console.error('❌ LOAD-ASSESSMENTS: Error cargando evaluaciones:', error);
        });
}

// Función para cargar coachees
function loadCoachees() {
    fetch('/api/coach/my-coachees')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                coacheesData = data.coachees;
                displayCoachees();
                updateCoacheeSelect();
            }
        })
        .catch(error => {
            console.error('Error loading coachees:', error);
            document.getElementById('coacheesTableBody').innerHTML = 
                '<tr><td colspan="7" class="text-center text-danger">Error al cargar coachees</td></tr>';
            document.getElementById('coacheesCardsContainer').innerHTML = 
                '<div class="text-center text-danger p-3">Error al cargar coachees</div>';
        });
}

// Función para mostrar coachees en la tabla y cards móviles
function displayCoachees() {
    const tbody = document.getElementById('coacheesTableBody');
    const cardsContainer = document.getElementById('coacheesCardsContainer');
    
    if (coacheesData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No hay coachees asignados</td></tr>';
        cardsContainer.innerHTML = '<div class="unified-empty-state"><i class="fas fa-users"></i><p>No hay coachees asignados</p></div>';
        return;
    }
    
    // Vista tabla para desktop
    tbody.innerHTML = coacheesData.map(coachee => `
        <tr>
            <td>${coachee.name || 'Sin nombre'}</td>
            <td>${coachee.email || 'Sin email'}</td>
            <td>
                ${coachee.password ? `
                    <div class="d-flex align-items-center">
                        <span class="password-text" id="pwd-${coachee.id}" style="font-family: monospace; min-width: 70px;">●●●●●●●●</span>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="togglePassword(${coachee.id}, '${coachee.password}')" title="Mostrar/Ocultar contraseña">
                            <i class="fas fa-eye" id="eye-${coachee.id}"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary ms-1" onclick="copyPassword('${coachee.password}')" title="Copiar contraseña">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                ` : '<span class="text-muted">-</span>'}
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewCoacheeDetails(${coachee.id})" title="Ver detalles">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="editCoachee(${coachee.id})" title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="showAssignModal(${coachee.id}, '${coachee.name}')" title="Asignar evaluación/tarea">
                    <i class="fas fa-plus"></i>
                </button>
            </td>
        </tr>
    `).join('');
    
    // Vista cards para móvil - mejorada con estilos unificados
    cardsContainer.innerHTML = `
        <div class="results-list">
            ${coacheesData.map(coachee => `
                <div class="unified-card">
                    <div class="unified-card-header">
                        <div class="d-flex justify-content-between align-items-start w-100">
                            <h5 class="unified-card-title">${coachee.name || 'Sin nombre'}</h5>
                            <span class="unified-badge ${coachee.is_active ? 'unified-badge-success' : 'unified-badge-secondary'}">
                                ${coachee.is_active ? 'Activo' : 'Inactivo'}
                            </span>
                        </div>
                    </div>
                    <div class="unified-card-body">
                        <div class="coachee-details">
                            <div class="meta-item">
                                <i class="fas fa-envelope"></i>
                                <span>${coachee.email || 'Sin email'}</span>
                            </div>
                            ${coachee.password ? `
                            <div class="meta-item">
                                <i class="fas fa-key"></i>
                                <div class="d-flex align-items-center">
                                    <span class="password-text" id="pwd-mobile-${coachee.id}" style="font-family: monospace;">●●●●●●●●</span>
                                    <button class="unified-btn unified-btn-sm unified-btn-secondary ms-2" onclick="togglePasswordMobile(${coachee.id}, '${coachee.password}')" title="Mostrar/Ocultar">
                                        <i class="fas fa-eye" id="eye-mobile-${coachee.id}"></i>
                                    </button>
                                    <button class="unified-btn unified-btn-sm unified-btn-primary ms-1" onclick="copyPassword('${coachee.password}')" title="Copiar">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                            ` : ''}
                            <div class="meta-item">
                                <i class="fas fa-chart-line"></i>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="unified-badge unified-badge-info">${coachee.evaluations_count || 0} evaluaciones</span>
                                    ${coachee.avg_score ? `<span class="text-muted">Promedio: ${Math.round(coachee.avg_score)}%</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="unified-card-footer">
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="unified-btn unified-btn-primary unified-btn-sm" onclick="viewCoacheeDetails(${coachee.id})" title="Ver detalles">
                                <i class="fas fa-eye"></i>
                                Detalles
                            </button>
                            <button class="unified-btn unified-btn-secondary unified-btn-sm" onclick="editCoachee(${coachee.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                                Editar
                            </button>
                            <button class="unified-btn unified-btn-success unified-btn-sm" onclick="showAssignModal(${coachee.id}, '${coachee.name}')" title="Asignar">
                                <i class="fas fa-plus"></i>
                                Asignar
                            </button>
                            <button class="unified-btn unified-btn-info unified-btn-sm" onclick="showAssignedAssessments(${coachee.id}, '${coachee.name}')" title="Ver evaluaciones">
                                <i class="fas fa-list"></i>
                                Evaluaciones
                            </button>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// Función para actualizar select de coachees en tareas
function updateCoacheeSelect() {
    const select = document.getElementById('taskCoachee');
    select.innerHTML = '<option value="">Seleccionar coachee</option>' +
        coacheesData.map(coachee => `<option value="${coachee.id}">${coachee.name}</option>`).join('');
}

// Función para cargar tareas
function loadTasks() {
    fetch('/api/coach/tasks')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                tasksData = data.tasks;
                displayTasks();
            }
        })
        .catch(error => {
            console.error('Error loading tasks:', error);
            document.getElementById('tasksTableBody').innerHTML = 
                '<tr><td colspan="8" class="text-center text-danger">Error al cargar tareas</td></tr>';
        });
}

// Función para mostrar tareas
function displayTasks() {
    const tableBody = document.getElementById('tasksTableBody');
    const cardsContainer = document.getElementById('tasksCardsContainer');
    
    if (tasksData.length === 0) {
        // Vista tabla vacia
        tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No hay tareas creadas</td></tr>';
        // Vista cards vacia
        cardsContainer.innerHTML = '<div class="text-center text-muted">No hay tareas creadas</div>';
        return;
    }

    // Limpiar contenedores
    tableBody.innerHTML = '';
    cardsContainer.innerHTML = '';

    tasksData.forEach(task => {
        const fechaCreated = new Date(task.created_at).toLocaleDateString('es-ES');
        const coacheeName = task.coachee_name || 'No asignado';
        
        // Formatear fecha de vencimiento
        let fechaVencimiento = 'Sin fecha';
        let vencimientoClass = '';
        if (task.due_date) {
            const dueDate = new Date(task.due_date);
            const today = new Date();
            const diffTime = dueDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            fechaVencimiento = dueDate.toLocaleDateString('es-ES');
            
            if (diffDays < 0) {
                vencimientoClass = 'text-danger fw-bold'; // Vencida
                fechaVencimiento += ' <small>(Vencida)</small>';
            } else if (diffDays <= 3) {
                vencimientoClass = 'text-warning fw-bold'; // Próxima a vencer
                fechaVencimiento += ` <small>(${diffDays} días)</small>`;
            } else {
                vencimientoClass = 'text-success'; // A tiempo
            }
        }
        
        // Determinar el estado visual
        let estadoBadge = '';
        if (task.completed) {
            estadoBadge = '<span class="badge bg-success">Completada</span>';
        } else {
            estadoBadge = '<span class="badge bg-warning text-dark">Pendiente</span>';
        }

        // Crear fila para tabla (desktop)
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div class="fw-bold text-dark">${task.title}</div>
                <small class="text-muted">${task.description || 'Sin descripción'}</small>
            </td>
            <td class="text-dark">${coacheeName}</td>
            <td>
                <span class="badge bg-light text-dark border">${task.category || 'Sin categoría'}</span>
            </td>
            <td>${estadoBadge}</td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="progress me-2" style="width: 60px; height: 20px;">
                        <div class="progress-bar bg-primary" style="width: ${task.progress_percentage || 0}%"></div>
                    </div>
                    <small class="text-muted">${task.progress_percentage || 0}%</small>
                </div>
            </td>
            <td class="${vencimientoClass}">${fechaVencimiento}</td>
            <td class="text-dark">${fechaCreated}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary btn-sm" onclick="editTask(${task.id})" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteTask(${task.id})" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tableBody.appendChild(row);

        // Crear card para móvil
        const card = document.createElement('div');
        card.className = 'card mb-3 border-light shadow-sm';
        card.innerHTML = `
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-title mb-1 text-dark fw-bold">${task.title}</h6>
                    ${estadoBadge}
                </div>
                
                <p class="card-text text-muted small mb-3">${task.description || 'Sin descripción'}</p>
                
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-user text-primary me-2"></i>
                            <div>
                                <div class="small text-muted">Coachee</div>
                                <div class="fw-medium text-dark small">${coacheeName}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-tag text-info me-2"></i>
                            <div>
                                <div class="small text-muted">Categoría</div>
                                <div class="fw-medium text-dark small">${task.category || 'Sin categoría'}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-chart-line text-success me-2"></i>
                            <div style="flex: 1;">
                                <div class="small text-muted">Progreso</div>
                                <div class="d-flex align-items-center">
                                    <div class="progress me-2" style="flex: 1; height: 16px;">
                                        <div class="progress-bar bg-success" style="width: ${task.progress_percentage || 0}%"></div>
                                    </div>
                                    <small class="fw-medium text-dark">${task.progress_percentage || 0}%</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    ${task.due_date ? `
                    <div class="col-12">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-clock text-warning me-2"></i>
                            <div>
                                <div class="small text-muted">Vencimiento</div>
                                <div class="fw-medium small ${vencimientoClass}">${fechaVencimiento}</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        <i class="fas fa-calendar me-1"></i>Creada: ${fechaCreated}
                    </small>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary btn-sm" onclick="editTask(${task.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteTask(${task.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        cardsContainer.appendChild(card);
    });
}

// Función para crear tarea
function createTask() {
    const title = document.getElementById('taskTitle').value.trim();
    const description = document.getElementById('taskDescription').value.trim();
    const category = document.getElementById('taskCategory').value;
    const coacheeId = document.getElementById('taskCoachee').value;
    const dueDate = document.getElementById('taskDueDate').value;
    
    if (!title) {
        alert('Por favor ingrese un título para la tarea');
        return;
    }
    
    if (!description) {
        alert('Por favor ingrese una descripción para la tarea');
        return;
    }
    
    if (!category) {
        alert('Por favor seleccione una categoría para la tarea');
        return;
    }
    
    if (!coacheeId) {
        alert('Por favor seleccione un coachee');
        return;
    }
    
    const taskData = {
        title: title,
        description: description,
        category: category,
        coachee_id: parseInt(coacheeId)
    };
    
    // Agregar fecha de vencimiento solo si se especifica
    if (dueDate) {
        taskData.due_date = dueDate;
    }
    
    fetch('/api/coach/tasks', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(taskData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('taskCategory').value = '';
            document.getElementById('taskCoachee').value = '';
            document.getElementById('taskDueDate').value = '';
            loadTasks();
            alert('Tarea creada exitosamente');
        } else {
            alert('Error al crear la tarea: ' + (data.message || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error creating task:', error);
        alert('Error al crear la tarea');
    });
}

// Función para eliminar tarea
function deleteTask(taskId) {
    if (confirm('¿Está seguro de que desea eliminar esta tarea?')) {
        fetch(`/api/coach/tasks/${taskId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Tarea eliminada exitosamente');
                loadTasks(); // Recargar la lista de tareas
            } else {
                alert('Error al eliminar la tarea: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error deleting task:', error);
            alert('Error al eliminar la tarea');
        });
    }
}

// Función para editar tarea
function editTask(taskId) {
    const task = tasksData.find(t => t.id === taskId);
    if (!task) {
        alert('Tarea no encontrada');
        return;
    }
    
    // Llenar el formulario con los datos de la tarea
    document.getElementById('taskTitle').value = task.title;
    document.getElementById('taskDescription').value = task.description || '';
    document.getElementById('taskCategory').value = task.category || '';
    document.getElementById('taskCoachee').value = task.coachee_id || '';
    
    // Llenar fecha de vencimiento si existe
    if (task.due_date) {
        document.getElementById('taskDueDate').value = task.due_date;
    } else {
        document.getElementById('taskDueDate').value = '';
    }
    
    // Cambiar el botón de crear por actualizar
    const createButton = document.querySelector('#gestion-tareas button[onclick="createTask()"]');
    createButton.innerHTML = '<i class="fas fa-save me-1"></i>Actualizar Tarea';
    createButton.onclick = function() { updateTask(taskId); };
    
    // Agregar botón de cancelar
    const cancelButton = document.createElement('button');
    cancelButton.className = 'btn btn-secondary ms-2';
    cancelButton.innerHTML = '<i class="fas fa-times me-1"></i>Cancelar';
    cancelButton.onclick = cancelEdit;
    createButton.parentNode.appendChild(cancelButton);
    
    // Scroll al formulario
    document.getElementById('gestion-tareas').scrollIntoView({ behavior: 'smooth' });
}

// Función para actualizar tarea
function updateTask(taskId) {
    const title = document.getElementById('taskTitle').value.trim();
    const description = document.getElementById('taskDescription').value.trim();
    const category = document.getElementById('taskCategory').value;
    const coacheeId = document.getElementById('taskCoachee').value;
    const dueDate = document.getElementById('taskDueDate').value;
    
    if (!title) {
        alert('Por favor ingrese un título para la tarea');
        return;
    }
    
    const taskData = {
        title: title,
        description: description,
        category: category,
        coachee_id: coacheeId || null,
        due_date: dueDate || null
    };
    
    fetch(`/api/coach/tasks/${taskId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(taskData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Tarea actualizada exitosamente');
            cancelEdit(); // Resetear formulario
            loadTasks(); // Recargar la lista de tareas
        } else {
            alert('Error al actualizar la tarea: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error updating task:', error);
        alert('Error al actualizar la tarea');
    });
}

// Función para cancelar edición
function cancelEdit() {
    // Limpiar formulario
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskDescription').value = '';
    document.getElementById('taskCategory').value = '';
    document.getElementById('taskCoachee').value = '';
    document.getElementById('taskDueDate').value = '';
    
    // Restaurar botón de crear
    const updateButton = document.querySelector('#gestion-tareas button[onclick*="updateTask"]');
    if (updateButton) {
        updateButton.innerHTML = '<i class="fas fa-plus me-1"></i>Crear Tarea';
        updateButton.onclick = createTask;
        
        // Remover botón cancelar
        const cancelButton = updateButton.parentNode.querySelector('.btn-secondary');
        if (cancelButton) {
            cancelButton.remove();
        }
    }
}

// Función para ver detalles del coachee
function viewCoacheeDetails(coacheeId) {
    const coachee = coacheesData.find(c => c.id === coacheeId);
    if (!coachee) {
        alert('Coachee no encontrado');
        return;
    }
    
    document.getElementById('modalCoacheeName').textContent = coachee.name;
    document.getElementById('coacheeEvaluationsContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Cargando evaluaciones...</span>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('coacheeEvaluationsModal'));
    modal.show();
    
    // Cargar evaluaciones del coachee
    fetch(`/api/coach/coachee-evaluations/${coacheeId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.evaluations) {
                // Procesar evaluaciones para agregar campos necesarios
                const processedEvaluations = data.evaluations.map(evaluation => {
                    // Calcular porcentaje basado en el score
                    const percentage = evaluation.score || 0;
                    
                    return {
                        ...evaluation,
                        percentage: percentage,
                        level: getAssertiveLevelFromScore(percentage),
                        interpretation: evaluation.result_text || ''
                    };
                });
                
                displayCoacheeEvaluations(processedEvaluations);
            } else {
                document.getElementById('coacheeEvaluationsContent').innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Este coachee no tiene evaluaciones completadas.
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading coachee evaluations:', error);
            document.getElementById('coacheeEvaluationsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error al cargar las evaluaciones.
                </div>
            `;
        });
}

// Función para mostrar evaluaciones del coachee
function displayCoacheeEvaluations(evaluations) {
    if (!evaluations || evaluations.length === 0) {
        document.getElementById('coacheeEvaluationsContent').innerHTML = `
            <div class="alert alert-info border-0" style="background: #f8f9fa; border-left: 4px solid #17a2b8 !important;">
                <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle me-3" style="font-size: 1.5rem; color: #17a2b8;"></i>
                    <div>
                        <h6 class="mb-0">No hay evaluaciones disponibles</h6>
                        <small class="text-muted">Este coachee aún no ha completado ninguna evaluación.</small>
                    </div>
                </div>
            </div>
        `;
        return;
    }

    // Header con estadísticas
    const totalEvaluations = evaluations.length;
    const avgScore = evaluations.reduce((sum, eval) => sum + (eval.percentage || 0), 0) / totalEvaluations;
    const lastEvaluation = evaluations.sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at))[0];

    let html = `
        <div class="evaluations-summary mb-4">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="summary-card">
                        <div class="summary-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-number">${totalEvaluations}</div>
                            <div class="summary-label">Evaluaciones</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="summary-card">
                        <div class="summary-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-number">${Math.round(avgScore)}%</div>
                            <div class="summary-label">Promedio</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="summary-card">
                        <div class="summary-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-number">${formatDateShort(lastEvaluation.completed_at)}</div>
                            <div class="summary-label">Última evaluación</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="evaluations-list">
            <div class="list-header mb-3">
                <h6 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    Historial de Evaluaciones
                </h6>
            </div>
    `;

    // Ordenar evaluaciones por fecha (más reciente primero)
    const sortedEvaluations = evaluations.sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at));

    sortedEvaluations.forEach((evaluation, index) => {
        const scoreColor = getScoreColor(evaluation.percentage);
        const levelBadge = getLevelBadge(evaluation.level, evaluation.percentage);
        const isRecent = index === 0; // Marcar la más reciente

        html += `
            <div class="evaluation-card ${isRecent ? 'recent-evaluation' : ''}" data-evaluation-id="${evaluation.id}">
                ${isRecent ? '<div class="recent-badge">Más reciente</div>' : ''}
                
                <div class="evaluation-header">
                    <div class="d-flex align-items-start justify-content-between">
                        <div class="evaluation-info flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <div class="evaluation-icon me-3">
                                    <i class="fas fa-clipboard-check"></i>
                                </div>
                                <div>
                                    <h6 class="evaluation-title mb-1">
                                        ${evaluation.assessment_title || 'Evaluación de Asertividad'}
                                    </h6>
                                    <div class="evaluation-meta">
                                        <span class="meta-item">
                                            <i class="fas fa-calendar-alt me-1"></i>
                                            ${formatDateLong(evaluation.completed_at)}
                                        </span>
                                        <span class="meta-item">
                                            <i class="fas fa-clock me-1"></i>
                                            ${getTimeAgo(evaluation.completed_at)}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="evaluation-score-section text-end">
                            <div class="score-display ${scoreColor}">
                                <div class="score-number">${evaluation.percentage || 0}%</div>
                                <div class="score-label">Puntuación</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="evaluation-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            ${evaluation.interpretation ? `
                                <div class="interpretation-section">
                                    <h6 class="section-title">
                                        <i class="fas fa-lightbulb me-2"></i>
                                        Interpretación
                                    </h6>
                                    <p class="interpretation-text">${evaluation.interpretation}</p>
                                </div>
                            ` : ''}
                            
                            ${evaluation.dimensional_scores && Object.keys(evaluation.dimensional_scores).length > 0 ? `
                                <div class="dimensions-preview">
                                    <h6 class="section-title">
                                        <i class="fas fa-chart-radar me-2"></i>
                                        Dimensiones Evaluadas
                                    </h6>
                                    <div class="dimensions-grid">
                                        ${generateDimensionsPreview(evaluation.dimensional_scores)}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="col-md-4">
                            <div class="evaluation-actions">
                                <button class="btn btn-primary btn-block mb-2" 
                                        onclick="viewEvaluationDetails(${evaluation.id})"
                                        title="Ver análisis completo de la evaluación">
                                    <i class="fas fa-eye me-2"></i>
                                    Ver Análisis Completo
                                </button>
                                
                                <div class="quick-stats">
                                    <div class="stat-item">
                                        <span class="stat-label">ID Evaluación:</span>
                                        <span class="stat-value">#${evaluation.id}</span>
                                    </div>
                                    ${evaluation.total_questions ? `
                                        <div class="stat-item">
                                            <span class="stat-label">Preguntas:</span>
                                            <span class="stat-value">${evaluation.total_questions}</span>
                                        </div>
                                    ` : ''}
                                    <div class="stat-item">
                                        <span class="stat-label">Estado:</span>
                                        <span class="badge bg-success">Completada</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    
    document.getElementById('coacheeEvaluationsContent').innerHTML = html;
}

// Funciones auxiliares para displayCoacheeEvaluations
function formatDateShort(dateString) {
    return new Date(dateString).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
}

function formatDateLong(dateString) {
    return new Date(dateString).toLocaleDateString('es-ES', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
}

function getTimeAgo(dateString) {
    const now = new Date();
    const date = new Date(dateString);
    const diffInDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
    
    if (diffInDays === 0) return 'Hoy';
    if (diffInDays === 1) return 'Ayer';
    if (diffInDays < 7) return `Hace ${diffInDays} días`;
    if (diffInDays < 30) return `Hace ${Math.floor(diffInDays / 7)} semanas`;
    return `Hace ${Math.floor(diffInDays / 30)} meses`;
}

function getScoreColor(percentage) {
    if (percentage >= 80) return 'score-high';     // Verde - 80%+
    if (percentage >= 40) return 'score-medium';   // Azul - 40-79%
    return 'score-low';                             // Rojo - Bajo 40%
}

function getLevelBadge(level, percentage) {
    const badgeColor = percentage >= 80 ? 'success' : 
                      percentage >= 60 ? 'warning' : 'danger';
    return `<div class="badge bg-${badgeColor}">${level || 'Sin nivel'}</div>`;
}

function generateDimensionsPreview(dimensionalScores) {
    return Object.entries(dimensionalScores)
        .slice(0, 3)
        .map(([dimension, score]) => `
            <div class="dimension-item">
                <span class="dimension-name">${dimension}</span>
                <span class="dimension-score">${score}%</span>
            </div>
        `).join('');
}

// Función para ver detalles de evaluación
function viewEvaluationDetails(evaluationId) {
    document.getElementById('evaluationDetailsContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Cargando detalles...</span>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('evaluationDetailsModal'));
    modal.show();
    
    // Cargar detalles de la evaluación
    fetch(`/api/coach/evaluation-details/${evaluationId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayEvaluationDetails(data.evaluation);
            } else {
                document.getElementById('evaluationDetailsContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error al cargar los detalles de la evaluación.
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading evaluation details:', error);
            document.getElementById('evaluationDetailsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error al cargar los detalles de la evaluación.
                </div>
            `;
        });
}

// Función para mostrar detalles de evaluación
function displayEvaluationDetails(evaluation) {
    console.log('renderEvaluationDetails called with:', evaluation);
    
    const container = document.getElementById('evaluationDetailsContent');
    
    // Detectar si es una evaluación DISC, Inteligencia Emocional o de Asertividad
    const assessmentTitle = evaluation.assessment?.title || '';
    const isDiscAssessment = assessmentTitle.toLowerCase().includes('disc');
    const isEmotionalIntelligenceAssessment = assessmentTitle.includes('Inteligencia Emocional');
    const isGrowthPreparationAssessment = assessmentTitle.includes('Preparación para crecer 2026');
    
    // Si es la evaluación "Preparación para crecer 2026", usar el layout personalizado
    if (isGrowthPreparationAssessment) {
        displayGrowthPreparationEvaluation(evaluation);
        return;
    }
    
    // Usar datos de la evaluación
    const data = evaluation;
    const dimensionalScores = evaluation.dimensional_scores;
    const recommendations = evaluation.recommendations || [];
    const detailedAnalysis = evaluation.detailed_analysis;
    
    console.log('Final data to use:', data);
    console.log('Dimensional scores:', dimensionalScores);
    console.log('Is DISC Assessment:', isDiscAssessment);
    console.log('Assessment Title:', assessmentTitle);
    console.log('Recommendations from server:', recommendations);
    
    // Título dinámico según el tipo de evaluación
    const analysisTitle = isDiscAssessment ? 'Análisis Completo DISC de Personalidad' : 
                         (isEmotionalIntelligenceAssessment ? 'Análisis Completo de Inteligencia Emocional' : 'Análisis Completo de Asertividad');
    
    const html = `
        <!-- Resumen General -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                    <div class="card-body text-center">
                        <h4 class="mb-3" style="color: #333;">${analysisTitle}</h4>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="h2" style="color: #007bff;">${Math.round(data.score || data.percentage || 0)}%</div>
                                <div style="color: #666;">Puntuación Total</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h4" style="color: #28a745;">${isDiscAssessment ? getDiscLevelFromScore(data.score || data.percentage || 0) : (isEmotionalIntelligenceAssessment ? getEmotionalIntelligenceLevelFromScore(data.score || data.percentage || 0) : getAssertiveLevelFromScore(data.score || data.percentage || 0))}</div>
                                <div style="color: #666;">${isDiscAssessment ? 'Estilo DISC Dominante' : (isEmotionalIntelligenceAssessment ? 'Nivel de Inteligencia Emocional' : 'Nivel de Asertividad')}</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h6" style="color: #333;">${formatDate(data.completed_at)}</div>
                                <div style="color: #666;">Fecha de Completado</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h6" style="color: #333;">${data.total_questions || evaluation.total_questions || (evaluation.responses ? evaluation.responses.length : 'N/A')}</div>
                                <div style="color: #666;">Preguntas Respondidas</div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12 text-center">
                                <div class="h5" style="color: #333;">${evaluation.coachee ? evaluation.coachee.name : (data.participant_name || evaluation.participant_name || 'N/A')}</div>
                                <div style="color: #666;">Participante</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráfico Radar y Análisis Dimensional -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="card border-0 h-100" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                    <div class="card-header" style="background: #e9ecef; border-bottom: 1px solid #dee2e6;">
                        <h5 style="color: #333;"><i class="fas fa-chart-radar me-2"></i>${isDiscAssessment ? 'Radar de Dimensiones DISC' : (isEmotionalIntelligenceAssessment ? 'Radar de Dimensiones IE' : 'Radar de Competencias')}</h5>
                    </div>
                    <div class="card-body">
                        <div class="radar-chart-container" style="position: relative; height: 300px;">
                            <canvas id="evaluationRadarChart" width="300" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6 mb-4">
                <div class="card border-0 h-100" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                    <div class="card-header" style="background: #e9ecef; border-bottom: 1px solid #dee2e6;">
                        <h5 style="color: #333;"><i class="fas fa-chart-bar me-2"></i>Puntuaciones por Dimensión</h5>
                    </div>
                    <div class="card-body">
                        <div id="dimensionalScoresContainer">
                            ${generateDimensionalScoresHTML(dimensionalScores)}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        ${generateDetailedAnalysisHTML(detailedAnalysis || generateAnalysisFromScores(dimensionalScores))}
        ${recommendations && recommendations.length > 0 ? generateRecommendationsHTML(recommendations) : ''}
        
        <!-- Respuestas Detalladas -->
        <div class="row">
            <div class="col-12">
                <div class="card border-0" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                    <div class="card-header" style="background: #e9ecef; border-bottom: 1px solid #dee2e6;">
                        <h5 style="color: #333;"><i class="fas fa-list me-2"></i>Respuestas Detalladas</h5>
                    </div>
                    <div class="card-body">
                        ${generateResponsesHTML(evaluation.responses || [])}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    
    // Crear el gráfico radar después de insertar el HTML
    setTimeout(() => {
        createRadarChart(dimensionalScores, isDiscAssessment, isEmotionalIntelligenceAssessment);
    }, 100);
}

// Función para crear gráfico radar
function createRadarChart(dimensionalScores, isDiscAssessment = false, isEmotionalIntelligenceAssessment = false) {
    const ctx = document.getElementById('evaluationRadarChart');
    if (!ctx) return;
    
    console.log('🎯 COACH RADAR DEBUG: Creating chart with params:', {
        isDiscAssessment,
        isEmotionalIntelligenceAssessment,
        dimensionalScores
    });
    
    let labels = [];
    let data = [];
    let chartLabel = '';
    
    if (isDiscAssessment) {
        // Configuración para DISC
        labels = ['Dominante', 'Influyente', 'Estable', 'Concienzudo'];
        data = [
            dimensionalScores?.Dominante || dimensionalScores?.dominante || 0,
            dimensionalScores?.Influyente || dimensionalScores?.influyente || 0,
            dimensionalScores?.Estable || dimensionalScores?.estable || 0,
            dimensionalScores?.Concienzudo || dimensionalScores?.concienzudo || 0
        ];
        chartLabel = 'Perfil DISC';
    } else if (isEmotionalIntelligenceAssessment) {
        // Configuración para Inteligencia Emocional
        labels = [
            'Autoconciencia',
            'Autorregulación',
            'Automotivación',
            'Empatía',
            'Habilidades Sociales'
        ];
        data = [
            dimensionalScores?.Autoconciencia || dimensionalScores?.autoconciencia || 0,
            dimensionalScores?.Autorregulación || dimensionalScores?.autorregulacion || 0,
            dimensionalScores?.Automotivación || dimensionalScores?.automotivacion || 0,
            dimensionalScores?.Empatía || dimensionalScores?.empatia || 0,
            dimensionalScores?.['Habilidades Sociales'] || dimensionalScores?.habilidades_sociales || 0
        ];
        chartLabel = 'Perfil de Inteligencia Emocional';
        console.log('🧠 COACH RADAR DEBUG: IE data values:', data);
    } else {
        // Configuración para Asertividad (lógica original)
        if (dimensionalScores && typeof dimensionalScores === 'object') {
            if (Array.isArray(dimensionalScores)) {
                // Array de objetos
                labels = dimensionalScores.map(score => score.dimension || score.name);
                data = dimensionalScores.map(score => Math.round((score.score / score.max_score) * 100));
            } else {
                // Objeto con claves de dimensiones
                labels = Object.keys(dimensionalScores).map(key => formatDimensionName(key));
                data = Object.values(dimensionalScores);
            }
        }
        chartLabel = 'Puntuación (%)';
    }
    
    console.log('📊 COACH RADAR DEBUG: Final chart config:', {
        labels,
        data,
        chartLabel
    });
    
    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{
                label: chartLabel,
                data: data,
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        stepSize: 20
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    console.log('✅ COACH RADAR DEBUG: Chart created successfully!');
}

// Función para generar HTML de puntuaciones dimensionales
function generateDimensionalScoresHTML(dimensionalScores) {
    if (!dimensionalScores) return '<p style="color: #666;">No hay datos dimensionales disponibles.</p>';
    
    let html = '';
    
    if (typeof dimensionalScores === 'object' && !Array.isArray(dimensionalScores)) {
        // Objeto con claves de dimensiones
        for (const [dimension, score] of Object.entries(dimensionalScores)) {
            const dimensionName = formatDimensionName(dimension);
            const percentage = Math.round(score);
            let colorClass = 'danger';
            if (percentage >= 70) colorClass = 'success';
            else if (percentage >= 50) colorClass = 'warning';
            
            html += `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <strong style="color: #333;">${dimensionName}</strong>
                        <span class="badge bg-${colorClass}">${percentage}%</span>
                    </div>
                    <div class="progress" style="height: 10px; background: #e9ecef;">
                        <div class="progress-bar bg-${colorClass}" style="width: ${percentage}%"></div>
                    </div>
                    <small style="color: #666;">${getDimensionDescription(dimension, percentage)}</small>
                </div>
            `;
        }
    } else if (Array.isArray(dimensionalScores)) {
        // Array de objetos
        dimensionalScores.forEach(score => {
            const percentage = Math.round((score.score / score.max_score) * 100);
            let colorClass = 'danger';
            if (percentage >= 70) colorClass = 'success';
            else if (percentage >= 50) colorClass = 'warning';
            
            html += `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <strong style="color: #333;">${score.dimension}</strong>
                        <span class="badge bg-${colorClass}">${percentage}%</span>
                    </div>
                    <div class="progress" style="height: 10px; background: #e9ecef;">
                        <div class="progress-bar bg-${colorClass}" style="width: ${percentage}%"></div>
                    </div>
                    <small style="color: #666;">${score.score}/${score.max_score} puntos</small>
                </div>
            `;
        });
    }
    
    return html;
}

// Función para generar análisis desde puntuaciones dimensionales
function generateAnalysisFromScores(dimensionalScores) {
    if (!dimensionalScores) return null;
    
    const strengths = [];
    const improvementAreas = [];
    
    // Analizar cada dimensión
    for (const [dimension, score] of Object.entries(dimensionalScores)) {
        const percentage = Math.round(score);
        const dimensionName = formatDimensionName(dimension);
        
        if (percentage >= 70) {
            // Es una fortaleza
            strengths.push({
                name: dimensionName,
                score: percentage,
                description: getDimensionDescription(dimension, percentage)
            });
        } else if (percentage < 60) {
            // Es un área de mejora
            const priority = percentage < 40 ? 'high' : 'medium';
            improvementAreas.push({
                name: dimensionName,
                score: percentage,
                description: getDimensionDescription(dimension, percentage),
                priority: priority
            });
        }
    }
    
    return {
        strengths: strengths,
        improvement_areas: improvementAreas
    };
}

// Función para generar HTML de análisis detallado
function generateDetailedAnalysisHTML(analysis) {
    let html = '<div class="row mb-4">';
    
    // Fortalezas
    if (analysis.strengths && analysis.strengths.length > 0) {
        html += `
            <div class="col-lg-6 mb-4">
                <div class="card border-0 h-100" style="background: #f8f9fa; border: 1px solid #dee2e6; border-left: 4px solid #28a745 !important;">
                    <div class="card-header" style="background: #d4edda; color: #155724;">
                        <h6 class="mb-0"><i class="fas fa-star me-2"></i>Fortalezas Identificadas</h6>
                    </div>
                    <div class="card-body">
        `;
        
        analysis.strengths.forEach(strength => {
            html += `
                <div class="d-flex align-items-start mb-3">
                    <div class="flex-shrink-0">
                        <span class="fw-bold text-success">${Math.round(strength.score)}%</span>
                    </div>
                    <div class="flex-grow-1 ms-2">
                        <strong style="color: #333;">${strength.name}</strong>
                        <p class="mb-0 small" style="color: #666;">${strength.description}</p>
                    </div>
                </div>
            `;
        });
        
        html += `
                    </div>
                </div>
            </div>
        `;
    }
    
    // Áreas de mejora
    if (analysis.improvement_areas && analysis.improvement_areas.length > 0) {
        html += `
            <div class="col-lg-6 mb-4">
                <div class="card border-0 h-100" style="background: #f8f9fa; border: 1px solid #dee2e6; border-left: 4px solid #ffc107 !important;">
                    <div class="card-header" style="background: #fff3cd; color: #856404;">
                        <h6 class="mb-0"><i class="fas fa-target me-2"></i>Áreas de Mejora</h6>
                    </div>
                    <div class="card-body">
        `;
        
        analysis.improvement_areas.forEach(area => {
            const priorityClass = area.priority === 'high' ? 'danger' : 'warning';
            const scoreColor = Math.round(area.score) >= 40 ? 'text-warning' : 'text-danger';
            html += `
                <div class="d-flex align-items-start mb-3">
                    <div class="flex-shrink-0">
                        <span class="fw-bold ${scoreColor}">${Math.round(area.score)}%</span>
                    </div>
                    <div class="flex-grow-1 ms-2">
                        <strong style="color: #333;">${area.name}</strong> 
                        <span class="badge bg-${priorityClass} ms-1">${area.priority}</span>
                        <p class="mb-0 small" style="color: #666;">${area.description}</p>
                    </div>
                </div>
            `;
        });
        
        html += `
                    </div>
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    return html;
}

















// Función para generar HTML de respuestas
function generateResponsesHTML(responses) {
    if (!responses || responses.length === 0) {
        return '<p class="text-muted">No hay respuestas detalladas disponibles.</p>';
    }
    
    const optionLabels = {
        1: 'Totalmente en desacuerdo',
        2: 'En desacuerdo', 
        3: 'Neutral',
        4: 'De acuerdo',
        5: 'Totalmente de acuerdo'
    };
    
    let html = '';
    responses.forEach((response, index) => {
        const scoreClass = response.selected_option >= 4 ? 'success' : 
                          response.selected_option === 3 ? 'warning' : 'danger';
        
        html += `
            <div class="border-start border-3 border-primary ps-3 mb-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <strong>Pregunta ${index + 1}:</strong>
                        <p class="mb-1">${response.question_text}</p>
                        <small class="text-${scoreClass}">
                            <i class="fas fa-check-circle me-1"></i>
                            ${optionLabels[response.selected_option] || response.answer_text || 'N/A'}
                        </small>
                    </div>
                    <span class="badge bg-${scoreClass} ms-2">${response.selected_option || response.points || 0}/5</span>
                </div>
            </div>
        `;
    });
    
    return html;
}

// Funciones auxiliares
function getAssertiveLevelFromScore(score) {
    if (score >= 85) return 'Muy Asertivo';
    if (score >= 70) return 'Asertivo';
    if (score >= 50) return 'Moderadamente Asertivo';
    return 'Poco Asertivo';
}

function getDiscLevelFromScore(score) {
    if (score >= 80) return 'Dominante Alto';
    if (score >= 60) return 'Influyente Alto';
    if (score >= 40) return 'Estable Alto';
    if (score >= 20) return 'Concienzudo Alto';
    return 'Perfil Equilibrado';
}

function getEmotionalIntelligenceLevelFromScore(score) {
    if (score >= 80) return 'Muy Alta';
    if (score >= 65) return 'Alta';
    if (score >= 50) return 'Moderada';
    if (score >= 35) return 'Baja';
    return 'Muy Baja';
}

function formatDimensionName(dimension) {
    const nameMap = {
        'comunicacion': 'Comunicación',
        'derechos': 'Defensa de Derechos',
        'opiniones': 'Expresión de Opiniones',
        'conflictos': 'Manejo de Conflictos',
        'autoconfianza': 'Autoconfianza'
    };
    return nameMap[dimension] || dimension.charAt(0).toUpperCase() + dimension.slice(1);
}

function getDimensionDescription(dimension, score) {
    const descriptions = {
        'comunicacion': score >= 70 ? 'Excelente comunicación interpersonal' : 'Oportunidad de mejorar la comunicación',
        'derechos': score >= 70 ? 'Sabe defender sus derechos apropiadamente' : 'Necesita fortalecer la defensa de derechos',
        'opiniones': score >= 70 ? 'Expresa opiniones con confianza' : 'Puede mejorar la expresión de opiniones',
        'conflictos': score >= 70 ? 'Maneja conflictos efectivamente' : 'Requiere desarrollo en manejo de conflictos',
        'autoconfianza': score >= 70 ? 'Alta confianza en sí mismo/a' : 'Oportunidad de fortalecer autoconfianza'
    };
    return descriptions[dimension] || 'Área de desarrollo personal';
}

function formatDate(dateString) {
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        return dateString || 'Fecha no disponible';
    }
}

// Función para editar coachee
function editCoachee(coacheeId) {
    console.log('Edit coachee:', coacheeId);
    
    // Buscar el coachee en los datos cargados
    const coachee = coacheesData.find(c => c.id === coacheeId);
    
    if (!coachee) {
        showAlert('error', 'No se pudo encontrar la información del coachee');
        return;
    }
    
    // Llenar el formulario con los datos actuales
    document.getElementById('editCoacheeId').value = coachee.id;
    document.getElementById('editCoacheeName').value = coachee.name || coachee.full_name || '';
    document.getElementById('editCoacheeEmail').value = coachee.email || '';
    document.getElementById('editCoacheePassword').value = ''; // Siempre vacío por seguridad
    
    // Limpiar alertas previas
    const alertDiv = document.getElementById('editCoacheeAlert');
    alertDiv.className = 'alert d-none';
    alertDiv.innerHTML = '';
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('editCoacheeModal'));
    modal.show();
}

// ✅ Función para mostrar/ocultar contraseña en tabla desktop
function togglePassword(coacheeId, password) {
    const passwordElement = document.getElementById(`pwd-${coacheeId}`);
    const eyeIcon = document.getElementById(`eye-${coacheeId}`);
    
    if (passwordElement.textContent === '●●●●●●●●') {
        passwordElement.textContent = password;
        eyeIcon.className = 'fas fa-eye-slash';
    } else {
        passwordElement.textContent = '●●●●●●●●';
        eyeIcon.className = 'fas fa-eye';
    }
}

// ✅ Función para mostrar/ocultar contraseña en vista móvil
function togglePasswordMobile(coacheeId, password) {
    const passwordElement = document.getElementById(`pwd-mobile-${coacheeId}`);
    const eyeIcon = document.getElementById(`eye-mobile-${coacheeId}`);
    
    if (passwordElement.textContent === '●●●●●●●●') {
        passwordElement.textContent = password;
        eyeIcon.className = 'fas fa-eye-slash';
    } else {
        passwordElement.textContent = '●●●●●●●●';
        eyeIcon.className = 'fas fa-eye';
    }
}

// ✅ Función para copiar contraseña al portapapeles
function copyPassword(password) {
    navigator.clipboard.writeText(password).then(function() {
        // Mostrar mensaje de éxito temporal
        const originalText = event.target.closest('button').innerHTML;
        event.target.closest('button').innerHTML = '<i class="fas fa-check"></i>';
        event.target.closest('button').classList.remove('btn-outline-primary');
        event.target.closest('button').classList.add('btn-success');
        
        setTimeout(() => {
            event.target.closest('button').innerHTML = originalText;
            event.target.closest('button').classList.remove('btn-success');
            event.target.closest('button').classList.add('btn-outline-primary');
        }, 1500);
    }).catch(function() {
        alert('Error al copiar la contraseña');
    });
}

// Manejar formulario de invitación
document.getElementById('inviteForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const name = document.getElementById('coacheeName').value.trim();
    const email = document.getElementById('coacheeEmail').value.trim();
    const assignedAssessment = document.getElementById('assignedAssessment').value;
    const customMessage = document.getElementById('customMessage').value.trim();
    
    if (!name || !email) {
        alert('Por favor complete todos los campos obligatorios');
        return;
    }
    
    // Preparar datos de la invitación
    const invitationData = {
        full_name: name,
        email: email,
        message: customMessage || 'Invitación para participar en evaluaciones de coaching'
    };
    
    // Agregar evaluación asignada si se seleccionó
    if (assignedAssessment) {
        invitationData.assigned_assessment_id = parseInt(assignedAssessment);
    }
    
    fetch('/api/coach/create-invitation-v2', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(invitationData)
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            document.getElementById('inviteForm').reset();
            
            // Guardar datos del coachee para el modal
            window.currentCoacheeData = {
                name: data.coachee.full_name,
                email: data.coachee.email,
                username: data.coachee.username,
                password: data.coachee.password,
                loginUrl: `${window.location.origin}/participant-access`,
                assignedAssessment: data.coachee.assigned_assessment
            };
            
            // Llenar datos en el modal
            document.getElementById('modalCoacheeName').textContent = data.coachee.full_name;
            document.getElementById('modalCoacheeEmail').textContent = data.coachee.email;
            document.getElementById('modalCoacheeUsername').textContent = data.coachee.username;
            document.getElementById('modalCoacheePassword').textContent = data.coachee.password;
            
            // Mostrar información de evaluación asignada si existe
            if (data.coachee.assigned_assessment) {
                document.getElementById('assignedAssessmentName').textContent = data.coachee.assigned_assessment;
                document.getElementById('assessmentAssignedInfo').style.display = 'block';
            } else {
                document.getElementById('assessmentAssignedInfo').style.display = 'none';
            }
            
            // Generar mensaje de invitación
            generateInvitationMessage();
            
            // Mostrar modal con configuración mejorada
            setTimeout(() => {
                const modalElement = document.getElementById('invitationSuccessModal');
                if (modalElement) {
                    // Limpiar cualquier instancia anterior y backdrops residuales
                    const existingModal = bootstrap.Modal.getInstance(modalElement);
                    if (existingModal) {
                        existingModal.dispose();
                    }
                    
                    // Limpiar backdrops residuales y asegurar que no se creen nuevos
                    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = 'auto';
                    document.body.style.paddingRight = '';
                    
                    // Crear nueva instancia con configuración específica
                    const modal = new bootstrap.Modal(modalElement, {
                        backdrop: false,    // Sin fondo oscuro
                        keyboard: true,     // Permitir cerrar con ESC
                        focus: true,
                        show: false
                    });
                    
                    // Mostrar el modal
                    modal.show();
                    
                    // Asegurar que los eventos funcionen correctamente
                    modalElement.addEventListener('hidden.bs.modal', function () {
                        modal.dispose();
                        // Limpieza adicional al cerrar
                        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                    }, { once: true });
                    
                    console.log('✅ Modal de invitación mostrado correctamente');
                } else {
                    console.error('❌ Modal element not found');
                }
            }, 100);
            
            // Recargar lista de coachees
            loadCoachees();
        } else {
            alert('Error al crear el coachee: ' + (data.error || data.message || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error sending invitation:', error);
        alert('Error al enviar la invitación: ' + error.message);
    });
});

// Cargar datos iniciales
document.addEventListener('DOMContentLoaded', function() {
    refreshDashboard();
    
    // FORZAR APLICACIÓN DE ESTILOS PANEL DE CONTROL
    setTimeout(function() {
        // Elementos con las clases nuevas
        const sidebar = document.querySelector('.sidebar-white');
        const header = document.querySelector('.sidebar-header-white');
        const title = document.querySelector('.sidebar-title-white');
        
        // Elementos con las clases originales (por si acaso)
        const sidebarOld = document.querySelector('.sidebar-force-white');
        const headerOld = document.querySelector('.sidebar-header-force');
        const titleOld = document.querySelector('.sidebar-title-force');
        
        // Aplicar estilos a elementos nuevos
        if (sidebar) {
            sidebar.style.setProperty('background', 'white', 'important');
            sidebar.style.setProperty('background-color', 'white', 'important');
            sidebar.style.setProperty('border', '1px solid #dee2e6', 'important');
            sidebar.classList.remove('bg-dark', 'border-secondary');
        }
        if (header) {
            header.style.setProperty('background', '#f8f9fa', 'important');
            header.style.setProperty('background-color', '#f8f9fa', 'important');
            header.style.setProperty('color', '#333', 'important');
            header.classList.remove('bg-dark');
        }
        if (title) {
            title.style.setProperty('color', '#333', 'important');
            title.classList.remove('text-white');
        }
        
        // Aplicar estilos a elementos originales (fallback)
        if (sidebarOld) {
            sidebarOld.style.setProperty('background', 'white', 'important');
            sidebarOld.style.setProperty('background-color', 'white', 'important');
        }
        if (headerOld) {
            headerOld.style.setProperty('background', '#f8f9fa', 'important');
            headerOld.style.setProperty('background-color', '#f8f9fa', 'important');
            headerOld.style.setProperty('color', '#333', 'important');
        }
        if (titleOld) {
            titleOld.style.setProperty('color', '#333', 'important');
        }
        
        console.log('Estilos del panel de control forzados ULTRA - v2.2');
        
        // FORZAR VARIABLES CSS DEL TEMA
        const sidebarTheme = document.querySelector('.sidebar');
        if (sidebarTheme) {
            sidebarTheme.style.setProperty('--theme-card-bg', 'white', 'important');
            sidebarTheme.style.setProperty('--theme-card-border', '#dee2e6', 'important');
            sidebarTheme.style.setProperty('--theme-text-primary', '#333', 'important');
            sidebarTheme.style.setProperty('--theme-hover-bg', '#f8f9fa', 'important');
            console.log('Variables CSS del tema anuladas para sidebar');
        }
    }, 100);
});

// Mejorar navegación del panel de control - Prevenir scroll automático
document.addEventListener('DOMContentLoaded', function() {
    // Agregar event listeners a todos los enlaces del menú
    document.querySelectorAll('[data-module]').forEach(link => {
        link.addEventListener('click', function(e) {
            // Solo prevenir para elementos del menú, no para modales
            if (!e.target.closest('.modal')) {
                e.preventDefault(); // Prevenir comportamiento por defecto
                e.stopPropagation(); // Prevenir propagación del evento
                
                const moduleId = this.getAttribute('data-module');
                if (moduleId) {
                    showModule(moduleId);
                }
                
                return false;
            }
        });
    });
    
    console.log('✅ Event listeners del panel de control configurados');
});

// ===== FUNCIONES PARA ASIGNAR EVALUACIONES/TAREAS =====

// Función para mostrar el modal de asignación
function showAssignModal(coacheeId, coacheeName) {
    console.log('🎯 Abriendo modal de asignación para coachee:', coacheeId, coacheeName);
    
    // Establecer datos del coachee
    document.getElementById('targetCoacheeId').value = coacheeId;
    document.getElementById('assignModalCoacheeName').textContent = coacheeName;
    
    // Cargar evaluaciones disponibles
    loadAssessmentsForAssignment();
    
    // Resetear formularios
    document.getElementById('assignEvaluationForm').reset();
    document.getElementById('assignTaskForm').reset();
    document.getElementById('targetCoacheeId').value = coacheeId; // Restaurar después del reset
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('assignModal'));
    modal.show();
}

// Función para cargar evaluaciones en el selector del modal de asignación
function loadAssessmentsForAssignment() {
    console.log('📋 Cargando evaluaciones para asignación...');
    
    const select = document.getElementById('assignAssessmentSelect');
    select.innerHTML = '<option value="">Cargando evaluaciones...</option>';
    
    fetch('/api/coach/available-assessments')
        .then(response => response.json())
        .then(data => {
            console.log('📊 Evaluaciones recibidas para asignación:', data);
            
            if (data.success && data.assessments && data.assessments.length > 0) {
                select.innerHTML = '<option value="">Seleccionar evaluación</option>';
                
                data.assessments.forEach(assessment => {
                    const option = document.createElement('option');
                    option.value = assessment.id;
                    option.textContent = `${assessment.title} (${assessment.questions_count} preguntas)`;
                    select.appendChild(option);
                });
                
                console.log('✅ Evaluaciones cargadas en selector de asignación');
            } else {
                select.innerHTML = '<option value="">No hay evaluaciones disponibles</option>';
                console.log('❌ No se encontraron evaluaciones para asignación');
            }
        })
        .catch(error => {
            console.error('❌ Error cargando evaluaciones para asignación:', error);
            select.innerHTML = '<option value="">Error cargando evaluaciones</option>';
        });
}

// Función para ejecutar la asignación (evaluación o tarea)
function executeAssignment() {
    const activeTab = document.querySelector('#assignTabs .nav-link.active');
    const isEvaluationTab = activeTab.id === 'evaluation-tab';
    
    if (isEvaluationTab) {
        assignEvaluationFromModal();
    } else {
        assignTaskFromModal();
    }
}

// Función para asignar evaluación desde el modal
function assignEvaluationFromModal() {
    const coacheeId = document.getElementById('targetCoacheeId').value;
    const assessmentId = document.getElementById('assignAssessmentSelect').value;
    const message = document.getElementById('assignEvaluationMessage').value;
    const dueDate = document.getElementById('assignEvaluationDueDate').value;
    
    if (!assessmentId) {
        alert('Por favor selecciona una evaluación');
        return;
    }
    
    console.log('📋 Asignando evaluación:', { coacheeId, assessmentId, message, dueDate });
    
    // Preparar datos para la API de crear tarea
    const taskData = {
        coachee_id: parseInt(coacheeId),
        title: `Evaluación: ${document.getElementById('assignAssessmentSelect').selectedOptions[0].textContent}`,
        description: message || `Completa la evaluación asignada por tu coach.`,
        category: 'evaluation',
        priority: 'high',
        due_date: dueDate || null
    };
    
    // Crear tarea
    fetch('/api/coach/tasks', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(taskData)
    })
    .then(response => response.json())
    .then(data => {
        console.log('📊 Respuesta de asignación de evaluación:', data);
        
        if (data.success) {
            alert('✅ Evaluación asignada exitosamente');
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('assignModal'));
            modal.hide();
            
            // Recargar datos
            loadTasks();
            loadCoachees();
        } else {
            alert('❌ Error al asignar evaluación: ' + (data.message || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('❌ Error asignando evaluación:', error);
        alert('❌ Error al asignar evaluación');
    });
}

// Función para asignar tarea desde el modal
function assignTaskFromModal() {
    const coacheeId = document.getElementById('targetCoacheeId').value;
    const title = document.getElementById('assignTaskTitle').value;
    const description = document.getElementById('assignTaskDescription').value;
    const category = document.getElementById('assignTaskCategory').value;
    const priority = document.getElementById('assignTaskPriority').value;
    const dueDate = document.getElementById('assignTaskDueDate').value;
    
    if (!title || !description || !category) {
        alert('Por favor completa todos los campos requeridos');
        return;
    }
    
    console.log('📝 Asignando tarea:', { coacheeId, title, description, category, priority, dueDate });
    
    const taskData = {
        coachee_id: parseInt(coacheeId),
        title: title,
        description: description,
        category: category,
        priority: priority,
        due_date: dueDate || null
    };
    
    fetch('/api/coach/tasks', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(taskData)
    })
    .then(response => response.json())
    .then(data => {
        console.log('📊 Respuesta de asignación de tarea:', data);
        
        if (data.success) {
            alert('✅ Tarea asignada exitosamente');
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('assignModal'));
            modal.hide();
            
            // Recargar datos
            loadTasks();
            loadCoachees();
        } else {
            alert('❌ Error al asignar tarea: ' + (data.message || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('❌ Error asignando tarea:', error);
        alert('❌ Error al asignar tarea');
    });
}

// Función para abrir modal de asignación desde el contexto de evaluación
function openAssignModalFromEvaluation(assessmentId, assessmentTitle) {
    console.log('🎯 Abriendo modal de asignación desde evaluación:', assessmentId, assessmentTitle);
    
    // Crear un modal específico para seleccionar coachee
    const assignEvaluationModal = document.createElement('div');
    assignEvaluationModal.className = 'modal fade';
    assignEvaluationModal.id = 'assignEvaluationToCoacheeModal';
    assignEvaluationModal.setAttribute('tabindex', '-1');
    
    assignEvaluationModal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus me-2"></i>Asignar Evaluación: ${assessmentTitle}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Pestañas -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="existing-coachee-tab" data-bs-toggle="tab" 
                                data-bs-target="#existing-coachee-pane" type="button" role="tab">
                                <i class="fas fa-users me-1"></i>Coachee Existente
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="new-coachee-tab" data-bs-toggle="tab" 
                                data-bs-target="#new-coachee-pane" type="button" role="tab">
                                <i class="fas fa-user-plus me-1"></i>Nuevo Coachee
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- Pestaña de Coachee Existente -->
                        <div class="tab-pane fade show active" id="existing-coachee-pane" role="tabpanel">
                            <div class="mb-3">
                                <label for="existingCoacheeSelect" class="form-label">Seleccionar coachee:</label>
                                <select class="form-select" id="existingCoacheeSelect" required>
                                    <option value="">Cargando coachees...</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="existingEvaluationMessage" class="form-label">Mensaje personalizado (opcional):</label>
                                <textarea class="form-control" id="existingEvaluationMessage" rows="3" 
                                    placeholder="Mensaje para el coachee..."></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="existingEvaluationDueDate" class="form-label">Fecha límite (opcional):</label>
                                <input type="date" class="form-control" id="existingEvaluationDueDate">
                            </div>
                            
                            <button type="button" class="btn btn-success" onclick="assignEvaluationToExistingCoachee(${assessmentId})">
                                <i class="fas fa-check me-1"></i>Asignar Evaluación
                            </button>
                        </div>

                        <!-- Pestaña de Nuevo Coachee -->
                        <div class="tab-pane fade" id="new-coachee-pane" role="tabpanel">
                            <div class="mb-3">
                                <label for="newCoacheeName" class="form-label">Nombre completo:</label>
                                <input type="text" class="form-control" id="newCoacheeName" required
                                    placeholder="Ej: María González">
                            </div>
                            
                            <div class="mb-3">
                                <label for="newCoacheeEmail" class="form-label">Email:</label>
                                <input type="email" class="form-control" id="newCoacheeEmail" required
                                    placeholder="Ej: maria@empresa.com">
                            </div>
                            
                            <div class="mb-3">
                                <label for="newCoacheePassword" class="form-label">Contraseña temporal:</label>
                                <input type="password" class="form-control" id="newCoacheePassword" required
                                    placeholder="Contraseña para el coachee">
                            </div>
                            
                            <div class="mb-3">
                                <label for="newEvaluationMessage" class="form-label">Mensaje personalizado (opcional):</label>
                                <textarea class="form-control" id="newEvaluationMessage" rows="3" 
                                    placeholder="Mensaje para el coachee..."></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="newEvaluationDueDate" class="form-label">Fecha límite (opcional):</label>
                                <input type="date" class="form-control" id="newEvaluationDueDate">
                            </div>
                            
                            <button type="button" class="btn btn-success" onclick="createCoacheeAndAssignEvaluation(${assessmentId})">
                                <i class="fas fa-user-plus me-1"></i>Crear Coachee y Asignar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Agregar modal al DOM
    document.body.appendChild(assignEvaluationModal);
    
    // Cargar coachees existentes
    loadCoacheesForAssignment();
    
    // Mostrar modal
    const modal = new bootstrap.Modal(assignEvaluationModal);
    modal.show();
    
    // Limpiar modal cuando se cierre
    assignEvaluationModal.addEventListener('hidden.bs.modal', function () {
        document.body.removeChild(assignEvaluationModal);
    });
}

// Función para cargar coachees en el selector
function loadCoacheesForAssignment() {
    console.log('👥 Cargando coachees para asignación...');
    
    const select = document.getElementById('existingCoacheeSelect');
    if (select) {
        select.innerHTML = '<option value="">Cargando coachees...</option>';
        
        fetch('/api/coach/my-coachees')
            .then(response => response.json())
            .then(data => {
                console.log('📊 Coachees cargados:', data);
                
                select.innerHTML = '<option value="">Seleccionar coachee...</option>';
                
                if (data.success && data.coachees) {
                    data.coachees.forEach(coachee => {
                        const option = document.createElement('option');
                        option.value = coachee.id;
                        option.textContent = `${coachee.name} (${coachee.email})`;
                        select.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('❌ Error cargando coachees:', error);
                select.innerHTML = '<option value="">Error cargando coachees</option>';
            });
    }
}

// Función para asignar evaluación a coachee existente
function assignEvaluationToExistingCoachee(assessmentId) {
    const coacheeId = document.getElementById('existingCoacheeSelect').value;
    const message = document.getElementById('existingEvaluationMessage').value;
    const dueDate = document.getElementById('existingEvaluationDueDate').value;
    
    if (!coacheeId) {
        alert('Por favor selecciona un coachee');
        return;
    }
    
    console.log('📋 Asignando evaluación a coachee existente:', { coacheeId, assessmentId, message, dueDate });
    
    // Obtener el título de la evaluación desde el modal
    const modalTitle = document.querySelector('#assignEvaluationToCoacheeModal .modal-title').textContent;
    const assessmentTitle = modalTitle.replace('Asignar Evaluación: ', '');
    
    const taskData = {
        coachee_id: parseInt(coacheeId),
        title: `Evaluación: ${assessmentTitle}`,
        description: message || `Completa la evaluación asignada por tu coach.`,
        category: 'evaluation',
        priority: 'high',
        due_date: dueDate || null
    };
    
    fetch('/api/coach/tasks', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(taskData)
    })
    .then(response => response.json())
    .then(data => {
        console.log('📊 Respuesta de asignación:', data);
        
        if (data.success) {
            alert('✅ Evaluación asignada exitosamente');
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('assignEvaluationToCoacheeModal'));
            modal.hide();
            
            // Recargar datos si estamos en la vista de tareas
            if (typeof loadTasks === 'function') {
                loadTasks();
            }
        } else {
            alert('❌ Error al asignar evaluación: ' + (data.message || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('❌ Error asignando evaluación:', error);
        alert('❌ Error al asignar evaluación');
    });
}

// Función para crear coachee y asignar evaluación
function createCoacheeAndAssignEvaluation(assessmentId) {
    const name = document.getElementById('newCoacheeName').value;
    const email = document.getElementById('newCoacheeEmail').value;
    const password = document.getElementById('newCoacheePassword').value;
    const message = document.getElementById('newEvaluationMessage').value;
    const dueDate = document.getElementById('newEvaluationDueDate').value;
    
    if (!name || !email || !password) {
        alert('Por favor completa todos los campos requeridos');
        return;
    }
    
    console.log('👤 Creando coachee y asignando evaluación:', { name, email, assessmentId, message, dueDate });
    
    // Crear coachee primero
    const coacheeData = {
        full_name: name,
        email: email,
        password: password,
        assigned_assessment_id: assessmentId
    };
    
    fetch('/api/coach/create-invitation-v2', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(coacheeData)
    })
    .then(response => response.json())
    .then(data => {
        console.log('📊 Respuesta de creación de coachee:', data);
        
        if (data.success) {
            alert('✅ Coachee creado y evaluación asignada exitosamente');
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('assignEvaluationToCoacheeModal'));
            modal.hide();
            
            // Recargar datos
            if (typeof loadCoachees === 'function') {
                loadCoachees();
            }
            if (typeof loadTasks === 'function') {
                loadTasks();
            }
        } else {
            alert('❌ Error al crear coachee: ' + (data.message || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('❌ Error creando coachee:', error);
        alert('❌ Error al crear coachee');
    });
}

// Función para mostrar las evaluaciones asignadas a un coachee
function showAssignedAssessments(coacheeId, coacheeName) {
    console.log(`🔍 Showing assigned assessments for coachee ${coacheeId} (${coacheeName})`);
    
    // Actualizar el título del modal
    document.getElementById('assignedAssessmentsModalLabel').innerHTML = 
        `<i class="fas fa-clipboard-list me-2"></i>Evaluaciones - ${coacheeName}`;
    
    // Mostrar spinner de carga
    document.getElementById('assignedAssessmentsContent').innerHTML = `
        <div class="text-center">
            <i class="fas fa-spinner fa-spin fa-2x text-info"></i>
            <p class="mt-2">Cargando evaluaciones asignadas...</p>
        </div>
    `;
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('assignedAssessmentsModal'));
    modal.show();
    
    // Obtener las evaluaciones asignadas
    fetch(`/api/coach/coachee-assessments/${coacheeId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayAssignedAssessments(data.assessments, coacheeId, coacheeName);
            } else {
                document.getElementById('assignedAssessmentsContent').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${data.error || 'Error al cargar las evaluaciones asignadas'}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading assigned assessments:', error);
            document.getElementById('assignedAssessmentsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error al cargar las evaluaciones asignadas
                </div>
            `;
        });
}

// Función para mostrar las evaluaciones asignadas en el modal
function displayAssignedAssessments(assessments, coacheeId, coacheeName) {
    const container = document.getElementById('assignedAssessmentsContent');
    
    if (assessments.length === 0) {
        container.innerHTML = `
            <div class="unified-empty-state">
                <i class="fas fa-clipboard fa-3x"></i>
                <h5>No hay evaluaciones disponibles</h5>
                <p>No se encontraron evaluaciones para este coachee.</p>
            </div>
        `;
        return;
    }
    
    // Separar evaluaciones asignadas y disponibles
    const assignedAssessments = assessments.filter(assessment => assessment.is_assigned);
    const availableAssessments = assessments.filter(assessment => !assessment.is_assigned);
    
    container.innerHTML = `
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="alert alert-info">
                    <i class="fas fa-clipboard-check me-2"></i>
                    <strong>${assignedAssessments.length}</strong> evaluación${assignedAssessments.length !== 1 ? 'es asignadas' : ' asignada'}
                </div>
            </div>
            <div class="col-md-6">
                <div class="alert alert-secondary">
                    <i class="fas fa-clipboard-list me-2"></i>
                    <strong>${availableAssessments.length}</strong> evaluación${availableAssessments.length !== 1 ? 'es disponibles' : ' disponible'}
                </div>
            </div>
        </div>
        
        ${assignedAssessments.length > 0 ? `
            <div class="mb-4">
                <h6 class="text-primary mb-3">
                    <i class="fas fa-clipboard-check me-2"></i>
                    Evaluaciones Asignadas
                </h6>
                <div class="results-list">
                    ${assignedAssessments.map(assessment => `
                        <div class="unified-card">
                            <div class="unified-card-header">
                                <div class="d-flex justify-content-between align-items-start w-100">
                                    <div>
                                        <div class="mb-2">
                                            <span class="unified-badge unified-badge-success">Asignada</span>
                                        </div>
                                        <h5 class="unified-card-title">${assessment.assessment_title}</h5>
                                    </div>
                                    <button class="unified-btn unified-btn-danger unified-btn-sm" 
                                            onclick="confirmUnassignAssessment(${coacheeId}, '${coacheeName}', '${assessment.assessment_title}')" 
                                            title="Desasignar evaluación">
                                        <i class="fas fa-times"></i>
                                        Desasignar
                                    </button>
                                </div>
                            </div>
                            <div class="unified-card-body">
                                <p class="text-muted mb-2">${assessment.description || 'Sin descripción'}</p>
                                <div class="assessment-meta">
                                    <div class="meta-item">
                                        <i class="fas fa-question-circle"></i>
                                        <span>${assessment.total_questions} preguntas</span>
                                    </div>
                                    ${assessment.assigned_date ? `
                                    <div class="meta-item">
                                        <i class="fas fa-calendar-plus"></i>
                                        <span>Asignada: ${new Date(assessment.assigned_date).toLocaleString()}</span>
                                    </div>
                                    ` : ''}
                                    ${assessment.due_date ? `
                                    <div class="meta-item">
                                        <i class="fas fa-calendar-times"></i>
                                        <span>Vence: ${new Date(assessment.due_date).toLocaleString()}</span>
                                    </div>
                                    ` : ''}
                                    ${assessment.completed_attempts > 0 ? `
                                    <div class="meta-item">
                                        <i class="fas fa-check-circle text-success"></i>
                                        <span>Completada ${assessment.completed_attempts} vez${assessment.completed_attempts !== 1 ? 'es' : ''}</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : ''}
        
        ${availableAssessments.length > 0 ? `
            <div class="mb-4">
                <h6 class="text-secondary mb-3">
                    <i class="fas fa-clipboard-list me-2"></i>
                    Evaluaciones Disponibles (No Asignadas)
                </h6>
                <div class="results-list">
                    ${availableAssessments.map(assessment => `
                        <div class="unified-card">
                            <div class="unified-card-header">
                                <div>
                                    <div class="mb-2">
                                        <span class="unified-badge unified-badge-secondary">Disponible</span>
                                    </div>
                                    <h5 class="unified-card-title">${assessment.assessment_title}</h5>
                                </div>
                            </div>
                            <div class="unified-card-body">
                                <p class="text-muted mb-2">${assessment.description || 'Sin descripción'}</p>
                                <div class="assessment-meta">
                                    <div class="meta-item">
                                        <i class="fas fa-question-circle"></i>
                                        <span>${assessment.total_questions} preguntas</span>
                                    </div>
                                    ${assessment.completed_attempts > 0 ? `
                                    <div class="meta-item">
                                        <i class="fas fa-check-circle text-success"></i>
                                        <span>Completada ${assessment.completed_attempts} vez${assessment.completed_attempts !== 1 ? 'es' : ''} (sin asignar)</span>
                                    </div>
                                    ` : `
                                    <div class="meta-item">
                                        <i class="fas fa-clock text-muted"></i>
                                        <span>Sin completar</span>
                                    </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : ''}
        
        <div class="alert alert-info mt-3">
            <i class="fas fa-lightbulb me-2"></i>
            <strong>Información:</strong> Esta vista muestra todas las evaluaciones disponibles para ${coacheeName}. 
            Las evaluaciones marcadas como "Asignadas" aparecen en el dashboard del coachee como tareas pendientes.
        </div>
    `;
}

// Función para confirmar la desasignación de una evaluación
function confirmUnassignAssessment(coacheeId, coacheeName, assessmentTitle) {
    if (confirm(`¿Estás seguro de que deseas desasignar la evaluación "${assessmentTitle}" de ${coacheeName}?\n\nEsta acción no se puede deshacer.`)) {
        unassignAssessment(coacheeId, coacheeName, assessmentTitle);
    }
}

// Función para desasignar una evaluación
function unassignAssessment(coacheeId, coacheeName, assessmentTitle) {
    console.log(`🚫 Unassigning assessment "${assessmentTitle}" from coachee ${coacheeId} (${coacheeName})`);
    
    // Mostrar spinner en el botón
    const buttons = document.querySelectorAll('button[onclick*="confirmUnassignAssessment"]');
    buttons.forEach(btn => {
        if (btn.onclick.toString().includes(assessmentTitle)) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Desasignando...';
            btn.disabled = true;
        }
    });
    
    fetch('/api/coach/unassign-assessment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            coachee_id: coacheeId,
            assessment_title: assessmentTitle
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ Assessment unassigned successfully');
            
            // Mostrar mensaje de éxito
            showSuccessMessage(`Evaluación "${assessmentTitle}" desasignada exitosamente de ${coacheeName}`);
            
            // Recargar las evaluaciones asignadas
            showAssignedAssessments(coacheeId, coacheeName);
            
            // Recargar la lista de coachees para actualizar los contadores
            if (typeof loadCoachees === 'function') {
                loadCoachees();
            }
        } else {
            console.error('❌ Error unassigning assessment:', data.error);
            alert(`❌ Error: ${data.error}`);
            
            // Restaurar botones
            buttons.forEach(btn => {
                if (btn.onclick.toString().includes(assessmentTitle)) {
                    btn.innerHTML = '<i class="fas fa-times me-1"></i>Desasignar';
                    btn.disabled = false;
                }
            });
        }
    })
    .catch(error => {
        console.error('❌ Error unassigning assessment:', error);
        alert('❌ Error al desasignar la evaluación');
        
        // Restaurar botones
        buttons.forEach(btn => {
            if (btn.onclick.toString().includes(assessmentTitle)) {
                btn.innerHTML = '<i class="fas fa-times me-1"></i>Desasignar';
                btn.disabled = false;
            }
        });
    });
}

// Función auxiliar para mostrar mensajes de éxito
function showSuccessMessage(message) {
    // Crear y mostrar un toast de éxito
    const toastContainer = document.querySelector('.toast-container') || createToastContainer();
    
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-check-circle me-2"></i>${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    const toast = new bootstrap.Toast(document.getElementById(toastId));
    toast.show();
    
    // Limpiar el toast después de que se oculte
    document.getElementById(toastId).addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}

// Función para crear el contenedor de toasts si no existe
function createToastContainer() {
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1055';
    document.body.appendChild(container);
    return container;
}

// Función para imprimir reporte de evaluación
function printEvaluationReport() {
    // Crear una nueva ventana para imprimir
    const printWindow = window.open('', '_blank');
    const evaluationContent = document.getElementById('evaluationDetailsContent').innerHTML;
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Reporte de Evaluación de Asertividad</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body { font-family: Arial, sans-serif; }
                .card { border: 1px solid #dee2e6; margin-bottom: 1rem; }
                .badge { display: inline-block; padding: 0.25em 0.6em; }
                @media print { 
                    .btn { display: none; }
                    canvas { max-width: 400px; }
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1 class="text-center mb-4">Reporte de Evaluación de Asertividad</h1>
                ${evaluationContent}
            </div>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
}

// Función específica para mostrar evaluación "Preparación para crecer 2026" en dashboard del coach
function displayGrowthPreparationEvaluation(evaluation) {
    console.log('🌱 GROWTH COACH: Displaying Preparación para crecer 2026 evaluation:', evaluation);
    
    const container = document.getElementById('evaluationDetailsContent');
    const score = Math.round(evaluation.score || 0);
    const resultText = evaluation.result_text || '';
    const dimensionalScores = evaluation.dimensional_scores || {};
    
    // Determinar el resultado basado en el puntaje
    let resultLevel, resultColor, resultIcon, respuestasC;
    if (score <= 30) {
        resultLevel = "Rojo";
        resultColor = "#dc3545";
        resultIcon = "fas fa-exclamation-triangle";
        respuestasC = "0-2";
    } else if (score <= 70) {
        resultLevel = "Amarillo";
        resultColor = "#ffc107";
        resultIcon = "fas fa-clock";
        respuestasC = "3-4";
    } else {
        resultLevel = "Verde";
        resultColor = "#28a745";
        resultIcon = "fas fa-check-circle";
        respuestasC = "5-7";
    }
    
    const html = `
        <!-- Resultado destacado para Coach -->
        <div class="tu-resultado mb-4 p-4" style="background: ${resultColor} !important; color: white !important; border-radius: 15px; text-align: center; box-shadow: 0 6px 12px rgba(0,0,0,0.1);">
            <h4 style="color: white !important; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5) !important;">
                <i class="${resultIcon} me-2" style="color: white !important;"></i>
                Resultado del Coachee: <span style="color: white !important; text-shadow: 2px 2px 4px rgba(0,0,0,0.5) !important;">${resultLevel}</span>
            </h4>
            <p style="margin: 0; font-size: 1.2em; line-height: 1.5; font-weight: 500; color: white !important;">
                ${resultText.split('\\n\\n')[0]}
            </p>
        </div>

        <!-- Análisis por Dimensiones -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card h-100" style="border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div class="card-header" style="background: #667eea; color: white;">
                        <h5 style="margin: 0; color: white;">
                            <i class="fas fa-chart-radar me-2"></i>
                            Radar de Dimensiones Empresariales
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="radar-chart-container" style="position: relative; height: 300px;">
                            <canvas id="coachGrowthRadarChart" width="300" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="card h-100" style="border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div class="card-header" style="background: #764ba2; color: white;">
                        <h5 style="margin: 0; color: white;">
                            <i class="fas fa-chart-bar me-2"></i>
                            Puntuación por Dimensión
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="coachDimensionalScores">
                            ${generateCoachDimensionalScores(dimensionalScores)}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Respuestas Detalladas -->
        <div class="card" style="border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div class="card-header" style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <h5 style="margin: 0; color: #333;">
                    <i class="fas fa-list-check me-2"></i>
                    Respuestas Detalladas del Coachee
                </h5>
            </div>
            <div class="card-body">
                ${generateResponsesHTML(evaluation.responses || [])}
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    
    // Crear el gráfico radar después de insertar el HTML
    setTimeout(() => {
        createCoachGrowthRadarChart(dimensionalScores);
    }, 100);
}

// Función auxiliar para generar puntuaciones dimensionales en dashboard del coach
function generateCoachDimensionalScores(dimensionalScores) {
    if (!dimensionalScores || Object.keys(dimensionalScores).length === 0) {
        return '<p class="text-muted">No hay datos dimensionales disponibles</p>';
    }
    
    let html = '';
    Object.entries(dimensionalScores).forEach(([dimension, score]) => {
        const percentage = Math.round(((score - 1) / 2) * 100);
        let scoreColor, scoreIcon;
        
        if (score >= 2.5) {
            scoreColor = '#28a745';
            scoreIcon = 'fas fa-check-circle';
        } else if (score >= 1.5) {
            scoreColor = '#ffc107';
            scoreIcon = 'fas fa-clock';
        } else {
            scoreColor = '#dc3545';
            scoreIcon = 'fas fa-exclamation-triangle';
        }
        
        html += `
            <div class="dimension-score mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span style="font-weight: 600; color: #333; font-size: 0.95em;">${dimension}</span>
                    <span class="badge" style="background: ${scoreColor}; color: white; font-size: 0.8em;">
                        <i class="${scoreIcon} me-1"></i>
                        ${score}/3
                    </span>
                </div>
                <div class="d-flex align-items-center">
                    <div class="progress flex-grow-1 me-3" style="height: 15px; background: #e9ecef; border-radius: 8px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);">
                        <div class="progress-bar" style="background: linear-gradient(90deg, ${scoreColor}, ${scoreColor}cc) !important; width: ${percentage}%; border-radius: 8px; transition: width 0.8s ease;">
                        </div>
                    </div>
                    <small style="color: #666; font-weight: 600; min-width: 40px; font-size: 0.9em;">${percentage}%</small>
                </div>
            </div>
        `;
    });
    
    return html;
}

// Función para crear gráfico radar específico para coach
function createCoachGrowthRadarChart(dimensionalScores) {
    const ctx = document.getElementById('coachGrowthRadarChart');
    if (!ctx) {
        console.log('❌ Canvas coachGrowthRadarChart no encontrado');
        return;
    }
    
    if (window.coachGrowthRadarChartInstance) {
        window.coachGrowthRadarChartInstance.destroy();
    }
    
    const labels = Object.keys(dimensionalScores);
    const data = Object.values(dimensionalScores);
    
    window.coachGrowthRadarChartInstance = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Preparación Empresarial',
                data: data,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.2)',
                borderWidth: 2,
                pointBackgroundColor: '#667eea',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                r: {
                    angleLines: {
                        display: true,
                        color: 'rgba(0,0,0,0.1)'
                    },
                    suggestedMin: 0,
                    suggestedMax: 3,
                    ticks: {
                        stepSize: 1,
                        display: true,
                        color: '#666'
                    },
                    pointLabels: {
                        font: {
                            size: 11
                        },
                        color: '#333'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom'
                }
            }
        }
    });
}

// ===== FUNCIONES DE GESTIÓN DE CONTENIDO =====

// Cargar coachees para el selector de contenido
function loadCoacheesForContent() {
    console.log('🔍 Cargando coachees para contenido...');
    
    fetch('/api/coach/my-coachees')
        .then(response => {
            console.log('📡 Respuesta recibida:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📊 Datos recibidos:', data);
            
            const select = document.getElementById('coacheeSelect');
            if (!select) {
                console.error('❌ Elemento coacheeSelect no encontrado');
                return;
            }
            
            select.innerHTML = '<option value="">Selecciona un coachee...</option>';
            
            if (data.success && data.coachees) {
                console.log(`✅ Procesando ${data.coachees.length} coachees`);
                
                data.coachees.forEach(coachee => {
                    const option = document.createElement('option');
                    option.value = coachee.id;
                    option.textContent = `${coachee.full_name} (${coachee.email})`;
                    select.appendChild(option);
                    console.log(`➕ Agregado: ${coachee.full_name}`);
                });
                
                console.log('✅ Coachees cargados exitosamente');
            } else {
                console.error('❌ No se encontraron coachees o respuesta inválida');
                select.innerHTML = '<option value="">No hay coachees disponibles</option>';
            }
        })
        .catch(error => {
            console.error('❌ Error cargando coachees para contenido:', error);
            alert('Error cargando lista de coachees: ' + error.message);
            
            const select = document.getElementById('coacheeSelect');
            if (select) {
                select.innerHTML = '<option value="">Error cargando coachees</option>';
            }
        });
}

// Validar URL de YouTube y mostrar vista previa
// Alias para compatibilidad con código existente
function validateYouTubeUrl(url) {
    return isYouTubeUrl(url);
}

function getYouTubeVideoId(url) {
    return extractYouTubeVideoId(url);
}

// Función para obtener información del video de YouTube
async function getYouTubeVideoInfo(url) {
    try {
        // Verificar si es una URL válida de YouTube
        if (!isYouTubeUrl(url)) {
            return null;
        }
        
        // Usar la API de oEmbed de YouTube para obtener información básica
        const oEmbedResponse = await fetch(`https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`);
        
        if (!oEmbedResponse.ok) {
            throw new Error('No se pudo obtener información del video');
        }
        
        const oEmbedData = await oEmbedResponse.json();
        
        return {
            title: oEmbedData.title || '',
            description: oEmbedData.author_name || 'Contenido educativo asignado por el coach',
            duration: null, // oEmbed no proporciona duración
            thumbnail: oEmbedData.thumbnail_url || ''
        };
    } catch (error) {
        console.warn('No se pudo obtener información del video:', error);
        
        // Fallback: usar información básica si no podemos obtener datos
        const videoId = extractYouTubeVideoId(url);
        return {
            title: 'Video de YouTube',
            description: 'Contenido educativo asignado por el coach',
            duration: null,
            thumbnail: videoId ? `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg` : ''
        };
    }
}

// Verificar si una URL es de YouTube
function isYouTubeUrl(url) {
    if (!url || typeof url !== 'string') return false;
    
    const youtubePatterns = [
        /^https?:\/\/(www\.)?youtube\.com\/watch\?v=[\w-]+/,
        /^https?:\/\/(www\.)?youtu\.be\/[\w-]+/,
        /^https?:\/\/(www\.)?youtube\.com\/embed\/[\w-]+/,
        /^https?:\/\/(www\.)?youtube\.com\/v\/[\w-]+/
    ];
    
    return youtubePatterns.some(pattern => pattern.test(url.trim()));
}

// Extraer el ID del video de YouTube de diferentes formatos de URL
function extractYouTubeVideoId(url) {
    if (!url) return null;
    
    const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/)([^&\n?#]+)/
    ];
    
    for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match) return match[1];
    }
    
    return null;
}

// Función mejorada para mostrar vista previa y llenar campos automáticamente
async function showVideoPreview(url) {
    const previewDiv = document.getElementById('videoPreview');
    const titleInput = document.getElementById('contentTitle');
    const descriptionInput = document.getElementById('contentDescription');
    const durationInput = document.getElementById('videoDuration');
    
    if (!url || !isYouTubeUrl(url)) {
        previewDiv.innerHTML = `
            <i class="fas fa-video fa-3x mb-2 text-muted"></i>
            <p class="small text-muted">La vista previa del video aparecerá aquí cuando ingreses una URL válida</p>
        `;
        return;
    }
    
    const videoId = extractYouTubeVideoId(url);
    if (videoId) {
        // Mostrar preview inmediatamente
        previewDiv.innerHTML = `
            <div class="ratio ratio-16x9">
                <iframe src="https://www.youtube.com/embed/${videoId}" 
                    title="Vista previa del video" frameborder="0" allowfullscreen>
                </iframe>
            </div>
            <p class="small text-info mt-2">
                <i class="fas fa-sync fa-spin me-1"></i>
                Obteniendo información del video...
            </p>
        `;
        
        try {
            // Obtener información del video usando la URL completa
            const videoInfo = await getYouTubeVideoInfo(url);
            
            if (videoInfo) {
                // Llenar campos automáticamente solo si están vacíos
                if (!titleInput.value.trim()) {
                    // Limpiar el título de paréntesis inicial problemático
                    let cleanTitle = videoInfo.title;
                    
                    // Si el título empieza con "(Video de", limpiar esa parte
                    if (cleanTitle.startsWith('(Video de')) {
                        // Buscar el cierre del paréntesis y tomar el texto después
                        const closeParenIndex = cleanTitle.indexOf(')');
                        if (closeParenIndex !== -1) {
                            cleanTitle = cleanTitle.substring(closeParenIndex + 1).trim();
                        }
                    }
                    
                    // Si el título aún está vacío o muy corto, usar un fallback
                    if (!cleanTitle || cleanTitle.length < 3) {
                        cleanTitle = 'Video educativo';
                    }
                    
                    titleInput.value = cleanTitle;
                    titleInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
                
                if (!descriptionInput.value.trim()) {
                    descriptionInput.value = videoInfo.description;
                    descriptionInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
                
                if (videoInfo.duration && !durationInput.value) {
                    durationInput.value = videoInfo.duration;
                    durationInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
                
                // Mostrar notificación de autocompletado
                showAutoFillNotification();
                
                // Actualizar el mensaje en la vista previa
                const infoText = previewDiv.querySelector('.text-info');
                if (infoText) {
                    infoText.innerHTML = `
                        <i class="fas fa-check-circle me-1 text-success"></i>
                        Información del video cargada automáticamente
                    `;
                    infoText.className = 'small text-success mt-2';
                }
            } else {
                // Fallback si no hay información
                const infoText = previewDiv.querySelector('.text-info');
                if (infoText) {
                    infoText.innerHTML = `
                        <i class="fas fa-exclamation-triangle me-1 text-warning"></i>
                        Vista previa disponible - completa manualmente los campos
                    `;
                    infoText.className = 'small text-warning mt-2';
                }
                
                // Llenar con valores por defecto
                if (!titleInput.value.trim()) {
                    titleInput.value = 'Video de YouTube';
                }
                if (!descriptionInput.value.trim()) {
                    descriptionInput.value = 'Contenido educativo asignado por el coach';
                }
            }
        } catch (error) {
            console.warn('Error al obtener información del video:', error);
            
            // Mantener la vista previa pero indicar que hubo un problema
            const infoText = previewDiv.querySelector('.text-info');
            if (infoText) {
                infoText.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-1 text-warning"></i>
                    Vista previa disponible - completa manualmente los campos
                `;
                infoText.className = 'small text-warning mt-2';
            }
            
            // Llenar con valores por defecto
            if (!titleInput.value.trim()) {
                titleInput.value = 'Video de YouTube';
            }
            if (!descriptionInput.value.trim()) {
                descriptionInput.value = 'Contenido educativo asignado por el coach';
            }
        }
    }
}

// Función para mostrar notificación de autocompletado
function showAutoFillNotification() {
    // Crear notificación temporal
    const notification = document.createElement('div');
    notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
    notification.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    notification.innerHTML = `
        <i class="fas fa-magic me-2"></i>
        <strong>¡Campos completados automáticamente!</strong>
        <br>
        <small>Puedes editar la información si es necesario</small>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remover después de 4 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 4000);
}

// Manejar formulario de asignación de contenido
function setupContentAssignmentForm() {
    const form = document.getElementById('assignContentForm');
    const urlInput = document.getElementById('videoUrl');
    
    let debounceTimer;
    
    // Vista previa en tiempo real con debounce para evitar muchas llamadas
    urlInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            showVideoPreview(this.value);
        }, 800); // Esperar 800ms después de que el usuario deje de escribir
    });
    
    // También procesar cuando se pierde el foco del campo
    urlInput.addEventListener('blur', function() {
        clearTimeout(debounceTimer);
        if (this.value.trim()) {
            showVideoPreview(this.value);
        }
    });
    
    // Envío del formulario
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        assignContentToCoachee();
    });
}

// Asignar contenido a coachee
async function assignContentToCoachee() {
    // Prevenir múltiples envíos concurrentes
    const submitButton = document.querySelector('#assignContentForm button[type="submit"]');
    if (submitButton.disabled) {
        console.log('⚠️ Submit ya en progreso, ignorando envío duplicado');
        return;
    }
    
    const coacheeId = document.getElementById('coacheeSelect').value;
    const videoUrl = document.getElementById('videoUrl').value;
    const title = document.getElementById('contentTitle').value;
    const description = document.getElementById('contentDescription').value;
    const duration = document.getElementById('videoDuration').value;
    
    // Validaciones
    if (!coacheeId) {
        showAlert('Por favor selecciona un coachee', 'warning');
        return;
    }
    
    if (!videoUrl) {
        showAlert('Por favor ingresa la URL del video', 'warning');
        return;
    }
    
    if (!validateYouTubeUrl(videoUrl)) {
        showAlert('Por favor ingresa una URL válida de YouTube', 'warning');
        return;
    }
    
    if (!title.trim()) {
        showAlert('Por favor ingresa un título para el contenido', 'warning');
        return;
    }
    
    try {
        // Deshabilitar botón durante envío
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Asignando...';
        
        console.log('📤 Enviando asignación de contenido:', {
            coacheeId,
            videoUrl,
            title: title.trim(),
            description: description.trim()
        });
        
        const response = await fetch('/api/coach/content', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                coachee_id: parseInt(coacheeId),
                title: title.trim(),
                description: description.trim(),
                content_type: 'video',
                content_url: videoUrl,
                duration: duration ? parseInt(duration) * 60 : null // convertir a segundos
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('¡Video asignado exitosamente!', 'success');
            resetAssignForm();
            // Actualizar la lista de contenido asignado si está visible
            if (document.getElementById('manage-content-tab').classList.contains('active')) {
                loadAssignedContent();
            }
        } else {
            throw new Error(data.error || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('Error asignando contenido:', error);
        showAlert('Error asignando contenido: ' + error.message, 'danger');
    } finally {
        // Restaurar botón
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-plus me-1"></i>Asignar Video';
    }
}

// Limpiar formulario de asignación
function resetAssignForm() {
    document.getElementById('assignContentForm').reset();
    showVideoPreview('');
}

// Cargar contenido asignado con filtros
async function loadAssignedContent() {
    const listContainer = document.getElementById('assignedContentList');
    
    try {
        listContainer.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando contenido...</span>
                </div>
            </div>
        `;
        
        // Obtener valores de filtros
        const coacheeFilter = document.getElementById('coacheeFilter').value;
        const viewMode = document.getElementById('viewModeFilter').value;
        
        // Construir URL con parámetros de filtro
        const params = new URLSearchParams();
        if (coacheeFilter) params.append('coachee_id', coacheeFilter);
        if (viewMode) params.append('view_mode', viewMode);
        
        const url = `/api/coach/content${params.toString() ? '?' + params.toString() : ''}`;
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            console.log('🔍 COACH-CONTENT: Datos recibidos del backend', {
                totalItems: data.content.length,
                statistics: data.statistics,
                currentFilter: data.current_filter,
                firstThreeItems: data.content.slice(0, 3).map(item => ({
                    id: item.id,
                    title: item.title,
                    view_mode: item.view_mode,
                    coachee_id: item.coachee_id
                }))
            });
            
            // Actualizar lista de coachees en el filtro si no está poblada
            updateCoacheeFilter(data.coachees);
            // Guardar datos para filtrado local
            lastLoadedContent = data.content;
            lastLoadedData = data;
            renderAssignedContent(data.content, data);
        } else {
            throw new Error(data.error || 'Error desconocido cargando contenido asignado');
        }
        
    } catch (error) {
        console.error('Error cargando contenido asignado:', error);
        listContainer.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
                <p class="text-danger">Error cargando contenido asignado</p>
                <small class="text-muted">${error.message}</small>
            </div>
        `;
    }
}

// Actualizar filtro de coachees
function updateCoacheeFilter(coachees) {
    const select = document.getElementById('coacheeFilter');
    const currentValue = select.value;
    
    // Mantener la opción "Todos"
    const allOption = select.querySelector('option[value=""]');
    select.innerHTML = '';
    select.appendChild(allOption);
    
    // Agregar coachees
    coachees.forEach(coachee => {
        const option = document.createElement('option');
        option.value = coachee.id;
        option.textContent = coachee.name;
        select.appendChild(option);
    });
    
    // Restaurar valor seleccionado
    select.value = currentValue;
}

// Aplicar filtros de contenido
function applyContentFilters() {
    loadAssignedContent();
}

// Limpiar filtros de contenido
function clearContentFilters() {
    document.getElementById('coacheeFilter').value = '';
    document.getElementById('viewModeFilter').value = 'all';
    document.getElementById('statusFilter').value = '';
    document.getElementById('contentSearch').value = '';
    loadAssignedContent();
}

// Función para refrescar lista (ya existente, pero actualizada)
function refreshContentList() {
    loadAssignedContent();
}

// Renderizar contenido asignado
function renderAssignedContent(contentList, data) {
    const listContainer = document.getElementById('assignedContentList');
    const statusFilter = document.getElementById('statusFilter').value;
    const searchTerm = document.getElementById('contentSearch').value.toLowerCase();
    
    console.log('🎨 RENDER-ASSIGNED: Iniciando renderizado', {
        originalCount: contentList.length,
        statusFilter,
        searchTerm,
        firstThreeItems: contentList.slice(0, 3).map(item => ({
            id: item.id,
            title: item.title,
            view_mode: item.view_mode
        }))
    });
    
    if (!contentList || contentList.length === 0) {
        listContainer.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-video fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Sin Contenido Asignado</h5>
                <p class="text-muted">No has asignado ningún contenido todavía.</p>
                <p class="small text-info">
                    <i class="fas fa-info-circle me-1"></i>
                    Usa la pestaña "Asignar Video" para crear nuevas asignaciones
                </p>
            </div>
        `;
        return;
    }
    
    // Filtrar contenido localmente
    let filteredContent = contentList.filter(content => {
        // Filtro de estado
        if (statusFilter === 'viewed' && !content.is_viewed && !content.total_viewed) return false;
        if (statusFilter === 'pending' && (content.is_viewed || (content.total_viewed > 0 && content.total_viewed >= content.total_assigned))) return false;
        
        // Filtro de búsqueda
        if (searchTerm) {
            const searchInTitle = content.title.toLowerCase().includes(searchTerm);
            const searchInCoachee = content.view_mode === 'unique' ? 
                content.assigned_to.toLowerCase().includes(searchTerm) :
                content.coachee_name.toLowerCase().includes(searchTerm);
            if (!searchInTitle && !searchInCoachee) return false;
        }
        
        return true;
    });
    
    console.log('📊 FILTER-RESULT: Después de filtros', {
        originalCount: contentList.length,
        filteredCount: filteredContent.length,
        filteredItems: filteredContent.map(item => ({
            id: item.id,
            title: item.title,
            view_mode: item.view_mode
        }))
    });

    // Estadísticas
    const stats = data.statistics;
    const statsHtml = `
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0">${stats.total_assigned}</h4>
                                <p class="mb-0">Total Asignado</p>
                            </div>
                            <i class="fas fa-video fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0">${stats.total_viewed}</h4>
                                <p class="mb-0">Visto</p>
                            </div>
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0">${stats.total_pending}</h4>
                                <p class="mb-0">Pendiente</p>
                            </div>
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Lista de contenido
    let contentHtml = '<div class="row">';
    
    if (filteredContent.length === 0) {
        contentHtml += `
            <div class="col-12">
                <div class="text-center py-4">
                    <i class="fas fa-filter fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No se encontró contenido con los filtros aplicados</p>
                    <button class="btn btn-outline-primary" onclick="clearContentFilters()">
                        <i class="fas fa-times me-1"></i>Limpiar Filtros
                    </button>
                </div>
            </div>
        `;
    } else {
        filteredContent.forEach(content => {
            if (content.view_mode === 'unique') {
                // Vista única - mostrar contenido agrupado
                contentHtml += renderUniqueContentCard(content);
            } else {
                // Vista normal - mostrar asignaciones individuales
                contentHtml += renderIndividualContentCard(content);
            }
        });
    }
    
    contentHtml += '</div>';
    
    listContainer.innerHTML = statsHtml + contentHtml;
}

// Renderizar tarjeta de contenido único
function renderUniqueContentCard(content) {
    const duration = content.duration ? Math.ceil(content.duration / 60) + ' min' : '';
    
    // Extraer video ID para thumbnail si es YouTube
    let thumbnailUrl = content.thumbnail_url;
    if (!thumbnailUrl && (content.content_url.includes('youtube.com') || content.content_url.includes('youtu.be'))) {
        let videoId = '';
        if (content.content_url.includes('youtube.com/watch?v=')) {
            videoId = content.content_url.split('v=')[1].split('&')[0];
        } else if (content.content_url.includes('youtu.be/')) {
            videoId = content.content_url.split('youtu.be/')[1].split('?')[0];
        }
        if (videoId) {
            thumbnailUrl = `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;
        }
    }
    
    const viewedPercentage = content.total_assigned > 0 ? 
        Math.round((content.total_viewed / content.total_assigned) * 100) : 0;
    
    return `
        <div class="col-lg-6 col-xl-4 mb-3">
            <div class="card h-100">
                ${thumbnailUrl ? `
                    <div class="position-relative">
                        <img src="${thumbnailUrl}" class="card-img-top" style="height: 180px; object-fit: cover;">
                        <div class="position-absolute top-0 end-0 m-2">
                            <span class="badge bg-info">
                                <i class="fas fa-users me-1"></i>${content.total_assigned} asignado${content.total_assigned !== 1 ? 's' : ''}
                            </span>
                        </div>
                        ${duration ? `
                            <div class="position-absolute bottom-0 end-0 m-2">
                                <span class="badge bg-dark bg-opacity-75">
                                    <i class="fas fa-clock me-1"></i>${duration}
                                </span>
                            </div>
                        ` : ''}
                    </div>
                ` : `
                    <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 180px;">
                        <div class="text-center">
                            <i class="fas fa-video fa-3x text-muted mb-2"></i>
                            <div>
                                <span class="badge bg-info">
                                    <i class="fas fa-users me-1"></i>${content.total_assigned} asignado${content.total_assigned !== 1 ? 's' : ''}
                                </span>
                            </div>
                        </div>
                    </div>
                `}
                
                <div class="card-body">
                    <h6 class="card-title">${escapeHtml(content.title)}</h6>
                    ${content.description ? `<p class="card-text small text-muted">${escapeHtml(content.description)}</p>` : ''}
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted">Progreso de visualización</small>
                            <small class="text-muted">${content.total_viewed}/${content.total_assigned}</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar ${viewedPercentage === 100 ? 'bg-success' : 'bg-primary'}" 
                                 role="progressbar" style="width: ${viewedPercentage}%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-users me-1"></i>
                            <strong>Asignado a:</strong> ${escapeHtml(content.assigned_to)}
                        </small>
                    </div>
                    
                    <div class="row g-2 mb-2">
                        <div class="col-4">
                            <div class="text-center">
                                <div class="badge bg-primary w-100">${content.total_assigned}</div>
                                <small class="text-muted">Total</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center">
                                <div class="badge bg-success w-100">${content.total_viewed}</div>
                                <small class="text-muted">Visto</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center">
                                <div class="badge bg-warning w-100">${content.total_pending}</div>
                                <small class="text-muted">Pendiente</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer bg-transparent">
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="window.open('${content.content_url}', '_blank')">
                            <i class="fas fa-external-link-alt me-1"></i>Ver Contenido
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="showContentAssignments(${content.id})">
                            <i class="fas fa-list me-1"></i>Ver Asignaciones
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Renderizar tarjeta de contenido individual
function renderIndividualContentCard(content) {
    const formattedDate = content.assigned_at ? 
        new Date(content.assigned_at).toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        }) : 'Sin fecha';
    
    const viewedDate = content.viewed_at ? 
        new Date(content.viewed_at).toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        }) : null;
    
    const duration = content.duration ? Math.ceil(content.duration / 60) + ' min' : '';
    
    const statusBadge = content.is_viewed ? 
        '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Visto</span>' : 
        '<span class="badge bg-warning"><i class="fas fa-clock me-1"></i>Pendiente</span>';
    
    // Extraer video ID para thumbnail si es YouTube
    let thumbnailUrl = content.thumbnail_url;
    if (!thumbnailUrl && (content.content_url.includes('youtube.com') || content.content_url.includes('youtu.be'))) {
        let videoId = '';
        if (content.content_url.includes('youtube.com/watch?v=')) {
            videoId = content.content_url.split('v=')[1].split('&')[0];
        } else if (content.content_url.includes('youtu.be/')) {
            videoId = content.content_url.split('youtu.be/')[1].split('?')[0];
        }
        if (videoId) {
            thumbnailUrl = `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;
        }
    }
    
    return `
        <div class="col-lg-6 col-xl-4 mb-3">
            <div class="card h-100">
                ${thumbnailUrl ? `
                    <div class="position-relative">
                        <img src="${thumbnailUrl}" class="card-img-top" style="height: 180px; object-fit: cover;">
                        <div class="position-absolute top-0 end-0 m-2">
                            ${statusBadge}
                        </div>
                        ${duration ? `
                            <div class="position-absolute bottom-0 end-0 m-2">
                                <span class="badge bg-dark bg-opacity-75">
                                    <i class="fas fa-clock me-1"></i>${duration}
                                </span>
                            </div>
                        ` : ''}
                    </div>
                ` : `
                    <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 180px;">
                        <div class="text-center">
                            <i class="fas fa-${content.content_type === 'video' ? 'video' : 'file-alt'} fa-3x text-muted mb-2"></i>
                            <div>${statusBadge}</div>
                        </div>
                    </div>
                `}
                
                <div class="card-body">
                    <h6 class="card-title">${escapeHtml(content.title)}</h6>
                    ${content.description ? `<p class="card-text small text-muted">${escapeHtml(content.description)}</p>` : ''}
                    
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-user me-1"></i>
                            <strong>Coachee:</strong> ${escapeHtml(content.coachee_name)}
                        </small>
                    </div>
                    
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-calendar me-1"></i>
                            <strong>Asignado:</strong> ${formattedDate}
                        </small>
                    </div>
                    
                    ${content.is_viewed && viewedDate ? `
                        <div class="mb-2">
                            <small class="text-success">
                                <i class="fas fa-check-circle me-1"></i>
                                <strong>Visto:</strong> ${viewedDate}
                            </small>
                        </div>
                    ` : ''}
                </div>
                
                <div class="card-footer bg-transparent">
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="window.open('${content.content_url}', '_blank')">
                            <i class="fas fa-external-link-alt me-1"></i>Ver Contenido
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAssignedContent(${content.id})">
                            <i class="fas fa-trash me-1"></i>Eliminar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Función para eliminar contenido asignado
async function deleteAssignedContent(contentId) {
    if (!confirm('¿Estás seguro de que quieres eliminar este contenido asignado?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/coach/content/${contentId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('Contenido eliminado exitosamente', 'success');
            loadAssignedContent(); // Recargar la lista
        } else {
            throw new Error(data.error || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('Error eliminando contenido:', error);
        showAlert('Error eliminando contenido: ' + error.message, 'danger');
    }
}

// Refrescar lista de contenido
function refreshContentList() {
    loadAssignedContent();
}

// Función para escapar HTML y prevenir XSS
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Configurar pestañas de contenido
function setupContentTabs() {
    const assignTab = document.getElementById('assign-content-tab');
    const manageTab = document.getElementById('manage-content-tab');
    
    assignTab.addEventListener('shown.bs.tab', function() {
        loadCoacheesForContent();
    });
    
    manageTab.addEventListener('shown.bs.tab', function() {
        loadAssignedContent();
    });
}

// Inicializar cuando se muestra el módulo de contenido
function initializeContentModule() {
    console.log('🚀 Inicializando módulo de contenido...');
    setupContentAssignmentForm();
    setupContentTabs();
    loadCoacheesForContent();
}

// Llamar a inicialización cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
    console.log('📄 DOM cargado, configurando observer para módulo de contenido...');
    
    // Observer para detectar cuando el módulo de contenido se hace visible
    const contentModule = document.getElementById('agregar-contenido');
    if (contentModule) {
        console.log('✅ Módulo de contenido encontrado, configurando observer...');
        
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                    const isVisible = contentModule.style.display !== 'none';
                    console.log('👁️ Cambio de visibilidad detectado:', isVisible);
                    
                    if (isVisible) {
                        console.log('🎯 Módulo de contenido ahora visible, inicializando...');
                        initializeContentModule();
                    }
                }
            });
        });
        
        observer.observe(contentModule, {
            attributes: true,
            attributeFilter: ['style']
        });
        
        // También intentar inicializar inmediatamente si ya está visible
        if (contentModule.style.display !== 'none') {
            console.log('🎯 Módulo ya visible, inicializando inmediatamente...');
            initializeContentModule();
        }
    } else {
        console.error('❌ Módulo de contenido no encontrado');
    }
    
    // También agregar listener para cuando se hace clic en el enlace de contenido
    const contentLink = document.querySelector('[data-module="agregar-contenido"]');
    if (contentLink) {
        console.log('✅ Enlace de contenido encontrado, agregando listener...');
        contentLink.addEventListener('click', function() {
            console.log('🖱️ Click en enlace de contenido detectado');
            setTimeout(() => {
                initializeContentModule();
            }, 100);
        });
    }
    
    // Agregar event listeners para los filtros de contenido
    const coacheeFilter = document.getElementById('coacheeFilter');
    const viewModeFilter = document.getElementById('viewModeFilter');
    const statusFilter = document.getElementById('statusFilter');
    const contentSearch = document.getElementById('contentSearch');
    
    if (coacheeFilter) {
        coacheeFilter.addEventListener('change', applyContentFilters);
    }
    if (viewModeFilter) {
        viewModeFilter.addEventListener('change', applyContentFilters);
    }
    if (statusFilter) {
        statusFilter.addEventListener('change', function() {
            // Para filtro de estado, aplicar filtro local sin recargar desde servidor
            const listContainer = document.getElementById('assignedContentList');
            if (listContainer && listContainer.innerHTML !== '') {
                // Re-aplicar renderizado con filtros locales
                renderAssignedContent(lastLoadedContent, lastLoadedData);
            }
        });
    }
    if (contentSearch) {
        let searchTimeout;
        contentSearch.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                // Para búsqueda, aplicar filtro local sin recargar desde servidor
                const listContainer = document.getElementById('assignedContentList');
                if (listContainer && listContainer.innerHTML !== '') {
                    renderAssignedContent(lastLoadedContent, lastLoadedData);
                }
            }, 300);
        });
    }
});

// Variables globales para mantener el último contenido cargado
let lastLoadedContent = [];
let lastLoadedData = {};

// Función para mostrar asignaciones de un contenido único
function showContentAssignments(contentId) {
    // Esta función mostrará un modal con todas las asignaciones individuales
    // Por ahora, cambiar a vista "all" y filtrar por ese contenido
    document.getElementById('viewModeFilter').value = 'all';
    loadAssignedContent();
}

// Funciones para el modal de edición de coachee
function toggleEditPassword() {
    const passwordInput = document.getElementById('editCoacheePassword');
    const passwordIcon = document.getElementById('editPasswordIcon');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        passwordIcon.className = 'fas fa-eye-slash';
    } else {
        passwordInput.type = 'password';
        passwordIcon.className = 'fas fa-eye';
    }
}

async function saveCoacheeChanges() {
    const coacheeId = document.getElementById('editCoacheeId').value;
    const name = document.getElementById('editCoacheeName').value.trim();
    const email = document.getElementById('editCoacheeEmail').value.trim();
    const password = document.getElementById('editCoacheePassword').value.trim();
    
    // Validaciones básicas
    if (!name) {
        showEditAlert('error', 'El nombre es requerido');
        return;
    }
    
    if (!email) {
        showEditAlert('error', 'El email es requerido');
        return;
    }
    
    if (!email.includes('@')) {
        showEditAlert('error', 'Formato de email inválido');
        return;
    }
    
    if (password && password.length < 4) {
        showEditAlert('error', 'La contraseña debe tener al menos 4 caracteres');
        return;
    }
    
    // Deshabilitar botón y mostrar cargando
    const saveBtn = document.getElementById('saveCoacheeBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Guardando...';
    
    try {
        const updateData = {
            full_name: name,
            email: email
        };
        
        // Solo incluir contraseña si se proporcionó una nueva
        if (password) {
            updateData.password = password;
        }
        
        const response = await fetch(`/api/coach/update-coachee/${coacheeId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updateData)
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            showEditAlert('success', 'Coachee actualizado exitosamente');
            
            // Actualizar los datos en memoria
            const coacheeIndex = coacheesData.findIndex(c => c.id == coacheeId);
            if (coacheeIndex !== -1) {
                coacheesData[coacheeIndex].name = name;
                coacheesData[coacheeIndex].full_name = name;
                coacheesData[coacheeIndex].email = email;
                if (password) {
                    coacheesData[coacheeIndex].password = password;
                }
            }
            
            // Actualizar la tabla
            displayCoachees();
            
            // Cerrar modal después de un breve delay
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('editCoacheeModal'));
                modal.hide();
            }, 1500);
            
        } else {
            showEditAlert('error', data.error || 'Error al actualizar el coachee');
        }
        
    } catch (error) {
        console.error('Error updating coachee:', error);
        showEditAlert('error', 'Error de conexión. Inténtalo de nuevo.');
    } finally {
        // Restaurar botón
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
    }
}

function showEditAlert(type, message) {
    const alertDiv = document.getElementById('editCoacheeAlert');
    alertDiv.className = `alert alert-${type === 'error' ? 'danger' : 'success'}`;
    alertDiv.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'check-circle'} me-1"></i>${message}`;
}

// Funciones para manejo de invitaciones de WhatsApp
function generateInvitationMessage() {
    const data = window.currentCoacheeData;
    if (!data) return;
    
    let message = `🎯 *Invitación a Evaluación de Coaching*\n\n`;
    message += `¡Hola ${data.name}! 👋\n\n`;
    message += `Has sido invitado/a a participar en una evaluación de coaching. `;
    message += `A continuación encontrarás tus credenciales de acceso:\n\n`;
    
    message += `📋 *DATOS DE ACCESO:*\n`;
    message += `• *Usuario:* ${data.username}\n`;
    message += `• *Contraseña:* ${data.password}\n`;
    message += `• *Link de acceso:* ${data.loginUrl}\n\n`;
    
    if (data.assignedAssessment) {
        message += `✅ *EVALUACIÓN ASIGNADA:*\n`;
        message += `"${data.assignedAssessment}"\n\n`;
    }
    
    message += `📱 *INSTRUCCIONES:*\n`;
    message += `1. Haz clic en el link de acceso\n`;
    message += `2. Ingresa tu usuario y contraseña\n`;
    message += `3. Completa la evaluación asignada\n`;
    message += `4. ¡Listo! Tu coach revisará los resultados\n\n`;
    
    message += `💡 *Tip:* Responde con honestidad para obtener los mejores insights para tu desarrollo.\n\n`;
    message += `¿Tienes dudas? ¡Contáctame! 😊`;
    
    document.getElementById('invitationMessage').textContent = message;
    return message;
}

function copyInvitationToClipboard() {
    const message = document.getElementById('invitationMessage').textContent;
    
    // Usar la API moderna del portapapeles si está disponible
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(message).then(() => {
            showNotification('¡Mensaje copiado al portapapeles!', 'success');
        }).catch(err => {
            console.error('Error al copiar al portapapeles:', err);
            fallbackCopyToClipboard(message);
        });
    } else {
        fallbackCopyToClipboard(message);
    }
}

function fallbackCopyToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showNotification('¡Mensaje copiado al portapapeles!', 'success');
    } catch (err) {
        console.error('Error al copiar:', err);
        showNotification('Error al copiar. Por favor, selecciona y copia manualmente.', 'error');
    }
    
    document.body.removeChild(textArea);
}

function shareViaWhatsApp() {
    const message = document.getElementById('invitationMessage').textContent;
    const encodedMessage = encodeURIComponent(message);
    const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
    
    // Abrir WhatsApp en una nueva ventana
    window.open(whatsappUrl, '_blank');
    
    showNotification('Abriendo WhatsApp...', 'info');
}

function shareViaEmail() {
    const data = window.currentCoacheeData;
    if (!data) return;
    
    const subject = `Invitación a Evaluación de Coaching - ${data.name}`;
    const body = document.getElementById('invitationMessage').textContent;
    
    const emailUrl = `mailto:${data.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    
    // Abrir cliente de email
    window.location.href = emailUrl;
    
    showNotification('Abriendo cliente de email...', 'info');
}

function showNotification(message, type = 'info') {
    // Crear notificación temporal
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 15000; min-width: 300px;';
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-1"></i>
        ${message}
    `;
    
    document.body.appendChild(notification);
    
    // Remover después de 3 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

function closeInvitationModal() {
    const modalElement = document.getElementById('invitationSuccessModal');
    if (modalElement) {
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
            // Limpiar backdrop si queda colgado
            setTimeout(() => {
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }, 300);
        } else {
            // Método alternativo si no hay instancia
            modalElement.style.display = 'none';
            modalElement.classList.remove('show');
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }
        console.log('✅ Modal cerrado manualmente');
    }
}

// Agregar listener para ESC global como fallback
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modal = document.getElementById('invitationSuccessModal');
        if (modal && modal.classList.contains('show')) {
            closeInvitationModal();
            console.log('✅ Modal cerrado con ESC');
        }
    }
});

// Cache buster - Forzar recarga: 2025-10-18-13:10
console.log('🔄 Template actualizado: 2025-10-18-13:10 - Invitaciones WhatsApp implementadas con modal y compartir');
</script>
{% endblock %}
