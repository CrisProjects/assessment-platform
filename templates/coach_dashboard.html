{% extends "base.html" %}

{% block title %}Dashboard Coach - Assessment Platform{% endblock %}

{% block extra_css %}
<!-- Anti-cache meta tags -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<style>
    /* Variables CSS para recomendaciones unificadas - IGUAL QUE COACHEE */
    :root {
        --calm-primary: #1E3A8A;        /* Deep Blue */
        --calm-secondary: #3B82F6;      /* Bright Blue */
        --calm-accent: #06B6D4;         /* Cyan */
        --calm-light: #EFF6FF;          /* Very Light Blue */
        --calm-dark: #1E293B;           /* Dark Slate */
        --calm-white: #FFFFFF;
        --calm-gray-50: #F8FAFC;
        --calm-gray-100: #F1F5F9;
    }
    
    /* ANULAR SISTEMA DE TEMAS PARA SIDEBAR - PROBLEMA ENCONTRADO! */
    .sidebar,
    .sidebar * {
        --theme-card-bg: white !important;
        --theme-card-border: #dee2e6 !important;
        --theme-text-primary: #333 !important;
        --theme-text-secondary: #333 !important;
        --theme-hover-bg: #f8f9fa !important;
    }
    
    /* ESTILOS DE CONTRASTE ALTO - SIN TRANSPARENCIAS - v2.3 */
    body {
        background: #f8f9fa !important;
        color: #333 !important;
    }
    
    /* Cards con fondo blanco sólido */
    .card,
    .glass-card,
    .modal-content {
        background: white !important;
        border: 1px solid #dee2e6 !important;
        color: #333 !important;
        backdrop-filter: none !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
    }
    
    .card.bg-dark {
        background: white !important;
        border: 1px solid #dee2e6 !important;
    }
    
    .card.bg-dark .card-body {
        background: white !important;
    }
    
    /* Textos con contraste */
    .text-white,
    .text-muted,
    .card.bg-dark .text-white,
    .card.bg-dark .text-muted {
        color: #333 !important;
    }
    
    .text-primary {
        color: #0066cc !important;
    }
    
    /* Botones con colores sólidos */
    .btn-outline-light {
        border-color: #dee2e6 !important;
        color: #333 !important;
        background: white !important;
    }
    
    .btn-outline-light:hover {
        background: #f8f9fa !important;
        border-color: #adb5bd !important;
        color: #333 !important;
    }
    
    .btn-primary {
        background: #007bff !important;
        border-color: #007bff !important;
        color: white !important;
    }
    
    .btn-success {
        background: #28a745 !important;
        border-color: #28a745 !important;
        color: white !important;
    }
    
    .btn-info {
        background: #17a2b8 !important;
        border-color: #17a2b8 !important;
        color: white !important;
    }
    
    /* Modal con fondo sólido */
    .modal-content {
        background: white !important;
        color: #333 !important;
    }
    
    .modal-header {
        background: #f8f9fa !important;
        border-bottom: 1px solid #dee2e6 !important;
    }
    
    .modal-title {
        color: #333 !important;
    }
    
    /* Elementos de evaluación */
    .evaluation-item {
        background: white !important;
        border: 1px solid #dee2e6 !important;
        color: #333 !important;
        margin-bottom: 1rem;
        padding: 1rem;
        border-radius: 8px;
    }
    
    .evaluation-item:hover {
        background: #f8f9fa !important;
        border-color: #adb5bd !important;
    }
    
    /* Progress bars */
    .progress {
        background: #e9ecef !important;
    }
    
    .progress-bar {
        background: #007bff !important;
    }
    
    /* Tables */
    .table-dark {
        background: white !important;
        color: #333 !important;
    }
    
    .table-dark th,
    .table-dark td {
        background: white !important;
        color: #333 !important;
        border-color: #dee2e6 !important;
    }
    
    .table-hover tbody tr:hover {
        background: #f8f9fa !important;
        color: #333 !important;
    }
    
    /* Sidebar limpio - FORZAR CACHE REFRESH v2.1 */
    .sidebar,
    .sidebar .card,
    .sidebar .card.bg-dark,
    .sidebar .card.bg-dark.border-secondary {
        background: white !important;
        background-color: white !important;
        border-right: 1px solid #dee2e6 !important;
        border: 1px solid #dee2e6 !important;
    }
    
    .sidebar .card-header,
    .sidebar .card-header.bg-dark,
    .sidebar .card-header.bg-dark.border-secondary {
        background: #f8f9fa !important;
        background-color: #f8f9fa !important;
        border-bottom: 1px solid #dee2e6 !important;
        color: #333 !important;
    }
    
    .sidebar .card-header h6,
    .sidebar .card-header .text-white,
    .sidebar .card-header h6.mb-0 {
        color: #333 !important;
        font-weight: 600 !important;
    }
    
    .sidebar .nav-link,
    .sidebar .list-group-item,
    .sidebar .list-group-item.bg-dark {
        background: white !important;
        color: #333 !important;
        border-color: #dee2e6 !important;
    }
    
    .sidebar .nav-link:hover,
    .sidebar .list-group-item:hover {
        background: #f8f9fa !important;
        color: #333 !important;
    }
    
    .sidebar .nav-link.active,
    .sidebar .list-group-item.active {
        background: #007bff !important;
        color: white !important;
        border-color: #007bff !important;
    }
    
    /* FUERZA ANTI-CACHE ESPECÍFICO PANEL DE CONTROL */
    .sidebar .card[style*="background"] {
        background: white !important;
        background-color: white !important;
    }
    
    .sidebar .card-header[style*="background"] {
        background: #f8f9fa !important;
        background-color: #f8f9fa !important;
        color: #333 !important;
    }
    
    .sidebar h6[style*="color"] {
        color: #333 !important;
    }
    
    /* Timestamp para forzar refresh: 20250831-1135 */
    
    /* MÁXIMA ESPECIFICIDAD PARA PANEL DE CONTROL */
    .sidebar.sidebar-force-white,
    .sidebar.sidebar-force-white.card,
    .sidebar.sidebar-force-white.card.bg-dark,
    .sidebar.sidebar-force-white.card.bg-dark.border-secondary {
        background: white !important;
        background-color: white !important;
        border: 1px solid #dee2e6 !important;
    }
    
    .sidebar .sidebar-header-force,
    .sidebar .sidebar-header-force.card-header,
    .sidebar .sidebar-header-force.card-header.bg-dark {
        background: #f8f9fa !important;
        background-color: #f8f9fa !important;
        color: #333 !important;
        border-bottom: 1px solid #dee2e6 !important;
    }
    
    .sidebar .sidebar-title-force,
    .sidebar .sidebar-title-force.mb-0,
    .sidebar .sidebar-title-force.text-white {
        color: #333 !important;
        font-weight: 600 !important;
    }
    
    /* NUEVA CLASE ULTRA-ESPECÍFICA - ELIMINAR CUALQUIER BG-DARK */
    .sidebar-white,
    .sidebar-white.card,
    .sidebar-white.sidebar,
    .sidebar-white.sidebar.card {
        background: white !important;
        background-color: white !important;
        border: 1px solid #dee2e6 !important;
    }
    
    .sidebar-header-white,
    .sidebar-header-white.card-header {
        background: #f8f9fa !important;
        background-color: #f8f9fa !important;
        color: #333 !important;
        border-bottom: 1px solid #dee2e6 !important;
    }
    
    .sidebar-title-white,
    .sidebar-title-white.mb-0 {
        color: #333 !important;
        font-weight: 600 !important;
    }
    
    /* ENFOQUE NUCLEAR - ANULAR CUALQUIER BG-DARK EN SIDEBAR */
    .sidebar *,
    .sidebar *.bg-dark,
    .sidebar *.bg-secondary,
    .sidebar *.bg-primary,
    .sidebar .card.bg-dark,
    .sidebar .card-header.bg-dark,
    .sidebar .card-body.bg-dark {
        background: white !important;
        background-color: white !important;
    }
    
    .sidebar .card-header *,
    .sidebar .card-header *.bg-dark {
        background: #f8f9fa !important;
        background-color: #f8f9fa !important;
        color: #333 !important;
    }
    
    /* Charts con colores sólidos */
    .chart-container {
        background: white !important;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    
    /* Estilos profesionales para recomendaciones categorizadas - UNIFICADOS */
    .recommendations-container {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 16px;
        border: 2px solid var(--calm-accent);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }
    
    .recommendations-header {
        background: linear-gradient(135deg, var(--calm-primary) 0%, #1D4ED8 100%);
        color: white !important;
        padding: 1.5rem;
        border-bottom: 3px solid var(--calm-accent);
        position: relative;
    }
    
    .recommendations-header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--calm-accent) 0%, #0ea5e9 50%, var(--calm-accent) 100%);
    }
    
    .recommendation-category {
        background: white;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
        overflow: hidden;
        transition: all 0.3s ease;
        animation: fadeInUp 0.6s ease-out;
    }
    
    .recommendation-category:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        border-color: var(--calm-accent);
    }
    
    .category-header {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        border-bottom: 2px solid #e2e8f0;
        padding: 1rem 1.25rem;
        position: relative;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .category-title {
        font-weight: 700;
        color: var(--calm-primary);
        font-size: 1.1rem;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .category-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--calm-accent) 0%, #0ea5e9 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        margin-right: 0.75rem;
        animation: pulse 2s infinite;
    }
    
    .score-badge {
        background: linear-gradient(135deg, var(--calm-secondary) 0%, var(--calm-accent) 100%);
        color: white;
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    .priority-indicator {
        position: absolute;
        top: 0;
        right: 0;
        width: 0;
        height: 0;
        border-left: 15px solid transparent;
        border-top: 15px solid;
    }
    
    .priority-high {
        border-top-color: #ef4444;
    }
    
    .priority-medium {
        border-top-color: #f59e0b;
    }
    
    .priority-low {
        border-top-color: #06b6d4;
    }
    
    .priority-growth {
        border-top-color: #10b981;
    }
    
    .category-content {
        padding: 1.25rem;
    }
    
    .recommendation-item {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 8px;
        padding: 0.75rem 1rem;
        margin-bottom: 0.75rem;
        border-left: 4px solid var(--calm-accent);
        position: relative;
        transition: all 0.3s ease;
        transform: translateY(0);
    }
    
    .recommendation-item:hover {
        background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
        border-left-color: var(--calm-primary);
        transform: translateX(5px) translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-color: var(--bs-primary) !important;
    }
    
    .recommendation-item:before {
        content: "✓";
        position: absolute;
        left: -2px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        background: var(--calm-accent);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .recommendation-text {
        margin-left: 1.5rem;
        line-height: 1.6;
        color: #334155;
        font-weight: 500;
    }
    
    .general-recommendations {
        border: 2px solid var(--calm-primary);
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    }
    
    .general-recommendations .category-header {
        background: linear-gradient(135deg, var(--calm-primary) 0%, #1D4ED8 100%);
        color: white;
        border-bottom-color: var(--calm-primary);
    }
    
    .general-recommendations .category-title {
        color: white;
    }
    
    .strengths-category {
        border: 2px solid #10b981;
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    }
    
    .strengths-category .category-header {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border-bottom-color: #10b981;
    }
    
    .strengths-category .category-title {
        color: white;
    }
    
    .strengths-category .recommendation-item {
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        border-left-color: #10b981;
    }
    
    .strengths-category .recommendation-item:before {
        background: #10b981;
        content: "★";
    }
    
    .final-message {
        border: 2px solid #8b5cf6;
        background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
    }
    
    .final-message .category-header {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        border-bottom-color: #8b5cf6;
    }
    
    .final-message .category-title {
        color: white;
    }
    
    .final-message .recommendation-item {
        background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
        border-left-color: #8b5cf6;
    }
    
    /* Estilos especiales para subcategorías de dimensiones */
    .dimension-subcategory {
        border: 2px solid var(--calm-primary);
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        margin-bottom: 2rem;
    }
    
    .subcategory-header {
        background: linear-gradient(135deg, var(--calm-primary) 0%, #1D4ED8 100%);
        color: white;
        padding: 1.25rem;
        border-bottom: 3px solid var(--calm-accent);
    }
    
    .subcategory-title-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .subcategory-info {
        flex: 1;
    }
    
    .subcategory-title {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 700;
        color: white;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .action-list li {
        position: relative;
        padding-left: 0.5rem;
    }
    
    .action-list li:before {
        content: "→";
        position: absolute;
        left: -0.5rem;
        color: var(--bs-primary);
        font-weight: bold;
    }
    
    .item-number {
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .category-header {
            padding: 1rem !important;
        }
        
        .category-header .d-flex {
            flex-direction: column;
            text-align: center;
        }
        
        .category-icon {
            margin-bottom: 1rem;
        }
        
        .recommendation-item {
            padding: 1rem !important;
        }
        
        /* Mejoras para header en móviles */
        .dashboard-header {
            padding: 1rem !important;
        }
        
        .dashboard-header .d-flex {
            flex-direction: column !important;
            align-items: flex-start !important;
            gap: 1rem !important;
        }
        
        .dashboard-header .btn-group-mobile {
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 0.5rem !important;
            width: 100% !important;
        }
        
        .dashboard-header .btn-group-mobile .btn {
            flex: 1 !important;
            min-width: 0 !important;
            font-size: 0.75rem !important;
            padding: 0.375rem 0.5rem !important;
        }
        
        .dashboard-header .btn-group-mobile .btn .fas {
            margin-right: 0.25rem !important;
        }
        
        /* Statistics cards responsive */
        .stats-card-mobile {
            margin-bottom: 1rem !important;
            min-height: 140px !important;
        }
        
        .stats-card-mobile .card-body {
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            text-align: center !important;
            padding: 1.5rem 1rem !important;
        }
        
        .stats-card-mobile h3 {
            font-size: 2rem !important;
            margin-bottom: 0.5rem !important;
        }
        
        .stats-card-mobile .text-muted {
            font-size: 0.875rem !important;
            margin-bottom: 0 !important;
        }
        
        /* Mobile coachees cards */
        .coachee-card-mobile {
            margin-bottom: 1rem !important;
            border: 1px solid #e3e6f0 !important;
            border-radius: 8px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        }
        
        .coachee-card-mobile:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
            transform: translateY(-1px);
            transition: all 0.3s ease;
        }
        
        /* Task management mobile styles */
        #gestion-tareas .row.g-3 {
            margin-bottom: 1rem !important;
        }
        
        #gestion-tareas .col-md-6 {
            margin-bottom: 0.75rem !important;
        }
        
        #gestion-tareas .form-label {
            font-size: 0.875rem !important;
            margin-bottom: 0.25rem !important;
        }
        
        #gestion-tareas .form-control,
        #gestion-tareas .form-select {
            font-size: 0.875rem !important;
            padding: 0.5rem 0.75rem !important;
        }
        
        #gestion-tareas textarea.form-control {
            min-height: 80px !important;
        }
        
        #gestion-tareas .btn {
            padding: 0.5rem 1rem !important;
            font-size: 0.875rem !important;
        }
        
        /* Task cards mobile */
        #tasksCardsContainer .card {
            border: 1px solid #e3e6f0 !important;
            border-radius: 8px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08) !important;
            transition: all 0.3s ease !important;
        }
        
        #tasksCardsContainer .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            transform: translateY(-2px);
        }
        
        #tasksCardsContainer .card-title {
            font-size: 1rem !important;
            line-height: 1.3 !important;
        }
        
        #tasksCardsContainer .card-text {
            font-size: 0.875rem !important;
            line-height: 1.4 !important;
        }
        
        #tasksCardsContainer .btn-group .btn {
            padding: 0.25rem 0.5rem !important;
            font-size: 0.75rem !important;
        }
        
        #tasksCardsContainer .row.g-2 {
            margin-bottom: 0.5rem !important;
        }
        
        #tasksCardsContainer .small {
            font-size: 0.75rem !important;
        }
        
        .stats-card-mobile {
            height: 100% !important;
        }
        
        .stats-card-mobile .card {
            height: 100% !important;
            min-height: 140px !important;
        }
        
        .stats-card-mobile .card-body {
            padding: 1rem 0.75rem !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            text-align: center !important;
            height: 100% !important;
        }
        
        .stats-card-mobile .fa-2x {
            font-size: 1.5rem !important;
            margin-bottom: 0.5rem !important;
        }
        
        .stats-card-mobile h4 {
            font-size: 1.25rem !important;
            margin-bottom: 0.25rem !important;
            line-height: 1.2 !important;
        }
        
        .stats-card-mobile .small {
            font-size: 0.7rem !important;
            line-height: 1.1 !important;
            margin-bottom: 0 !important;
        }
        
        /* Container fluid para móviles */
        .container-fluid {
            padding-left: 0.75rem !important;
            padding-right: 0.75rem !important;
        }
        
        /* Sidebar en móviles */
        .sidebar .card {
            margin-bottom: 1rem !important;
        }
        
        .sidebar .card-body {
            padding: 0.75rem !important;
        }
        
        /* Títulos más pequeños en móvil */
        .dashboard-header h3 {
            font-size: 1.5rem !important;
        }
        
        .dashboard-header p {
            font-size: 0.875rem !important;
        }
        
        /* Ajustes adicionales para textos en móvil */
        .small {
            font-size: 0.75rem !important;
        }
        
        /* Coachees cards para móvil */
        .coachee-card-mobile {
            background-color: white !important;
            border: 1px solid #dee2e6 !important;
            border-radius: 8px !important;
            margin-bottom: 1rem !important;
            padding: 1rem !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        }
        
        .coachee-card-mobile .coachee-header {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 0.75rem !important;
            border-bottom: 1px solid #eee !important;
            padding-bottom: 0.5rem !important;
        }
        
        .coachee-card-mobile .coachee-name {
            font-weight: 600 !important;
            font-size: 1rem !important;
            color: #212529 !important;
            margin: 0 !important;
        }
        
        .coachee-card-mobile .coachee-status {
            font-size: 0.75rem !important;
        }
        
        .coachee-card-mobile .coachee-details {
            margin-bottom: 0.75rem !important;
        }
        
        .coachee-card-mobile .coachee-detail-item {
            display: flex !important;
            justify-content: space-between !important;
            margin-bottom: 0.5rem !important;
            font-size: 0.85rem !important;
        }
        
        .coachee-card-mobile .coachee-detail-label {
            font-weight: 500 !important;
            color: #666 !important;
        }
        
        .coachee-card-mobile .coachee-detail-value {
            color: #212529 !important;
            text-align: right !important;
        }
        
        .coachee-card-mobile .coachee-actions {
            display: flex !important;
            gap: 0.5rem !important;
            justify-content: center !important;
        }
        
        .coachee-card-mobile .btn-sm {
            font-size: 0.75rem !important;
            padding: 0.25rem 0.5rem !important;
        }
        
        /* Estilos para botón de asignar */
        .btn-outline-success:hover {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }
        
        /* Estilos para el modal de asignación */
        #assignModal .nav-tabs .nav-link {
            color: #6c757d;
        }
        
        #assignModal .nav-tabs .nav-link.active {
            color: #28a745;
            border-color: #28a745;
        }
        
        #assignModal .tab-content {
            min-height: 300px;
        }
    }
    
    /* Estilos adicionales para tablets */
    @media (max-width: 992px) {
        .dashboard-header .btn-group-mobile .btn {
            font-size: 0.8rem !important;
            padding: 0.4rem 0.6rem !important;
        }
        
        .stats-card-mobile h4 {
            font-size: 1.3rem !important;
        }
    }
    
    /* Estilos para evaluaciones del coachee */
    .summary-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .summary-icon {
        width: 40px;
        height: 40px;
        background: var(--bs-primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .summary-number {
        font-size: 1.2rem;
        font-weight: bold;
        color: #333;
    }
    
    .summary-label {
        font-size: 0.85rem;
        color: #666;
    }
    
    /* Estilos para evaluaciones disponibles */
    .assessment-card {
        background: white;
        border: 1px solid #e3e6f0;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .assessment-card:hover {
        border-color: #e3e6f0;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.05);
    }
    
    .assessment-card.selected {
        border-color: #4e73df;
        background-color: #f8f9fc;
    }
    
    .assessment-actions {
        border-top: 1px solid #e9ecef;
        padding-top: 1rem;
        margin-top: 1rem;
    }
    
    .assessment-actions .btn {
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .assessment-actions .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.15);
    }
    
    .assessment-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }
    
    .assessment-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
    }
    
    .assessment-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        color: white !important;
        border: none;
    }
    
    .assessment-badge.bg-success {
        background: #28a745 !important;
        color: white !important;
    }
    
    .assessment-badge.bg-primary {
        background: #007bff !important;
        color: white !important;
    }
    
    .assessment-description {
        color: #6c757d;
        font-size: 0.9rem;
        line-height: 1.5;
        margin-bottom: 1rem;
    }
    
    .assessment-stats {
        display: flex;
        gap: 1.5rem;
        align-items: center;
        font-size: 0.85rem;
        color: #8b949e;
    }
    
    .assessment-stat {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .assessment-stat i {
        color: #4e73df;
    }
    
    /* Responsive styles para evaluaciones en móvil */
    @media (max-width: 768px) {
        .assessment-card {
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 8px;
        }
        
        .assessment-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .assessment-title {
            font-size: 1rem;
            line-height: 1.3;
        }
        
        .assessment-badge {
            align-self: flex-start;
            font-size: 0.7rem;
            padding: 0.2rem 0.6rem;
        }
        
        .assessment-badge.bg-success {
            background: #28a745 !important;
            color: white !important;
        }
        
        .assessment-badge.bg-primary {
            background: #007bff !important;
            color: white !important;
        }
        
        .assessment-description {
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }
        
        .assessment-stats {
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.8rem;
        }
        
        .assessment-stat {
            gap: 0.4rem;
            flex: 1;
            min-width: calc(50% - 0.5rem);
        }
        
        .assessment-stat i {
            font-size: 0.9rem;
        }
        
        /* Mejorar el spacing del spinner de carga */
        #assessments-loading {
            padding: 2rem 1rem !important;
        }
        
        /* Mejorar mensaje de no evaluaciones */
        #no-assessments {
            padding: 2rem 1rem !important;
        }
        
        #no-assessments i {
            font-size: 2.5rem !important;
            margin-bottom: 1rem !important;
        }
        
        #no-assessments h6 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        
        #no-assessments p {
            font-size: 0.85rem;
        }
        
        /* Mejorar alertas de error */
        #assessments-error {
            margin: 0;
            font-size: 0.85rem;
            padding: 0.75rem;
        }
    }
    
    /* Extra small devices (portrait phones, less than 576px) */
    @media (max-width: 575.98px) {
        .assessment-card {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .assessment-header {
            margin-bottom: 0.5rem;
        }
        
        .assessment-title {
            font-size: 0.95rem;
        }
        
        .assessment-description {
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }
        
        .assessment-stats {
            gap: 0.75rem;
            font-size: 0.75rem;
        }
        
        .assessment-stat {
            min-width: 100%;
            margin-bottom: 0.25rem;
        }
        
        /* Mejorar card-body padding en móvil */
        #seleccionar-evaluaciones .card-body {
            padding: 0.75rem !important;
        }
        
        /* Header más compacto en móvil */
        #seleccionar-evaluaciones .card-header {
            padding: 0.75rem !important;
        }
        
        #seleccionar-evaluaciones .card-header h5 {
            font-size: 1rem;
        }
        
        #seleccionar-evaluaciones .card-header .small {
            font-size: 0.75rem;
        }
    }
    
    /* Touch-friendly interactions */
    @media (hover: none) and (pointer: coarse) {
        .assessment-card:hover {
            transform: none;
        }
        
        .assessment-card:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }
    }
    
    /* High contrast mode for accessibility */
    @media (prefers-contrast: high) {
        .assessment-card {
            border-width: 2px;
        }
        
        .assessment-badge {
            border: 1px solid #4e73df;
        }
    }
    
    /* Reduced motion preferences */
    @media (prefers-reduced-motion: reduce) {
        .assessment-card {
            transition: none;
        }
        
        .assessment-card:hover {
            transform: none;
        }
    }
    
    /* Estilos adicionales para interacciones móviles */
    .selection-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #28a745;
        color: white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        animation: selectionPulse 0.3s ease-out;
        z-index: 10;
    }
    
    @keyframes selectionPulse {
        0% {
            transform: scale(0);
            opacity: 0;
        }
        50% {
            transform: scale(1.2);
            opacity: 1;
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }
    
    .assessment-card.selected {
        border-color: #28a745;
        box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25);
        background: rgba(40, 167, 69, 0.05);
    }
    
    .assessment-preview-card {
        background: rgba(13, 110, 253, 0.1);
        border: 1px solid rgba(13, 110, 253, 0.3);
        border-radius: 8px;
        padding: 1rem;
    }
    
    /* Mejoras para modales en móvil */
    @media (max-width: 575.98px) {
        .modal-dialog {
            margin: 0.5rem;
        }
        
        .modal-content {
            border-radius: 12px;
        }
        
        .modal-header {
            padding: 1rem;
        }
        
        .modal-title {
            font-size: 1.1rem;
        }
        
        .modal-body {
            padding: 1rem;
        }
        
        .modal-footer {
            padding: 1rem;
            gap: 0.5rem;
        }
        
        .assessment-preview-card {
            padding: 0.75rem;
        }
    }
    
    /* Botones táctiles mejorados */
    @media (hover: none) and (pointer: coarse) {
        .assessment-card {
            transition: background-color 0.2s ease;
        }
        
        .assessment-card:active {
            background: rgba(13, 110, 253, 0.1);
            transform: scale(0.98);
        }
        
        .btn {
            min-height: 44px;
            padding: 0.75rem 1rem;
        }
        
        .btn-sm {
            min-height: 40px;
            padding: 0.5rem 0.75rem;
        }
    }
    
    .evaluation-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        position: relative;
    }
    
    .evaluation-card.recent-evaluation {
        border-left: 4px solid #28a745;
    }
    
    .recent-badge {
        position: absolute;
        top: -8px;
        right: 1rem;
        background: #28a745;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .evaluation-icon {
        width: 45px;
        height: 45px;
        background: var(--bs-primary);
        color: white;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .evaluation-title {
        color: #333;
        font-weight: 600;
        margin: 0;
    }
    
    .evaluation-meta {
        display: flex;
        gap: 1rem;
    }
    
    .meta-item {
        font-size: 0.85rem;
        color: #666;
    }
    
    .score-display {
        text-align: center;
        margin-bottom: 0.5rem;
    }
    
    .score-display.score-low { color: #dc3545; }      /* Rojo - Bajo 40% */
    .score-display.score-medium { color: #007bff; }   /* Azul - 40-79% */
    .score-display.score-high { color: #28a745; }     /* Verde - 80%+ */
    
    .score-number {
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1;
    }
    
    .score-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .section-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }
    
    .interpretation-text {
        font-size: 0.9rem;
        color: #666;
        line-height: 1.5;
        margin: 0;
    }
    
    .dimensions-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .dimension-item {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 0.5rem;
        flex: 1;
        min-width: 120px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .dimension-name {
        font-size: 0.8rem;
        color: #666;
    }
    
    .dimension-score {
        font-weight: 600;
        color: #333;
    }
    
    .evaluation-actions .btn-block {
        width: 100%;
    }
    
    .quick-stats {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
    }
    
    .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .stat-item:last-child {
        margin-bottom: 0;
    }
    
    .stat-label {
        font-size: 0.8rem;
        color: #666;
    }
    
    .stat-value {
        font-weight: 600;
        color: #333;
    }
</style>
{% endblock %}

{% block content %}
<!-- Chart.js para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/static/js/recommendations.js?v={{ get_file_version('js/recommendations.js') }}"></script>
<link rel="stylesheet" href="/static/css/unified-dashboard.css?v={{ get_file_version('css/unified-dashboard.css') }}">

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-secondary">
                <div class="card-body dashboard-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="header-info">
                            <h3 class="text-white mb-1">Dashboard Coach</h3>
                            <p class="text-muted mb-0">Bienvenido, <span id="coachName">Coach</span></p>
                        </div>
                        <div class="btn-group-mobile d-flex gap-2">
                            <button class="btn btn-outline-light btn-sm" onclick="refreshDashboard()" title="Actualizar">
                                <i class="fas fa-sync-alt me-1"></i><span class="d-none d-sm-inline">Actualizar</span>
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="window.location.href='/dashboard-selection'" title="Inicio">
                                <i class="fas fa-home me-1"></i><span class="d-none d-sm-inline">Inicio</span>
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="logoutCoach()" title="Salir">
                                <i class="fas fa-sign-out-alt me-1"></i><span class="d-none d-sm-inline">Salir</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-6 col-md-3 stats-card-mobile">
            <div class="card bg-dark border-secondary text-center">
                <div class="card-body">
                    <i class="fas fa-users fa-2x text-primary mb-3"></i>
                    <h4 class="text-white" id="totalCoachees">0</h4>
                    <p class="text-muted mb-0 small">Total Coachees</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 stats-card-mobile">
            <div class="card bg-dark border-secondary text-center">
                <div class="card-body">
                    <i class="fas fa-clipboard-check fa-2x text-success mb-3"></i>
                    <h4 class="text-white" id="completedAssessments">0</h4>
                    <p class="text-muted mb-0 small">Evaluaciones Completadas</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 stats-card-mobile">
            <div class="card bg-dark border-secondary text-center">
                <div class="card-body">
                    <i class="fas fa-hourglass-half fa-2x text-warning mb-3"></i>
                    <h4 class="text-white" id="pendingAssessments">0</h4>
                    <p class="text-muted mb-0 small">Evaluaciones Pendientes</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 stats-card-mobile">
            <div class="card bg-dark border-secondary text-center">
                <div class="card-body">
                    <i class="fas fa-chart-bar fa-2x text-info mb-3"></i>
                    <h4 class="text-white" id="avgScore">0%</h4>
                    <p class="text-muted mb-0 small">Promedio General</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Sidebar Navigation -->
        <div class="col-md-3">
            <div class="card sidebar sidebar-white sidebar-force-white" style="background: white !important; background-color: white !important; border: 1px solid #dee2e6 !important;">
                <div class="card-header sidebar-header-white sidebar-header-force" style="background: #f8f9fa !important; background-color: #f8f9fa !important; color: #333 !important; border-bottom: 1px solid #dee2e6 !important;">
                    <h6 class="mb-0 sidebar-title-white sidebar-title-force" style="color: #333 !important; font-weight: 600 !important;">
                        <i class="fas fa-tachometer-alt me-2" style="color: #333 !important;"></i>Panel de Control
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <a href="javascript:void(0)" class="list-group-item list-group-item-action border-secondary active" 
                           onclick="showModule('mis-coachees'); return false;" data-module="mis-coachees">
                            <i class="fas fa-users me-3"></i>Mis Coachees
                        </a>
                        <a href="javascript:void(0)" class="list-group-item list-group-item-action border-secondary" 
                           onclick="showModule('gestion-tareas'); return false;" data-module="gestion-tareas">
                            <i class="fas fa-tasks me-3"></i>Gestión de Tareas
                        </a>
                        <a href="javascript:void(0)" class="list-group-item list-group-item-action border-secondary" 
                           onclick="showModule('invitar-coachee'); return false;" data-module="invitar-coachee">
                            <i class="fas fa-envelope me-3"></i>Invitar Coachee
                        </a>
                        <a href="javascript:void(0)" class="list-group-item list-group-item-action border-secondary" 
                           onclick="showModule('seleccionar-evaluaciones'); return false;" data-module="seleccionar-evaluaciones">
                            <i class="fas fa-clipboard-list me-3"></i>Evaluaciones
                        </a>
                        <a href="javascript:void(0)" class="list-group-item list-group-item-action border-secondary" 
                           onclick="showModule('agregar-contenido'); return false;" data-module="agregar-contenido">
                            <i class="fas fa-plus-circle me-3"></i>Contenido
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="col-md-9">
            <!-- Mis Coachees Module -->
            <div id="mis-coachees" class="module-content">
                <div class="card sidebar-white border-secondary" style="--theme-card-bg: white !important; background-color: white !important;">
                    <div class="card-header" style="background-color: white !important; border-bottom: 1px solid #dee2e6;">
                        <h5 class="text-dark mb-0">Mis Coachees</h5>
                    </div>
                    <div class="card-body" style="background-color: white !important;">
                        <!-- Vista tabla para desktop -->
                        <div class="table-responsive d-none d-md-block">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th style="color: #212529;">Nombre</th>
                                        <th style="color: #212529;">Email</th>
                                        <th style="color: #212529;">Contraseña</th>
                                        <th style="color: #212529;">Estado</th>
                                        <th style="color: #212529;">Evaluaciones</th>
                                        <th style="color: #212529;">Último Acceso</th>
                                        <th style="color: #212529;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="coacheesTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">Cargando coachees...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Vista cards para móvil -->
                        <div class="d-block d-md-none" id="coacheesCardsContainer">
                            <div class="text-center text-muted p-3">Cargando coachees...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gestión de Tareas Module -->
            <div id="gestion-tareas" class="module-content" style="display: none;">
                <div class="card sidebar-white border-secondary" style="--theme-card-bg: white !important; background-color: white !important;">
                    <div class="card-header" style="background-color: white !important; border-bottom: 1px solid #dee2e6;">
                        <h5 class="text-dark mb-0">Gestión de Tareas</h5>
                    </div>
                    <div class="card-body" style="background-color: white !important;">
                        
                        <!-- Formulario de Creación de Tareas -->
                        <div class="card mb-4" style="border: 1px solid #e3e6f0; border-radius: 8px;">
                            <div class="card-header bg-light">
                                <h6 class="mb-0 text-dark">
                                    <i class="fas fa-plus-circle me-2"></i>Crear Nueva Tarea
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Formulario responsive -->
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label text-dark small fw-bold">Título de la Tarea</label>
                                        <input type="text" class="form-control border-secondary" 
                                               placeholder="Ingrese el título" id="taskTitle" 
                                               style="background-color: white; color: #212529;">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-dark small fw-bold">Categoría</label>
                                        <select class="form-select border-secondary" id="taskCategory" 
                                                style="background-color: white; color: #212529;">
                                            <option value="">Seleccionar categoría</option>
                                            <option value="coaching">Coaching</option>
                                            <option value="evaluacion">Evaluación</option>
                                            <option value="desarrollo">Desarrollo</option>
                                            <option value="seguimiento">Seguimiento</option>
                                            <option value="planificacion">Planificación</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-dark small fw-bold">Asignar a Coachee</label>
                                        <select class="form-select border-secondary" id="taskCoachee" 
                                                style="background-color: white; color: #212529;">
                                            <option value="">Seleccionar coachee</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-dark small fw-bold">Fecha de Vencimiento</label>
                                        <input type="date" class="form-control border-secondary" 
                                               id="taskDueDate" 
                                               style="background-color: white; color: #212529;">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label text-dark small fw-bold">Descripción</label>
                                        <textarea class="form-control border-secondary" 
                                                  placeholder="Descripción detallada de la tarea" 
                                                  id="taskDescription" rows="3" 
                                                  style="background-color: white; color: #212529;"></textarea>
                                    </div>
                                    <div class="col-12">
                                        <button class="btn btn-primary w-100" onclick="createTask()">
                                            <i class="fas fa-plus me-1"></i>Crear Tarea
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Lista de Tareas -->
                        <div class="card" style="border: 1px solid #e3e6f0; border-radius: 8px;">
                            <div class="card-header bg-light">
                                <h6 class="mb-0 text-dark">
                                    <i class="fas fa-tasks me-2"></i>Lista de Tareas
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <!-- Vista tabla para desktop -->
                                <div class="table-responsive d-none d-md-block">
                                    <table class="table table-striped mb-0">
                                        <thead>
                                            <tr>
                                                <th style="color: #212529;">Tarea</th>
                                                <th style="color: #212529;">Coachee</th>
                                                <th style="color: #212529;">Categoría</th>
                                                <th style="color: #212529;">Estado</th>
                                                <th style="color: #212529;">Vencimiento</th>
                                                <th style="color: #212529;">Creada</th>
                                                <th style="color: #212529;">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tasksTableBody">
                                            <tr>
                                                <td colspan="7" class="text-center text-muted">No hay tareas creadas</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Vista cards para móvil -->
                                <div class="d-block d-md-none p-3" id="tasksCardsContainer">
                                    <div class="text-center text-muted">No hay tareas creadas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invitar Coachee Module -->
            <div id="invitar-coachee" class="module-content" style="display: none;">
                <div class="card sidebar-white border-secondary" style="--theme-card-bg: white !important; background-color: white !important;">
                    <div class="card-header" style="background-color: white !important; border-bottom: 1px solid #dee2e6;">
                        <h5 class="text-dark mb-0">Invitar Nuevo Coachee</h5>
                        <p class="text-muted small mb-0">Invita a un coachee y asigna una evaluación inicial</p>
                    </div>
                    <div class="card-body" style="background-color: white !important;">
                        <form id="inviteForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-dark">Nombre</label>
                                    <input type="text" class="form-control border-secondary" 
                                           id="coacheeName" required style="background-color: white; color: #212529;">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-dark">Email</label>
                                    <input type="email" class="form-control border-secondary" 
                                           id="coacheeEmail" required style="background-color: white; color: #212529;">
                                </div>
                            </div>
                            
                            <!-- Sección de evaluación -->
                            <div class="mb-3">
                                <label class="form-label text-dark">
                                    <i class="fas fa-clipboard-list me-1 text-primary"></i>
                                    Evaluación a Asignar (Opcional)
                                </label>
                                <select class="form-select border-secondary" id="assignedAssessment" 
                                        style="background-color: white; color: #212529;">
                                    <option value="">Seleccionar evaluación...</option>
                                </select>
                                <div class="form-text text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Si seleccionas una evaluación, se asignará automáticamente al coachee
                                </div>
                            </div>
                            
                            <!-- Mensaje personalizado -->
                            <div class="mb-3">
                                <label class="form-label text-dark">Mensaje Personalizado (Opcional)</label>
                                <textarea class="form-control border-secondary" id="customMessage" rows="3" 
                                          style="background-color: white; color: #212529;" 
                                          placeholder="Mensaje de bienvenida para tu coachee..."></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-paper-plane me-1"></i>Enviar Invitación
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Seleccionar Evaluaciones Module -->
            <div id="seleccionar-evaluaciones" class="module-content" style="display: none;">
                <div class="card sidebar-white border-secondary" style="--theme-card-bg: white !important; background-color: white !important;">
                    <div class="card-header d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center" style="background-color: white !important; border-bottom: 1px solid #dee2e6;">
                        <div>
                            <h5 class="text-dark mb-1">
                                <i class="fas fa-clipboard-list me-2 text-primary"></i>
                                Evaluaciones Disponibles
                            </h5>
                            <p class="text-muted mb-0 small">Selecciona evaluaciones para asignar a tus coachees</p>
                        </div>
                        <!-- Botón de actualizar para móvil -->
                        <button class="btn btn-outline-primary btn-sm mt-2 mt-sm-0" onclick="loadAvailableAssessments()" title="Actualizar evaluaciones">
                            <i class="fas fa-sync-alt me-1"></i>
                            <span class="d-none d-sm-inline">Actualizar</span>
                        </button>
                    </div>
                    <div class="card-body" style="background-color: white !important; padding: 1rem;">
                        <!-- Loading spinner -->
                        <div id="assessments-loading" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando evaluaciones...</span>
                            </div>
                            <p class="text-muted small mt-2 mb-0">Cargando evaluaciones disponibles...</p>
                        </div>
                        
                        <!-- Assessments list -->
                        <div id="assessments-list" style="display: none;">
                            <!-- Assessment cards will be populated here -->
                        </div>
                        
                        <!-- Error message -->
                        <div id="assessments-error" class="alert alert-warning d-flex align-items-center" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <div>
                                <strong>Error:</strong> No se pudieron cargar las evaluaciones disponibles.
                                <br><small>Intenta actualizar la página o contacta al administrador.</small>
                            </div>
                        </div>
                        
                        <!-- No assessments message -->
                        <div id="no-assessments" class="text-center py-4" style="display: none;">
                            <div class="mb-3">
                                <i class="fas fa-clipboard-list text-muted" style="font-size: 3rem;"></i>
                            </div>
                            <h6 class="text-muted mb-2">No hay evaluaciones disponibles</h6>
                            <p class="text-muted small mb-3">Las evaluaciones aparecerán aquí cuando estén disponibles.</p>
                            <button class="btn btn-primary btn-sm" onclick="loadAvailableAssessments()">
                                <i class="fas fa-sync-alt me-1"></i>Intentar de nuevo
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agregar Contenido Module -->
            <div id="agregar-contenido" class="module-content" style="display: none;">
                <div class="card sidebar-white border-secondary" style="--theme-card-bg: white !important; background-color: white !important;">
                    <div class="card-header" style="background-color: white !important; border-bottom: 1px solid #dee2e6;">
                        <h5 class="text-dark mb-0">Agregar Contenido</h5>
                    </div>
                    <div class="card-body" style="background-color: white !important;">
                        <p class="text-muted">Módulo de contenido en desarrollo</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver evaluaciones del coachee -->
<div class="modal fade" id="coacheeEvaluationsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Evaluaciones de <span id="modalCoacheeName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="coacheeEvaluationsContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver detalles de evaluación -->
<div class="modal fade" id="evaluationDetailsModal" tabindex="-1" aria-labelledby="evaluationDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header modal-header-dark">
                <h5 class="modal-title" id="evaluationDetailsModalLabel">
                    <i class="fas fa-chart-radar me-2"></i>
                    Detalles de Evaluación
                </h5>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-light btn-sm" onclick="printEvaluationReport()" title="Imprimir Reporte">
                        <i class="fas fa-print me-1"></i>
                        Imprimir
                    </button>
                    <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal" title="Cerrar">
                        <i class="fas fa-times me-1"></i>
                        Cerrar
                    </button>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body" id="evaluationDetailsContent">
                <div class="loading-spinner">
                    <div class="spinner-border spinner-border-custom" role="status">
                        <span class="visually-hidden">Cargando detalles...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-progress" onclick="printEvaluationReport()">
                    <i class="fas fa-print me-2"></i>
                    Imprimir Reporte
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para asignar evaluación/tarea -->
<div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Asignar a <span id="assignModalCoacheeName"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Pestañas -->
                <ul class="nav nav-tabs mb-3" id="assignTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="evaluation-tab" data-bs-toggle="tab" data-bs-target="#evaluation-pane" type="button" role="tab">
                            <i class="fas fa-clipboard-check me-1"></i>Evaluación
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="task-tab" data-bs-toggle="tab" data-bs-target="#task-pane" type="button" role="tab">
                            <i class="fas fa-tasks me-1"></i>Tarea
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="assignTabContent">
                    <!-- Pestaña de Evaluación -->
                    <div class="tab-pane fade show active" id="evaluation-pane" role="tabpanel">
                        <form id="assignEvaluationForm">
                            <input type="hidden" id="targetCoacheeId" value="">
                            
                            <div class="mb-3">
                                <label for="assignAssessmentSelect" class="form-label">Seleccionar evaluación:</label>
                                <select class="form-select" id="assignAssessmentSelect" required>
                                    <option value="">Cargando evaluaciones...</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="assignEvaluationMessage" class="form-label">Mensaje personalizado (opcional):</label>
                                <textarea class="form-control" id="assignEvaluationMessage" rows="3" 
                                    placeholder="Mensaje para el coachee..."></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="assignEvaluationDueDate" class="form-label">Fecha límite (opcional):</label>
                                <input type="date" class="form-control" id="assignEvaluationDueDate">
                            </div>
                        </form>
                    </div>

                    <!-- Pestaña de Tarea -->
                    <div class="tab-pane fade" id="task-pane" role="tabpanel">
                        <form id="assignTaskForm">
                            <div class="mb-3">
                                <label for="assignTaskTitle" class="form-label">Título de la tarea:</label>
                                <input type="text" class="form-control" id="assignTaskTitle" required
                                    placeholder="Ej: Completar ejercicio de reflexión">
                            </div>
                            
                            <div class="mb-3">
                                <label for="assignTaskDescription" class="form-label">Descripción:</label>
                                <textarea class="form-control" id="assignTaskDescription" rows="4" required
                                    placeholder="Describe la tarea que debe realizar el coachee..."></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="assignTaskCategory" class="form-label">Categoría:</label>
                                <select class="form-select" id="assignTaskCategory" required>
                                    <option value="">Seleccionar categoría</option>
                                    <option value="evaluation">Evaluación</option>
                                    <option value="coaching">Coaching</option>
                                    <option value="development">Desarrollo</option>
                                    <option value="feedback">Feedback</option>
                                    <option value="reflection">Reflexión</option>
                                    <option value="goal">Objetivo</option>
                                    <option value="other">Otro</option>
                                </select>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="assignTaskPriority" class="form-label">Prioridad:</label>
                                    <select class="form-select" id="assignTaskPriority">
                                        <option value="medium">Media</option>
                                        <option value="high">Alta</option>
                                        <option value="low">Baja</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="assignTaskDueDate" class="form-label">Fecha límite (opcional):</label>
                                    <input type="date" class="form-control" id="assignTaskDueDate">
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="executeAssignment()">
                    <i class="fas fa-paper-plane me-1"></i>Asignar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para mostrar evaluaciones asignadas -->
<div class="modal fade" id="assignedAssessmentsModal" tabindex="-1" aria-labelledby="assignedAssessmentsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="assignedAssessmentsModalLabel">
                    <i class="fas fa-clipboard-list me-2"></i>Evaluaciones Asignadas
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="assignedAssessmentsContent">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin fa-2x text-info"></i>
                        <p class="mt-2">Cargando evaluaciones asignadas...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let coacheesData = [];
let tasksData = [];

// Función para mostrar módulos
function showModule(moduleId) {
    // Prevenir scroll automático
    if (event) {
        event.preventDefault();
    }
    
    // Ocultar todos los módulos
    document.querySelectorAll('.module-content').forEach(module => {
        module.style.display = 'none';
    });
    
    // Remover clase active de todos los enlaces
    document.querySelectorAll('[data-module]').forEach(link => {
        link.classList.remove('active');
    });
    
    // Mostrar módulo seleccionado
    const selectedModule = document.getElementById(moduleId);
    if (selectedModule) {
        selectedModule.style.display = 'block';
        
        // En móviles, hacer scroll suave hacia el contenido
        if (window.innerWidth <= 768) {
            setTimeout(() => {
                selectedModule.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start',
                    inline: 'nearest'
                });
            }, 100);
        }
    }
    
    // Agregar clase active al enlace seleccionado
    const selectedLink = document.querySelector(`[data-module="${moduleId}"]`);
    if (selectedLink) {
        selectedLink.classList.add('active');
    }
    
    // Cargar datos específicos del módulo si es necesario
    if (moduleId === 'mis-coachees') {
        loadCoachees();
    } else if (moduleId === 'gestion-tareas') {
        loadTasks();
    } else if (moduleId === 'seleccionar-evaluaciones') {
        loadAvailableAssessments();
    } else if (moduleId === 'invitar-coachee') {
        loadAssessmentsForInvitation();
    }
    
    return false; // Prevenir comportamiento por defecto
}

// Función para refrescar dashboard
function refreshDashboard() {
    loadCoachees();
    loadTasks();
    loadStats();
}

// Función de logout específica para coach
async function logoutCoach() {
    try {
        const response = await fetch('/api/coach/logout', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            console.log('Coach logout successful');
        } else {
            console.error('Coach logout failed');
        }
        
        // Redirigir a la página de selección independientemente del resultado
        window.location.href = '/dashboard-selection';
        
    } catch (error) {
        console.error('Error during coach logout:', error);
        // Aún así redirigir en caso de error
        window.location.href = '/dashboard-selection';
    }
}

// Función para cargar estadísticas
function loadStats() {
    console.log('🔄 STATS: Starting to load stats...');
    
    // Verificar que los elementos del DOM existan
    const elements = {
        totalCoachees: document.getElementById('totalCoachees'),
        completedAssessments: document.getElementById('completedAssessments'),
        pendingAssessments: document.getElementById('pendingAssessments'),
        avgScore: document.getElementById('avgScore'),
        coachName: document.getElementById('coachName')
    };
    
    console.log('🔍 STATS: DOM elements check:', elements);
    
    // Verificar elementos faltantes
    const missingElements = Object.keys(elements).filter(key => !elements[key]);
    if (missingElements.length > 0) {
        console.error('❌ STATS: Missing DOM elements:', missingElements);
    }
    
    fetch('/api/coach/profile')
        .then(response => response.json())
        .then(data => {
            console.log('👤 PROFILE: Received profile data:', data);
            if (data.success && elements.coachName) {
                elements.coachName.textContent = data.coach.name || 'Coach';
            }
        })
        .catch(error => console.error('❌ PROFILE: Error loading coach profile:', error));
    
    // Cargar estadísticas generales
    fetch('/api/coach/my-coachees')
        .then(response => response.json())
        .then(data => {
            console.log('📊 STATS: Received data:', data); // Debug log
            
            if (data.success) {
                // Actualizar total de coachees
                if (elements.totalCoachees) {
                    elements.totalCoachees.textContent = data.coachees.length;
                }
                
                let totalEvaluations = 0;
                let totalScore = 0;
                let evaluationsWithScore = 0;
                
                // Calcular estadísticas basado en la nueva estructura
                data.coachees.forEach(coachee => {
                    console.log(`👤 STATS: Processing coachee ${coachee.name}:`, coachee); // Debug log
                    
                    // Contar evaluaciones completadas
                    if (coachee.evaluations_count) {
                        totalEvaluations += coachee.evaluations_count;
                    }
                    
                    // Sumar scores para promedio
                    if (coachee.avg_score) {
                        totalScore += coachee.avg_score * coachee.evaluations_count;
                        evaluationsWithScore += coachee.evaluations_count;
                    }
                });
                
                // Actualizar las tarjetas de estadísticas
                if (elements.completedAssessments) {
                    elements.completedAssessments.textContent = totalEvaluations;
                }
                if (elements.pendingAssessments) {
                    elements.pendingAssessments.textContent = 0; // TODO: Implementar lógica de pendientes
                }
                
                // Calcular promedio general
                const avgScore = evaluationsWithScore > 0 ? Math.round(totalScore / evaluationsWithScore) : 0;
                if (elements.avgScore) {
                    elements.avgScore.textContent = avgScore + '%';
                }
                
                console.log(`📊 STATS: Updated - Coachees: ${data.coachees.length}, Completed: ${totalEvaluations}, Avg: ${avgScore}%`);
            }
        })
        .catch(error => {
            console.error('❌ STATS: Error loading stats:', error);
            // Mostrar valores por defecto en caso de error
            if (elements.totalCoachees) elements.totalCoachees.textContent = '0';
            if (elements.completedAssessments) elements.completedAssessments.textContent = '0';
            if (elements.pendingAssessments) elements.pendingAssessments.textContent = '0';
            if (elements.avgScore) elements.avgScore.textContent = '0%';
        });
}

// Función para cargar evaluaciones disponibles
function loadAvailableAssessments() {
    const loadingElement = document.getElementById('assessments-loading');
    const listElement = document.getElementById('assessments-list');
    const errorElement = document.getElementById('assessments-error');
    const noAssessmentsElement = document.getElementById('no-assessments');
    
    // Mostrar loading y ocultar otros elementos
    loadingElement.style.display = 'block';
    listElement.style.display = 'none';
    errorElement.style.display = 'none';
    noAssessmentsElement.style.display = 'none';
    
    fetch('/api/coach/available-assessments')
        .then(response => response.json())
        .then(data => {
            loadingElement.style.display = 'none';
            
            if (data.success && data.assessments && data.assessments.length > 0) {
                displayAvailableAssessments(data.assessments);
                listElement.style.display = 'block';
            } else {
                noAssessmentsElement.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading assessments:', error);
            loadingElement.style.display = 'none';
            errorElement.style.display = 'block';
        });
}

// Función para mostrar evaluaciones disponibles
function displayAvailableAssessments(assessments) {
    const container = document.getElementById('assessments-list');
    container.innerHTML = '';
    
    if (assessments.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-search text-muted mb-3" style="font-size: 2rem;"></i>
                <h6 class="text-muted">No se encontraron evaluaciones</h6>
                <p class="text-muted small">No hay evaluaciones disponibles en este momento.</p>
            </div>
        `;
        return;
    }
    
    assessments.forEach((assessment, index) => {
        const card = document.createElement('div');
        card.className = 'assessment-card';
        card.setAttribute('data-assessment-id', assessment.id);
        
        // Agregar animación de entrada escalonada
        card.style.animationDelay = `${index * 0.1}s`;
        
        const createdDate = assessment.created_at ? 
            new Date(assessment.created_at).toLocaleDateString('es-ES', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            }) : 'No disponible';
        
        // Determinar color del badge basado en estadísticas
        const badgeClass = assessment.completed_count > 0 ? 'success' : 'primary';
        const badgeIcon = assessment.completed_count > 0 ? 'check-circle' : 'clipboard-list';
        
        card.innerHTML = `
            <div class="assessment-header">
                <h6 class="assessment-title">${assessment.title}</h6>
                <span class="assessment-badge bg-${badgeClass}">
                    <i class="fas fa-${badgeIcon} me-1"></i>
                    ${assessment.completed_count > 0 ? 'Activa' : 'Nueva'}
                </span>
            </div>
            
            <p class="assessment-description">
                ${assessment.description || 'Sin descripción disponible'}
            </p>
            
            <div class="assessment-stats">
                <div class="assessment-stat">
                    <i class="fas fa-question-circle"></i>
                    <span>${assessment.questions_count} ${assessment.questions_count === 1 ? 'pregunta' : 'preguntas'}</span>
                </div>
                <div class="assessment-stat">
                    <i class="fas fa-users"></i>
                    <span>${assessment.completed_count} ${assessment.completed_count === 1 ? 'completada' : 'completadas'}</span>
                </div>
                <div class="assessment-stat">
                    <i class="fas fa-calendar-plus"></i>
                    <span class="d-none d-sm-inline">Creada: </span>${createdDate}</span>
                </div>
            </div>
            
            <!-- Botones de acción -->
            <div class="assessment-actions mt-2">
                <!-- Botón de asignación -->
                <button class="btn btn-outline-success btn-sm w-100" onclick="event.stopPropagation(); openAssignModalFromEvaluation(${assessment.id}, '${assessment.title}')">
                    <i class="fas fa-user-plus me-1"></i>Asignar a Coachee
                </button>
            </div>
        `;
        
        container.appendChild(card);
    });
    
    // Agregar mensaje informativo al final
    const infoMessage = document.createElement('div');
    infoMessage.className = 'alert alert-info mt-3';
    infoMessage.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-info-circle me-2"></i>
            <div>
                <strong>${assessments.length} ${assessments.length === 1 ? 'evaluación disponible' : 'evaluaciones disponibles'}</strong>
                <br><small>Usa el botón "Asignar a Coachee" para asignar evaluaciones a tus coachees.</small>
            </div>
        </div>
    `;
    container.appendChild(infoMessage);
}

// Función para seleccionar una evaluación
function selectAssessment(assessmentId) {
    // Añadir feedback visual inmediato
    const allCards = document.querySelectorAll('.assessment-card');
    const selectedCard = document.querySelector(`[data-assessment-id="${assessmentId}"]`);
    
    // Remover selección previa
    allCards.forEach(card => {
        card.classList.remove('selected');
        card.style.transform = '';
    });
    
    // Añadir selección actual con animación
    if (selectedCard) {
        selectedCard.classList.add('selected');
        
        // Efecto de pulso para feedback táctil en móvil
        selectedCard.style.transform = 'scale(0.98)';
        setTimeout(() => {
            selectedCard.style.transform = 'scale(1)';
        }, 150);
        
        // Añadir indicador visual de selección
        const existingCheck = selectedCard.querySelector('.selection-indicator');
        if (existingCheck) {
            existingCheck.remove();
        }
        
        const selectionIndicator = document.createElement('div');
        selectionIndicator.className = 'selection-indicator';
        selectionIndicator.innerHTML = '<i class="fas fa-check-circle"></i>';
        selectedCard.appendChild(selectionIndicator);
    }
    
    // Mostrar modal de confirmación optimizado para móvil
    const assessmentCard = selectedCard;
    const assessmentTitle = assessmentCard.querySelector('.assessment-title').textContent;
    const assessmentDescription = assessmentCard.querySelector('.assessment-description').textContent;
    
    // Crear modal responsive
    const modalHtml = `
        <div class="modal fade" id="confirmAssessmentModal" tabindex="-1" aria-labelledby="confirmAssessmentModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="confirmAssessmentModalLabel">
                            <i class="fas fa-clipboard-check me-2"></i>Confirmar Evaluación
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-3">
                            <div class="assessment-preview-card">
                                <h6 class="fw-bold text-primary">${assessmentTitle}</h6>
                                <p class="text-muted small mb-0">${assessmentDescription}</p>
                            </div>
                        </div>
                        
                        <div class="alert alert-info d-flex align-items-start">
                            <i class="fas fa-info-circle me-2 mt-1"></i>
                            <div>
                                <strong>¿Deseas asignar esta evaluación?</strong>
                                <br><small>Podrás enviarla a tus coachees para que la completen.</small>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer flex-column flex-sm-row">
                        <button type="button" class="btn btn-outline-secondary mb-2 mb-sm-0 w-100 w-sm-auto" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </button>
                        <button type="button" class="btn btn-primary w-100 w-sm-auto" onclick="confirmAssignAssessment(${assessmentId})">
                            <i class="fas fa-paper-plane me-1"></i>Asignar Evaluación
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal previo si existe
    const existingModal = document.getElementById('confirmAssessmentModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Añadir nuevo modal al DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Mostrar modal con mejor experiencia móvil
    const modal = new bootstrap.Modal(document.getElementById('confirmAssessmentModal'), {
        backdrop: 'static',
        keyboard: true
    });
    
    modal.show();
    
    // Limpiar modal cuando se cierre
    document.getElementById('confirmAssessmentModal').addEventListener('hidden.bs.modal', function () {
        this.remove();
        // Remover selección visual
        if (selectedCard) {
            selectedCard.classList.remove('selected');
            const indicator = selectedCard.querySelector('.selection-indicator');
            if (indicator) {
                indicator.remove();
            }
        }
    });
}

// Función para confirmar la asignación de evaluación
function confirmAssignAssessment(assessmentId) {
    // Cerrar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('confirmAssessmentModal'));
    if (modal) {
        modal.hide();
    }
    
    // Mostrar notificación de éxito con mejor UX móvil
    showNotification('Evaluación asignada exitosamente', 'success');
    
    // Opcional: Aquí se puede agregar lógica para realizar la asignación real
    console.log('Evaluación confirmada:', assessmentId);
    
    // Feedback visual adicional
    setTimeout(() => {
        // Limpiar selecciones
        document.querySelectorAll('.assessment-card').forEach(card => {
            card.classList.remove('selected');
            const indicator = card.querySelector('.selection-indicator');
            if (indicator) {
                indicator.remove();
            }
        });
    }, 1000);
}

// Función para cargar evaluaciones en el selector del formulario de invitación
function loadAssessmentsForInvitation() {
    const selector = document.getElementById('assignedAssessment');
    if (!selector) return;
    
    // Limpiar opciones existentes (excepto la primera)
    while (selector.children.length > 1) {
        selector.removeChild(selector.lastChild);
    }
    
    fetch('/api/coach/available-assessments')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.assessments && data.assessments.length > 0) {
                data.assessments.forEach(assessment => {
                    const option = document.createElement('option');
                    option.value = assessment.id;
                    option.textContent = `${assessment.title} (${assessment.questions_count} preguntas)`;
                    selector.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading assessments for invitation:', error);
        });
}

// Función para cargar coachees
function loadCoachees() {
    fetch('/api/coach/my-coachees')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                coacheesData = data.coachees;
                displayCoachees();
                updateCoacheeSelect();
            }
        })
        .catch(error => {
            console.error('Error loading coachees:', error);
            document.getElementById('coacheesTableBody').innerHTML = 
                '<tr><td colspan="7" class="text-center text-danger">Error al cargar coachees</td></tr>';
            document.getElementById('coacheesCardsContainer').innerHTML = 
                '<div class="text-center text-danger p-3">Error al cargar coachees</div>';
        });
}

// Función para mostrar coachees en la tabla y cards móviles
function displayCoachees() {
    const tbody = document.getElementById('coacheesTableBody');
    const cardsContainer = document.getElementById('coacheesCardsContainer');
    
    if (coacheesData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No hay coachees asignados</td></tr>';
        cardsContainer.innerHTML = '<div class="unified-empty-state"><i class="fas fa-users"></i><p>No hay coachees asignados</p></div>';
        return;
    }
    
    // Vista tabla para desktop
    tbody.innerHTML = coacheesData.map(coachee => `
        <tr>
            <td>${coachee.name || 'Sin nombre'}</td>
            <td>${coachee.email || 'Sin email'}</td>
            <td>
                ${coachee.password ? `
                    <div class="d-flex align-items-center">
                        <span class="password-text" id="pwd-${coachee.id}" style="font-family: monospace; min-width: 70px;">●●●●●●●●</span>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="togglePassword(${coachee.id}, '${coachee.password}')" title="Mostrar/Ocultar contraseña">
                            <i class="fas fa-eye" id="eye-${coachee.id}"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary ms-1" onclick="copyPassword('${coachee.password}')" title="Copiar contraseña">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                ` : '<span class="text-muted">-</span>'}
            </td>
            <td>
                <span class="unified-badge ${coachee.is_active ? 'unified-badge-success' : 'unified-badge-secondary'}">
                    ${coachee.is_active ? 'Activo' : 'Inactivo'}
                </span>
            </td>
            <td>
                <div class="d-flex align-items-center gap-2">
                    <span class="unified-badge unified-badge-info">${coachee.evaluations_count || 0}</span>
                    ${coachee.avg_score ? `<small class="text-muted">Prom: ${Math.round(coachee.avg_score)}%</small>` : ''}
                    <button class="btn btn-sm btn-outline-info" onclick="showAssignedAssessments(${coachee.id}, '${coachee.name}')" title="Ver todas las evaluaciones">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </td>
            <td>${coachee.last_evaluation ? new Date(coachee.last_evaluation.completed_at).toLocaleDateString() : 'Nunca'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewCoacheeDetails(${coachee.id})" title="Ver detalles">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="editCoachee(${coachee.id})" title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="showAssignModal(${coachee.id}, '${coachee.name}')" title="Asignar evaluación/tarea">
                    <i class="fas fa-plus"></i>
                </button>
            </td>
        </tr>
    `).join('');
    
    // Vista cards para móvil - mejorada con estilos unificados
    cardsContainer.innerHTML = `
        <div class="results-list">
            ${coacheesData.map(coachee => `
                <div class="unified-card">
                    <div class="unified-card-header">
                        <div class="d-flex justify-content-between align-items-start w-100">
                            <h5 class="unified-card-title">${coachee.name || 'Sin nombre'}</h5>
                            <span class="unified-badge ${coachee.is_active ? 'unified-badge-success' : 'unified-badge-secondary'}">
                                ${coachee.is_active ? 'Activo' : 'Inactivo'}
                            </span>
                        </div>
                    </div>
                    <div class="unified-card-body">
                        <div class="coachee-details">
                            <div class="meta-item">
                                <i class="fas fa-envelope"></i>
                                <span>${coachee.email || 'Sin email'}</span>
                            </div>
                            ${coachee.password ? `
                            <div class="meta-item">
                                <i class="fas fa-key"></i>
                                <div class="d-flex align-items-center">
                                    <span class="password-text" id="pwd-mobile-${coachee.id}" style="font-family: monospace;">●●●●●●●●</span>
                                    <button class="unified-btn unified-btn-sm unified-btn-secondary ms-2" onclick="togglePasswordMobile(${coachee.id}, '${coachee.password}')" title="Mostrar/Ocultar">
                                        <i class="fas fa-eye" id="eye-mobile-${coachee.id}"></i>
                                    </button>
                                    <button class="unified-btn unified-btn-sm unified-btn-primary ms-1" onclick="copyPassword('${coachee.password}')" title="Copiar">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                            ` : ''}
                            <div class="meta-item">
                                <i class="fas fa-chart-line"></i>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="unified-badge unified-badge-info">${coachee.evaluations_count || 0} evaluaciones</span>
                                    ${coachee.avg_score ? `<span class="text-muted">Promedio: ${Math.round(coachee.avg_score)}%</span>` : ''}
                                </div>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-calendar-alt"></i>
                                <span>Última evaluación: ${coachee.last_evaluation ? new Date(coachee.last_evaluation.completed_at).toLocaleDateString() : 'Nunca'}</span>
                            </div>
                        </div>
                    </div>
                    <div class="unified-card-footer">
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="unified-btn unified-btn-primary unified-btn-sm" onclick="viewCoacheeDetails(${coachee.id})" title="Ver detalles">
                                <i class="fas fa-eye"></i>
                                Detalles
                            </button>
                            <button class="unified-btn unified-btn-secondary unified-btn-sm" onclick="editCoachee(${coachee.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                                Editar
                            </button>
                            <button class="unified-btn unified-btn-success unified-btn-sm" onclick="showAssignModal(${coachee.id}, '${coachee.name}')" title="Asignar">
                                <i class="fas fa-plus"></i>
                                Asignar
                            </button>
                            <button class="unified-btn unified-btn-info unified-btn-sm" onclick="showAssignedAssessments(${coachee.id}, '${coachee.name}')" title="Ver evaluaciones">
                                <i class="fas fa-list"></i>
                                Evaluaciones
                            </button>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// Función para actualizar select de coachees en tareas
function updateCoacheeSelect() {
    const select = document.getElementById('taskCoachee');
    select.innerHTML = '<option value="">Seleccionar coachee</option>' +
        coacheesData.map(coachee => `<option value="${coachee.id}">${coachee.name}</option>`).join('');
}

// Función para cargar tareas
function loadTasks() {
    fetch('/api/coach/tasks')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                tasksData = data.tasks;
                displayTasks();
            }
        })
        .catch(error => {
            console.error('Error loading tasks:', error);
            document.getElementById('tasksTableBody').innerHTML = 
                '<tr><td colspan="5" class="text-center text-danger">Error al cargar tareas</td></tr>';
        });
}

// Función para mostrar tareas
function displayTasks() {
    const tableBody = document.getElementById('tasksTableBody');
    const cardsContainer = document.getElementById('tasksCardsContainer');
    
    if (tasksData.length === 0) {
        // Vista tabla vacia
        tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No hay tareas creadas</td></tr>';
        // Vista cards vacia
        cardsContainer.innerHTML = '<div class="text-center text-muted">No hay tareas creadas</div>';
        return;
    }

    // Limpiar contenedores
    tableBody.innerHTML = '';
    cardsContainer.innerHTML = '';

    tasksData.forEach(task => {
        const fechaCreated = new Date(task.created_at).toLocaleDateString('es-ES');
        const coacheeName = task.coachee_name || 'No asignado';
        
        // Formatear fecha de vencimiento
        let fechaVencimiento = 'Sin fecha';
        let vencimientoClass = '';
        if (task.due_date) {
            const dueDate = new Date(task.due_date);
            const today = new Date();
            const diffTime = dueDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            fechaVencimiento = dueDate.toLocaleDateString('es-ES');
            
            if (diffDays < 0) {
                vencimientoClass = 'text-danger fw-bold'; // Vencida
                fechaVencimiento += ' <small>(Vencida)</small>';
            } else if (diffDays <= 3) {
                vencimientoClass = 'text-warning fw-bold'; // Próxima a vencer
                fechaVencimiento += ` <small>(${diffDays} días)</small>`;
            } else {
                vencimientoClass = 'text-success'; // A tiempo
            }
        }
        
        // Determinar el estado visual
        let estadoBadge = '';
        if (task.completed) {
            estadoBadge = '<span class="badge bg-success">Completada</span>';
        } else {
            estadoBadge = '<span class="badge bg-warning text-dark">Pendiente</span>';
        }

        // Crear fila para tabla (desktop)
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div class="fw-bold text-dark">${task.title}</div>
                <small class="text-muted">${task.description || 'Sin descripción'}</small>
            </td>
            <td class="text-dark">${coacheeName}</td>
            <td>
                <span class="badge bg-light text-dark border">${task.category || 'Sin categoría'}</span>
            </td>
            <td>${estadoBadge}</td>
            <td class="${vencimientoClass}">${fechaVencimiento}</td>
            <td class="text-dark">${fechaCreated}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary btn-sm" onclick="editTask(${task.id})" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteTask(${task.id})" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tableBody.appendChild(row);

        // Crear card para móvil
        const card = document.createElement('div');
        card.className = 'card mb-3 border-light shadow-sm';
        card.innerHTML = `
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-title mb-1 text-dark fw-bold">${task.title}</h6>
                    ${estadoBadge}
                </div>
                
                <p class="card-text text-muted small mb-3">${task.description || 'Sin descripción'}</p>
                
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-user text-primary me-2"></i>
                            <div>
                                <div class="small text-muted">Coachee</div>
                                <div class="fw-medium text-dark small">${coacheeName}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-tag text-info me-2"></i>
                            <div>
                                <div class="small text-muted">Categoría</div>
                                <div class="fw-medium text-dark small">${task.category || 'Sin categoría'}</div>
                            </div>
                        </div>
                    </div>
                    ${task.due_date ? `
                    <div class="col-12">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-clock text-warning me-2"></i>
                            <div>
                                <div class="small text-muted">Vencimiento</div>
                                <div class="fw-medium small ${vencimientoClass}">${fechaVencimiento}</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        <i class="fas fa-calendar me-1"></i>Creada: ${fechaCreated}
                    </small>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary btn-sm" onclick="editTask(${task.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteTask(${task.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        cardsContainer.appendChild(card);
    });
}

// Función para crear tarea
function createTask() {
    const title = document.getElementById('taskTitle').value.trim();
    const description = document.getElementById('taskDescription').value.trim();
    const category = document.getElementById('taskCategory').value;
    const coacheeId = document.getElementById('taskCoachee').value;
    const dueDate = document.getElementById('taskDueDate').value;
    
    if (!title) {
        alert('Por favor ingrese un título para la tarea');
        return;
    }
    
    if (!description) {
        alert('Por favor ingrese una descripción para la tarea');
        return;
    }
    
    if (!category) {
        alert('Por favor seleccione una categoría para la tarea');
        return;
    }
    
    if (!coacheeId) {
        alert('Por favor seleccione un coachee');
        return;
    }
    
    const taskData = {
        title: title,
        description: description,
        category: category,
        coachee_id: parseInt(coacheeId)
    };
    
    // Agregar fecha de vencimiento solo si se especifica
    if (dueDate) {
        taskData.due_date = dueDate;
    }
    
    fetch('/api/coach/tasks', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(taskData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('taskCategory').value = '';
            document.getElementById('taskCoachee').value = '';
            document.getElementById('taskDueDate').value = '';
            loadTasks();
            alert('Tarea creada exitosamente');
        } else {
            alert('Error al crear la tarea: ' + (data.message || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error creating task:', error);
        alert('Error al crear la tarea');
    });
}

// Función para eliminar tarea
function deleteTask(taskId) {
    if (confirm('¿Está seguro de que desea eliminar esta tarea?')) {
        fetch(`/api/coach/tasks/${taskId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Tarea eliminada exitosamente');
                loadTasks(); // Recargar la lista de tareas
            } else {
                alert('Error al eliminar la tarea: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error deleting task:', error);
            alert('Error al eliminar la tarea');
        });
    }
}

// Función para editar tarea
function editTask(taskId) {
    const task = tasksData.find(t => t.id === taskId);
    if (!task) {
        alert('Tarea no encontrada');
        return;
    }
    
    // Llenar el formulario con los datos de la tarea
    document.getElementById('taskTitle').value = task.title;
    document.getElementById('taskDescription').value = task.description || '';
    document.getElementById('taskCategory').value = task.category || '';
    document.getElementById('taskCoachee').value = task.coachee_id || '';
    
    // Llenar fecha de vencimiento si existe
    if (task.due_date) {
        document.getElementById('taskDueDate').value = task.due_date;
    } else {
        document.getElementById('taskDueDate').value = '';
    }
    
    // Cambiar el botón de crear por actualizar
    const createButton = document.querySelector('#gestion-tareas button[onclick="createTask()"]');
    createButton.innerHTML = '<i class="fas fa-save me-1"></i>Actualizar Tarea';
    createButton.onclick = function() { updateTask(taskId); };
    
    // Agregar botón de cancelar
    const cancelButton = document.createElement('button');
    cancelButton.className = 'btn btn-secondary ms-2';
    cancelButton.innerHTML = '<i class="fas fa-times me-1"></i>Cancelar';
    cancelButton.onclick = cancelEdit;
    createButton.parentNode.appendChild(cancelButton);
    
    // Scroll al formulario
    document.getElementById('gestion-tareas').scrollIntoView({ behavior: 'smooth' });
}

// Función para actualizar tarea
function updateTask(taskId) {
    const title = document.getElementById('taskTitle').value.trim();
    const description = document.getElementById('taskDescription').value.trim();
    const category = document.getElementById('taskCategory').value;
    const coacheeId = document.getElementById('taskCoachee').value;
    const dueDate = document.getElementById('taskDueDate').value;
    
    if (!title) {
        alert('Por favor ingrese un título para la tarea');
        return;
    }
    
    const taskData = {
        title: title,
        description: description,
        category: category,
        coachee_id: coacheeId || null,
        due_date: dueDate || null
    };
    
    fetch(`/api/coach/tasks/${taskId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(taskData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Tarea actualizada exitosamente');
            cancelEdit(); // Resetear formulario
            loadTasks(); // Recargar la lista de tareas
        } else {
            alert('Error al actualizar la tarea: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error updating task:', error);
        alert('Error al actualizar la tarea');
    });
}

// Función para cancelar edición
function cancelEdit() {
    // Limpiar formulario
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskDescription').value = '';
    document.getElementById('taskCategory').value = '';
    document.getElementById('taskCoachee').value = '';
    document.getElementById('taskDueDate').value = '';
    
    // Restaurar botón de crear
    const updateButton = document.querySelector('#gestion-tareas button[onclick*="updateTask"]');
    if (updateButton) {
        updateButton.innerHTML = '<i class="fas fa-plus me-1"></i>Crear Tarea';
        updateButton.onclick = createTask;
        
        // Remover botón cancelar
        const cancelButton = updateButton.parentNode.querySelector('.btn-secondary');
        if (cancelButton) {
            cancelButton.remove();
        }
    }
}

// Función para ver detalles del coachee
function viewCoacheeDetails(coacheeId) {
    const coachee = coacheesData.find(c => c.id === coacheeId);
    if (!coachee) {
        alert('Coachee no encontrado');
        return;
    }
    
    document.getElementById('modalCoacheeName').textContent = coachee.name;
    document.getElementById('coacheeEvaluationsContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Cargando evaluaciones...</span>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('coacheeEvaluationsModal'));
    modal.show();
    
    // Cargar evaluaciones del coachee
    fetch(`/api/coach/coachee-evaluations/${coacheeId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.evaluations) {
                // Procesar evaluaciones para agregar campos necesarios
                const processedEvaluations = data.evaluations.map(evaluation => {
                    // Calcular porcentaje basado en el score
                    const percentage = evaluation.score || 0;
                    
                    return {
                        ...evaluation,
                        percentage: percentage,
                        level: getAssertiveLevelFromScore(percentage),
                        interpretation: evaluation.result_text || ''
                    };
                });
                
                displayCoacheeEvaluations(processedEvaluations);
            } else {
                document.getElementById('coacheeEvaluationsContent').innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Este coachee no tiene evaluaciones completadas.
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading coachee evaluations:', error);
            document.getElementById('coacheeEvaluationsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error al cargar las evaluaciones.
                </div>
            `;
        });
}

// Función para mostrar evaluaciones del coachee
function displayCoacheeEvaluations(evaluations) {
    if (!evaluations || evaluations.length === 0) {
        document.getElementById('coacheeEvaluationsContent').innerHTML = `
            <div class="alert alert-info border-0" style="background: #f8f9fa; border-left: 4px solid #17a2b8 !important;">
                <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle me-3" style="font-size: 1.5rem; color: #17a2b8;"></i>
                    <div>
                        <h6 class="mb-0">No hay evaluaciones disponibles</h6>
                        <small class="text-muted">Este coachee aún no ha completado ninguna evaluación.</small>
                    </div>
                </div>
            </div>
        `;
        return;
    }

    // Header con estadísticas
    const totalEvaluations = evaluations.length;
    const avgScore = evaluations.reduce((sum, eval) => sum + (eval.percentage || 0), 0) / totalEvaluations;
    const lastEvaluation = evaluations.sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at))[0];

    let html = `
        <div class="evaluations-summary mb-4">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="summary-card">
                        <div class="summary-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-number">${totalEvaluations}</div>
                            <div class="summary-label">Evaluaciones</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="summary-card">
                        <div class="summary-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-number">${Math.round(avgScore)}%</div>
                            <div class="summary-label">Promedio</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="summary-card">
                        <div class="summary-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-number">${formatDateShort(lastEvaluation.completed_at)}</div>
                            <div class="summary-label">Última evaluación</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="evaluations-list">
            <div class="list-header mb-3">
                <h6 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    Historial de Evaluaciones
                </h6>
            </div>
    `;

    // Ordenar evaluaciones por fecha (más reciente primero)
    const sortedEvaluations = evaluations.sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at));

    sortedEvaluations.forEach((evaluation, index) => {
        const scoreColor = getScoreColor(evaluation.percentage);
        const levelBadge = getLevelBadge(evaluation.level, evaluation.percentage);
        const isRecent = index === 0; // Marcar la más reciente

        html += `
            <div class="evaluation-card ${isRecent ? 'recent-evaluation' : ''}" data-evaluation-id="${evaluation.id}">
                ${isRecent ? '<div class="recent-badge">Más reciente</div>' : ''}
                
                <div class="evaluation-header">
                    <div class="d-flex align-items-start justify-content-between">
                        <div class="evaluation-info flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <div class="evaluation-icon me-3">
                                    <i class="fas fa-clipboard-check"></i>
                                </div>
                                <div>
                                    <h6 class="evaluation-title mb-1">
                                        ${evaluation.assessment_title || 'Evaluación de Asertividad'}
                                    </h6>
                                    <div class="evaluation-meta">
                                        <span class="meta-item">
                                            <i class="fas fa-calendar-alt me-1"></i>
                                            ${formatDateLong(evaluation.completed_at)}
                                        </span>
                                        <span class="meta-item">
                                            <i class="fas fa-clock me-1"></i>
                                            ${getTimeAgo(evaluation.completed_at)}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="evaluation-score-section text-end">
                            <div class="score-display ${scoreColor}">
                                <div class="score-number">${evaluation.percentage || 0}%</div>
                                <div class="score-label">Puntuación</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="evaluation-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            ${evaluation.interpretation ? `
                                <div class="interpretation-section">
                                    <h6 class="section-title">
                                        <i class="fas fa-lightbulb me-2"></i>
                                        Interpretación
                                    </h6>
                                    <p class="interpretation-text">${evaluation.interpretation}</p>
                                </div>
                            ` : ''}
                            
                            ${evaluation.dimensional_scores && Object.keys(evaluation.dimensional_scores).length > 0 ? `
                                <div class="dimensions-preview">
                                    <h6 class="section-title">
                                        <i class="fas fa-chart-radar me-2"></i>
                                        Dimensiones Evaluadas
                                    </h6>
                                    <div class="dimensions-grid">
                                        ${generateDimensionsPreview(evaluation.dimensional_scores)}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="col-md-4">
                            <div class="evaluation-actions">
                                <button class="btn btn-primary btn-block mb-2" 
                                        onclick="viewEvaluationDetails(${evaluation.id})"
                                        title="Ver análisis completo de la evaluación">
                                    <i class="fas fa-eye me-2"></i>
                                    Ver Análisis Completo
                                </button>
                                
                                <div class="quick-stats">
                                    <div class="stat-item">
                                        <span class="stat-label">ID Evaluación:</span>
                                        <span class="stat-value">#${evaluation.id}</span>
                                    </div>
                                    ${evaluation.total_questions ? `
                                        <div class="stat-item">
                                            <span class="stat-label">Preguntas:</span>
                                            <span class="stat-value">${evaluation.total_questions}</span>
                                        </div>
                                    ` : ''}
                                    <div class="stat-item">
                                        <span class="stat-label">Estado:</span>
                                        <span class="badge bg-success">Completada</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    
    document.getElementById('coacheeEvaluationsContent').innerHTML = html;
}

// Funciones auxiliares para displayCoacheeEvaluations
function formatDateShort(dateString) {
    return new Date(dateString).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
}

function formatDateLong(dateString) {
    return new Date(dateString).toLocaleDateString('es-ES', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
}

function getTimeAgo(dateString) {
    const now = new Date();
    const date = new Date(dateString);
    const diffInDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
    
    if (diffInDays === 0) return 'Hoy';
    if (diffInDays === 1) return 'Ayer';
    if (diffInDays < 7) return `Hace ${diffInDays} días`;
    if (diffInDays < 30) return `Hace ${Math.floor(diffInDays / 7)} semanas`;
    return `Hace ${Math.floor(diffInDays / 30)} meses`;
}

function getScoreColor(percentage) {
    if (percentage >= 80) return 'score-high';     // Verde - 80%+
    if (percentage >= 40) return 'score-medium';   // Azul - 40-79%
    return 'score-low';                             // Rojo - Bajo 40%
}

function getLevelBadge(level, percentage) {
    const badgeColor = percentage >= 80 ? 'success' : 
                      percentage >= 60 ? 'warning' : 'danger';
    return `<div class="badge bg-${badgeColor}">${level || 'Sin nivel'}</div>`;
}

function generateDimensionsPreview(dimensionalScores) {
    return Object.entries(dimensionalScores)
        .slice(0, 3)
        .map(([dimension, score]) => `
            <div class="dimension-item">
                <span class="dimension-name">${dimension}</span>
                <span class="dimension-score">${score}%</span>
            </div>
        `).join('');
}

// Función para ver detalles de evaluación
function viewEvaluationDetails(evaluationId) {
    document.getElementById('evaluationDetailsContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Cargando detalles...</span>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('evaluationDetailsModal'));
    modal.show();
    
    // Cargar detalles de la evaluación
    fetch(`/api/coach/evaluation-details/${evaluationId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayEvaluationDetails(data.evaluation);
            } else {
                document.getElementById('evaluationDetailsContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error al cargar los detalles de la evaluación.
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading evaluation details:', error);
            document.getElementById('evaluationDetailsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error al cargar los detalles de la evaluación.
                </div>
            `;
        });
}

// Función para mostrar detalles de evaluación
function displayEvaluationDetails(evaluation) {
    console.log('renderEvaluationDetails called with:', evaluation);
    
    const container = document.getElementById('evaluationDetailsContent');
    
    // Detectar si es una evaluación DISC, Inteligencia Emocional o de Asertividad
    const assessmentTitle = evaluation.assessment?.title || '';
    const isDiscAssessment = assessmentTitle.toLowerCase().includes('disc');
    const isEmotionalIntelligenceAssessment = assessmentTitle.includes('Inteligencia Emocional');
    
    // Usar datos de la evaluación
    const data = evaluation;
    const dimensionalScores = evaluation.dimensional_scores;
    const recommendations = evaluation.recommendations || [];
    const detailedAnalysis = evaluation.detailed_analysis;
    
    console.log('Final data to use:', data);
    console.log('Dimensional scores:', dimensionalScores);
    console.log('Is DISC Assessment:', isDiscAssessment);
    console.log('Assessment Title:', assessmentTitle);
    console.log('Recommendations from server:', recommendations);
    
    // Título dinámico según el tipo de evaluación
    const analysisTitle = isDiscAssessment ? 'Análisis Completo DISC de Personalidad' : 
                         (isEmotionalIntelligenceAssessment ? 'Análisis Completo de Inteligencia Emocional' : 'Análisis Completo de Asertividad');
    
    const html = `
        <!-- Resumen General -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                    <div class="card-body text-center">
                        <h4 class="mb-3" style="color: #333;">${analysisTitle}</h4>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="h2" style="color: #007bff;">${Math.round(data.score || data.percentage || 0)}%</div>
                                <div style="color: #666;">Puntuación Total</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h4" style="color: #28a745;">${isDiscAssessment ? getDiscLevelFromScore(data.score || data.percentage || 0) : (isEmotionalIntelligenceAssessment ? getEmotionalIntelligenceLevelFromScore(data.score || data.percentage || 0) : getAssertiveLevelFromScore(data.score || data.percentage || 0))}</div>
                                <div style="color: #666;">${isDiscAssessment ? 'Estilo DISC Dominante' : (isEmotionalIntelligenceAssessment ? 'Nivel de Inteligencia Emocional' : 'Nivel de Asertividad')}</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h6" style="color: #333;">${formatDate(data.completed_at)}</div>
                                <div style="color: #666;">Fecha de Completado</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h6" style="color: #333;">${data.total_questions || evaluation.total_questions || (evaluation.responses ? evaluation.responses.length : 'N/A')}</div>
                                <div style="color: #666;">Preguntas Respondidas</div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12 text-center">
                                <div class="h5" style="color: #333;">${evaluation.coachee ? evaluation.coachee.name : (data.participant_name || evaluation.participant_name || 'N/A')}</div>
                                <div style="color: #666;">Participante</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráfico Radar y Análisis Dimensional -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="card border-0 h-100" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                    <div class="card-header" style="background: #e9ecef; border-bottom: 1px solid #dee2e6;">
                        <h5 style="color: #333;"><i class="fas fa-chart-radar me-2"></i>${isDiscAssessment ? 'Radar de Dimensiones DISC' : (isEmotionalIntelligenceAssessment ? 'Radar de Dimensiones IE' : 'Radar de Competencias')}</h5>
                    </div>
                    <div class="card-body">
                        <div class="radar-chart-container" style="position: relative; height: 300px;">
                            <canvas id="evaluationRadarChart" width="300" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6 mb-4">
                <div class="card border-0 h-100" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                    <div class="card-header" style="background: #e9ecef; border-bottom: 1px solid #dee2e6;">
                        <h5 style="color: #333;"><i class="fas fa-chart-bar me-2"></i>Puntuaciones por Dimensión</h5>
                    </div>
                    <div class="card-body">
                        <div id="dimensionalScoresContainer">
                            ${generateDimensionalScoresHTML(dimensionalScores)}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        ${generateDetailedAnalysisHTML(detailedAnalysis || generateAnalysisFromScores(dimensionalScores))}
        ${recommendations && recommendations.length > 0 ? generateRecommendationsHTML(recommendations) : ''}
        
        <!-- Respuestas Detalladas -->
        <div class="row">
            <div class="col-12">
                <div class="card border-0" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                    <div class="card-header" style="background: #e9ecef; border-bottom: 1px solid #dee2e6;">
                        <h5 style="color: #333;"><i class="fas fa-list me-2"></i>Respuestas Detalladas</h5>
                    </div>
                    <div class="card-body">
                        ${generateResponsesHTML(evaluation.responses || [])}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    
    // Crear el gráfico radar después de insertar el HTML
    setTimeout(() => {
        createRadarChart(dimensionalScores, isDiscAssessment, isEmotionalIntelligenceAssessment);
    }, 100);
}

// Función para crear gráfico radar
function createRadarChart(dimensionalScores, isDiscAssessment = false, isEmotionalIntelligenceAssessment = false) {
    const ctx = document.getElementById('evaluationRadarChart');
    if (!ctx) return;
    
    console.log('🎯 COACH RADAR DEBUG: Creating chart with params:', {
        isDiscAssessment,
        isEmotionalIntelligenceAssessment,
        dimensionalScores
    });
    
    let labels = [];
    let data = [];
    let chartLabel = '';
    
    if (isDiscAssessment) {
        // Configuración para DISC
        labels = ['Dominante', 'Influyente', 'Estable', 'Concienzudo'];
        data = [
            dimensionalScores?.Dominante || dimensionalScores?.dominante || 0,
            dimensionalScores?.Influyente || dimensionalScores?.influyente || 0,
            dimensionalScores?.Estable || dimensionalScores?.estable || 0,
            dimensionalScores?.Concienzudo || dimensionalScores?.concienzudo || 0
        ];
        chartLabel = 'Perfil DISC';
    } else if (isEmotionalIntelligenceAssessment) {
        // Configuración para Inteligencia Emocional
        labels = [
            'Autoconciencia',
            'Autorregulación',
            'Automotivación',
            'Empatía',
            'Habilidades Sociales'
        ];
        data = [
            dimensionalScores?.Autoconciencia || dimensionalScores?.autoconciencia || 0,
            dimensionalScores?.Autorregulación || dimensionalScores?.autorregulacion || 0,
            dimensionalScores?.Automotivación || dimensionalScores?.automotivacion || 0,
            dimensionalScores?.Empatía || dimensionalScores?.empatia || 0,
            dimensionalScores?.['Habilidades Sociales'] || dimensionalScores?.habilidades_sociales || 0
        ];
        chartLabel = 'Perfil de Inteligencia Emocional';
        console.log('🧠 COACH RADAR DEBUG: IE data values:', data);
    } else {
        // Configuración para Asertividad (lógica original)
        if (dimensionalScores && typeof dimensionalScores === 'object') {
            if (Array.isArray(dimensionalScores)) {
                // Array de objetos
                labels = dimensionalScores.map(score => score.dimension || score.name);
                data = dimensionalScores.map(score => Math.round((score.score / score.max_score) * 100));
            } else {
                // Objeto con claves de dimensiones
                labels = Object.keys(dimensionalScores).map(key => formatDimensionName(key));
                data = Object.values(dimensionalScores);
            }
        }
        chartLabel = 'Puntuación (%)';
    }
    
    console.log('📊 COACH RADAR DEBUG: Final chart config:', {
        labels,
        data,
        chartLabel
    });
    
    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{
                label: chartLabel,
                data: data,
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        stepSize: 20
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    console.log('✅ COACH RADAR DEBUG: Chart created successfully!');
}

// Función para generar HTML de puntuaciones dimensionales
function generateDimensionalScoresHTML(dimensionalScores) {
    if (!dimensionalScores) return '<p style="color: #666;">No hay datos dimensionales disponibles.</p>';
    
    let html = '';
    
    if (typeof dimensionalScores === 'object' && !Array.isArray(dimensionalScores)) {
        // Objeto con claves de dimensiones
        for (const [dimension, score] of Object.entries(dimensionalScores)) {
            const dimensionName = formatDimensionName(dimension);
            const percentage = Math.round(score);
            let colorClass = 'danger';
            if (percentage >= 70) colorClass = 'success';
            else if (percentage >= 50) colorClass = 'warning';
            
            html += `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <strong style="color: #333;">${dimensionName}</strong>
                        <span class="badge bg-${colorClass}">${percentage}%</span>
                    </div>
                    <div class="progress" style="height: 10px; background: #e9ecef;">
                        <div class="progress-bar bg-${colorClass}" style="width: ${percentage}%"></div>
                    </div>
                    <small style="color: #666;">${getDimensionDescription(dimension, percentage)}</small>
                </div>
            `;
        }
    } else if (Array.isArray(dimensionalScores)) {
        // Array de objetos
        dimensionalScores.forEach(score => {
            const percentage = Math.round((score.score / score.max_score) * 100);
            let colorClass = 'danger';
            if (percentage >= 70) colorClass = 'success';
            else if (percentage >= 50) colorClass = 'warning';
            
            html += `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <strong style="color: #333;">${score.dimension}</strong>
                        <span class="badge bg-${colorClass}">${percentage}%</span>
                    </div>
                    <div class="progress" style="height: 10px; background: #e9ecef;">
                        <div class="progress-bar bg-${colorClass}" style="width: ${percentage}%"></div>
                    </div>
                    <small style="color: #666;">${score.score}/${score.max_score} puntos</small>
                </div>
            `;
        });
    }
    
    return html;
}

// Función para generar análisis desde puntuaciones dimensionales
function generateAnalysisFromScores(dimensionalScores) {
    if (!dimensionalScores) return null;
    
    const strengths = [];
    const improvementAreas = [];
    
    // Analizar cada dimensión
    for (const [dimension, score] of Object.entries(dimensionalScores)) {
        const percentage = Math.round(score);
        const dimensionName = formatDimensionName(dimension);
        
        if (percentage >= 70) {
            // Es una fortaleza
            strengths.push({
                name: dimensionName,
                score: percentage,
                description: getDimensionDescription(dimension, percentage)
            });
        } else if (percentage < 60) {
            // Es un área de mejora
            const priority = percentage < 40 ? 'high' : 'medium';
            improvementAreas.push({
                name: dimensionName,
                score: percentage,
                description: getDimensionDescription(dimension, percentage),
                priority: priority
            });
        }
    }
    
    return {
        strengths: strengths,
        improvement_areas: improvementAreas
    };
}

// Función para generar HTML de análisis detallado
function generateDetailedAnalysisHTML(analysis) {
    let html = '<div class="row mb-4">';
    
    // Fortalezas
    if (analysis.strengths && analysis.strengths.length > 0) {
        html += `
            <div class="col-lg-6 mb-4">
                <div class="card border-0 h-100" style="background: #f8f9fa; border: 1px solid #dee2e6; border-left: 4px solid #28a745 !important;">
                    <div class="card-header" style="background: #d4edda; color: #155724;">
                        <h6 class="mb-0"><i class="fas fa-star me-2"></i>Fortalezas Identificadas</h6>
                    </div>
                    <div class="card-body">
        `;
        
        analysis.strengths.forEach(strength => {
            html += `
                <div class="d-flex align-items-start mb-3">
                    <div class="flex-shrink-0">
                        <span class="fw-bold text-success">${Math.round(strength.score)}%</span>
                    </div>
                    <div class="flex-grow-1 ms-2">
                        <strong style="color: #333;">${strength.name}</strong>
                        <p class="mb-0 small" style="color: #666;">${strength.description}</p>
                    </div>
                </div>
            `;
        });
        
        html += `
                    </div>
                </div>
            </div>
        `;
    }
    
    // Áreas de mejora
    if (analysis.improvement_areas && analysis.improvement_areas.length > 0) {
        html += `
            <div class="col-lg-6 mb-4">
                <div class="card border-0 h-100" style="background: #f8f9fa; border: 1px solid #dee2e6; border-left: 4px solid #ffc107 !important;">
                    <div class="card-header" style="background: #fff3cd; color: #856404;">
                        <h6 class="mb-0"><i class="fas fa-target me-2"></i>Áreas de Mejora</h6>
                    </div>
                    <div class="card-body">
        `;
        
        analysis.improvement_areas.forEach(area => {
            const priorityClass = area.priority === 'high' ? 'danger' : 'warning';
            const scoreColor = Math.round(area.score) >= 40 ? 'text-warning' : 'text-danger';
            html += `
                <div class="d-flex align-items-start mb-3">
                    <div class="flex-shrink-0">
                        <span class="fw-bold ${scoreColor}">${Math.round(area.score)}%</span>
                    </div>
                    <div class="flex-grow-1 ms-2">
                        <strong style="color: #333;">${area.name}</strong> 
                        <span class="badge bg-${priorityClass} ms-1">${area.priority}</span>
                        <p class="mb-0 small" style="color: #666;">${area.description}</p>
                    </div>
                </div>
            `;
        });
        
        html += `
                    </div>
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    return html;
}

















// Función para generar HTML de respuestas
function generateResponsesHTML(responses) {
    if (!responses || responses.length === 0) {
        return '<p class="text-muted">No hay respuestas detalladas disponibles.</p>';
    }
    
    const optionLabels = {
        1: 'Totalmente en desacuerdo',
        2: 'En desacuerdo', 
        3: 'Neutral',
        4: 'De acuerdo',
        5: 'Totalmente de acuerdo'
    };
    
    let html = '';
    responses.forEach((response, index) => {
        const scoreClass = response.selected_option >= 4 ? 'success' : 
                          response.selected_option === 3 ? 'warning' : 'danger';
        
        html += `
            <div class="border-start border-3 border-primary ps-3 mb-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <strong>Pregunta ${index + 1}:</strong>
                        <p class="mb-1">${response.question_text}</p>
                        <small class="text-${scoreClass}">
                            <i class="fas fa-check-circle me-1"></i>
                            ${optionLabels[response.selected_option] || response.answer_text || 'N/A'}
                        </small>
                    </div>
                    <span class="badge bg-${scoreClass} ms-2">${response.selected_option || response.points || 0}/5</span>
                </div>
            </div>
        `;
    });
    
    return html;
}

// Funciones auxiliares
function getAssertiveLevelFromScore(score) {
    if (score >= 85) return 'Muy Asertivo';
    if (score >= 70) return 'Asertivo';
    if (score >= 50) return 'Moderadamente Asertivo';
    return 'Poco Asertivo';
}

function getDiscLevelFromScore(score) {
    if (score >= 80) return 'Dominante Alto';
    if (score >= 60) return 'Influyente Alto';
    if (score >= 40) return 'Estable Alto';
    if (score >= 20) return 'Concienzudo Alto';
    return 'Perfil Equilibrado';
}

function getEmotionalIntelligenceLevelFromScore(score) {
    if (score >= 80) return 'Muy Alta';
    if (score >= 65) return 'Alta';
    if (score >= 50) return 'Moderada';
    if (score >= 35) return 'Baja';
    return 'Muy Baja';
}

function formatDimensionName(dimension) {
    const nameMap = {
        'comunicacion': 'Comunicación',
        'derechos': 'Defensa de Derechos',
        'opiniones': 'Expresión de Opiniones',
        'conflictos': 'Manejo de Conflictos',
        'autoconfianza': 'Autoconfianza'
    };
    return nameMap[dimension] || dimension.charAt(0).toUpperCase() + dimension.slice(1);
}

function getDimensionDescription(dimension, score) {
    const descriptions = {
        'comunicacion': score >= 70 ? 'Excelente comunicación interpersonal' : 'Oportunidad de mejorar la comunicación',
        'derechos': score >= 70 ? 'Sabe defender sus derechos apropiadamente' : 'Necesita fortalecer la defensa de derechos',
        'opiniones': score >= 70 ? 'Expresa opiniones con confianza' : 'Puede mejorar la expresión de opiniones',
        'conflictos': score >= 70 ? 'Maneja conflictos efectivamente' : 'Requiere desarrollo en manejo de conflictos',
        'autoconfianza': score >= 70 ? 'Alta confianza en sí mismo/a' : 'Oportunidad de fortalecer autoconfianza'
    };
    return descriptions[dimension] || 'Área de desarrollo personal';
}

function formatDate(dateString) {
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        return dateString || 'Fecha no disponible';
    }
}

// Función para editar coachee
function editCoachee(coacheeId) {
    console.log('Edit coachee:', coacheeId);
    // Implementar edición
}

// ✅ Función para mostrar/ocultar contraseña en tabla desktop
function togglePassword(coacheeId, password) {
    const passwordElement = document.getElementById(`pwd-${coacheeId}`);
    const eyeIcon = document.getElementById(`eye-${coacheeId}`);
    
    if (passwordElement.textContent === '●●●●●●●●') {
        passwordElement.textContent = password;
        eyeIcon.className = 'fas fa-eye-slash';
    } else {
        passwordElement.textContent = '●●●●●●●●';
        eyeIcon.className = 'fas fa-eye';
    }
}

// ✅ Función para mostrar/ocultar contraseña en vista móvil
function togglePasswordMobile(coacheeId, password) {
    const passwordElement = document.getElementById(`pwd-mobile-${coacheeId}`);
    const eyeIcon = document.getElementById(`eye-mobile-${coacheeId}`);
    
    if (passwordElement.textContent === '●●●●●●●●') {
        passwordElement.textContent = password;
        eyeIcon.className = 'fas fa-eye-slash';
    } else {
        passwordElement.textContent = '●●●●●●●●';
        eyeIcon.className = 'fas fa-eye';
    }
}

// ✅ Función para copiar contraseña al portapapeles
function copyPassword(password) {
    navigator.clipboard.writeText(password).then(function() {
        // Mostrar mensaje de éxito temporal
        const originalText = event.target.closest('button').innerHTML;
        event.target.closest('button').innerHTML = '<i class="fas fa-check"></i>';
        event.target.closest('button').classList.remove('btn-outline-primary');
        event.target.closest('button').classList.add('btn-success');
        
        setTimeout(() => {
            event.target.closest('button').innerHTML = originalText;
            event.target.closest('button').classList.remove('btn-success');
            event.target.closest('button').classList.add('btn-outline-primary');
        }, 1500);
    }).catch(function() {
        alert('Error al copiar la contraseña');
    });
}

// Manejar formulario de invitación
document.getElementById('inviteForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const name = document.getElementById('coacheeName').value.trim();
    const email = document.getElementById('coacheeEmail').value.trim();
    const assignedAssessment = document.getElementById('assignedAssessment').value;
    const customMessage = document.getElementById('customMessage').value.trim();
    
    if (!name || !email) {
        alert('Por favor complete todos los campos obligatorios');
        return;
    }
    
    // Preparar datos de la invitación
    const invitationData = {
        full_name: name,
        email: email,
        message: customMessage || 'Invitación para participar en evaluaciones de coaching'
    };
    
    // Agregar evaluación asignada si se seleccionó
    if (assignedAssessment) {
        invitationData.assigned_assessment_id = parseInt(assignedAssessment);
    }
    
    fetch('/api/coach/create-invitation-v2', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(invitationData)
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            document.getElementById('inviteForm').reset();
            
            let message = '¡Coachee creado exitosamente!\n\nCredenciales:\nUsuario: ' + data.coachee.username + '\nContraseña: ' + data.coachee.password;
            
            // Mostrar información sobre evaluación asignada
            if (data.coachee.assigned_assessment) {
                message += '\n\n✅ Evaluación "' + data.coachee.assigned_assessment + '" asignada exitosamente';
            } else if (assignedAssessment) {
                message += '\n\n⚠️ No se pudo asignar la evaluación seleccionada';
            }
            
            alert(message);
            loadCoachees();
        } else {
            alert('Error al crear el coachee: ' + (data.error || data.message || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error sending invitation:', error);
        alert('Error al enviar la invitación: ' + error.message);
    });
});

// Cargar datos iniciales
document.addEventListener('DOMContentLoaded', function() {
    refreshDashboard();
    
    // FORZAR APLICACIÓN DE ESTILOS PANEL DE CONTROL
    setTimeout(function() {
        // Elementos con las clases nuevas
        const sidebar = document.querySelector('.sidebar-white');
        const header = document.querySelector('.sidebar-header-white');
        const title = document.querySelector('.sidebar-title-white');
        
        // Elementos con las clases originales (por si acaso)
        const sidebarOld = document.querySelector('.sidebar-force-white');
        const headerOld = document.querySelector('.sidebar-header-force');
        const titleOld = document.querySelector('.sidebar-title-force');
        
        // Aplicar estilos a elementos nuevos
        if (sidebar) {
            sidebar.style.setProperty('background', 'white', 'important');
            sidebar.style.setProperty('background-color', 'white', 'important');
            sidebar.style.setProperty('border', '1px solid #dee2e6', 'important');
            sidebar.classList.remove('bg-dark', 'border-secondary');
        }
        if (header) {
            header.style.setProperty('background', '#f8f9fa', 'important');
            header.style.setProperty('background-color', '#f8f9fa', 'important');
            header.style.setProperty('color', '#333', 'important');
            header.classList.remove('bg-dark');
        }
        if (title) {
            title.style.setProperty('color', '#333', 'important');
            title.classList.remove('text-white');
        }
        
        // Aplicar estilos a elementos originales (fallback)
        if (sidebarOld) {
            sidebarOld.style.setProperty('background', 'white', 'important');
            sidebarOld.style.setProperty('background-color', 'white', 'important');
        }
        if (headerOld) {
            headerOld.style.setProperty('background', '#f8f9fa', 'important');
            headerOld.style.setProperty('background-color', '#f8f9fa', 'important');
            headerOld.style.setProperty('color', '#333', 'important');
        }
        if (titleOld) {
            titleOld.style.setProperty('color', '#333', 'important');
        }
        
        console.log('Estilos del panel de control forzados ULTRA - v2.2');
        
        // FORZAR VARIABLES CSS DEL TEMA
        const sidebarTheme = document.querySelector('.sidebar');
        if (sidebarTheme) {
            sidebarTheme.style.setProperty('--theme-card-bg', 'white', 'important');
            sidebarTheme.style.setProperty('--theme-card-border', '#dee2e6', 'important');
            sidebarTheme.style.setProperty('--theme-text-primary', '#333', 'important');
            sidebarTheme.style.setProperty('--theme-hover-bg', '#f8f9fa', 'important');
            console.log('Variables CSS del tema anuladas para sidebar');
        }
    }, 100);
});

// Mejorar navegación del panel de control - Prevenir scroll automático
document.addEventListener('DOMContentLoaded', function() {
    // Agregar event listeners a todos los enlaces del menú
    document.querySelectorAll('[data-module]').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault(); // Prevenir comportamiento por defecto
            e.stopPropagation(); // Prevenir propagación del evento
            
            const moduleId = this.getAttribute('data-module');
            if (moduleId) {
                showModule(moduleId);
            }
            
            return false;
        });
    });
    
    console.log('✅ Event listeners del panel de control configurados');
});

// ===== FUNCIONES PARA ASIGNAR EVALUACIONES/TAREAS =====

// Función para mostrar el modal de asignación
function showAssignModal(coacheeId, coacheeName) {
    console.log('🎯 Abriendo modal de asignación para coachee:', coacheeId, coacheeName);
    
    // Establecer datos del coachee
    document.getElementById('targetCoacheeId').value = coacheeId;
    document.getElementById('assignModalCoacheeName').textContent = coacheeName;
    
    // Cargar evaluaciones disponibles
    loadAssessmentsForAssignment();
    
    // Resetear formularios
    document.getElementById('assignEvaluationForm').reset();
    document.getElementById('assignTaskForm').reset();
    document.getElementById('targetCoacheeId').value = coacheeId; // Restaurar después del reset
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('assignModal'));
    modal.show();
}

// Función para cargar evaluaciones en el selector del modal de asignación
function loadAssessmentsForAssignment() {
    console.log('📋 Cargando evaluaciones para asignación...');
    
    const select = document.getElementById('assignAssessmentSelect');
    select.innerHTML = '<option value="">Cargando evaluaciones...</option>';
    
    fetch('/api/coach/available-assessments')
        .then(response => response.json())
        .then(data => {
            console.log('📊 Evaluaciones recibidas para asignación:', data);
            
            if (data.success && data.assessments && data.assessments.length > 0) {
                select.innerHTML = '<option value="">Seleccionar evaluación</option>';
                
                data.assessments.forEach(assessment => {
                    const option = document.createElement('option');
                    option.value = assessment.id;
                    option.textContent = `${assessment.title} (${assessment.questions_count} preguntas)`;
                    select.appendChild(option);
                });
                
                console.log('✅ Evaluaciones cargadas en selector de asignación');
            } else {
                select.innerHTML = '<option value="">No hay evaluaciones disponibles</option>';
                console.log('❌ No se encontraron evaluaciones para asignación');
            }
        })
        .catch(error => {
            console.error('❌ Error cargando evaluaciones para asignación:', error);
            select.innerHTML = '<option value="">Error cargando evaluaciones</option>';
        });
}

// Función para ejecutar la asignación (evaluación o tarea)
function executeAssignment() {
    const activeTab = document.querySelector('#assignTabs .nav-link.active');
    const isEvaluationTab = activeTab.id === 'evaluation-tab';
    
    if (isEvaluationTab) {
        assignEvaluationFromModal();
    } else {
        assignTaskFromModal();
    }
}

// Función para asignar evaluación desde el modal
function assignEvaluationFromModal() {
    const coacheeId = document.getElementById('targetCoacheeId').value;
    const assessmentId = document.getElementById('assignAssessmentSelect').value;
    const message = document.getElementById('assignEvaluationMessage').value;
    const dueDate = document.getElementById('assignEvaluationDueDate').value;
    
    if (!assessmentId) {
        alert('Por favor selecciona una evaluación');
        return;
    }
    
    console.log('📋 Asignando evaluación:', { coacheeId, assessmentId, message, dueDate });
    
    // Preparar datos para la API de crear tarea
    const taskData = {
        coachee_id: parseInt(coacheeId),
        title: `Evaluación: ${document.getElementById('assignAssessmentSelect').selectedOptions[0].textContent}`,
        description: message || `Completa la evaluación asignada por tu coach.`,
        category: 'evaluation',
        priority: 'high',
        due_date: dueDate || null
    };
    
    // Crear tarea
    fetch('/api/coach/tasks', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(taskData)
    })
    .then(response => response.json())
    .then(data => {
        console.log('📊 Respuesta de asignación de evaluación:', data);
        
        if (data.success) {
            alert('✅ Evaluación asignada exitosamente');
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('assignModal'));
            modal.hide();
            
            // Recargar datos
            loadTasks();
            loadCoachees();
        } else {
            alert('❌ Error al asignar evaluación: ' + (data.message || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('❌ Error asignando evaluación:', error);
        alert('❌ Error al asignar evaluación');
    });
}

// Función para asignar tarea desde el modal
function assignTaskFromModal() {
    const coacheeId = document.getElementById('targetCoacheeId').value;
    const title = document.getElementById('assignTaskTitle').value;
    const description = document.getElementById('assignTaskDescription').value;
    const category = document.getElementById('assignTaskCategory').value;
    const priority = document.getElementById('assignTaskPriority').value;
    const dueDate = document.getElementById('assignTaskDueDate').value;
    
    if (!title || !description || !category) {
        alert('Por favor completa todos los campos requeridos');
        return;
    }
    
    console.log('📝 Asignando tarea:', { coacheeId, title, description, category, priority, dueDate });
    
    const taskData = {
        coachee_id: parseInt(coacheeId),
        title: title,
        description: description,
        category: category,
        priority: priority,
        due_date: dueDate || null
    };
    
    fetch('/api/coach/tasks', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(taskData)
    })
    .then(response => response.json())
    .then(data => {
        console.log('📊 Respuesta de asignación de tarea:', data);
        
        if (data.success) {
            alert('✅ Tarea asignada exitosamente');
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('assignModal'));
            modal.hide();
            
            // Recargar datos
            loadTasks();
            loadCoachees();
        } else {
            alert('❌ Error al asignar tarea: ' + (data.message || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('❌ Error asignando tarea:', error);
        alert('❌ Error al asignar tarea');
    });
}

// Función para abrir modal de asignación desde el contexto de evaluación
function openAssignModalFromEvaluation(assessmentId, assessmentTitle) {
    console.log('🎯 Abriendo modal de asignación desde evaluación:', assessmentId, assessmentTitle);
    
    // Crear un modal específico para seleccionar coachee
    const assignEvaluationModal = document.createElement('div');
    assignEvaluationModal.className = 'modal fade';
    assignEvaluationModal.id = 'assignEvaluationToCoacheeModal';
    assignEvaluationModal.setAttribute('tabindex', '-1');
    
    assignEvaluationModal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus me-2"></i>Asignar Evaluación: ${assessmentTitle}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Pestañas -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="existing-coachee-tab" data-bs-toggle="tab" 
                                data-bs-target="#existing-coachee-pane" type="button" role="tab">
                                <i class="fas fa-users me-1"></i>Coachee Existente
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="new-coachee-tab" data-bs-toggle="tab" 
                                data-bs-target="#new-coachee-pane" type="button" role="tab">
                                <i class="fas fa-user-plus me-1"></i>Nuevo Coachee
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- Pestaña de Coachee Existente -->
                        <div class="tab-pane fade show active" id="existing-coachee-pane" role="tabpanel">
                            <div class="mb-3">
                                <label for="existingCoacheeSelect" class="form-label">Seleccionar coachee:</label>
                                <select class="form-select" id="existingCoacheeSelect" required>
                                    <option value="">Cargando coachees...</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="existingEvaluationMessage" class="form-label">Mensaje personalizado (opcional):</label>
                                <textarea class="form-control" id="existingEvaluationMessage" rows="3" 
                                    placeholder="Mensaje para el coachee..."></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="existingEvaluationDueDate" class="form-label">Fecha límite (opcional):</label>
                                <input type="date" class="form-control" id="existingEvaluationDueDate">
                            </div>
                            
                            <button type="button" class="btn btn-success" onclick="assignEvaluationToExistingCoachee(${assessmentId})">
                                <i class="fas fa-check me-1"></i>Asignar Evaluación
                            </button>
                        </div>

                        <!-- Pestaña de Nuevo Coachee -->
                        <div class="tab-pane fade" id="new-coachee-pane" role="tabpanel">
                            <div class="mb-3">
                                <label for="newCoacheeName" class="form-label">Nombre completo:</label>
                                <input type="text" class="form-control" id="newCoacheeName" required
                                    placeholder="Ej: María González">
                            </div>
                            
                            <div class="mb-3">
                                <label for="newCoacheeEmail" class="form-label">Email:</label>
                                <input type="email" class="form-control" id="newCoacheeEmail" required
                                    placeholder="Ej: maria@empresa.com">
                            </div>
                            
                            <div class="mb-3">
                                <label for="newCoacheePassword" class="form-label">Contraseña temporal:</label>
                                <input type="password" class="form-control" id="newCoacheePassword" required
                                    placeholder="Contraseña para el coachee">
                            </div>
                            
                            <div class="mb-3">
                                <label for="newEvaluationMessage" class="form-label">Mensaje personalizado (opcional):</label>
                                <textarea class="form-control" id="newEvaluationMessage" rows="3" 
                                    placeholder="Mensaje para el coachee..."></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="newEvaluationDueDate" class="form-label">Fecha límite (opcional):</label>
                                <input type="date" class="form-control" id="newEvaluationDueDate">
                            </div>
                            
                            <button type="button" class="btn btn-success" onclick="createCoacheeAndAssignEvaluation(${assessmentId})">
                                <i class="fas fa-user-plus me-1"></i>Crear Coachee y Asignar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Agregar modal al DOM
    document.body.appendChild(assignEvaluationModal);
    
    // Cargar coachees existentes
    loadCoacheesForAssignment();
    
    // Mostrar modal
    const modal = new bootstrap.Modal(assignEvaluationModal);
    modal.show();
    
    // Limpiar modal cuando se cierre
    assignEvaluationModal.addEventListener('hidden.bs.modal', function () {
        document.body.removeChild(assignEvaluationModal);
    });
}

// Función para cargar coachees en el selector
function loadCoacheesForAssignment() {
    console.log('👥 Cargando coachees para asignación...');
    
    const select = document.getElementById('existingCoacheeSelect');
    if (select) {
        select.innerHTML = '<option value="">Cargando coachees...</option>';
        
        fetch('/api/coach/my-coachees')
            .then(response => response.json())
            .then(data => {
                console.log('📊 Coachees cargados:', data);
                
                select.innerHTML = '<option value="">Seleccionar coachee...</option>';
                
                if (data.success && data.coachees) {
                    data.coachees.forEach(coachee => {
                        const option = document.createElement('option');
                        option.value = coachee.id;
                        option.textContent = `${coachee.name} (${coachee.email})`;
                        select.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('❌ Error cargando coachees:', error);
                select.innerHTML = '<option value="">Error cargando coachees</option>';
            });
    }
}

// Función para asignar evaluación a coachee existente
function assignEvaluationToExistingCoachee(assessmentId) {
    const coacheeId = document.getElementById('existingCoacheeSelect').value;
    const message = document.getElementById('existingEvaluationMessage').value;
    const dueDate = document.getElementById('existingEvaluationDueDate').value;
    
    if (!coacheeId) {
        alert('Por favor selecciona un coachee');
        return;
    }
    
    console.log('📋 Asignando evaluación a coachee existente:', { coacheeId, assessmentId, message, dueDate });
    
    // Obtener el título de la evaluación desde el modal
    const modalTitle = document.querySelector('#assignEvaluationToCoacheeModal .modal-title').textContent;
    const assessmentTitle = modalTitle.replace('Asignar Evaluación: ', '');
    
    const taskData = {
        coachee_id: parseInt(coacheeId),
        title: `Evaluación: ${assessmentTitle}`,
        description: message || `Completa la evaluación asignada por tu coach.`,
        category: 'evaluation',
        priority: 'high',
        due_date: dueDate || null
    };
    
    fetch('/api/coach/tasks', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(taskData)
    })
    .then(response => response.json())
    .then(data => {
        console.log('📊 Respuesta de asignación:', data);
        
        if (data.success) {
            alert('✅ Evaluación asignada exitosamente');
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('assignEvaluationToCoacheeModal'));
            modal.hide();
            
            // Recargar datos si estamos en la vista de tareas
            if (typeof loadTasks === 'function') {
                loadTasks();
            }
        } else {
            alert('❌ Error al asignar evaluación: ' + (data.message || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('❌ Error asignando evaluación:', error);
        alert('❌ Error al asignar evaluación');
    });
}

// Función para crear coachee y asignar evaluación
function createCoacheeAndAssignEvaluation(assessmentId) {
    const name = document.getElementById('newCoacheeName').value;
    const email = document.getElementById('newCoacheeEmail').value;
    const password = document.getElementById('newCoacheePassword').value;
    const message = document.getElementById('newEvaluationMessage').value;
    const dueDate = document.getElementById('newEvaluationDueDate').value;
    
    if (!name || !email || !password) {
        alert('Por favor completa todos los campos requeridos');
        return;
    }
    
    console.log('👤 Creando coachee y asignando evaluación:', { name, email, assessmentId, message, dueDate });
    
    // Crear coachee primero
    const coacheeData = {
        full_name: name,
        email: email,
        password: password,
        assigned_assessment_id: assessmentId
    };
    
    fetch('/api/coach/create-invitation-v2', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(coacheeData)
    })
    .then(response => response.json())
    .then(data => {
        console.log('📊 Respuesta de creación de coachee:', data);
        
        if (data.success) {
            alert('✅ Coachee creado y evaluación asignada exitosamente');
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('assignEvaluationToCoacheeModal'));
            modal.hide();
            
            // Recargar datos
            if (typeof loadCoachees === 'function') {
                loadCoachees();
            }
            if (typeof loadTasks === 'function') {
                loadTasks();
            }
        } else {
            alert('❌ Error al crear coachee: ' + (data.message || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('❌ Error creando coachee:', error);
        alert('❌ Error al crear coachee');
    });
}

// Función para mostrar las evaluaciones asignadas a un coachee
function showAssignedAssessments(coacheeId, coacheeName) {
    console.log(`🔍 Showing assigned assessments for coachee ${coacheeId} (${coacheeName})`);
    
    // Actualizar el título del modal
    document.getElementById('assignedAssessmentsModalLabel').innerHTML = 
        `<i class="fas fa-clipboard-list me-2"></i>Evaluaciones - ${coacheeName}`;
    
    // Mostrar spinner de carga
    document.getElementById('assignedAssessmentsContent').innerHTML = `
        <div class="text-center">
            <i class="fas fa-spinner fa-spin fa-2x text-info"></i>
            <p class="mt-2">Cargando evaluaciones asignadas...</p>
        </div>
    `;
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('assignedAssessmentsModal'));
    modal.show();
    
    // Obtener las evaluaciones asignadas
    fetch(`/api/coach/coachee-assessments/${coacheeId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayAssignedAssessments(data.assessments, coacheeId, coacheeName);
            } else {
                document.getElementById('assignedAssessmentsContent').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${data.error || 'Error al cargar las evaluaciones asignadas'}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading assigned assessments:', error);
            document.getElementById('assignedAssessmentsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error al cargar las evaluaciones asignadas
                </div>
            `;
        });
}

// Función para mostrar las evaluaciones asignadas en el modal
function displayAssignedAssessments(assessments, coacheeId, coacheeName) {
    const container = document.getElementById('assignedAssessmentsContent');
    
    if (assessments.length === 0) {
        container.innerHTML = `
            <div class="unified-empty-state">
                <i class="fas fa-clipboard fa-3x"></i>
                <h5>No hay evaluaciones disponibles</h5>
                <p>No se encontraron evaluaciones para este coachee.</p>
            </div>
        `;
        return;
    }
    
    // Separar evaluaciones asignadas y disponibles
    const assignedAssessments = assessments.filter(assessment => assessment.is_assigned);
    const availableAssessments = assessments.filter(assessment => !assessment.is_assigned);
    
    container.innerHTML = `
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="alert alert-info">
                    <i class="fas fa-clipboard-check me-2"></i>
                    <strong>${assignedAssessments.length}</strong> evaluación${assignedAssessments.length !== 1 ? 'es asignadas' : ' asignada'}
                </div>
            </div>
            <div class="col-md-6">
                <div class="alert alert-secondary">
                    <i class="fas fa-clipboard-list me-2"></i>
                    <strong>${availableAssessments.length}</strong> evaluación${availableAssessments.length !== 1 ? 'es disponibles' : ' disponible'}
                </div>
            </div>
        </div>
        
        ${assignedAssessments.length > 0 ? `
            <div class="mb-4">
                <h6 class="text-primary mb-3">
                    <i class="fas fa-clipboard-check me-2"></i>
                    Evaluaciones Asignadas
                </h6>
                <div class="results-list">
                    ${assignedAssessments.map(assessment => `
                        <div class="unified-card">
                            <div class="unified-card-header">
                                <div class="d-flex justify-content-between align-items-start w-100">
                                    <div>
                                        <div class="mb-2">
                                            <span class="unified-badge unified-badge-success">Asignada</span>
                                        </div>
                                        <h5 class="unified-card-title">${assessment.assessment_title}</h5>
                                    </div>
                                    <button class="unified-btn unified-btn-danger unified-btn-sm" 
                                            onclick="confirmUnassignAssessment(${coacheeId}, '${coacheeName}', '${assessment.assessment_title}')" 
                                            title="Desasignar evaluación">
                                        <i class="fas fa-times"></i>
                                        Desasignar
                                    </button>
                                </div>
                            </div>
                            <div class="unified-card-body">
                                <p class="text-muted mb-2">${assessment.description || 'Sin descripción'}</p>
                                <div class="assessment-meta">
                                    <div class="meta-item">
                                        <i class="fas fa-question-circle"></i>
                                        <span>${assessment.total_questions} preguntas</span>
                                    </div>
                                    ${assessment.assigned_date ? `
                                    <div class="meta-item">
                                        <i class="fas fa-calendar-plus"></i>
                                        <span>Asignada: ${new Date(assessment.assigned_date).toLocaleString()}</span>
                                    </div>
                                    ` : ''}
                                    ${assessment.due_date ? `
                                    <div class="meta-item">
                                        <i class="fas fa-calendar-times"></i>
                                        <span>Vence: ${new Date(assessment.due_date).toLocaleString()}</span>
                                    </div>
                                    ` : ''}
                                    ${assessment.completed_attempts > 0 ? `
                                    <div class="meta-item">
                                        <i class="fas fa-check-circle text-success"></i>
                                        <span>Completada ${assessment.completed_attempts} vez${assessment.completed_attempts !== 1 ? 'es' : ''}</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : ''}
        
        ${availableAssessments.length > 0 ? `
            <div class="mb-4">
                <h6 class="text-secondary mb-3">
                    <i class="fas fa-clipboard-list me-2"></i>
                    Evaluaciones Disponibles (No Asignadas)
                </h6>
                <div class="results-list">
                    ${availableAssessments.map(assessment => `
                        <div class="unified-card">
                            <div class="unified-card-header">
                                <div>
                                    <div class="mb-2">
                                        <span class="unified-badge unified-badge-secondary">Disponible</span>
                                    </div>
                                    <h5 class="unified-card-title">${assessment.assessment_title}</h5>
                                </div>
                            </div>
                            <div class="unified-card-body">
                                <p class="text-muted mb-2">${assessment.description || 'Sin descripción'}</p>
                                <div class="assessment-meta">
                                    <div class="meta-item">
                                        <i class="fas fa-question-circle"></i>
                                        <span>${assessment.total_questions} preguntas</span>
                                    </div>
                                    ${assessment.completed_attempts > 0 ? `
                                    <div class="meta-item">
                                        <i class="fas fa-check-circle text-success"></i>
                                        <span>Completada ${assessment.completed_attempts} vez${assessment.completed_attempts !== 1 ? 'es' : ''} (sin asignar)</span>
                                    </div>
                                    ` : `
                                    <div class="meta-item">
                                        <i class="fas fa-clock text-muted"></i>
                                        <span>Sin completar</span>
                                    </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : ''}
        
        <div class="alert alert-info mt-3">
            <i class="fas fa-lightbulb me-2"></i>
            <strong>Información:</strong> Esta vista muestra todas las evaluaciones disponibles para ${coacheeName}. 
            Las evaluaciones marcadas como "Asignadas" aparecen en el dashboard del coachee como tareas pendientes.
        </div>
    `;
}

// Función para confirmar la desasignación de una evaluación
function confirmUnassignAssessment(coacheeId, coacheeName, assessmentTitle) {
    if (confirm(`¿Estás seguro de que deseas desasignar la evaluación "${assessmentTitle}" de ${coacheeName}?\n\nEsta acción no se puede deshacer.`)) {
        unassignAssessment(coacheeId, coacheeName, assessmentTitle);
    }
}

// Función para desasignar una evaluación
function unassignAssessment(coacheeId, coacheeName, assessmentTitle) {
    console.log(`🚫 Unassigning assessment "${assessmentTitle}" from coachee ${coacheeId} (${coacheeName})`);
    
    // Mostrar spinner en el botón
    const buttons = document.querySelectorAll('button[onclick*="confirmUnassignAssessment"]');
    buttons.forEach(btn => {
        if (btn.onclick.toString().includes(assessmentTitle)) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Desasignando...';
            btn.disabled = true;
        }
    });
    
    fetch('/api/coach/unassign-assessment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            coachee_id: coacheeId,
            assessment_title: assessmentTitle
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ Assessment unassigned successfully');
            
            // Mostrar mensaje de éxito
            showSuccessMessage(`Evaluación "${assessmentTitle}" desasignada exitosamente de ${coacheeName}`);
            
            // Recargar las evaluaciones asignadas
            showAssignedAssessments(coacheeId, coacheeName);
            
            // Recargar la lista de coachees para actualizar los contadores
            if (typeof loadCoachees === 'function') {
                loadCoachees();
            }
        } else {
            console.error('❌ Error unassigning assessment:', data.error);
            alert(`❌ Error: ${data.error}`);
            
            // Restaurar botones
            buttons.forEach(btn => {
                if (btn.onclick.toString().includes(assessmentTitle)) {
                    btn.innerHTML = '<i class="fas fa-times me-1"></i>Desasignar';
                    btn.disabled = false;
                }
            });
        }
    })
    .catch(error => {
        console.error('❌ Error unassigning assessment:', error);
        alert('❌ Error al desasignar la evaluación');
        
        // Restaurar botones
        buttons.forEach(btn => {
            if (btn.onclick.toString().includes(assessmentTitle)) {
                btn.innerHTML = '<i class="fas fa-times me-1"></i>Desasignar';
                btn.disabled = false;
            }
        });
    });
}

// Función auxiliar para mostrar mensajes de éxito
function showSuccessMessage(message) {
    // Crear y mostrar un toast de éxito
    const toastContainer = document.querySelector('.toast-container') || createToastContainer();
    
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-check-circle me-2"></i>${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    const toast = new bootstrap.Toast(document.getElementById(toastId));
    toast.show();
    
    // Limpiar el toast después de que se oculte
    document.getElementById(toastId).addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}

// Función para crear el contenedor de toasts si no existe
function createToastContainer() {
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1055';
    document.body.appendChild(container);
    return container;
}

// Función para imprimir reporte de evaluación
function printEvaluationReport() {
    // Crear una nueva ventana para imprimir
    const printWindow = window.open('', '_blank');
    const evaluationContent = document.getElementById('evaluationDetailsContent').innerHTML;
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Reporte de Evaluación de Asertividad</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body { font-family: Arial, sans-serif; }
                .card { border: 1px solid #dee2e6; margin-bottom: 1rem; }
                .badge { display: inline-block; padding: 0.25em 0.6em; }
                @media print { 
                    .btn { display: none; }
                    canvas { max-width: 400px; }
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1 class="text-center mb-4">Reporte de Evaluación de Asertividad</h1>
                ${evaluationContent}
            </div>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
}

// Cache buster - Forzar recarga: 2025-08-31-19:22
console.log('🔄 Template actualizado: 2025-08-31-20:25 - Funcionalidad de desasignación de evaluaciones agregada');
</script>
{% endblock %}
