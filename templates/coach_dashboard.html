<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InstaCoach - Coach</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts - Lobster Two -->
    <link href="https://fonts.googleapis.com/css2?family=Lobster+Two:wght@400;700&display=swap" rel="stylesheet">
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/recommendations.js?v={{ get_file_version('js/recommendations.js') }}"></script>
    <link rel="stylesheet" href="/static/css/unified-dashboard.css?v={{ get_file_version('css/unified-dashboard.css') }}">
    <!-- FullCalendar CSS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- PDF.js para vista previa de documentos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configurar worker de PDF.js
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>

    
    <style>
        /* Variables CSS para recomendaciones unificadas - IGUAL QUE COACHEE */
        :root {
            --calm-primary: #1E3A8A;        /* Deep Blue */
            --calm-secondary: #3B82F6;      /* Bright Blue */
            --calm-accent: #06B6D4;         /* Cyan */
            --calm-light: #EFF6FF;          /* Very Light Blue */
            --calm-dark: #1E293B;           /* Dark Slate */
            --calm-white: #FFFFFF;
            --calm-gray-50: #F8FAFC;
            --calm-gray-100: #F1F5F9;
        }

        /* Estilos principales del body - IGUALADO CON COACHEE DASHBOARD */
        body {
            background: #f8fafc !important;
            color: #1e293b !important;
            transition: all 0.3s ease;
        }

        /* Container principal con z-index para aparecer sobre partículas */
        .container-fluid {
            position: relative;
            z-index: 2;
        }

        /* Animated background particles - IGUAL QUE COACHEE */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            background: rgba(90, 103, 216, 0.08); /* Calm's signature blue with very low opacity */
            border-radius: 50%;
            animation: float 25s infinite linear; /* Slower, more peaceful animation */
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% {
                transform: translateY(-100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Cards y contenedores - Con z-index para aparecer sobre partículas */
        .card,
        .glass-card,
        .modal-content {
            background: white !important;
            border: 1px solid #e2e8f0 !important;
            color: #1e293b !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            border-radius: 0.5rem !important;
            transition: all 0.3s ease;
            position: relative;
            z-index: 2;
        }
        
        .card.bg-dark {
            background: white !important;
            border: 1px solid #e2e8f0 !important;
        }
        
        .card.bg-dark .card-body {
            background: white !important;
        }
    
        /* Textos */
        .text-white,
        .text-muted,
        .card.bg-dark .text-white,
        .card.bg-dark .text-muted {
            color: #1e293b !important;
        }
        
        .text-primary {
            color: var(--calm-secondary) !important;
        }
        
        .text-muted {
            color: #64748b !important;
        }
        
        /* Botones */
        .btn-outline-light {
            border-color: #e2e8f0 !important;
            color: #1e293b !important;
            background: white !important;
        }
        
        .btn-outline-light:hover {
            background: #f1f5f9 !important;
            border-color: #e2e8f0 !important;
            color: #1e293b !important;
        }
    
    .btn-primary {
        background: var(--calm-secondary) !important;
        border-color: var(--calm-secondary) !important;
        color: white !important;
    }
    
    .btn-success {
        background: #28a745 !important;
        border-color: #28a745 !important;
        color: white !important;
    }
    
    .btn-info {
        background: #17a2b8 !important;
        border-color: #17a2b8 !important;
        color: white !important;
    }
        
        /* ESTILOS PARA SIDEBAR PANEL DE CONTROL - MODERNO */
        .sidebar {
            background: white !important;
            border: 2px solid #e2e8f0 !important;
            border-radius: 16px !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08) !important;
            overflow: hidden !important;
        }
        
        .sidebar-white {
            background: white !important;
            background-color: white !important;
        }
        
        .sidebar-force-white {
            background: white !important;
            background-color: white !important;
        }
        
        .sidebar-header-white {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            background-color: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border-bottom: none !important;
        }
        
        .sidebar-header-force {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            background-color: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border-bottom: none !important;
        }
        
        .sidebar-title-white {
            color: white !important;
            font-weight: 700 !important;
        }
        
        .sidebar-title-force {
            color: white !important;
            font-weight: 700 !important;
        }
        
        .list-group-item {
            background-color: white !important;
            color: #1e293b !important;
            border: none !important;
            border-bottom: 1px solid #e2e8f0 !important;
            transition: all 0.2s ease !important;
            font-weight: 500 !important;
            padding: 1rem 1.25rem !important;
        }
        
        .list-group-item:hover {
            background-color: #f8fafc !important;
            color: #667eea !important;
            transform: translateX(4px);
        }
        
        .list-group-item.active {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.1) 0%, rgba(102, 126, 234, 0.05) 100%) !important;
            border-left: 4px solid #667eea !important;
            color: #667eea !important;
            font-weight: 600 !important;
        }
        
        .list-group-item i {
            color: #667eea !important;
            width: 20px !important;
            text-align: center !important;
            font-size: 1.1rem !important;
        }
        
        .list-group-item.active i {
            color: #667eea !important;
        }
        
        .list-group-item:hover i {
            transform: scale(1.1);
            transition: transform 0.2s ease;
        }
        
        /* Formularios y inputs */
        .form-control,
        .form-select {
            background: white !important;
            border: 1px solid #e2e8f0 !important;
            color: #1e293b !important;
        }
        
        .form-control:focus,
        .form-select:focus {
            background: white !important;
            border-color: var(--calm-secondary) !important;
            color: #1e293b !important;
            box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25) !important;
        }
        
        /* Modales */
        .modal-content {
            background: white !important;
            color: #1e293b !important;
        }
        
        .modal-header {
            background: white !important;
            border-bottom: 1px solid #e2e8f0 !important;
        }
        
        .modal-title {
            color: #1e293b !important;
        }
        
        .modal-footer {
            background: white !important;
            border-top: 1px solid #e2e8f0 !important;
        }
        
        /* Tablas */
        .table {
            color: #1e293b !important;
        }
        
        .table thead th {
            background: #f1f5f9 !important;
            border-color: #e2e8f0 !important;
            color: #1e293b !important;
        }
        
        .table td,
        .table th {
            border-color: #e2e8f0 !important;
        }
        
        .table-striped tbody tr:nth-of-type(odd) {
            background: #f1f5f9 !important;
        }
    
    /* Navegación y pestañas */
    .nav-tabs .nav-link {
        background: white !important;
        border: 1px solid #e2e8f0 !important;
        color: #64748b !important;
    }
    
    .nav-tabs .nav-link.active {
        background: white !important;
        border-color: var(--calm-secondary) !important;
        color: #1e293b !important;
    }
    
    .nav-pills .nav-link {
        color: #64748b !important;
    }
    
    .nav-pills .nav-link.active {
        background: var(--calm-secondary) !important;
        color: white !important;
    }
    
    /* Elementos de evaluación */
    .evaluation-item {
        background: white !important;
        border: 1px solid #dee2e6 !important;
        color: #333 !important;
        margin-bottom: 1rem;
        padding: 1rem;
        border-radius: 8px;
    }
    
    .evaluation-item:hover {
        background: #f8f9fa !important;
        border-color: #adb5bd !important;
    }
    
    /* Progress bars */
    .progress {
        background: #e9ecef !important;
    }
    
    .progress-bar {
        background: #007bff !important;
    }
    
    /* Tables con soporte de temas */
    .table-dark {
        background: white !important;
        color: #1e293b !important;
    }
    
    .table-dark th,
    .table-dark td {
        background: white !important;
        color: #1e293b !important;
        border-color: #e2e8f0 !important;
    }
    
    .table-hover tbody tr:hover {
        background: #f1f5f9 !important;
        color: #1e293b !important;
    }
    
    /* Estilos específicos del dashboard coach */
    
    .sidebar .nav-link:hover,
    .sidebar .list-group-item:hover {
        background: #f1f5f9 !important;
        color: #1e293b !important;
    }
    
    .sidebar .nav-link.active,
    .sidebar .list-group-item.active {
        background: var(--calm-secondary) !important;
        color: white !important;
        border-color: var(--calm-secondary) !important;
    }
    
    /* Estilos forzados para elementos específicos con soporte de temas */
    .sidebar .card[style*="background"] {
        background: white !important;
        background-color: white !important;
    }
    
    .sidebar .card-header[style*="background"] {
        background: #f1f5f9 !important;
        background-color: #f1f5f9 !important;
        color: #1e293b !important;
    }
    
    .sidebar h6[style*="color"] {
        color: #1e293b !important;
    }
    
    /* Timestamp actualizado para sistema de temas: 2025-10-19 */
    
    /* Elementos sidebar con máxima especificidad y soporte de temas */
    .sidebar *,
    .sidebar *.bg-dark,
    .sidebar *.bg-secondary,
    .sidebar *.bg-primary,
    .sidebar .card.bg-dark,
    .sidebar .card-header.bg-dark,
    .sidebar .card-body.bg-dark {
        background: white !important;
        background-color: white !important;
    }
    
    .sidebar .card-header *,
    .sidebar .card-header *.bg-dark {
        background: #f1f5f9 !important;
        background-color: #f1f5f9 !important;
        color: #1e293b !important;
    }
    
    /* Charts con soporte de temas */
    .chart-container {
        background: white !important;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        color: #1e293b;
    }
    
    /* Estilos profesionales para recomendaciones categorizadas - UNIFICADOS */
    .recommendations-container {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 16px;
        border: 2px solid var(--calm-accent);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }
    
    .recommendations-header {
        background: linear-gradient(135deg, var(--calm-primary) 0%, #1D4ED8 100%);
        color: white !important;
        padding: 1.5rem;
        border-bottom: 3px solid var(--calm-accent);
        position: relative;
    }
    
    .recommendations-header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--calm-accent) 0%, #0ea5e9 50%, var(--calm-accent) 100%);
    }
    
    .recommendation-category {
        background: white;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
        overflow: hidden;
        transition: all 0.3s ease;
        animation: fadeInUp 0.6s ease-out;
    }
    
    .recommendation-category:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        border-color: var(--calm-accent);
    }
    
    .category-header {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        border-bottom: 2px solid #e2e8f0;
        padding: 1rem 1.25rem;
        position: relative;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .category-title {
        font-weight: 700;
        color: var(--calm-primary);
        font-size: 1rem;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .category-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--calm-accent) 0%, #0ea5e9 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        margin-right: 0.75rem;
        animation: pulse 2s infinite;
    }
    
    .score-badge {
        background: linear-gradient(135deg, var(--calm-secondary) 0%, var(--calm-accent) 100%);
        color: white;
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    .priority-indicator {
        position: absolute;
        top: 0;
        right: 0;
        width: 0;
        height: 0;
        border-left: 15px solid transparent;
        border-top: 15px solid;
    }
    
    .priority-high {
        border-top-color: #ef4444;
    }
    
    .priority-medium {
        border-top-color: #f59e0b;
    }
    
    .priority-low {
        border-top-color: #06b6d4;
    }
    
    .priority-growth {
        border-top-color: #10b981;
    }
    
    .category-content {
        padding: 1.25rem;
    }
    
    .recommendation-item {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 8px;
        padding: 0.75rem 1rem;
        margin-bottom: 0.75rem;
        border-left: 4px solid var(--calm-accent);
        position: relative;
        transition: all 0.3s ease;
        transform: translateY(0);
    }
    
    .recommendation-item:hover {
        background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
        border-left-color: var(--calm-primary);
        transform: translateX(5px) translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-color: var(--bs-primary) !important;
    }
    
    .recommendation-item:before {
        content: "✓";
        position: absolute;
        left: -2px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        background: var(--calm-accent);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .recommendation-text {
        margin-left: 1.5rem;
        line-height: 1.6;
        color: #334155;
        font-weight: 500;
    }
    
    .general-recommendations {
        border: 2px solid var(--calm-primary);
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    }
    
    .general-recommendations .category-header {
        background: linear-gradient(135deg, var(--calm-primary) 0%, #1D4ED8 100%);
        color: white;
        border-bottom-color: var(--calm-primary);
    }
    
    .general-recommendations .category-title {
        color: white;
    }
    
    .strengths-category {
        border: 2px solid #10b981;
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    }
    
    .strengths-category .category-header {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border-bottom-color: #10b981;
    }
    
    .strengths-category .category-title {
        color: white;
    }
    
    .strengths-category .recommendation-item {
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        border-left-color: #10b981;
    }
    
    .strengths-category .recommendation-item:before {
        background: #10b981;
        content: "★";
    }
    
    .final-message {
        border: 2px solid #8b5cf6;
        background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
    }
    
    .final-message .category-header {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        border-bottom-color: #8b5cf6;
    }
    
    .final-message .category-title {
        color: white;
    }
    
    .final-message .recommendation-item {
        background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
        border-left-color: #8b5cf6;
    }
    
    /* Estilos especiales para subcategorías de dimensiones */
    .dimension-subcategory {
        border: 2px solid var(--calm-primary);
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        margin-bottom: 2rem;
    }
    
    .subcategory-header {
        background: linear-gradient(135deg, var(--calm-primary) 0%, #1D4ED8 100%);
        color: white;
        padding: 1.25rem;
        border-bottom: 3px solid var(--calm-accent);
    }
    
    .subcategory-title-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .subcategory-info {
        flex: 1;
    }
    
    .subcategory-title {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 700;
        color: white;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .action-list li {
        position: relative;
        padding-left: 0.5rem;
    }
    
    .action-list li:before {
        content: "→";
        position: absolute;
        left: -0.5rem;
        color: var(--bs-primary);
        font-weight: bold;
    }
    
    .item-number {
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .category-header {
            padding: 1rem !important;
        }
        
        .category-header .d-flex {
            flex-direction: column;
            text-align: center;
        }
        
        .category-icon {
            margin-bottom: 1rem;
        }
        
        .recommendation-item {
            padding: 1rem !important;
        }
        
        /* Mejoras para header en móviles */
        .dashboard-header {
            padding: 1rem !important;
        }
        
        .dashboard-header .d-flex {
            flex-direction: column !important;
            align-items: flex-start !important;
            gap: 1rem !important;
        }
        
        .dashboard-header .btn-group-mobile {
            display: flex !important;
            flex-direction: column !important;
            gap: 0.75rem !important;
            width: 100% !important;
        }
        
        .dashboard-header .btn-group-mobile .btn {
            flex: none !important;
            width: 100% !important;
            min-width: 0 !important;
            font-size: 0.875rem !important;
            padding: 0.75rem 1rem !important;
            justify-content: center !important;
            align-items: center !important;
            text-align: center !important;
            min-height: 44px !important;
        }
        
        /* MOSTRAR TEXTO EN MÓVILES - Forzar que el texto sea visible */
        .dashboard-header .btn-group-mobile .btn .d-none.d-sm-inline {
            display: inline !important;
        }
        
        /* CENTRAR ICONOS Y TEXTO EN MÓVILES */
        .dashboard-header .btn-group-mobile .btn .fas {
            margin-right: 0.5rem !important;
        }
        
        /* Mobile coachees cards */
        .coachee-card-mobile {
            margin-bottom: 1rem !important;
            border: 1px solid #e3e6f0 !important;
            border-radius: 8px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        }
        
        .coachee-card-mobile:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
            transform: translateY(-1px);
            transition: all 0.3s ease;
        }
        
        /* Task management mobile styles */
        #gestion-tareas .row.g-3 {
            margin-bottom: 1rem !important;
        }
        
        #gestion-tareas .col-md-6 {
            margin-bottom: 0.75rem !important;
        }
        
        #gestion-tareas .form-label {
            font-size: 0.875rem !important;
            margin-bottom: 0.25rem !important;
        }
        
        #gestion-tareas .form-control,
        #gestion-tareas .form-select {
            font-size: 0.875rem !important;
            padding: 0.5rem 0.75rem !important;
        }
        
        #gestion-tareas textarea.form-control {
            min-height: 80px !important;
        }
        
        #gestion-tareas .btn {
            padding: 0.5rem 1rem !important;
            font-size: 0.875rem !important;
        }
        
        /* Task cards mobile */
        #tasksCardsContainer .card {
            border: 1px solid #e3e6f0 !important;
            border-radius: 8px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08) !important;
            transition: all 0.3s ease !important;
        }
        
        #tasksCardsContainer .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            transform: translateY(-2px);
        }
        
        #tasksCardsContainer .card-title {
            font-size: 1rem !important;
            line-height: 1.3 !important;
        }
        
        #tasksCardsContainer .card-text {
            font-size: 0.875rem !important;
            line-height: 1.4 !important;
        }
        
        #tasksCardsContainer .btn-group .btn {
            padding: 0.25rem 0.5rem !important;
            font-size: 0.75rem !important;
        }
        
        #tasksCardsContainer .row.g-2 {
            margin-bottom: 0.5rem !important;
        }
        
        #tasksCardsContainer .small {
            font-size: 0.75rem !important;
        }
        
        /* Container fluid para móviles */
        .container-fluid {
            padding-left: 0.75rem !important;
            padding-right: 0.75rem !important;
        }
        
        /* Sidebar en móviles */
        .sidebar .card {
            margin-bottom: 1rem !important;
        }
        
        /* ========== CORRECCIÓN LAYOUT MIS COACHEES ========== */
        
        /* Contenedor principal sin overflow oculto */
        .container-fluid {
            overflow-x: visible !important;
        }
        
        /* Fila principal con mejor distribución */
        .row {
            margin-left: -0.75rem;
            margin-right: -0.75rem;
        }
        
        /* Sidebar optimizado */
        .col-md-3 {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }
        
        /* Área de contenido principal */
        .col-md-9 {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
            overflow: visible !important;
        }
        
        /* Card de Mis Coachees */
        #mis-coachees .card {
            margin-bottom: 1rem;
            border: 1px solid #dee2e6;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        /* Tabla responsiva SIN scroll horizontal */
        #mis-coachees .table-responsive {
            overflow-x: hidden !important;
            overflow-y: visible !important;
            margin: 0;
            padding: 0;
            border: none;
        }
        
        /* Tabla responsiva que se ajusta al contenedor */
        #mis-coachees .table {
            width: 100% !important;
            table-layout: fixed !important;
            margin-bottom: 0;
            font-size: 0.875rem;
            border-collapse: collapse;
        }
        
        /* Headers de tabla - Estilo moderno mejorado */
        #mis-coachees .table thead th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white !important;
            border-bottom: 3px solid #5a67d8;
            font-weight: 700;
            padding: 1rem 0.75rem;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* Celdas de tabla con manejo de overflow y estilos mejorados */
        #mis-coachees .table tbody td {
            padding: 1rem 0.875rem !important;
            vertical-align: middle;
            border-bottom: 2px solid #e2e8f0;
            overflow: visible !important;
            white-space: normal !important;
            font-size: 0.875rem;
            background: white;
            transition: all 0.3s ease;
        }
        
        /* Efecto hover en filas - Mejorado */
        #mis-coachees .table tbody tr {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #mis-coachees .table tbody tr:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #eff6ff 100%);
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }
        
        #mis-coachees .table tbody tr:hover td {
            background: transparent;
        }
        
        /* Avatar en tabla */
        #mis-coachees .coachee-avatar {
            transition: transform 0.2s ease;
        }
        
        #mis-coachees tr:hover .coachee-avatar {
            transform: scale(1.1);
        }
        
        /* Texto específico para celdas críticas */
        #mis-coachees .table td:nth-child(1),
        #mis-coachees .table td:nth-child(2) {
            font-size: 0.8rem !important;
            line-height: 1.2;
        }
        
        /* Columna de contraseña optimizada para mostrar texto completo */
        #mis-coachees .table td:nth-child(3) {
            font-family: monospace !important;
            font-size: 0.8rem !important;
            line-height: 1.3 !important;
            white-space: nowrap !important;
            overflow: visible !important;
            text-overflow: clip !important;
            padding: 0.4rem 0.2rem !important;
        }
        
        /* Asegurar que el texto de contraseña sea visible */
        #mis-coachees .table td:nth-child(3) .password-text {
            font-family: monospace !important;
            font-size: 0.8rem !important;
            min-width: auto !important;
            display: inline-block !important;
        }
        
        /* Headers también compactos */
        #mis-coachees .table thead th {
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
        }
        
        /* Botones modernos con mejor estilo */
        #mis-coachees .table .btn-sm {
            padding: 0.375rem 0.625rem !important;
            font-size: 0.75rem !important;
            margin: 0 0.25rem !important;
            border-radius: 6px;
            white-space: nowrap;
            line-height: 1.3;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        #mis-coachees .table .btn-outline-primary {
            color: #3B82F6 !important;
            border-color: #3B82F6 !important;
            background: white;
        }
        
        #mis-coachees .table .btn-outline-primary:hover {
            background: #3B82F6 !important;
            color: white !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }
        
        #mis-coachees .table .btn-outline-warning {
            color: #f59e0b !important;
            border-color: #f59e0b !important;
            background: white;
        }
        
        #mis-coachees .table .btn-outline-warning:hover {
            background: #f59e0b !important;
            color: white !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
        }
        
        #mis-coachees .table .btn-outline-success {
            color: #10b981 !important;
            border-color: #10b981 !important;
            background: white;
        }
        
        #mis-coachees .table .btn-outline-success:hover {
            background: #10b981 !important;
            color: white !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }
        
        #mis-coachees .table .btn-outline-secondary {
            color: #64748b !important;
            border-color: #cbd5e1 !important;
            background: white;
        }
        
        #mis-coachees .table .btn-outline-secondary:hover {
            background: #f1f5f9 !important;
            border-color: #94a3b8 !important;
            transform: translateY(-2px);
        }
        
        /* Contenedor de botones en columna Acciones sin padding extra */
        #mis-coachees .table td:nth-child(4) {
            padding: 0.3rem 0.2rem !important;
            overflow: visible !important;
            text-align: center !important;
        }
        
        #mis-coachees .table td:nth-child(4) .btn-group {
            display: flex;
            flex-direction: column;
            gap: 1px;
            align-items: center;
            width: 100%;
        }
        
        /* Botones específicos más pequeños */
        #mis-coachees .table .btn-success,
        #mis-coachees .table .btn-primary,
        #mis-coachees .table .btn-info,
        #mis-coachees .table .btn-warning {
            padding: 0.1rem 0.2rem !important;
            font-size: 0.6rem !important;
            min-width: auto !important;
            width: 100% !important;
            max-width: 100% !important;
        }
        
        /* Columnas específicas redistribuidas para 4 columnas - SIN ÚLTIMO ACCESO */
        #mis-coachees .table th:nth-child(1), 
        #mis-coachees .table td:nth-child(1) { 
            width: 20% !important;
            max-width: 20% !important;
        }
        
        #mis-coachees .table th:nth-child(2), 
        #mis-coachees .table td:nth-child(2) { 
            width: 30% !important;
            max-width: 30% !important;
        }
        
        #mis-coachees .table th:nth-child(3), 
        #mis-coachees .table td:nth-child(3) { 
            width: 35% !important;
            max-width: 35% !important;
        }
        
        #mis-coachees .table th:nth-child(4), 
        #mis-coachees .table td:nth-child(4) { 
            width: 15% !important;
            max-width: 15% !important;
            text-align: center !important; 
        }
        
        /* Cards móviles mejoradas - Estilo Landing Page Moderno */
        #coacheesCardsContainer .unified-card {
            margin-bottom: 1.5rem;
            border: 2px solid transparent;
            border-radius: 16px;
            overflow: hidden;
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #coacheesCardsContainer .unified-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 28px rgba(59, 130, 246, 0.2);
            border-color: #3B82F6;
        }
        
        #coacheesCardsContainer .unified-card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1.25rem;
            border-bottom: none;
        }
        
        #coacheesCardsContainer .unified-card-title {
            color: white !important;
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        #coacheesCardsContainer .unified-card-body {
            padding: 1.25rem;
            background: white;
        }
        
        #coacheesCardsContainer .coachee-details {
            display: flex;
            flex-direction: column;
            gap: 0.875rem;
        }
        
        #coacheesCardsContainer .meta-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }
        
        #coacheesCardsContainer .meta-item:hover {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-color: #3B82F6;
        }
        
        #coacheesCardsContainer .meta-item i {
            font-size: 1.125rem;
            color: #3B82F6;
            min-width: 20px;
            text-align: center;
        }
        
        #coacheesCardsContainer .meta-item span {
            font-size: 0.9rem;
            color: #1e293b;
            font-weight: 500;
        }
        
        #coacheesCardsContainer .unified-card-footer {
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-top: 1px solid #e2e8f0;
        }
        
        #coacheesCardsContainer .unified-card-footer .d-flex {
            gap: 0.625rem;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        
        #coacheesCardsContainer .unified-btn-sm {
            font-size: 0.8125rem;
            padding: 0.625rem 1rem;
            flex: 1 1 calc(50% - 0.3125rem);
            min-width: 0;
            text-align: center;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        #coacheesCardsContainer .unified-btn-primary {
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            color: white !important;
            border-color: transparent;
        }
        
        #coacheesCardsContainer .unified-btn-primary:hover {
            background: linear-gradient(135deg, #2563EB 0%, #1d4ed8 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        #coacheesCardsContainer .unified-btn-secondary {
            background: white;
            color: #64748b !important;
            border-color: #e2e8f0;
        }
        
        #coacheesCardsContainer .unified-btn-secondary:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            transform: translateY(-2px);
        }
        
        #coacheesCardsContainer .unified-btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white !important;
            border-color: transparent;
        }
        
        #coacheesCardsContainer .unified-btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        #coacheesCardsContainer .password-text {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            letter-spacing: 0.05em;
        }
        
        /* Results List Container */
        #coacheesCardsContainer .results-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 0.5rem 0;
        }
        
        @media (max-width: 768px) {
            #coacheesCardsContainer .results-list {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
        
        /* Empty State Moderno */
        #coacheesCardsContainer .unified-empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px;
            border: 2px dashed #cbd5e1;
            margin: 1rem 0;
        }
        
        #coacheesCardsContainer .unified-empty-state i {
            font-size: 4rem;
            color: #cbd5e1;
            margin-bottom: 1rem;
            display: block;
        }
        
        #coacheesCardsContainer .unified-empty-state p {
            color: #64748b;
            font-size: 1.125rem;
            font-weight: 500;
            margin: 0;
        }
        
        .sidebar .card-body {
            padding: 0.75rem !important;
        }
    }
    
        /* ========== RESPONSIVE MEJORADO PARA COACHEES ========== */
        
        /* Tablets landscape (768px - 1024px) */
        @media (min-width: 768px) and (max-width: 1024px) {
            .col-md-9 {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }
            
            #mis-coachees .table {
                font-size: 0.8rem !important;
            }
            
            #mis-coachees .table th,
            #mis-coachees .table td {
                padding: 0.5rem 0.3rem !important;
            }
            
            #mis-coachees .table .btn-sm {
                padding: 0.15rem 0.3rem !important;
                font-size: 0.65rem !important;
                margin: 0 1px !important;
            }
            
            /* Ajustes específicos para tablets */
            #mis-coachees .table th:nth-child(1), 
            #mis-coachees .table td:nth-child(1) { 
                width: 19% !important;
            }
            
            #mis-coachees .table th:nth-child(2), 
            #mis-coachees .table td:nth-child(2) { 
                width: 32% !important;
            }
            
            #mis-coachees .table th:nth-child(5), 
            #mis-coachees .table td:nth-child(5) { 
                width: 22% !important;
            }
        }
        
        /* Tablets portrait y móviles - Vista de cards */
        @media (max-width: 767px) {
            .col-md-3, .col-md-9 {
                flex: 0 0 100% !important;
                max-width: 100% !important;
                padding-left: 0.75rem !important;
                padding-right: 0.75rem !important;
            }
            
            .col-md-3 {
                margin-bottom: 1rem;
            }
            
            #mis-coachees .card-body {
                padding: 0.75rem !important;
            }
            
            /* Cards móviles mejoradas - Mantener estilo moderno */
            #coacheesCardsContainer .unified-card {
                margin-bottom: 1.25rem;
                border: 2px solid transparent;
                border-radius: 14px;
                box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            }
            
            #coacheesCardsContainer .unified-card-header {
                padding: 1rem;
            }
            
            #coacheesCardsContainer .unified-card-title {
                font-size: 1.125rem;
            }
            
            #coacheesCardsContainer .unified-card-body {
                padding: 1rem;
            }
            
            #coacheesCardsContainer .unified-card-footer {
                padding: 0.875rem 1rem;
            }
            
            #coacheesCardsContainer .unified-card-footer .d-flex {
                gap: 0.5rem;
                flex-wrap: wrap;
            }
            
            #coacheesCardsContainer .unified-btn-sm {
                font-size: 0.75rem;
                padding: 0.5rem 0.75rem;
                flex: 1 1 calc(50% - 0.25rem);
                min-width: 0;
                text-align: center;
            }
        }
        
        /* Móviles muy pequeños */
        @media (max-width: 575px) {
            #coacheesCardsContainer .unified-card {
                border-radius: 12px;
                margin-bottom: 1rem;
            }
            
            #coacheesCardsContainer .unified-card-header {
                padding: 0.875rem;
            }
            
            #coacheesCardsContainer .unified-card-title {
                font-size: 1rem;
            }
            
            #coacheesCardsContainer .unified-card-body {
                padding: 0.875rem;
            }
            
            #coacheesCardsContainer .meta-item {
                font-size: 0.8rem;
                padding: 0.625rem;
                margin-bottom: 0;
            }
            
            #coacheesCardsContainer .unified-card-footer {
                padding: 0.75rem;
            }
            
            #coacheesCardsContainer .unified-card-footer .d-flex {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            #coacheesCardsContainer .unified-btn-sm {
                flex: 1 1 100% !important;
                width: 100%;
                padding: 0.625rem;
            }
        }
            
            .col-md-3, .col-md-9 {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            /* Reducir sidebar en tablets para dar más espacio al contenido */
            .col-md-3 {
                flex: 0 0 25%;
                max-width: 25%;
            }
            
            .col-md-9 {
                flex: 0 0 75%;
                max-width: 75%;
            }
        
        
        /* Títulos más pequeños en móvil */
        .dashboard-header h3 {
            font-size: 2.25rem !important; /* Incrementado de 1.5rem (24px) a 2.25rem (36px) */
        }
        
        .dashboard-header p {
            font-size: 0.875rem !important;
        }
        
        /* Ajustes adicionales para textos en móvil */
        .small {
            font-size: 0.75rem !important;
        }
        
        /* Coachees cards para móvil */
        .coachee-card-mobile {
            background-color: white !important;
            border: 1px solid #dee2e6 !important;
            border-radius: 8px !important;
            margin-bottom: 1rem !important;
            padding: 1rem !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        }
        
        .coachee-card-mobile .coachee-header {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 0.75rem !important;
            border-bottom: 1px solid #eee !important;
            padding-bottom: 0.5rem !important;
        }
        
        .coachee-card-mobile .coachee-name {
            font-weight: 600 !important;
            font-size: 1rem !important;
            color: #212529 !important;
            margin: 0 !important;
        }
        
        .coachee-card-mobile .coachee-status {
            font-size: 0.75rem !important;
        }
        
        .coachee-card-mobile .coachee-details {
            margin-bottom: 0.75rem !important;
        }
        
        .coachee-card-mobile .coachee-detail-item {
            display: flex !important;
            justify-content: space-between !important;
            margin-bottom: 0.5rem !important;
            font-size: 0.85rem !important;
        }
        
        .coachee-card-mobile .coachee-detail-label {
            font-weight: 500 !important;
            color: #666 !important;
        }
        
        .coachee-card-mobile .coachee-detail-value {
            color: #212529 !important;
            text-align: right !important;
        }
        
        .coachee-card-mobile .coachee-actions {
            display: flex !important;
            gap: 0.5rem !important;
            justify-content: center !important;
        }
        
        .coachee-card-mobile .btn-sm {
            font-size: 0.75rem !important;
            padding: 0.25rem 0.5rem !important;
        }
        
        /* Estilos para botón de asignar */
        .btn-outline-success:hover {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }
        
        /* Estilos para el modal de asignación */
        #assignModal .nav-tabs .nav-link {
            color: #6c757d;
        }
        
        #assignModal .nav-tabs .nav-link.active {
            color: #28a745;
            border-color: #28a745;
        }
        
        #assignModal .tab-content {
            min-height: 300px;
        }
    
    /* Estilos adicionales para tablets */
    @media (max-width: 992px) {
        .dashboard-header .btn-group-mobile .btn {
            font-size: 0.8rem !important;
            padding: 0.4rem 0.6rem !important;
        }
        
        .stats-card-mobile h4 {
            font-size: 1.3rem !important;
        }
    }
    
    /* MÓVILES PEQUEÑOS - Mayor incremento del título */
    @media (max-width: 576px) {
        .dashboard-header h3 {
            font-size: 2rem !important; /* 32px para pantallas muy pequeñas */
        }
    }
    
    /* Estilos para evaluaciones del coachee */
    .summary-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .summary-icon {
        width: 40px;
        height: 40px;
        background: var(--bs-primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .summary-number {
        font-size: 1.2rem;
        font-weight: bold;
        color: #333;
    }
    
    .summary-label {
        font-size: 0.85rem;
        color: #666;
    }
    
    /* Estilos para evaluaciones disponibles */
    .assessment-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s;
        cursor: pointer;
        border: 2px solid transparent;
    }
    
    /* Skeleton loader styles */
    .skeleton-card {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .skeleton-header,
    .skeleton-text {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: skeleton-loading 1.5s infinite;
        border-radius: 4px;
    }
    
    .skeleton-header {
        height: 24px;
        width: 70%;
    }
    
    .skeleton-text {
        height: 16px;
        width: 100%;
    }
    
    .skeleton-text.short {
        width: 50%;
    }
    
    @keyframes skeleton-loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    
    .assessment-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }
    
    .assessment-card.selected {
        border-color: #4e73df;
        background-color: #f8f9fc;
    }
    
    .assessment-actions {
        border-top: 1px solid #e9ecef;
        padding-top: 1rem;
        margin-top: 1rem;
    }
    
    .assessment-actions .btn {
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .assessment-actions .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.15);
    }
    
    .assessment-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }
    
    .assessment-title {
        font-size: 1rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
    }
    
    .assessment-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        color: white !important;
        border: none;
    }
    
    .assessment-badge.bg-success {
        background: #28a745 !important;
        color: white !important;
    }
    
    .assessment-badge.bg-primary {
        background: #007bff !important;
        color: white !important;
    }
    
    .assessment-description {
        color: #6c757d;
        font-size: 0.875rem;
        line-height: 1.5;
        margin-bottom: 1rem;
    }
    
    .assessment-stats {
        display: flex;
        gap: 1.5rem;
        align-items: center;
        font-size: 0.85rem;
        color: #8b949e;
    }
    
    .assessment-stat {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .assessment-stat i {
        color: #4e73df;
    }
    
    /* Estilos para categorías de evaluaciones */
    .assessment-category {
        margin-bottom: 2.5rem;
        animation: fadeInUp 0.6s ease-out;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Estilos para el header colapsable */
    .section-header-eval {
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }
    
    .section-header-eval:active {
        transform: scale(0.99);
    }
    
    .category-container {
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    .category-container:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }
    
    .category-header-visual {
        position: relative;
        overflow: hidden;
    }
    
    .category-icon-large {
        animation: iconFloat 3s ease-in-out infinite;
    }
    
    @keyframes iconFloat {
        0%, 100% {
            transform: translateY(0px);
        }
        50% {
            transform: translateY(-10px);
        }
    }
    
    .category-count-badge {
        animation: pulseGlow 2s ease-in-out infinite;
    }
    
    @keyframes pulseGlow {
        0%, 100% {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        50% {
            box-shadow: 0 4px 20px rgba(255,255,255,0.4);
        }
    }
    
    .category-assessments-wrapper {
        background: white;
    }
    
    .category-assessments-wrapper .assessment-card {
        margin-bottom: 1rem;
        border-left: 3px solid transparent;
        transition: all 0.3s ease;
    }
    
    .category-assessments-wrapper .assessment-card:hover {
        border-left-color: currentColor;
        transform: translateX(5px);
    }
    
    /* Responsive styles para evaluaciones en móvil */
    @media (max-width: 768px) {
        .assessment-card {
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 8px;
        }
        
        .assessment-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .assessment-title {
            font-size: 1rem;
            line-height: 1.3;
        }
        
        .assessment-badge {
            align-self: flex-start;
            font-size: 0.7rem;
            padding: 0.2rem 0.6rem;
        }
        
        .assessment-badge.bg-success {
            background: #28a745 !important;
            color: white !important;
        }
        
        .assessment-badge.bg-primary {
            background: #007bff !important;
            color: white !important;
        }
        
        .assessment-description {
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }
        
        .assessment-stats {
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.8rem;
        }
        
        .assessment-stat {
            gap: 0.4rem;
            flex: 1;
            min-width: calc(50% - 0.5rem);
        }
        
        .assessment-stat i {
            font-size: 0.9rem;
        }
        
        /* Mejorar el spacing del spinner de carga */
        #assessments-loading {
            padding: 2rem 1rem !important;
        }
        
        /* Mejorar mensaje de no evaluaciones */
        #no-assessments {
            padding: 2rem 1rem !important;
        }
        
        #no-assessments i {
            font-size: 2.5rem !important;
            margin-bottom: 1rem !important;
        }
        
        #no-assessments h6 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        
        #no-assessments p {
            font-size: 0.85rem;
        }
        
        /* Mejorar alertas de error */
        #assessments-error {
            margin: 0;
            font-size: 0.85rem;
            padding: 0.75rem;
        }
    }
    
    /* Extra small devices (portrait phones, less than 576px) */
    @media (max-width: 575.98px) {
        .assessment-card {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .assessment-header {
            margin-bottom: 0.5rem;
        }
        
        .assessment-title {
            font-size: 0.95rem;
        }
        
        .assessment-description {
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }
        
        .assessment-stats {
            gap: 0.75rem;
            font-size: 0.75rem;
        }
        
        .assessment-stat {
            min-width: 100%;
            margin-bottom: 0.25rem;
        }
        
        /* Mejorar card-body padding en móvil */
        #seleccionar-evaluaciones .card-body {
            padding: 0.75rem !important;
        }
        
        /* Header más compacto en móvil */
        #seleccionar-evaluaciones .card-header {
            padding: 0.75rem !important;
        }
        
        #seleccionar-evaluaciones .card-header h5 {
            font-size: 1rem;
        }
        
        #seleccionar-evaluaciones .card-header .small {
            font-size: 0.75rem;
        }
        
        /* STATISTICS CARDS EN MÓVIL - GRILLA 2X2 IGUAL QUE COACHEE */
        .stats-card-mobile {
            margin-bottom: 1rem !important;
            padding: 0 0.5rem !important;
        }
        
        .stats-card-mobile .card {
            margin-bottom: 0 !important;
            min-height: 120px !important;
            border-radius: 1rem !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
        }
        
        .stats-card-mobile .card-body {
            padding: 1rem 0.5rem !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            text-align: center !important;
        }
        
        .stats-card-mobile h4 {
            font-size: 1.5rem !important;
            margin-bottom: 0.3rem !important;
        }
        
        .stats-card-mobile .text-muted {
            font-size: 0.75rem !important;
            line-height: 1.2 !important;
        }
        
        .stats-card-mobile i {
            font-size: 1.2rem !important;
            margin-bottom: 0.5rem !important;
        }
    }
    
    /* RESPONSIVE PARA ESTADÍSTICAS - MÓVIL */
    @media (max-width: 768px) {
        .stats-card-mobile {
            margin-bottom: 1rem !important;
            height: 100% !important;
        }
        
        .stats-card-mobile .card {
            height: 100% !important;
            min-height: 130px !important;
            border-radius: 1rem !important;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08) !important;
        }
        
        .stats-card-mobile .card:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 6px 16px rgba(0,0,0,0.12) !important;
        }
        
        .stats-card-mobile .card-body {
            padding: 1.25rem 1rem !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            text-align: center !important;
        }
        
        .stats-card-mobile h4 {
            font-size: 2.2rem !important;
            margin-bottom: 0.5rem !important;
            font-weight: 700 !important;
        }
        
        .stats-card-mobile .text-muted {
            font-size: 0.95rem !important;
            line-height: 1.3 !important;
            text-align: center !important;
        }
        
        .stats-card-mobile i {
            font-size: 2rem !important;
            margin-bottom: 0.75rem !important;
        }
    }
    
    /* Touch-friendly interactions */
    @media (hover: none) and (pointer: coarse) {
        .assessment-card:hover {
            transform: none;
        }
        
        .assessment-card:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }
    }
    
    /* High contrast mode for accessibility */
    @media (prefers-contrast: high) {
        .assessment-card {
            border-width: 2px;
        }
        
        .assessment-badge {
            border: 1px solid #4e73df;
        }
    }
    
    /* Reduced motion preferences */
    @media (prefers-reduced-motion: reduce) {
        .assessment-card {
            transition: none;
        }
        
        .assessment-card:hover {
            transform: none;
        }
    }
    
    /* Estilos adicionales para interacciones móviles */
    .selection-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #28a745;
        color: white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        animation: selectionPulse 0.3s ease-out;
        z-index: 10;
    }
    
    @keyframes selectionPulse {
        0% {
            transform: scale(0);
            opacity: 0;
        }
        50% {
            transform: scale(1.2);
            opacity: 1;
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }
    
    .assessment-card.selected {
        border-color: #28a745;
        box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25);
        background: rgba(40, 167, 69, 0.05);
    }
    
    .assessment-preview-card {
        background: rgba(13, 110, 253, 0.1);
        border: 1px solid rgba(13, 110, 253, 0.3);
        border-radius: 8px;
        padding: 1rem;
    }
    
    /* Mejoras para modales en móvil */
    @media (max-width: 575.98px) {
        .modal-dialog {
            margin: 0.5rem;
        }
        
        .modal-content {
            border-radius: 12px;
        }
        
        .modal-header {
            padding: 1rem;
        }
        
        .modal-title {
            font-size: 1.1rem;
        }
        
        .modal-body {
            padding: 1rem;
        }
        
        .modal-footer {
            padding: 1rem;
            gap: 0.5rem;
        }
        
        .assessment-preview-card {
            padding: 0.75rem;
        }
    }
    
    /* Botones táctiles mejorados */
    @media (hover: none) and (pointer: coarse) {
        .assessment-card {
            transition: background-color 0.2s ease;
        }
        
        .assessment-card:active {
            background: rgba(13, 110, 253, 0.1);
            transform: scale(0.98);
        }
        
        .btn {
            min-height: 44px;
            padding: 0.75rem 1rem;
        }
        
        .btn-sm {
            min-height: 40px;
            padding: 0.5rem 0.75rem;
        }
    }
    
    .evaluation-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        position: relative;
    }
    
    .evaluation-card.recent-evaluation {
        border-left: 4px solid #28a745;
    }
    
    .recent-badge {
        position: absolute;
        top: -8px;
        right: 1rem;
        background: #28a745;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .evaluation-icon {
        width: 45px;
        height: 45px;
        background: var(--bs-primary);
        color: white;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .evaluation-title {
        color: #333;
        font-weight: 600;
        margin: 0;
    }
    
    .evaluation-meta {
        display: flex;
        gap: 1rem;
    }
    
    .meta-item {
        font-size: 0.85rem;
        color: #666;
    }
    
    .score-display {
        text-align: center;
        margin-bottom: 0.5rem;
    }
    
    .score-display.score-low { color: #dc3545; }      /* Rojo - Bajo 40% */
    .score-display.score-medium { color: #007bff; }   /* Azul - 40-79% */
    .score-display.score-high { color: #28a745; }     /* Verde - 80%+ */
    
    .score-number {
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1;
    }
    
    .score-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .section-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }
    
    .interpretation-text {
        font-size: 0.9rem;
        color: #666;
        line-height: 1.5;
        margin: 0;
    }
    
    .dimensions-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .dimension-item {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 0.5rem;
        flex: 1;
        min-width: 120px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .dimension-name {
        font-size: 0.8rem;
        color: #666;
    }
    
    .dimension-score {
        font-weight: 600;
        color: #333;
    }
    
    .evaluation-actions .btn-block {
        width: 100%;
    }
    
    .quick-stats {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
    }
    
    .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .stat-item:last-child {
        margin-bottom: 0;
    }
    
    .stat-label {
        font-size: 0.8rem;
        color: #666;
    }
    
    .stat-value {
        font-weight: 600;
        color: #333;
    }
    
    /* FORZAR GRID 2X2 EN MÓVIL PARA ESTADÍSTICAS - SÚPER ESPECÍFICO */
    @media (max-width: 767.98px) {
        .row.mb-4 > .stats-card-mobile {
            flex: 0 0 50% !important;
            max-width: 50% !important;
            width: 50% !important;
            height: 140px !important;
        }
        
        .stats-card-mobile {
            padding: 0 0.5rem !important;
            height: 140px !important;
        }
        
        .stats-card-mobile .card {
            width: 100% !important;
            height: 140px !important;
            min-height: 140px !important;
            max-height: 140px !important;
            margin-bottom: 1rem !important;
            display: flex !important;
            flex-direction: column !important;
        }
        
        .stats-card-mobile .card-body {
            flex: 1 !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            text-align: center !important;
            padding: 1rem 0.75rem !important;
        }
        
        .stats-card-mobile h4 {
            font-size: 1.5rem !important;
            margin-bottom: 0.25rem !important;
            font-weight: 600 !important;
            line-height: 1.2 !important;
        }
        
        .stats-card-mobile .text-muted,
        .stats-card-mobile .small {
            font-size: 0.75rem !important;
            line-height: 1.1 !important;
            margin-bottom: 0 !important;
        }
        
        .stats-card-mobile i,
        .stats-card-mobile .fa-2x {
            font-size: 1.4rem !important;
            margin-bottom: 0.4rem !important;
        }
    }
    
    /* IGUALAR TAMAÑOS EN DESKTOP TAMBIÉN */
    @media (min-width: 768px) {
        .stats-card-mobile {
            height: 160px !important;
        }
        
        .stats-card-mobile .card {
            height: 160px !important;
            min-height: 160px !important;
            max-height: 160px !important;
            display: flex !important;
            flex-direction: column !important;
        }
        
        .stats-card-mobile .card-body {
            flex: 1 !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            text-align: center !important;
        }
    }
    
    /* ESTILOS ESPECÍFICOS PARA MODAL DE INVITACIÓN */
    #invitationSuccessModal {
        z-index: 10000 !important;
    }
    
    #invitationSuccessModal .modal-backdrop {
        z-index: 9999 !important;
    }
    
    #invitationSuccessModal .modal-dialog {
        z-index: 10001 !important;
    }
    
    #invitationSuccessModal .modal-content {
        border-radius: 12px !important;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2) !important;
    }
    
    #invitationSuccessModal .modal-header {
        border-top-left-radius: 12px !important;
        border-top-right-radius: 12px !important;
    }
    
    #invitationMessage {
        max-height: 300px !important;
        overflow-y: auto !important;
        border: 1px solid #dee2e6 !important;
        border-radius: 6px !important;
        background: #ffffff !important;
    }
    
    .invitation-message-container {
        position: relative !important;
    }
    
    .invitation-message-container:hover {
        border-color: #0d6efd !important;
    }
    
    /* FORZAR ACCESIBILIDAD DEL MODAL - SIN BACKDROP */
    .modal-backdrop {
        display: none !important;
        opacity: 0 !important;
    }
    
    body.modal-open {
        overflow: auto !important;
    }
    
    /* Asegurar que todos los elementos del modal sean clickeables */
    #invitationSuccessModal * {
        pointer-events: auto !important;
    }
    
    #invitationSuccessModal .modal-content {
        pointer-events: auto !important;
        position: relative !important;
        z-index: 10002 !important;
    }
    
    /* Asegurar que los botones del modal siempre sean clickeables */
    #invitationSuccessModal .btn {
        pointer-events: auto !important;
        position: relative !important;
        z-index: 10003 !important;
    }
    
    /* Modal sin backdrop - más prominente */
    #invitationSuccessModal .modal-dialog {
        box-shadow: 0 10px 30px rgba(0,0,0,0.3) !important;
        border: 2px solid #28a745 !important;
        border-radius: 10px !important;
    }
    
    
    /* Botones del modal siempre accesibles */
    #invitationSuccessModal button {
        cursor: pointer !important;
        pointer-events: auto !important;
        z-index: 10002 !important;
        position: relative !important;
    }
    
    /* ========== ESTILOS PARA CALENDARIO MEJORADO ========== */
    
    /* Estilo general del calendario */
    #calendar {
        border-radius: 10px !important;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1) !important;
        overflow: hidden !important;
    }
    
    /* Botones de navegación de vista */
    .fc-button-group {
        border-radius: 6px !important;
        overflow: hidden !important;
    }
    
    .fc-button {
        border: none !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        font-weight: 500 !important;
        padding: 8px 12px !important;
        transition: all 0.3s ease !important;
    }
    
    .fc-button:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%) !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4) !important;
    }
    
    .fc-button-active {
        background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%) !important;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.2) !important;
    }
    
    /* Header del calendario */
    .fc-header-toolbar {
        padding: 1rem !important;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
        border-bottom: 1px solid #dee2e6 !important;
    }
    
    .fc-toolbar-title {
        font-size: 1.5rem !important;
        font-weight: 600 !important;
        color: #495057 !important;
    }
    
    /* Vista de mes */
    .fc-daygrid-day {
        transition: background-color 0.2s ease !important;
    }
    
    .fc-daygrid-day:hover {
        background-color: rgba(102, 126, 234, 0.05) !important;
    }
    
    .fc-daygrid-day-number {
        color: #495057 !important;
        font-weight: 500 !important;
        padding: 4px 8px !important;
        text-decoration: none !important;
    }
    
    .fc-daygrid-day-number:hover {
        background-color: rgba(102, 126, 234, 0.1) !important;
        border-radius: 4px !important;
        cursor: pointer !important;
    }
    
    /* Vista de semana */
    .fc-timegrid-slot {
        height: 2em !important;
    }
    
    .fc-timegrid-slot-label {
        color: #6c757d !important;
        font-size: 0.85rem !important;
    }
    
    /* Vista de día */
    .fc-timegrid-day {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%) !important;
    }
    
    /* Eventos del calendario */
    .fc-event {
        border-radius: 6px !important;
        border: none !important;
        font-size: 0.85rem !important;
        font-weight: 500 !important;
        margin: 1px !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        transition: all 0.3s ease !important;
        cursor: pointer !important;
    }
    
    .fc-event:hover {
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important;
    }
    
    .fc-event-title {
        padding: 2px 6px !important;
    }
    
    /* Responsivo para calendario */
    @media (max-width: 768px) {
        .fc-header-toolbar {
            flex-direction: column !important;
            gap: 0.5rem !important;
        }
        
        .fc-toolbar-chunk {
            display: flex !important;
            justify-content: center !important;
        }
        
        .fc-button {
            font-size: 0.8rem !important;
            padding: 6px 8px !important;
        }
        
        .fc-toolbar-title {
            font-size: 1.2rem !important;
            margin-bottom: 0.5rem !important;
        }
    }

    /* ========== MEJORAS RESPONSIVAS PARA AGENDA MODULE ========== */
    @media (max-width: 768px) {
        /* Agenda Module - Pestañas responsivas */
        #agendaTabs {
            flex-wrap: nowrap !important;
            overflow-x: auto !important;
            border-bottom: 1px solid #dee2e6 !important;
            scrollbar-width: none !important; /* Firefox */
            -ms-overflow-style: none !important; /* IE/Edge */
        }
        
        #agendaTabs::-webkit-scrollbar {
            display: none !important; /* Chrome/Safari */
        }
        
        #agendaTabs .nav-item {
            flex-shrink: 0 !important;
        }
        
        #agendaTabs .nav-link {
            white-space: nowrap !important;
            padding: 8px 12px !important;
            font-size: 0.85rem !important;
        }
        
        /* Disponibilidad Form - Layout vertical en mobile */
        #availability-pane .row .col-md-6 {
            margin-bottom: 1rem !important;
        }
        
        #availability-pane .d-flex.flex-wrap {
            flex-direction: column !important;
            gap: 0.5rem !important;
        }
        
        #availability-pane .form-check {
            margin-bottom: 0.5rem !important;
        }
        
        /* Selector de días responsivo */
        .days-selector .form-check {
            margin-bottom: 0.75rem !important;
        }
        
        .days-selector .form-check-label {
            font-size: 0.9rem !important;
            cursor: pointer !important;
        }
        
        .days-selector .form-check-input {
            margin-top: 0.25rem !important;
        }
        
        /* Botones de disponibilidad más espaciados */
        #availability-pane .btn-group {
            flex-direction: column !important;
            width: 100% !important;
        }
        
        #availability-pane .btn-group .btn {
            border-radius: 0.375rem !important;
            margin-bottom: 0.5rem !important;
        }
        
        /* Agenda Cards - Stack vertical en mobile */
        #agenda .card-body {
            padding: 0.75rem !important;
        }
        
        /* Calendar container padding */
        #calendar {
            font-size: 0.85rem !important;
        }
    }

    @media (max-width: 576px) {
        /* Mobile específico para agenda */
        #agendaTabs .nav-link {
            padding: 6px 8px !important;
            font-size: 0.8rem !important;
        }
        
        #agendaTabs .nav-link i {
            margin-right: 4px !important;
        }
        
        /* Ocultar texto en iconos en pantallas muy pequeñas */
        #agendaTabs .nav-link span {
            display: none !important;
        }
        
        /* Formulario de disponibilidad más compacto */
        #availability-pane .form-label {
            font-size: 0.9rem !important;
            margin-bottom: 0.25rem !important;
        }
        
        #availability-pane .form-select,
        #availability-pane .form-control {
            font-size: 0.9rem !important;
            padding: 0.5rem !important;
        }
        
        /* Calendar más compacto */
        .fc-button {
            font-size: 0.7rem !important;
            padding: 4px 6px !important;
        }
        
        .fc-toolbar-title {
            font-size: 1rem !important;
        }
    }

    /* Tablet específico para agenda */
    @media (min-width: 769px) and (max-width: 1024px) {
        #agenda .col-lg-8 {
            margin-bottom: 1.5rem !important;
        }
        
        #agendaTabs .nav-link {
            padding: 10px 16px !important;
        }
        
        /* Formulario de disponibilidad en 2 columnas en tablet */
        #availability-pane .row.g-3 {
            margin: 0 !important;
        }
        
        #availability-pane .col-md-6 {
            padding: 0 0.5rem !important;
        }
    }
    
    /* Animaciones para cambios de vista */
    .fc-view {
        animation: fadeIn 0.3s ease !important;
    }

    /* === BOTTOM NAVIGATION BAR === */
    .bottom-navigation {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: white;
        border-top: 1px solid #dbdbdb;
        display: flex;
        justify-content: space-around;
        align-items: center;
        z-index: 1000;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }
    
    .nav-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border: none;
        background: transparent;
        cursor: pointer;
        padding: 8px;
        transition: color 0.2s;
        color: #8e8e8e;
        text-decoration: none;
    }
    
    .nav-item i {
        font-size: 24px;
        margin-bottom: 4px;
    }
    
    .nav-item span {
        font-size: 11px;
        font-weight: 500;
    }
    
    .nav-item:hover,
    .nav-item.active {
        color: #0a66c2;
    }
    
    .nav-item.active {
        color: #262626;
    }
    
    /* Espacio inferior para evitar que el contenido quede debajo del nav */
    body {
        padding-bottom: 70px;
    }
    
    /* Tema oscuro para bottom navigation */
    [data-theme="dark"] .bottom-navigation {
        background: #1a1a1a;
        border-top-color: #2a2a2a;
    }
    
    [data-theme="dark"] .nav-item {
        color: #8e8e8e;
    }
    
    [data-theme="dark"] .nav-item:hover,
    [data-theme="dark"] .nav-item.active {
        color: #0a66c2;
    }
    
    /* Efectos hover para tarjetas de estadísticas */
    .row.mb-4 .card:hover {
        transform: translateY(-6px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2) !important;
    }
    
    .row.mb-4 .card {
        cursor: pointer;
    }
    </style>
</head>
<body>
    <!-- Animated background particles -->
    <div class="particles">
        <!-- Particles will be generated by JavaScript -->
    </div>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3); overflow: hidden;">
                <div class="card-body p-3 p-md-4">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="header-info">
                            <h3 class="text-white mb-2" style="font-family: 'Lobster Two', cursive; font-size: clamp(24px, 5vw, 40px); font-weight: 400; letter-spacing: 0.5px; text-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; align-items: center; flex-wrap: wrap; gap: 8px;">
                                <span style="display: inline-flex; align-items: center; justify-content: center; width: clamp(32px, 8vw, 46px); height: clamp(32px, 8vw, 46px); background: white; border: 2px solid #3B82F6; border-radius: 8px; font-family: 'Lobster Two', cursive; font-size: clamp(16px, 4vw, 24px); font-weight: 700; color: #1a1a1a; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); letter-spacing: -1px; flex-shrink: 0;">IC</span>
                                <span style="white-space: nowrap;">InstaCoach</span>
                            </h3>
                            <p class="text-white mb-0" style="font-size: clamp(13px, 2.5vw, 16px); opacity: 0.95; font-weight: 500;">
                                <i class="fas fa-user-tie me-1 me-md-2"></i>Bienvenido Coach <span id="coachName" style="font-weight: 600;"></span>
                            </p>
                        </div>
                        <div class="d-flex align-items-center gap-2 gap-md-3">
                            <div class="text-end me-2 me-md-3 d-none d-md-block">
                                <p class="text-white mb-0" style="font-size: 14px; opacity: 0.9;" id="currentDate"></p>
                                <p class="text-white mb-0" style="font-size: 12px; opacity: 0.8;" id="currentTime"></p>
                            </div>
                            <div class="user-avatar" id="headerCoachAvatar" style="width: clamp(44px, 10vw, 56px); height: clamp(44px, 10vw, 56px); border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; color: #667eea; font-size: clamp(18px, 4vw, 24px); font-weight: 700; border: 2px solid rgba(255,255,255,0.5); box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.2s; flex-shrink: 0;">
                                <i class="fas fa-user-tie"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4 g-2 g-md-3">
        <div class="col-6 col-md-3 stats-card-mobile">
            <div class="card border-0 text-center h-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); transition: transform 0.2s, box-shadow 0.2s;">
                <div class="card-body p-2 p-md-3">
                    <div style="width: clamp(36px, 8vw, 48px); height: clamp(36px, 8vw, 48px); background: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin: 0 auto clamp(8px, 2vw, 12px);">
                        <i class="fas fa-users" style="font-size: clamp(18px, 4vw, 24px); color: #667eea;"></i>
                    </div>
                    <h3 class="text-white mb-1" id="totalCoachees" style="font-weight: 700; font-size: clamp(24px, 6vw, 32px); line-height: 1.2;">0</h3>
                    <p class="text-white mb-0" style="font-size: clamp(12px, 3vw, 14px); opacity: 0.95; font-weight: 500;">Total Coachees</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 stats-card-mobile">
            <div class="card border-0 text-center h-100" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 10px; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3); transition: transform 0.2s, box-shadow 0.2s;">
                <div class="card-body p-2 p-md-3">
                    <div style="width: clamp(36px, 8vw, 48px); height: clamp(36px, 8vw, 48px); background: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin: 0 auto clamp(8px, 2vw, 12px);">
                        <i class="fas fa-clipboard-check" style="font-size: clamp(18px, 4vw, 24px); color: #10b981;"></i>
                    </div>
                    <h3 class="text-white mb-1" id="completedAssessments" style="font-weight: 700; font-size: clamp(24px, 6vw, 32px); line-height: 1.2;">0</h3>
                    <p class="text-white mb-0" style="font-size: clamp(12px, 3vw, 14px); opacity: 0.95; font-weight: 500;">Evaluaciones Completadas</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 stats-card-mobile">
            <div class="card border-0 text-center h-100" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 10px; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3); transition: transform 0.2s, box-shadow 0.2s;">
                <div class="card-body p-2 p-md-3">
                    <div style="width: clamp(36px, 8vw, 48px); height: clamp(36px, 8vw, 48px); background: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin: 0 auto clamp(8px, 2vw, 12px);">
                        <i class="fas fa-hourglass-half" style="font-size: clamp(18px, 4vw, 24px); color: #f59e0b;"></i>
                    </div>
                    <h3 class="text-white mb-1" id="pendingAssessments" style="font-weight: 700; font-size: clamp(24px, 6vw, 32px); line-height: 1.2;">0</h3>
                    <p class="text-white mb-0" style="font-size: clamp(12px, 3vw, 14px); opacity: 0.95; font-weight: 500;">Evaluaciones Pendientes</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 stats-card-mobile">
            <div class="card border-0 text-center h-100" style="background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); border-radius: 10px; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3); transition: transform 0.2s, box-shadow 0.2s;">
                <div class="card-body p-2 p-md-3">
                    <div style="width: clamp(36px, 8vw, 48px); height: clamp(36px, 8vw, 48px); background: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin: 0 auto clamp(8px, 2vw, 12px);">
                        <i class="fas fa-chart-line" style="font-size: clamp(18px, 4vw, 24px); color: #3B82F6;"></i>
                    </div>
                    <h3 class="text-white mb-1" id="avgScore" style="font-weight: 700; font-size: clamp(24px, 6vw, 32px); line-height: 1.2;">0%</h3>
                    <p class="text-white mb-0" style="font-size: clamp(12px, 3vw, 14px); opacity: 0.95; font-weight: 500;">Promedio General</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Sidebar Navigation -->
        <div class="col-md-3">
            <div class="card sidebar sidebar-white sidebar-force-white" style="background: white !important; background-color: white !important; border: 2px solid #e2e8f0 !important; border-radius: 16px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); overflow: hidden;">
                <div class="card-header sidebar-header-white sidebar-header-force" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; background-color: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; border-bottom: none !important; padding: 1.5rem 1.25rem;">
                    <h5 class="mb-0 sidebar-title-white sidebar-title-force" style="color: white !important; font-weight: 700 !important; font-size: 1.4rem; display: flex; align-items: center;">
                        <i class="fas fa-tachometer-alt me-3" style="color: #fbbf24 !important; font-size: 1.5rem;"></i>Panel de Control
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <a href="javascript:void(0)" class="list-group-item list-group-item-action active" 
                           onclick="showModule('mis-coachees'); return false;" data-module="mis-coachees"
                           style="border: none; border-bottom: 1px solid #e2e8f0 !important; padding: 1rem 1.25rem; transition: all 0.2s; font-weight: 500;">
                            <i class="fas fa-users me-3" style="width: 20px; text-align: center; color: #667eea;"></i>Mis Coachees
                        </a>
                        <a href="javascript:void(0)" class="list-group-item list-group-item-action" 
                           onclick="showModule('invitar-coachee'); return false;" data-module="invitar-coachee"
                           style="border: none; border-bottom: 1px solid #e2e8f0 !important; padding: 1rem 1.25rem; transition: all 0.2s; font-weight: 500;">
                            <i class="fas fa-envelope me-3" style="width: 20px; text-align: center; color: #667eea;"></i>Invitar Coachee
                        </a>
                        <a href="javascript:void(0)" class="list-group-item list-group-item-action" 
                           onclick="showModule('gestion-tareas'); return false;" data-module="gestion-tareas"
                           style="border: none; border-bottom: 1px solid #e2e8f0 !important; padding: 1rem 1.25rem; transition: all 0.2s; font-weight: 500;">
                            <i class="fas fa-tasks me-3" style="width: 20px; text-align: center; color: #667eea;"></i>Gestión de Acciones y Metas
                        </a>
                        <a href="javascript:void(0)" class="list-group-item list-group-item-action" 
                           onclick="showModule('seleccionar-evaluaciones'); return false;" data-module="seleccionar-evaluaciones"
                           style="border: none; border-bottom: 1px solid #e2e8f0 !important; padding: 1rem 1.25rem; transition: all 0.2s; font-weight: 500;">
                            <i class="fas fa-clipboard-list me-3" style="width: 20px; text-align: center; color: #667eea;"></i>Evaluaciones Disponibles
                        </a>
                        <a href="javascript:void(0)" class="list-group-item list-group-item-action" 
                           onclick="showModule('evaluaciones-pendientes'); return false;" data-module="evaluaciones-pendientes"
                           style="border: none; border-bottom: 1px solid #e2e8f0 !important; padding: 1rem 1.25rem; transition: all 0.2s; font-weight: 500;">
                            <i class="fas fa-hourglass-half me-3" style="width: 20px; text-align: center; color: #667eea;"></i>Evaluaciones Pendientes
                        </a>
                        <a href="javascript:void(0)" class="list-group-item list-group-item-action" 
                           onclick="showModule('crear-cargar-evaluaciones'); return false;" data-module="crear-cargar-evaluaciones"
                           style="border: none; border-bottom: 1px solid #e2e8f0 !important; padding: 1rem 1.25rem; transition: all 0.2s; font-weight: 500;">
                            <i class="fas fa-file-upload me-3" style="width: 20px; text-align: center; color: #667eea;"></i>Crear Nueva Evaluacion (En Proceso)
                        </a>
                        <a href="javascript:void(0)" class="list-group-item list-group-item-action" 
                           onclick="showModule('agregar-contenido'); return false;" data-module="agregar-contenido"
                           style="border: none; border-bottom: 1px solid #e2e8f0 !important; padding: 1rem 1.25rem; transition: all 0.2s; font-weight: 500;">
                            <i class="fas fa-plus-circle me-3" style="width: 20px; text-align: center; color: #667eea;"></i>Compartir Contenido
                        </a>
                        <a href="javascript:void(0)" class="list-group-item list-group-item-action" 
                           onclick="showModule('agenda'); return false;" data-module="agenda"
                           style="border: none; padding: 1rem 1.25rem; transition: all 0.2s; font-weight: 500;">
                            <i class="fas fa-calendar-alt me-3" style="width: 20px; text-align: center; color: #667eea;"></i>Mi Agenda
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="col-md-9" style="padding-left: 0.75rem; padding-right: 0.75rem; overflow: visible;">
            <!-- Mis Coachees Module -->
            <div id="mis-coachees" class="module-content">
                <div class="card sidebar-white border-secondary" style="background-color: white !important; margin-bottom: 1rem; border-radius: 16px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); overflow: hidden; border: 2px solid #e2e8f0 !important;">
                    <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; border-bottom: none !important; padding: 1.25rem;">
                        <h5 class="mb-0" style="color: white !important; font-weight: 700; font-size: 1.5rem; display: flex; align-items: center;">
                            <i class="fas fa-users me-3" style="font-size: 1.75rem;"></i>Mis Coachees
                        </h5>
                        <p class="mb-0 mt-2" style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem;">Gestiona y visualiza tu equipo de coachees</p>
                    </div>
                    <div class="card-body" style="background-color: white !important; padding: 1.5rem; overflow: visible;">
        <!-- Vista tabla para desktop -->
        <div class="d-none d-md-block" style="margin: 0; padding: 0; overflow: hidden;">
            <table class="table table-striped table-hover" style="margin-bottom: 0; width: 100%; table-layout: fixed;">
                <thead class="table-light">
                    <tr>
                        <th style="color: #212529; padding: 0.5rem 0.3rem; font-size: 0.85rem;">Nombre</th>
                        <th style="color: #212529; padding: 0.5rem 0.3rem; font-size: 0.85rem;">Email</th>
                        <th style="color: #212529; padding: 0.5rem 0.3rem; font-size: 0.85rem;">Contraseña</th>
                        <th style="color: #212529; padding: 0.5rem 0.3rem; text-align: center; font-size: 0.85rem;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="coacheesTableBody">
                    <tr>
                        <td colspan="4" class="text-center text-muted" style="padding: 2rem;">Cargando coachees...</td>
                    </tr>
                </tbody>
            </table>
        </div>                        <!-- Vista cards para móvil -->
                        <div class="d-block d-md-none" id="coacheesCardsContainer">
                            <div class="text-center text-muted p-3">Cargando coachees...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gestión de Acciones y Metas Module -->
            <div id="gestion-tareas" class="module-content" style="display: none;">
                <div class="card sidebar-white border-secondary" style="background-color: white !important; margin-bottom: 1rem; border-radius: 16px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); overflow: hidden; border: 2px solid #e2e8f0 !important;">
                    <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; border-bottom: none !important; padding: 1.25rem;">
                        <h5 class="mb-0" style="color: white !important; font-weight: 700; font-size: 1.5rem; display: flex; align-items: center;">
                            <i class="fas fa-tasks me-3" style="font-size: 1.75rem;"></i>Gestión de Acciones y Metas
                        </h5>
                        <p class="mb-0 mt-2" style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem;">Crea y gestiona acciones y metas para tus coachees</p>
                    </div>
                    <div class="card-body" style="background-color: white !important; padding: 1.5rem;">
                        
                        <!-- Formulario de Creación de Acciones y Metas -->
                        <div class="card mb-4" style="border: 2px solid #e2e8f0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                            <div class="card-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important; border-bottom: none !important; padding: 1rem 1.25rem;">
                                <h6 class="mb-0" style="color: white !important; font-weight: 600; font-size: 1.1rem;">
                                    <i class="fas fa-plus-circle me-2"></i>Crear Nueva Acción o Meta
                                </h6>
                            </div>
                            <div class="card-body" style="padding: 1.5rem;">
                                <!-- Formulario responsive -->
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label text-dark small fw-bold">
                                            <i class="fas fa-heading me-1 text-primary"></i>Título
                                        </label>
                                        <input type="text" class="form-control border-secondary" 
                                               placeholder="Ingrese el título de la acción o meta" id="taskTitle" 
                                               style="background-color: white; color: #212529; border-radius: 8px; border: 2px solid #e2e8f0;">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-dark small fw-bold">
                                            <i class="fas fa-tag me-1 text-primary"></i>Categoría
                                        </label>
                                        <select class="form-select border-secondary" id="taskCategory" 
                                                style="background-color: white; color: #212529; border-radius: 8px; border: 2px solid #e2e8f0;">
                                            <option value="">Seleccionar categoría</option>
                                            <option value="personalidad">Personalidad</option>
                                            <option value="liderazgo">Liderazgo</option>
                                            <option value="inteligencia_emocional">Inteligencia Emocional</option>
                                            <option value="trabajo_equipo">Trabajo en Equipo</option>
                                            <option value="crecimiento_empresarial">Crecimiento Empresarial</option>
                                            <option value="otros">Otros</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-dark small fw-bold">
                                            <i class="fas fa-list-check me-1 text-primary"></i>Tipo
                                        </label>
                                        <select class="form-select border-secondary" id="taskType" 
                                                style="background-color: white; color: #212529; border-radius: 8px; border: 2px solid #e2e8f0;">
                                            <option value="">Seleccionar tipo</option>
                                            <option value="accion">Acción</option>
                                            <option value="meta">Meta</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-dark small fw-bold">
                                            <i class="fas fa-user me-1 text-primary"></i>Asignar a Coachee
                                        </label>
                                        <select class="form-select border-secondary" id="taskCoachee" 
                                                style="background-color: white; color: #212529; border-radius: 8px; border: 2px solid #e2e8f0;">
                                            <option value="">Seleccionar coachee</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-dark small fw-bold">
                                            <i class="fas fa-calendar me-1 text-primary"></i>Fecha de Vencimiento
                                        </label>
                                        <input type="date" class="form-control border-secondary" 
                                               id="taskDueDate" 
                                               style="background-color: white; color: #212529; border-radius: 8px; border: 2px solid #e2e8f0;">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label text-dark small fw-bold">
                                            <i class="fas fa-align-left me-1 text-primary"></i>Descripción
                                        </label>
                                        <textarea class="form-control border-secondary" 
                                                  placeholder="Descripción detallada de la acción o meta" 
                                                  id="taskDescription" rows="3" 
                                                  style="background-color: white; color: #212529; border-radius: 8px; border: 2px solid #e2e8f0;"></textarea>
                                    </div>
                                    <div class="col-12">
                                        <button class="btn btn-success btn-lg" onclick="createTask()" 
                                                style="border-radius: 8px; padding: 0.75rem 2rem; font-weight: 600; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); width: 100%;">
                                            <i class="fas fa-plus me-2"></i>Crear Acción o Meta
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Lista de Acciones y Metas -->
                        <div class="card" style="border: 2px solid #e2e8f0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                            <div class="card-header" style="background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%) !important; border-bottom: none !important; padding: 1rem 1.25rem;">
                                <h6 class="mb-0" style="color: white !important; font-weight: 600; font-size: 1.1rem;">
                                    <i class="fas fa-tasks me-2"></i>Lista de Acciones y Metas
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <!-- Vista tabla para desktop -->
                                <div class="table-responsive d-none d-md-block">
                                    <table class="table table-striped mb-0">
                                        <thead>
                                            <tr>
                                                <th style="color: #212529;">Acción/Meta</th>
                                                <th style="color: #212529;">Coachee</th>
                                                <th style="color: #212529;">Categoría</th>
                                                <th style="color: #212529;">Estado</th>
                                                <th style="color: #212529;">Progreso</th>
                                                <th style="color: #212529;">Vencimiento</th>
                                                <th style="color: #212529;">Creada</th>
                                                <th style="color: #212529;">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tasksTableBody">
                                            <tr>
                                                <td colspan="8" class="text-center text-muted">No hay acciones o metas creadas</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Vista cards para móvil -->
                                <div class="d-block d-md-none p-3" id="tasksCardsContainer">
                                    <div class="text-center text-muted">No hay tareas creadas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invitar Coachee Module -->
            <div id="invitar-coachee" class="module-content" style="display: none;">
                <div class="card sidebar-white border-secondary" style="background-color: white !important; margin-bottom: 1rem; border-radius: 16px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); overflow: hidden; border: 2px solid #e2e8f0 !important;">
                    <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; border-bottom: none !important; padding: 1.25rem;">
                        <h5 class="mb-0" style="color: white !important; font-weight: 700; font-size: 1.5rem; display: flex; align-items: center;">
                            <i class="fas fa-user-plus me-3" style="font-size: 1.75rem;"></i>Invitar Nuevo Coachee
                        </h5>
                        <p class="mb-0 mt-2" style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem;">Invita a un coachee y asigna una evaluación inicial</p>
                    </div>
                    <div class="card-body" style="background-color: white !important; padding: 1.5rem;">
                        <form id="inviteForm">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label text-dark small fw-bold">
                                        <i class="fas fa-user me-1 text-primary"></i>Nombre
                                    </label>
                                    <input type="text" class="form-control border-secondary" 
                                           id="coacheeName" required 
                                           placeholder="Nombre completo del coachee"
                                           style="background-color: white; color: #212529; border-radius: 8px; border: 2px solid #e2e8f0;">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label text-dark small fw-bold">
                                        <i class="fas fa-envelope me-1 text-primary"></i>Email
                                    </label>
                                    <input type="email" class="form-control border-secondary" 
                                           id="coacheeEmail" required 
                                           placeholder="correo@ejemplo.com"
                                           style="background-color: white; color: #212529; border-radius: 8px; border: 2px solid #e2e8f0;">
                                </div>
                            </div>
                            
                            <!-- Sección de evaluación -->
                            <div class="mb-3 mt-3">
                                <label class="form-label text-dark small fw-bold">
                                    <i class="fas fa-clipboard-list me-1 text-primary"></i>
                                    Evaluación a Asignar (Opcional)
                                </label>
                                <select class="form-select border-secondary" id="assignedAssessment" 
                                        style="background-color: white; color: #212529; border-radius: 8px; border: 2px solid #e2e8f0;">
                                    <option value="">Seleccionar evaluación...</option>
                                </select>
                                <div class="form-text text-muted small">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Si seleccionas una evaluación, se asignará automáticamente al coachee
                                </div>
                            </div>
                            
                            <!-- Mensaje personalizado -->
                            <div class="mb-4">
                                <label class="form-label text-dark small fw-bold">
                                    <i class="fas fa-comment-dots me-1 text-primary"></i>Mensaje Personalizado (Opcional)
                                </label>
                                <textarea class="form-control border-secondary" id="customMessage" rows="3" 
                                          style="background-color: white; color: #212529; border-radius: 8px; border: 2px solid #e2e8f0;" 
                                          placeholder="Mensaje de bienvenida para tu coachee..."></textarea>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex">
                                <button type="submit" class="btn btn-success btn-lg" style="border-radius: 8px; padding: 0.75rem 2rem; font-weight: 600; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                                    <i class="fas fa-paper-plane me-2"></i>Crear Coachee
                                </button>
                            </div>
                        </form>
                        
                        <!-- Modal para mostrar invitación creada -->
                        <div class="modal fade" id="invitationSuccessModal" tabindex="-1" aria-labelledby="invitationSuccessModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header bg-success text-white">
                                        <h5 class="modal-title" id="invitationSuccessModalLabel">
                                            <i class="fas fa-check-circle me-2"></i>¡Coachee Creado Exitosamente!
                                        </h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" onclick="closeInvitationModal()"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6 class="text-primary">
                                                    <i class="fas fa-user me-1"></i>Información del Coachee
                                                </h6>
                                                <div class="bg-light p-3 rounded mb-3">
                                                    <p class="mb-1"><strong>Nombre:</strong> <span id="modalCoacheeName"></span></p>
                                                    <p class="mb-1"><strong>Email:</strong> <span id="modalCoacheeEmail"></span></p>
                                                    <p class="mb-1"><strong>Usuario:</strong> <span id="modalCoacheeUsername" class="text-primary"></span></p>
                                                    <p class="mb-0"><strong>Contraseña:</strong> <span id="modalCoacheePassword" class="text-danger fw-bold"></span></p>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <h6 class="text-primary">
                                                    <i class="fas fa-share-alt me-1"></i>Compartir Invitación
                                                </h6>
                                                <div class="d-grid gap-2">
                                                    <button class="btn btn-outline-primary" onclick="copyInvitationToClipboard()">
                                                        <i class="fas fa-copy me-1"></i>Copiar al Portapapeles
                                                    </button>
                                                    <button class="btn btn-success" onclick="shareViaWhatsApp()">
                                                        <i class="fab fa-whatsapp me-1"></i>Enviar por WhatsApp
                                                    </button>
                                                    <button class="btn btn-info" onclick="shareViaEmail()">
                                                        <i class="fas fa-envelope me-1"></i>Enviar por Email
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <hr>
                                        
                        <h6 class="text-primary">
                            <i class="fas fa-comment-dots me-1"></i>Mensaje de Invitación
                        </h6>
                        <div class="invitation-message-container bg-light p-3 rounded border" style="cursor: text;">
                            <div id="invitationMessage" style="white-space: pre-line; font-family: monospace; font-size: 0.9rem; user-select: text; -webkit-user-select: text; -moz-user-select: text; -ms-user-select: text; cursor: text; line-height: 1.4;"></div>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>Puedes seleccionar y copiar el texto directamente desde aquí
                        </small>                                        <div id="assessmentAssignedInfo" class="alert alert-info mt-3" style="display: none;">
                                            <i class="fas fa-clipboard-check me-1"></i>
                                            <strong>Evaluación Asignada:</strong> <span id="assignedAssessmentName"></span>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" onclick="closeInvitationModal()">
                                            <i class="fas fa-times me-1"></i>Cerrar
                                        </button>
                                        <button type="button" class="btn btn-primary" onclick="copyInvitationToClipboard()">
                                            <i class="fas fa-copy me-1"></i>Copiar Mensaje
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seleccionar Evaluaciones Module -->
            <div id="seleccionar-evaluaciones" class="module-content" style="display: none;">
                <div class="card sidebar-white border-secondary" style="background-color: white !important; margin-bottom: 1rem; border-radius: 16px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); overflow: hidden; border: 2px solid #e2e8f0 !important;">
                    <div class="card-header d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; border-bottom: none !important; padding: 1.25rem;">
                        <div>
                            <h5 class="mb-0" style="color: white !important; font-weight: 700; font-size: 1.5rem; display: flex; align-items: center;">
                                <i class="fas fa-clipboard-list me-3" style="font-size: 1.75rem;"></i>
                                Evaluaciones Disponibles
                            </h5>
                            <p class="mb-0 mt-2" style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem;">Selecciona evaluaciones para asignar a tus coachees</p>
                        </div>
                        <!-- Botón de actualizar para móvil -->
                        <button class="btn btn-light btn-sm mt-2 mt-sm-0" onclick="loadAvailableAssessments()" title="Actualizar evaluaciones" style="border-radius: 8px; font-weight: 600; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);">
                            <i class="fas fa-sync-alt me-1"></i>
                            <span class="d-none d-sm-inline">Actualizar</span>
                        </button>
                    </div>
                    <div class="card-body" style="background-color: white !important; padding: 1.5rem;">
                        <!-- Loading skeleton (más atractivo que spinner) -->
                        <div id="assessments-loading" class="py-2">
                            <div class="skeleton-card mb-3">
                                <div class="skeleton-header mb-2"></div>
                                <div class="skeleton-text mb-2"></div>
                                <div class="skeleton-text short"></div>
                            </div>
                            <div class="skeleton-card mb-3">
                                <div class="skeleton-header mb-2"></div>
                                <div class="skeleton-text mb-2"></div>
                                <div class="skeleton-text short"></div>
                            </div>
                            <div class="skeleton-card">
                                <div class="skeleton-header mb-2"></div>
                                <div class="skeleton-text mb-2"></div>
                                <div class="skeleton-text short"></div>
                            </div>
                        </div>
                        
                        <!-- Assessments list -->
                        <div id="assessments-list" style="display: none;">
                            <!-- Assessment cards will be populated here -->
                        </div>
                        
                        <!-- Error message -->
                        <div id="assessments-error" class="alert alert-warning" style="display: none;">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Error:</strong>
                            </div>
                            <p class="mb-2 small">No se pudieron cargar las evaluaciones disponibles.</p>
                            <button class="btn btn-sm btn-warning" onclick="loadAvailableAssessments()">
                                <i class="fas fa-sync-alt me-1"></i>Reintentar ahora
                            </button>
                        </div>
                        
                        <!-- No assessments message -->
                        <div id="no-assessments" class="text-center py-4" style="display: none;">
                            <div class="mb-3">
                                <i class="fas fa-clipboard-list text-muted" style="font-size: 3rem;"></i>
                            </div>
                            <h6 class="text-muted mb-2">No hay evaluaciones disponibles</h6>
                            <p class="text-muted small mb-3">Las evaluaciones aparecerán aquí cuando estén disponibles.</p>
                            <button class="btn btn-primary btn-sm" onclick="loadAvailableAssessments()">
                                <i class="fas fa-sync-alt me-1"></i>Intentar de nuevo
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Evaluaciones Pendientes Module -->
            <div id="evaluaciones-pendientes" class="module-content" style="display: none;">
                <div class="card sidebar-white border-secondary" style="background-color: white !important; margin-bottom: 1rem; border-radius: 16px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); overflow: hidden; border: 2px solid #e2e8f0 !important;">
                    <div class="card-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important; border-bottom: none !important; padding: 1.25rem;">
                        <h5 class="mb-0" style="color: white !important; font-weight: 700; font-size: 1.5rem; display: flex; align-items: center;">
                            <i class="fas fa-hourglass-half me-3" style="font-size: 1.75rem;"></i>
                            Evaluaciones Pendientes
                        </h5>
                        <p class="mb-0 mt-2" style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem;">Evaluaciones asignadas que están en proceso o pendientes de completar</p>
                    </div>
                    <div class="card-body p-0">
                        <!-- Vista tabla para desktop -->
                        <div class="table-responsive d-block">
                            <table class="table table-striped mb-0">
                                <thead>
                                    <tr>
                                        <th style="color: #212529;">Evaluación</th>
                                        <th style="color: #212529;">Coachee</th>
                                        <th style="color: #212529;">Fecha Asignación</th>
                                        <th style="color: #212529;">Estado</th>
                                        <th style="color: #212529;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="pendingEvaluationsTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">No hay evaluaciones pendientes</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Vista cards para móvil (oculta por ahora, mostrar solo tabla) -->
                        <div class="d-none p-3" id="pendingEvaluationsCardsContainer">
                            <div class="text-center text-muted">No hay evaluaciones pendientes</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Crear o Cargar Evaluaciones Module -->
            <div id="crear-cargar-evaluaciones" class="module-content" style="display: none;">
                <div class="card sidebar-white border-secondary" style="background-color: white !important; margin-bottom: 1rem; border-radius: 16px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); overflow: hidden; border: 2px solid #e2e8f0 !important;">
                    <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; border-bottom: none !important; padding: 1.25rem;">
                        <h5 class="mb-0" style="color: white !important; font-weight: 700; font-size: 1.5rem; display: flex; align-items: center;">
                            <i class="fas fa-file-upload me-3" style="font-size: 1.75rem;"></i>
                            Crear Nueva Evaluación (En Proceso)
                        </h5>
                        <p class="mb-0 mt-2" style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem;">Sube un archivo con las evaluaciones en formato compatible</p>
                    </div>
                    <div class="card-body" style="background-color: white !important; padding: 1.5rem;">
                        <!-- Formulario de carga -->
                        <div class="mb-4">
                            <label class="form-label text-dark small fw-bold">
                                <i class="fas fa-file-import me-2 text-primary"></i>Seleccionar archivo de evaluación
                            </label>
                            <p class="text-muted small mb-3">
                                Formatos aceptados: JSON, CSV, Excel (.xlsx, .xls)
                            </p>
                            <div class="input-group">
                                <input type="file" class="form-control border-secondary" id="evaluationFile" 
                                       accept=".json,.csv,.xlsx,.xls"
                                       style="background-color: white; color: #212529; border-radius: 8px 0 0 8px; border: 2px solid #e2e8f0;">
                                <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('evaluationFile').value = ''" style="border-radius: 0 8px 8px 0; border: 2px solid #e2e8f0;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Información del formato -->
                        <div class="alert alert-info" role="alert">
                            <h6 class="alert-heading">
                                <i class="fas fa-info-circle me-2"></i>Formato del archivo
                            </h6>
                            <p class="mb-2 small">El archivo debe contener la siguiente estructura:</p>
                            <ul class="small mb-2">
                                <li><strong>Título:</strong> Nombre de la evaluación</li>
                                <li><strong>Descripción:</strong> Breve descripción</li>
                                <li><strong>Categoría:</strong> Personalidad, Liderazgo, Inteligencia Emocional, Trabajo en Equipo, Crecimiento Empresarial, u Otros</li>
                                <li><strong>Preguntas:</strong> Lista de preguntas con sus opciones y respuestas correctas</li>
                            </ul>
                            <button class="btn btn-sm btn-outline-info" onclick="downloadEvaluationTemplate()">
                                <i class="fas fa-download me-1"></i>Descargar plantilla de ejemplo
                            </button>
                        </div>

                        <!-- Vista previa del archivo -->
                        <div id="filePreview" style="display: none;" class="mb-4">
                            <h6 class="text-dark mb-3">
                                <i class="fas fa-eye me-2 text-primary"></i>Vista previa
                            </h6>
                            <div class="card border-secondary">
                                <div class="card-body" style="background-color: #f8f9fa;">
                                    <div id="previewContent" class="small">
                                        <!-- Preview content will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botones de acción -->
                        <div class="d-flex gap-2 justify-content-end">
                            <button class="btn btn-outline-secondary" onclick="cancelUpload()" style="border-radius: 8px; padding: 0.625rem 1.5rem; font-weight: 600;">
                                <i class="fas fa-times me-1"></i>Cancelar
                            </button>
                            <button class="btn btn-primary" onclick="uploadEvaluation()" id="uploadBtn" disabled style="border-radius: 8px; padding: 0.625rem 1.5rem; font-weight: 600; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                                <i class="fas fa-upload me-1"></i>Cargar Evaluación
                            </button>
                        </div>

                        <!-- Estado de carga -->
                        <div id="uploadProgress" style="display: none;" class="mt-4">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <span class="small text-muted">Cargando evaluación...</span>
                                <span class="small text-muted" id="uploadPercent">0%</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%" id="uploadProgressBar"></div>
                            </div>
                        </div>

                        <!-- Resultado de la carga -->
                        <div id="uploadResult" style="display: none;" class="mt-4">
                            <!-- Success or error message will be shown here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agregar Contenido Module -->
            <div id="agregar-contenido" class="module-content" style="display: none;">
                <div class="card sidebar-white border-secondary" style="background-color: white !important; margin-bottom: 1rem; border-radius: 16px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); overflow: hidden; border: 2px solid #e2e8f0 !important;">
                    <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; border-bottom: none !important; padding: 1.25rem;">
                        <h5 class="mb-0" style="color: white !important; font-weight: 700; font-size: 1.5rem; display: flex; align-items: center;">
                            <i class="fas fa-video me-3" style="font-size: 1.75rem;"></i>
                            Gestión de Contenido
                        </h5>
                        <p class="mb-0 mt-2" style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem;">Asigna videos y documentos a tus coachees</p>
                    </div>
                    <div class="card-body" style="background-color: white !important; padding: 1.5rem;">
                        <!-- Pestañas para organizar contenido -->
                        <ul class="nav nav-tabs mb-4" id="contentTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="assign-content-tab" data-bs-toggle="tab" 
                                    data-bs-target="#assign-content-pane" type="button" role="tab">
                                    <i class="fas fa-plus-circle me-1"></i>Asignar Video
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="upload-documents-tab" data-bs-toggle="tab" 
                                    data-bs-target="#upload-documents-pane" type="button" role="tab">
                                    <i class="fas fa-file-upload me-1"></i>Subir Documentos
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="manage-content-tab" data-bs-toggle="tab" 
                                    data-bs-target="#manage-content-pane" type="button" role="tab">
                                    <i class="fas fa-list me-1"></i>Contenido Asignado
                                </button>
                            </li>
                        </ul>

                        <!-- Contenido de las pestañas -->
                        <div class="tab-content" id="contentTabContent">
                            <!-- Pestaña: Asignar Video -->
                            <div class="tab-pane fade show active" id="assign-content-pane" role="tabpanel">
                                <div class="row">
                                    <div class="col-lg-8">
                                        <form id="assignContentForm">
                                            <div class="mb-3">
                                                <label for="coacheeSelect" class="form-label">
                                                    <i class="fas fa-user me-1"></i>Seleccionar Coachee
                                                </label>
                                                <select class="form-select" id="coacheeSelect" required>
                                                    <option value="">Selecciona un coachee...</option>
                                                </select>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="videoUrl" class="form-label">
                                                    <i class="fab fa-youtube me-1 text-danger"></i>URL del Video de YouTube
                                                </label>
                                                <input type="url" class="form-control" id="videoUrl" 
                                                    placeholder="https://www.youtube.com/watch?v=..." required>
                                                <div class="form-text">
                                                    Ejemplo: https://www.youtube.com/watch?v=b6vozRQhtCc
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="contentTitle" class="form-label">
                                                    <i class="fas fa-heading me-1"></i>Título del Contenido
                                                </label>
                                                <input type="text" class="form-control" id="contentTitle" 
                                                    placeholder="Título descriptivo del video" required>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="contentDescription" class="form-label">
                                                    <i class="fas fa-align-left me-1"></i>Descripción (Opcional)
                                                </label>
                                                <textarea class="form-control" id="contentDescription" rows="3" 
                                                    placeholder="Describe el contenido del video y por qué es relevante para el coachee..."></textarea>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="videoDuration" class="form-label">
                                                    <i class="fas fa-clock me-1"></i>Duración (minutos, opcional)
                                                </label>
                                                <input type="number" class="form-control" id="videoDuration" 
                                                    placeholder="15" min="1" max="999">
                                            </div>
                                            
                                            <div class="d-flex gap-2">
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-paper-plane me-1"></i>
                                                    Asignar Video
                                                </button>
                                                <button type="button" class="btn btn-secondary" onclick="resetAssignForm()">
                                                    <i class="fas fa-undo me-1"></i>
                                                    Limpiar
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                    
                                    <div class="col-lg-4">
                                        <div class="card bg-light">
                                            <div class="card-header">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-lightbulb me-1 text-warning"></i>
                                                    Vista Previa
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="videoPreview" class="text-center text-muted">
                                                    <i class="fas fa-video fa-3x mb-2"></i>
                                                    <p class="small">La vista previa del video aparecerá aquí cuando ingreses una URL válida</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <h6><i class="fas fa-info-circle me-1 text-info"></i>Formatos Soportados</h6>
                                            <ul class="list-unstyled small text-muted">
                                                <li><i class="fab fa-youtube me-1"></i>YouTube videos</li>
                                                <li><i class="fas fa-link me-1"></i>Enlaces directos</li>
                                                <li><i class="fas fa-file-video me-1"></i>Videos embebidos</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pestaña: Subir Documentos -->
                            <div class="tab-pane fade" id="upload-documents-pane" role="tabpanel">
                                <div class="row">
                                    <div class="col-lg-8">
                                        <div class="card mb-4">
                                            <div class="card-header">
                                                <h6 class="card-title mb-0">
                                                    <i class="fas fa-cloud-upload-alt me-2"></i>Subir Documentos PDF e Imágenes
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <form id="uploadDocumentForm" enctype="multipart/form-data">
                                                    <div class="mb-3">
                                                        <label for="coacheeSelectDocuments" class="form-label">
                                                            <i class="fas fa-user me-1"></i>Seleccionar Coachee
                                                        </label>
                                                        <select class="form-select" id="coacheeSelectDocuments" required>
                                                            <option value="">Selecciona un coachee...</option>
                                                        </select>
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <label for="documentFile" class="form-label">
                                                            <i class="fas fa-file me-1"></i>Seleccionar Archivo
                                                        </label>
                                                        <input type="file" class="form-control" id="documentFile" 
                                                               accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx" required>
                                                        <div class="form-text">
                                                            Formatos permitidos: PDF, JPG, PNG, GIF, DOC, DOCX (máximo 10MB)
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <label for="documentTitle" class="form-label">
                                                            <i class="fas fa-heading me-1"></i>Título del Documento
                                                        </label>
                                                        <input type="text" class="form-control" id="documentTitle" 
                                                               placeholder="Ej: Manual de Ejercicios de Asertividad" required>
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <label for="documentDescription" class="form-label">
                                                            <i class="fas fa-align-left me-1"></i>Descripción
                                                        </label>
                                                        <textarea class="form-control" id="documentDescription" rows="3"
                                                                  placeholder="Describe el contenido del documento y por qué es relevante para el coachee..."></textarea>
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <label for="documentCategory" class="form-label">
                                                            <i class="fas fa-tags me-1"></i>Categoría
                                                        </label>
                                                        <select class="form-select" id="documentCategory" required>
                                                            <option value="">Selecciona una categoría...</option>
                                                            <option value="ejercicios">Ejercicios y Actividades</option>
                                                            <option value="teoria">Material Teórico</option>
                                                            <option value="evaluacion">Evaluaciones Complementarias</option>
                                                            <option value="recurso">Recursos de Apoyo</option>
                                                            <option value="tarea">Tareas y Asignaciones</option>
                                                            <option value="referencias">Referencias y Bibliografía</option>
                                                        </select>
                                                    </div>
                                                    
                                                    <div class="row mb-3">
                                                        <div class="col-md-6">
                                                            <label for="documentPriority" class="form-label">
                                                                <i class="fas fa-exclamation-circle me-1"></i>Prioridad
                                                            </label>
                                                            <select class="form-select" id="documentPriority">
                                                                <option value="normal">Normal</option>
                                                                <option value="alta">Alta</option>
                                                                <option value="urgente">Urgente</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="form-check mt-4">
                                                                <input class="form-check-input" type="checkbox" id="notifyCoachee">
                                                                <label class="form-check-label" for="notifyCoachee">
                                                                    <i class="fas fa-bell me-1"></i>Notificar al coachee
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                                        <button type="reset" class="btn btn-outline-secondary me-2">
                                                            <i class="fas fa-times me-1"></i>Cancelar
                                                        </button>
                                                        <button type="submit" class="btn btn-primary">
                                                            <i class="fas fa-upload me-1"></i>Subir Documento
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-lg-4">
                                        <!-- Vista previa del archivo -->
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="card-title mb-0">
                                                    <i class="fas fa-eye me-2"></i>Vista Previa
                                                </h6>
                                            </div>
                                            <div class="card-body text-center" id="documentPreviewContainer">
                                                <div class="text-muted">
                                                    <i class="fas fa-file-alt" style="font-size: 48px; opacity: 0.3;"></i>
                                                    <p class="mt-3">Selecciona un archivo para ver la vista previa</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Estadísticas de documentos -->
                                        <div class="card mt-3">
                                            <div class="card-header">
                                                <h6 class="card-title mb-0">
                                                    <i class="fas fa-chart-pie me-2"></i>Estadísticas
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row text-center">
                                                    <div class="col-4">
                                                        <div class="text-primary">
                                                            <i class="fas fa-file-pdf"></i>
                                                            <div class="fw-bold" id="pdfCount">0</div>
                                                            <small>PDFs</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-4">
                                                        <div class="text-success">
                                                            <i class="fas fa-image"></i>
                                                            <div class="fw-bold" id="imageCount">0</div>
                                                            <small>Imágenes</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-4">
                                                        <div class="text-info">
                                                            <i class="fas fa-file-word"></i>
                                                            <div class="fw-bold" id="docCount">0</div>
                                                            <small>Docs</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pestaña: Contenido Asignado -->
                            <div class="tab-pane fade" id="manage-content-pane" role="tabpanel">
                                <!-- Controles de filtrado -->
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title mb-3">
                                            <i class="fas fa-filter me-2"></i>Filtros y Opciones de Vista
                                        </h6>
                                        <div class="row g-3">
                                            <div class="col-md-3">
                                                <label for="coacheeFilter" class="form-label small">Filtrar por Coachee</label>
                                                <select class="form-select" id="coacheeFilter">
                                                    <option value="">Todos los coachees</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="viewModeFilter" class="form-label small">Modo de Vista</label>
                                                <select class="form-select" id="viewModeFilter">
                                                    <option value="all">Todas las asignaciones</option>
                                                    <option value="unique">Contenido único</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="statusFilter" class="form-label small">Estado</label>
                                                <select class="form-select" id="statusFilter">
                                                    <option value="">Todos los estados</option>
                                                    <option value="viewed">Solo vistos</option>
                                                    <option value="pending">Solo pendientes</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="contentSearch" class="form-label small">Buscar</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="contentSearch" 
                                                        placeholder="Buscar contenido...">
                                                    <button class="btn btn-outline-primary" onclick="applyContentFilters()">
                                                        <i class="fas fa-search"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-12">
                                                <button class="btn btn-sm btn-outline-secondary me-2" onclick="clearContentFilters()">
                                                    <i class="fas fa-times me-1"></i>Limpiar Filtros
                                                </button>
                                                <button class="btn btn-sm btn-outline-primary" onclick="refreshContentList()">
                                                    <i class="fas fa-sync-alt me-1"></i>Actualizar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="assignedContentList">
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando contenido...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

            <!-- Agenda Module -->
            <div id="agenda" class="module-content" style="display: none;">
                <div class="card sidebar-white border-secondary" style="background-color: white !important; margin-bottom: 1rem; border-radius: 16px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); overflow: hidden; border: 2px solid #e2e8f0 !important;">
                    <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; border-bottom: none !important; padding: 1.25rem;">
                        <h5 class="mb-0" style="color: white !important; font-weight: 700; font-size: 1.5rem; display: flex; align-items: center;">
                            <i class="fas fa-calendar-alt me-3" style="font-size: 1.75rem;"></i>
                            Mi Agenda
                        </h5>
                        <p class="mb-0 mt-2" style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem;">Gestiona tu calendario y disponibilidad</p>
                    </div>
                    <div class="card-body" style="background-color: white !important; padding: 1.5rem;">
                        
                        <!-- Pestañas de la Agenda -->
                        <ul class="nav nav-tabs mb-4" id="agendaTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="calendar-tab" data-bs-toggle="tab" 
                                    data-bs-target="#calendar-pane" type="button" role="tab">
                                    <i class="fas fa-calendar me-1"></i>Calendario
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="availability-tab" data-bs-toggle="tab" 
                                    data-bs-target="#availability-pane" type="button" role="tab">
                                    <i class="fas fa-clock me-1"></i>Disponibilidad
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link position-relative" id="requests-tab" data-bs-toggle="tab" 
                                    data-bs-target="#requests-pane" type="button" role="tab">
                                    <i class="fas fa-inbox me-1"></i>Solicitudes
                                    <span class="badge bg-danger rounded-pill ms-1" id="requestsCount" style="display: none;">0</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="appointment-management-tab" data-bs-toggle="tab" 
                                    data-bs-target="#appointment-management-pane" type="button" role="tab">
                                    <i class="fas fa-calendar-plus me-1"></i>Gestión de Citas
                                </button>
                            </li>
                        </ul>

                        <!-- Contenido de las pestañas -->
                        <div class="tab-content" id="agendaTabContent">
                            
                            <!-- Pestaña: Calendario -->
                            <div class="tab-pane fade show active" id="calendar-pane" role="tabpanel">
                                <div class="row">
                                    <div class="col-12">
                                        <div id="calendar"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pestaña: Disponibilidad -->
                            <div class="tab-pane fade" id="availability-pane" role="tabpanel">
                                <div class="row">
                                    <div class="col-lg-8">
                                        <h6 class="mb-3">
                                            <i class="fas fa-clock me-2"></i>Configurar Horarios Disponibles
                                        </h6>
                                        
                                        <form id="availabilityForm">
                                            <div class="row g-3">
                                                <!-- Días de la semana -->
                                                <div class="col-12">
                                                    <label class="form-label fw-bold">Días Disponibles</label>
                                                    <div class="row g-2 days-selector">
                                                        <div class="col-6 col-sm-4 col-lg-3">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="day1" value="1">
                                                                <label class="form-check-label" for="day1">Lunes</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6 col-sm-4 col-lg-3">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="day2" value="2">
                                                                <label class="form-check-label" for="day2">Martes</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6 col-sm-4 col-lg-3">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="day3" value="3">
                                                                <label class="form-check-label" for="day3">Miércoles</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6 col-sm-4 col-lg-3">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="day4" value="4">
                                                                <label class="form-check-label" for="day4">Jueves</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6 col-sm-4 col-lg-3">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="day5" value="5">
                                                                <label class="form-check-label" for="day5">Viernes</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6 col-sm-4 col-lg-3">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="day6" value="6">
                                                                <label class="form-check-label" for="day6">Sábado</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6 col-sm-4 col-lg-3">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="day0" value="0">
                                                                <label class="form-check-label" for="day0">Domingo</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Horarios -->
                                                <div class="col-md-6">
                                                    <label for="startTime" class="form-label">Hora de Inicio</label>
                                                    <select class="form-select time-select-24h" id="startTime">
                                                        <option value="00:00">00:00</option>
                                                        <option value="01:00">01:00</option>
                                                        <option value="02:00">02:00</option>
                                                        <option value="03:00">03:00</option>
                                                        <option value="04:00">04:00</option>
                                                        <option value="05:00">05:00</option>
                                                        <option value="06:00">06:00</option>
                                                        <option value="07:00">07:00</option>
                                                        <option value="08:00">08:00</option>
                                                        <option value="09:00" selected>09:00</option>
                                                        <option value="10:00">10:00</option>
                                                        <option value="11:00">11:00</option>
                                                        <option value="12:00">12:00</option>
                                                        <option value="13:00">13:00</option>
                                                        <option value="14:00">14:00</option>
                                                        <option value="15:00">15:00</option>
                                                        <option value="16:00">16:00</option>
                                                        <option value="17:00">17:00</option>
                                                        <option value="18:00">18:00</option>
                                                        <option value="19:00">19:00</option>
                                                        <option value="20:00">20:00</option>
                                                        <option value="21:00">21:00</option>
                                                        <option value="22:00">22:00</option>
                                                        <option value="23:00">23:00</option>
                                                        <option value="24:00">24:00</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="endTime" class="form-label">Hora de Fin</label>
                                                    <select class="form-select time-select-24h" id="endTime">
                                                        <option value="00:00">00:00</option>
                                                        <option value="01:00">01:00</option>
                                                        <option value="02:00">02:00</option>
                                                        <option value="03:00">03:00</option>
                                                        <option value="04:00">04:00</option>
                                                        <option value="05:00">05:00</option>
                                                        <option value="06:00">06:00</option>
                                                        <option value="07:00">07:00</option>
                                                        <option value="08:00">08:00</option>
                                                        <option value="09:00">09:00</option>
                                                        <option value="10:00">10:00</option>
                                                        <option value="11:00">11:00</option>
                                                        <option value="12:00">12:00</option>
                                                        <option value="13:00">13:00</option>
                                                        <option value="14:00">14:00</option>
                                                        <option value="15:00">15:00</option>
                                                        <option value="16:00">16:00</option>
                                                        <option value="17:00" selected>17:00</option>
                                                        <option value="18:00">18:00</option>
                                                        <option value="19:00">19:00</option>
                                                        <option value="20:00">20:00</option>
                                                        <option value="21:00">21:00</option>
                                                        <option value="22:00">22:00</option>
                                                        <option value="23:00">23:00</option>
                                                        <option value="24:00">24:00</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="col-12">
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="fas fa-save me-2"></i>Guardar Disponibilidad
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    
                                    <div class="col-lg-4">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-info-circle me-2"></i>Disponibilidad Actual
                                                </h6>
                                            </div>
                                            <div class="card-body" id="currentAvailability">
                                                <div class="text-center py-3">
                                                    <div class="spinner-border spinner-border-sm" role="status">
                                                        <span class="visually-hidden">Cargando...</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pestaña: Solicitudes -->
                            <div class="tab-pane fade" id="requests-pane" role="tabpanel">
                                <div class="row">
                                    <div class="col-12">
                                        <h6 class="mb-3">
                                            <i class="fas fa-inbox me-2"></i>Solicitudes Pendientes
                                        </h6>
                                        
                                        <div id="sessionRequests">
                                            <div class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Cargando solicitudes...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pestaña: Gestión de Citas -->
                            <div class="tab-pane fade" id="appointment-management-pane" role="tabpanel">
                                <div class="row">
                                    <div class="col-12">
                                        <!-- Sub-pestañas para Gestión de Citas -->
                                        <ul class="nav nav-pills mb-4" id="appointmentSubTabs" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="self-schedule-tab" data-bs-toggle="pill" 
                                                    data-bs-target="#self-schedule-pane" type="button" role="tab">
                                                    <i class="fas fa-user-clock me-1"></i>Autoagendar Tiempo
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="direct-appointment-tab" data-bs-toggle="pill" 
                                                    data-bs-target="#direct-appointment-pane" type="button" role="tab">
                                                    <i class="fas fa-calendar-check me-1"></i>Agendar Cita Directa
                                                </button>
                                            </li>
                                        </ul>

                                        <!-- Contenido de sub-pestañas -->
                                        <div class="tab-content" id="appointmentSubTabContent">
                                            
                                            <!-- Sub-pestaña: Autoagendar Tiempo -->
                                            <div class="tab-pane fade show active" id="self-schedule-pane" role="tabpanel">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h6 class="mb-0">
                                                            <i class="fas fa-user-clock me-2 text-success"></i>
                                                            Bloquear Tiempo Personal
                                                        </h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <p class="text-muted mb-4">
                                                            <i class="fas fa-info-circle me-1"></i>
                                                            Reserva tiempo en tu calendario para actividades personales, preparación de sesiones, descansos, etc.
                                                        </p>
                                                        
                                                        <form id="selfScheduleForm">
                                                            <div class="row g-3">
                                                                <div class="col-md-6">
                                                                    <label for="selfActivityTitle" class="form-label">
                                                                        <i class="fas fa-tag me-1"></i>Título de la Actividad
                                                                    </label>
                                                                    <input type="text" class="form-control" id="selfActivityTitle" 
                                                                        placeholder="Ej: Preparación de sesiones, Almuerzo, Reunión administrativa..." required>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <label for="selfActivityType" class="form-label">
                                                                        <i class="fas fa-list me-1"></i>Tipo de Actividad
                                                                    </label>
                                                                    <select class="form-select" id="selfActivityType" required>
                                                                        <option value="">Seleccionar tipo...</option>
                                                                        <option value="preparation">Preparación de Sesiones</option>
                                                                        <option value="admin">Tareas Administrativas</option>
                                                                        <option value="break">Descanso/Almuerzo</option>
                                                                        <option value="training">Formación/Capacitación</option>
                                                                        <option value="meeting">Reunión</option>
                                                                        <option value="personal">Tiempo Personal</option>
                                                                        <option value="other">Otro</option>
                                                                    </select>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <label for="selfDate" class="form-label">
                                                                        <i class="fas fa-calendar me-1"></i>Fecha
                                                                    </label>
                                                                    <input type="date" class="form-control" id="selfDate" required>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <label for="selfStartTime" class="form-label">
                                                                        <i class="fas fa-clock me-1"></i>Hora de Inicio
                                                                    </label>
                                                                    <select class="form-select time-select-24h" id="selfStartTime" required>
                                                                        <option value="00:00">00:00</option>
                                                                        <option value="01:00">01:00</option>
                                                                        <option value="02:00">02:00</option>
                                                                        <option value="03:00">03:00</option>
                                                                        <option value="04:00">04:00</option>
                                                                        <option value="05:00">05:00</option>
                                                                        <option value="06:00">06:00</option>
                                                                        <option value="07:00">07:00</option>
                                                                        <option value="08:00">08:00</option>
                                                                        <option value="09:00">09:00</option>
                                                                        <option value="10:00">10:00</option>
                                                                        <option value="11:00">11:00</option>
                                                                        <option value="12:00" selected>12:00</option>
                                                                        <option value="13:00">13:00</option>
                                                                        <option value="14:00">14:00</option>
                                                                        <option value="15:00">15:00</option>
                                                                        <option value="16:00">16:00</option>
                                                                        <option value="17:00">17:00</option>
                                                                        <option value="18:00">18:00</option>
                                                                        <option value="19:00">19:00</option>
                                                                        <option value="20:00">20:00</option>
                                                                        <option value="21:00">21:00</option>
                                                                        <option value="22:00">22:00</option>
                                                                        <option value="23:00">23:00</option>
                                                                    </select>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <label for="selfEndTime" class="form-label">
                                                                        <i class="fas fa-clock me-1"></i>Hora de Fin
                                                                    </label>
                                                                    <select class="form-select time-select-24h" id="selfEndTime" required>
                                                                        <option value="00:00">00:00</option>
                                                                        <option value="01:00">01:00</option>
                                                                        <option value="02:00">02:00</option>
                                                                        <option value="03:00">03:00</option>
                                                                        <option value="04:00">04:00</option>
                                                                        <option value="05:00">05:00</option>
                                                                        <option value="06:00">06:00</option>
                                                                        <option value="07:00">07:00</option>
                                                                        <option value="08:00">08:00</option>
                                                                        <option value="09:00">09:00</option>
                                                                        <option value="10:00">10:00</option>
                                                                        <option value="11:00">11:00</option>
                                                                        <option value="12:00">12:00</option>
                                                                        <option value="13:00" selected>13:00</option>
                                                                        <option value="14:00">14:00</option>
                                                                        <option value="15:00">15:00</option>
                                                                        <option value="16:00">16:00</option>
                                                                        <option value="17:00">17:00</option>
                                                                        <option value="18:00">18:00</option>
                                                                        <option value="19:00">19:00</option>
                                                                        <option value="20:00">20:00</option>
                                                                        <option value="21:00">21:00</option>
                                                                        <option value="22:00">22:00</option>
                                                                        <option value="23:00">23:00</option>
                                                                    </select>
                                                                </div>
                                                                <div class="col-12">
                                                                    <label for="selfDescription" class="form-label">
                                                                        <i class="fas fa-align-left me-1"></i>Descripción (opcional)
                                                                    </label>
                                                                    <textarea class="form-control" id="selfDescription" rows="3" 
                                                                        placeholder="Detalles adicionales sobre la actividad..."></textarea>
                                                                </div>
                                                                <div class="col-12">
                                                                    <div class="form-check">
                                                                        <input class="form-check-input" type="checkbox" id="selfRecurring">
                                                                        <label class="form-check-label" for="selfRecurring">
                                                                            <i class="fas fa-repeat me-1"></i>
                                                                            Repetir semanalmente (mismo día y hora)
                                                                        </label>
                                                                    </div>
                                                                </div>
                                                                <div class="col-12">
                                                                    <button type="submit" class="btn btn-success">
                                                                        <i class="fas fa-calendar-plus me-2"></i>Bloquear Tiempo
                                                                    </button>
                                                                    <button type="button" class="btn btn-outline-secondary ms-2" onclick="clearSelfScheduleForm()">
                                                                        <i class="fas fa-times me-2"></i>Limpiar
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>

                                                <!-- Lista de actividades bloqueadas -->
                                                <div class="card mt-4">
                                                    <div class="card-header">
                                                        <h6 class="mb-0">
                                                            <i class="fas fa-list me-2 text-info"></i>
                                                            Tiempo Bloqueado Próximo
                                                        </h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div id="selfScheduledList">
                                                            <div class="text-center py-3">
                                                                <div class="spinner-border spinner-border-sm" role="status">
                                                                    <span class="visually-hidden">Cargando...</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Sub-pestaña: Agendar Cita Directa -->
                                            <div class="tab-pane fade" id="direct-appointment-pane" role="tabpanel">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h6 class="mb-0">
                                                            <i class="fas fa-calendar-check me-2 text-primary"></i>
                                                            Crear Cita Directa para Coachee
                                                        </h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <p class="text-muted mb-4">
                                                            <i class="fas fa-info-circle me-1"></i>
                                                            Agenda una cita directamente en nombre de un coachee. Se enviará una notificación automática.
                                                        </p>
                                                        
                                                        <form id="directAppointmentForm">
                                                            <div class="row g-3">
                                                                <div class="col-md-6">
                                                                    <label for="directCoacheeSelect" class="form-label">
                                                                        <i class="fas fa-user me-1"></i>Seleccionar Coachee
                                                                    </label>
                                                                    <select class="form-select" id="directCoacheeSelect" required>
                                                                        <option value="">Cargando coachees...</option>
                                                                    </select>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <label for="directSessionType" class="form-label">
                                                                        <i class="fas fa-comments me-1"></i>Tipo de Sesión
                                                                    </label>
                                                                    <select class="form-select" id="directSessionType" required>
                                                                        <option value="">Seleccionar tipo...</option>
                                                                        <option value="coaching">Sesión de Coaching</option>
                                                                        <option value="follow-up">Seguimiento</option>
                                                                        <option value="evaluation">Evaluación de Progreso</option>
                                                                        <option value="planning">Planificación de Objetivos</option>
                                                                        <option value="feedback">Retroalimentación</option>
                                                                        <option value="support">Sesión de Apoyo</option>
                                                                        <option value="other">Otra</option>
                                                                    </select>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <label for="directDate" class="form-label">
                                                                        <i class="fas fa-calendar me-1"></i>Fecha
                                                                    </label>
                                                                    <input type="date" class="form-control" id="directDate" required>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <label for="directStartTime" class="form-label">
                                                                        <i class="fas fa-clock me-1"></i>Hora de Inicio
                                                                    </label>
                                                                    <select class="form-select time-select-24h" id="directStartTime" required>
                                                                        <option value="00:00">00:00</option>
                                                                        <option value="01:00">01:00</option>
                                                                        <option value="02:00">02:00</option>
                                                                        <option value="03:00">03:00</option>
                                                                        <option value="04:00">04:00</option>
                                                                        <option value="05:00">05:00</option>
                                                                        <option value="06:00">06:00</option>
                                                                        <option value="07:00">07:00</option>
                                                                        <option value="08:00">08:00</option>
                                                                        <option value="09:00">09:00</option>
                                                                        <option value="10:00" selected>10:00</option>
                                                                        <option value="11:00">11:00</option>
                                                                        <option value="12:00">12:00</option>
                                                                        <option value="13:00">13:00</option>
                                                                        <option value="14:00">14:00</option>
                                                                        <option value="15:00">15:00</option>
                                                                        <option value="16:00">16:00</option>
                                                                        <option value="17:00">17:00</option>
                                                                        <option value="18:00">18:00</option>
                                                                        <option value="19:00">19:00</option>
                                                                        <option value="20:00">20:00</option>
                                                                        <option value="21:00">21:00</option>
                                                                        <option value="22:00">22:00</option>
                                                                        <option value="23:00">23:00</option>
                                                                    </select>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <label for="directEndTime" class="form-label">
                                                                        <i class="fas fa-clock me-1"></i>Hora de Fin
                                                                    </label>
                                                                    <select class="form-select time-select-24h" id="directEndTime" required>
                                                                        <option value="00:00">00:00</option>
                                                                        <option value="01:00">01:00</option>
                                                                        <option value="02:00">02:00</option>
                                                                        <option value="03:00">03:00</option>
                                                                        <option value="04:00">04:00</option>
                                                                        <option value="05:00">05:00</option>
                                                                        <option value="06:00">06:00</option>
                                                                        <option value="07:00">07:00</option>
                                                                        <option value="08:00">08:00</option>
                                                                        <option value="09:00">09:00</option>
                                                                        <option value="10:00">10:00</option>
                                                                        <option value="11:00" selected>11:00</option>
                                                                        <option value="12:00">12:00</option>
                                                                        <option value="13:00">13:00</option>
                                                                        <option value="14:00">14:00</option>
                                                                        <option value="15:00">15:00</option>
                                                                        <option value="16:00">16:00</option>
                                                                        <option value="17:00">17:00</option>
                                                                        <option value="18:00">18:00</option>
                                                                        <option value="19:00">19:00</option>
                                                                        <option value="20:00">20:00</option>
                                                                        <option value="21:00">21:00</option>
                                                                        <option value="22:00">22:00</option>
                                                                        <option value="23:00">23:00</option>
                                                                    </select>
                                                                </div>
                                                                <div class="col-12">
                                                                    <label for="directSessionNotes" class="form-label">
                                                                        <i class="fas fa-sticky-note me-1"></i>Notas de la Sesión
                                                                    </label>
                                                                    <textarea class="form-control" id="directSessionNotes" rows="3" 
                                                                        placeholder="Objetivo de la sesión, temas a tratar, preparación necesaria..."></textarea>
                                                                </div>
                                                                <div class="col-12">
                                                                    <label for="directNotificationMessage" class="form-label">
                                                                        <i class="fas fa-envelope me-1"></i>Mensaje de Notificación
                                                                    </label>
                                                                    <textarea class="form-control" id="directNotificationMessage" rows="2" 
                                                                        placeholder="Mensaje personalizado que se enviará al coachee junto con la cita..."></textarea>
                                                                </div>
                                                                <div class="col-12">
                                                                    <div class="form-check">
                                                                        <input class="form-check-input" type="checkbox" id="directSendNotification" checked>
                                                                        <label class="form-check-label" for="directSendNotification">
                                                                            <i class="fas fa-bell me-1"></i>
                                                                            Enviar notificación inmediata al coachee
                                                                        </label>
                                                                    </div>
                                                                </div>
                                                                <div class="col-12">
                                                                    <button type="submit" class="btn btn-primary">
                                                                        <i class="fas fa-calendar-plus me-2"></i>Crear Cita Directa
                                                                    </button>
                                                                    <button type="button" class="btn btn-outline-secondary ms-2" onclick="clearDirectAppointmentForm()">
                                                                        <i class="fas fa-times me-2"></i>Limpiar
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>

                                                <!-- Lista de citas directas creadas -->
                                                <div class="card mt-4">
                                                    <div class="card-header">
                                                        <h6 class="mb-0">
                                                            <i class="fas fa-history me-2 text-warning"></i>
                                                            Citas Directas Recientes
                                                        </h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div id="directAppointmentsList">
                                                            <div class="text-center py-3">
                                                                <div class="spinner-border spinner-border-sm" role="status">
                                                                    <span class="visually-hidden">Cargando...</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para proponer nuevo horario -->
<div class="modal fade" id="proposeTimeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-clock me-2"></i>Proponer Nuevo Horario
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="proposeTimeForm">
                    <input type="hidden" id="originalSessionId">
                    
                    <div class="mb-3">
                        <label class="form-label">Coachee:</label>
                        <p class="fw-bold text-primary" id="proposeCoacheeName">-</p>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="proposedDate" class="form-label">Nueva Fecha</label>
                            <input type="date" class="form-control" id="proposedDate" required>
                        </div>
                        <div class="col-md-6">
                            <label for="proposedStartTime" class="form-label">Hora de Inicio</label>
                            <select class="form-select time-select-24h" id="proposedStartTime" required>
                                <option value="00:00">00:00</option>
                                <option value="01:00">01:00</option>
                                <option value="02:00">02:00</option>
                                <option value="03:00">03:00</option>
                                <option value="04:00">04:00</option>
                                <option value="05:00">05:00</option>
                                <option value="06:00">06:00</option>
                                <option value="07:00">07:00</option>
                                <option value="08:00">08:00</option>
                                <option value="09:00">09:00</option>
                                <option value="10:00" selected>10:00</option>
                                <option value="11:00">11:00</option>
                                <option value="12:00">12:00</option>
                                <option value="13:00">13:00</option>
                                <option value="14:00">14:00</option>
                                <option value="15:00">15:00</option>
                                <option value="16:00">16:00</option>
                                <option value="17:00">17:00</option>
                                <option value="18:00">18:00</option>
                                <option value="19:00">19:00</option>
                                <option value="20:00">20:00</option>
                                <option value="21:00">21:00</option>
                                <option value="22:00">22:00</option>
                                <option value="23:00">23:00</option>
                                <option value="24:00">24:00</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="proposedEndTime" class="form-label">Hora de Fin</label>
                            <select class="form-select time-select-24h" id="proposedEndTime" required>
                                <option value="00:00">00:00</option>
                                <option value="01:00">01:00</option>
                                <option value="02:00">02:00</option>
                                <option value="03:00">03:00</option>
                                <option value="04:00">04:00</option>
                                <option value="05:00">05:00</option>
                                <option value="06:00">06:00</option>
                                <option value="07:00">07:00</option>
                                <option value="08:00">08:00</option>
                                <option value="09:00">09:00</option>
                                <option value="10:00">10:00</option>
                                <option value="11:00" selected>11:00</option>
                                <option value="12:00">12:00</option>
                                <option value="13:00">13:00</option>
                                <option value="14:00">14:00</option>
                                <option value="15:00">15:00</option>
                                <option value="16:00">16:00</option>
                                <option value="17:00">17:00</option>
                                <option value="18:00">18:00</option>
                                <option value="19:00">19:00</option>
                                <option value="20:00">20:00</option>
                                <option value="21:00">21:00</option>
                                <option value="22:00">22:00</option>
                                <option value="23:00">23:00</option>
                                <option value="24:00">24:00</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label for="proposalMessage" class="form-label">Mensaje (opcional)</label>
                            <textarea class="form-control" id="proposalMessage" rows="3" 
                                placeholder="Explica el motivo del cambio de horario..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="submitTimeProposal()">
                    <i class="fas fa-paper-plane me-2"></i>Enviar Propuesta
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver evaluaciones del coachee -->
<div class="modal fade" id="coacheeEvaluationsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Evaluaciones Completadas <span id="modalCoacheeName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="coacheeEvaluationsContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver detalles de evaluación -->
<div class="modal fade" id="evaluationDetailsModal" tabindex="-1" aria-labelledby="evaluationDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header modal-header-dark">
                <h5 class="modal-title" id="evaluationDetailsModalLabel">
                    <i class="fas fa-chart-radar me-2"></i>
                    Detalles de Evaluación
                </h5>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-light btn-sm" onclick="printEvaluationReport()" title="Imprimir Reporte">
                        <i class="fas fa-print me-1"></i>
                        Imprimir
                    </button>
                    <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal" title="Cerrar">
                        <i class="fas fa-times me-1"></i>
                        Cerrar
                    </button>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body" id="evaluationDetailsContent">
                <div class="loading-spinner">
                    <div class="spinner-border spinner-border-custom" role="status">
                        <span class="visually-hidden">Cargando detalles...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-progress" onclick="printEvaluationReport()">
                    <i class="fas fa-print me-2"></i>
                    Imprimir Reporte
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para asignar evaluación/tarea -->
<div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Asignar a <span id="assignModalCoacheeName"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Pestañas -->
                <ul class="nav nav-tabs mb-3" id="assignTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="evaluation-tab" data-bs-toggle="tab" data-bs-target="#evaluation-pane" type="button" role="tab">
                            <i class="fas fa-clipboard-check me-1"></i>Evaluación
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="task-tab" data-bs-toggle="tab" data-bs-target="#task-pane" type="button" role="tab">
                            <i class="fas fa-tasks me-1"></i>Tarea
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="assignTabContent">
                    <!-- Pestaña de Evaluación -->
                    <div class="tab-pane fade show active" id="evaluation-pane" role="tabpanel">
                        <form id="assignEvaluationForm">
                            <input type="hidden" id="targetCoacheeId" value="">
                            
                            <div class="mb-3">
                                <label for="assignAssessmentSelect" class="form-label">Seleccionar evaluación:</label>
                                <select class="form-select" id="assignAssessmentSelect" required>
                                    <option value="">Cargando evaluaciones...</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="assignEvaluationMessage" class="form-label">Mensaje personalizado (opcional):</label>
                                <textarea class="form-control" id="assignEvaluationMessage" rows="3" 
                                    placeholder="Mensaje para el coachee..."></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="assignEvaluationDueDate" class="form-label">Fecha límite (opcional):</label>
                                <input type="date" class="form-control" id="assignEvaluationDueDate">
                            </div>
                        </form>
                    </div>

                    <!-- Pestaña de Tarea -->
                    <div class="tab-pane fade" id="task-pane" role="tabpanel">
                        <form id="assignTaskForm">
                            <div class="mb-3">
                                <label for="assignTaskTitle" class="form-label">Título de la tarea:</label>
                                <input type="text" class="form-control" id="assignTaskTitle" required
                                    placeholder="Ej: Completar ejercicio de reflexión">
                            </div>
                            
                            <div class="mb-3">
                                <label for="assignTaskDescription" class="form-label">Descripción:</label>
                                <textarea class="form-control" id="assignTaskDescription" rows="4" required
                                    placeholder="Describe la tarea que debe realizar el coachee..."></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="assignTaskCategory" class="form-label">Categoría:</label>
                                <select class="form-select" id="assignTaskCategory" required>
                                    <option value="">Seleccionar categoría</option>
                                    <option value="evaluation">Evaluación</option>
                                    <option value="coaching">Coaching</option>
                                    <option value="development">Desarrollo</option>
                                    <option value="feedback">Feedback</option>
                                    <option value="reflection">Reflexión</option>
                                    <option value="goal">Objetivo</option>
                                    <option value="other">Otro</option>
                                </select>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="assignTaskPriority" class="form-label">Prioridad:</label>
                                    <select class="form-select" id="assignTaskPriority">
                                        <option value="medium">Media</option>
                                        <option value="high">Alta</option>
                                        <option value="low">Baja</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="assignTaskDueDate" class="form-label">Fecha límite (opcional):</label>
                                    <input type="date" class="form-control" id="assignTaskDueDate">
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="executeAssignment()">
                    <i class="fas fa-paper-plane me-1"></i>Asignar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para mostrar evaluaciones asignadas -->
<div class="modal fade" id="assignedAssessmentsModal" tabindex="-1" aria-labelledby="assignedAssessmentsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="assignedAssessmentsModalLabel">
                    <i class="fas fa-clipboard-list me-2"></i>Evaluaciones Asignadas
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="assignedAssessmentsContent">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin fa-2x text-info"></i>
                        <p class="mt-2">Cargando evaluaciones asignadas...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar coachee -->
<div class="modal fade" id="editCoacheeModal" tabindex="-1" aria-labelledby="editCoacheeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="editCoacheeModalLabel">
                    <i class="fas fa-edit me-2"></i>Editar Coachee
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editCoacheeForm">
                    <input type="hidden" id="editCoacheeId" name="coacheeId">
                    
                    <div class="mb-3">
                        <label for="editCoacheeName" class="form-label">
                            <i class="fas fa-user me-1"></i>Nombre Completo
                        </label>
                        <input type="text" class="form-control" id="editCoacheeName" name="full_name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editCoacheeEmail" class="form-label">
                            <i class="fas fa-envelope me-1"></i>Email
                        </label>
                        <input type="email" class="form-control" id="editCoacheeEmail" name="email" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editCoacheePassword" class="form-label">
                            <i class="fas fa-lock me-1"></i>Nueva Contraseña
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="editCoacheePassword" name="password" placeholder="Dejar vacío para mantener la actual">
                            <button type="button" class="btn btn-outline-secondary" onclick="toggleEditPassword()">
                                <i class="fas fa-eye" id="editPasswordIcon"></i>
                            </button>
                        </div>
                        <div class="form-text">Mínimo 4 caracteres. Dejar vacío para no cambiar la contraseña.</div>
                    </div>
                </form>
                
                <div id="editCoacheeAlert" class="alert d-none" role="alert"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-warning" onclick="saveCoacheeChanges()" id="saveCoacheeBtn">
                    <i class="fas fa-save me-1"></i>Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/static/js/recommendations.js?v={{ get_file_version('js/recommendations.js') }}"></script>
<link rel="stylesheet" href="/static/css/unified-dashboard.css?v={{ get_file_version('css/unified-dashboard.css') }}">

<script>
// Variables globales
let coacheesData = [];
let tasksData = [];

// Initialize particles animation - IGUAL QUE COACHEE
function createParticles() {
    const particlesContainer = document.querySelector('.particles');
    for (let i = 0; i < 30; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 20 + 's';
        particle.style.width = particle.style.height = (Math.random() * 4 + 2) + 'px';
        particle.style.animationDuration = (Math.random() * 10 + 20) + 's';
        particlesContainer.appendChild(particle);
    }
}

// Función para mostrar módulos
function showModule(moduleId) {
    // Prevenir scroll automático
    if (event) {
        event.preventDefault();
    }
    
    // Colapsar todas las tarjetas de coachees al cambiar de sección
    collapseAllCoacheeCards();
    
    // Ocultar todos los módulos
    document.querySelectorAll('.module-content').forEach(module => {
        module.style.display = 'none';
    });
    
    // Remover clase active de todos los enlaces
    document.querySelectorAll('[data-module]').forEach(link => {
        link.classList.remove('active');
    });
    
    // Mostrar módulo seleccionado
    const selectedModule = document.getElementById(moduleId);
    if (selectedModule) {
        selectedModule.style.display = 'block';
        
        // En móviles, hacer scroll suave hacia el contenido
        if (window.innerWidth <= 768) {
            setTimeout(() => {
                selectedModule.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start',
                    inline: 'nearest'
                });
            }, 100);
        }
    }
    
    // Agregar clase active al enlace seleccionado
    const selectedLink = document.querySelector(`[data-module="${moduleId}"]`);
    if (selectedLink) {
        selectedLink.classList.add('active');
    }
    
    // Cargar datos específicos del módulo si es necesario
    if (moduleId === 'mis-coachees') {
        loadCoachees();
    } else if (moduleId === 'gestion-tareas') {
        loadTasks();
    } else if (moduleId === 'gestion-acciones') {
        loadTasks(); // Cargar tareas y evaluaciones pendientes
    } else if (moduleId === 'seleccionar-evaluaciones') {
        loadAvailableAssessments();
    } else if (moduleId === 'invitar-coachee') {
        console.log('📋 MODULE-SWITCH: Activando módulo invitar-coachee - cargando evaluaciones');
        loadAssessmentsForInvitation();
    } else if (moduleId === 'agenda') {
        setTimeout(initializeAgenda, 100);
        // Configurar listeners para gestión de citas si está en esa pestaña
        setTimeout(() => {
            const appointmentTab = document.getElementById('appointment-management-tab');
            if (appointmentTab && appointmentTab.classList.contains('active')) {
                setupAppointmentManagementListeners();
            }
        }, 200);
    }
    
    return false; // Prevenir comportamiento por defecto
}

// Función para refrescar dashboard
function refreshDashboard() {
    loadCoachees();
    loadTasks();
    loadStats();
}

// Función de logout específica para coach
async function logoutCoach() {
    try {
        const response = await fetch('/api/coach/logout', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            console.log('Coach logout successful');
        } else {
            console.error('Coach logout failed');
        }
        
        // Redirigir al coach login independientemente del resultado
        window.location.href = '/coach-login';
        
    } catch (error) {
        console.error('Error during coach logout:', error);
        // Aún así redirigir en caso de error
        window.location.href = '/coach-login';
    }
}

// Función para cargar estadísticas
function loadStats() {
    console.log('🔄 STATS: Starting to load stats...');
    
    // Verificar que los elementos del DOM existan
    const elements = {
        totalCoachees: document.getElementById('totalCoachees'),
        completedAssessments: document.getElementById('completedAssessments'),
        pendingAssessments: document.getElementById('pendingAssessments'),
        avgScore: document.getElementById('avgScore'),
        coachName: document.getElementById('coachName'),
        headerCoachAvatar: document.getElementById('headerCoachAvatar'),
        currentDate: document.getElementById('currentDate'),
        currentTime: document.getElementById('currentTime')
    };
    
    console.log('🔍 STATS: DOM elements check:', elements);
    
    // Verificar elementos faltantes
    const missingElements = Object.keys(elements).filter(key => !elements[key]);
    if (missingElements.length > 0) {
        console.error('❌ STATS: Missing DOM elements:', missingElements);
    }
    
    // Función para actualizar fecha y hora
    function updateDateTime() {
        const now = new Date();
        const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
        
        if (elements.currentDate) {
            elements.currentDate.textContent = now.toLocaleDateString('es-ES', dateOptions);
        }
        if (elements.currentTime) {
            elements.currentTime.textContent = now.toLocaleTimeString('es-ES', timeOptions);
        }
    }
    
    // Actualizar fecha y hora cada segundo
    updateDateTime();
    setInterval(updateDateTime, 1000);
    
    fetch('/api/coach/profile')
        .then(response => response.json())
        .then(data => {
            console.log('👤 PROFILE: Received profile data:', data);
            if (data.success) {
                const profile = data.profile;
                const displayName = profile.full_name || profile.username || 'Coach';
                
                // Actualizar nombre
                if (elements.coachName) {
                    elements.coachName.textContent = displayName;
                }
                
                // Actualizar avatar
                if (elements.headerCoachAvatar) {
                    if (profile.avatar_url) {
                        elements.headerCoachAvatar.innerHTML = `<img src="${profile.avatar_url}" alt="${displayName}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                    } else {
                        const initial = displayName.charAt(0).toUpperCase();
                        elements.headerCoachAvatar.innerHTML = initial;
                    }
                    
                    // Agregar efecto hover
                    elements.headerCoachAvatar.addEventListener('mouseenter', function() {
                        this.style.transform = 'scale(1.1)';
                    });
                    elements.headerCoachAvatar.addEventListener('mouseleave', function() {
                        this.style.transform = 'scale(1)';
                    });
                }
            }
        })
        .catch(error => console.error('❌ PROFILE: Error loading coach profile:', error));
    
    // Cargar estadísticas generales
    fetch('/api/coach/my-coachees')
        .then(response => response.json())
        .then(data => {
            console.log('📊 STATS: Received data:', data); // Debug log
            
            if (data.success) {
                // Actualizar total de coachees
                if (elements.totalCoachees) {
                    elements.totalCoachees.textContent = data.coachees.length;
                }
                
                let totalEvaluations = 0;
                let totalScore = 0;
                let evaluationsWithScore = 0;
                
                // Calcular estadísticas basado en la nueva estructura
                data.coachees.forEach(coachee => {
                    console.log(`👤 STATS: Processing coachee ${coachee.name}:`, coachee); // Debug log
                    
                    // Contar evaluaciones completadas
                    if (coachee.evaluations_count) {
                        totalEvaluations += coachee.evaluations_count;
                    }
                    
                    // Sumar scores para promedio
                    if (coachee.avg_score) {
                        totalScore += coachee.avg_score * coachee.evaluations_count;
                        evaluationsWithScore += coachee.evaluations_count;
                    }
                });
                
                // Actualizar las tarjetas de estadísticas
                if (elements.completedAssessments) {
                    elements.completedAssessments.textContent = totalEvaluations;
                }
                
                // Calcular evaluaciones pendientes: Tareas asignadas - Completadas
                if (elements.pendingAssessments) {
                    const assignedTasks = data.assigned_evaluation_tasks || 0;
                    const pendingCount = assignedTasks - totalEvaluations;
                    elements.pendingAssessments.textContent = Math.max(0, pendingCount); // Asegurar no negativos
                    console.log(`📊 STATS: Pending = ${assignedTasks} assigned tasks - ${totalEvaluations} completed = ${pendingCount}`);
                }
                
                // Calcular promedio general
                const avgScore = evaluationsWithScore > 0 ? Math.round(totalScore / evaluationsWithScore) : 0;
                if (elements.avgScore) {
                    elements.avgScore.textContent = avgScore + '%';
                }
                
                console.log(`📊 STATS: Updated - Coachees: ${data.coachees.length}, Completed: ${totalEvaluations}, Avg: ${avgScore}%`);
            }
        })
        .catch(error => {
            console.error('❌ STATS: Error loading stats:', error);
            // Mostrar valores por defecto en caso de error
            if (elements.totalCoachees) elements.totalCoachees.textContent = '0';
            if (elements.completedAssessments) elements.completedAssessments.textContent = '0';
            if (elements.pendingAssessments) elements.pendingAssessments.textContent = '0';
            if (elements.avgScore) elements.avgScore.textContent = '0%';
        });
}

// Función para cargar evaluaciones disponibles con caching optimizado
function loadAvailableAssessments(forceRefresh = false) {
    const loadingElement = document.getElementById('assessments-loading');
    const listElement = document.getElementById('assessments-list');
    const errorElement = document.getElementById('assessments-error');
    const noAssessmentsElement = document.getElementById('no-assessments');
    
    // OPTIMIZACIÓN: Intentar cargar desde cache primero si existe
    const cacheKey = 'coach_assessments_cache';
    const cacheTimeKey = 'coach_assessments_cache_time';
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutos
    
    if (!forceRefresh) {
        try {
            const cachedData = localStorage.getItem(cacheKey);
            const cacheTime = localStorage.getItem(cacheTimeKey);
            
            if (cachedData && cacheTime) {
                const age = Date.now() - parseInt(cacheTime);
                if (age < CACHE_DURATION) {
                    console.log('📦 Using cached assessments data (age: ' + Math.round(age/1000) + 's)');
                    const data = JSON.parse(cachedData);
                    
                    // Mostrar datos del cache inmediatamente
                    loadingElement.style.display = 'none';
                    if (data.assessments && data.assessments.length > 0) {
                        displayAvailableAssessments(data.assessments);
                        listElement.style.display = 'block';
                    } else {
                        noAssessmentsElement.style.display = 'block';
                    }
                    
                    // Actualizar en segundo plano si el cache tiene más de 2 minutos
                    if (age > 2 * 60 * 1000) {
                        console.log('🔄 Cache old, refreshing in background...');
                        setTimeout(() => loadAvailableAssessments(true), 100);
                    }
                    return; // Salir temprano con datos del cache
                }
            }
        } catch (e) {
            console.warn('⚠️ Error reading cache:', e);
        }
    }
    
    // Mostrar loading y ocultar otros elementos
    loadingElement.style.display = 'block';
    listElement.style.display = 'none';
    errorElement.style.display = 'none';
    noAssessmentsElement.style.display = 'none';
    
    // Cache-busting: agregar timestamp para evitar problemas de caché
    const cacheBuster = new Date().getTime();
    
    fetch(`/api/coach/available-assessments?_=${cacheBuster}`, {
        method: 'GET',
        headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache'
        },
        credentials: 'same-origin'
    })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Evaluaciones recibidas:', data);
            loadingElement.style.display = 'none';
            
            // OPTIMIZACIÓN: Guardar en cache si la respuesta es exitosa
            if (data && data.success === true) {
                try {
                    localStorage.setItem(cacheKey, JSON.stringify(data));
                    localStorage.setItem(cacheTimeKey, Date.now().toString());
                    console.log('💾 Cached assessments data');
                } catch (e) {
                    console.warn('⚠️ Could not save to cache:', e);
                }
            }
            
            // Mejor validación de datos
            if (data && data.success === true) {
                if (data.assessments && Array.isArray(data.assessments) && data.assessments.length > 0) {
                    displayAvailableAssessments(data.assessments);
                    listElement.style.display = 'block';
                } else {
                    console.log('No hay evaluaciones disponibles');
                    noAssessmentsElement.style.display = 'block';
                }
            } else if (data && data.success === false) {
                // Error del servidor pero con respuesta estructurada
                console.error('Error del servidor:', data.error || data.message);
                errorElement.style.display = 'block';
                errorElement.querySelector('p').textContent = data.error || 'Error al cargar evaluaciones';
            } else {
                console.warn('Respuesta inesperada:', data);
                noAssessmentsElement.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading assessments:', error);
            console.error('Error details:', error.message);
            loadingElement.style.display = 'none';
            errorElement.style.display = 'block';
            
            // Mostrar mensaje de error más informativo
            const errorMsg = errorElement.querySelector('p');
            if (errorMsg) {
                errorMsg.textContent = `Error de conexión: ${error.message}. Por favor, actualiza la página.`;
            }
        });
}

// Función para mostrar evaluaciones disponibles
function displayAvailableAssessments(assessments) {
    const container = document.getElementById('assessments-list');
    container.innerHTML = '';
    
    if (assessments.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-search text-muted mb-3" style="font-size: 2rem;"></i>
                <h6 class="text-muted">No se encontraron evaluaciones</h6>
                <p class="text-muted small">No hay evaluaciones disponibles en este momento.</p>
            </div>
        `;
        return;
    }
    
    // Categorizar evaluaciones por tipo
    const categories = {
        'Personalidad': {
            icon: 'fa-user-circle',
            color: '#6f42c1',
            assessments: []
        },
        'Liderazgo': {
            icon: 'fa-crown',
            color: '#fd7e14',
            assessments: []
        },
        'Inteligencia Emocional': {
            icon: 'fa-heart',
            color: '#e83e8c',
            assessments: []
        },
        'Trabajo en Equipo': {
            icon: 'fa-users',
            color: '#20c997',
            assessments: []
        },
        'Crecimiento Empresarial': {
            icon: 'fa-chart-line',
            color: '#17a2b8',
            assessments: []
        },
        'Otros': {
            icon: 'fa-clipboard-list',
            color: '#6c757d',
            assessments: []
        }
    };
    
    // Clasificar evaluaciones por categoría
    assessments.forEach(assessment => {
        const title = assessment.title.toLowerCase();
        
        if (title.includes('disc') || title.includes('personalidad') || title.includes('asertividad')) {
            categories['Personalidad'].assessments.push(assessment);
        } else if (title.includes('liderazgo')) {
            categories['Liderazgo'].assessments.push(assessment);
        } else if (title.includes('inteligencia emocional') || title.includes('emocional')) {
            categories['Inteligencia Emocional'].assessments.push(assessment);
        } else if (title.includes('trabajo en equipo') || title.includes('equipo')) {
            categories['Trabajo en Equipo'].assessments.push(assessment);
        } else if (title.includes('crecer') || title.includes('crecimiento') || title.includes('preparación')) {
            categories['Crecimiento Empresarial'].assessments.push(assessment);
        } else {
            categories['Otros'].assessments.push(assessment);
        }
    });
    
    // Renderizar categorías con evaluaciones
    let totalDisplayed = 0;
    Object.keys(categories).forEach(categoryName => {
        const category = categories[categoryName];
        
        if (category.assessments.length === 0) {
            return; // Saltar categorías vacías
        }
        
        // Crear contenedor de categoría estilo landing page con collapse
        const categorySection = document.createElement('div');
        categorySection.className = 'assessment-category mb-4';
        const categoryId = `category-${categoryName.replace(/\s+/g, '-')}`;
        categorySection.innerHTML = `
            <div class="section-header-eval" style="margin: 30px 0 20px 0; padding: 15px; border-bottom: 2px solid ${category.color}; cursor: pointer; transition: all 0.3s ease; border-radius: 8px;" onclick="toggleCategory('${categoryId}', this)" onmouseover="this.style.backgroundColor='${category.color}10'" onmouseout="this.style.backgroundColor='transparent'">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h4 style="color: #262626; font-size: 24px; font-weight: 600; margin: 0;">
                        <i class="fas ${category.icon} me-2" style="color: ${category.color};"></i>
                        ${categoryName}
                        <span style="color: ${category.color}; font-size: 18px; font-weight: 500; margin-left: 8px;">(${category.assessments.length})</span>
                    </h4>
                    <i class="fas fa-chevron-down" id="icon-${categoryId}" style="color: ${category.color}; font-size: 20px; transition: transform 0.3s ease; transform: rotate(-90deg);"></i>
                </div>
            </div>
            <div class="assessments-grid" id="${categoryId}" data-expanded="false" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; margin-bottom: 0px; overflow: hidden; max-height: 0px; opacity: 0; transition: max-height 0.5s ease, opacity 0.3s ease;">
            </div>
        `;
        
        container.appendChild(categorySection);
        
        // Agregar evaluaciones a la categoría
        const categoryContainer = categorySection.querySelector('.assessments-grid');
        category.assessments.forEach((assessment, index) => {
            const card = document.createElement('div');
            card.className = 'assessment-card';
            card.setAttribute('data-assessment-id', assessment.id);
            
            // Agregar animación de entrada escalonada
            card.style.animationDelay = `${totalDisplayed * 0.1}s`;
            totalDisplayed++;
            
            const createdDate = assessment.created_at ? 
                new Date(assessment.created_at).toLocaleDateString('es-ES', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                }) : 'No disponible';
            
            // Determinar color del badge basado en estadísticas
            const badgeClass = assessment.completed_count > 0 ? 'success' : 'primary';
            const badgeIcon = assessment.completed_count > 0 ? 'check-circle' : 'clipboard-list';
            
            card.innerHTML = `
                <div class="assessment-image" style="width: 100%; height: 180px; background: linear-gradient(135deg, ${category.color} 0%, ${category.color}dd 100%); display: flex; align-items: center; justify-content: center; font-size: 64px; color: white;">
                    <i class="fas ${category.icon}"></i>
                </div>
                <div class="assessment-body" style="padding: 16px;">
                    <div class="assessment-title" style="font-size: 18px; font-weight: 600; color: #262626; margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                        ${assessment.title}
                    </div>
                    <div class="assessment-description" style="font-size: 14px; color: #8e8e8e; margin-bottom: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                        ${assessment.description || 'Sin descripción disponible'}
                    </div>
                    <div class="assessment-meta" style="display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #8e8e8e; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-users" style="color: ${category.color};"></i>
                            <span>${assessment.completed_count} ${assessment.completed_count === 1 ? 'completada' : 'completadas'}</span>
                        </div>
                        <div class="assessment-badge" style="background: linear-gradient(135deg, ${category.color} 0%, ${category.color}dd 100%); color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
                            ${assessment.questions_count} ${assessment.questions_count === 1 ? 'pregunta' : 'preguntas'}
                        </div>
                    </div>
                    <div class="assessment-actions" style="display: flex; gap: 8px;">
                        <button class="btn btn-sm flex-fill" style="background: ${category.color}; color: white; border: none; padding: 8px 12px; border-radius: 8px; font-weight: 500; transition: all 0.2s;" onclick="event.stopPropagation(); openAssignModalFromEvaluation(${assessment.id}, '${assessment.title}')" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                            <i class="fas fa-user-plus me-1"></i>Asignar
                        </button>
                        <button class="btn btn-outline-secondary btn-sm flex-fill" style="border: 2px solid ${category.color}30; color: ${category.color}; padding: 8px 12px; border-radius: 8px; font-weight: 500; transition: all 0.2s;" onclick="event.stopPropagation(); viewAssessmentQuestions(${assessment.id}, '${assessment.title}')" onmouseover="this.style.background='${category.color}15'" onmouseout="this.style.background='transparent'">
                            <i class="fas fa-list me-1"></i>Ver
                        </button>
                    </div>
                </div>
            `;
            
            categoryContainer.appendChild(card);
        });
    });
}

// Función para expandir/contraer categorías
function toggleCategory(categoryId, headerElement) {
    const categoryGrid = document.getElementById(categoryId);
    const icon = document.getElementById(`icon-${categoryId}`);
    const isExpanded = categoryGrid.getAttribute('data-expanded') === 'true';
    
    if (isExpanded) {
        // Contraer
        categoryGrid.style.maxHeight = '0px';
        categoryGrid.style.opacity = '0';
        categoryGrid.style.marginBottom = '0px';
        categoryGrid.style.paddingTop = '0px';
        icon.style.transform = 'rotate(-90deg)';
        categoryGrid.setAttribute('data-expanded', 'false');
    } else {
        // Expandir
        categoryGrid.style.maxHeight = '5000px';
        categoryGrid.style.opacity = '1';
        categoryGrid.style.marginBottom = '30px';
        categoryGrid.style.paddingTop = '0px';
        icon.style.transform = 'rotate(0deg)';
        categoryGrid.setAttribute('data-expanded', 'true');
    }
}

// Función para seleccionar una evaluación
function selectAssessment(assessmentId) {
    // Añadir feedback visual inmediato
    const allCards = document.querySelectorAll('.assessment-card');
    const selectedCard = document.querySelector(`[data-assessment-id="${assessmentId}"]`);
    
    // Remover selección previa
    allCards.forEach(card => {
        card.classList.remove('selected');
        card.style.transform = '';
    });
    
    // Añadir selección actual con animación
    if (selectedCard) {
        selectedCard.classList.add('selected');
        
        // Efecto de pulso para feedback táctil en móvil
        selectedCard.style.transform = 'scale(0.98)';
        setTimeout(() => {
            selectedCard.style.transform = 'scale(1)';
        }, 150);
        
        // Añadir indicador visual de selección
        const existingCheck = selectedCard.querySelector('.selection-indicator');
        if (existingCheck) {
            existingCheck.remove();
        }
        
        const selectionIndicator = document.createElement('div');
        selectionIndicator.className = 'selection-indicator';
        selectionIndicator.innerHTML = '<i class="fas fa-check-circle"></i>';
        selectedCard.appendChild(selectionIndicator);
    }
    
    // Mostrar modal de confirmación optimizado para móvil
    const assessmentCard = selectedCard;
    const assessmentTitle = assessmentCard.querySelector('.assessment-title').textContent;
    const assessmentDescription = assessmentCard.querySelector('.assessment-description').textContent;
    
    // Crear modal responsive
    const modalHtml = `
        <div class="modal fade" id="confirmAssessmentModal" tabindex="-1" aria-labelledby="confirmAssessmentModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="confirmAssessmentModalLabel">
                            <i class="fas fa-clipboard-check me-2"></i>Confirmar Evaluación
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-3">
                            <div class="assessment-preview-card">
                                <h6 class="fw-bold text-primary">${assessmentTitle}</h6>
                                <p class="text-muted small mb-0">${assessmentDescription}</p>
                            </div>
                        </div>
                        
                        <div class="alert alert-info d-flex align-items-start">
                            <i class="fas fa-info-circle me-2 mt-1"></i>
                            <div>
                                <strong>¿Deseas asignar esta evaluación?</strong>
                                <br><small>Podrás enviarla a tus coachees para que la completen.</small>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer flex-column flex-sm-row">
                        <button type="button" class="btn btn-outline-secondary mb-2 mb-sm-0 w-100 w-sm-auto" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </button>
                        <button type="button" class="btn btn-primary w-100 w-sm-auto" onclick="confirmAssignAssessment(${assessmentId})">
                            <i class="fas fa-paper-plane me-1"></i>Asignar Evaluación
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal previo si existe
    const existingModal = document.getElementById('confirmAssessmentModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Añadir nuevo modal al DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Mostrar modal con mejor experiencia móvil
    const modal = new bootstrap.Modal(document.getElementById('confirmAssessmentModal'), {
        backdrop: 'static',
        keyboard: true
    });
    
    modal.show();
    
    // Limpiar modal cuando se cierre
    document.getElementById('confirmAssessmentModal').addEventListener('hidden.bs.modal', function () {
        this.remove();
        // Remover selección visual
        if (selectedCard) {
            selectedCard.classList.remove('selected');
            const indicator = selectedCard.querySelector('.selection-indicator');
            if (indicator) {
                indicator.remove();
            }
        }
    });
}

// Función para confirmar la asignación de evaluación
function confirmAssignAssessment(assessmentId) {
    // Cerrar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('confirmAssessmentModal'));
    if (modal) {
        modal.hide();
    }
    
    // Mostrar notificación de éxito con mejor UX móvil
    showNotification('Evaluación asignada exitosamente', 'success');
    
    // Opcional: Aquí se puede agregar lógica para realizar la asignación real
    console.log('Evaluación confirmada:', assessmentId);
    
    // Feedback visual adicional
    setTimeout(() => {
        // Limpiar selecciones
        document.querySelectorAll('.assessment-card').forEach(card => {
            card.classList.remove('selected');
            const indicator = card.querySelector('.selection-indicator');
            if (indicator) {
                indicator.remove();
            }
        });
    }, 1000);
}

// Función para ver las preguntas de una evaluación
async function viewAssessmentQuestions(assessmentId, assessmentTitle) {
    console.log('👁️ VIEW-QUESTIONS: Cargando preguntas para evaluación:', assessmentId);
    
    try {
        // Mostrar loading
        showNotification('Cargando preguntas...', 'info');
        
        // Obtener las preguntas desde la API
        const response = await fetch(`/api/assessments/${assessmentId}/questions`);
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.error || 'Error al cargar las preguntas');
        }
        
        const questions = data.questions || [];
        console.log('✅ VIEW-QUESTIONS: Preguntas cargadas:', questions.length);
        
        // Crear contenido del modal con las preguntas
        let questionsHtml = '';
        if (questions.length === 0) {
            questionsHtml = `
                <div class="text-center py-4">
                    <i class="fas fa-question-circle text-muted mb-3" style="font-size: 3rem;"></i>
                    <h6 class="text-muted">No hay preguntas disponibles</h6>
                    <p class="text-muted small">Esta evaluación aún no tiene preguntas configuradas.</p>
                </div>
            `;
        } else {
            questionsHtml = questions.map((question, index) => `
                <div class="question-item mb-3 p-3 border rounded">
                    <div class="d-flex align-items-start">
                        <span class="badge bg-primary me-2 mt-1">${index + 1}</span>
                        <div class="flex-grow-1">
                            <h6 class="mb-2">${question.question_text}</h6>
                            ${question.options ? `
                                <div class="options-list mt-2">
                                    ${question.options.map((option, optIndex) => `
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" disabled>
                                            <label class="form-check-label text-muted small">
                                                ${option}
                                            </label>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Crear modal con las preguntas
        const modalHtml = `
            <div class="modal fade" id="viewQuestionsModal" tabindex="-1" aria-labelledby="viewQuestionsModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="viewQuestionsModalLabel">
                                <i class="fas fa-list me-2"></i>${assessmentTitle} - Preguntas
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info d-flex align-items-start mb-3">
                                <i class="fas fa-info-circle me-2 mt-1"></i>
                                <div>
                                    <strong>${questions.length} ${questions.length === 1 ? 'pregunta' : 'preguntas'}</strong>
                                    <br><small>Esta es la lista de preguntas que verán tus coachees al completar esta evaluación.</small>
                                </div>
                            </div>
                            <div class="questions-container">
                                ${questionsHtml}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remover modal previo si existe
        const existingModal = document.getElementById('viewQuestionsModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Añadir nuevo modal al DOM
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('viewQuestionsModal'));
        modal.show();
        
        // Limpiar modal cuando se cierre
        document.getElementById('viewQuestionsModal').addEventListener('hidden.bs.modal', function () {
            this.remove();
        });
        
    } catch (error) {
        console.error('❌ VIEW-QUESTIONS: Error:', error);
        showNotification('Error al cargar las preguntas: ' + error.message, 'danger');
    }
}

// Función para cargar evaluaciones en el selector del formulario de invitación
function loadAssessmentsForInvitation() {
    console.log('🔄 LOAD-ASSESSMENTS: Iniciando carga de evaluaciones para invitación');
    
    const selector = document.getElementById('assignedAssessment');
    if (!selector) {
        console.warn('⚠️ LOAD-ASSESSMENTS: Selector assignedAssessment no encontrado');
        return;
    }
    
    console.log('🧹 LOAD-ASSESSMENTS: Limpiando selector - opciones actuales:', selector.children.length);
    
    // Limpiar opciones existentes (excepto la primera)
    while (selector.children.length > 1) {
        selector.removeChild(selector.lastChild);
    }
    
    console.log('📡 LOAD-ASSESSMENTS: Solicitando evaluaciones del backend');
    
    fetch('/api/coach/available-assessments')
        .then(response => response.json())
        .then(data => {
            console.log('📥 LOAD-ASSESSMENTS: Respuesta recibida', {
                success: data.success,
                assessmentCount: data.assessments ? data.assessments.length : 0,
                assessments: data.assessments ? data.assessments.map(a => ({id: a.id, title: a.title})) : []
            });
            
            if (data.success && data.assessments && data.assessments.length > 0) {
                data.assessments.forEach((assessment, index) => {
                    console.log(`➕ LOAD-ASSESSMENTS: Agregando evaluación ${index + 1}:`, {
                        id: assessment.id, 
                        title: assessment.title, 
                        questions: assessment.questions_count
                    });
                    
                    // Verificar si ya existe una opción con este valor
                    const existingOption = Array.from(selector.options).find(option => option.value === assessment.id.toString());
                    if (existingOption) {
                        console.warn(`⚠️ DUPLICATE-PREVENTION: Evaluación ${assessment.id} ya existe en el selector, omitiendo`);
                        return;
                    }
                    
                    const option = document.createElement('option');
                    option.value = assessment.id;
                    option.textContent = assessment.title;
                    selector.appendChild(option);
                });
                
                console.log(`✅ LOAD-ASSESSMENTS: ${data.assessments.length} evaluaciones procesadas. Total opciones en selector:`, selector.children.length);
            } else {
                console.warn('⚠️ LOAD-ASSESSMENTS: No se encontraron evaluaciones o respuesta inválida');
            }
        })
        .catch(error => {
            console.error('❌ LOAD-ASSESSMENTS: Error cargando evaluaciones:', error);
        });
}

// Función para cargar coachees
function loadCoachees() {
    fetch('/api/coach/my-coachees')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                coacheesData = data.coachees;
                displayCoachees();
                updateCoacheeSelect();
            }
        })
        .catch(error => {
            console.error('Error loading coachees:', error);
            document.getElementById('coacheesTableBody').innerHTML = 
                '<tr><td colspan="7" class="text-center text-danger">Error al cargar coachees</td></tr>';
            document.getElementById('coacheesCardsContainer').innerHTML = 
                '<div class="text-center text-danger p-3">Error al cargar coachees</div>';
        });
}

// Función para mostrar coachees en la tabla y cards móviles
function displayCoachees() {
    const tbody = document.getElementById('coacheesTableBody');
    const cardsContainer = document.getElementById('coacheesCardsContainer');
    
    if (coacheesData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No hay coachees asignados</td></tr>';
        cardsContainer.innerHTML = '<div class="unified-empty-state"><i class="fas fa-users"></i><p>No hay coachees asignados</p></div>';
        return;
    }
    
    // Vista tabla para desktop - Mejorada con avatares y badges
    tbody.innerHTML = coacheesData.map((coachee, index) => {
        // Generar color único para el avatar basado en el ID
        const avatarColors = [
            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
            'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
            'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
            'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
            'linear-gradient(135deg, #30cfd0 0%, #330867 100%)'
        ];
        const avatarColor = avatarColors[index % avatarColors.length];
        const initial = (coachee.name || 'S').charAt(0).toUpperCase();
        
        // Badge de estado (puedes personalizarlo según tus necesidades)
        const statusBadge = coachee.is_active !== false ? 
            '<span class="badge bg-success" style="font-size: 0.7rem;">Activo</span>' : 
            '<span class="badge bg-secondary" style="font-size: 0.7rem;">Inactivo</span>';
        
        return `
        <tr style="border-bottom: 2px solid #e2e8f0;">
            <td>
                <div class="d-flex align-items-center gap-3">
                    <div class="coachee-avatar" style="
                        width: 45px;
                        height: 45px;
                        border-radius: 50%;
                        background: ${avatarColor};
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: 700;
                        font-size: 1.1rem;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                        flex-shrink: 0;
                    ">${initial}</div>
                    <div>
                        <div style="font-weight: 600; color: #1e293b; font-size: 0.95rem; margin-bottom: 2px;">
                            ${coachee.name || 'Sin nombre'}
                        </div>
                        ${statusBadge}
                    </div>
                </div>
            </td>
            <td>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-envelope" style="color: #3B82F6; font-size: 0.9rem;"></i>
                    <span style="color: #64748b; font-size: 0.875rem;">${coachee.email || 'Sin email'}</span>
                </div>
            </td>
            <td>
                ${coachee.password ? `
                    <div class="d-flex align-items-center gap-2" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); padding: 8px 12px; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <i class="fas fa-key" style="color: #3B82F6; font-size: 0.85rem;"></i>
                        <span class="password-text" id="pwd-${coachee.id}" style="font-family: 'Courier New', monospace; font-weight: 600; min-width: 70px; color: #1e293b;">●●●●●●●●</span>
                        <button class="btn btn-sm btn-outline-secondary" style="padding: 0.25rem 0.5rem; border-radius: 6px;" onclick="togglePassword(${coachee.id}, '${coachee.password}')" title="Mostrar/Ocultar contraseña">
                            <i class="fas fa-eye" id="eye-${coachee.id}" style="font-size: 0.8rem;"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary" style="padding: 0.25rem 0.5rem; border-radius: 6px;" onclick="copyPassword('${coachee.password}')" title="Copiar contraseña">
                            <i class="fas fa-copy" style="font-size: 0.8rem;"></i>
                        </button>
                    </div>
                ` : '<span class="text-muted">-</span>'}
            </td>
            <td>
                <div class="d-flex gap-2 justify-content-center flex-wrap">
                    <button class="btn btn-sm btn-outline-primary" onclick="viewCoacheeDetails(${coachee.id})" title="Ver detalles" style="border-radius: 8px; padding: 0.4rem 0.75rem;">
                        <i class="fas fa-eye me-1"></i>Ver
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="editCoachee(${coachee.id})" title="Editar" style="border-radius: 8px; padding: 0.4rem 0.75rem;">
                        <i class="fas fa-edit me-1"></i>Editar
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="showAssignModal(${coachee.id}, '${coachee.name}')" title="Asignar evaluación/tarea" style="border-radius: 8px; padding: 0.4rem 0.75rem;">
                        <i class="fas fa-plus me-1"></i>Asignar
                    </button>
                </div>
            </td>
        </tr>
        `;
    }).join('');
    
    // Vista cards para móvil - Mejorada con avatares y mejor diseño
    cardsContainer.innerHTML = `
        <div class="results-list">
            ${coacheesData.map((coachee, index) => {
                // Generar color único para el avatar basado en el ID
                const avatarColors = [
                    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                    'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    'linear-gradient(135deg, #30cfd0 0%, #330867 100%)'
                ];
                const avatarColor = avatarColors[index % avatarColors.length];
                const initial = (coachee.name || 'S').charAt(0).toUpperCase();
                
                // Badge de estado
                const statusBadge = coachee.is_active !== false ? 
                    '<span class="badge bg-success" style="font-size: 0.7rem; padding: 4px 10px;">Activo</span>' : 
                    '<span class="badge bg-secondary" style="font-size: 0.7rem; padding: 4px 10px;">Inactivo</span>';
                
                return `
                <div class="unified-card coachee-card-collapsible" data-coachee-id="${coachee.id}">
                    <div class="unified-card-header" onclick="toggleCoacheeCard(${coachee.id})" style="cursor: pointer;">
                        <div class="d-flex align-items-center gap-3 w-100">
                            <div class="coachee-avatar" style="
                                width: 60px;
                                height: 60px;
                                border-radius: 50%;
                                background: ${avatarColor};
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-weight: 700;
                                font-size: 1.5rem;
                                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                                flex-shrink: 0;
                            ">${initial}</div>
                            <div class="flex-grow-1">
                                <h5 class="unified-card-title mb-2">${coachee.name || 'Sin nombre'}</h5>
                                ${statusBadge}
                            </div>
                            <i class="fas fa-chevron-down coachee-toggle-icon" style="color: #3B82F6; font-size: 1.2rem; transition: transform 0.3s ease;"></i>
                        </div>
                    </div>
                    <div class="unified-card-body coachee-card-content" style="display: none;">
                        <div class="coachee-details">
                            <div class="meta-item">
                                <i class="fas fa-envelope"></i>
                                <span>${coachee.email || 'Sin email'}</span>
                            </div>
                            ${coachee.password ? `
                            <div class="meta-item">
                                <i class="fas fa-key"></i>
                                <div class="d-flex align-items-center flex-grow-1">
                                    <span class="password-text" id="pwd-mobile-${coachee.id}" style="font-family: 'Courier New', monospace; font-weight: 600;">●●●●●●●●</span>
                                    <button class="unified-btn unified-btn-sm unified-btn-secondary ms-2" onclick="event.stopPropagation(); togglePasswordMobile(${coachee.id}, '${coachee.password}')" title="Mostrar/Ocultar">
                                        <i class="fas fa-eye" id="eye-mobile-${coachee.id}"></i>
                                    </button>
                                    <button class="unified-btn unified-btn-sm unified-btn-primary ms-1" onclick="event.stopPropagation(); copyPassword('${coachee.password}')" title="Copiar">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                            ` : ''}
                            <div class="meta-item">
                                <i class="fas fa-user-circle"></i>
                                <span style="color: #64748b; font-size: 0.85rem;">
                                    ID: <strong style="color: #1e293b;">#${coachee.id}</strong>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="unified-card-footer coachee-card-content" style="display: none;">
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="unified-btn unified-btn-primary unified-btn-sm" onclick="event.stopPropagation(); viewCoacheeDetails(${coachee.id})" title="Ver detalles">
                                <i class="fas fa-eye"></i>
                                Detalles
                            </button>
                            <button class="unified-btn unified-btn-secondary unified-btn-sm" onclick="event.stopPropagation(); editCoachee(${coachee.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                                Editar
                            </button>
                            <button class="unified-btn unified-btn-success unified-btn-sm" onclick="event.stopPropagation(); showAssignModal(${coachee.id}, '${coachee.name}')" title="Asignar">
                                <i class="fas fa-plus"></i>
                                Asignar
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('')}
        </div>
    `;
}

// Función para actualizar select de coachees en tareas
function updateCoacheeSelect() {
    const select = document.getElementById('taskCoachee');
    select.innerHTML = '<option value="">Seleccionar coachee</option>' +
        coacheesData.map(coachee => `<option value="${coachee.id}">${coachee.name}</option>`).join('');
}

// Función para cargar tareas
function loadTasks() {
    console.log('📋 Loading tasks...');
    fetch('/api/coach/tasks')
        .then(response => {
            console.log('📋 Tasks response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📋 Tasks data:', data);
            if (data.success) {
                tasksData = data.tasks;
                displayTasks();
                console.log('📋 Calling loadPendingEvaluations...');
                loadPendingEvaluations(); // Cargar evaluaciones pendientes también
            } else {
                console.warn('📋 Tasks request did not return success:', data);
            }
        })
        .catch(error => {
            console.error('❌ Error loading tasks:', error);
            document.getElementById('tasksTableBody').innerHTML = 
                '<tr><td colspan="8" class="text-center text-danger">Error al cargar tareas</td></tr>';
        });
}

// Función para cargar evaluaciones pendientes
function loadPendingEvaluations() {
    console.log('📊 Loading pending evaluations...');
    
    fetch('/api/coach/pending-evaluations')
        .then(response => {
            console.log('📊 Pending evaluations response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📊 Pending evaluations data:', data);
            if (data.success) {
                console.log(`✅ Found ${data.total} pending evaluations`);
                console.log('📊 Calling displayPendingEvaluations with:', data.pending_evaluations);
                displayPendingEvaluations(data.pending_evaluations);
            } else {
                console.warn('⚠️ Pending evaluations request did not return success:', data);
                throw new Error(data.error || 'Error desconocido');
            }
        })
        .catch(error => {
            console.error('❌ Error loading pending evaluations:', error);
            document.getElementById('pendingEvaluationsTableBody').innerHTML = 
                '<tr><td colspan="5" class="text-center text-danger">Error al cargar evaluaciones pendientes</td></tr>';
            document.getElementById('pendingEvaluationsCardsContainer').innerHTML = 
                '<div class="text-center text-danger">Error al cargar evaluaciones pendientes</div>';
        });
}

// Función para mostrar evaluaciones pendientes
function displayPendingEvaluations(pending) {
    console.log('🎨 displayPendingEvaluations called with:', pending);
    console.log('🎨 Number of pending evaluations:', pending ? pending.length : 'null/undefined');
    
    const tableBody = document.getElementById('pendingEvaluationsTableBody');
    const cardsContainer = document.getElementById('pendingEvaluationsCardsContainer');
    
    console.log('🎨 Table body element:', tableBody);
    console.log('🎨 Cards container element:', cardsContainer);
    
    if (!tableBody || !cardsContainer) {
        console.warn('⚠️ Contenedores de evaluaciones pendientes no encontrados');
        return;
    }
    
    if (pending.length === 0) {
        console.log('ℹ️ No pending evaluations, showing empty state');
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay evaluaciones pendientes</td></tr>';
        cardsContainer.innerHTML = '<div class="text-center text-muted">No hay evaluaciones pendientes</div>';
        return;
    }
    
    console.log(`✅ Displaying ${pending.length} pending evaluations`);
    
    // Limpiar contenedores
    tableBody.innerHTML = '';
    cardsContainer.innerHTML = '';
    
    console.log('🔄 Starting forEach loop...');
    pending.forEach((eval, index) => {
        console.log(`🔄 Processing evaluation ${index + 1}:`, eval);
        const fechaAsignacion = new Date(eval.assigned_date).toLocaleDateString('es-ES');
        console.log('📅 Formatted date:', fechaAsignacion);
        
        // Badge de estado
        const estadoBadge = '<span class="badge bg-warning text-dark">Pendiente</span>';
        
        // Crear fila para tabla (desktop)
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div class="fw-bold text-dark">${eval.assessment_title}</div>
            </td>
            <td>
                <div class="text-dark">${eval.coachee_name}</div>
                <small class="text-muted">${eval.coachee_email}</small>
            </td>
            <td class="text-dark">${fechaAsignacion}</td>
            <td>${estadoBadge}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="sendReminder(${eval.coachee_id}, '${eval.assessment_title}')" title="Enviar recordatorio">
                    <i class="fas fa-bell me-1"></i>Recordar
                </button>
            </td>
        `;
        console.log('➕ Appending row to table body...');
        tableBody.appendChild(row);
        console.log('✅ Row appended successfully');
        
        // Crear card para móvil
        const card = document.createElement('div');
        card.className = 'card mb-3 border-secondary';
        card.innerHTML = `
            <div class="card-body" style="background-color: white;">
                <h6 class="card-title text-dark fw-bold">${eval.assessment_title}</h6>
                <p class="card-text mb-2">
                    <strong class="text-dark">Coachee:</strong> <span class="text-dark">${eval.coachee_name}</span><br>
                    <small class="text-muted">${eval.coachee_email}</small>
                </p>
                <p class="card-text mb-2">
                    <strong class="text-dark">Fecha Asignación:</strong> <span class="text-dark">${fechaAsignacion}</span>
                </p>
                <p class="card-text mb-2">
                    <strong class="text-dark">Estado:</strong> ${estadoBadge}
                </p>
                <button class="btn btn-sm btn-outline-primary w-100" onclick="sendReminder(${eval.coachee_id}, '${eval.assessment_title}')">
                    <i class="fas fa-bell me-1"></i>Enviar Recordatorio
                </button>
            </div>
        `;
        console.log('➕ Appending card to cards container...');
        cardsContainer.appendChild(card);
        console.log('✅ Card appended successfully');
    });
    console.log('🎉 All pending evaluations displayed!');
}

// Función para enviar recordatorio
function sendReminder(coacheeId, assessmentTitle) {
    if (confirm(`¿Enviar recordatorio para completar "${assessmentTitle}"?`)) {
        // TODO: Implementar endpoint de recordatorio
        alert(`Función de recordatorio en desarrollo.\nCoachee ID: ${coacheeId}\nEvaluación: ${assessmentTitle}`);
    }
}

// Función para mostrar tareas
function displayTasks() {
    const tableBody = document.getElementById('tasksTableBody');
    const cardsContainer = document.getElementById('tasksCardsContainer');
    
    if (tasksData.length === 0) {
        // Vista tabla vacia
        tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No hay tareas creadas</td></tr>';
        // Vista cards vacia
        cardsContainer.innerHTML = '<div class="text-center text-muted">No hay tareas creadas</div>';
        return;
    }

    // Limpiar contenedores
    tableBody.innerHTML = '';
    cardsContainer.innerHTML = '';

    tasksData.forEach(task => {
        const fechaCreated = new Date(task.created_at).toLocaleDateString('es-ES');
        const coacheeName = task.coachee_name || 'No asignado';
        
        // Formatear fecha de vencimiento (zona horaria Santiago)
        let fechaVencimiento = 'Sin fecha';
        let vencimientoClass = '';
        if (task.due_date) {
            const dueDate = new Date(task.due_date);
            const today = getSantiagoDateTime();
            const diffTime = dueDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            fechaVencimiento = dueDate.toLocaleDateString('es-ES');
            
            if (diffDays < 0) {
                vencimientoClass = 'text-danger fw-bold'; // Vencida
                fechaVencimiento += ' <small>(Vencida)</small>';
            } else if (diffDays <= 3) {
                vencimientoClass = 'text-warning fw-bold'; // Próxima a vencer
                fechaVencimiento += ` <small>(${diffDays} días)</small>`;
            } else {
                vencimientoClass = 'text-success'; // A tiempo
            }
        }
        
        // Determinar el estado visual
        let estadoBadge = '';
        if (task.completed) {
            estadoBadge = '<span class="badge bg-success">Completada</span>';
        } else {
            estadoBadge = '<span class="badge bg-warning text-dark">Pendiente</span>';
        }

        // Crear fila para tabla (desktop)
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div class="fw-bold text-dark">${task.title}</div>
                <small class="text-muted">${task.description || 'Sin descripción'}</small>
            </td>
            <td class="text-dark">${coacheeName}</td>
            <td>
                <span class="badge bg-light text-dark border">${task.category || 'Sin categoría'}</span>
            </td>
            <td>${estadoBadge}</td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="progress me-2" style="width: 60px; height: 20px;">
                        <div class="progress-bar bg-primary" style="width: ${task.progress_percentage || 0}%"></div>
                    </div>
                    <small class="text-muted">${task.progress_percentage || 0}%</small>
                </div>
            </td>
            <td class="${vencimientoClass}">${fechaVencimiento}</td>
            <td class="text-dark">${fechaCreated}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary btn-sm" onclick="editTask(${task.id})" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteTask(${task.id})" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tableBody.appendChild(row);

        // Crear card para móvil
        const card = document.createElement('div');
        card.className = 'card mb-3 border-light shadow-sm';
        card.innerHTML = `
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-title mb-1 text-dark fw-bold">${task.title}</h6>
                    ${estadoBadge}
                </div>
                
                <p class="card-text text-muted small mb-3">${task.description || 'Sin descripción'}</p>
                
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-user text-primary me-2"></i>
                            <div>
                                <div class="small text-muted">Coachee</div>
                                <div class="fw-medium text-dark small">${coacheeName}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-tag text-info me-2"></i>
                            <div>
                                <div class="small text-muted">Categoría</div>
                                <div class="fw-medium text-dark small">${task.category || 'Sin categoría'}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-chart-line text-success me-2"></i>
                            <div style="flex: 1;">
                                <div class="small text-muted">Progreso</div>
                                <div class="d-flex align-items-center">
                                    <div class="progress me-2" style="flex: 1; height: 16px;">
                                        <div class="progress-bar bg-success" style="width: ${task.progress_percentage || 0}%"></div>
                                    </div>
                                    <small class="fw-medium text-dark">${task.progress_percentage || 0}%</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    ${task.due_date ? `
                    <div class="col-12">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-clock text-warning me-2"></i>
                            <div>
                                <div class="small text-muted">Vencimiento</div>
                                <div class="fw-medium small ${vencimientoClass}">${fechaVencimiento}</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        <i class="fas fa-calendar me-1"></i>Creada: ${fechaCreated}
                    </small>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary btn-sm" onclick="editTask(${task.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteTask(${task.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        cardsContainer.appendChild(card);
    });
}

// Función para crear tarea
function createTask() {
    const title = document.getElementById('taskTitle').value.trim();
    const description = document.getElementById('taskDescription').value.trim();
    const category = document.getElementById('taskCategory').value;
    const coacheeId = document.getElementById('taskCoachee').value;
    const dueDate = document.getElementById('taskDueDate').value;
    
    if (!title) {
        alert('Por favor ingrese un título para la tarea');
        return;
    }
    
    if (!description) {
        alert('Por favor ingrese una descripción para la tarea');
        return;
    }
    
    if (!category) {
        alert('Por favor seleccione una categoría para la tarea');
        return;
    }
    
    if (!coacheeId) {
        alert('Por favor seleccione un coachee');
        return;
    }
    
    const taskData = {
        title: title,
        description: description,
        category: category,
        coachee_id: parseInt(coacheeId)
    };
    
    // Agregar fecha de vencimiento solo si se especifica
    if (dueDate) {
        taskData.due_date = dueDate;
    }
    
    fetch('/api/coach/tasks', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(taskData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('taskCategory').value = '';
            document.getElementById('taskCoachee').value = '';
            document.getElementById('taskDueDate').value = '';
            loadTasks();
            alert('Tarea creada exitosamente');
        } else {
            alert('Error al crear la tarea: ' + (data.message || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error creating task:', error);
        alert('Error al crear la tarea');
    });
}

// Función para eliminar tarea
function deleteTask(taskId) {
    if (confirm('¿Está seguro de que desea eliminar esta tarea?')) {
        fetch(`/api/coach/tasks/${taskId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Tarea eliminada exitosamente');
                loadTasks(); // Recargar la lista de tareas
            } else {
                alert('Error al eliminar la tarea: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error deleting task:', error);
            alert('Error al eliminar la tarea');
        });
    }
}

// Función para editar tarea
function editTask(taskId) {
    const task = tasksData.find(t => t.id === taskId);
    if (!task) {
        alert('Tarea no encontrada');
        return;
    }
    
    // Llenar el formulario con los datos de la tarea
    document.getElementById('taskTitle').value = task.title;
    document.getElementById('taskDescription').value = task.description || '';
    document.getElementById('taskCategory').value = task.category || '';
    document.getElementById('taskCoachee').value = task.coachee_id || '';
    
    // Llenar fecha de vencimiento si existe
    if (task.due_date) {
        document.getElementById('taskDueDate').value = task.due_date;
    } else {
        document.getElementById('taskDueDate').value = '';
    }
    
    // Cambiar el botón de crear por actualizar
    const createButton = document.querySelector('#gestion-tareas button[onclick="createTask()"]');
    createButton.innerHTML = '<i class="fas fa-save me-1"></i>Actualizar Tarea';
    createButton.onclick = function() { updateTask(taskId); };
    
    // Agregar botón de cancelar
    const cancelButton = document.createElement('button');
    cancelButton.className = 'btn btn-secondary ms-2';
    cancelButton.innerHTML = '<i class="fas fa-times me-1"></i>Cancelar';
    cancelButton.onclick = cancelEdit;
    createButton.parentNode.appendChild(cancelButton);
    
    // Scroll al formulario
    document.getElementById('gestion-tareas').scrollIntoView({ behavior: 'smooth' });
}

// Función para actualizar tarea
function updateTask(taskId) {
    const title = document.getElementById('taskTitle').value.trim();
    const description = document.getElementById('taskDescription').value.trim();
    const category = document.getElementById('taskCategory').value;
    const coacheeId = document.getElementById('taskCoachee').value;
    const dueDate = document.getElementById('taskDueDate').value;
    
    if (!title) {
        alert('Por favor ingrese un título para la tarea');
        return;
    }
    
    const taskData = {
        title: title,
        description: description,
        category: category,
        coachee_id: coacheeId || null,
        due_date: dueDate || null
    };
    
    fetch(`/api/coach/tasks/${taskId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(taskData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Tarea actualizada exitosamente');
            cancelEdit(); // Resetear formulario
            loadTasks(); // Recargar la lista de tareas
        } else {
            alert('Error al actualizar la tarea: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error updating task:', error);
        alert('Error al actualizar la tarea');
    });
}

// Función para cancelar edición
function cancelEdit() {
    // Limpiar formulario
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskDescription').value = '';
    document.getElementById('taskCategory').value = '';
    document.getElementById('taskCoachee').value = '';
    document.getElementById('taskDueDate').value = '';
    
    // Restaurar botón de crear
    const updateButton = document.querySelector('#gestion-tareas button[onclick*="updateTask"]');
    if (updateButton) {
        updateButton.innerHTML = '<i class="fas fa-plus me-1"></i>Crear Tarea';
        updateButton.onclick = createTask;
        
        // Remover botón cancelar
        const cancelButton = updateButton.parentNode.querySelector('.btn-secondary');
        if (cancelButton) {
            cancelButton.remove();
        }
    }
}

// Función para ver detalles del coachee
function viewCoacheeDetails(coacheeId) {
    const coachee = coacheesData.find(c => c.id === coacheeId);
    if (!coachee) {
        alert('Coachee no encontrado');
        return;
    }
    
    document.getElementById('modalCoacheeName').textContent = coachee.name;
    document.getElementById('coacheeEvaluationsContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Cargando evaluaciones...</span>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('coacheeEvaluationsModal'));
    modal.show();
    
    // Cargar evaluaciones del coachee
    fetch(`/api/coach/coachee-evaluations/${coacheeId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.evaluations) {
                // Procesar evaluaciones para agregar campos necesarios
                const processedEvaluations = data.evaluations.map(evaluation => {
                    const assessmentTitle = evaluation.assessment?.title || '';
                    const isLeadershipAssessment = assessmentTitle.includes('Liderazgo');
                    const isTeamworkAssessment = assessmentTitle.includes('Trabajo en Equipo');
                    const isDiscAssessment = assessmentTitle.toLowerCase().includes('disc');
                    const isEmotionalIntelligenceAssessment = assessmentTitle.includes('Inteligencia Emocional');
                    
                    // Calcular porcentaje basado en el tipo de evaluación
                    let percentage;
                    let level;
                    
                    if (isLeadershipAssessment) {
                        // Liderazgo: score es suma (10-50), convertir a porcentaje
                        percentage = Math.round((evaluation.score / 50) * 100);
                        level = getLeadershipLevelFromScore(evaluation.score);
                    } else if (isTeamworkAssessment) {
                        // Trabajo en Equipo: score es suma (12-60), convertir a porcentaje
                        percentage = Math.round((evaluation.score / 60) * 100);
                        level = getTeamworkLevelFromScore(evaluation.score);
                    } else if (isDiscAssessment) {
                        // DISC: score es suma (16-80), convertir a porcentaje
                        percentage = Math.round((evaluation.score / 80) * 100);
                        level = getDiscLevelFromScore(evaluation.score);
                    } else if (isEmotionalIntelligenceAssessment) {
                        // IE: score es suma (12-60), convertir a porcentaje
                        percentage = Math.round((evaluation.score / 60) * 100);
                        level = getEmotionalIntelligenceLevelFromScore(evaluation.score);
                    } else {
                        // Asertividad y otras: score ya es porcentaje
                        percentage = evaluation.score || 0;
                        level = getAssertiveLevelFromScore(percentage);
                    }
                    
                    return {
                        ...evaluation,
                        percentage: percentage,
                        level: level,
                        interpretation: evaluation.result_text || ''
                    };
                });
                
                displayCoacheeEvaluations(processedEvaluations);
            } else {
                document.getElementById('coacheeEvaluationsContent').innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Este coachee no tiene evaluaciones completadas.
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading coachee evaluations:', error);
            document.getElementById('coacheeEvaluationsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error al cargar las evaluaciones.
                </div>
            `;
        });
}

// Función para mostrar evaluaciones del coachee
function displayCoacheeEvaluations(evaluations) {
    if (!evaluations || evaluations.length === 0) {
        document.getElementById('coacheeEvaluationsContent').innerHTML = `
            <div class="alert alert-info border-0" style="background: #f8f9fa; border-left: 4px solid #17a2b8 !important;">
                <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle me-3" style="font-size: 1.5rem; color: #17a2b8;"></i>
                    <div>
                        <h6 class="mb-0">No hay evaluaciones disponibles</h6>
                        <small class="text-muted">Este coachee aún no ha completado ninguna evaluación.</small>
                    </div>
                </div>
            </div>
        `;
        return;
    }

    // Header con estadísticas
    const totalEvaluations = evaluations.length;
    const avgScore = evaluations.reduce((sum, eval) => sum + (eval.percentage || 0), 0) / totalEvaluations;
    const lastEvaluation = evaluations.sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at))[0];

    let html = `
        <div class="evaluations-summary mb-4">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="summary-card">
                        <div class="summary-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-number">${totalEvaluations}</div>
                            <div class="summary-label">Evaluaciones</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="summary-card">
                        <div class="summary-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-number">${Math.round(avgScore)}%</div>
                            <div class="summary-label">Promedio</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="summary-card">
                        <div class="summary-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-number">${formatDateShort(lastEvaluation.completed_at)}</div>
                            <div class="summary-label">Última evaluación</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="evaluations-list">
            <div class="list-header mb-3">
                <h6 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    Historial de Evaluaciones
                </h6>
            </div>
    `;

    // Ordenar evaluaciones por fecha (más reciente primero)
    const sortedEvaluations = evaluations.sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at));

    sortedEvaluations.forEach((evaluation, index) => {
        const scoreColor = getScoreColor(evaluation.percentage);
        const levelBadge = getLevelBadge(evaluation.level, evaluation.percentage);
        const isRecent = index === 0; // Marcar la más reciente

        html += `
            <div class="evaluation-card ${isRecent ? 'recent-evaluation' : ''}" data-evaluation-id="${evaluation.id}">
                ${isRecent ? '<div class="recent-badge">Más reciente</div>' : ''}
                
                <div class="evaluation-header">
                    <div class="d-flex align-items-start justify-content-between">
                        <div class="evaluation-info flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <div class="evaluation-icon me-3">
                                    <i class="fas fa-clipboard-check"></i>
                                </div>
                                <div>
                                    <h6 class="evaluation-title mb-1">
                                        ${evaluation.assessment_title || 'Evaluación de Asertividad'}
                                    </h6>
                                    <div class="evaluation-meta">
                                        <span class="meta-item">
                                            <i class="fas fa-calendar-alt me-1"></i>
                                            ${formatDateLong(evaluation.completed_at)}
                                        </span>
                                        <span class="meta-item">
                                            <i class="fas fa-clock me-1"></i>
                                            ${getTimeAgo(evaluation.completed_at)}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="evaluation-score-section text-end">
                            <div class="score-display ${scoreColor}">
                                <div class="score-number">${evaluation.percentage || 0}%</div>
                                <div class="score-label">Puntuación</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="evaluation-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            ${evaluation.interpretation ? `
                                <div class="interpretation-section">
                                    <h6 class="section-title">
                                        <i class="fas fa-lightbulb me-2"></i>
                                        Interpretación
                                    </h6>
                                    <p class="interpretation-text">${evaluation.interpretation}</p>
                                </div>
                            ` : ''}
                            
                            ${evaluation.dimensional_scores && Object.keys(evaluation.dimensional_scores).length > 0 ? `
                                <div class="dimensions-preview">
                                    <h6 class="section-title">
                                        <i class="fas fa-chart-radar me-2"></i>
                                        Dimensiones Evaluadas
                                    </h6>
                                    <div class="dimensions-grid">
                                        ${generateDimensionsPreview(evaluation.dimensional_scores)}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="col-md-4">
                            <div class="evaluation-actions">
                                <button class="btn btn-primary btn-block mb-2" 
                                        onclick="viewEvaluationDetails(${evaluation.id})"
                                        title="Ver análisis completo de la evaluación">
                                    <i class="fas fa-eye me-2"></i>
                                    Ver Análisis Completo
                                </button>
                                
                                <div class="quick-stats">
                                    <div class="stat-item">
                                        <span class="stat-label">ID Evaluación:</span>
                                        <span class="stat-value">#${evaluation.id}</span>
                                    </div>
                                    ${evaluation.total_questions ? `
                                        <div class="stat-item">
                                            <span class="stat-label">Preguntas:</span>
                                            <span class="stat-value">${evaluation.total_questions}</span>
                                        </div>
                                    ` : ''}
                                    <div class="stat-item">
                                        <span class="stat-label">Estado:</span>
                                        <span class="badge bg-success">Completada</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    
    document.getElementById('coacheeEvaluationsContent').innerHTML = html;
}

// Funciones auxiliares para displayCoacheeEvaluations
function formatDateShort(dateString) {
    const date = new Date(dateString + (dateString.includes('Z') ? '' : 'Z'));
    return date.toLocaleDateString('es-CL', { 
        timeZone: 'America/Santiago',
        day: '2-digit', 
        month: '2-digit' 
    });
}

function formatDateLong(dateString) {
    const date = new Date(dateString + (dateString.includes('Z') ? '' : 'Z'));
    return date.toLocaleDateString('es-CL', { 
        timeZone: 'America/Santiago',
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
}

function getTimeAgo(dateString) {
    const now = getSantiagoDateTime();
    const date = new Date(dateString);
    const diffInDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
    
    if (diffInDays === 0) return 'Hoy';
    if (diffInDays === 1) return 'Ayer';
    if (diffInDays < 7) return `Hace ${diffInDays} días`;
    if (diffInDays < 30) return `Hace ${Math.floor(diffInDays / 7)} semanas`;
    return `Hace ${Math.floor(diffInDays / 30)} meses`;
}

function getScoreColor(percentage) {
    if (percentage >= 80) return 'score-high';     // Verde - 80%+
    if (percentage >= 40) return 'score-medium';   // Azul - 40-79%
    return 'score-low';                             // Rojo - Bajo 40%
}

function getLevelBadge(level, percentage) {
    const badgeColor = percentage >= 80 ? 'success' : 
                      percentage >= 60 ? 'warning' : 'danger';
    return `<div class="badge bg-${badgeColor}">${level || 'Sin nivel'}</div>`;
}

function generateDimensionsPreview(dimensionalScores) {
    return Object.entries(dimensionalScores)
        .slice(0, 3)
        .map(([dimension, score]) => `
            <div class="dimension-item">
                <span class="dimension-name">${dimension}</span>
                <span class="dimension-score">${score}%</span>
            </div>
        `).join('');
}

// Función para ver detalles de evaluación
function viewEvaluationDetails(evaluationId) {
    document.getElementById('evaluationDetailsContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Cargando detalles...</span>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('evaluationDetailsModal'));
    modal.show();
    
    // Cargar detalles de la evaluación
    fetch(`/api/coach/evaluation-details/${evaluationId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayEvaluationDetails(data.evaluation);
            } else {
                document.getElementById('evaluationDetailsContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error al cargar los detalles de la evaluación.
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading evaluation details:', error);
            document.getElementById('evaluationDetailsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error al cargar los detalles de la evaluación.
                </div>
            `;
        });
}

// Función para mostrar detalles de evaluación
function displayEvaluationDetails(evaluation) {
    console.log('🔍 displayEvaluationDetails called with:', evaluation);
    
    const container = document.getElementById('evaluationDetailsContent');
    
    // Detectar si es una evaluación DISC, Inteligencia Emocional o de Asertividad
    const assessmentTitle = evaluation.assessment?.title || '';
    console.log('🏷️ Assessment Title:', assessmentTitle);
    
    const isDiscAssessment = assessmentTitle.toLowerCase().includes('disc');
    const isEmotionalIntelligenceAssessment = assessmentTitle.includes('Inteligencia Emocional');
    const isLeadershipAssessment = assessmentTitle.includes('Liderazgo');
    const isTeamworkAssessment = assessmentTitle.includes('Trabajo en Equipo');
    const isGrowthPreparationAssessment = assessmentTitle.includes('Preparación para crecer 2026');
    
    console.log('🎯 Detection Flags:', {
        isDiscAssessment,
        isEmotionalIntelligenceAssessment,
        isLeadershipAssessment,
        isTeamworkAssessment,
        isGrowthPreparationAssessment
    });
    
    // Si es la evaluación "Preparación para crecer 2026", usar el layout personalizado
    if (isGrowthPreparationAssessment) {
        console.log('✅ Redirecting to displayGrowthPreparationEvaluation');
        displayGrowthPreparationEvaluation(evaluation);
        return;
    }
    
    // Si es la evaluación de Liderazgo, usar el layout específico de Liderazgo
    if (isLeadershipAssessment) {
        console.log('✅ Redirecting to displayLeadershipEvaluation');
        displayLeadershipEvaluation(evaluation);
        return;
    }
    
    console.log('⚠️ Using generic displayEvaluationDetails (not Leadership)');
    
    // Usar datos de la evaluación
    const data = evaluation;
    const dimensionalScores = evaluation.dimensional_scores;
    const recommendations = evaluation.recommendations || [];
    const detailedAnalysis = evaluation.detailed_analysis;
    
    // Log para debug de respuestas
    console.log('📝 Responses data:', evaluation.responses);
    console.log('📊 Is Teamwork?', isTeamworkAssessment);
    
    // Calcular porcentaje correcto según el tipo de evaluación
    let displayPercentage;
    let levelLabel;
    
    if (isLeadershipAssessment) {
        // Liderazgo: score es suma (10-50), convertir a porcentaje
        displayPercentage = Math.round((data.score / 50) * 100);
        levelLabel = 'Nivel de Liderazgo';
    } else if (isTeamworkAssessment) {
        // Trabajo en Equipo: score es suma (12-60), convertir a porcentaje
        displayPercentage = Math.round((data.score / 60) * 100);
        levelLabel = 'Nivel de Colaboración';
    } else if (isDiscAssessment) {
        // DISC: score es suma (16-80), convertir a porcentaje
        displayPercentage = Math.round((data.score / 80) * 100);
        levelLabel = 'Estilo DISC Dominante';
    } else if (isEmotionalIntelligenceAssessment) {
        // IE: score es suma (12-60), convertir a porcentaje
        displayPercentage = Math.round((data.score / 60) * 100);
        levelLabel = 'Nivel de Inteligencia Emocional';
    } else {
        // Asertividad: score ya es porcentaje
        displayPercentage = Math.round(data.score || 0);
        levelLabel = 'Nivel de Asertividad';
    }
    
    console.log('Final data to use:', data);
    console.log('Dimensional scores:', dimensionalScores);
    console.log('Assessment Title:', assessmentTitle);
    console.log('Raw Score:', data.score);
    console.log('Display Percentage:', displayPercentage);
    console.log('Is DISC Assessment:', isDiscAssessment);
    console.log('Is Emotional Intelligence Assessment:', isEmotionalIntelligenceAssessment);
    console.log('Is Leadership Assessment:', isLeadershipAssessment);
    console.log('Is Teamwork Assessment:', isTeamworkAssessment);
    console.log('Is Growth Preparation Assessment:', isGrowthPreparationAssessment);
    console.log('Recommendations from server:', recommendations);
    
    // Título dinámico según el tipo de evaluación
    const analysisTitle = isDiscAssessment ? 'Análisis Completo DISC de Personalidad' : 
                         (isEmotionalIntelligenceAssessment ? 'Análisis Completo de Inteligencia Emocional' :
                         (isLeadershipAssessment ? 'Análisis Completo de Habilidades de Liderazgo' :
                         (isTeamworkAssessment ? 'Análisis Completo de Trabajo en Equipo' : 'Análisis Completo de Asertividad')));
    
    const html = `
        <!-- Resumen General -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                    <div class="card-body text-center">
                        <h4 class="mb-3" style="color: #333;">${analysisTitle}</h4>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="h2" style="color: #007bff;">${displayPercentage}%</div>
                                <div style="color: #666;">Puntuación Total</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h4" style="color: #28a745;">${isDiscAssessment ? getDiscLevelFromScore(data.score) : (isEmotionalIntelligenceAssessment ? getEmotionalIntelligenceLevelFromScore(data.score) : (isLeadershipAssessment ? getLeadershipLevelFromScore(data.score) : (isTeamworkAssessment ? getTeamworkLevelFromScore(data.score) : getAssertiveLevelFromScore(data.score))))}</div>
                                <div style="color: #666;">${levelLabel}</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h6" style="color: #333;">${formatDate(data.completed_at)}</div>
                                <div style="color: #666;">Fecha de Completado</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h6" style="color: #333;">${data.total_questions || evaluation.total_questions || (evaluation.responses ? evaluation.responses.length : 'N/A')}</div>
                                <div style="color: #666;">Preguntas Respondidas</div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12 text-center">
                                <div class="h5" style="color: #333;">${evaluation.coachee ? evaluation.coachee.name : (data.participant_name || evaluation.participant_name || 'N/A')}</div>
                                <div style="color: #666;">Participante</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráfico Radar y Análisis Dimensional -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="card border-0 h-100" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                    <div class="card-header" style="background: #e9ecef; border-bottom: 1px solid #dee2e6;">
                        <h5 style="color: #333;"><i class="fas fa-chart-radar me-2"></i>${isDiscAssessment ? 'Radar de Dimensiones DISC' : (isEmotionalIntelligenceAssessment ? 'Radar de Dimensiones IE' : (isLeadershipAssessment ? 'Radar de Competencias de Liderazgo' : (isTeamworkAssessment ? 'Radar de Competencias de Trabajo en Equipo' : 'Radar de Competencias')))}</h5>
                    </div>
                    <div class="card-body">
                        <div class="radar-chart-container" style="position: relative; height: 300px;">
                            <canvas id="evaluationRadarChart" width="300" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6 mb-4">
                <div class="card border-0 h-100" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                    <div class="card-header" style="background: #e9ecef; border-bottom: 1px solid #dee2e6;">
                        <h5 style="color: #333;"><i class="fas fa-chart-bar me-2"></i>Puntuaciones por Dimensión</h5>
                    </div>
                    <div class="card-body">
                        <div id="dimensionalScoresContainer">
                            ${generateDimensionalScoresHTML(dimensionalScores)}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        ${generateDetailedAnalysisHTML(detailedAnalysis || generateAnalysisFromScores(dimensionalScores))}
        
        <!-- Respuestas Detalladas -->
        <div class="row">
            <div class="col-12">
                <div class="card border-0" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                    <div class="card-header" style="background: #e9ecef; border-bottom: 1px solid #dee2e6;">
                        <h5 style="color: #333;"><i class="fas fa-list me-2"></i>Respuestas Detalladas</h5>
                    </div>
                    <div class="card-body">
                        ${generateResponsesHTML(evaluation.responses || [])}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    
    // Crear el gráfico radar después de insertar el HTML
    setTimeout(() => {
        createRadarChart(dimensionalScores, isDiscAssessment, isEmotionalIntelligenceAssessment, isLeadershipAssessment, isTeamworkAssessment);
    }, 100);
}

// Función para crear gráfico radar
function createRadarChart(dimensionalScores, isDiscAssessment = false, isEmotionalIntelligenceAssessment = false, isLeadershipAssessment = false, isTeamworkAssessment = false) {
    const ctx = document.getElementById('evaluationRadarChart');
    if (!ctx) return;
    
    console.log('🎯 COACH RADAR DEBUG: Creating chart with params:', {
        isDiscAssessment,
        isEmotionalIntelligenceAssessment,
        dimensionalScores
    });
    
    let labels = [];
    let data = [];
    let chartLabel = '';
    
    if (isDiscAssessment) {
        // Configuración para DISC
        labels = ['Dominante', 'Influyente', 'Estable', 'Concienzudo'];
        data = [
            dimensionalScores?.Dominante || dimensionalScores?.dominante || 0,
            dimensionalScores?.Influyente || dimensionalScores?.influyente || 0,
            dimensionalScores?.Estable || dimensionalScores?.estable || 0,
            dimensionalScores?.Concienzudo || dimensionalScores?.concienzudo || 0
        ];
        chartLabel = 'Perfil DISC';
    } else if (isEmotionalIntelligenceAssessment) {
        // Configuración para Inteligencia Emocional
        labels = [
            'Autoconciencia',
            'Autorregulación',
            'Automotivación',
            'Empatía',
            'Habilidades Sociales'
        ];
        data = [
            dimensionalScores?.Autoconciencia || dimensionalScores?.autoconciencia || 0,
            dimensionalScores?.Autorregulación || dimensionalScores?.autorregulacion || 0,
            dimensionalScores?.Automotivación || dimensionalScores?.automotivacion || 0,
            dimensionalScores?.Empatía || dimensionalScores?.empatia || 0,
            dimensionalScores?.['Habilidades Sociales'] || dimensionalScores?.habilidades_sociales || 0
        ];
        chartLabel = 'Perfil de Inteligencia Emocional';
        console.log('🧠 COACH RADAR DEBUG: IE data values:', data);
    } else if (isLeadershipAssessment || isTeamworkAssessment) {
        // Configuración para Liderazgo o Trabajo en Equipo (usar dimensiones dinámicas)
        if (dimensionalScores && typeof dimensionalScores === 'object') {
            if (Array.isArray(dimensionalScores)) {
                labels = dimensionalScores.map(score => score.dimension || score.name);
                data = dimensionalScores.map(score => Math.round((score.score / score.max_score) * 100));
            } else {
                // Objeto con claves de dimensiones - mantener orden y nombres originales
                labels = Object.keys(dimensionalScores);
                data = Object.values(dimensionalScores);
            }
        }
        chartLabel = isLeadershipAssessment ? 'Competencias de Liderazgo (%)' : 'Competencias de Trabajo en Equipo (%)';
        console.log(`🎯 COACH RADAR DEBUG: ${isLeadershipAssessment ? 'Leadership' : 'Teamwork'} data:`, { labels, data });
    } else {
        // Configuración para Asertividad (lógica original)
        if (dimensionalScores && typeof dimensionalScores === 'object') {
            if (Array.isArray(dimensionalScores)) {
                // Array de objetos
                labels = dimensionalScores.map(score => score.dimension || score.name);
                data = dimensionalScores.map(score => Math.round((score.score / score.max_score) * 100));
            } else {
                // Objeto con claves de dimensiones
                labels = Object.keys(dimensionalScores).map(key => formatDimensionName(key));
                data = Object.values(dimensionalScores);
            }
        }
        chartLabel = 'Puntuación (%)';
    }
    
    console.log('📊 COACH RADAR DEBUG: Final chart config:', {
        labels,
        data,
        chartLabel
    });
    
    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{
                label: chartLabel,
                data: data,
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        stepSize: 20
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    console.log('✅ COACH RADAR DEBUG: Chart created successfully!');
}

// Función para generar HTML de puntuaciones dimensionales
function generateDimensionalScoresHTML(dimensionalScores) {
    if (!dimensionalScores) return '<p style="color: #666;">No hay datos dimensionales disponibles.</p>';
    
    let html = '';
    
    if (typeof dimensionalScores === 'object' && !Array.isArray(dimensionalScores)) {
        // Objeto con claves de dimensiones
        for (const [dimension, score] of Object.entries(dimensionalScores)) {
            const dimensionName = formatDimensionName(dimension);
            const percentage = Math.round(score);
            let colorClass = 'danger';
            if (percentage >= 70) colorClass = 'success';
            else if (percentage >= 50) colorClass = 'warning';
            
            html += `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <strong style="color: #333;">${dimensionName}</strong>
                        <span class="badge bg-${colorClass}">${percentage}%</span>
                    </div>
                    <div class="progress" style="height: 10px; background: #e9ecef;">
                        <div class="progress-bar bg-${colorClass}" style="width: ${percentage}%"></div>
                    </div>
                    <small style="color: #666;">${getDimensionDescription(dimension, percentage)}</small>
                </div>
            `;
        }
    } else if (Array.isArray(dimensionalScores)) {
        // Array de objetos
        dimensionalScores.forEach(score => {
            const percentage = Math.round((score.score / score.max_score) * 100);
            let colorClass = 'danger';
            if (percentage >= 70) colorClass = 'success';
            else if (percentage >= 50) colorClass = 'warning';
            
            html += `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <strong style="color: #333;">${score.dimension}</strong>
                        <span class="badge bg-${colorClass}">${percentage}%</span>
                    </div>
                    <div class="progress" style="height: 10px; background: #e9ecef;">
                        <div class="progress-bar bg-${colorClass}" style="width: ${percentage}%"></div>
                    </div>
                    <small style="color: #666;">${score.score}/${score.max_score} puntos</small>
                </div>
            `;
        });
    }
    
    return html;
}

// Función para generar análisis desde puntuaciones dimensionales
function generateAnalysisFromScores(dimensionalScores) {
    if (!dimensionalScores) return null;
    
    const strengths = [];
    const improvementAreas = [];
    
    // Analizar cada dimensión
    for (const [dimension, score] of Object.entries(dimensionalScores)) {
        const percentage = Math.round(score);
        const dimensionName = formatDimensionName(dimension);
        
        if (percentage >= 70) {
            // Es una fortaleza
            strengths.push({
                name: dimensionName,
                score: percentage,
                description: getDimensionDescription(dimension, percentage)
            });
        } else if (percentage < 60) {
            // Es un área de mejora
            const priority = percentage < 40 ? 'high' : 'medium';
            improvementAreas.push({
                name: dimensionName,
                score: percentage,
                description: getDimensionDescription(dimension, percentage),
                priority: priority
            });
        }
    }
    
    return {
        strengths: strengths,
        improvement_areas: improvementAreas
    };
}

// Función para generar HTML de análisis detallado
function generateDetailedAnalysisHTML(analysis) {
    let html = '<div class="row mb-4">';
    
    // Fortalezas
    if (analysis.strengths && analysis.strengths.length > 0) {
        html += `
            <div class="col-lg-6 mb-4">
                <div class="card border-0 h-100" style="background: #f8f9fa; border: 1px solid #dee2e6; border-left: 4px solid #28a745 !important;">
                    <div class="card-header" style="background: #d4edda; color: #155724;">
                        <h6 class="mb-0"><i class="fas fa-star me-2"></i>Fortalezas Identificadas</h6>
                    </div>
                    <div class="card-body">
        `;
        
        analysis.strengths.forEach(strength => {
            html += `
                <div class="d-flex align-items-start mb-3">
                    <div class="flex-shrink-0">
                        <span class="fw-bold text-success">${Math.round(strength.score)}%</span>
                    </div>
                    <div class="flex-grow-1 ms-2">
                        <strong style="color: #333;">${strength.name}</strong>
                        <p class="mb-0 small" style="color: #666;">${strength.description}</p>
                    </div>
                </div>
            `;
        });
        
        html += `
                    </div>
                </div>
            </div>
        `;
    }
    
    // Áreas de mejora
    if (analysis.improvement_areas && analysis.improvement_areas.length > 0) {
        html += `
            <div class="col-lg-6 mb-4">
                <div class="card border-0 h-100" style="background: #f8f9fa; border: 1px solid #dee2e6; border-left: 4px solid #ffc107 !important;">
                    <div class="card-header" style="background: #fff3cd; color: #856404;">
                        <h6 class="mb-0"><i class="fas fa-target me-2"></i>Áreas de Mejora</h6>
                    </div>
                    <div class="card-body">
        `;
        
        analysis.improvement_areas.forEach(area => {
            const priorityClass = area.priority === 'high' ? 'danger' : 'warning';
            const scoreColor = Math.round(area.score) >= 40 ? 'text-warning' : 'text-danger';
            html += `
                <div class="d-flex align-items-start mb-3">
                    <div class="flex-shrink-0">
                        <span class="fw-bold ${scoreColor}">${Math.round(area.score)}%</span>
                    </div>
                    <div class="flex-grow-1 ms-2">
                        <strong style="color: #333;">${area.name}</strong> 
                        <span class="badge bg-${priorityClass} ms-1">${area.priority}</span>
                        <p class="mb-0 small" style="color: #666;">${area.description}</p>
                    </div>
                </div>
            `;
        });
        
        html += `
                    </div>
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    return html;
}

















// Función para generar HTML de respuestas
function generateResponsesHTML(responses) {
    if (!responses || responses.length === 0) {
        return '<p class="text-muted">No hay respuestas detalladas disponibles.</p>';
    }
    
    const optionLabels = {
        1: 'Totalmente en desacuerdo',
        2: 'En desacuerdo', 
        3: 'Neutral',
        4: 'De acuerdo',
        5: 'Totalmente de acuerdo'
    };
    
    let html = '';
    responses.forEach((response, index) => {
        const scoreClass = response.selected_option >= 4 ? 'success' : 
                          response.selected_option === 3 ? 'warning' : 'danger';
        
        html += `
            <div class="border-start border-3 border-primary ps-3 mb-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <strong>Pregunta ${index + 1}:</strong>
                        <p class="mb-1">${response.question_text}</p>
                        <small class="text-${scoreClass}">
                            <i class="fas fa-check-circle me-1"></i>
                            ${optionLabels[response.selected_option] || response.answer_text || 'N/A'}
                        </small>
                    </div>
                    <span class="badge bg-${scoreClass} ms-2">${response.selected_option || response.points || 0}/5</span>
                </div>
            </div>
        `;
    });
    
    return html;
}

// Funciones auxiliares
function getAssertiveLevelFromScore(score) {
    if (score >= 85) return 'Muy Asertivo';
    if (score >= 70) return 'Asertivo';
    if (score >= 50) return 'Moderadamente Asertivo';
    return 'Poco Asertivo';
}

function getDiscLevelFromScore(score) {
    if (score >= 80) return 'Dominante Alto';
    if (score >= 60) return 'Influyente Alto';
    if (score >= 40) return 'Estable Alto';
    if (score >= 20) return 'Concienzudo Alto';
    return 'Perfil Equilibrado';
}

function getEmotionalIntelligenceLevelFromScore(score) {
    if (score >= 80) return 'Muy Alta';
    if (score >= 65) return 'Alta';
    if (score >= 50) return 'Moderada';
    if (score >= 35) return 'Baja';
    return 'Muy Baja';
}

function getLeadershipLevelFromScore(score) {
    if (score >= 80) return 'Liderazgo Excepcional';
    if (score >= 60) return 'Buen Liderazgo';
    if (score >= 40) return 'Liderazgo en Desarrollo';
    return 'Liderazgo Inicial';
}

function getTeamworkLevelFromScore(score) {
    if (score >= 80) return 'Excelente Colaborador';
    if (score >= 60) return 'Buen Colaborador';
    if (score >= 40) return 'Colaborador en Desarrollo';
    return 'Colaborador Inicial';
}

function formatDimensionName(dimension) {
    const nameMap = {
        'comunicacion': 'Comunicación',
        'derechos': 'Defensa de Derechos',
        'opiniones': 'Expresión de Opiniones',
        'conflictos': 'Manejo de Conflictos',
        'autoconfianza': 'Autoconfianza'
    };
    // Si ya está en el mapa, usar ese nombre
    if (nameMap[dimension]) return nameMap[dimension];
    // Si la dimensión ya tiene mayúscula (ej: Inspiración, Delegación), mantenerla tal cual
    if (dimension.charAt(0) === dimension.charAt(0).toUpperCase()) return dimension;
    // Si no, capitalizar primera letra
    return dimension.charAt(0).toUpperCase() + dimension.slice(1);
}

function getDimensionDescription(dimension, score) {
    const descriptions = {
        'comunicacion': score >= 70 ? 'Excelente comunicación interpersonal' : 'Oportunidad de mejorar la comunicación',
        'derechos': score >= 70 ? 'Sabe defender sus derechos apropiadamente' : 'Necesita fortalecer la defensa de derechos',
        'opiniones': score >= 70 ? 'Expresa opiniones con confianza' : 'Puede mejorar la expresión de opiniones',
        'conflictos': score >= 70 ? 'Maneja conflictos efectivamente' : 'Requiere desarrollo en manejo de conflictos',
        'autoconfianza': score >= 70 ? 'Alta confianza en sí mismo/a' : 'Oportunidad de fortalecer autoconfianza'
    };
    // Si está en el mapa específico, usar esa descripción
    if (descriptions[dimension]) return descriptions[dimension];
    // Descripción genérica basada en el score
    if (score >= 70) return 'Fortaleza identificada en esta área';
    if (score >= 50) return 'Área con oportunidad de mejora';
    return 'Área prioritaria de desarrollo';
}

function formatDate(dateString) {
    try {
        // Crear fecha asumiendo que viene en UTC desde el backend
        const date = new Date(dateString + (dateString.includes('Z') ? '' : 'Z'));
        
        return date.toLocaleDateString('es-CL', {
            timeZone: 'America/Santiago',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
    } catch (e) {
        return dateString || 'Fecha no disponible';
    }
}

// Función para editar coachee
function editCoachee(coacheeId) {
    console.log('Edit coachee:', coacheeId);
    
    // Buscar el coachee en los datos cargados
    const coachee = coacheesData.find(c => c.id === coacheeId);
    
    if (!coachee) {
        showAlert('error', 'No se pudo encontrar la información del coachee');
        return;
    }
    
    // Llenar el formulario con los datos actuales
    document.getElementById('editCoacheeId').value = coachee.id;
    document.getElementById('editCoacheeName').value = coachee.name || coachee.full_name || '';
    document.getElementById('editCoacheeEmail').value = coachee.email || '';
    document.getElementById('editCoacheePassword').value = ''; // Siempre vacío por seguridad
    
    // Limpiar alertas previas
    const alertDiv = document.getElementById('editCoacheeAlert');
    alertDiv.className = 'alert d-none';
    alertDiv.innerHTML = '';
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('editCoacheeModal'));
    modal.show();
}

// ✅ Función para mostrar/ocultar contraseña en tabla desktop
function togglePassword(coacheeId, password) {
    const passwordElement = document.getElementById(`pwd-${coacheeId}`);
    const eyeIcon = document.getElementById(`eye-${coacheeId}`);
    
    if (passwordElement.textContent === '●●●●●●●●') {
        passwordElement.textContent = password;
        eyeIcon.className = 'fas fa-eye-slash';
    } else {
        passwordElement.textContent = '●●●●●●●●';
        eyeIcon.className = 'fas fa-eye';
    }
}

// ✅ Función para mostrar/ocultar contraseña en vista móvil
function togglePasswordMobile(coacheeId, password) {
    const passwordElement = document.getElementById(`pwd-mobile-${coacheeId}`);
    const eyeIcon = document.getElementById(`eye-mobile-${coacheeId}`);
    
    if (passwordElement.textContent === '●●●●●●●●') {
        passwordElement.textContent = password;
        eyeIcon.className = 'fas fa-eye-slash';
    } else {
        passwordElement.textContent = '●●●●●●●●';
        eyeIcon.className = 'fas fa-eye';
    }
}

// ✅ Función para colapsar/expandir tarjetas de coachees en móvil
function toggleCoacheeCard(coacheeId) {
    const card = document.querySelector(`.coachee-card-collapsible[data-coachee-id="${coacheeId}"]`);
    if (!card) return;
    
    const contents = card.querySelectorAll('.coachee-card-content');
    const icon = card.querySelector('.coachee-toggle-icon');
    
    const isExpanded = contents[0].style.display !== 'none';
    
    contents.forEach(content => {
        content.style.display = isExpanded ? 'none' : 'block';
    });
    
    if (icon) {
        icon.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
    }
}

// ✅ Función para colapsar todas las tarjetas de coachees
function collapseAllCoacheeCards() {
    const cards = document.querySelectorAll('.coachee-card-collapsible');
    cards.forEach(card => {
        const contents = card.querySelectorAll('.coachee-card-content');
        const icon = card.querySelector('.coachee-toggle-icon');
        
        contents.forEach(content => {
            content.style.display = 'none';
        });
        
        if (icon) {
            icon.style.transform = 'rotate(0deg)';
        }
    });
}

// ✅ Función para copiar contraseña al portapapeles
function copyPassword(password) {
    navigator.clipboard.writeText(password).then(function() {
        // Mostrar mensaje de éxito temporal
        const originalText = event.target.closest('button').innerHTML;
        event.target.closest('button').innerHTML = '<i class="fas fa-check"></i>';
        event.target.closest('button').classList.remove('btn-outline-primary');
        event.target.closest('button').classList.add('btn-success');
        
        setTimeout(() => {
            event.target.closest('button').innerHTML = originalText;
            event.target.closest('button').classList.remove('btn-success');
            event.target.closest('button').classList.add('btn-outline-primary');
        }, 1500);
    }).catch(function() {
        alert('Error al copiar la contraseña');
    });
}

// Manejar formulario de invitación
document.getElementById('inviteForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const name = document.getElementById('coacheeName').value.trim();
    const email = document.getElementById('coacheeEmail').value.trim();
    const assignedAssessment = document.getElementById('assignedAssessment').value;
    const customMessage = document.getElementById('customMessage').value.trim();
    
    if (!name || !email) {
        alert('Por favor complete todos los campos obligatorios');
        return;
    }
    
    // Preparar datos de la invitación
    const invitationData = {
        full_name: name,
        email: email,
        message: customMessage || 'Invitación para participar en evaluaciones de coaching'
    };
    
    // Agregar evaluación asignada si se seleccionó
    if (assignedAssessment) {
        invitationData.assigned_assessment_id = parseInt(assignedAssessment);
    }
    
    fetch('/api/coach/create-invitation-v2', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(invitationData)
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            document.getElementById('inviteForm').reset();
            
            // Guardar datos del coachee para el modal
            window.currentCoacheeData = {
                name: data.coachee.full_name,
                email: data.coachee.email,
                username: data.coachee.username,
                password: data.coachee.password,
                loginUrl: `${window.location.origin}/participant-access`,
                assignedAssessment: data.coachee.assigned_assessment
            };
            
            // Llenar datos en el modal
            document.getElementById('modalCoacheeName').textContent = data.coachee.full_name;
            document.getElementById('modalCoacheeEmail').textContent = data.coachee.email;
            document.getElementById('modalCoacheeUsername').textContent = data.coachee.full_name.toLowerCase();
            document.getElementById('modalCoacheePassword').textContent = data.coachee.password;
            
            // Mostrar información de evaluación asignada si existe
            if (data.coachee.assigned_assessment) {
                document.getElementById('assignedAssessmentName').textContent = data.coachee.assigned_assessment;
                document.getElementById('assessmentAssignedInfo').style.display = 'block';
            } else {
                document.getElementById('assessmentAssignedInfo').style.display = 'none';
            }
            
            // Generar mensaje de invitación
            generateInvitationMessage();
            
            // Mostrar modal con configuración mejorada
            setTimeout(() => {
                const modalElement = document.getElementById('invitationSuccessModal');
                if (modalElement) {
                    // Limpiar cualquier instancia anterior y backdrops residuales
                    const existingModal = bootstrap.Modal.getInstance(modalElement);
                    if (existingModal) {
                        existingModal.dispose();
                    }
                    
                    // Limpiar backdrops residuales y asegurar que no se creen nuevos
                    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = 'auto';
                    document.body.style.paddingRight = '';
                    
                    // Crear nueva instancia con configuración específica
                    const modal = new bootstrap.Modal(modalElement, {
                        backdrop: false,    // Sin fondo oscuro
                        keyboard: true,     // Permitir cerrar con ESC
                        focus: true,
                        show: false
                    });
                    
                    // Mostrar el modal
                    modal.show();
                    
                    // Asegurar que los eventos funcionen correctamente
                    modalElement.addEventListener('hidden.bs.modal', function () {
                        modal.dispose();
                        // Limpieza adicional al cerrar
                        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                    }, { once: true });
                    
                    console.log('✅ Modal de invitación mostrado correctamente');
                } else {
                    console.error('❌ Modal element not found');
                }
            }, 100);
            
            // Recargar lista de coachees
            loadCoachees();
        } else {
            alert('Error al crear el coachee: ' + (data.error || data.message || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error sending invitation:', error);
        alert('Error al enviar la invitación: ' + error.message);
    });
});

// Cargar datos iniciales
document.addEventListener('DOMContentLoaded', function() {
    refreshDashboard();
    
    // FORZAR APLICACIÓN DE ESTILOS PANEL DE CONTROL
    setTimeout(function() {
        // Elementos con las clases nuevas
        const sidebar = document.querySelector('.sidebar-white');
        const header = document.querySelector('.sidebar-header-white');
        const title = document.querySelector('.sidebar-title-white');
        
        // Elementos con las clases originales (por si acaso)
        const sidebarOld = document.querySelector('.sidebar-force-white');
        const headerOld = document.querySelector('.sidebar-header-force');
        const titleOld = document.querySelector('.sidebar-title-force');
        
        // Aplicar estilos a elementos nuevos
        if (sidebar) {
            sidebar.style.setProperty('background', 'white', 'important');
            sidebar.style.setProperty('background-color', 'white', 'important');
            sidebar.style.setProperty('border', '1px solid #dee2e6', 'important');
            sidebar.classList.remove('bg-dark', 'border-secondary');
        }
        if (header) {
            header.style.setProperty('background', '#f8f9fa', 'important');
            header.style.setProperty('background-color', '#f8f9fa', 'important');
            header.style.setProperty('color', '#333', 'important');
            header.classList.remove('bg-dark');
        }
        if (title) {
            title.style.setProperty('color', '#333', 'important');
            title.classList.remove('text-white');
        }
        
        // Aplicar estilos a elementos originales (fallback)
        if (sidebarOld) {
            sidebarOld.style.setProperty('background', 'white', 'important');
            sidebarOld.style.setProperty('background-color', 'white', 'important');
        }
        if (headerOld) {
            headerOld.style.setProperty('background', '#f8f9fa', 'important');
            headerOld.style.setProperty('background-color', '#f8f9fa', 'important');
            headerOld.style.setProperty('color', '#333', 'important');
        }
        if (titleOld) {
            titleOld.style.setProperty('color', '#333', 'important');
        }
        
        console.log('Estilos del panel de control forzados ULTRA - v2.2');
        
        // FORZAR VARIABLES CSS DEL TEMA
        const sidebarTheme = document.querySelector('.sidebar');
        if (sidebarTheme) {
            sidebarTheme.style.setProperty('--theme-card-bg', 'white', 'important');
            sidebarTheme.style.setProperty('--theme-card-border', '#dee2e6', 'important');
            sidebarTheme.style.setProperty('--theme-text-primary', '#333', 'important');
            sidebarTheme.style.setProperty('--theme-hover-bg', '#f8f9fa', 'important');
            console.log('Variables CSS del tema anuladas para sidebar');
        }
    }, 100);
});

// Mejorar navegación del panel de control - Prevenir scroll automático
document.addEventListener('DOMContentLoaded', function() {
    // Agregar event listeners a todos los enlaces del menú
    document.querySelectorAll('[data-module]').forEach(link => {
        link.addEventListener('click', function(e) {
            // Solo prevenir para elementos del menú, no para modales
            if (!e.target.closest('.modal')) {
                e.preventDefault(); // Prevenir comportamiento por defecto
                e.stopPropagation(); // Prevenir propagación del evento
                
                const moduleId = this.getAttribute('data-module');
                if (moduleId) {
                    showModule(moduleId);
                }
                
                return false;
            }
        });
    });
    
    console.log('✅ Event listeners del panel de control configurados');
});

// ===== FUNCIONES PARA ASIGNAR EVALUACIONES/TAREAS =====

// Función para mostrar el modal de asignación
function showAssignModal(coacheeId, coacheeName) {
    console.log('🎯 Abriendo modal de asignación para coachee:', coacheeId, coacheeName);
    
    // Establecer datos del coachee
    document.getElementById('targetCoacheeId').value = coacheeId;
    document.getElementById('assignModalCoacheeName').textContent = coacheeName;
    
    // Cargar evaluaciones disponibles
    loadAssessmentsForAssignment();
    
    // Resetear formularios
    document.getElementById('assignEvaluationForm').reset();
    document.getElementById('assignTaskForm').reset();
    document.getElementById('targetCoacheeId').value = coacheeId; // Restaurar después del reset
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('assignModal'));
    modal.show();
}

// Función para cargar evaluaciones en el selector del modal de asignación
function loadAssessmentsForAssignment() {
    console.log('📋 Cargando evaluaciones para asignación...');
    
    const select = document.getElementById('assignAssessmentSelect');
    select.innerHTML = '<option value="">Cargando evaluaciones...</option>';
    
    fetch('/api/coach/available-assessments')
        .then(response => response.json())
        .then(data => {
            console.log('📊 Evaluaciones recibidas para asignación:', data);
            
            if (data.success && data.assessments && data.assessments.length > 0) {
                select.innerHTML = '<option value="">Seleccionar evaluación</option>';
                
                data.assessments.forEach(assessment => {
                    const option = document.createElement('option');
                    option.value = assessment.id;
                    option.textContent = `${assessment.title} (${assessment.questions_count} preguntas)`;
                    select.appendChild(option);
                });
                
                console.log('✅ Evaluaciones cargadas en selector de asignación');
            } else {
                select.innerHTML = '<option value="">No hay evaluaciones disponibles</option>';
                console.log('❌ No se encontraron evaluaciones para asignación');
            }
        })
        .catch(error => {
            console.error('❌ Error cargando evaluaciones para asignación:', error);
            select.innerHTML = '<option value="">Error cargando evaluaciones</option>';
        });
}

// Función para ejecutar la asignación (evaluación o tarea)
function executeAssignment() {
    const activeTab = document.querySelector('#assignTabs .nav-link.active');
    const isEvaluationTab = activeTab.id === 'evaluation-tab';
    
    if (isEvaluationTab) {
        assignEvaluationFromModal();
    } else {
        assignTaskFromModal();
    }
}

// Función para asignar evaluación desde el modal
function assignEvaluationFromModal() {
    const coacheeId = document.getElementById('targetCoacheeId').value;
    const assessmentId = document.getElementById('assignAssessmentSelect').value;
    const message = document.getElementById('assignEvaluationMessage').value;
    const dueDate = document.getElementById('assignEvaluationDueDate').value;
    
    if (!assessmentId) {
        alert('Por favor selecciona una evaluación');
        return;
    }
    
    console.log('📋 Asignando evaluación:', { coacheeId, assessmentId, message, dueDate });
    
    // Preparar datos para la API de crear tarea
    const taskData = {
        coachee_id: parseInt(coacheeId),
        title: `Evaluación: ${document.getElementById('assignAssessmentSelect').selectedOptions[0].textContent}`,
        description: message || `Completa la evaluación asignada por tu coach.`,
        category: 'evaluation',
        priority: 'high',
        due_date: dueDate || null
    };
    
    // Crear tarea
    fetch('/api/coach/tasks', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(taskData)
    })
    .then(response => response.json())
    .then(data => {
        console.log('📊 Respuesta de asignación de evaluación:', data);
        
        if (data.success) {
            alert('✅ Evaluación asignada exitosamente');
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('assignModal'));
            modal.hide();
            
            // Recargar datos
            loadTasks();
            loadCoachees();
        } else {
            alert('❌ Error al asignar evaluación: ' + (data.message || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('❌ Error asignando evaluación:', error);
        alert('❌ Error al asignar evaluación');
    });
}

// Función para asignar tarea desde el modal
function assignTaskFromModal() {
    const coacheeId = document.getElementById('targetCoacheeId').value;
    const title = document.getElementById('assignTaskTitle').value;
    const description = document.getElementById('assignTaskDescription').value;
    const category = document.getElementById('assignTaskCategory').value;
    const priority = document.getElementById('assignTaskPriority').value;
    const dueDate = document.getElementById('assignTaskDueDate').value;
    
    if (!title || !description || !category) {
        alert('Por favor completa todos los campos requeridos');
        return;
    }
    
    console.log('📝 Asignando tarea:', { coacheeId, title, description, category, priority, dueDate });
    
    const taskData = {
        coachee_id: parseInt(coacheeId),
        title: title,
        description: description,
        category: category,
        priority: priority,
        due_date: dueDate || null
    };
    
    fetch('/api/coach/tasks', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(taskData)
    })
    .then(response => response.json())
    .then(data => {
        console.log('📊 Respuesta de asignación de tarea:', data);
        
        if (data.success) {
            alert('✅ Tarea asignada exitosamente');
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('assignModal'));
            modal.hide();
            
            // Recargar datos
            loadTasks();
            loadCoachees();
        } else {
            alert('❌ Error al asignar tarea: ' + (data.message || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('❌ Error asignando tarea:', error);
        alert('❌ Error al asignar tarea');
    });
}

// Función para abrir modal de asignación desde el contexto de evaluación
function openAssignModalFromEvaluation(assessmentId, assessmentTitle) {
    console.log('🎯 Abriendo modal de asignación desde evaluación:', assessmentId, assessmentTitle);
    
    // Crear un modal específico para seleccionar coachee
    const assignEvaluationModal = document.createElement('div');
    assignEvaluationModal.className = 'modal fade';
    assignEvaluationModal.id = 'assignEvaluationToCoacheeModal';
    assignEvaluationModal.setAttribute('tabindex', '-1');
    
    assignEvaluationModal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus me-2"></i>Asignar Evaluación: ${assessmentTitle}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Pestañas -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="existing-coachee-tab" data-bs-toggle="tab" 
                                data-bs-target="#existing-coachee-pane" type="button" role="tab">
                                <i class="fas fa-users me-1"></i>Coachee Existente
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="new-coachee-tab" data-bs-toggle="tab" 
                                data-bs-target="#new-coachee-pane" type="button" role="tab">
                                <i class="fas fa-user-plus me-1"></i>Nuevo Coachee
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- Pestaña de Coachee Existente -->
                        <div class="tab-pane fade show active" id="existing-coachee-pane" role="tabpanel">
                            <div class="mb-3">
                                <label for="existingCoacheeSelect" class="form-label">Seleccionar coachee:</label>
                                <select class="form-select" id="existingCoacheeSelect" required>
                                    <option value="">Cargando coachees...</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="existingEvaluationMessage" class="form-label">Mensaje personalizado (opcional):</label>
                                <textarea class="form-control" id="existingEvaluationMessage" rows="3" 
                                    placeholder="Mensaje para el coachee..."></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="existingEvaluationDueDate" class="form-label">Fecha límite (opcional):</label>
                                <input type="date" class="form-control" id="existingEvaluationDueDate">
                            </div>
                            
                            <button type="button" class="btn btn-success" onclick="assignEvaluationToExistingCoachee(${assessmentId})">
                                <i class="fas fa-check me-1"></i>Asignar Evaluación
                            </button>
                        </div>

                        <!-- Pestaña de Nuevo Coachee -->
                        <div class="tab-pane fade" id="new-coachee-pane" role="tabpanel">
                            <div class="mb-3">
                                <label for="newCoacheeName" class="form-label">Nombre completo:</label>
                                <input type="text" class="form-control" id="newCoacheeName" required
                                    placeholder="Ej: María González">
                            </div>
                            
                            <div class="mb-3">
                                <label for="newCoacheeEmail" class="form-label">Email:</label>
                                <input type="email" class="form-control" id="newCoacheeEmail" required
                                    placeholder="Ej: maria@empresa.com">
                            </div>
                            
                            <div class="mb-3">
                                <label for="newCoacheePassword" class="form-label">Contraseña temporal:</label>
                                <input type="password" class="form-control" id="newCoacheePassword" required
                                    placeholder="Contraseña para el coachee">
                            </div>
                            
                            <div class="mb-3">
                                <label for="newEvaluationMessage" class="form-label">Mensaje personalizado (opcional):</label>
                                <textarea class="form-control" id="newEvaluationMessage" rows="3" 
                                    placeholder="Mensaje para el coachee..."></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="newEvaluationDueDate" class="form-label">Fecha límite (opcional):</label>
                                <input type="date" class="form-control" id="newEvaluationDueDate">
                            </div>
                            
                            <button type="button" class="btn btn-success" onclick="createCoacheeAndAssignEvaluation(${assessmentId})">
                                <i class="fas fa-user-plus me-1"></i>Crear Coachee y Asignar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Agregar modal al DOM
    document.body.appendChild(assignEvaluationModal);
    
    // Cargar coachees existentes
    loadCoacheesForAssignment();
    
    // Mostrar modal
    const modal = new bootstrap.Modal(assignEvaluationModal);
    modal.show();
    
    // Limpiar modal cuando se cierre
    assignEvaluationModal.addEventListener('hidden.bs.modal', function () {
        document.body.removeChild(assignEvaluationModal);
    });
}

// Función para cargar coachees en el selector
function loadCoacheesForAssignment() {
    console.log('👥 Cargando coachees para asignación...');
    
    const select = document.getElementById('existingCoacheeSelect');
    if (select) {
        select.innerHTML = '<option value="">Cargando coachees...</option>';
        
        fetch('/api/coach/my-coachees')
            .then(response => response.json())
            .then(data => {
                console.log('📊 Coachees cargados:', data);
                
                select.innerHTML = '<option value="">Seleccionar coachee...</option>';
                
                if (data.success && data.coachees) {
                    data.coachees.forEach(coachee => {
                        const option = document.createElement('option');
                        option.value = coachee.id;
                        option.textContent = `${coachee.name} (${coachee.email})`;
                        select.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('❌ Error cargando coachees:', error);
                select.innerHTML = '<option value="">Error cargando coachees</option>';
            });
    }
}

// Función para asignar evaluación a coachee existente
function assignEvaluationToExistingCoachee(assessmentId) {
    const coacheeId = document.getElementById('existingCoacheeSelect').value;
    const message = document.getElementById('existingEvaluationMessage').value;
    const dueDate = document.getElementById('existingEvaluationDueDate').value;
    
    if (!coacheeId) {
        alert('Por favor selecciona un coachee');
        return;
    }
    
    console.log('📋 Asignando evaluación a coachee existente:', { coacheeId, assessmentId, message, dueDate });
    
    // Obtener el título de la evaluación desde el modal
    const modalTitle = document.querySelector('#assignEvaluationToCoacheeModal .modal-title').textContent;
    const assessmentTitle = modalTitle.replace('Asignar Evaluación: ', '');
    
    const taskData = {
        coachee_id: parseInt(coacheeId),
        title: `Evaluación: ${assessmentTitle}`,
        description: message || `Completa la evaluación asignada por tu coach.`,
        category: 'evaluation',
        priority: 'high',
        due_date: dueDate || null
    };
    
    fetch('/api/coach/tasks', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(taskData)
    })
    .then(response => response.json())
    .then(data => {
        console.log('📊 Respuesta de asignación:', data);
        
        if (data.success) {
            alert('✅ Evaluación asignada exitosamente');
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('assignEvaluationToCoacheeModal'));
            modal.hide();
            
            // Recargar datos si estamos en la vista de tareas
            if (typeof loadTasks === 'function') {
                loadTasks();
            }
        } else {
            alert('❌ Error al asignar evaluación: ' + (data.message || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('❌ Error asignando evaluación:', error);
        alert('❌ Error al asignar evaluación');
    });
}

// Función para crear coachee y asignar evaluación
function createCoacheeAndAssignEvaluation(assessmentId) {
    const name = document.getElementById('newCoacheeName').value;
    const email = document.getElementById('newCoacheeEmail').value;
    const password = document.getElementById('newCoacheePassword').value;
    const message = document.getElementById('newEvaluationMessage').value;
    const dueDate = document.getElementById('newEvaluationDueDate').value;
    
    if (!name || !email || !password) {
        alert('Por favor completa todos los campos requeridos');
        return;
    }
    
    console.log('👤 Creando coachee y asignando evaluación:', { name, email, assessmentId, message, dueDate });
    
    // Crear coachee primero
    const coacheeData = {
        full_name: name,
        email: email,
        password: password,
        assigned_assessment_id: assessmentId
    };
    
    fetch('/api/coach/create-invitation-v2', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(coacheeData)
    })
    .then(response => response.json())
    .then(data => {
        console.log('📊 Respuesta de creación de coachee:', data);
        
        if (data.success) {
            alert('✅ Coachee creado y evaluación asignada exitosamente');
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('assignEvaluationToCoacheeModal'));
            modal.hide();
            
            // Recargar datos
            if (typeof loadCoachees === 'function') {
                loadCoachees();
            }
            if (typeof loadTasks === 'function') {
                loadTasks();
            }
        } else {
            alert('❌ Error al crear coachee: ' + (data.message || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('❌ Error creando coachee:', error);
        alert('❌ Error al crear coachee');
    });
}

// Función para mostrar las evaluaciones asignadas a un coachee
function showAssignedAssessments(coacheeId, coacheeName) {
    console.log(`🔍 Showing assigned assessments for coachee ${coacheeId} (${coacheeName})`);
    
    // Actualizar el título del modal
    document.getElementById('assignedAssessmentsModalLabel').innerHTML = 
        `<i class="fas fa-clipboard-list me-2"></i>Evaluaciones - ${coacheeName}`;
    
    // Mostrar spinner de carga
    document.getElementById('assignedAssessmentsContent').innerHTML = `
        <div class="text-center">
            <i class="fas fa-spinner fa-spin fa-2x text-info"></i>
            <p class="mt-2">Cargando evaluaciones asignadas...</p>
        </div>
    `;
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('assignedAssessmentsModal'));
    modal.show();
    
    // Obtener las evaluaciones asignadas
    fetch(`/api/coach/coachee-assessments/${coacheeId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayAssignedAssessments(data.assessments, coacheeId, coacheeName);
            } else {
                document.getElementById('assignedAssessmentsContent').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${data.error || 'Error al cargar las evaluaciones asignadas'}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading assigned assessments:', error);
            document.getElementById('assignedAssessmentsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error al cargar las evaluaciones asignadas
                </div>
            `;
        });
}

// Función para mostrar las evaluaciones asignadas en el modal
function displayAssignedAssessments(assessments, coacheeId, coacheeName) {
    const container = document.getElementById('assignedAssessmentsContent');
    
    if (assessments.length === 0) {
        container.innerHTML = `
            <div class="unified-empty-state">
                <i class="fas fa-clipboard fa-3x"></i>
                <h5>No hay evaluaciones disponibles</h5>
                <p>No se encontraron evaluaciones para este coachee.</p>
            </div>
        `;
        return;
    }
    
    // Separar evaluaciones asignadas y disponibles
    const assignedAssessments = assessments.filter(assessment => assessment.is_assigned);
    const availableAssessments = assessments.filter(assessment => !assessment.is_assigned);
    
    container.innerHTML = `
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="alert alert-info">
                    <i class="fas fa-clipboard-check me-2"></i>
                    <strong>${assignedAssessments.length}</strong> evaluación${assignedAssessments.length !== 1 ? 'es asignadas' : ' asignada'}
                </div>
            </div>
            <div class="col-md-6">
                <div class="alert alert-secondary">
                    <i class="fas fa-clipboard-list me-2"></i>
                    <strong>${availableAssessments.length}</strong> evaluación${availableAssessments.length !== 1 ? 'es disponibles' : ' disponible'}
                </div>
            </div>
        </div>
        
        ${assignedAssessments.length > 0 ? `
            <div class="mb-4">
                <h6 class="text-primary mb-3">
                    <i class="fas fa-clipboard-check me-2"></i>
                    Evaluaciones Asignadas
                </h6>
                <div class="results-list">
                    ${assignedAssessments.map(assessment => `
                        <div class="unified-card">
                            <div class="unified-card-header">
                                <div class="d-flex justify-content-between align-items-start w-100">
                                    <div>
                                        <div class="mb-2">
                                            <span class="unified-badge unified-badge-success">Asignada</span>
                                        </div>
                                        <h5 class="unified-card-title">${assessment.assessment_title}</h5>
                                    </div>
                                    <button class="unified-btn unified-btn-danger unified-btn-sm" 
                                            onclick="confirmUnassignAssessment(${coacheeId}, '${coacheeName}', '${assessment.assessment_title}')" 
                                            title="Desasignar evaluación">
                                        <i class="fas fa-times"></i>
                                        Desasignar
                                    </button>
                                </div>
                            </div>
                            <div class="unified-card-body">
                                <p class="text-muted mb-2">${assessment.description || 'Sin descripción'}</p>
                                <div class="assessment-meta">
                                    <div class="meta-item">
                                        <i class="fas fa-question-circle"></i>
                                        <span>${assessment.total_questions} preguntas</span>
                                    </div>
                                    ${assessment.assigned_date ? `
                                    <div class="meta-item">
                                        <i class="fas fa-calendar-plus"></i>
                                        <span>Asignada: ${new Date(assessment.assigned_date).toLocaleString()}</span>
                                    </div>
                                    ` : ''}
                                    ${assessment.due_date ? `
                                    <div class="meta-item">
                                        <i class="fas fa-calendar-times"></i>
                                        <span>Vence: ${new Date(assessment.due_date).toLocaleString()}</span>
                                    </div>
                                    ` : ''}
                                    ${assessment.completed_attempts > 0 ? `
                                    <div class="meta-item">
                                        <i class="fas fa-check-circle text-success"></i>
                                        <span>Completada ${assessment.completed_attempts} vez${assessment.completed_attempts !== 1 ? 'es' : ''}</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : ''}
        
        ${availableAssessments.length > 0 ? `
            <div class="mb-4">
                <h6 class="text-secondary mb-3">
                    <i class="fas fa-clipboard-list me-2"></i>
                    Evaluaciones Disponibles (No Asignadas)
                </h6>
                <div class="results-list">
                    ${availableAssessments.map(assessment => `
                        <div class="unified-card">
                            <div class="unified-card-header">
                                <div>
                                    <div class="mb-2">
                                        <span class="unified-badge unified-badge-secondary">Disponible</span>
                                    </div>
                                    <h5 class="unified-card-title">${assessment.assessment_title}</h5>
                                </div>
                            </div>
                            <div class="unified-card-body">
                                <p class="text-muted mb-2">${assessment.description || 'Sin descripción'}</p>
                                <div class="assessment-meta">
                                    <div class="meta-item">
                                        <i class="fas fa-question-circle"></i>
                                        <span>${assessment.total_questions} preguntas</span>
                                    </div>
                                    ${assessment.completed_attempts > 0 ? `
                                    <div class="meta-item">
                                        <i class="fas fa-check-circle text-success"></i>
                                        <span>Completada ${assessment.completed_attempts} vez${assessment.completed_attempts !== 1 ? 'es' : ''} (sin asignar)</span>
                                    </div>
                                    ` : `
                                    <div class="meta-item">
                                        <i class="fas fa-clock text-muted"></i>
                                        <span>Sin completar</span>
                                    </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : ''}
        
        <div class="alert alert-info mt-3">
            <i class="fas fa-lightbulb me-2"></i>
            <strong>Información:</strong> Esta vista muestra todas las evaluaciones disponibles para ${coacheeName}. 
            Las evaluaciones marcadas como "Asignadas" aparecen en el dashboard del coachee como tareas pendientes.
        </div>
    `;
}

// Función para confirmar la desasignación de una evaluación
function confirmUnassignAssessment(coacheeId, coacheeName, assessmentTitle) {
    if (confirm(`¿Estás seguro de que deseas desasignar la evaluación "${assessmentTitle}" de ${coacheeName}?\n\nEsta acción no se puede deshacer.`)) {
        unassignAssessment(coacheeId, coacheeName, assessmentTitle);
    }
}

// Función para desasignar una evaluación
function unassignAssessment(coacheeId, coacheeName, assessmentTitle) {
    console.log(`🚫 Unassigning assessment "${assessmentTitle}" from coachee ${coacheeId} (${coacheeName})`);
    
    // Mostrar spinner en el botón
    const buttons = document.querySelectorAll('button[onclick*="confirmUnassignAssessment"]');
    buttons.forEach(btn => {
        if (btn.onclick.toString().includes(assessmentTitle)) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Desasignando...';
            btn.disabled = true;
        }
    });
    
    fetch('/api/coach/unassign-assessment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            coachee_id: coacheeId,
            assessment_title: assessmentTitle
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ Assessment unassigned successfully');
            
            // Mostrar mensaje de éxito
            showSuccessMessage(`Evaluación "${assessmentTitle}" desasignada exitosamente de ${coacheeName}`);
            
            // Recargar las evaluaciones asignadas
            showAssignedAssessments(coacheeId, coacheeName);
            
            // Recargar la lista de coachees para actualizar los contadores
            if (typeof loadCoachees === 'function') {
                loadCoachees();
            }
        } else {
            console.error('❌ Error unassigning assessment:', data.error);
            alert(`❌ Error: ${data.error}`);
            
            // Restaurar botones
            buttons.forEach(btn => {
                if (btn.onclick.toString().includes(assessmentTitle)) {
                    btn.innerHTML = '<i class="fas fa-times me-1"></i>Desasignar';
                    btn.disabled = false;
                }
            });
        }
    })
    .catch(error => {
        console.error('❌ Error unassigning assessment:', error);
        alert('❌ Error al desasignar la evaluación');
        
        // Restaurar botones
        buttons.forEach(btn => {
            if (btn.onclick.toString().includes(assessmentTitle)) {
                btn.innerHTML = '<i class="fas fa-times me-1"></i>Desasignar';
                btn.disabled = false;
            }
        });
    });
}

// Función auxiliar para mostrar mensajes de éxito
function showSuccessMessage(message) {
    // Crear y mostrar un toast de éxito
    const toastContainer = document.querySelector('.toast-container') || createToastContainer();
    
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-check-circle me-2"></i>${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    const toast = new bootstrap.Toast(document.getElementById(toastId));
    toast.show();
    
    // Limpiar el toast después de que se oculte
    document.getElementById(toastId).addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}

// Función para crear el contenedor de toasts si no existe
function createToastContainer() {
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1055';
    document.body.appendChild(container);
    return container;
}

// Función para imprimir reporte de evaluación
function printEvaluationReport() {
    // Crear una nueva ventana para imprimir
    const printWindow = window.open('', '_blank');
    const evaluationContent = document.getElementById('evaluationDetailsContent').innerHTML;
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Reporte de Evaluación de Asertividad</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body { font-family: Arial, sans-serif; }
                .card { border: 1px solid #dee2e6; margin-bottom: 1rem; }
                .badge { display: inline-block; padding: 0.25em 0.6em; }
                @media print { 
                    .btn { display: none; }
                    canvas { max-width: 400px; }
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1 class="text-center mb-4">Reporte de Evaluación de Asertividad</h1>
                ${evaluationContent}
            </div>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
}

// Función específica para mostrar evaluación de Liderazgo en dashboard del coach
function displayLeadershipEvaluation(evaluation) {
    console.log('👔 LEADERSHIP: Displaying Leadership evaluation:', evaluation);
    
    const container = document.getElementById('evaluationDetailsContent');
    
    // Datos de la evaluación
    const rawScore = evaluation.score || 0;
    const maxScore = 50; // 10 preguntas * 5 puntos máximo
    const percentage = Math.round((rawScore / maxScore) * 100);
    const dimensionalScores = evaluation.dimensional_scores || {};
    
    // Determinar nivel de liderazgo según el score
    let level, levelColor, levelDescription;
    if (rawScore >= 40) {
        level = 'Liderazgo consolidado';
        levelColor = '#28a745'; // Verde
        levelDescription = 'Demuestras habilidades de liderazgo sólidas y efectivas.';
    } else if (rawScore >= 30) {
        level = 'Liderazgo competente';
        levelColor = '#17a2b8'; // Azul
        levelDescription = 'Posees buenas habilidades de liderazgo con áreas de mejora.';
    } else if (rawScore >= 20) {
        level = 'Liderazgo en desarrollo';
        levelColor = '#ffc107'; // Amarillo
        levelDescription = 'Muestras potencial de liderazgo con áreas importantes por desarrollar.';
    } else {
        level = 'Liderazgo inicial';
        levelColor = '#dc3545'; // Rojo
        levelDescription = 'Estás comenzando tu camino en el desarrollo de habilidades de liderazgo.';
    }
    
    // Identificar fortalezas y áreas de mejora
    const strengths = [];
    const improvements = [];
    
    for (const [dimension, score] of Object.entries(dimensionalScores)) {
        if (score >= 70) {
            strengths.push({ name: dimension, score: score });
        } else if (score < 50) {
            improvements.push({ name: dimension, score: score });
        }
    }
    
    // Ordenar por score
    strengths.sort((a, b) => b.score - a.score);
    improvements.sort((a, b) => a.score - b.score);
    
    const html = `
        <!-- Resumen General -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="card-body text-center py-4">
                        <h3 class="mb-3">
                            <i class="fas fa-users-cog me-2"></i>
                            Análisis Completo de Habilidades de Liderazgo
                        </h3>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="display-4 fw-bold">${percentage}%</div>
                                <div class="opacity-75">Puntuación Global</div>
                                <small class="opacity-50">${rawScore}/${maxScore} puntos</small>
                            </div>
                            <div class="col-md-3">
                                <div class="h3 fw-bold">${level}</div>
                                <div class="opacity-75">Nivel de Liderazgo</div>
                                <small class="opacity-50">${levelDescription}</small>
                            </div>
                            <div class="col-md-3">
                                <div class="h5">${formatDate(evaluation.completed_at)}</div>
                                <div class="opacity-75">Fecha de Completado</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h5">${evaluation.total_questions || 10}</div>
                                <div class="opacity-75">Preguntas Respondidas</div>
                            </div>
                        </div>
                        ${evaluation.coachee ? `
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="h5">${evaluation.coachee.name}</div>
                                    <div class="opacity-75">Participante</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>

        <!-- Radar y Dimensiones -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="card border-0 h-100 shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-radar me-2 text-primary"></i>
                            Radar de Competencias de Liderazgo
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="radar-chart-container" style="position: relative; height: 300px;">
                            <canvas id="evaluationRadarChart" width="300" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6 mb-4">
                <div class="card border-0 h-100 shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2 text-primary"></i>
                            Puntuaciones por Competencia
                        </h5>
                    </div>
                    <div class="card-body">
                        ${Object.entries(dimensionalScores).map(([dimension, score]) => {
                            const percentage = Math.round(score);
                            let barColor;
                            if (percentage >= 70) barColor = '#28a745';
                            else if (percentage >= 50) barColor = '#17a2b8';
                            else if (percentage >= 30) barColor = '#ffc107';
                            else barColor = '#dc3545';
                            
                            return `
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="fw-medium">${dimension}</span>
                                        <span class="text-muted">${percentage}%</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar" style="width: ${percentage}%; background-color: ${barColor};" role="progressbar"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
        </div>

        <!-- Fortalezas y Áreas de Mejora -->
        <div class="row mb-4">
            ${strengths.length > 0 ? `
                <div class="col-lg-6 mb-4">
                    <div class="card border-0 h-100 shadow-sm" style="border-left: 4px solid #28a745 !important;">
                        <div class="card-header" style="background-color: #d4edda;">
                            <h5 class="mb-0 text-success">
                                <i class="fas fa-star me-2"></i>
                                Fortalezas en Liderazgo
                            </h5>
                        </div>
                        <div class="card-body">
                            ${strengths.map(item => `
                                <div class="d-flex align-items-center mb-3 p-2 bg-light rounded">
                                    <div class="flex-shrink-0 me-3">
                                        <span class="badge bg-success fs-6">${Math.round(item.score)}%</span>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="fw-bold">${item.name}</div>
                                        <small class="text-muted">Competencia destacada</small>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            ` : ''}
            
            ${improvements.length > 0 ? `
                <div class="col-lg-6 mb-4">
                    <div class="card border-0 h-100 shadow-sm" style="border-left: 4px solid #ffc107 !important;">
                        <div class="card-header" style="background-color: #fff3cd;">
                            <h5 class="mb-0 text-warning">
                                <i class="fas fa-chart-line me-2"></i>
                                Áreas de Desarrollo
                            </h5>
                        </div>
                        <div class="card-body">
                            ${improvements.map(item => `
                                <div class="d-flex align-items-center mb-3 p-2 bg-light rounded">
                                    <div class="flex-shrink-0 me-3">
                                        <span class="badge ${item.score < 30 ? 'bg-danger' : 'bg-warning'} fs-6">${Math.round(item.score)}%</span>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="fw-bold">${item.name}</div>
                                        <small class="text-muted">Oportunidad de mejora</small>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            ` : ''}
        </div>

        <!-- Respuestas Detalladas -->
        ${evaluation.responses && evaluation.responses.length > 0 ? `
            <div class="row">
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>
                                Respuestas Detalladas
                            </h5>
                        </div>
                        <div class="card-body">
                            ${evaluation.responses.map((response, index) => {
                                const optionLabels = {
                                    1: 'Nunca',
                                    2: 'Raramente',
                                    3: 'A veces',
                                    4: 'Frecuentemente',
                                    5: 'Siempre'
                                };
                                return `
                                    <div class="mb-3 p-3 border rounded">
                                        <div class="fw-bold mb-2">${index + 1}. ${response.question_text}</div>
                                        <div class="text-muted">
                                            <i class="fas fa-reply me-2"></i>
                                            Respuesta: <span class="badge bg-secondary">${optionLabels[response.selected_option] || response.selected_option}</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            </div>
        ` : ''}
    `;
    
    container.innerHTML = html;
    
    // Crear el gráfico radar después de insertar el HTML
    setTimeout(() => {
        createRadarChart(dimensionalScores, false, false, true, false);
    }, 100);
}

// Función específica para mostrar evaluación "Preparación para crecer 2026" en dashboard del coach
function displayGrowthPreparationEvaluation(evaluation) {
    console.log('🌱 GROWTH COACH: Displaying Preparación para crecer 2026 evaluation:', evaluation);
    
    const container = document.getElementById('evaluationDetailsContent');
    const score = Math.round(evaluation.score || 0);
    const resultText = evaluation.result_text || '';
    const dimensionalScores = evaluation.dimensional_scores || {};
    
    // Determinar el resultado basado en el puntaje
    let resultLevel, resultColor, resultIcon, respuestasC;
    if (score <= 30) {
        resultLevel = "Rojo";
        resultColor = "#dc3545";
        resultIcon = "fas fa-exclamation-triangle";
        respuestasC = "0-2";
    } else if (score <= 70) {
        resultLevel = "Amarillo";
        resultColor = "#ffc107";
        resultIcon = "fas fa-clock";
        respuestasC = "3-4";
    } else {
        resultLevel = "Verde";
        resultColor = "#28a745";
        resultIcon = "fas fa-check-circle";
        respuestasC = "5-7";
    }
    
    const html = `
        <!-- Resultado destacado para Coach -->
        <div class="tu-resultado mb-4 p-4" style="background: ${resultColor} !important; color: white !important; border-radius: 15px; text-align: center; box-shadow: 0 6px 12px rgba(0,0,0,0.1);">
            <h4 style="color: white !important; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5) !important;">
                <i class="${resultIcon} me-2" style="color: white !important;"></i>
                Resultado del Coachee: <span style="color: white !important; text-shadow: 2px 2px 4px rgba(0,0,0,0.5) !important;">${resultLevel}</span>
            </h4>
            <p style="margin: 0; font-size: 1.2em; line-height: 1.5; font-weight: 500; color: white !important;">
                ${resultText.split('\\n\\n')[0]}
            </p>
        </div>

        <!-- Análisis por Dimensiones -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card h-100" style="border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div class="card-header" style="background: #667eea; color: white;">
                        <h5 style="margin: 0; color: white;">
                            <i class="fas fa-chart-radar me-2"></i>
                            Radar de Dimensiones Empresariales
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="radar-chart-container" style="position: relative; height: 300px;">
                            <canvas id="coachGrowthRadarChart" width="300" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="card h-100" style="border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div class="card-header" style="background: #764ba2; color: white;">
                        <h5 style="margin: 0; color: white;">
                            <i class="fas fa-chart-bar me-2"></i>
                            Puntuación por Dimensión
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="coachDimensionalScores">
                            ${generateCoachDimensionalScores(dimensionalScores)}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Respuestas Detalladas -->
        <div class="card" style="border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div class="card-header" style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <h5 style="margin: 0; color: #333;">
                    <i class="fas fa-list-check me-2"></i>
                    Respuestas Detalladas del Coachee
                </h5>
            </div>
            <div class="card-body">
                ${generateResponsesHTML(evaluation.responses || [])}
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    
    // Crear el gráfico radar después de insertar el HTML
    setTimeout(() => {
        createCoachGrowthRadarChart(dimensionalScores);
    }, 100);
}

// Función auxiliar para generar puntuaciones dimensionales en dashboard del coach
function generateCoachDimensionalScores(dimensionalScores) {
    if (!dimensionalScores || Object.keys(dimensionalScores).length === 0) {
        return '<p class="text-muted">No hay datos dimensionales disponibles</p>';
    }
    
    let html = '';
    Object.entries(dimensionalScores).forEach(([dimension, score]) => {
        const percentage = Math.round(((score - 1) / 2) * 100);
        let scoreColor, scoreIcon;
        
        if (score >= 2.5) {
            scoreColor = '#28a745';
            scoreIcon = 'fas fa-check-circle';
        } else if (score >= 1.5) {
            scoreColor = '#ffc107';
            scoreIcon = 'fas fa-clock';
        } else {
            scoreColor = '#dc3545';
            scoreIcon = 'fas fa-exclamation-triangle';
        }
        
        html += `
            <div class="dimension-score mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span style="font-weight: 600; color: #333; font-size: 0.95em;">${dimension}</span>
                    <span class="badge" style="background: ${scoreColor}; color: white; font-size: 0.8em;">
                        <i class="${scoreIcon} me-1"></i>
                        ${score}/3
                    </span>
                </div>
                <div class="d-flex align-items-center">
                    <div class="progress flex-grow-1 me-3" style="height: 15px; background: #e9ecef; border-radius: 8px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);">
                        <div class="progress-bar" style="background: linear-gradient(90deg, ${scoreColor}, ${scoreColor}cc) !important; width: ${percentage}%; border-radius: 8px; transition: width 0.8s ease;">
                        </div>
                    </div>
                    <small style="color: #666; font-weight: 600; min-width: 40px; font-size: 0.9em;">${percentage}%</small>
                </div>
            </div>
        `;
    });
    
    return html;
}

// Función para crear gráfico radar específico para coach
function createCoachGrowthRadarChart(dimensionalScores) {
    const ctx = document.getElementById('coachGrowthRadarChart');
    if (!ctx) {
        console.log('❌ Canvas coachGrowthRadarChart no encontrado');
        return;
    }
    
    if (window.coachGrowthRadarChartInstance) {
        window.coachGrowthRadarChartInstance.destroy();
    }
    
    const labels = Object.keys(dimensionalScores);
    const data = Object.values(dimensionalScores);
    
    window.coachGrowthRadarChartInstance = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Preparación Empresarial',
                data: data,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.2)',
                borderWidth: 2,
                pointBackgroundColor: '#667eea',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                r: {
                    angleLines: {
                        display: true,
                        color: 'rgba(0,0,0,0.1)'
                    },
                    suggestedMin: 0,
                    suggestedMax: 3,
                    ticks: {
                        stepSize: 1,
                        display: true,
                        color: '#666'
                    },
                    pointLabels: {
                        font: {
                            size: 11
                        },
                        color: '#333'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom'
                }
            }
        }
    });
}

// ===== FUNCIONES DE GESTIÓN DE CONTENIDO =====

// Cargar coachees para el selector de contenido
function loadCoacheesForContent() {
    console.log('🔍 Cargando coachees para contenido...');
    
    fetch('/api/coach/my-coachees')
        .then(response => {
            console.log('📡 Respuesta recibida:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📊 Datos recibidos:', data);
            
            const select = document.getElementById('coacheeSelect');
            if (!select) {
                console.error('❌ Elemento coacheeSelect no encontrado');
                return;
            }
            
            select.innerHTML = '<option value="">Selecciona un coachee...</option>';
            
            if (data.success && data.coachees) {
                console.log(`✅ Procesando ${data.coachees.length} coachees`);
                
                data.coachees.forEach(coachee => {
                    const option = document.createElement('option');
                    option.value = coachee.id;
                    option.textContent = `${coachee.full_name} (${coachee.email})`;
                    select.appendChild(option);
                    console.log(`➕ Agregado: ${coachee.full_name}`);
                });
                
                console.log('✅ Coachees cargados exitosamente');
            } else {
                console.error('❌ No se encontraron coachees o respuesta inválida');
                select.innerHTML = '<option value="">No hay coachees disponibles</option>';
            }
        })
        .catch(error => {
            console.error('❌ Error cargando coachees para contenido:', error);
            alert('Error cargando lista de coachees: ' + error.message);
            
            const select = document.getElementById('coacheeSelect');
            if (select) {
                select.innerHTML = '<option value="">Error cargando coachees</option>';
            }
        });
}

// Validar URL de YouTube y mostrar vista previa
// Alias para compatibilidad con código existente
function validateYouTubeUrl(url) {
    return isYouTubeUrl(url);
}

function getYouTubeVideoId(url) {
    return extractYouTubeVideoId(url);
}

// Función para obtener información del video de YouTube
async function getYouTubeVideoInfo(url) {
    try {
        // Verificar si es una URL válida de YouTube
        if (!isYouTubeUrl(url)) {
            return null;
        }
        
        // Usar la API de oEmbed de YouTube para obtener información básica
        const oEmbedResponse = await fetch(`https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`);
        
        if (!oEmbedResponse.ok) {
            throw new Error('No se pudo obtener información del video');
        }
        
        const oEmbedData = await oEmbedResponse.json();
        
        return {
            title: oEmbedData.title || '',
            description: oEmbedData.author_name || 'Contenido educativo asignado por el coach',
            duration: null, // oEmbed no proporciona duración
            thumbnail: oEmbedData.thumbnail_url || ''
        };
    } catch (error) {
        console.warn('No se pudo obtener información del video:', error);
        
        // Fallback: usar información básica si no podemos obtener datos
        const videoId = extractYouTubeVideoId(url);
        return {
            title: 'Video de YouTube',
            description: 'Contenido educativo asignado por el coach',
            duration: null,
            thumbnail: videoId ? `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg` : ''
        };
    }
}

// Verificar si una URL es de YouTube
function isYouTubeUrl(url) {
    if (!url || typeof url !== 'string') return false;
    
    const youtubePatterns = [
        /^https?:\/\/(www\.)?youtube\.com\/watch\?v=[\w-]+/,
        /^https?:\/\/(www\.)?youtu\.be\/[\w-]+/,
        /^https?:\/\/(www\.)?youtube\.com\/embed\/[\w-]+/,
        /^https?:\/\/(www\.)?youtube\.com\/v\/[\w-]+/
    ];
    
    return youtubePatterns.some(pattern => pattern.test(url.trim()));
}

// Extraer el ID del video de YouTube de diferentes formatos de URL
function extractYouTubeVideoId(url) {
    if (!url) return null;
    
    const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/)([^&\n?#]+)/
    ];
    
    for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match) return match[1];
    }
    
    return null;
}

// Función mejorada para mostrar vista previa y llenar campos automáticamente
async function showVideoPreview(url) {
    const previewDiv = document.getElementById('videoPreview');
    const titleInput = document.getElementById('contentTitle');
    const descriptionInput = document.getElementById('contentDescription');
    const durationInput = document.getElementById('videoDuration');
    
    if (!url || !isYouTubeUrl(url)) {
        previewDiv.innerHTML = `
            <i class="fas fa-video fa-3x mb-2 text-muted"></i>
            <p class="small text-muted">La vista previa del video aparecerá aquí cuando ingreses una URL válida</p>
        `;
        return;
    }
    
    const videoId = extractYouTubeVideoId(url);
    if (videoId) {
        // Mostrar preview inmediatamente
        previewDiv.innerHTML = `
            <div class="ratio ratio-16x9">
                <iframe src="https://www.youtube.com/embed/${videoId}" 
                    title="Vista previa del video" frameborder="0" allowfullscreen>
                </iframe>
            </div>
            <p class="small text-info mt-2">
                <i class="fas fa-sync fa-spin me-1"></i>
                Obteniendo información del video...
            </p>
        `;
        
        try {
            // Obtener información del video usando la URL completa
            const videoInfo = await getYouTubeVideoInfo(url);
            
            if (videoInfo) {
                // Llenar campos automáticamente solo si están vacíos
                if (!titleInput.value.trim()) {
                    // Limpiar el título de paréntesis inicial problemático
                    let cleanTitle = videoInfo.title;
                    
                    // Si el título empieza con "(Video de", limpiar esa parte
                    if (cleanTitle.startsWith('(Video de')) {
                        // Buscar el cierre del paréntesis y tomar el texto después
                        const closeParenIndex = cleanTitle.indexOf(')');
                        if (closeParenIndex !== -1) {
                            cleanTitle = cleanTitle.substring(closeParenIndex + 1).trim();
                        }
                    }
                    
                    // Si el título aún está vacío o muy corto, usar un fallback
                    if (!cleanTitle || cleanTitle.length < 3) {
                        cleanTitle = 'Video educativo';
                    }
                    
                    titleInput.value = cleanTitle;
                    titleInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
                
                if (!descriptionInput.value.trim()) {
                    descriptionInput.value = videoInfo.description;
                    descriptionInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
                
                if (videoInfo.duration && !durationInput.value) {
                    durationInput.value = videoInfo.duration;
                    durationInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
                
                // Mostrar notificación de autocompletado
                showAutoFillNotification();
                
                // Actualizar el mensaje en la vista previa
                const infoText = previewDiv.querySelector('.text-info');
                if (infoText) {
                    infoText.innerHTML = `
                        <i class="fas fa-check-circle me-1 text-success"></i>
                        Información del video cargada automáticamente
                    `;
                    infoText.className = 'small text-success mt-2';
                }
            } else {
                // Fallback si no hay información
                const infoText = previewDiv.querySelector('.text-info');
                if (infoText) {
                    infoText.innerHTML = `
                        <i class="fas fa-exclamation-triangle me-1 text-warning"></i>
                        Vista previa disponible - completa manualmente los campos
                    `;
                    infoText.className = 'small text-warning mt-2';
                }
                
                // Llenar con valores por defecto
                if (!titleInput.value.trim()) {
                    titleInput.value = 'Video de YouTube';
                }
                if (!descriptionInput.value.trim()) {
                    descriptionInput.value = 'Contenido educativo asignado por el coach';
                }
            }
        } catch (error) {
            console.warn('Error al obtener información del video:', error);
            
            // Mantener la vista previa pero indicar que hubo un problema
            const infoText = previewDiv.querySelector('.text-info');
            if (infoText) {
                infoText.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-1 text-warning"></i>
                    Vista previa disponible - completa manualmente los campos
                `;
                infoText.className = 'small text-warning mt-2';
            }
            
            // Llenar con valores por defecto
            if (!titleInput.value.trim()) {
                titleInput.value = 'Video de YouTube';
            }
            if (!descriptionInput.value.trim()) {
                descriptionInput.value = 'Contenido educativo asignado por el coach';
            }
        }
    }
}

// Función para mostrar notificación de autocompletado
function showAutoFillNotification() {
    // Crear notificación temporal
    const notification = document.createElement('div');
    notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
    notification.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    notification.innerHTML = `
        <i class="fas fa-magic me-2"></i>
        <strong>¡Campos completados automáticamente!</strong>
        <br>
        <small>Puedes editar la información si es necesario</small>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remover después de 4 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 4000);
}

// Manejar formulario de asignación de contenido
function setupContentAssignmentForm() {
    const form = document.getElementById('assignContentForm');
    const urlInput = document.getElementById('videoUrl');
    
    let debounceTimer;
    
    // Vista previa en tiempo real con debounce para evitar muchas llamadas
    urlInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            showVideoPreview(this.value);
        }, 800); // Esperar 800ms después de que el usuario deje de escribir
    });
    
    // También procesar cuando se pierde el foco del campo
    urlInput.addEventListener('blur', function() {
        clearTimeout(debounceTimer);
        if (this.value.trim()) {
            showVideoPreview(this.value);
        }
    });
    
    // Envío del formulario
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        assignContentToCoachee();
    });
}

// Asignar contenido a coachee
async function assignContentToCoachee() {
    // Prevenir múltiples envíos concurrentes
    const submitButton = document.querySelector('#assignContentForm button[type="submit"]');
    if (submitButton.disabled) {
        console.log('⚠️ Submit ya en progreso, ignorando envío duplicado');
        return;
    }
    
    const coacheeId = document.getElementById('coacheeSelect').value;
    const videoUrl = document.getElementById('videoUrl').value;
    const title = document.getElementById('contentTitle').value;
    const description = document.getElementById('contentDescription').value;
    const duration = document.getElementById('videoDuration').value;
    
    // Validaciones
    if (!coacheeId) {
        showAlert('Por favor selecciona un coachee', 'warning');
        return;
    }
    
    if (!videoUrl) {
        showAlert('Por favor ingresa la URL del video', 'warning');
        return;
    }
    
    if (!validateYouTubeUrl(videoUrl)) {
        showAlert('Por favor ingresa una URL válida de YouTube', 'warning');
        return;
    }
    
    if (!title.trim()) {
        showAlert('Por favor ingresa un título para el contenido', 'warning');
        return;
    }
    
    try {
        // Deshabilitar botón durante envío
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Asignando...';
        
        console.log('📤 Enviando asignación de contenido:', {
            coacheeId,
            videoUrl,
            title: title.trim(),
            description: description.trim()
        });
        
        const response = await fetch('/api/coach/content', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                coachee_id: parseInt(coacheeId),
                title: title.trim(),
                description: description.trim(),
                content_type: 'video',
                content_url: videoUrl,
                duration: duration ? parseInt(duration) * 60 : null // convertir a segundos
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('¡Video asignado exitosamente!', 'success');
            resetAssignForm();
            // Actualizar la lista de contenido asignado si está visible
            if (document.getElementById('manage-content-tab').classList.contains('active')) {
                loadAssignedContent();
            }
        } else {
            throw new Error(data.error || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('Error asignando contenido:', error);
        showAlert('Error asignando contenido: ' + error.message, 'danger');
    } finally {
        // Restaurar botón
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-plus me-1"></i>Asignar Video';
    }
}

// Limpiar formulario de asignación
function resetAssignForm() {
    document.getElementById('assignContentForm').reset();
    showVideoPreview('');
}

// Cargar contenido asignado con filtros
async function loadAssignedContent() {
    const listContainer = document.getElementById('assignedContentList');
    
    try {
        listContainer.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando contenido...</span>
                </div>
            </div>
        `;
        
        // Obtener valores de filtros
        const coacheeFilter = document.getElementById('coacheeFilter').value;
        const viewMode = document.getElementById('viewModeFilter').value;
        
        // Construir URL con parámetros de filtro
        const params = new URLSearchParams();
        if (coacheeFilter) params.append('coachee_id', coacheeFilter);
        if (viewMode) params.append('view_mode', viewMode);
        
        const url = `/api/coach/content${params.toString() ? '?' + params.toString() : ''}`;
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            console.log('🔍 COACH-CONTENT: Datos recibidos del backend', {
                totalItems: data.content.length,
                statistics: data.statistics,
                currentFilter: data.current_filter,
                firstThreeItems: data.content.slice(0, 3).map(item => ({
                    id: item.id,
                    title: item.title,
                    view_mode: item.view_mode,
                    coachee_id: item.coachee_id
                }))
            });
            
            // Actualizar lista de coachees en el filtro si no está poblada
            updateCoacheeFilter(data.coachees);
            // Guardar datos para filtrado local
            lastLoadedContent = data.content;
            lastLoadedData = data;
            renderAssignedContent(data.content, data);
        } else {
            throw new Error(data.error || 'Error desconocido cargando contenido asignado');
        }
        
    } catch (error) {
        console.error('Error cargando contenido asignado:', error);
        listContainer.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
                <p class="text-danger">Error cargando contenido asignado</p>
                <small class="text-muted">${error.message}</small>
            </div>
        `;
    }
}

// Actualizar filtro de coachees
function updateCoacheeFilter(coachees) {
    const select = document.getElementById('coacheeFilter');
    const currentValue = select.value;
    
    // Mantener la opción "Todos"
    const allOption = select.querySelector('option[value=""]');
    select.innerHTML = '';
    select.appendChild(allOption);
    
    // Agregar coachees
    coachees.forEach(coachee => {
        const option = document.createElement('option');
        option.value = coachee.id;
        option.textContent = coachee.name;
        select.appendChild(option);
    });
    
    // Restaurar valor seleccionado
    select.value = currentValue;
}

// Aplicar filtros de contenido
function applyContentFilters() {
    loadAssignedContent();
}

// Limpiar filtros de contenido
function clearContentFilters() {
    document.getElementById('coacheeFilter').value = '';
    document.getElementById('viewModeFilter').value = 'all';
    document.getElementById('statusFilter').value = '';
    document.getElementById('contentSearch').value = '';
    loadAssignedContent();
}

// Función para refrescar lista (ya existente, pero actualizada)
function refreshContentList() {
    loadAssignedContent();
}

// Renderizar contenido asignado
function renderAssignedContent(contentList, data) {
    const listContainer = document.getElementById('assignedContentList');
    const statusFilter = document.getElementById('statusFilter').value;
    const searchTerm = document.getElementById('contentSearch').value.toLowerCase();
    
    console.log('🎨 RENDER-ASSIGNED: Iniciando renderizado', {
        originalCount: contentList.length,
        statusFilter,
        searchTerm,
        firstThreeItems: contentList.slice(0, 3).map(item => ({
            id: item.id,
            title: item.title,
            view_mode: item.view_mode
        }))
    });
    
    if (!contentList || contentList.length === 0) {
        listContainer.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Sin Contenido Asignado</h5>
                <p class="text-muted">No has asignado ningún contenido todavía.</p>
                <p class="small text-info">
                    <i class="fas fa-info-circle me-1"></i>
                    Usa las pestañas "Asignar Video" o "Subir Documentos" para crear nuevas asignaciones
                </p>
            </div>
        `;
        return;
    }
    
    // Filtrar contenido localmente
    let filteredContent = contentList.filter(content => {
        // Filtro de estado
        if (statusFilter === 'viewed' && !content.is_viewed && !content.total_viewed) return false;
        if (statusFilter === 'pending' && (content.is_viewed || (content.total_viewed > 0 && content.total_viewed >= content.total_assigned))) return false;
        
        // Filtro de búsqueda
        if (searchTerm) {
            const searchInTitle = content.title.toLowerCase().includes(searchTerm);
            const searchInCoachee = content.view_mode === 'unique' ? 
                content.assigned_to.toLowerCase().includes(searchTerm) :
                content.coachee_name.toLowerCase().includes(searchTerm);
            if (!searchInTitle && !searchInCoachee) return false;
        }
        
        return true;
    });
    
    console.log('📊 FILTER-RESULT: Después de filtros', {
        originalCount: contentList.length,
        filteredCount: filteredContent.length,
        filteredItems: filteredContent.map(item => ({
            id: item.id,
            title: item.title,
            view_mode: item.view_mode
        }))
    });

    // Estadísticas
    const stats = data.statistics;
    const statsHtml = `
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0">${stats.total_assigned}</h4>
                                <p class="mb-0">Total Asignado</p>
                            </div>
                            <i class="fas fa-share-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0">${stats.total_viewed}</h4>
                                <p class="mb-0">Visto</p>
                            </div>
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0">${stats.total_pending}</h4>
                                <p class="mb-0">Pendiente</p>
                            </div>
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Lista de contenido
    let contentHtml = '<div class="row">';
    
    if (filteredContent.length === 0) {
        contentHtml += `
            <div class="col-12">
                <div class="text-center py-4">
                    <i class="fas fa-filter fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No se encontró contenido con los filtros aplicados</p>
                    <button class="btn btn-outline-primary" onclick="clearContentFilters()">
                        <i class="fas fa-times me-1"></i>Limpiar Filtros
                    </button>
                </div>
            </div>
        `;
    } else {
        filteredContent.forEach(content => {
            if (content.view_mode === 'unique') {
                // Vista única - mostrar contenido agrupado
                contentHtml += renderUniqueContentCard(content);
            } else {
                // Vista normal - mostrar asignaciones individuales
                contentHtml += renderIndividualContentCard(content);
            }
        });
    }
    
    contentHtml += '</div>';
    
    listContainer.innerHTML = statsHtml + contentHtml;
}

// Renderizar tarjeta de contenido único
function renderUniqueContentCard(content) {
    const duration = content.duration ? Math.ceil(content.duration / 60) + ' min' : '';
    
    // Determinar tipo de contenido e icono
    const isDocument = content.content_type === 'document';
    const isVideo = content.content_type === 'video' || !content.content_type; // Por defecto video si no está definido
    
    // Extraer video ID para thumbnail si es YouTube
    let thumbnailUrl = content.thumbnail_url;
    let contentIcon = 'fas fa-video';
    let contentLabel = 'Video';
    
    if (isDocument) {
        contentIcon = getFileIcon(content.content_url);
        contentLabel = 'Documento';
        // Generar preview para documentos (puede ser asíncrono para PDFs)
        const previewResult = generateDocumentPreview(content.content_url, content.title);
        
        // Si es una promesa (PDF), manejarla de forma asíncrona
        if (previewResult && typeof previewResult.then === 'function') {
            // Usar imagen placeholder mientras se carga el PDF
            thumbnailUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDMyMCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMjAiIGhlaWdodD0iMTgwIiBmaWxsPSIjZGMzNTQ1Ii8+Cjx0ZXh0IHg9IjE2MCIgeT0iOTAiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiBmb250LXNpemU9IjE0Ij5DYXJnYW5kbyBQREYuLi48L3RleHQ+Cjwvc3ZnPg==';
            
            // Actualizar thumbnail cuando la promesa se resuelva
            previewResult.then(dataUrl => {
                // Buscar la imagen en el DOM y actualizarla
                const thumbnails = document.querySelectorAll(`img[data-content-id="${content.id}"]`);
                thumbnails.forEach(img => {
                    img.src = dataUrl;
                });
            });
        } else {
            thumbnailUrl = previewResult;
        }
    } else if (isVideo && !thumbnailUrl && (content.content_url.includes('youtube.com') || content.content_url.includes('youtu.be'))) {
        let videoId = '';
        if (content.content_url.includes('youtube.com/watch?v=')) {
            videoId = content.content_url.split('v=')[1].split('&')[0];
        } else if (content.content_url.includes('youtu.be/')) {
            videoId = content.content_url.split('youtu.be/')[1].split('?')[0];
        }
        if (videoId) {
            thumbnailUrl = `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;
        }
    }
    
    const viewedPercentage = content.total_assigned > 0 ? 
        Math.round((content.total_viewed / content.total_assigned) * 100) : 0;
    
    return `
        <div class="col-lg-6 col-xl-4 mb-3">
            <div class="card h-100">
                ${thumbnailUrl ? `
                    <div class="position-relative">
                        <img src="${thumbnailUrl}" class="card-img-top" style="height: 180px; object-fit: cover;" data-content-id="${content.id}">
                        <div class="position-absolute top-0 end-0 m-2">
                            <span class="badge bg-info">
                                <i class="fas fa-users me-1"></i>${content.total_assigned} asignado${content.total_assigned !== 1 ? 's' : ''}
                            </span>
                        </div>
                        ${duration ? `
                            <div class="position-absolute bottom-0 end-0 m-2">
                                <span class="badge bg-dark bg-opacity-75">
                                    <i class="fas fa-clock me-1"></i>${duration}
                                </span>
                            </div>
                        ` : ''}
                    </div>
                ` : `
                    <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 180px;">
                        <div class="text-center">
                            <i class="${contentIcon} fa-3x text-muted mb-2"></i>
                            <div>
                                <span class="badge bg-info">
                                    <i class="fas fa-users me-1"></i>${content.total_assigned} asignado${content.total_assigned !== 1 ? 's' : ''}
                                </span>
                            </div>
                            <div class="mt-1">
                                <small class="text-muted">${contentLabel}</small>
                            </div>
                        </div>
                    </div>
                `}
                
                <div class="card-body">
                    <h6 class="card-title">${escapeHtml(content.title)}</h6>
                    ${content.description ? `<p class="card-text small text-muted">${escapeHtml(content.description)}</p>` : ''}
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted">Progreso de visualización</small>
                            <small class="text-muted">${content.total_viewed}/${content.total_assigned}</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar ${viewedPercentage === 100 ? 'bg-success' : 'bg-primary'}" 
                                 role="progressbar" style="width: ${viewedPercentage}%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-users me-1"></i>
                            <strong>Asignado a:</strong> ${escapeHtml(content.assigned_to)}
                        </small>
                    </div>
                    
                    <div class="row g-2 mb-2">
                        <div class="col-4">
                            <div class="text-center">
                                <div class="badge bg-primary w-100">${content.total_assigned}</div>
                                <small class="text-muted">Total</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center">
                                <div class="badge bg-success w-100">${content.total_viewed}</div>
                                <small class="text-muted">Visto</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center">
                                <div class="badge bg-warning w-100">${content.total_pending}</div>
                                <small class="text-muted">Pendiente</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer bg-transparent">
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="window.open('${content.content_url}', '_blank')">
                            <i class="fas ${isDocument ? 'fa-file-alt' : 'fa-play'} me-1"></i>Ver ${isDocument ? 'Documento' : 'Video'}
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="showContentAssignments(${content.id})">
                            <i class="fas fa-list me-1"></i>Ver Asignaciones
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Renderizar tarjeta de contenido individual
function renderIndividualContentCard(content) {
    const formattedDate = content.assigned_at ? 
        new Date(content.assigned_at).toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        }) : 'Sin fecha';
    
    const viewedDate = content.viewed_at ? 
        new Date(content.viewed_at).toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        }) : null;
    
    const duration = content.duration ? Math.ceil(content.duration / 60) + ' min' : '';
    
    const statusBadge = content.is_viewed ? 
        '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Visto</span>' : 
        '<span class="badge bg-warning"><i class="fas fa-clock me-1"></i>Pendiente</span>';
    
    // Determinar tipo de contenido e icono
    const isDocument = content.content_type === 'document';
    const isVideo = content.content_type === 'video' || !content.content_type;
    
    // Extraer video ID para thumbnail si es YouTube
    let thumbnailUrl = content.thumbnail_url;
    let contentIcon = 'fas fa-video';
    let contentLabel = 'Video';
    
    if (isDocument) {
        contentIcon = getFileIcon(content.content_url);
        contentLabel = 'Documento';
        // Generar preview para documentos (puede ser asíncrono para PDFs)
        const previewResult = generateDocumentPreview(content.content_url, content.title);
        
        // Si es una promesa (PDF), manejarla de forma asíncrona
        if (previewResult && typeof previewResult.then === 'function') {
            // Usar imagen placeholder mientras se carga el PDF
            thumbnailUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDMyMCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMjAiIGhlaWdodD0iMTgwIiBmaWxsPSIjZGMzNTQ1Ii8+Cjx0ZXh0IHg9IjE2MCIgeT0iOTAiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiBmb250LXNpemU9IjE0Ij5DYXJnYW5kbyBQREYuLi48L3RleHQ+Cjwvc3ZnPg==';
            
            // Actualizar thumbnail cuando la promesa se resuelva
            previewResult.then(dataUrl => {
                // Buscar la imagen en el DOM y actualizarla
                const thumbnails = document.querySelectorAll(`img[data-content-id="${content.id}"]`);
                thumbnails.forEach(img => {
                    img.src = dataUrl;
                });
            });
        } else {
            thumbnailUrl = previewResult;
        }
    } else if (isVideo && !thumbnailUrl && (content.content_url.includes('youtube.com') || content.content_url.includes('youtu.be'))) {
        let videoId = '';
        if (content.content_url.includes('youtube.com/watch?v=')) {
            videoId = content.content_url.split('v=')[1].split('&')[0];
        } else if (content.content_url.includes('youtu.be/')) {
            videoId = content.content_url.split('youtu.be/')[1].split('?')[0];
        }
        if (videoId) {
            thumbnailUrl = `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;
        }
    }
    
    return `
        <div class="col-lg-6 col-xl-4 mb-3">
            <div class="card h-100">
                ${thumbnailUrl ? `
                    <div class="position-relative">
                        <img src="${thumbnailUrl}" class="card-img-top" style="height: 180px; object-fit: cover;" data-content-id="${content.id}">
                        <div class="position-absolute top-0 end-0 m-2">
                            ${statusBadge}
                        </div>
                        ${duration ? `
                            <div class="position-absolute bottom-0 end-0 m-2">
                                <span class="badge bg-dark bg-opacity-75">
                                    <i class="fas fa-clock me-1"></i>${duration}
                                </span>
                            </div>
                        ` : ''}
                    </div>
                ` : `
                    <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 180px;">
                        <div class="text-center">
                            <i class="${contentIcon} fa-3x text-muted mb-2"></i>
                            <div>${statusBadge}</div>
                            <div class="mt-1">
                                <small class="text-muted">${contentLabel}</small>
                            </div>
                        </div>
                    </div>
                `}
                
                <div class="card-body">
                    <h6 class="card-title">${escapeHtml(content.title)}</h6>
                    ${content.description ? `<p class="card-text small text-muted">${escapeHtml(content.description)}</p>` : ''}
                    
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-user me-1"></i>
                            <strong>Coachee:</strong> ${escapeHtml(content.coachee_name)}
                        </small>
                    </div>
                    
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-calendar me-1"></i>
                            <strong>Asignado:</strong> ${formattedDate}
                        </small>
                    </div>
                    
                    ${content.is_viewed && viewedDate ? `
                        <div class="mb-2">
                            <small class="text-success">
                                <i class="fas fa-check-circle me-1"></i>
                                <strong>Visto:</strong> ${viewedDate}
                            </small>
                        </div>
                    ` : ''}
                </div>
                
                <div class="card-footer bg-transparent">
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="window.open('${content.content_url}', '_blank')">
                            <i class="fas ${isDocument ? 'fa-file-alt' : 'fa-play'} me-1"></i>Ver ${isDocument ? 'Documento' : 'Video'}
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAssignedContent(${content.id})">
                            <i class="fas fa-trash me-1"></i>Eliminar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Función para eliminar contenido asignado
async function deleteAssignedContent(contentId) {
    if (!confirm('¿Estás seguro de que quieres eliminar este contenido asignado?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/coach/content/${contentId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('Contenido eliminado exitosamente', 'success');
            loadAssignedContent(); // Recargar la lista
        } else {
            throw new Error(data.error || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('Error eliminando contenido:', error);
        showAlert('Error eliminando contenido: ' + error.message, 'danger');
    }
}

// Refrescar lista de contenido
function refreshContentList() {
    loadAssignedContent();
}

// Función para escapar HTML y prevenir XSS
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Configurar pestañas de contenido
function setupContentTabs() {
    const assignTab = document.getElementById('assign-content-tab');
    const manageTab = document.getElementById('manage-content-tab');
    
    assignTab.addEventListener('shown.bs.tab', function() {
        loadCoacheesForContent();
    });
    
    manageTab.addEventListener('shown.bs.tab', function() {
        loadAssignedContent();
    });
}

// Inicializar cuando se muestra el módulo de contenido
function initializeContentModule() {
    console.log('🚀 Inicializando módulo de contenido...');
    setupContentAssignmentForm();
    setupContentTabs();
    loadCoacheesForContent();
}

// Llamar a inicialización cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
    console.log('📄 DOM cargado, configurando observer para módulo de contenido...');
    
    // Observer para detectar cuando el módulo de contenido se hace visible
    const contentModule = document.getElementById('agregar-contenido');
    if (contentModule) {
        console.log('✅ Módulo de contenido encontrado, configurando observer...');
        
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                    const isVisible = contentModule.style.display !== 'none';
                    console.log('👁️ Cambio de visibilidad detectado:', isVisible);
                    
                    if (isVisible) {
                        console.log('🎯 Módulo de contenido ahora visible, inicializando...');
                        initializeContentModule();
                        initializeDocumentModule();
                    }
                }
            });
        });
        
        observer.observe(contentModule, {
            attributes: true,
            attributeFilter: ['style']
        });
        
        // También intentar inicializar inmediatamente si ya está visible
        if (contentModule.style.display !== 'none') {
            console.log('🎯 Módulo ya visible, inicializando inmediatamente...');
            initializeContentModule();
            initializeDocumentModule();
        }
    } else {
        console.error('❌ Módulo de contenido no encontrado');
    }
    
    // También agregar listener para cuando se hace clic en el enlace de contenido
    const contentLink = document.querySelector('[data-module="agregar-contenido"]');
    if (contentLink) {
        console.log('✅ Enlace de contenido encontrado, agregando listener...');
        contentLink.addEventListener('click', function() {
            console.log('🖱️ Click en enlace de contenido detectado');
            setTimeout(() => {
                initializeContentModule();
            }, 100);
        });
    }
    
    // Agregar event listeners para los filtros de contenido
    const coacheeFilter = document.getElementById('coacheeFilter');
    const viewModeFilter = document.getElementById('viewModeFilter');
    const statusFilter = document.getElementById('statusFilter');
    const contentSearch = document.getElementById('contentSearch');
    
    if (coacheeFilter) {
        coacheeFilter.addEventListener('change', applyContentFilters);
    }
    if (viewModeFilter) {
        viewModeFilter.addEventListener('change', applyContentFilters);
    }
    if (statusFilter) {
        statusFilter.addEventListener('change', function() {
            // Para filtro de estado, aplicar filtro local sin recargar desde servidor
            const listContainer = document.getElementById('assignedContentList');
            if (listContainer && listContainer.innerHTML !== '') {
                // Re-aplicar renderizado con filtros locales
                renderAssignedContent(lastLoadedContent, lastLoadedData);
            }
        });
    }
    if (contentSearch) {
        let searchTimeout;
        contentSearch.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                // Para búsqueda, aplicar filtro local sin recargar desde servidor
                const listContainer = document.getElementById('assignedContentList');
                if (listContainer && listContainer.innerHTML !== '') {
                    renderAssignedContent(lastLoadedContent, lastLoadedData);
                }
            }, 300);
        });
    }
});

// Listener específico para pestañas de gestión de citas
document.addEventListener('DOMContentLoaded', function() {
    // Configurar listeners para las pestañas de gestión de citas
    const appointmentTab = document.getElementById('appointment-management-tab');
    if (appointmentTab) {
        appointmentTab.addEventListener('click', function() {
            setTimeout(setupAppointmentManagementListeners, 100);
        });
    }
    
    // También configurar listeners para las sub-pestañas
    const selfScheduleTab = document.getElementById('self-schedule-tab');
    const directAppointmentTab = document.getElementById('direct-appointment-tab');
    
    if (selfScheduleTab) {
        selfScheduleTab.addEventListener('click', function() {
            setTimeout(() => {
                loadSelfScheduledActivities();
                // Configurar fecha por defecto
                const today = getSantiagoDate();
                const selfDateInput = document.getElementById('selfDate');
                if (selfDateInput && !selfDateInput.value) {
                    selfDateInput.value = today;
                    selfDateInput.min = today;
                }
            }, 100);
        });
    }
    
    if (directAppointmentTab) {
        directAppointmentTab.addEventListener('click', function() {
            setTimeout(() => {
                loadCoacheesForDirectAppointment();
                loadDirectAppointments();
                // Configurar fecha por defecto
                const tomorrow = getSantiagoTomorrow();
                const directDateInput = document.getElementById('directDate');
                if (directDateInput && !directDateInput.value) {
                    directDateInput.value = tomorrow;
                    directDateInput.min = getSantiagoDate();
                }
            }, 100);
        });
    }
});

// Variables globales para mantener el último contenido cargado
let lastLoadedContent = [];
let lastLoadedData = {};

// Función para mostrar asignaciones de un contenido único
function showContentAssignments(contentId) {
    // Esta función mostrará un modal con todas las asignaciones individuales
    // Por ahora, cambiar a vista "all" y filtrar por ese contenido
    document.getElementById('viewModeFilter').value = 'all';
    loadAssignedContent();
}

// Funciones para el modal de edición de coachee
function toggleEditPassword() {
    const passwordInput = document.getElementById('editCoacheePassword');
    const passwordIcon = document.getElementById('editPasswordIcon');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        passwordIcon.className = 'fas fa-eye-slash';
    } else {
        passwordInput.type = 'password';
        passwordIcon.className = 'fas fa-eye';
    }
}

async function saveCoacheeChanges() {
    const coacheeId = document.getElementById('editCoacheeId').value;
    const name = document.getElementById('editCoacheeName').value.trim();
    const email = document.getElementById('editCoacheeEmail').value.trim();
    const password = document.getElementById('editCoacheePassword').value.trim();
    
    // Validaciones básicas
    if (!name) {
        showEditAlert('error', 'El nombre es requerido');
        return;
    }
    
    if (!email) {
        showEditAlert('error', 'El email es requerido');
        return;
    }
    
    if (!email.includes('@')) {
        showEditAlert('error', 'Formato de email inválido');
        return;
    }
    
    if (password && password.length < 4) {
        showEditAlert('error', 'La contraseña debe tener al menos 4 caracteres');
        return;
    }
    
    // Deshabilitar botón y mostrar cargando
    const saveBtn = document.getElementById('saveCoacheeBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Guardando...';
    
    try {
        const updateData = {
            full_name: name,
            email: email
        };
        
        // Solo incluir contraseña si se proporcionó una nueva
        if (password) {
            updateData.password = password;
        }
        
        const response = await fetch(`/api/coach/update-coachee/${coacheeId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updateData)
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            showEditAlert('success', 'Coachee actualizado exitosamente');
            
            // Actualizar los datos en memoria
            const coacheeIndex = coacheesData.findIndex(c => c.id == coacheeId);
            if (coacheeIndex !== -1) {
                coacheesData[coacheeIndex].name = name;
                coacheesData[coacheeIndex].full_name = name;
                coacheesData[coacheeIndex].email = email;
                if (password) {
                    coacheesData[coacheeIndex].password = password;
                }
            }
            
            // Actualizar la tabla
            displayCoachees();
            
            // Cerrar modal después de un breve delay
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('editCoacheeModal'));
                modal.hide();
            }, 1500);
            
        } else {
            showEditAlert('error', data.error || 'Error al actualizar el coachee');
        }
        
    } catch (error) {
        console.error('Error updating coachee:', error);
        showEditAlert('error', 'Error de conexión. Inténtalo de nuevo.');
    } finally {
        // Restaurar botón
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
    }
}

function showEditAlert(type, message) {
    const alertDiv = document.getElementById('editCoacheeAlert');
    alertDiv.className = `alert alert-${type === 'error' ? 'danger' : 'success'}`;
    alertDiv.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'check-circle'} me-1"></i>${message}`;
}

// Funciones para manejo de invitaciones de WhatsApp
function generateInvitationMessage() {
    const data = window.currentCoacheeData;
    if (!data) return;
    
    let message = `🎯 *Invitación a Evaluación de Coaching*\n\n`;
    message += `¡Hola ${data.name}! 👋\n\n`;
    message += `Has sido invitado/a a participar en una evaluación de coaching. `;
    message += `A continuación encontrarás tus credenciales de acceso:\n\n`;
    
    message += `📋 *DATOS DE ACCESO:*\n`;
    message += `• *Usuario:* ${data.username}\n`;
    message += `• *Contraseña:* ${data.password}\n`;
    message += `• *Link de acceso:* ${data.loginUrl}\n\n`;
    
    if (data.assignedAssessment) {
        message += `✅ *EVALUACIÓN ASIGNADA:*\n`;
        message += `"${data.assignedAssessment}"\n\n`;
    }
    
    message += `📱 *INSTRUCCIONES:*\n`;
    message += `1. Haz clic en el link de acceso\n`;
    message += `2. Ingresa tu usuario y contraseña\n`;
    message += `3. Completa la evaluación asignada\n`;
    message += `4. ¡Listo! Tu coach revisará los resultados\n\n`;
    
    message += `💡 *Tip:* Responde con honestidad para obtener los mejores insights para tu desarrollo.\n\n`;
    message += `¿Tienes dudas? ¡Contáctame! 😊`;
    
    document.getElementById('invitationMessage').textContent = message;
    return message;
}

function copyInvitationToClipboard() {
    const message = document.getElementById('invitationMessage').textContent;
    
    // Usar la API moderna del portapapeles si está disponible
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(message).then(() => {
            showNotification('¡Mensaje copiado al portapapeles!', 'success');
        }).catch(err => {
            console.error('Error al copiar al portapapeles:', err);
            fallbackCopyToClipboard(message);
        });
    } else {
        fallbackCopyToClipboard(message);
    }
}

function fallbackCopyToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showNotification('¡Mensaje copiado al portapapeles!', 'success');
    } catch (err) {
        console.error('Error al copiar:', err);
        showNotification('Error al copiar. Por favor, selecciona y copia manualmente.', 'error');
    }
    
    document.body.removeChild(textArea);
}

function shareViaWhatsApp() {
    const message = document.getElementById('invitationMessage').textContent;
    const encodedMessage = encodeURIComponent(message);
    const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
    
    // Abrir WhatsApp en una nueva ventana
    window.open(whatsappUrl, '_blank');
    
    showNotification('Abriendo WhatsApp...', 'info');
}

function shareViaEmail() {
    const data = window.currentCoacheeData;
    if (!data) return;
    
    const subject = `Invitación a Evaluación de Coaching - ${data.name}`;
    const body = document.getElementById('invitationMessage').textContent;
    
    const emailUrl = `mailto:${data.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    
    // Abrir cliente de email
    window.location.href = emailUrl;
    
    showNotification('Abriendo cliente de email...', 'info');
}

function showNotification(message, type = 'info') {
    // Crear notificación temporal
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 15000; min-width: 300px;';
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-1"></i>
        ${message}
    `;
    
    document.body.appendChild(notification);
    
    // Remover después de 3 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

function closeInvitationModal() {
    const modalElement = document.getElementById('invitationSuccessModal');
    if (modalElement) {
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
            // Limpiar backdrop si queda colgado
            setTimeout(() => {
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }, 300);
        } else {
            // Método alternativo si no hay instancia
            modalElement.style.display = 'none';
            modalElement.classList.remove('show');
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }
        console.log('✅ Modal cerrado manualmente');
    }
}

// Agregar listener para ESC global como fallback
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modal = document.getElementById('invitationSuccessModal');
        if (modal && modal.classList.contains('show')) {
            closeInvitationModal();
            console.log('✅ Modal cerrado con ESC');
        }
    }
});

// ===== FUNCIONES DE GESTIÓN DE DOCUMENTOS =====

// Cargar coachees para el selector de documentos
function loadCoacheesForDocuments() {
    console.log('🔍 Cargando coachees para documentos...');
    
    fetch('/api/coach/my-coachees', {
        credentials: 'include'
    })
        .then(response => {
            console.log('📡 Respuesta loadCoacheesForDocuments:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📄 Datos recibidos:', data);
            
            const select = document.getElementById('coacheeSelectDocuments');
            if (!select) {
                console.error('❌ Selector coacheeSelectDocuments no encontrado');
                return;
            }
            
            select.innerHTML = '<option value="">Selecciona un coachee...</option>';
            
            if (data.success && data.coachees) {
                console.log(`✅ Cargando ${data.coachees.length} coachees`);
                data.coachees.forEach(coachee => {
                    const option = document.createElement('option');
                    option.value = coachee.id;
                    option.textContent = `${coachee.full_name} (${coachee.email})`;
                    select.appendChild(option);
                });
            } else {
                console.warn('⚠️ No se encontraron coachees o respuesta no exitosa');
            }
        })
        .catch(error => {
            console.error('❌ Error cargando coachees para documentos:', error);
        });
}

// Configurar vista previa de archivo
function setupDocumentPreview() {
    const fileInput = document.getElementById('documentFile');
    const previewContainer = document.getElementById('documentPreviewContainer');
    
    if (!fileInput || !previewContainer) return;
    
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) {
            showDefaultPreview();
            return;
        }
        
        // Validar tamaño (10MB máximo)
        if (file.size > 10 * 1024 * 1024) {
            showToast('El archivo es demasiado grande. Máximo 10MB permitido.', 'error');
            fileInput.value = '';
            showDefaultPreview();
            return;
        }
        
        // Mostrar información del archivo
        const fileInfo = `
            <div class="text-center">
                <i class="fas ${getFileIcon(file.type)} fa-3x text-primary mb-3"></i>
                <h6 class="mb-2">${file.name}</h6>
                <p class="text-muted mb-1">Tamaño: ${formatFileSize(file.size)}</p>
                <p class="text-muted">Tipo: ${file.type || 'Desconocido'}</p>
                
                ${file.type.startsWith('image/') ? `
                    <div class="mt-3">
                        <img id="imagePreview" src="" alt="Vista previa" class="img-fluid rounded" style="max-height: 200px;">
                    </div>
                ` : ''}
                
                ${file.type === 'application/pdf' ? `
                    <div class="mt-3">
                        <div id="pdfPreviewContainer" class="border rounded p-2" style="min-height: 250px; background-color: #f8f9fa;">
                            <div class="d-flex justify-content-center align-items-center" style="height: 230px;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando vista previa...</span>
                                </div>
                            </div>
                        </div>
                        <small class="text-muted mt-2 d-block">Vista previa de la primera página</small>
                    </div>
                ` : ''}
                
                ${(file.type.includes('document') || file.type.includes('word') || file.name.endsWith('.doc') || file.name.endsWith('.docx')) ? `
                    <div class="mt-3">
                        <div class="alert alert-info">
                            <i class="fas fa-file-word me-2"></i>
                            <strong>Documento Word detectado</strong><br>
                            <small>La vista previa estará disponible después de la conversión automática a PDF</small>
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
        
        previewContainer.innerHTML = fileInfo;
        
        // Si es imagen, mostrar vista previa
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imagePreview = document.getElementById('imagePreview');
                if (imagePreview) {
                    imagePreview.src = e.target.result;
                }
            };
            reader.readAsDataURL(file);
        }
        
        // Si es PDF, mostrar vista previa usando PDF.js
        if (file.type === 'application/pdf') {
            displayPDFPreview(file);
        }
        // Si es documento Word
        else if (file.type.includes('word') || file.type.includes('msword') || 
                 file.type.includes('application/vnd.openxmlformats-officedocument.wordprocessingml.document') ||
                 file.name.toLowerCase().endsWith('.doc') || file.name.toLowerCase().endsWith('.docx')) {
            displayWordDocumentInfo(file);
        }
        // Para otros tipos de documento
        else if (!file.type.startsWith('image/')) {
            displayGenericDocumentInfo(file);
        }
        
        // Auto-rellenar título si está vacío
        const titleInput = document.getElementById('documentTitle');
        if (titleInput && !titleInput.value) {
            const fileName = file.name.split('.').slice(0, -1).join('.');
            titleInput.value = fileName;
        }
    });
}

// Mostrar vista previa por defecto
function showDefaultPreview() {
    const previewContainer = document.getElementById('documentPreviewContainer');
    if (!previewContainer) return;
    
    previewContainer.innerHTML = `
        <div class="text-muted">
            <i class="fas fa-file-alt" style="font-size: 48px; opacity: 0.3;"></i>
            <p class="mt-3">Selecciona un archivo para ver la vista previa</p>
        </div>
    `;
}

// Mostrar vista previa de PDF
async function displayPDFPreview(file) {
    const container = document.getElementById('pdfPreviewContainer');
    if (!container) return;
    
    try {
        // Verificar si PDF.js está disponible
        if (typeof pdfjsLib === 'undefined') {
            container.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Vista previa no disponible</strong><br>
                    <small>PDF seleccionado correctamente, pero la vista previa requiere configuración adicional</small>
                </div>
            `;
            return;
        }
        
        // Mostrar indicador de carga
        container.innerHTML = `
            <div class="d-flex justify-content-center align-items-center" style="height: 230px;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Generando vista previa...</span>
                </div>
            </div>
        `;
        
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const typedarray = new Uint8Array(e.target.result);
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                const page = await pdf.getPage(1);
                
                // Crear canvas con dimensiones similares a generateDocumentPreview
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                
                // Configurar dimensiones (proporción 16:9 como en generateDocumentPreview)
                canvas.width = 320;
                canvas.height = 180;
                
                const viewport = page.getViewport({ scale: 1 });
                
                // Calcular escala para ajustar al canvas (misma lógica que generatePDFPreview)
                const scaleX = canvas.width / viewport.width;
                const scaleY = canvas.height / viewport.height;
                const scale = Math.min(scaleX, scaleY);
                
                const scaledViewport = page.getViewport({ scale: scale });
                
                // Centrar el contenido
                const offsetX = (canvas.width - scaledViewport.width) / 2;
                const offsetY = (canvas.height - scaledViewport.height) / 2;
                
                // Limpiar canvas con fondo blanco
                context.fillStyle = '#ffffff';
                context.fillRect(0, 0, canvas.width, canvas.height);
                
                // Configurar contexto para renderizado
                const renderContext = {
                    canvasContext: context,
                    viewport: scaledViewport,
                    transform: [1, 0, 0, 1, offsetX, offsetY]
                };
                
                await page.render(renderContext).promise;
                
                // Mostrar canvas en el contenedor
                container.innerHTML = '';
                canvas.className = 'img-fluid rounded border';
                canvas.style.maxWidth = '100%';
                canvas.style.maxHeight = '230px';
                canvas.style.objectFit = 'contain';
                container.appendChild(canvas);
                
            } catch (error) {
                console.error('Error renderizando PDF:', error);
                // Usar el fallback genérico de generateGenericDocumentPreview
                const fallbackCanvas = document.createElement('canvas');
                const ctx = fallbackCanvas.getContext('2d');
                fallbackCanvas.width = 320;
                fallbackCanvas.height = 180;
                
                const dataUrl = generateGenericDocumentPreview('document.pdf', file.name, fallbackCanvas, ctx);
                
                container.innerHTML = `
                    <img src="${dataUrl}" class="img-fluid rounded border" style="max-width: 100%; max-height: 230px; object-fit: contain;" alt="Vista previa del documento">
                `;
            }
        };
        
        reader.readAsArrayBuffer(file);
        
    } catch (error) {
        console.error('Error cargando PDF:', error);
        // Usar el fallback genérico de generateGenericDocumentPreview
        const fallbackCanvas = document.createElement('canvas');
        const ctx = fallbackCanvas.getContext('2d');
        fallbackCanvas.width = 320;
        fallbackCanvas.height = 180;
        
        const dataUrl = generateGenericDocumentPreview('document.pdf', file.name, fallbackCanvas, ctx);
        
        container.innerHTML = `
            <img src="${dataUrl}" class="img-fluid rounded border" style="max-width: 100%; max-height: 230px; object-fit: contain;" alt="Vista previa del documento">
        `;
    }
}

// Mostrar información para documentos Word
function displayWordDocumentInfo(file) {
    const container = document.getElementById('wordPreviewContainer');
    if (!container) return;
    
    const fileSizeKB = (file.size / 1024).toFixed(1);
    container.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-file-word me-2" style="color: #2b579a;"></i>
            <strong>Documento Word seleccionado</strong><br>
            <small class="text-muted">
                ${file.name}<br>
                Tamaño: ${fileSizeKB} KB
            </small>
        </div>
    `;
}

// Mostrar información para documentos genéricos
function displayGenericDocumentInfo(file) {
    const container = document.getElementById('wordPreviewContainer');
    if (!container) return;
    
    const fileSizeKB = (file.size / 1024).toFixed(1);
    const extension = file.name.split('.').pop().toUpperCase();
    
    container.innerHTML = `
        <div class="alert alert-secondary">
            <i class="fas fa-file me-2"></i>
            <strong>Documento ${extension} seleccionado</strong><br>
            <small class="text-muted">
                ${file.name}<br>
                Tamaño: ${fileSizeKB} KB
            </small>
        </div>
    `;
}

// Obtener icono según tipo de archivo
function getFileIcon(input) {
    // Si es un MIME type
    if (input.includes('/')) {
        if (input.startsWith('image/')) return 'fa-image';
        if (input === 'application/pdf') return 'fa-file-pdf';
        if (input.includes('word')) return 'fa-file-word';
        if (input.includes('excel') || input.includes('spreadsheet')) return 'fa-file-excel';
        if (input.includes('powerpoint') || input.includes('presentation')) return 'fa-file-powerpoint';
        return 'fa-file';
    }
    
    // Si es una URL, extraer la extensión
    const extension = input.split('.').pop().toLowerCase();
    if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(extension)) return 'fa-image';
    if (extension === 'pdf') return 'fa-file-pdf';
    if (['doc', 'docx'].includes(extension)) return 'fa-file-word';
    if (['xls', 'xlsx'].includes(extension)) return 'fa-file-excel';
    if (['ppt', 'pptx'].includes(extension)) return 'fa-file-powerpoint';
    if (['mp4', 'avi', 'mov', 'wmv', 'webm'].includes(extension)) return 'fa-video';
    return 'fa-file';
}

// Generar preview para documentos
function generateDocumentPreview(contentUrl, title) {
    // Crear canvas para el preview
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Configurar dimensiones (proporción 16:9 como los videos de YouTube)
    canvas.width = 320;
    canvas.height = 180;
    
    // Detectar si es un documento basándose en la URL o el título
    const isPDFUrl = contentUrl.includes('/api/coach/documents/') || contentUrl.includes('.pdf');
    const isPDFTitle = title && (title.toLowerCase().includes('.pdf') || title.toLowerCase().endsWith('pdf'));
    
    // Si es PDF, intentar renderizar la primera página
    if (isPDFUrl || isPDFTitle) {
        return generatePDFPreview(contentUrl, canvas);
    } else {
        // Para otros tipos de documento, usar preview genérico
        return generateGenericDocumentPreview(contentUrl, title, canvas, ctx);
    }
}

function generatePDFPreview(contentUrl, canvas) {
    const ctx = canvas.getContext('2d');
    
    // Cargar PDF.js si no está disponible
    if (typeof pdfjsLib === 'undefined') {
        console.log('PDF.js no disponible, usando preview genérico');
        return generateGenericDocumentPreview(contentUrl, 'PDF Document', canvas, ctx);
    }
    
    // Configurar PDF.js worker
    pdfjsLib.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    return new Promise((resolve) => {
        // Si es una URL de descarga de documentos, necesitamos obtenerla con fetch para incluir cookies
        if (contentUrl.includes('/api/coach/documents/')) {
            fetch(contentUrl, {
                method: 'GET',
                credentials: 'include', // Incluir cookies de sesión
                headers: {
                    'Accept': 'application/pdf'
                }
            }).then(response => {
                if (!response.ok) {
                    throw new Error('Error descargando documento');
                }
                return response.arrayBuffer();
            }).then(arrayBuffer => {
                const typedarray = new Uint8Array(arrayBuffer);
                return pdfjsLib.getDocument(typedarray).promise;
            }).then(function(pdf) {
                // Renderizar la primera página
                pdf.getPage(1).then(function(page) {
                    const viewport = page.getViewport({ scale: 1 });
                    
                    // Calcular escala para ajustar al canvas
                    const scaleX = canvas.width / viewport.width;
                    const scaleY = canvas.height / viewport.height;
                    const scale = Math.min(scaleX, scaleY);
                    
                    const scaledViewport = page.getViewport({ scale: scale });
                    
                    // Centrar el contenido
                    const offsetX = (canvas.width - scaledViewport.width) / 2;
                    const offsetY = (canvas.height - scaledViewport.height) / 2;
                    
                    // Limpiar canvas con fondo blanco
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Configurar contexto para renderizado
                    const renderContext = {
                        canvasContext: ctx,
                        viewport: scaledViewport,
                        transform: [1, 0, 0, 1, offsetX, offsetY]
                    };
                    
                    // Renderizar la página
                    page.render(renderContext).promise.then(function() {
                        resolve(canvas.toDataURL('image/png'));
                    });
                });
            }).catch(function(error) {
                console.log('Error cargando PDF desde URL de descarga:', error);
                // Fallback a preview genérico
                resolve(generateGenericDocumentPreview(contentUrl, 'PDF Document', canvas, ctx));
            });
        } else {
            // Para URLs directas de PDF, usar método original
            pdfjsLib.getDocument(contentUrl).promise.then(function(pdf) {
                // Renderizar la primera página
                pdf.getPage(1).then(function(page) {
                    const viewport = page.getViewport({ scale: 1 });
                    
                    // Calcular escala para ajustar al canvas
                    const scaleX = canvas.width / viewport.width;
                    const scaleY = canvas.height / viewport.height;
                    const scale = Math.min(scaleX, scaleY);
                    
                    const scaledViewport = page.getViewport({ scale: scale });
                    
                    // Centrar el contenido
                    const offsetX = (canvas.width - scaledViewport.width) / 2;
                    const offsetY = (canvas.height - scaledViewport.height) / 2;
                    
                    // Limpiar canvas con fondo blanco
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Configurar contexto para renderizado
                    const renderContext = {
                        canvasContext: ctx,
                        viewport: scaledViewport,
                        transform: [1, 0, 0, 1, offsetX, offsetY]
                    };
                    
                    // Renderizar la página
                    page.render(renderContext).promise.then(function() {
                        resolve(canvas.toDataURL('image/png'));
                    });
                });
            }).catch(function(error) {
                console.log('Error cargando PDF:', error);
                // Fallback a preview genérico
                resolve(generateGenericDocumentPreview(contentUrl, 'PDF Document', canvas, ctx));
            });
        }
    });
}

function generateGenericDocumentPreview(contentUrl, title, canvas, ctx) {
    // Detectar extensión del archivo desde la URL o el título
    let extension = 'default';
    
    if (contentUrl.includes('/api/coach/documents/')) {
        // Para URLs de descarga, intentar obtener extensión del título
        if (title) {
            const titleLower = title.toLowerCase();
            if (titleLower.includes('.pdf') || titleLower.endsWith('pdf')) extension = 'pdf';
            else if (titleLower.includes('.doc')) extension = titleLower.includes('.docx') ? 'docx' : 'doc';
            else if (titleLower.includes('.ppt')) extension = titleLower.includes('.pptx') ? 'pptx' : 'ppt';
            else if (titleLower.includes('.xls')) extension = titleLower.includes('.xlsx') ? 'xlsx' : 'xls';
            else if (titleLower.includes('.txt')) extension = 'txt';
        }
    } else {
        // Para URLs normales, obtener extensión de la URL
        extension = contentUrl.split('.').pop().toLowerCase();
    }
    
    // Colores y iconos por tipo de documento
    const documentTypes = {
        'pdf': { color: '#dc3545', gradient: '#ff6b6b', icon: '\uf1c1' }, // fa-file-pdf
        'doc': { color: '#0d6efd', gradient: '#4dabf7', icon: '\uf1c2' }, // fa-file-word
        'docx': { color: '#0d6efd', gradient: '#4dabf7', icon: '\uf1c2' },
        'ppt': { color: '#fd7e14', gradient: '#ffa726', icon: '\uf1c4' }, // fa-file-powerpoint
        'pptx': { color: '#fd7e14', gradient: '#ffa726', icon: '\uf1c4' },
        'xls': { color: '#198754', gradient: '#66bb6a', icon: '\uf1c3' }, // fa-file-excel
        'xlsx': { color: '#198754', gradient: '#66bb6a', icon: '\uf1c3' },
        'txt': { color: '#6c757d', gradient: '#90a4ae', icon: '\uf15c' }, // fa-file-text
        'default': { color: '#6c757d', gradient: '#90a4ae', icon: '\uf15b' } // fa-file
    };
    
    const docType = documentTypes[extension] || documentTypes.default;
    
    // Crear gradiente de fondo
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, docType.color);
    gradient.addColorStop(1, docType.gradient);
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Agregar icono (usando FontAwesome Unicode)
    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
    ctx.font = 'bold 48px "Font Awesome 6 Free"';
    ctx.textAlign = 'center';
    ctx.fillText(docType.icon, canvas.width / 2, canvas.height / 2 - 10);
    
    // Agregar título del documento
    ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
    ctx.font = 'bold 14px Arial';
    ctx.textAlign = 'center';
    
    // Truncar título si es muy largo
    let displayTitle = title;
    if (title.length > 25) {
        displayTitle = title.substring(0, 22) + '...';
    }
    
    ctx.fillText(displayTitle, canvas.width / 2, canvas.height / 2 + 35);
    
    // Agregar extensión del archivo
    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
    ctx.font = 'bold 12px Arial';
    ctx.fillText(extension.toUpperCase(), canvas.width / 2, canvas.height / 2 + 55);
    
    // Convertir canvas a data URL
    return canvas.toDataURL('image/png');
}

// Formatear tamaño de archivo
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Configurar formulario de subida de documentos
function setupDocumentUploadForm() {
    console.log('🔧 Configurando formulario de subida de documentos...');
    const form = document.getElementById('uploadDocumentForm');
    if (!form) {
        console.error('❌ Formulario uploadDocumentForm no encontrado');
        return;
    }
    
    // Verificar si ya tiene un event listener
    if (form.hasAttribute('data-listener-added')) {
        console.log('⚠️ Event listener ya agregado al formulario, saltando...');
        return;
    }
    
    console.log('✅ Formulario encontrado, agregando event listener...');
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('📤 Formulario de documento enviado');
        
        const fileInput = document.getElementById('documentFile');
        const coacheeSelect = document.getElementById('coacheeSelectDocuments');
        const titleInput = document.getElementById('documentTitle');
        const categorySelect = document.getElementById('documentCategory');
        
        // Debug: verificar elementos
        console.log('🔍 Verificando elementos del formulario:', {
            fileInput: !!fileInput,
            coacheeSelect: !!coacheeSelect,
            titleInput: !!titleInput,
            categorySelect: !!categorySelect
        });
        
        const file = fileInput?.files[0];
        const coacheeId = coacheeSelect?.value;
        const title = titleInput?.value;
        const category = categorySelect?.value;
        
        console.log('📋 Datos del formulario:', {
            file: file ? file.name : 'No file',
            coacheeId,
            title,
            category
        });
        
        if (!file) {
            alert('Por favor selecciona un archivo');
            return;
        }
        
        if (!coacheeId) {
            alert('Por favor selecciona un coachee');
            return;
        }
        
        if (!title) {
            alert('Por favor ingresa un título');
            return;
        }
        
        if (!category) {
            alert('Por favor selecciona una categoría');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('coachee_id', coacheeId);
        formData.append('title', title);
        formData.append('description', document.getElementById('documentDescription')?.value || '');
        formData.append('category', category);
        formData.append('priority', document.getElementById('documentPriority')?.value || 'normal');
        formData.append('notify_coachee', document.getElementById('notifyCoachee')?.checked || false);
        
        console.log('🚀 Enviando documento al servidor...');
        
        try {
            const response = await fetch('/api/coach/upload-document', {
                method: 'POST',
                credentials: 'include',
                body: formData
            });
            
            console.log('📡 Respuesta del servidor:', response.status, response.statusText);
            
            const result = await response.json();
            console.log('📄 Resultado JSON:', result);
            
            if (result.success) {
                alert('Documento subido exitosamente');
                form.reset();
                showDefaultPreview();
                updateDocumentStats();
            } else {
                alert(result.error || 'Error al subir el documento');
            }
        } catch (error) {
            console.error('❌ Error subiendo documento:', error);
            alert('Error de conexión al subir el documento');
        }
    });
    
    // Marcar el formulario como que ya tiene un event listener
    form.setAttribute('data-listener-added', 'true');
}

// Actualizar estadísticas de documentos
function updateDocumentStats() {
    fetch('/api/coach/document-stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('pdfCount').textContent = data.stats.pdf || 0;
                document.getElementById('imageCount').textContent = data.stats.images || 0;
                document.getElementById('docCount').textContent = data.stats.documents || 0;
            }
        })
        .catch(error => {
            console.error('Error actualizando estadísticas:', error);
        });
}

// Variable para controlar la inicialización
let documentModuleInitialized = false;

// Inicializar módulo de documentos
function initializeDocumentModule() {
    if (documentModuleInitialized) {
        console.log('⚠️ Módulo de documentos ya inicializado, saltando...');
        return;
    }
    
    console.log('🚀 Inicializando módulo de documentos...');
    
    // Verificar que los elementos necesarios existen
    const form = document.getElementById('uploadDocumentForm');
    const coacheeSelect = document.getElementById('coacheeSelectDocuments');
    
    console.log('🔍 Elementos encontrados:', {
        form: !!form,
        coacheeSelect: !!coacheeSelect
    });
    
    // Cargar coachees
    loadCoacheesForDocuments();
    
    // Configurar vista previa
    setupDocumentPreview();
    
    // Configurar formulario
    setupDocumentUploadForm();
    
    // Cargar estadísticas
    updateDocumentStats();
    
    // Marcar como inicializado
    documentModuleInitialized = true;
    
    console.log('✅ Módulo de documentos inicializado');
}

// ================================
// AGENDA Y CALENDARIO FUNCIONES
// ================================

// FullCalendar JS
const calendarScript = document.createElement('script');
calendarScript.src = 'https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js';
calendarScript.onload = function() {
    console.log('✅ FullCalendar cargado');
    initializeCalendar();
    setupTimeDropdowns();
};
document.head.appendChild(calendarScript);

let calendar = null;

function initializeCalendar() {
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) return;
    
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        height: 'auto',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        buttonText: {
            today: 'Hoy',
            month: 'Mes',
            week: 'Semana',
            day: 'Día'
        },
        events: function(fetchInfo, successCallback, failureCallback) {
            loadCalendarEvents(fetchInfo.startStr, fetchInfo.endStr, successCallback, failureCallback);
        },
        eventClick: function(info) {
            showSessionDetails(info.event);
        },
        selectable: true,
        selectMirror: true,
        select: function(selectionInfo) {
            // Cambiar a vista de día cuando se seleccione una fecha específica
            console.log('Selección de fecha:', selectionInfo);
            calendar.changeView('timeGridDay', selectionInfo.start);
            console.log('📅 Cambiando a vista de día para la fecha seleccionada');
        },
        // Callback cuando se cambia de vista
        viewDidMount: function(info) {
            console.log('📅 Vista del calendario montada:', info.view.type);
        },
        // Callback cuando los eventos se han renderizado
        eventsSet: function(events) {
            console.log('📅 Eventos renderizados en vista:', calendar.view.type);
        },
        // Permitir navegación con teclado
        navLinks: true,
        // Al hacer clic en un día en vista de mes, cambiar a vista de día
        dateClick: function(info) {
            console.log('📅 Clic en fecha:', info.dateStr);
            calendar.changeView('timeGridDay', info.date);
        },
        // Mejorar la experiencia visual
        dayMaxEvents: 3,
        moreLinkClick: function(info) {
            calendar.changeView('timeGridDay', info.date);
        }
    });
    
    calendar.render();
    console.log('📅 Calendario inicializado con navegación flexible de vistas');
}

function loadCalendarEvents(startDate, endDate, successCallback, failureCallback) {
    fetch(`/api/coach/sessions?start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const events = data.sessions.map(session => ({
                    id: session.id,
                    title: `${session.coachee_name} - ${session.title || 'Sesión'}`,
                    start: session.start,
                    end: session.end,
                    backgroundColor: getSessionColor(session.status),
                    borderColor: getSessionColor(session.status),
                    extendedProps: {
                        coachee_name: session.coachee_name,
                        status: session.status,
                        description: session.description,
                        location: session.location,
                        session_id: session.id
                    }
                }));
                successCallback(events);
                console.log('📅 Eventos cargados exitosamente:', events.length);
            } else {
                failureCallback(data.error);
            }
        })
        .catch(error => {
            console.error('Error cargando eventos del calendario:', error);
            failureCallback(error);
        });
}

// Función para permitir navegación libre entre vistas del calendario
function enableCalendarNavigation() {
    console.log('� Navegación libre de vistas habilitada');
    // Esta función reemplaza la restricción anterior de vista fija
    // Ahora el usuario puede navegar libremente entre mes, semana y día
}

// Agregar listener para cuando se cambia a la pestaña del calendario
function setupCalendarTabListener() {
    const calendarTab = document.getElementById('calendar-tab');
    if (calendarTab) {
        calendarTab.addEventListener('shown.bs.tab', function (e) {
            console.log('📅 Pestaña de calendario activada');
            setTimeout(() => {
                if (calendar) {
                    calendar.render();
                    console.log('📅 Calendario re-renderizado al activar pestaña');
                }
            }, 100);
        });
    }
}

function getSessionColor(status) {
    const colors = {
        'pending': '#ffc107',      // Amarillo - pendiente
        'confirmed': '#28a745',    // Verde - confirmada
        'proposed': '#17a2b8',     // Azul - propuesta
        'cancelled': '#dc3545',    // Rojo - cancelada
        'completed': '#6c757d'     // Gris - completada
    };
    return colors[status] || '#6c757d';
}

function showSessionDetails(event) {
    const props = event.extendedProps;
    
    const detailsHtml = `
        <div class="row g-3">
            <div class="col-12">
                <h6 class="text-primary">${props.coachee_name}</h6>
                <p class="mb-1"><strong>Fecha:</strong> ${event.startStr}</p>
                <p class="mb-1"><strong>Estado:</strong> 
                    <span class="badge" style="background-color: ${event.backgroundColor}">
                        ${getStatusText(props.status)}
                    </span>
                </p>
                ${props.description ? `<p class="mb-1"><strong>Descripción:</strong> ${props.description}</p>` : ''}
                ${props.location ? `<p class="mb-1"><strong>Ubicación:</strong> ${props.location}</p>` : ''}
            </div>
            <div class="col-12">
                <div class="d-flex gap-2">
                    <button class="btn btn-primary btn-sm" onclick="proposeReschedule(${props.session_id}, '${props.coachee_name}')">
                        <i class="fas fa-clock me-1"></i>Reagendar
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="cancelSession(${props.session_id})">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Mostrar en un modal o alert (simplificado)
    if (confirm(`Sesión con ${props.coachee_name}\n¿Deseas reagendar esta sesión?`)) {
        proposeReschedule(props.session_id, props.coachee_name);
    }
}

function getStatusText(status) {
    const statusTexts = {
        'pending': 'Pendiente',
        'confirmed': 'Confirmada',
        'proposed': 'Propuesta',
        'cancelled': 'Cancelada',
        'completed': 'Completada'
    };
    return statusTexts[status] || status;
}

// Gestión de disponibilidad
function loadAvailability() {
    fetch('/api/coach/availability')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayCurrentAvailability(data.availability);
            }
        })
        .catch(error => {
            console.error('Error cargando disponibilidad:', error);
        });
}

function displayCurrentAvailability(availability) {
    const container = document.getElementById('currentAvailability');
    if (!container) return;
    
    if (availability.length === 0) {
        container.innerHTML = '<p class="text-muted">No hay disponibilidad configurada</p>';
        return;
    }
    
    const dayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
    
    const html = availability.map(slot => `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="fw-medium">${dayNames[slot.day_of_week]}</span>
            <span class="text-muted">${slot.start_time} - ${slot.end_time}</span>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

// Formulario de disponibilidad
document.getElementById('availabilityForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const selectedDays = [];
    const checkboxes = document.querySelectorAll('#availabilityForm input[type="checkbox"]:checked');
    checkboxes.forEach(cb => selectedDays.push(parseInt(cb.value)));
    
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;
    
    if (selectedDays.length === 0) {
        showNotification('Selecciona al menos un día', 'error');
        return;
    }
    
    const availability = selectedDays.map(day => ({
        day_of_week: day,
        start_time: startTime,
        end_time: endTime
    }));
    
    fetch('/api/coach/availability', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ availability })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Disponibilidad actualizada correctamente', 'success');
            loadAvailability();
        } else {
            showNotification(data.error || 'Error actualizando disponibilidad', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error actualizando disponibilidad', 'error');
    });
});

// Función para configurar los dropdowns de tiempo con auto-completado
function setupTimeDropdowns() {
    console.log('🕐 Configurando dropdowns de tiempo para coach...');
    
    // Auto-completar en formulario de disponibilidad
    const startTimeAvailability = document.getElementById('startTime');
    const endTimeAvailability = document.getElementById('endTime');
    
    if (startTimeAvailability && endTimeAvailability) {
        startTimeAvailability.addEventListener('change', function() {
            const startTime = this.value;
            console.log('🕐 Hora de inicio de disponibilidad seleccionada:', startTime);
            
            if (startTime) {
                const [hours, minutes] = startTime.split(':').map(Number);
                let endHours = hours + 8; // 8 horas de trabajo por defecto
                
                // Asegurar que no exceda las 24:00
                if (endHours > 24) {
                    endHours = 24;
                }
                
                const endTime = `${String(endHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                endTimeAvailability.value = endTime;
                console.log('🕐 Hora de fin de disponibilidad auto-completada:', endTime);
            }
        });
    }
    
    // Auto-completar en modal de propuesta
    const startTimeProposal = document.getElementById('proposedStartTime');
    const endTimeProposal = document.getElementById('proposedEndTime');
    
    if (startTimeProposal && endTimeProposal) {
        startTimeProposal.addEventListener('change', function() {
            const startTime = this.value;
            console.log('🕐 Hora de inicio de propuesta seleccionada:', startTime);
            
            if (startTime) {
                const [hours, minutes] = startTime.split(':').map(Number);
                let endHours = hours + 1; // 1 hora por defecto para sesiones
                
                // Asegurar que no exceda las 24:00
                if (endHours > 24) {
                    endHours = 24;
                }
                
                const endTime = `${String(endHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                endTimeProposal.value = endTime;
                console.log('🕐 Hora de fin de propuesta auto-completada:', endTime);
            }
        });
    }
    
    console.log('✅ Dropdowns de tiempo del coach configurados');
}

// Cargar solicitudes pendientes
function loadSessionRequests() {
    fetch('/api/coach/session-requests')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySessionRequests(data.requests);
                updateRequestsCount(data.requests.length);
            }
        })
        .catch(error => {
            console.error('Error cargando solicitudes:', error);
        });
}

function displaySessionRequests(requests) {
    const container = document.getElementById('sessionRequests');
    if (!container) return;
    
    if (requests.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <p class="text-muted">No hay solicitudes pendientes</p>
            </div>
        `;
        return;
    }
    
    const html = requests.map(request => `
        <div class="card mb-3">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h6 class="mb-1">${request.coachee_name}</h6>
                        <p class="mb-1">
                            <i class="fas fa-calendar me-1"></i>
                            ${new Date(request.session_date + 'T12:00:00').toLocaleDateString('es-ES')} 
                            a las ${request.start_time}
                        </p>
                        ${request.description ? `<p class="mb-0 text-muted">${request.description}</p>` : ''}
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-success btn-sm me-1" onclick="respondToRequest(${request.id}, 'confirm')">
                            <i class="fas fa-check me-1"></i>Confirmar
                        </button>
                        <button class="btn btn-warning btn-sm me-1" onclick="proposeAlternative(${request.id}, '${request.coachee_name}')">
                            <i class="fas fa-clock me-1"></i>Proponer
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="respondToRequest(${request.id}, 'reject')">
                            <i class="fas fa-times me-1"></i>Rechazar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

function updateRequestsCount(count) {
    const badge = document.getElementById('requestsCount');
    if (badge) {
        if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    }
}

function respondToRequest(sessionId, action) {
    const actionText = action === 'confirm' ? 'confirmada' : 'rechazada';
    
    if (!confirm(`¿Estás seguro de que quieres ${actionText === 'confirmada' ? 'confirmar' : 'rechazar'} esta solicitud?`)) {
        return;
    }
    
    fetch('/api/coach/session-requests', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            session_id: sessionId,
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`Solicitud ${actionText} correctamente`, 'success');
            loadSessionRequests();
            if (calendar) {
                // Actualizar eventos manteniendo la vista actual
                calendar.refetchEvents();
                console.log('📅 Eventos actualizados después de confirmar solicitud');
            }
        } else {
            showNotification(data.error || 'Error procesando solicitud', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error procesando solicitud', 'error');
    });
}

function proposeAlternative(sessionId, coacheeName) {
    document.getElementById('originalSessionId').value = sessionId;
    document.getElementById('proposeCoacheeName').textContent = coacheeName;
    
    // Configurar fecha mínima (mañana en zona horaria de Santiago)
    document.getElementById('proposedDate').min = getSantiagoTomorrow();
    console.log('📅 Fecha mínima propuesta configurada (Santiago):', getSantiagoTomorrow());
    
    const modal = new bootstrap.Modal(document.getElementById('proposeTimeModal'));
    modal.show();
}

function proposeReschedule(sessionId, coacheeName) {
    proposeAlternative(sessionId, coacheeName);
}

function cancelSession(sessionId) {
    if (!confirm('¿Estás seguro de que quieres cancelar esta sesión?')) {
        return;
    }
    
    fetch(`/api/coach/session/${sessionId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Sesión cancelada correctamente', 'success');
            if (calendar) {
                // Actualizar eventos manteniendo la vista actual
                calendar.refetchEvents();
            }
        } else {
            showNotification(data.error || 'Error cancelando sesión', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error cancelando sesión', 'error');
    });
}

function submitTimeProposal() {
    const sessionId = document.getElementById('originalSessionId').value;
    const proposedDate = document.getElementById('proposedDate').value;
    const proposedStartTime = document.getElementById('proposedStartTime').value;
    const proposedEndTime = document.getElementById('proposedEndTime').value;
    const message = document.getElementById('proposalMessage').value;
    
    if (!proposedDate || !proposedStartTime || !proposedEndTime) {
        showNotification('Completa todos los campos requeridos', 'error');
        return;
    }
    
    fetch('/api/coach/session-requests', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            session_id: sessionId,
            action: 'propose',
            proposed_date: proposedDate,
            proposed_start_time: proposedStartTime,
            proposed_end_time: proposedEndTime,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Propuesta enviada correctamente', 'success');
            bootstrap.Modal.getInstance(document.getElementById('proposeTimeModal')).hide();
            loadSessionRequests();
            if (calendar) {
                // Actualizar eventos manteniendo la vista actual
                calendar.refetchEvents();
            }
        } else {
            showNotification(data.error || 'Error enviando propuesta', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error enviando propuesta', 'error');
    });
}

// Inicializar agenda cuando se muestra el módulo
function initializeAgenda() {
    console.log('🗓️ Inicializando agenda del coach');
    loadAvailability();
    loadSessionRequests();
    
    // Configurar listener para cambios de pestaña
    setupCalendarTabListener();
    
    if (calendar) {
        // Re-renderizar manteniendo la vista actual
        calendar.render();
        calendar.refetchEvents();
        console.log('📅 Calendario re-renderizado con navegación libre');
    } else if (typeof FullCalendar !== 'undefined') {
        initializeCalendar();
        // Configurar listener después de inicializar
        setTimeout(setupCalendarTabListener, 500);
    }
}

// Modificar showModule para incluir inicialización de agenda
const originalShowModule = window.showModule;
window.showModule = function(moduleId) {
    originalShowModule(moduleId);
    
    if (moduleId === 'agenda') {
        setTimeout(initializeAgenda, 100); // Pequeño delay para asegurar que el DOM esté listo
    }
};

// Función para obtener fecha/hora en zona horaria de Santiago
function getSantiagoDateTime() {
    const now = new Date();
    // Santiago de Chile: GMT-3 (horario de verano) o GMT-4 (horario estándar)
    // Usar Intl.DateTimeFormat para obtener la hora local correcta
    const santiagoTime = new Date(now.toLocaleString("en-US", {timeZone: "America/Santiago"}));
    return santiagoTime;
}

function getSantiagoDate() {
    const santiagoTime = getSantiagoDateTime();
    return santiagoTime.toISOString().split('T')[0];
}

function getSantiagoTomorrow() {
    const santiagoTime = getSantiagoDateTime();
    santiagoTime.setDate(santiagoTime.getDate() + 1);
    return santiagoTime.toISOString().split('T')[0];
}

// ========== FUNCIONES PARA GESTIÓN DE CITAS ==========

// Función para limpiar formulario de autoagenda
function clearSelfScheduleForm() {
    document.getElementById('selfScheduleForm').reset();
    
    // Establecer fecha de hoy como predeterminada
    const today = getSantiagoDate();
    document.getElementById('selfDate').value = today;
}

// Función para limpiar formulario de cita directa
function clearDirectAppointmentForm() {
    document.getElementById('directAppointmentForm').reset();
    
    // Establecer fecha de mañana como predeterminada
    const tomorrow = getSantiagoTomorrow();
    document.getElementById('directDate').value = tomorrow;
    
    // Recargar lista de coachees
    loadCoacheesForDirectAppointment();
}

// Función para cargar coachees en el select de cita directa
async function loadCoacheesForDirectAppointment() {
    console.log('🔄 Cargando coachees para cita directa...');
    try {
        const response = await fetch('/api/coach/my-coachees', {
            credentials: 'include'
        });
        console.log('📡 Response status:', response.status);
        const data = await response.json();
        console.log('📊 Datos recibidos:', data);
        
        const select = document.getElementById('directCoacheeSelect');
        select.innerHTML = '<option value="">Seleccionar coachee...</option>';
        
        if (data.success && data.coachees) {
            console.log(`✅ Encontrados ${data.coachees.length} coachees`);
            data.coachees.forEach(coachee => {
                const option = document.createElement('option');
                option.value = coachee.id;
                option.textContent = `${coachee.name} (${coachee.email})`;
                select.appendChild(option);
            });
        } else {
            console.log('❌ No se encontraron coachees o error en respuesta');
        }
    } catch (error) {
        console.error('❌ Error cargando coachees:', error);
        const select = document.getElementById('directCoacheeSelect');
        select.innerHTML = '<option value="">Error cargando coachees</option>';
    }
}

// Función para manejar envío de autoagenda
async function handleSelfScheduleSubmit(event) {
    event.preventDefault();
    
    const formData = {
        title: document.getElementById('selfActivityTitle').value,
        type: document.getElementById('selfActivityType').value,
        date: document.getElementById('selfDate').value,
        start_time: document.getElementById('selfStartTime').value,
        end_time: document.getElementById('selfEndTime').value,
        description: document.getElementById('selfDescription').value,
        recurring: document.getElementById('selfRecurring').checked
    };
    
    // Validar que la hora de fin sea después de la hora de inicio
    if (formData.start_time >= formData.end_time) {
        alert('La hora de fin debe ser posterior a la hora de inicio');
        return;
    }
    
    try {
        const response = await fetch('/api/coach/self-schedule', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Tiempo bloqueado exitosamente');
            clearSelfScheduleForm();
            loadSelfScheduledActivities();
            
            // Refrescar calendario si está visible
            if (typeof calendar !== 'undefined' && calendar) {
                calendar.refetchEvents();
            }
        } else {
            alert(result.message || 'Error al bloquear tiempo');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error de conexión al bloquear tiempo');
    }
}

// Función para manejar envío de cita directa
console.log('🔧 SCRIPT LOADED: handleDirectAppointmentSubmit function defined');

async function handleDirectAppointmentSubmit(event) {
    event.preventDefault();
    console.log('🚀 handleDirectAppointmentSubmit iniciado');
    console.log('🎯 Event received:', event);
    console.log('🎯 Event target:', event.target);
    
    const formData = {
        coachee_id: document.getElementById('directCoacheeSelect').value,
        session_type: document.getElementById('directSessionType').value,
        date: document.getElementById('directDate').value,
        start_time: document.getElementById('directStartTime').value,
        end_time: document.getElementById('directEndTime').value,
        session_notes: document.getElementById('directSessionNotes').value,
        notification_message: document.getElementById('directNotificationMessage').value,
        send_notification: document.getElementById('directSendNotification').checked
    };
    
    console.log('📝 Datos del formulario:', formData);
    
    // Validaciones
    if (!formData.coachee_id) {
        console.log('❌ Error: No hay coachee seleccionado');
        alert('Debes seleccionar un coachee');
        return;
    }
    
    if (formData.start_time >= formData.end_time) {
        console.log('❌ Error: Hora de fin debe ser posterior a hora de inicio');
        alert('La hora de fin debe ser posterior a la hora de inicio');
        return;
    }
    
    try {
        console.log('📡 Enviando solicitud de cita directa...');
        const response = await fetch('/api/coach/create-direct-appointment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(formData)
        });
        
        console.log('📨 Response status:', response.status);
        const result = await response.json();
        console.log('📊 Response data:', result);
        
        if (response.ok && result.success) {
            console.log('✅ Cita directa creada exitosamente');
            alert('Cita directa creada exitosamente');
            clearDirectAppointmentForm();
            loadDirectAppointments();
            
            // Refrescar calendario si está visible
            if (typeof calendar !== 'undefined' && calendar) {
                calendar.refetchEvents();
            }
        } else {
            console.log('❌ Error en respuesta - result.error:', result.error);
            console.log('❌ Error en respuesta - result.message:', result.message);
            const errorMessage = result.error || result.message || 'Error al crear cita directa';
            console.log('❌ Mensaje final a mostrar:', errorMessage);
            alert(errorMessage);
        }
    } catch (error) {
        console.error('❌ Error en handleDirectAppointmentSubmit:', error);
        alert('Error de conexión al crear cita directa');
    }
}

// Función para cargar actividades autoagendadas
async function loadSelfScheduledActivities() {
    try {
        const response = await fetch('/api/coach/self-scheduled-activities', {
            credentials: 'include'
        });
        const data = await response.json();
        
        const container = document.getElementById('selfScheduledList');
        
        if (data.success && data.activities && data.activities.length > 0) {
            container.innerHTML = data.activities.map(activity => `
                <div class="border rounded p-3 mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">
                                <i class="fas fa-${getActivityIcon(activity.type)} me-2 text-${getActivityColor(activity.type)}"></i>
                                ${activity.title}
                            </h6>
                            <p class="text-muted small mb-1">
                                <i class="fas fa-calendar me-1"></i>${formatDate(activity.date)}
                                <i class="fas fa-clock ms-2 me-1"></i>${activity.start_time} - ${activity.end_time}
                            </p>
                            ${activity.description ? `<p class="text-muted small mb-0">${activity.description}</p>` : ''}
                            ${activity.recurring ? '<span class="badge bg-info"><i class="fas fa-repeat me-1"></i>Recurrente</span>' : ''}
                        </div>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteSelfScheduledActivity(${activity.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<p class="text-muted text-center">No hay tiempo bloqueado próximo</p>';
        }
    } catch (error) {
        console.error('Error cargando actividades:', error);
        document.getElementById('selfScheduledList').innerHTML = 
            '<p class="text-danger text-center">Error cargando actividades</p>';
    }
}

// Función para cargar citas directas
async function loadDirectAppointments() {
    try {
        const response = await fetch('/api/coach/direct-appointments', {
            credentials: 'include'
        });
        const data = await response.json();
        
        const container = document.getElementById('directAppointmentsList');
        
        if (data.success && data.appointments && data.appointments.length > 0) {
            container.innerHTML = data.appointments.map(appointment => `
                <div class="border rounded p-3 mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">
                                <i class="fas fa-user me-2 text-primary"></i>
                                ${appointment.coachee_name}
                            </h6>
                            <p class="text-muted small mb-1">
                                <i class="fas fa-calendar me-1"></i>${formatDate(appointment.date)}
                                <i class="fas fa-clock ms-2 me-1"></i>${appointment.start_time} - ${appointment.end_time}
                            </p>
                            <p class="text-muted small mb-1">
                                <i class="fas fa-tag me-1"></i>${getSessionTypeLabel(appointment.session_type)}
                            </p>
                            ${appointment.session_notes ? `<p class="text-muted small mb-0">${appointment.session_notes}</p>` : ''}
                            <span class="badge bg-${getStatusColor(appointment.status)}">${getStatusLabel(appointment.status)}</span>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">Creada ${formatDateTime(appointment.created_at)}</small>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<p class="text-muted text-center">No hay citas directas recientes</p>';
        }
    } catch (error) {
        console.error('Error cargando citas directas:', error);
        document.getElementById('directAppointmentsList').innerHTML = 
            '<p class="text-danger text-center">Error cargando citas directas</p>';
    }
}

// Funciones auxiliares para formateo
function getActivityIcon(type) {
    const icons = {
        'preparation': 'book',
        'admin': 'cog',
        'break': 'coffee',
        'training': 'graduation-cap',
        'meeting': 'users',
        'personal': 'user',
        'other': 'circle'
    };
    return icons[type] || 'circle';
}

function getActivityColor(type) {
    const colors = {
        'preparation': 'primary',
        'admin': 'secondary',
        'break': 'success',
        'training': 'info',
        'meeting': 'warning',
        'personal': 'dark',
        'other': 'muted'
    };
    return colors[type] || 'muted';
}

function getSessionTypeLabel(type) {
    const labels = {
        'coaching': 'Sesión de Coaching',
        'follow-up': 'Seguimiento',
        'evaluation': 'Evaluación de Progreso',
        'planning': 'Planificación de Objetivos',
        'feedback': 'Retroalimentación',
        'support': 'Sesión de Apoyo',
        'other': 'Otra'
    };
    return labels[type] || type;
}

function getStatusColor(status) {
    const colors = {
        'pending': 'warning',
        'confirmed': 'success',
        'cancelled': 'danger',
        'completed': 'info'
    };
    return colors[status] || 'secondary';
}

function getStatusLabel(status) {
    const labels = {
        'pending': 'Pendiente',
        'confirmed': 'Confirmada',
        'cancelled': 'Cancelada',
        'completed': 'Completada'
    };
    return labels[status] || status;
}

function formatDate(dateString) {
    // Crear fecha asumiendo que viene en UTC desde el backend
    const date = new Date(dateString + (dateString.includes('Z') ? '' : 'Z'));
    
    return date.toLocaleDateString('es-CL', { 
        timeZone: 'America/Santiago',
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
}

function formatDateTime(dateTimeString) {
    // Crear fecha asumiendo que viene en UTC desde el backend
    const date = new Date(dateTimeString + (dateTimeString.includes('Z') ? '' : 'Z'));
    
    return date.toLocaleString('es-CL', {
        timeZone: 'America/Santiago',
        hour12: false
    });
}

// Función para eliminar actividad autoagendada
async function deleteSelfScheduledActivity(activityId) {
    if (!confirm('¿Estás seguro de que quieres eliminar esta actividad bloqueada?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/coach/self-scheduled-activity/${activityId}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Actividad eliminada exitosamente');
            loadSelfScheduledActivities();
            
            // Refrescar calendario si está visible
            if (typeof calendar !== 'undefined' && calendar) {
                calendar.refetchEvents();
            }
        } else {
            alert(result.message || 'Error al eliminar actividad');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error de conexión al eliminar actividad');
    }
}

// Configurar listeners para los formularios de gestión de citas
function setupAppointmentManagementListeners() {
    // Listener para autoagenda
    const selfScheduleForm = document.getElementById('selfScheduleForm');
    if (selfScheduleForm) {
        console.log('✅ Event listener conectado para selfScheduleForm');
        selfScheduleForm.addEventListener('submit', handleSelfScheduleSubmit);
    } else {
        console.log('❌ No se encontró selfScheduleForm');
    }
    
    // Listener para cita directa
    const directAppointmentForm = document.getElementById('directAppointmentForm');
    if (directAppointmentForm) {
        console.log('✅ Event listener conectado para directAppointmentForm');
        directAppointmentForm.addEventListener('submit', handleDirectAppointmentSubmit);
    } else {
        console.log('❌ No se encontró directAppointmentForm');
    }
    
    // Configurar fechas por defecto
    const today = getSantiagoDate();
    const tomorrow = getSantiagoTomorrow();
    
    const selfDateInput = document.getElementById('selfDate');
    if (selfDateInput) {
        selfDateInput.value = today;
        selfDateInput.min = today; // No permitir fechas pasadas
    }
    
    const directDateInput = document.getElementById('directDate');
    if (directDateInput) {
        directDateInput.value = tomorrow;
        directDateInput.min = today; // No permitir fechas pasadas
    }
    
    // Cargar datos iniciales
    loadCoacheesForDirectAppointment();
    loadSelfScheduledActivities();
    loadDirectAppointments();
    
    // DEBUGGING: Verificar que el formulario esté disponible
    setTimeout(() => {
        const testForm = document.getElementById('directAppointmentForm');
        if (testForm) {
            console.log('✅ DEBUGGING: directAppointmentForm encontrado correctamente');
            console.log('📋 DEBUGGING: Formulario tiene elementos:', testForm.elements.length);
        } else {
            console.log('❌ DEBUGGING: directAppointmentForm NO encontrado');
        }
    }, 1000);
}

// Cache buster - Forzar recarga: 2025-10-18-21:52
console.log('🔄 Coach Dashboard: 2025-10-18-21:52 - DEBUGGING CREAR CITA DIRECTA');
console.log('🇨🇱 Hora actual Santiago:', getSantiagoDateTime().toLocaleString('es-CL'));
console.log('🔧 IMPORTANTE: Revisa los logs de debug cuando hagas clic en "Crear Cita Directa"');

// ==========================================
// FUNCIONES PARA CREAR/CARGAR EVALUACIONES
// ==========================================

// Activar el botón de carga cuando se selecciona un archivo
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('evaluationFile');
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const uploadBtn = document.getElementById('uploadBtn');
            const filePreview = document.getElementById('filePreview');
            
            if (e.target.files.length > 0) {
                uploadBtn.disabled = false;
                
                // Mostrar preview básico
                const file = e.target.files[0];
                const previewContent = document.getElementById('previewContent');
                previewContent.innerHTML = `
                    <p class="mb-1"><strong>Archivo seleccionado:</strong> ${file.name}</p>
                    <p class="mb-1"><strong>Tamaño:</strong> ${(file.size / 1024).toFixed(2)} KB</p>
                    <p class="mb-0"><strong>Tipo:</strong> ${file.type || 'No especificado'}</p>
                `;
                filePreview.style.display = 'block';
            } else {
                uploadBtn.disabled = true;
                filePreview.style.display = 'none';
            }
        });
    }
});

// Función para cancelar la carga
function cancelUpload() {
    const fileInput = document.getElementById('evaluationFile');
    const uploadBtn = document.getElementById('uploadBtn');
    const filePreview = document.getElementById('filePreview');
    const uploadResult = document.getElementById('uploadResult');
    
    fileInput.value = '';
    uploadBtn.disabled = true;
    filePreview.style.display = 'none';
    uploadResult.style.display = 'none';
}

// Función para cargar la evaluación
function uploadEvaluation() {
    const fileInput = document.getElementById('evaluationFile');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Por favor selecciona un archivo');
        return;
    }
    
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadResult = document.getElementById('uploadResult');
    const uploadBtn = document.getElementById('uploadBtn');
    
    // Mostrar barra de progreso
    uploadProgress.style.display = 'block';
    uploadResult.style.display = 'none';
    uploadBtn.disabled = true;
    
    // Crear FormData
    const formData = new FormData();
    formData.append('evaluation_file', file);
    
    // Simular progreso (en una implementación real, usarías XMLHttpRequest para progreso real)
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 10;
        document.getElementById('uploadProgressBar').style.width = progress + '%';
        document.getElementById('uploadPercent').textContent = progress + '%';
        
        if (progress >= 90) {
            clearInterval(progressInterval);
        }
    }, 200);
    
    // Enviar el archivo al servidor
    fetch('/api/coach/upload-evaluation', {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'
    })
        .then(response => response.json())
        .then(data => {
            clearInterval(progressInterval);
            document.getElementById('uploadProgressBar').style.width = '100%';
            document.getElementById('uploadPercent').textContent = '100%';
            
            setTimeout(() => {
                uploadProgress.style.display = 'none';
                
                if (data.success) {
                    uploadResult.innerHTML = `
                        <div class="alert alert-success">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>¡Evaluación cargada exitosamente!</strong>
                            </div>
                            <p class="mb-2 small">${data.message || 'La evaluación se agregó a "Evaluaciones Disponibles"'}</p>
                            <button class="btn btn-sm btn-success" onclick="showModule('seleccionar-evaluaciones')">
                                <i class="fas fa-clipboard-list me-1"></i>Ver Evaluaciones Disponibles
                            </button>
                        </div>
                    `;
                    
                    // Limpiar el formulario
                    setTimeout(() => {
                        cancelUpload();
                    }, 3000);
                } else {
                    uploadResult.innerHTML = `
                        <div class="alert alert-danger">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Error al cargar la evaluación</strong>
                            </div>
                            <p class="mb-2 small">${data.error || 'Ocurrió un error al procesar el archivo'}</p>
                            <button class="btn btn-sm btn-danger" onclick="cancelUpload()">
                                <i class="fas fa-redo me-1"></i>Intentar nuevamente
                            </button>
                        </div>
                    `;
                }
                
                uploadResult.style.display = 'block';
                uploadBtn.disabled = false;
            }, 500);
        })
        .catch(error => {
            clearInterval(progressInterval);
            console.error('Error al cargar evaluación:', error);
            
            uploadProgress.style.display = 'none';
            uploadResult.innerHTML = `
                <div class="alert alert-danger">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Error de conexión</strong>
                    </div>
                    <p class="mb-2 small">No se pudo conectar con el servidor. Por favor intenta nuevamente.</p>
                    <button class="btn btn-sm btn-danger" onclick="cancelUpload()">
                        <i class="fas fa-redo me-1"></i>Intentar nuevamente
                    </button>
                </div>
            `;
            uploadResult.style.display = 'block';
            uploadBtn.disabled = false;
        });
}

// Función para descargar plantilla de ejemplo
function downloadEvaluationTemplate() {
    // Crear una plantilla de ejemplo en formato JSON
    const template = {
        "titulo": "Ejemplo de Evaluación",
        "descripcion": "Esta es una evaluación de ejemplo",
        "categoria": "Personalidad",
        "preguntas": [
            {
                "pregunta": "¿Cuál es tu estilo de liderazgo?",
                "opciones": [
                    "Directivo",
                    "Participativo",
                    "Delegativo",
                    "Transformacional"
                ],
                "respuesta_correcta": 1,
                "puntos": 10
            },
            {
                "pregunta": "¿Cómo manejas el estrés?",
                "opciones": [
                    "Evitándolo",
                    "Afrontándolo directamente",
                    "Buscando apoyo",
                    "Planificando con anticipación"
                ],
                "respuesta_correcta": 3,
                "puntos": 10
            }
        ]
    };
    
    // Convertir a JSON y crear un blob
    const jsonString = JSON.stringify(template, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    
    // Crear un enlace de descarga
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'plantilla_evaluacion.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    console.log('✅ Plantilla de evaluación descargada');
}

// ==========================================
// FIN DEL ARCHIVO
// ==========================================

// Inicializar cuando el DOM esté listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🎨 DOM listo...');
        createParticles(); // Initialize particles
    });
} else {
    console.log('🎨 DOM ya listo...');
    createParticles(); // Initialize particles
}

</script>

    <!-- Bottom Navigation - Estilo LinkedIn -->
    <nav class="bottom-navigation">
        <a href="/coach-feed" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        
        <a href="/coach-comunidad" class="nav-item">
            <i class="fas fa-users"></i>
            <span>Comunidad</span>
        </a>
        
        <a href="/coach-dashboard" class="nav-item active">
            <i class="fas fa-chart-line"></i>
            <span>Dashboard</span>
        </a>
        
        <button class="nav-item" onclick="confirmLogoutFromCoachDashboard()">
            <i class="fas fa-sign-out-alt"></i>
            <span>Salir</span>
        </button>
    </nav>

    <script>
        // Función para confirmar logout desde coach dashboard
        function confirmLogoutFromCoachDashboard() {
            if (confirm('¿Estás seguro que deseas salir?')) {
                window.location.href = '/coach-login';
            }
        }
    </script>

</body>
</html>
