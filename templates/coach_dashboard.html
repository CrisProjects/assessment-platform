{% extends "base.html" %}

{% block title %}Dashboard Coach - Assessment Platform{% endblock %}

{% block content %}
<!-- Header Navigation -->
<nav class="glass-card p-3 mb-4 fade-in">
    <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <div class="rounded-circle d-inline-flex align-items-center justify-content-center me-3" 
                 style="width: 50px; height: 50px; background: var(--gradient-button);">
                <i class="fas fa-user-tie text-white fs-4"></i>
            </div>
            <div>
                <h4 class="text-gradient fw-bold mb-0">Dashboard Coach</h4>
                <p class="text-white-50 mb-0 small">Gestiona y supervisa tus coachees</p>
            </div>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-light btn-sm" onclick="window.location.href='/dashboard-selection'">
                <i class="fas fa-home me-1"></i>Inicio
            </button>
            <button class="btn btn-outline-light btn-sm" onclick="window.location.href='/logout'">
                <i class="fas fa-sign-out-alt me-1"></i>Cerrar Sesión
            </button>
        </div>
    </div>
</nav>

<!-- Main Dashboard Content -->
<div class="container-fluid">
    <!-- Statistics Cards -->
    <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="glass-card p-4 text-center fade-in">
                <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                     style="width: 60px; height: 60px; background: linear-gradient(135deg, var(--havelock-blue), #4A90E2);">
                    <i class="fas fa-users text-white fs-3"></i>
                </div>
                <h3 class="text-gradient fw-bold mb-1" id="totalCoachees">0</h3>
                <p class="text-white-50 mb-0">Total Coachees</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="glass-card p-4 text-center fade-in">
                <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                     style="width: 60px; height: 60px; background: linear-gradient(135deg, #10B981, #059669);">
                    <i class="fas fa-check-circle text-white fs-3"></i>
                </div>
                <h3 class="text-gradient fw-bold mb-1" id="completedAssessments">0</h3>
                <p class="text-white-50 mb-0">Evaluaciones Completadas</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="glass-card p-4 text-center fade-in">
                <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                     style="width: 60px; height: 60px; background: linear-gradient(135deg, #F59E0B, #D97706);">
                    <i class="fas fa-clock text-white fs-3"></i>
                </div>
                <h3 class="text-gradient fw-bold mb-1" id="pendingAssessments">0</h3>
                <p class="text-white-50 mb-0">Evaluaciones Pendientes</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="glass-card p-4 text-center fade-in">
                <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                     style="width: 60px; height: 60px; background: linear-gradient(135deg, #8B5CF6, #7C3AED);">
                    <i class="fas fa-chart-line text-white fs-3"></i>
                </div>
                <h3 class="text-gradient fw-bold mb-1" id="avgScore">0%</h3>
                <p class="text-white-50 mb-0">Puntuación Promedio</p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Mis Coachees -->
        <div class="col-12 mb-4">
            <div class="glass-card p-4 fade-in">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="text-gradient fw-bold mb-0">
                        <i class="fas fa-users me-2"></i>Mis Coachees
                    </h3>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success interactive-element" onclick="openInvitationModal()">
                            <i class="fas fa-envelope me-2"></i>Invitar Coachee
                        </button>
                        <button class="btn btn-primary interactive-element" onclick="loadCoachees()">
                            <i class="fas fa-refresh me-2"></i>Actualizar
                        </button>
                    </div>
                </div>
                <div id="coacheesContainer" class="row">
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando coachees...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gestión de Tareas -->
        <div class="col-12 mb-4">
            <div class="glass-card p-4 fade-in">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="text-gradient fw-bold mb-0">
                        <i class="fas fa-tasks me-2"></i>Gestión de Tareas
                    </h3>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success interactive-element" onclick="openTaskModal()">
                            <i class="fas fa-plus me-2"></i>Nueva Tarea
                        </button>
                        <button class="btn btn-primary interactive-element" onclick="loadTasks()">
                            <i class="fas fa-refresh me-2"></i>Actualizar
                        </button>
                    </div>
                </div>
                <div id="tasksContainer" class="row">
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando tareas...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1055;">
    <!-- Toasts will be inserted here -->
</div>

<!-- Modal de invitación de coachee -->
<div class="modal fade" id="invitationModal" tabindex="-1" aria-labelledby="invitationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content glass-card border-0">
            <div class="modal-header border-0">
                <h5 class="modal-title text-gradient fw-bold" id="invitationModalLabel">
                    <i class="fas fa-envelope me-2"></i>Invitar Coachee
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="invitationForm">
                    <div class="mb-3">
                        <label for="inviteEmail" class="form-label text-white">Correo electrónico del coachee</label>
                        <input type="email" class="form-control glass-input" id="inviteEmail" 
                               placeholder="coachee@email.com" required>
                    </div>
                    <div class="mb-3">
                        <label for="inviteFullName" class="form-label text-white">Nombre completo</label>
                        <input type="text" class="form-control glass-input" id="inviteFullName" 
                               placeholder="Nombre del coachee" required>
                    </div>
                    <div class="mb-3">
                        <label for="inviteMessage" class="form-label text-white">Mensaje personalizado (opcional)</label>
                        <textarea class="form-control glass-input" id="inviteMessage" rows="3" 
                                  placeholder="Escribe un mensaje de bienvenida para tu coachee..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-success w-100 interactive-element">
                        <i class="fas fa-paper-plane me-2"></i>Enviar Invitación
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear nueva tarea -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content glass-card border-0">
            <div class="modal-header border-0">
                <h5 class="modal-title text-gradient fw-bold" id="taskModalLabel">
                    <i class="fas fa-plus me-2"></i>Nueva Tarea
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="taskCoachee" class="form-label text-white">Asignar a Coachee</label>
                            <select class="form-select glass-input" id="taskCoachee" required>
                                <option value="">Selecciona un coachee...</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="taskCategory" class="form-label text-white">Categoría</label>
                            <select class="form-select glass-input" id="taskCategory" required>
                                <option value="">Selecciona categoría...</option>
                                <option value="comunicacion">Comunicación Asertiva</option>
                                <option value="derechos">Defensa de Derechos</option>
                                <option value="opiniones">Expresión de Opiniones</option>
                                <option value="conflictos">Manejo de Conflictos</option>
                                <option value="autoconfianza">Autoconfianza</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="taskPriority" class="form-label text-white">Prioridad</label>
                            <select class="form-select glass-input" id="taskPriority" required>
                                <option value="low">Baja</option>
                                <option value="medium" selected>Media</option>
                                <option value="high">Alta</option>
                                <option value="urgent">Urgente</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="taskDueDate" class="form-label text-white">Fecha límite (opcional)</label>
                            <input type="date" class="form-control glass-input" id="taskDueDate">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="taskTitle" class="form-label text-white">Título de la tarea</label>
                        <input type="text" class="form-control glass-input" id="taskTitle" 
                               placeholder="Ej: Practicar expresión de opiniones en reuniones" required>
                    </div>
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label text-white">Descripción detallada</label>
                        <textarea class="form-control glass-input" id="taskDescription" rows="4" 
                                  placeholder="Describe la tarea, objetivos y pasos a seguir..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-success w-100 interactive-element">
                        <i class="fas fa-plus me-2"></i>Crear Tarea
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% block extra_css %}
<style>
    .glass-input {
        background: rgba(255, 255, 255, 0.15) !important;
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
        color: white !important;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
    }
    
    .glass-input::placeholder {
        color: rgba(255, 255, 255, 0.7) !important;
    }
    
    .glass-input:focus {
        background: rgba(255, 255, 255, 0.25) !important;
        border-color: var(--havelock-blue) !important;
        box-shadow: 0 0 0 0.2rem rgba(98, 130, 227, 0.25) !important;
        color: white !important;
        outline: none !important;
    }
    
    .glass-input:hover {
        background: rgba(255, 255, 255, 0.2) !important;
        border-color: rgba(255, 255, 255, 0.4) !important;
    }
    
    .form-select.glass-input {
        cursor: pointer;
    }
    
    .form-select.glass-input option {
        background: var(--cloud-burst) !important;
        color: white !important;
        padding: 8px 12px;
    }
    
    /* Asegurar que los inputs sean completamente interactivos */
    .modal-body input,
    .modal-body textarea,
    .modal-body select {
        position: relative !important;
        z-index: 9999 !important;
        pointer-events: auto !important;
        -webkit-user-select: text !important;
        -moz-user-select: text !important;
        -ms-user-select: text !important;
        user-select: text !important;
        cursor: text !important;
    }
    
    .modal-body .form-select {
        cursor: pointer !important;
    }
    
    .modal-content {
        background: rgba(36, 52, 71, 0.95) !important;
        backdrop-filter: blur(25px);
        border: 1px solid rgba(160, 216, 204, 0.2);
        position: relative;
        z-index: 1050;
        pointer-events: auto !important;
    }
    
    .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 1040 !important;
    }
    
    /* Asegurar que el modal esté por encima de todo */
    .modal {
        z-index: 1055 !important;
        pointer-events: auto !important;
    }
    
    .modal-dialog {
        z-index: 1056 !important;
        pointer-events: auto !important;
    }
    
    /* Eliminar cualquier posible conflicto de backdrop-filter en inputs */
    .modal-body .glass-input {
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
    }
    
    /* Asegurar que los labels y formularios también sean clickeables */
    .modal-body .form-label,
    .modal-body form {
        pointer-events: auto !important;
        z-index: 9998 !important;
    }
    
    .spinner-border {
        color: var(--havelock-blue) !important;
    }
    
    .interactive-element {
        transition: all 0.3s ease;
    }
    
    .interactive-element:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(98, 130, 227, 0.3);
    }
    
    .task-card {
        border-left: 4px solid var(--havelock-blue);
        transition: all 0.3s ease;
    }
    
    .task-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(98, 130, 227, 0.2);
    }
    
    .priority-low { border-left-color: #10B981; }
    .priority-medium { border-left-color: #F59E0B; }
    .priority-high { border-left-color: #EF4444; }
    .priority-urgent { border-left-color: #DC2626; }
    
    .status-pending { background: linear-gradient(90deg, #64748B 0%, #64748B 0%); }
    .status-in_progress { background: linear-gradient(90deg, var(--havelock-blue) 0%, var(--havelock-blue) 50%); }
    .status-completed { background: linear-gradient(90deg, #10B981 0%, #10B981 100%); }
    
    .credentials-alert {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: 10px;
        backdrop-filter: blur(10px);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
        // Variables globales
        let coacheesData = [];
        let tasksData = [];

        // Función para mostrar notificaciones toast
        function showToast(message, type = 'info', duration = 5000) {
            const toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                alert(`${type.toUpperCase()}: ${message}`);
                return;
            }

            const toastId = 'toast-' + Date.now();
            const iconMap = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-triangle',
                warning: 'fa-exclamation-circle',
                info: 'fa-info-circle'
            };

            const bgColorMap = {
                success: 'bg-success',
                error: 'bg-danger',
                warning: 'bg-warning',
                info: 'bg-info'
            };

            const toastHtml = `
                <div class="toast align-items-center text-white ${bgColorMap[type]} border-0" role="alert" 
                     aria-live="assertive" aria-atomic="true" id="${toastId}">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas ${iconMap[type]} me-2"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                                data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: duration });
            toast.show();

            toastElement.addEventListener('hidden.bs.toast', function () {
                toastElement.remove();
            });
        }

        // Función para abrir el modal de invitación
        function openInvitationModal() {
            console.log('Abriendo modal de invitación...');
            
            // Asegurar que el formulario esté limpio
            const form = document.getElementById('invitationForm');
            if (form) {
                form.reset();
                
                // Verificar que los campos estén disponibles
                const emailInput = document.getElementById('inviteEmail');
                const nameInput = document.getElementById('inviteFullName');
                const messageInput = document.getElementById('inviteMessage');
                
                if (emailInput) {
                    emailInput.value = '';
                    emailInput.removeAttribute('disabled');
                    emailInput.style.pointerEvents = 'auto';
                }
                if (nameInput) {
                    nameInput.value = '';
                    nameInput.removeAttribute('disabled');
                    nameInput.style.pointerEvents = 'auto';
                }
                if (messageInput) {
                    messageInput.value = '';
                    messageInput.removeAttribute('disabled');
                    messageInput.style.pointerEvents = 'auto';
                }
                
                console.log('Formulario reseteado y campos habilitados');
            }
            
            // Abrir el modal
            const modal = new bootstrap.Modal(document.getElementById('invitationModal'));
            modal.show();
            
            // Enfocar el primer campo después de que se abra el modal
            setTimeout(() => {
                const emailInput = document.getElementById('inviteEmail');
                if (emailInput) {
                    emailInput.focus();
                    console.log('Campo email enfocado');
                }
            }, 300);
        }

        // Función para enviar la invitación
        async function sendInvitation() {
            const email = document.getElementById('inviteEmail').value.trim();
            const fullName = document.getElementById('inviteFullName').value.trim();
            const message = document.getElementById('inviteMessage').value.trim();
            const submitBtn = document.querySelector('#invitationForm button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            if (!email || !fullName) {
                showToast('Completa todos los campos requeridos para invitar al coachee', 'error');
                return;
            }

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
                
                const response = await fetch('/api/coach/create-invitation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ 
                        email: email, 
                        full_name: fullName,
                        message: message
                    })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Error al enviar invitación');
                }

                // Mostrar credenciales generadas
                const credentialsHtml = `
                    <div class="credentials-alert p-3 mb-3">
                        <h6 class="text-success fw-bold mb-2">
                            <i class="fas fa-check-circle me-2"></i>¡Coachee creado exitosamente!
                        </h6>
                        <p class="text-white-50 mb-2">Credenciales generadas para ${result.coachee.full_name}:</p>
                        <div class="row">
                            <div class="col-6">
                                <strong class="text-white">Usuario:</strong><br>
                                <code class="text-info">${result.coachee.username}</code>
                            </div>
                            <div class="col-6">
                                <strong class="text-white">Contraseña:</strong><br>
                                <code class="text-warning">${result.coachee.password}</code>
                            </div>
                        </div>
                        <small class="text-white-50">
                            <i class="fas fa-info-circle me-1"></i>
                            Comparte estas credenciales con tu coachee de forma segura.
                        </small>
                    </div>
                `;
                
                document.getElementById('invitationForm').innerHTML = credentialsHtml + 
                    '<button type="button" class="btn btn-primary w-100" onclick="location.reload()">Continuar</button>';
                
                showToast('Coachee creado e invitación enviada exitosamente', 'success');
                loadCoachees(); // Recargar lista de coachees
                
            } catch (error) {
                console.error('Error enviando invitación:', error);
                showToast(error.message || 'Error al enviar invitación', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        // Función para cargar coachees
        async function loadCoachees() {
            try {
                const container = document.getElementById('coacheesContainer');
                container.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando coachees...</span>
                        </div>
                    </div>
                `;

                const response = await fetch('/api/coach/my-coachees', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Error al cargar coachees');
                }

                // La API devuelve directamente un array, no un objeto con propiedad coachees
                coacheesData = await response.json();
                displayCoachees();
                updateStatistics();
                
            } catch (error) {
                console.error('Error cargando coachees:', error);
                const container = document.getElementById('coacheesContainer');
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger glass-card">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error al cargar coachees: ${error.message}
                            <button class="btn btn-sm btn-outline-light ms-2" onclick="loadCoachees()">
                                <i class="fas fa-refresh me-1"></i>Reintentar
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Función para actualizar estadísticas
        function updateStatistics() {
            const totalCoachees = coacheesData.length;
            const completedAssessments = coacheesData.filter(c => c.total_assessments > 0).length;
            const pendingAssessments = totalCoachees - completedAssessments;
            const avgScore = coacheesData.length > 0 ? 
                Math.round(coacheesData
                    .filter(c => c.last_assessment && c.last_assessment.score !== null)
                    .reduce((sum, c) => sum + (c.last_assessment.score || 0), 0) / 
                    Math.max(1, coacheesData.filter(c => c.last_assessment && c.last_assessment.score !== null).length)
                ) : 0;

            document.getElementById('totalCoachees').textContent = totalCoachees;
            document.getElementById('completedAssessments').textContent = completedAssessments;
            document.getElementById('pendingAssessments').textContent = pendingAssessments;
            document.getElementById('avgScore').textContent = avgScore + '%';
        }

        // Función para mostrar coachees
        function displayCoachees() {
            const container = document.getElementById('coacheesContainer');
            
            if (!coacheesData || coacheesData.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="text-center py-5">
                            <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-4" 
                                 style="width: 80px; height: 80px; background: rgba(255, 255, 255, 0.1);">
                                <i class="fas fa-users fa-2x text-white-50"></i>
                            </div>
                            <h4 class="text-gradient fw-bold">No hay coachees asignados</h4>
                            <p class="text-white-50 mb-4">Los coachees que invites aparecerán aquí.</p>
                            <button class="btn btn-success interactive-element" onclick="openInvitationModal()">
                                <i class="fas fa-envelope me-2"></i>Invitar Primer Coachee
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            const html = coacheesData.map(coachee => {
                const hasAssessment = coachee.last_assessment && coachee.last_assessment.score !== null;
                const score = hasAssessment ? coachee.last_assessment.score : 0;
                const isActive = coachee.total_assessments > 0;
                
                return `
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="glass-card h-100 p-4 interactive-element">
                        <div class="d-flex align-items-center mb-3">
                            <div class="rounded-circle d-inline-flex align-items-center justify-content-center me-3" 
                                 style="width: 50px; height: 50px; background: var(--gradient-button);">
                                <i class="fas fa-user text-white"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="text-gradient fw-bold mb-1">${coachee.full_name || coachee.username}</h6>
                                <p class="text-white-50 mb-0 small">${coachee.email}</p>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <span class="badge ${isActive ? 'bg-success' : 'bg-warning'} mb-2">
                                ${isActive ? 'Activo' : 'Pendiente'}
                            </span>
                            ${hasAssessment ? 
                                `<span class="badge bg-info">Evaluación Completada</span>` : 
                                `<span class="badge bg-secondary">Sin Evaluar</span>`
                            }
                        </div>
                        
                        ${hasAssessment ? 
                            `<div class="mb-3">
                                <small class="text-white-50">Puntuación de Asertividad:</small>
                                <div class="progress mt-1" style="height: 8px;">
                                    <div class="progress-bar bg-gradient" role="progressbar" 
                                         style="width: ${score}%; background: var(--gradient-button) !important;" 
                                         aria-valuenow="${score}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <small class="text-gradient fw-bold">${score}%</small>
                            </div>` : 
                            `<div class="mb-3">
                                <small class="text-white-50">Evaluaciones realizadas: ${coachee.total_assessments}</small>
                            </div>`
                        }
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary btn-sm flex-grow-1" onclick="viewCoacheeDetails('${coachee.id}')">
                                <i class="fas fa-eye me-1"></i>Ver Detalles
                            </button>
                            ${hasAssessment ? 
                                `<button class="btn btn-outline-success btn-sm" onclick="downloadReport('${coachee.id}')">
                                    <i class="fas fa-download me-1"></i>Reporte
                                </button>` : 
                                `<button class="btn btn-outline-warning btn-sm" onclick="sendReminder('${coachee.id}')">
                                    <i class="fas fa-bell me-1"></i>Recordar
                                </button>`
                            }
                        </div>
                    </div>
                </div>
            `}).join('');

            container.innerHTML = html;
        }

        // Función para ver detalles del coachee
        function viewCoacheeDetails(coacheeId) {
            showToast('Función de detalles en desarrollo', 'info');
        }

        // Función para descargar reporte
        function downloadReport(coacheeId) {
            showToast('Función de descarga en desarrollo', 'info');
        }

        // Función para enviar recordatorio
        function sendReminder(coacheeId) {
            showToast('Recordatorio enviado', 'success');
        }

        // ==========================================
        // FUNCIONES DE GESTIÓN DE TAREAS
        // ==========================================

        // Función para abrir el modal de nueva tarea
        function openTaskModal() {
            console.log('Abriendo modal de nueva tarea...');
            
            // Resetear el formulario
            const taskForm = document.getElementById('taskForm');
            if (taskForm) {
                taskForm.reset();
            }
            
            // Cargar coachees en el select
            const coacheeSelect = document.getElementById('taskCoachee');
            coacheeSelect.innerHTML = '<option value="">Selecciona un coachee...</option>';
            
            coacheesData.forEach(coachee => {
                const option = document.createElement('option');
                option.value = coachee.id;
                option.textContent = coachee.full_name || coachee.username;
                coacheeSelect.appendChild(option);
            });
            
            // Asegurar que todos los inputs estén habilitados
            const inputs = document.querySelectorAll('#taskModal input, #taskModal textarea, #taskModal select');
            inputs.forEach(input => {
                input.removeAttribute('disabled');
                input.style.pointerEvents = 'auto';
                input.style.userSelect = 'text';
                input.style.cursor = input.type === 'text' || input.tagName === 'TEXTAREA' ? 'text' : 'pointer';
            });
            
            // Abrir el modal
            const modal = new bootstrap.Modal(document.getElementById('taskModal'));
            modal.show();
            
            // Enfocar el primer select después de que se abra
            setTimeout(() => {
                const firstInput = document.getElementById('taskCoachee');
                if (firstInput) {
                    firstInput.focus();
                    console.log('Primer campo enfocado');
                }
            }, 300);
        }

        // Función para crear nueva tarea
        async function createTask() {
            const formData = {
                coachee_id: document.getElementById('taskCoachee').value,
                title: document.getElementById('taskTitle').value.trim(),
                description: document.getElementById('taskDescription').value.trim(),
                category: document.getElementById('taskCategory').value,
                priority: document.getElementById('taskPriority').value,
                due_date: document.getElementById('taskDueDate').value
            };

            const submitBtn = document.querySelector('#taskForm button[type="submit"]');
            const originalText = submitBtn.innerHTML;

            // Validar campos requeridos
            if (!formData.coachee_id || !formData.title || !formData.description || !formData.category) {
                showToast('Completa todos los campos requeridos', 'error');
                return;
            }

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creando...';

                const response = await fetch('/api/coach/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Error al crear tarea');
                }

                showToast('Tarea creada exitosamente', 'success');
                bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
                loadTasks();

            } catch (error) {
                console.error('Error creando tarea:', error);
                showToast(error.message || 'Error al crear tarea', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        // Función para cargar tareas
        async function loadTasks() {
            try {
                const container = document.getElementById('tasksContainer');
                container.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando tareas...</span>
                        </div>
                    </div>
                `;

                const response = await fetch('/api/coach/tasks', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Error al cargar tareas');
                }

                tasksData = await response.json();
                displayTasks();

            } catch (error) {
                console.error('Error cargando tareas:', error);
                const container = document.getElementById('tasksContainer');
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger glass-card">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error al cargar tareas: ${error.message}
                            <button class="btn btn-sm btn-outline-light ms-2" onclick="loadTasks()">
                                <i class="fas fa-refresh me-1"></i>Reintentar
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Función para mostrar tareas
        function displayTasks() {
            const container = document.getElementById('tasksContainer');

            if (!tasksData || tasksData.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="text-center py-5">
                            <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-4" 
                                 style="width: 80px; height: 80px; background: rgba(255, 255, 255, 0.1);">
                                <i class="fas fa-tasks fa-2x text-white-50"></i>
                            </div>
                            <h4 class="text-gradient fw-bold">No hay tareas asignadas</h4>
                            <p class="text-white-50 mb-4">Las tareas que crees para tus coachees aparecerán aquí.</p>
                            <button class="btn btn-success interactive-element" onclick="openTaskModal()">
                                <i class="fas fa-plus me-2"></i>Crear Primera Tarea
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            const html = tasksData.map(task => {
                const priorityColors = {
                    low: 'success',
                    medium: 'warning', 
                    high: 'danger',
                    urgent: 'danger'
                };

                const statusColors = {
                    pending: 'secondary',
                    in_progress: 'primary',
                    completed: 'success',
                    cancelled: 'dark'
                };

                const statusLabels = {
                    pending: 'Pendiente',
                    in_progress: 'En Progreso',
                    completed: 'Completada',
                    cancelled: 'Cancelada'
                };

                return `
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="glass-card task-card priority-${task.priority} h-100 p-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="flex-grow-1">
                                <h6 class="text-gradient fw-bold mb-1">${task.title}</h6>
                                <p class="text-white-50 mb-2 small">${task.coachee.name}</p>
                            </div>
                            <span class="badge bg-${priorityColors[task.priority]} ms-2">
                                ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}
                            </span>
                        </div>
                        
                        <p class="text-white-50 mb-3 small">${task.description.substring(0, 100)}${task.description.length > 100 ? '...' : ''}</p>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-white-50">Progreso:</small>
                                <small class="text-gradient fw-bold">${task.progress_percentage}%</small>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar status-${task.status}" role="progressbar" 
                                     style="width: ${task.progress_percentage}%;" 
                                     aria-valuenow="${task.progress_percentage}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <span class="badge bg-${statusColors[task.status]} mb-2">
                                ${statusLabels[task.status]}
                            </span>
                            <span class="badge bg-info">${task.category}</span>
                            ${task.due_date ? `<br><small class="text-warning">
                                <i class="fas fa-calendar me-1"></i>Vence: ${new Date(task.due_date).toLocaleDateString()}
                            </small>` : ''}
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary btn-sm flex-grow-1" onclick="viewTaskDetails(${task.id})">
                                <i class="fas fa-eye me-1"></i>Ver
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="updateTaskProgress(${task.id})">
                                <i class="fas fa-edit me-1"></i>Actualizar
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');

            container.innerHTML = html;
        }

        // Función para ver detalles de tarea
        function viewTaskDetails(taskId) {
            const task = tasksData.find(t => t.id === taskId);
            if (task) {
                showToast(`Detalles de: ${task.title}`, 'info');
            }
        }

        // Función para actualizar progreso de tarea
        function updateTaskProgress(taskId) {
            showToast('Función de actualización en desarrollo', 'info');
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM cargado, inicializando dashboard del coach...');
            
            // Verificar que Bootstrap esté disponible
            if (typeof bootstrap === 'undefined') {
                console.error('Bootstrap no está disponible');
                showToast('Error: Bootstrap no está cargado', 'error');
                return;
            }
            
            // Verificar que el modal existe
            const modalElement = document.getElementById('invitationModal');
            if (!modalElement) {
                console.error('Modal de invitación no encontrado');
                return;
            }
            
            // Configurar event listener para el formulario de invitación
            const invitationForm = document.getElementById('invitationForm');
            if (invitationForm) {
                console.log('Formulario de invitación encontrado, configurando event listener...');
                invitationForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    console.log('Formulario de invitación enviado');
                    await sendInvitation();
                });
                
                // Agregar listeners a los inputs para debugging
                const emailInput = document.getElementById('inviteEmail');
                const nameInput = document.getElementById('inviteFullName');
                
                if (emailInput) {
                    emailInput.addEventListener('input', function(e) {
                        console.log('Email input changed:', e.target.value);
                    });
                }
                
                if (nameInput) {
                    nameInput.addEventListener('input', function(e) {
                        console.log('Name input changed:', e.target.value);
                    });
                }
            } else {
                console.error('Formulario de invitación no encontrado');
            }

            // Configurar event listener para el formulario de tareas
            const taskForm = document.getElementById('taskForm');
            if (taskForm) {
                taskForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await createTask();
                });
                
                // Agregar listeners a los inputs de tareas para debugging
                const taskInputs = [
                    'taskCoachee', 'taskCategory', 'taskPriority', 
                    'taskDueDate', 'taskTitle', 'taskDescription'
                ];
                
                taskInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('input', function(e) {
                            console.log(`${inputId} changed:`, e.target.value);
                        });
                        
                        input.addEventListener('focus', function(e) {
                            console.log(`${inputId} focused`);
                            e.target.style.pointerEvents = 'auto';
                        });
                        
                        input.addEventListener('click', function(e) {
                            console.log(`${inputId} clicked`);
                        });
                    }
                });
            } else {
                console.error('Formulario de tareas no encontrado');
            }

            // Cargar datos iniciales
            loadCoachees();
            loadTasks();
            
            // Agregar event listeners para when modals are shown
            const invitationModal = document.getElementById('invitationModal');
            const taskModal = document.getElementById('taskModal');
            
            if (invitationModal) {
                invitationModal.addEventListener('shown.bs.modal', function () {
                    console.log('Modal de invitación mostrado');
                    // Forzar focus en el primer input
                    const firstInput = document.getElementById('inviteEmail');
                    if (firstInput) {
                        firstInput.focus();
                        firstInput.click();
                    }
                });
            }
            
            if (taskModal) {
                taskModal.addEventListener('shown.bs.modal', function () {
                    console.log('Modal de tareas mostrado');
                    // Forzar focus en el primer select
                    const firstSelect = document.getElementById('taskCoachee');
                    if (firstSelect) {
                        firstSelect.focus();
                        firstSelect.click();
                    }
                });
            }
        });
</script>
{% endblock %}
{% endblock %}
