<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Coach - Plataforma de Asertividad</title>
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8fafc;
            color: #2d3748;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #667eea;
            line-height: 1;
        }

        .stat-label {
            color: #718096;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .panel-header {
            background: #f7fafc;
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .panel-header h2 {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2d3748;
        }

        .panel-content {
            padding: 1.5rem;
        }

        .coachees-section {
            grid-column: 1 / -1;
        }

        .coachee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .coachee-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .coachee-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .coachee-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .coachee-email {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .coachee-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .coachee-stat {
            text-align: center;
        }

        .coachee-stat-number {
            font-weight: 700;
            font-size: 1.2rem;
            color: #667eea;
        }

        .coachee-stat-label {
            font-size: 0.8rem;
            color: #718096;
        }

        .last-assessment {
            background: #f7fafc;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
        }

        .assessment-score {
            font-weight: 600;
            color: #2d3748;
        }

        .assessment-date {
            font-size: 0.8rem;
            color: #718096;
            margin-top: 0.25rem;
        }

        .score-excellent { color: #38a169; }
        .score-good { color: #3182ce; }
        .score-average { color: #d69e2e; }
        .score-poor { color: #e53e3e; }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #718096;
        }

        .btn-secondary:hover {
            background: #4a5568;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #718096;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #718096;
        }

        .empty-state h3 {
            margin-bottom: 1rem;
            color: #4a5568;
        }

        .error-state {
            text-align: center;
            padding: 3rem;
            color: #e53e3e;
            background: #fed7d7;
            border: 1px solid #fc8181;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .error-state h3 {
            margin-bottom: 1rem;
            color: #c53030;
        }

        .error-state button:hover {
            background: #0056b3 !important;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .refresh-btn {
            background: #48bb78;
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .refresh-btn:hover {
            background: #38a169;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .coachee-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>🎯 Dashboard Coach</h1>
            <div class="user-info">
                <span>Coach: <strong id="coachName">Cargando...</strong></span>
                <a href="/logout" class="logout-btn">Cerrar Sesión</a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Estadísticas Generales -->
        <div class="dashboard-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalCoachees">-</div>
                <div class="stat-label">Coachees Asignados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalAssessments">-</div>
                <div class="stat-label">Evaluaciones Totales</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgScore">-</div>
                <div class="stat-label">Puntuación Promedio</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="recentActivity">-</div>
                <div class="stat-label">Actividad Este Mes</div>
            </div>
        </div>

        <!-- Contenido Principal -->
        <div class="main-content">
            <!-- Distribución de Niveles -->
            <div class="panel">
                <div class="panel-header">
                    <h2>📊 Distribución de Niveles</h2>
                </div>
                <div class="panel-content">
                    <div class="chart-container">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Progreso General -->
            <div class="panel">
                <div class="panel-header">
                    <h2>📈 Tendencia de Progreso</h2>
                </div>
                <div class="panel-content">
                    <div class="chart-container">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Coachees -->
        <div class="panel coachees-section">
            <div class="panel-header">
                <h2>👥 Mis Coachees</h2>
                <div class="action-buttons">
                    <button class="refresh-btn" onclick="openInvitationModal()">✉️ Invitar Coachee</button>
                    <button class="refresh-btn" onclick="loadCoachees()">🔄 Actualizar</button>
                </div>
            </div>
            <div class="panel-content">
                <div id="coacheesContainer" class="loading">
                    Cargando coachees...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let coacheesData = [];
        let statsData = {};
        let distributionChart = null;
        let progressChart = null;

        // Cargar datos iniciales
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardStats();
            loadCoachees();
            setCoachName();
        });

        function setCoachName() {
            // Obtener el nombre del coach desde la API de estadísticas
            fetch('/api/coach/dashboard-stats', {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.coach_name) {
                        document.getElementById('coachName').textContent = data.coach_name;
                    } else {
                        document.getElementById('coachName').textContent = 'Coach';
                    }
                })
                .catch(error => {
                    console.error('Error obteniendo nombre del coach:', error);
                    document.getElementById('coachName').textContent = 'Coach';
                });
        }

        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/coach/dashboard-stats', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    
                    // Si hay error de autenticación o autorización, redirigir al login
                    if (response.status === 401 || response.status === 403) {
                        console.log('Error de autorización en stats:', response.status, errorData);
                        window.location.href = '/login?role=coach';
                        return;
                    }
                    
                    throw new Error(errorData.error || 'No se pudieron cargar las estadísticas del dashboard');
                }
                
                const stats = await response.json();
                statsData = stats;
                
                // Actualizar estadísticas
                document.getElementById('totalCoachees').textContent = stats.total_coachees || 0;
                document.getElementById('totalAssessments').textContent = stats.total_assessments || 0;
                document.getElementById('avgScore').textContent = stats.avg_score ? stats.avg_score + '%' : '-';
                document.getElementById('recentActivity').textContent = stats.recent_activity || 0;
                
                // Crear gráficos con manejo de errores
                try {
                    createDistributionChart(stats.score_distribution);
                } catch (chartError) {
                    console.error('Error creando gráfico:', chartError);
                    // Continuar sin mostrar error al usuario por el gráfico
                }
                
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
                showError('No se pudieron cargar las estadísticas del dashboard. Por favor, recarga la página.');
            }
        }

        async function loadCoachees() {
            try {
                const container = document.getElementById('coacheesContainer');
                container.innerHTML = '<div class="loading">Cargando coachees...</div>';
                
                const response = await fetch('/api/coach/my-coachees', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    
                    // Si hay error de autenticación o autorización, redirigir al login
                    if (response.status === 401 || response.status === 403) {
                        console.log('Error de autorización:', response.status, errorData);
                        window.location.href = "/login?role=coach";
                        return;
                    }
                    
                    throw new Error(errorData.error || 'No se pudo cargar la lista de coachees');
                }
                
                const coachees = await response.json();
                coacheesData = coachees;
                
                if (coachees.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No tienes coachees asignados</h3>
                            <p>Los coachees aparecerán aquí una vez que sean asignados a tu supervisión.</p>
                        </div>
                    `;
                    return;
                }
                
                // Crear grid de coachees
                const coacheeGrid = document.createElement('div');
                coacheeGrid.className = 'coachee-grid';
                
                coachees.forEach(coachee => {
                    const card = createCoacheeCard(coachee);
                    coacheeGrid.appendChild(card);
                });
                
                container.innerHTML = '';
                container.appendChild(coacheeGrid);
                
            } catch (error) {
                console.error('Error cargando coachees:', error);
                const container = document.getElementById('coacheesContainer');
                container.innerHTML = `
                    <div class="error-state">
                        <h3>Error al cargar coachees</h3>
                        <p>No se pudieron cargar los coachees. <button onclick="loadCoachees()" style="
                            background: #007bff; 
                            color: white; 
                            border: none; 
                            padding: 8px 16px; 
                            border-radius: 4px; 
                            cursor: pointer;
                            margin-left: 8px;
                        ">Reintentar</button></p>
                    </div>
                `;
                showError('No se pudo cargar la lista de coachees. Verifica tu conexión.');
            }
        }

        function createCoacheeCard(coachee) {
            const card = document.createElement('div');
            card.className = 'coachee-card';
            card.onclick = () => viewCoacheeDetails(coachee.id);
            
            let lastAssessmentHtml = '';
            if (coachee.latest_assessment) {
                const score = coachee.latest_assessment.overall_score;
                const scoreClass = getScoreClass(score);
                const level = getAssertivityLevel(score);
                const date = new Date(coachee.latest_assessment.created_at).toLocaleDateString();
                
                lastAssessmentHtml = `
                    <div class="last-assessment">
                        <div class="assessment-score ${scoreClass}">
                            Última evaluación: ${score}% (${level})
                        </div>
                        <div class="assessment-date">${date}</div>
                    </div>
                `;
            } else {
                lastAssessmentHtml = `
                    <div class="last-assessment">
                        <div class="assessment-score">Sin evaluaciones completadas</div>
                    </div>
                `;
            }
            
            card.innerHTML = `
                <div class="coachee-name">${coachee.full_name}</div>
                <div class="coachee-email">${coachee.email}</div>
                
                <div class="coachee-stats">
                    <div class="coachee-stat">
                        <div class="coachee-stat-number">${coachee.total_assessments}</div>
                        <div class="coachee-stat-label">Evaluaciones</div>
                    </div>
                    <div class="coachee-stat">
                        <div class="coachee-stat-number">${coachee.latest_assessment ? 
                            getAssertivityLevel(coachee.latest_assessment.overall_score) : 'N/A'}</div>
                        <div class="coachee-stat-label">Nivel Actual</div>
                    </div>
                </div>
                
                ${lastAssessmentHtml}
            `;
            
            return card;
        }

        function createDistributionChart(distribution) {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            
            if (distributionChart) {
                distributionChart.destroy();
            }
            
            distributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(distribution),
                    datasets: [{
                        data: Object.values(distribution),
                        backgroundColor: [
                            '#e53e3e',  // Poco Asertivo
                            '#d69e2e',  // Moderadamente Asertivo
                            '#3182ce',  // Asertivo
                            '#38a169'   // Muy Asertivo
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        async function viewCoacheeDetails(coacheeId) {
            try {
                // Encontrar datos del coachee en el array local
                const coachee = coacheesData.find(c => c.id === coacheeId);
                if (!coachee || !coachee.latest_assessment) {
                    showWarning('No hay evaluaciones disponibles para este participante');
                    return;
                }
                
                // Mostrar modal con la evaluación completa
                showAssessmentResultModal(coachee);
                
            } catch (error) {
                console.error('Error:', error);
                showError('Error cargando detalles del coachee');
            }
        }

        function showAssessmentResultModal(coachee) {
            const assessment = coachee.latest_assessment;
            const dimensionalScores = assessment.dimensional_scores || {};
            
            // Crear modal con el MISMO formato que ve el coachee
            const modal = document.createElement('div');
            modal.id = 'assessmentModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
                overflow-y: auto;
                padding: 20px;
            `;
            
            // Usar el MISMO HTML que el dashboard del coachee
            modal.innerHTML = `
                <div style="background: white; border-radius: 20px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.3);">
                    <!-- Header igual al del coachee -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 20px 20px 0 0; text-align: center;">
                        <h1 style="margin: 0; font-size: 2rem; font-weight: 300;">¡Evaluación Completada!</h1>
                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Resultado para: ${coachee.full_name}</p>
                        <button onclick="closeAssessmentModal()" style="position: absolute; top: 15px; right: 20px; background: rgba(255,255,255,0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 18px;">×</button>
                    </div>
                    
                    <!-- Content igual al del coachee -->
                    <div style="padding: 2rem;">
                        <!-- Score Section igual al del coachee -->
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <div class="score" style="font-size: 4rem; font-weight: bold; color: #667eea; margin: 1rem 0;">${Math.round(assessment.overall_score)}%</div>
                            <p style="font-size: 1.5rem; font-weight: bold; color: #2d3748; margin: 1rem 0;">${getAssertivityLevel(assessment.overall_score)}</p>
                            <p style="color: #718096; font-size: 1.1rem;">Evaluación completada el ${new Date(assessment.completed_at).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                        </div>
                        
                        <!-- Interpretación detallada IGUAL a la del coachee -->
                        <div class="interpretation" style="background: #f7fafc; padding: 2rem; border-radius: 15px; margin-bottom: 2rem;">
                            ${getDetailedInterpretationForCoach(assessment)}
                        </div>
                        
                        <!-- Radar Chart Section igual al del coachee -->
                        <div style="background: #f7fafc; padding: 2rem; border-radius: 15px; margin-bottom: 2rem; text-align: center;">
                            <h3 style="color: #2d3748; margin-bottom: 1.5rem;">📊 Análisis por Dimensiones</h3>
                            <div style="max-width: 500px; margin: 0 auto;">
                                <canvas id="modalRadarChart" width="400" height="400"></canvas>
                            </div>
                            
                            <!-- Leyenda de Dimensiones IGUAL a la del coachee -->
                            <div class="dimensions-legend" style="margin-top: 2rem; text-align: left;">
                                <h4 style="color: #2d3748; margin-bottom: 1rem;">Dimensiones Evaluadas:</h4>
                                <ul style="list-style: none; padding: 0;">
                                    <li style="margin: 0.5rem 0; display: flex; align-items: center;">
                                        <span style="display: inline-block; width: 15px; height: 15px; background-color: #ff6384; border-radius: 50%; margin-right: 10px;"></span>
                                        <span><strong>Comunicación Directa:</strong> Capacidad para expresar ideas claramente</span>
                                    </li>
                                    <li style="margin: 0.5rem 0; display: flex; align-items: center;">
                                        <span style="display: inline-block; width: 15px; height: 15px; background-color: #36a2eb; border-radius: 50%; margin-right: 10px;"></span>
                                        <span><strong>Defensa de Derechos:</strong> Habilidad para hacer valer los propios derechos</span>
                                    </li>
                                    <li style="margin: 0.5rem 0; display: flex; align-items: center;">
                                        <span style="display: inline-block; width: 15px; height: 15px; background-color: #ffce56; border-radius: 50%; margin-right: 10px;"></span>
                                        <span><strong>Expresión de Opiniones:</strong> Facilidad para compartir puntos de vista</span>
                                    </li>
                                    <li style="margin: 0.5rem 0; display: flex; align-items: center;">
                                        <span style="display: inline-block; width: 15px; height: 15px; background-color: #4bc0c0; border-radius: 50%; margin-right: 10px;"></span>
                                        <span><strong>Manejo de Conflictos:</strong> Gestión efectiva de situaciones difíciles</span>
                                    </li>
                                    <li style="margin: 0.5rem 0; display: flex; align-items: center;">
                                        <span style="display: inline-block; width: 15px; height: 15px; background-color: #9966ff; border-radius: 50%; margin-right: 10px;"></span>
                                        <span><strong>Autoconfianza:</strong> Seguridad en las propias capacidades</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div style="text-align: center; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                            <button onclick="closeAssessmentModal()" style="background: #667eea; color: white; border: none; padding: 12px 30px; border-radius: 25px; font-size: 1rem; cursor: pointer; margin: 0 10px;">
                                ✅ Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Crear el gráfico de radar
            setTimeout(() => {
                createModalRadarChart(dimensionalScores);
            }, 100);
            
            // Cerrar modal al hacer clic en el fondo
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeAssessmentModal();
                }
            });
        }
        
        function closeAssessmentModal() {
            const modal = document.getElementById('assessmentModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function getScoreColor(score) {
            if (score >= 75) return '#38a169';      // Verde
            if (score >= 50) return '#3182ce';      // Azul
            if (score >= 25) return '#d69e2e';      // Amarillo
            return '#e53e3e';                       // Rojo
        }
        
        function createModalRadarChart(dimensionalScores) {
            const ctx = document.getElementById('modalRadarChart');
            if (!ctx) return;
            
            const chartCtx = ctx.getContext('2d');
            
            // Usar EXACTAMENTE los mismos datos y formato que el dashboard del coachee
            const data = {
                labels: [
                    'Comunicación\nDirecta',
                    'Defensa de\nDerechos', 
                    'Expresión de\nOpiniones',
                    'Manejo de\nConflictos',
                    'Autoconfianza'
                ],
                datasets: [{
                    label: 'Nivel de Asertividad',
                    data: [
                        dimensionalScores.comunicacion || 0,
                        dimensionalScores.derechos || 0,
                        dimensionalScores.opiniones || 0,
                        dimensionalScores.conflictos || 0,
                        dimensionalScores.autoconfianza || 0
                    ],
                    backgroundColor: 'rgba(102, 126, 234, 0.2)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(102, 126, 234, 1)',
                    pointRadius: 6,
                    pointHoverRadius: 8,
                }]
            };

            const options = {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false // Ocultar leyenda porque ya tenemos la descripción abajo
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw.toFixed(1)}%`;
                            }
                        }
                    }
                },
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            stepSize: 20,
                            font: {
                                size: 12
                            }
                        },
                        pointLabels: {
                            font: {
                                size: 11,
                                weight: 'bold'
                            },
                            color: '#2d3748'
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        angleLines: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    }
                }
            };

            new Chart(chartCtx, {
                type: 'radar',
                data: data,
                options: options
            });
        }

        function getDetailedInterpretationForCoach(assessment) {
            const score = assessment.overall_score;
            const level = getAssertivityLevel(score);
            
            let interpretation = `
                <div class="detailed-interpretation">
                    <h3 style="color: #2d3748; margin-bottom: 1rem;">🎯 Nivel de Asertividad: ${level}</h3>
                    <p style="font-size: 1.1rem; color: #4a5568; margin-bottom: 1.5rem;">Puntuación obtenida: <strong>${Math.round(score)}%</strong> en la evaluación general.</p>
            `;
            
            // Interpretación según el nivel (IGUAL a la del coachee)
            if (score >= 80) {
                interpretation += `
                    <div style="background: #f0fff4; border-left: 4px solid #38a169; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <h4 style="color: #38a169; margin-bottom: 0.5rem;">✨ ¡Excelente nivel de asertividad!</h4>
                        <p style="color: #2d3748; line-height: 1.6;">Demuestra una comunicación muy efectiva, sabe defender sus derechos con respeto y maneja los conflictos de manera constructiva. Mantiene un equilibrio entre expresar sus necesidades y respetar las de otros.</p>
                    </div>
                `;
            } else if (score >= 60) {
                interpretation += `
                    <div style="background: #f7fafc; border-left: 4px solid #3182ce; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <h4 style="color: #3182ce; margin-bottom: 0.5rem;">👍 Buen nivel de asertividad</h4>
                        <p style="color: #2d3748; line-height: 1.6;">Tiene una base sólida en comunicación asertiva. En la mayoría de las situaciones sabe expresarse con claridad y respeto. Hay oportunidades de mejora en algunas áreas específicas.</p>
                    </div>
                `;
            } else if (score >= 40) {
                interpretation += `
                    <div style="background: #fffdf0; border-left: 4px solid #d69e2e; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <h4 style="color: #d69e2e; margin-bottom: 0.5rem;">⚖️ Nivel moderado de asertividad</h4>
                        <p style="color: #2d3748; line-height: 1.6;">Su comunicación asertiva está en desarrollo. A veces logra expresarse de manera efectiva, pero en otras ocasiones podría beneficiarse de ser más directo o más empático según la situación.</p>
                    </div>
                `;
            } else {
                interpretation += `
                    <div style="background: #fef5e7; border-left: 4px solid #e53e3e; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <h4 style="color: #e53e3e; margin-bottom: 0.5rem;">🌱 Oportunidad de crecimiento</h4>
                        <p style="color: #2d3748; line-height: 1.6;">Tiene un gran potencial para desarrollar su asertividad. Trabajar en estas habilidades le ayudará a comunicarse con mayor confianza y efectividad en todas las áreas de su vida.</p>
                    </div>
                `;
            }
            
            interpretation += `
                <div style="background: #e6fffa; border-left: 4px solid #38b2ac; padding: 1.5rem; border-radius: 8px;">
                    <h4 style="color: #38b2ac; margin-bottom: 0.5rem;">📈 Próximos pasos recomendados:</h4>
                    <ul style="color: #2d3748; line-height: 1.6; margin: 0; padding-left: 1.5rem;">
                        <li>Revisar el gráfico dimensional para identificar fortalezas y áreas de mejora</li>
                        <li>Practicar la comunicación asertiva en situaciones cotidianas</li>
                        <li>Considerar trabajar con un coach para desarrollo personalizado</li>
                        <li>Realizar seguimiento periódico para medir el progreso</li>
                    </ul>
                </div>
            </div>
            `;
            
            return interpretation;
        }

        function getScoreClass(score) {
            if (score >= 80) return 'score-excellent';
            if (score >= 60) return 'score-good';
            if (score >= 40) return 'score-average';
            return 'score-poor';
        }

        function getAssertivityLevel(score) {
            if (score >= 80) return 'Muy Asertivo';
            if (score >= 60) return 'Asertivo';
            if (score >= 40) return 'Moderadamente Asertivo';
            return 'Poco Asertivo';
        }

        function showError(message, type = 'error', duration = 5000) {
            // Crear notificación moderna
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                max-width: 400px;
                padding: 16px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                font-size: 14px;
                line-height: 1.4;
                display: flex;
                align-items: center;
                gap: 12px;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                ${type === 'error' ? 
                    'background: #fee; border-left: 4px solid #dc3545; color: #721c24;' :
                    type === 'success' ? 
                    'background: #d4edda; border-left: 4px solid #28a745; color: #155724;' :
                    'background: #fff3cd; border-left: 4px solid #ffc107; color: #856404;'
                }
            `;
            
            // Icono según el tipo
            const icon = type === 'error' ? '⚠️' : type === 'success' ? '✅' : 'ℹ️';
            notification.innerHTML = `
                <span style="font-size: 16px;">${icon}</span>
                <span style="flex: 1;">${message}</span>
                <button onclick="this.parentElement.remove()" style="
                    background: none; 
                    border: none; 
                    font-size: 18px; 
                    cursor: pointer;
                    opacity: 0.7;
                    padding: 0;
                    width: 20px;
                    height: 20px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">×</button>
            `;
            
            document.body.appendChild(notification);
            
            // Animar entrada
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto-remover
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, duration);
        }

        function showSuccess(message) {
            showError(message, 'success');
        }

        function showWarning(message) {
            showError(message, 'warning');
        }

        // SISTEMA DE INVITACIONES
        function openInvitationModal() {
            const modal = document.createElement('div');
            modal.id = 'invitationModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            // Cerrar modal al hacer clic en el fondo
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeInvitationModal();
                }
            });
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 15px; width: 90%; max-width: 500px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);">
                    <h2 style="margin-bottom: 1.5rem; color: #2d3748;">✉️ Invitar Nuevo Coachee</h2>
                    
                    <div id="invitationMessage" style="display: none; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;"></div>
                    
                    <form id="invitationForm">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #4a5568; font-weight: 500;">Nombre Completo *</label>
                            <input type="text" id="invitationFullName" placeholder="Ej: María González" required
                                style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #4a5568; font-weight: 500;">Email *</label>
                            <input type="email" id="invitationEmail" placeholder="Ej: maria@ejemplo.com" required
                                style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                        </div>
                        
                        <div style="display: flex; gap: 1rem;">
                            <button type="button" onclick="closeInvitationModal()"
                                style="flex: 1; background: #e2e8f0; color: #4a5568; border: none; padding: 14px; border-radius: 8px; font-size: 1rem; cursor: pointer;">
                                Cancelar
                            </button>
                            <button type="submit" id="sendInvitationBtn"
                                style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 14px; border-radius: 8px; font-size: 1rem; cursor: pointer;">
                                Enviar Invitación
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Manejar envío del formulario
            document.getElementById('invitationForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await sendInvitation();
            });
        }

        function closeInvitationModal() {
            const modal = document.getElementById('invitationModal');
            if (modal) {
                modal.remove();
            }
        }

        async function sendInvitation() {
            const fullName = document.getElementById('invitationFullName').value;
            const email = document.getElementById('invitationEmail').value;
            const btn = document.getElementById('sendInvitationBtn');
            const messageDiv = document.getElementById('invitationMessage');
            
            if (!fullName || !email) {
                showInvitationMessage('Por favor completa todos los campos', 'error');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Enviando...';
            
            try {
                const response = await fetch('/api/coach/create-invitation', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        full_name: fullName,
                        email: email
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showInvitationMessage('¡Invitación creada exitosamente!', 'success');
                    showInvitationLink(data.invitation.invitation_url);
                    showSuccess(`Invitación enviada a ${fullName} (${email})`);
                    loadCoachees(); // Recargar lista
                } else {
                    const errorMsg = data.error || 'No se pudo crear la invitación';
                    showInvitationMessage(errorMsg, 'error');
                    showError(`Error al invitar a ${fullName}: ${errorMsg}`);
                }
                
            } catch (error) {
                console.error('Error:', error);
                const errorMsg = 'Error de conexión al crear la invitación';
                showInvitationMessage(errorMsg, 'error');
                showError(errorMsg);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Enviar Invitación';
            }
        }

        function showInvitationMessage(message, type) {
            const messageDiv = document.getElementById('invitationMessage');
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            messageDiv.style.background = type === 'success' ? '#f0fff4' : '#fed7d7';
            messageDiv.style.color = type === 'success' ? '#22543d' : '#822727';
            messageDiv.style.border = type === 'success' ? '1px solid #c6f6d5' : '1px solid #feb2b2';
        }

        function showInvitationLink(url) {
            // El URL ya viene como /evaluate/ directamente desde el backend
            const evaluationUrl = url;
            
            const messageDiv = document.getElementById('invitationMessage');
            messageDiv.innerHTML = `
                <div style="margin-bottom: 1rem;">¡Invitación creada exitosamente!</div>
                <div style="margin-bottom: 1rem;">
                    <strong>Enlace directo para evaluación:</strong><br>
                    <input type="text" value="${evaluationUrl}" readonly onclick="this.select()" 
                        style="width: 100%; padding: 8px; border: 1px solid #c6f6d5; border-radius: 4px; margin-top: 0.5rem; background: #f9fffa;">
                </div>
                <div style="margin-bottom: 1rem;">
                    <button onclick="copyToClipboard('${evaluationUrl}')" 
                        style="background: #48bb78; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                        📋 Copiar Enlace
                    </button>
                    <button onclick="sendWhatsApp('${evaluationUrl}')" 
                        style="background: #25d366; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-left: 8px;">
                        📱 Enviar por WhatsApp
                    </button>
                    <button onclick="closeInvitationModal()" 
                        style="background: #4299e1; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-left: 8px;">
                        ✅ Cerrar
                    </button>
                </div>
                <div style="font-size: 0.9rem; color: #666;">
                    � <strong>Instrucciones:</strong> El coachee solo necesita hacer clic en este enlace para comenzar su evaluación directamente.
                </div>
            `;
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                alert('¡Enlace copiado al portapapeles!');
            }, function(err) {
                console.error('Error al copiar: ', err);
            });
        }
        
        function sendWhatsApp(url) {
            const message = encodeURIComponent(`Hola! Te invito a completar tu evaluación de asertividad. Solo haz clic en este enlace: ${url}`);
            window.open(`https://wa.me/?text=${message}`, '_blank');
        }
    </script>
</body>
</html>
