<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InstaCoach - Admin (Alpine.js)</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <style>
        /* Calm.com Color System - Matching Landing Page - VERSION 1756421317 */
        :root {
            /* Color Palette Inspired by Calm.com - Same as Landing */
            --calm-primary: #1E3A8A;        /* Deep Blue */
            --calm-secondary: #3B82F6;      /* Bright Blue */
            --calm-accent: #06B6D4;         /* Cyan */
            --calm-light: #EFF6FF;          /* Very Light Blue */
            --calm-dark: #1E293B;           /* Dark Slate */
            --calm-white: #FFFFFF;
            --calm-gray-50: #F8FAFC;
            --calm-gray-100: #F1F5F9;
            --calm-gray-600: #475569;
            --calm-gray-700: #334155;
            
            /* Admin specific mappings using new system */
            --admin-primary: #1E3A8A;        /* Same as calm-primary */
            --admin-secondary: #3B82F6;      /* Same as calm-secondary */
            --admin-success: #10B981;        /* Success green */
            --admin-info: #06B6D4;           /* Same as calm-accent */
            --admin-warning: #F59E0B;        /* Warning orange */
            --admin-danger: #EF4444;         /* Danger red */
            
            /* Background and surface colors */
            --calm-background: #F8FAFC;      /* Light gray background */
            --calm-surface: #FFFFFF;         /* Clean white surfaces */
            --calm-border: rgba(59, 130, 246, 0.3); /* Blue border */
            --calm-text-primary: #1E293B;    /* Dark slate text */
            --calm-text-secondary: #475569;  /* Gray secondary text */
            
            /* Gradients */
            --calm-gradient-primary: linear-gradient(135deg, #1E3A8A 0%, #3B82F6 100%);
            --calm-gradient-light: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
            --calm-gradient-accent: linear-gradient(135deg, #06B6D4 0%, #0284C7 100%);
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--calm-background);
            color: var(--calm-text-primary);
        }

        /* Alpine.js transitions */
        [x-cloak] { display: none !important; }

        .alpine-fade-enter-active,
        .alpine-fade-leave-active {
            transition: opacity 0.3s ease;
        }

        .alpine-fade-enter-from,
        .alpine-fade-leave-to {
            opacity: 0;
        }

        /* Header responsivo */
        .admin-header {
            background: var(--calm-gradient-primary);
            color: white;
            box-shadow: 0 2px 4px rgba(30, 58, 138, 0.15);
        }

        /* Stats cards responsivas */
        .stat-card {
            background: var(--calm-surface);
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(30, 58, 138, 0.1);
            border-left: 4px solid var(--admin-success);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.15);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--calm-primary);
            line-height: 1;
        }

        @media (max-width: 768px) {
            .stat-number {
                font-size: 2rem;
            }
        }

        /* Cards principales */
        .admin-card {
            background: var(--calm-surface);
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--calm-border);
        }

        /* Tablas responsivas */
        .table-responsive {
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .admin-table {
            margin-bottom: 0;
        }

        .admin-table th {
            background-color: var(--calm-background);
            font-weight: 600;
            color: var(--calm-text-primary);
            border-bottom: 2px solid var(--calm-border);
            font-size: 0.875rem;
        }

        .admin-table td {
            vertical-align: middle;
            font-size: 0.875rem;
        }

        /* Role badges responsivos */
        .role-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .role-admin {
            background-color: rgba(36, 52, 71, 0.1);
            color: var(--calm-text-primary);
        }

        .role-coach {
            background-color: rgba(74, 108, 133, 0.1);
            color: var(--calm-text-secondary);
        }

        .role-coachee {
            background-color: rgba(160, 216, 204, 0.1);
            color: var(--calm-text-primary);
        }

        .role-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* User Avatar */
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
            overflow: hidden;
            margin-right: 8px;
            vertical-align: middle;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Charts responsivos */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 250px;
            }
        }

        /* Form styles responsivos */
        .form-floating > label {
            padding: 1rem 0.75rem;
        }

        .btn-admin {
            background: linear-gradient(135deg, var(--admin-primary) 0%, #b02a37 100%);
            border: none;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-admin:hover {
            background: linear-gradient(135deg, #b02a37 0%, var(--admin-primary) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
            color: white;
        }

        .btn-admin-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            border: none;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-admin-secondary:hover {
            background: linear-gradient(135deg, #5a6268 0%, #6c757d 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
            color: white;
        }

        /* Loading states */
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--admin-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile optimizations */
        @media (max-width: 576px) {
            .container-fluid {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            .admin-card {
                margin-bottom: 1rem;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .d-flex.gap-2 {
                flex-direction: column;
            }
        }

        /* Accessibility improvements */
        .btn:focus,
        .form-control:focus,
        .form-select:focus {
            box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
            border-color: var(--admin-primary);
        }

        /* Badge for Alpine.js indicator */
        .alpine-badge {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #77C1D2 0%, #3EADCF 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        }
    </style>
</head>
<body x-data="adminDashboard()" x-init="init()">
    <!-- Alpine.js Version Badge -->
    <div class="alpine-badge">
        <i class="fas fa-mountain"></i> Alpine.js Version
    </div>

    <!-- Header responsivo -->
    <header class="admin-header">
        <div class="container-fluid">
            <div class="row align-items-center py-3">
                <div class="col-12 col-md-8">
                    <h1 class="h3 h2-md mb-0">
                        <i class="fas fa-shield-alt me-2"></i>
                        Panel de Administración
                    </h1>
                </div>
                <div class="col-12 col-md-4 text-md-end mt-2 mt-md-0">
                    <div class="d-flex align-items-center justify-content-md-end gap-2">
                        <span class="d-none d-sm-inline text-white-50">
                            <i class="fas fa-user-shield me-1"></i>
                            Administrador
                        </span>
                        <button @click="openChangePasswordModal()" class="btn btn-outline-light btn-sm">
                            <i class="fas fa-key me-1"></i>
                            <span class="d-none d-sm-inline">Cambiar Contraseña</span>
                        </button>
                        <button onclick="adminLogout()" class="btn btn-outline-light btn-sm">
                            <i class="fas fa-sign-out-alt me-1"></i>
                            <span class="d-none d-sm-inline">Cerrar Sesión</span>
                            <span class="d-sm-none">Salir</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main content -->
    <main class="container-fluid py-4">
        
        <!-- Estadísticas Generales - Grid responsivo con Alpine.js -->
        <div class="row g-3 g-md-4 mb-4">
            <div class="col-6 col-lg-3">
                <div class="stat-card p-3 p-md-4 h-100">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="stat-number" x-text="stats.total_users">-</div>
                            <div class="text-muted small fw-medium">Total Usuarios</div>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-users fa-2x text-primary opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-6 col-lg-3">
                <div class="stat-card p-3 p-md-4 h-100">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="stat-number" x-text="stats.total_coaches">-</div>
                            <div class="text-muted small fw-medium">Coaches</div>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-user-tie fa-2x text-info opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-6 col-lg-3">
                <div class="stat-card p-3 p-md-4 h-100">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="stat-number" x-text="stats.total_coachees">-</div>
                            <div class="text-muted small fw-medium">Coachees</div>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-user-friends fa-2x text-success opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-6 col-lg-3">
                <div class="stat-card p-3 p-md-4 h-100">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="stat-number" x-text="stats.total_assessments">-</div>
                            <div class="text-muted small fw-medium">Evaluaciones</div>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-chart-bar fa-2x text-warning opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estadísticas Adicionales - Segunda fila -->
        <div class="row g-3 g-md-4 mb-4">
            <div class="col-6 col-lg-3">
                <div class="stat-card p-3 p-md-4 h-100">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="stat-number" x-text="stats.active_users">-</div>
                            <div class="text-muted small fw-medium">Usuarios Activos</div>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-user-check fa-2x text-success opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-6 col-lg-3">
                <div class="stat-card p-3 p-md-4 h-100">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="stat-number" x-text="stats.inactive_users">-</div>
                            <div class="text-muted small fw-medium">Usuarios Inactivos</div>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-user-slash fa-2x text-danger opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-6 col-lg-3">
                <div class="stat-card p-3 p-md-4 h-100">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="stat-number" x-text="stats.recent_assessments">-</div>
                            <div class="text-muted small fw-medium">Evaluaciones (30 días)</div>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-calendar-check fa-2x text-primary opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-6 col-lg-3">
                <div class="stat-card p-3 p-md-4 h-100">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="stat-number">
                                <span x-text="stats.avg_score">-</span>
                                <span class="fs-6 text-muted">%</span>
                            </div>
                            <div class="text-muted small fw-medium">Puntaje Promedio</div>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-star fa-2x text-warning opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Principal - Grid responsivo -->
        <div class="row g-3 g-md-4 mb-4">
            <!-- Lista de Usuarios -->
            <div class="col-12 col-xl-8">
                <div class="admin-card p-3 p-md-4 h-100">
                    <div class="d-flex align-items-center mb-3">
                        <h2 class="h4 mb-0 flex-grow-1">
                            <i class="fas fa-users text-primary me-2"></i>
                            Usuarios del Sistema
                        </h2>
                        <button class="btn btn-outline-primary btn-sm" @click="loadUsers()">
                            <i class="fas fa-sync-alt" :class="{ 'fa-spin': loading.users }"></i>
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <!-- Loading State -->
                        <div x-show="loading.users" x-cloak class="text-center py-4 text-muted">
                            <div class="loading-spinner me-2"></div>
                            Cargando usuarios...
                        </div>

                        <!-- Error State -->
                        <div x-show="!loading.users && error.users" x-cloak class="alert alert-warning" x-text="error.users"></div>

                        <!-- Empty State -->
                        <div x-show="!loading.users && !error.users && users.length === 0" x-cloak class="alert alert-info">
                            No hay usuarios registrados
                        </div>

                        <!-- Users Table -->
                        <table x-show="!loading.users && users.length > 0" x-cloak class="table admin-table table-hover">
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th class="d-none d-md-table-cell">Nombre</th>
                                    <th>Rol</th>
                                    <th class="d-none d-sm-table-cell">Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="user in users" :key="user.id">
                                    <tr>
                                        <td>
                                            <template x-if="user.avatar_url">
                                                <div class="user-avatar">
                                                    <img :src="user.avatar_url" :alt="user.username">
                                                </div>
                                            </template>
                                            <template x-if="!user.avatar_url">
                                                <div class="user-avatar" x-text="user.username.charAt(0).toUpperCase()"></div>
                                            </template>
                                            <div class="d-inline-block align-middle">
                                                <div class="fw-semibold" x-text="user.username"></div>
                                                <div class="d-md-none small text-muted" x-text="user.full_name"></div>
                                            </div>
                                        </td>
                                        <td class="d-none d-md-table-cell" x-text="user.full_name"></td>
                                        <td>
                                            <span class="role-badge" :class="`role-${user.role}`" x-text="getRoleDisplayName(user.role)"></span>
                                        </td>
                                        <td class="d-none d-sm-table-cell">
                                            <span class="badge" :class="user.is_active ? 'bg-success' : 'bg-danger'" x-text="user.is_active ? 'Activo' : 'Inactivo'"></span>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Actividad -->
            <div class="col-12 col-xl-4">
                <div class="admin-card p-3 p-md-4 h-100">
                    <h2 class="h4 mb-3">
                        <i class="fas fa-chart-pie text-primary me-2"></i>
                        Distribución
                    </h2>
                    <div class="chart-container">
                        <canvas id="userDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gestión de Coaches - Completamente responsiva con Alpine.js -->
        <div class="admin-card p-3 p-md-4 mb-4">
            <h2 class="h4 mb-4">
                <i class="fas fa-user-tie text-primary me-2"></i>
                Gestión de Coaches
            </h2>
            
            <!-- Formulario para crear nuevo coach - Alpine.js form handling -->
            <div class="bg-light rounded-3 p-3 p-md-4 mb-4">
                <h3 class="h5 mb-3 text-primary">
                    <i class="fas fa-plus-circle me-2"></i>
                    Crear Nuevo Coach
                </h3>
                
                <form @submit.prevent="handleCreateCoach()">
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <div class="form-floating">
                                <input type="text" x-model="coachForm.username" class="form-control" placeholder="Username" required>
                                <label for="coachUsername">
                                    <i class="fas fa-user me-1 text-muted"></i>
                                    Nombre de Usuario
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-12 col-md-6">
                            <div class="form-floating">
                                <input type="email" x-model="coachForm.email" class="form-control" placeholder="Email" required>
                                <label for="coachEmail">
                                    <i class="fas fa-envelope me-1 text-muted"></i>
                                    Email
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-12 col-md-6">
                            <div class="form-floating">
                                <input type="text" x-model="coachForm.full_name" class="form-control" placeholder="Nombre Completo" required>
                                <label for="coachFullName">
                                    <i class="fas fa-id-card me-1 text-muted"></i>
                                    Nombre Completo
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-12 col-md-6">
                            <div class="input-group">
                                <div class="form-floating flex-grow-1">
                                    <input type="password" x-model="coachForm.password" class="form-control" placeholder="Contraseña" required minlength="6">
                                    <label for="coachPassword">
                                        <i class="fas fa-lock me-1 text-muted"></i>
                                        Contraseña
                                    </label>
                                </div>
                                <button type="button" class="btn btn-outline-secondary" @click="generateRandomPassword()" title="Generar contraseña aleatoria">
                                    <i class="fas fa-dice"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <div class="d-grid">
                                <button type="submit" class="btn btn-admin btn-lg" :disabled="loading.createCoach">
                                    <template x-if="!loading.createCoach">
                                        <span><i class="fas fa-plus-circle me-2"></i>Crear Coach</span>
                                    </template>
                                    <template x-if="loading.createCoach">
                                        <span><div class="loading-spinner me-2"></div>Creando...</span>
                                    </template>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Lista de coaches existentes - Responsive table with Alpine.js -->
            <div>
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h3 class="h5 mb-0 text-primary">
                        <i class="fas fa-list me-2"></i>
                        Coaches Registrados
                    </h3>
                    <button class="btn btn-outline-primary btn-sm" @click="loadCoaches()">
                        <i class="fas fa-sync-alt" :class="{ 'fa-spin': loading.coaches }"></i>
                    </button>
                </div>
                
                <div class="table-responsive">
                    <!-- Loading State -->
                    <div x-show="loading.coaches" x-cloak class="text-center py-4 text-muted">
                        <div class="loading-spinner me-2"></div>
                        Cargando coaches...
                    </div>

                    <!-- Error State -->
                    <div x-show="!loading.coaches && error.coaches" x-cloak class="alert alert-danger" x-text="error.coaches"></div>

                    <!-- Empty State -->
                    <div x-show="!loading.coaches && !error.coaches && coaches.length === 0" x-cloak class="alert alert-info">
                        No hay coaches registrados
                    </div>

                    <!-- Coaches Table -->
                    <table x-show="!loading.coaches && coaches.length > 0" x-cloak class="table admin-table table-hover">
                        <thead>
                            <tr>
                                <th>Coach</th>
                                <th class="d-none d-lg-table-cell">Email</th>
                                <th class="d-none d-md-table-cell">Coachees</th>
                                <th class="d-none d-md-table-cell">Evaluaciones</th>
                                <th class="d-none d-xl-table-cell">Último Login</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="coach in coaches" :key="coach.id">
                                <tr>
                                    <td>
                                        <div class="fw-semibold" x-text="coach.username"></div>
                                        <div class="small text-muted" x-text="coach.full_name"></div>
                                        <div class="d-lg-none small text-muted" x-text="coach.email"></div>
                                    </td>
                                    <td class="d-none d-lg-table-cell" x-text="coach.email"></td>
                                    <td class="d-none d-md-table-cell">
                                        <span class="badge bg-primary" x-text="coach.coachees_count"></span>
                                    </td>
                                    <td class="d-none d-md-table-cell">
                                        <span class="badge bg-info" x-text="coach.assessments_count"></span>
                                    </td>
                                    <td class="d-none d-xl-table-cell" x-text="coach.last_login ? new Date(coach.last_login).toLocaleDateString() : 'Nunca'"></td>
                                    <td>
                                        <span class="role-badge" :class="coach.is_active ? 'role-coach' : 'role-inactive'" x-text="coach.is_active ? 'Activo' : 'Inactivo'"></span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Acciones de Administración - Mobile responsive -->
        <div class="admin-card p-3 p-md-4">
            <h2 class="h4 mb-3">
                <i class="fas fa-cogs text-primary me-2"></i>
                Acciones de Administración
            </h2>
            
            <div class="row g-2 g-md-3">
                <div class="col-12 col-sm-6 col-lg-3">
                    <a href="/admin/users-management" class="btn btn-admin w-100">
                        <i class="fas fa-users-cog me-2"></i>
                        Gestión de Usuarios
                    </a>
                </div>
                
                <div class="col-12 col-sm-6 col-lg-3">
                    <button class="btn btn-admin w-100" @click="initializeDatabase()">
                        <i class="fas fa-sync-alt me-2"></i>
                        <span class="d-none d-sm-inline">Reinicializar</span>
                        <span class="d-sm-none">Reinicializar DB</span>
                        Base de Datos
                    </button>
                </div>
                
                <div class="col-12 col-sm-6 col-lg-3">
                    <button class="btn btn-admin-secondary w-100" @click="exportData()">
                        <i class="fas fa-download me-2"></i>
                        Exportar Datos
                    </button>
                </div>
                
                <div class="col-12 col-sm-6 col-lg-3">
                    <button class="btn btn-admin-secondary w-100" @click="viewSystemLogs()">
                        <i class="fas fa-file-alt me-2"></i>
                        Ver Logs
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal: Cambiar Contraseña -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changePasswordModalLabel">
                        <i class="fas fa-key me-2"></i>Cambiar Contraseña
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm" @submit.prevent="submitPasswordChange()">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Contraseña Actual</label>
                            <input 
                                type="password" 
                                class="form-control" 
                                id="currentPassword" 
                                x-model="passwordForm.current_password" 
                                required
                                autocomplete="current-password">
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">Nueva Contraseña</label>
                            <input 
                                type="password" 
                                class="form-control" 
                                id="newPassword" 
                                x-model="passwordForm.new_password" 
                                required
                                minlength="6"
                                autocomplete="new-password">
                            <div class="form-text">Mínimo 6 caracteres</div>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirmar Nueva Contraseña</label>
                            <input 
                                type="password" 
                                class="form-control" 
                                id="confirmPassword" 
                                x-model="passwordForm.confirm_password" 
                                required
                                autocomplete="new-password">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button 
                        type="button" 
                        class="btn btn-primary" 
                        @click="submitPasswordChange()"
                        :disabled="loading.changePassword">
                        <span x-show="!loading.changePassword">
                            <i class="fas fa-save me-1"></i>Cambiar Contraseña
                        </span>
                        <span x-show="loading.changePassword" x-cloak>
                            <span class="spinner-border spinner-border-sm me-1"></span>Cambiando...
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Alpine.js Component
        function adminDashboard() {
            return {
                // Estado reactivo
                stats: {
                    total_users: 0,
                    total_coaches: 0,
                    total_coachees: 0,
                    total_assessments: 0,
                    total_admins: 1,
                    active_users: 0,
                    inactive_users: 0,
                    recent_assessments: 0,
                    avg_score: 0
                },
                users: [],
                coaches: [],
                loading: {
                    stats: true,
                    users: true,
                    coaches: true,
                    createCoach: false,
                    changePassword: false
                },
                error: {
                    users: null,
                    coaches: null
                },
                coachForm: {
                    username: '',
                    email: '',
                    full_name: '',
                    password: ''
                },
                passwordForm: {
                    current_password: '',
                    new_password: '',
                    confirm_password: ''
                },
                chart: null,

                // Inicialización
                init() {
                    this.loadPlatformStats();
                    this.loadUsers();
                    this.loadCoaches();
                },

                // API Base URL
                get apiBaseUrl() {
                    return window.location.origin;
                },

                // Cargar estadísticas
                async loadPlatformStats() {
                    this.loading.stats = true;
                    try {
                        const response = await fetch(`${this.apiBaseUrl}/api/admin/platform-stats`);
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.stats = data;
                            this.createUserDistributionChart();
                        } else {
                            throw new Error(data.error);
                        }
                    } catch (error) {
                        console.error('Error cargando estadísticas:', error);
                        this.stats = {
                            total_users: 'Error',
                            total_coaches: 'Error',
                            total_coachees: 'Error',
                            total_assessments: 'Error'
                        };
                    } finally {
                        this.loading.stats = false;
                    }
                },

                // Cargar usuarios
                async loadUsers() {
                    this.loading.users = true;
                    this.error.users = null;
                    try {
                        const response = await fetch(`${this.apiBaseUrl}/api/admin/users`);
                        
                        if (response.ok) {
                            const data = await response.json();
                            this.users = data.users || [];
                        } else {
                            const error = await response.json();
                            throw new Error(error.error || 'Error cargando usuarios');
                        }
                    } catch (error) {
                        console.error('Error cargando usuarios:', error);
                        this.error.users = error.message || 'Error cargando usuarios';
                    } finally {
                        this.loading.users = false;
                    }
                },

                // Cargar coaches
                async loadCoaches() {
                    this.loading.coaches = true;
                    this.error.coaches = null;
                    try {
                        const response = await fetch(`${this.apiBaseUrl}/api/admin/coaches`);
                        
                        if (response.ok) {
                            const data = await response.json();
                            this.coaches = data.coaches || [];
                        } else {
                            const error = await response.json();
                            throw new Error(error.error || 'Error cargando coaches');
                        }
                    } catch (error) {
                        console.error('Error cargando coaches:', error);
                        this.error.coaches = `Error cargando coaches: ${error.message}`;
                    } finally {
                        this.loading.coaches = false;
                    }
                },

                // Crear nuevo coach
                async handleCreateCoach() {
                    // Validaciones
                    if (this.coachForm.password.length < 6) {
                        alert('La contraseña debe tener al menos 6 caracteres');
                        return;
                    }

                    if (!this.coachForm.email.includes('@')) {
                        alert('Por favor ingresa un email válido');
                        return;
                    }

                    this.loading.createCoach = true;

                    try {
                        const response = await fetch(`${this.apiBaseUrl}/api/admin/create-coach`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(this.coachForm)
                        });

                        const data = await response.json();

                        if (data.success) {
                            alert(
                                `✅ Coach ${this.coachForm.full_name} creado exitosamente!\n\n` +
                                `Credenciales:\nUsuario: ${this.coachForm.username}\nContraseña: ${this.coachForm.password}\n\n` +
                                `El coach puede cambiar su contraseña desde /coach-login`
                            );
                            
                            // Reset form
                            this.coachForm = {
                                username: '',
                                email: '',
                                full_name: '',
                                password: ''
                            };
                            
                            // Recargar datos
                            this.loadPlatformStats();
                            this.loadCoaches();
                        } else {
                            alert('❌ Error creando coach: ' + data.error);
                        }
                    } catch (error) {
                        alert('❌ Error de conexión: ' + error.message);
                    } finally {
                        this.loading.createCoach = false;
                    }
                },

                // Generar contraseña aleatoria
                generateRandomPassword() {
                    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789';
                    let password = '';
                    for (let i = 0; i < 8; i++) {
                        password += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                    this.coachForm.password = password;
                },

                // Obtener nombre de rol
                getRoleDisplayName(role) {
                    const roleNames = {
                        'platform_admin': 'Admin',
                        'coach': 'Coach',
                        'coachee': 'Coachee'
                    };
                    return roleNames[role] || role;
                },

                // Crear gráfico
                createUserDistributionChart() {
                    const ctx = document.getElementById('userDistributionChart').getContext('2d');
                    
                    if (this.chart) {
                        this.chart.destroy();
                    }
                    
                    this.chart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Administradores', 'Coaches', 'Coachees'],
                            datasets: [{
                                data: [
                                    this.stats.total_admins || 1, 
                                    this.stats.total_coaches, 
                                    this.stats.total_coachees
                                ],
                                backgroundColor: ['#dc3545', '#0dcaf0', '#198754'],
                                borderWidth: 2,
                                borderColor: '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: window.innerWidth < 768 ? 'bottom' : 'right',
                                    labels: {
                                        padding: 15,
                                        font: {
                                            size: window.innerWidth < 768 ? 10 : 12
                                        }
                                    }
                                }
                            }
                        }
                    });
                },

                // Acciones de administración
                async initializeDatabase() {
                    if (confirm('¿Estás seguro de que quieres reinicializar la base de datos? Esto puede afectar los datos existentes.')) {
                        try {
                            const response = await fetch(`${this.apiBaseUrl}/api/init-db`, {
                                method: 'POST'
                            });
                            const result = await response.json();
                            
                            if (response.ok) {
                                alert('Base de datos reinicializada correctamente');
                                location.reload();
                            } else {
                                alert('Error: ' + result.message);
                            }
                        } catch (error) {
                            alert('Error reinicializando base de datos: ' + error.message);
                        }
                    }
                },

                exportData() {
                    alert('Funcionalidad de exportación próximamente');
                },

                viewSystemLogs() {
                    alert('Logs del sistema disponibles en el panel de Railway');
                },

                // Cambiar contraseña
                openChangePasswordModal() {
                    // Reset form
                    this.passwordForm = {
                        current_password: '',
                        new_password: '',
                        confirm_password: ''
                    };
                    
                    const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
                    modal.show();
                },

                async submitPasswordChange() {
                    // Validaciones
                    if (this.passwordForm.new_password !== this.passwordForm.confirm_password) {
                        alert('❌ Las contraseñas nuevas no coinciden');
                        return;
                    }

                    if (this.passwordForm.new_password.length < 6) {
                        alert('❌ La nueva contraseña debe tener al menos 6 caracteres');
                        return;
                    }

                    this.loading.changePassword = true;

                    try {
                        const response = await fetch(`${this.apiBaseUrl}/api/admin/change-password`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                current_password: this.passwordForm.current_password,
                                new_password: this.passwordForm.new_password
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            alert('✅ Contraseña cambiada exitosamente');
                            
                            // Cerrar modal
                            const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                            modal.hide();
                            
                            // Reset form
                            this.passwordForm = {
                                current_password: '',
                                new_password: '',
                                confirm_password: ''
                            };
                        } else {
                            alert('❌ Error: ' + (data.error || 'No se pudo cambiar la contraseña'));
                        }
                    } catch (error) {
                        console.error('Error al cambiar contraseña:', error);
                        alert('❌ Error al cambiar la contraseña: ' + error.message);
                    } finally {
                        this.loading.changePassword = false;
                    }
                }
            }
        }
        
        // Función de logout seguro para administradores
        async function adminLogout() {
            try {
                // Mostrar indicador de carga
                const logoutBtn = event.target.closest('button');
                const originalHtml = logoutBtn.innerHTML;
                logoutBtn.disabled = true;
                logoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Cerrando...';
                
                const response = await fetch('/api/admin/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Limpiar localStorage y sessionStorage
                    localStorage.clear();
                    sessionStorage.clear();
                    
                    // Mostrar mensaje y redirigir
                    window.location.href = data.redirect_url || '/admin-login';
                } else {
                    // En caso de error, forzar redirección al login
                    console.error('❌ Error cerrando sesión:', data.error);
                    window.location.href = '/admin-login';
                }
            } catch (error) {
                console.error('❌ Error en logout:', error);
                // Forzar redirección incluso si hay error
                window.location.href = '/admin-login';
            }
        }
    </script>
</body>
</html>
