<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Evaluaci√≥n de Asertividad</title>
    <!-- Chart.js para gr√°ficos de radar -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 600px;
            margin: 1rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            color: #4a5568;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #718096;
        }

        .login-form, .assessment-container {
            display: none;
        }

        .login-form.active, .assessment-container.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .progress-bar {
            background: #e2e8f0;
            border-radius: 10px;
            height: 10px;
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .question-card {
            margin-bottom: 2rem;
        }

        .question-text {
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
            color: #2d3748;
            font-weight: 600;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .option {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .option.selected {
            border-color: #667eea;
            background: #e6fffa;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        .btn-secondary {
            background: #718096;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            text-align: center;
            display: none;
        }

        .score {
            font-size: 3rem;
            font-weight: bold;
            color: #667eea;
            margin: 1rem 0;
        }

        .interpretation {
            background: #f7fafc;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
            text-align: left;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .success {
            background: #c6f6d5;
            color: #2f855a;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .info {
            background: #bee3f8;
            color: #2c5282;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        @media (max-width: 768px) {
            .container {
                margin: 0.5rem;
                padding: 1.5rem;
            }

            .navigation {
                flex-direction: column;
                gap: 1rem;
            }
        }
        
        /* Estilos para el gr√°fico de radar */
        .radar-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .radar-section h3 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
        }
        
        .radar-container {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
            background-color: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        #radarChart {
            max-width: 100%;
            height: auto;
        }
        
        .dimensions-legend {
            background-color: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .dimensions-legend h4 {
            color: #4a5568;
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
        }
        
        .legend-list {
            list-style: none;
            padding: 0;
        }
        
        .legend-list li {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin-right: 0.5rem;
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Evaluaci√≥n de Asertividad</h1>
            <p>Descubre tu nivel de asertividad y mejora tus habilidades de comunicaci√≥n</p>
        </div>

        <!-- Formulario de Informaci√≥n Personal -->
        <div class="login-form active" id="loginForm">
            <div class="form-group">
                <label for="name">Nombre completo:</label>
                <input type="text" id="name" placeholder="Ingresa tu nombre completo">
            </div>

            <div class="form-group">
                <label for="email">Correo electr√≥nico:</label>
                <input type="email" id="email" placeholder="tu@email.com">
            </div>

            <div class="form-group">
                <label for="age">Edad:</label>
                <input type="number" id="age" min="16" max="100" placeholder="25">
            </div>

            <div class="form-group">
                <label for="gender">G√©nero:</label>
                <select id="gender">
                    <option value="">Selecciona tu g√©nero</option>
                    <option value="masculino">Masculino</option>
                    <option value="femenino">Femenino</option>
                    <option value="otro">Otro</option>
                </select>
            </div>

            <button class="btn" onclick="startAssessment()">Iniciar Evaluaci√≥n</button>
        </div>

        <!-- Container de Evaluaci√≥n -->
        <div class="assessment-container" id="assessmentContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>

            <div class="question-info">
                <p>Pregunta <span id="currentQuestion">1</span> de <span id="totalQuestions">10</span></p>
            </div>

            <div class="question-card" id="questionCard">
                <!-- Las preguntas se cargar√°n din√°micamente -->
            </div>

            <div class="navigation">
                <button class="btn-secondary" id="prevBtn" onclick="previousQuestion()" style="display: none;">Anterior</button>
                <button class="btn" id="nextBtn" onclick="nextQuestion()" disabled>Siguiente</button>
                <button class="btn" id="finishBtn" onclick="completeAssessment()" style="display: none;">Finalizar Evaluaci√≥n</button>
            </div>
        </div>

        <!-- Pantalla de Carga -->
        <div class="loading" id="loadingScreen" style="display: none;">
            <div class="spinner"></div>
            <p>Procesando tu evaluaci√≥n...</p>
        </div>

        <!-- Resultados -->
        <div class="results" id="resultsContainer" style="display: none;">
            <h2>¬°Evaluaci√≥n Completada!</h2>
            <div class="score" id="scoreDisplay">0</div>
            <p><strong id="levelDisplay">Nivel de Asertividad</strong></p>
            <div class="interpretation" id="interpretationDisplay">
                <!-- La interpretaci√≥n se cargar√° din√°micamente -->
            </div>
            <!-- Gr√°fico de Radar -->
            <div class="radar-section">
                <h3>An√°lisis por Dimensiones</h3>
                <div class="radar-container">
                    <canvas id="radarChart" width="400" height="400"></canvas>
                </div>
                <!-- Leyenda de Dimensiones -->
                <div class="dimensions-legend">
                    <h4>Dimensiones Evaluadas:</h4>
                    <ul class="legend-list">
                        <li><span class="legend-color" style="background-color: #ff6384;"></span><strong>Comunicaci√≥n Directa:</strong> Capacidad para expresar ideas claramente</li>
                        <li><span class="legend-color" style="background-color: #36a2eb;"></span><strong>Defensa de Derechos:</strong> Habilidad para hacer valer los propios derechos</li>
                        <li><span class="legend-color" style="background-color: #ffce56;"></span><strong>Expresi√≥n de Opiniones:</strong> Facilidad para compartir puntos de vista</li>
                        <li><span class="legend-color" style="background-color: #4bc0c0;"></span><strong>Manejo de Conflictos:</strong> Gesti√≥n efectiva de situaciones dif√≠ciles</li>
                        <li><span class="legend-color" style="background-color: #9966ff;"></span><strong>Autoconfianza:</strong> Seguridad en las propias capacidades</li>
                    </ul>
                </div>
            </div>
            <button class="btn" onclick="restartAssessment()">Realizar Nueva Evaluaci√≥n</button>
        </div>

        <!-- Mensajes de Error/√âxito -->
        <div id="messageContainer"></div>
    </div>

    <script>
        // URL del backend en Render
        const API_BASE_URL = 'https://assessment-platform-1nuo.onrender.com';
        
        let currentUser = null;
        let questions = [];
        let currentQuestionIndex = 0;
        let answers = {};

        // Funci√≥n para mostrar mensajes
        function showMessage(message, type = 'error') {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Preguntas de asertividad (fallback local) - SINCRONIZADO CON RENDER (10 preguntas)
        const TEMP_QUESTIONS = [
            {
                id: 1,
                content: "Cuando alguien critica tu trabajo de manera injusta, ¬øc√≥mo sueles responder?",
                options: [
                    "Permanezco en silencio para evitar el conflicto",
                    "Me defiendo con calma y hechos",
                    "Me enojo y me pongo a la defensiva",
                    "Intento cambiar de tema"
                ],
                question_type: "multiple_choice"
            },
            {
                id: 2,
                content: "Si un amigo te pide dinero repetidamente y no lo devuelve, ¬øabordar√≠as este tema?",
                options: [
                    "No, evitar√≠a mencionarlo",
                    "S√≠, tendr√≠a una conversaci√≥n honesta al respecto",
                    "Dejar√≠a de prestar pero no lo hablar√≠a",
                    "Pondr√≠a excusas para no prestar m√°s"
                ],
                question_type: "multiple_choice"
            },
            {
                id: 3,
                content: "¬øCon qu√© frecuencia expresas tu opini√≥n en discusiones grupales?",
                options: [
                    "Rara vez - Suelo estar de acuerdo con la mayor√≠a",
                    "A menudo - Cuando el tema me importa mucho",
                    "Siempre - Hablo sin importar la opini√≥n de los dem√°s",
                    "A veces - Solo cuando me siento muy seguro"
                ],
                question_type: "multiple_choice"
            },
            {
                id: 4,
                content: "Cuando alguien se cuela delante de ti en una fila, ¬øqu√© sueles hacer?",
                options: [
                    "Dejo que se cuelen y evito el conflicto",
                    "Se√±alo educadamente que hay una fila",
                    "Los confronto agresivamente",
                    "No digo nada pero me frustro"
                ],
                question_type: "multiple_choice"
            },
            {
                id: 5,
                content: "¬øC√≥mo manejas las solicitudes que no quieres cumplir?",
                options: [
                    "Digo que s√≠ aunque no quiera",
                    "Digo que no de forma clara y directa",
                    "Evito a la persona o la situaci√≥n",
                    "Pongo excusas"
                ],
                question_type: "multiple_choice"
            },
            {
                id: 6,
                content: "Si tu comida en un restaurante no est√° preparada como la pediste, ¬øqu√© har√≠as?",
                options: [
                    "No digo nada pero dejo poca propina",
                    "Expreso mis inquietudes educadamente al camarero",
                    "Me quejo en voz alta y exijo ver al gerente",
                    "Nunca vuelvo al restaurante"
                ],
                question_type: "multiple_choice"
            },
            {
                id: 7,
                content: "¬øC√≥mo sueles reaccionar ante los cumplidos?",
                options: [
                    "Los minimizo o desv√≠o",
                    "Acepto los cumplidos con gratitud",
                    "Me siento muy inc√≥modo",
                    "Los rechazo completamente"
                ],
                question_type: "multiple_choice"
            },
            {
                id: 8,
                content: "Durante una reuni√≥n de equipo, ¬øc√≥mo respondes cuando no est√°s de acuerdo con una idea propuesta?",
                options: [
                    "Me quedo callado y acepto",
                    "Expreso mi desacuerdo respetuosamente y propongo alternativas",
                    "Discuto fuertemente en contra",
                    "Estoy de acuerdo en la reuni√≥n pero me quejo despu√©s"
                ],
                question_type: "multiple_choice"
            },
            {
                id: 9,
                content: "Si el comportamiento de un colega te molesta, ¬øqu√© har√≠as?",
                options: [
                    "No digo nada pero me resiento",
                    "Lo hablo directamente con la persona",
                    "Me enojo visiblemente y confronto",
                    "Doy indirectas sutiles"
                ],
                question_type: "multiple_choice"
            },
            {
                id: 10,
                content: "Cuando logras algo importante en el trabajo, ¬øc√≥mo lo manejas?",
                options: [
                    "No lo menciono en absoluto",
                    "Lo comparto con confianza cuando es apropiado",
                    "Hablo de ello constantemente",
                    "Espero que otros lo noten"
                ],
                question_type: "multiple_choice"
            }
        ];

        // Iniciar evaluaci√≥n con fallback offline
        async function startAssessment() {
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const age = document.getElementById('age').value;
            const gender = document.getElementById('gender').value;

            if (!name || !email || !age || !gender) {
                showMessage('Por favor, completa todos los campos.');
                return;
            }

            if (age < 16 || age > 100) {
                showMessage('La edad debe estar entre 16 y 100 a√±os.');
                return;
            }

            try {
                console.log('üöÄ Iniciando evaluaci√≥n...');
                
                // Intentar conexi√≥n con backend
                let onlineMode = true;
                try {
                    const loginResponse = await fetch(`${API_BASE_URL}/api/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            username: 'admin',
                            password: 'admin123'
                        })
                    });
                    
                    if (loginResponse.ok) {
                        console.log('‚úÖ Modo online - Backend conectado');
                        
                        const demoResponse = await fetch(`${API_BASE_URL}/api/demographics`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({
                                name: name,
                                email: email,
                                age: parseInt(age),
                                gender: gender
                            })
                        });
                        
                        if (demoResponse.ok) {
                            currentUser = await demoResponse.json();
                        }
                    } else {
                        throw new Error('Backend no disponible');
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è Modo offline - Usando evaluaci√≥n local');
                    onlineMode = false;
                    showMessage('Usando modo offline. La evaluaci√≥n funcionar√° normalmente.', 'info');
                }

                // Configurar usuario (online o offline)
                if (!currentUser) {
                    currentUser = {
                        id: 1,
                        name: name,
                        email: email,
                        age: parseInt(age),
                        gender: gender
                    };
                }

                // Usar preguntas integradas
                questions = TEMP_QUESTIONS;
                console.log(`‚úÖ ${questions.length} preguntas cargadas`);

                // Cambiar a vista de evaluaci√≥n
                document.getElementById('loginForm').classList.remove('active');
                document.getElementById('assessmentContainer').classList.add('active');
                
                // Inicializar evaluaci√≥n
                currentQuestionIndex = 0;
                answers = {};
                
                // Mostrar primera pregunta
                showQuestion();
                updateProgress();
                
                showMessage('¬°Evaluaci√≥n iniciada exitosamente!', 'success');
                console.log('üéØ Evaluaci√≥n iniciada con √©xito');
                
            } catch (error) {
                console.error('Error starting assessment:', error);
                showMessage('Error al iniciar la evaluaci√≥n. Por favor, int√©ntalo de nuevo.');
            }
        }

        // Mostrar pregunta actual
        function showQuestion() {
            const question = questions[currentQuestionIndex];
            const questionCard = document.getElementById('questionCard');
            
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuestions').textContent = questions.length;

            questionCard.innerHTML = `
                <div class="question-text">${question.content || question.text}</div>
                <div class="options">
                    ${question.options.map((option, index) => `
                        <div class="option" onclick="selectOption(${index})">
                            <input type="radio" name="question${question.id}" value="${index}" id="option${index}">
                            <label for="option${index}">${option}</label>
                        </div>
                    `).join('')}
                </div>
            `;

            // Actualizar botones de navegaci√≥n
            updateNavigationButtons();
        }

        // Seleccionar opci√≥n
        function selectOption(optionIndex) {
            answers[currentQuestionIndex] = optionIndex;
            
            // Quitar selecci√≥n anterior
            document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            
            // Marcar opci√≥n seleccionada
            document.querySelectorAll('.option')[optionIndex].classList.add('selected');
            
            // Habilitar bot√≥n siguiente
            document.getElementById('nextBtn').disabled = false;
            document.getElementById('finishBtn').disabled = false;
        }

        // Pregunta anterior
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion();
                updateProgress();
                
                // Mostrar selecci√≥n anterior si existe
                if (answers[currentQuestionIndex] !== undefined) {
                    selectOption(answers[currentQuestionIndex]);
                }
            }
        }

        // Pregunta siguiente
        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                showQuestion();
                updateProgress();
                
                // Mostrar selecci√≥n anterior si existe
                if (answers[currentQuestionIndex] !== undefined) {
                    selectOption(answers[currentQuestionIndex]);
                }
            }
        }

        // Actualizar botones de navegaci√≥n
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const finishBtn = document.getElementById('finishBtn');
            
            // Bot√≥n anterior
            prevBtn.style.display = currentQuestionIndex > 0 ? 'block' : 'none';
            
            // Bot√≥n siguiente vs finalizar
            if (currentQuestionIndex === questions.length - 1) {
                nextBtn.style.display = 'none';
                finishBtn.style.display = 'block';
                finishBtn.disabled = answers[currentQuestionIndex] === undefined;
            } else {
                nextBtn.style.display = 'block';
                finishBtn.style.display = 'none';
                nextBtn.disabled = answers[currentQuestionIndex] === undefined;
            }
        }

        // Actualizar barra de progreso
        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        // Completar evaluaci√≥n
        async function completeAssessment() {
            // Verificar que todas las preguntas est√©n respondidas
            if (Object.keys(answers).length < questions.length) {
                showMessage('Por favor, responde todas las preguntas antes de finalizar.');
                return;
            }

            try {
                // Mostrar pantalla de carga
                document.getElementById('assessmentContainer').style.display = 'none';
                document.getElementById('loadingScreen').style.display = 'block';
                
                // Simular procesamiento
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Calcular resultado general
                let score = 0;
                const totalQuestions = Object.keys(answers).length;
                
                Object.values(answers).forEach(answer => {
                    if (answer === 0) score += 4; // Respuesta asertiva
                    else if (answer === 1) score += 1; // Pasiva
                    else if (answer === 2) score += 2; // Agresiva
                    else score += 3; // Mixta
                });
                
                const percentage = Math.round((score / (totalQuestions * 4)) * 100);
                
                // Calcular puntuaciones por dimensiones
                const dimensionalScores = calculateDimensionalScores();
                
                let level, interpretation;
                if (percentage >= 80) {
                    level = "Muy Asertivo";
                    interpretation = "¬°Excelente! Tienes un nivel muy alto de asertividad. Sabes comunicarte de manera clara y directa, respetando tanto tus derechos como los de los dem√°s. Contin√∫a desarrollando estas habilidades.";
                } else if (percentage >= 60) {
                    level = "Asertivo";
                    interpretation = "¬°Muy bien! Tienes un buen nivel de asertividad. En la mayor√≠a de situaciones sabes expresar tus opiniones y necesidades de manera apropiada. Hay oportunidades para seguir mejorando.";
                } else if (percentage >= 40) {
                    level = "Moderadamente Asertivo";
                    interpretation = "Tienes un nivel moderado de asertividad. En algunas situaciones te expresas bien, pero en otras podr√≠as ser m√°s directo o m√°s diplom√°tico. Te beneficiar√≠as de desarrollar m√°s estas habilidades.";
                } else {
                    level = "Poco Asertivo";
                    interpretation = "Tu nivel de asertividad es bajo. Esto puede llevarte a situaciones de conflicto o frustraci√≥n. Te recomendamos trabajar en desarrollar habilidades de comunicaci√≥n asertiva para mejorar tus relaciones.";
                }
                
                // Mostrar resultados
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('resultsContainer').style.display = 'block';
                
                document.getElementById('scoreDisplay').textContent = percentage + '%';
                document.getElementById('levelDisplay').textContent = level;
                document.getElementById('interpretationDisplay').textContent = interpretation;
                
                // Crear gr√°fico de radar
                createRadarChart(dimensionalScores);
                
                console.log(`üéâ Evaluaci√≥n completada: ${percentage}% - ${level}`);
                console.log('üìä Puntuaciones por dimensiones:', dimensionalScores);
                
            } catch (error) {
                console.error('Error completing assessment:', error);
                document.getElementById('loadingScreen').style.display = 'none';
                showMessage('Error al procesar la evaluaci√≥n. Por favor, int√©ntalo de nuevo.');
            }
        }

        // Funci√≥n para calcular puntuaciones por dimensiones (para 10 preguntas)
        function calculateDimensionalScores() {
            // Mapeo de preguntas a dimensiones (basado en las 10 preguntas del sistema)
            const questionToDimension = {
                0: 'conflictos',       // Pregunta 1: cr√≠ticas injustas - manejo de conflictos
                1: 'derechos',         // Pregunta 2: dinero prestado - defensa de derechos
                2: 'opiniones',        // Pregunta 3: expresar opiniones en grupos
                3: 'derechos',         // Pregunta 4: alguien se cuela - defensa de derechos
                4: 'comunicacion',     // Pregunta 5: solicitudes no deseadas - comunicaci√≥n directa
                5: 'comunicacion',     // Pregunta 6: comida mal preparada - comunicaci√≥n directa
                6: 'autoconfianza',    // Pregunta 7: reaccionar a cumplidos - autoconfianza
                7: 'conflictos',       // Pregunta 8: desacuerdo en reuniones - manejo de conflictos
                8: 'conflictos',       // Pregunta 9: comportamiento molesto de colega
                9: 'autoconfianza'     // Pregunta 10: logros importantes - autoconfianza
            };

            const dimensionScores = {
                comunicacion: [],
                derechos: [],
                opiniones: [],
                conflictos: [],
                autoconfianza: []
            };

            // Agrupar respuestas por dimensi√≥n
            Object.entries(answers).forEach(([questionIndex, answer]) => {
                const dimension = questionToDimension[parseInt(questionIndex)];
                if (dimension) {
                    // Convertir respuesta a puntuaci√≥n (0=asertiva=4pts, 1=pasiva=1pt, 2=agresiva=2pts, 3=mixta=3pts)
                    let points = 4;
                    if (answer === 1) points = 1;      // Pasiva
                    else if (answer === 2) points = 2; // Agresiva  
                    else if (answer === 3) points = 3; // Mixta
                    // answer === 0 mantiene points = 4 (Asertiva)
                    
                    dimensionScores[dimension].push(points);
                }
            });

            // Para dimensiones sin preguntas espec√≠ficas, usar el promedio general
            const totalAnswers = Object.values(answers);
            let generalAverage = 0;
            if (totalAnswers.length > 0) {
                const generalSum = totalAnswers.reduce((sum, answer) => {
                    if (answer === 1) return sum + 1;      // Pasiva
                    else if (answer === 2) return sum + 2; // Agresiva  
                    else if (answer === 3) return sum + 3; // Mixta
                    else return sum + 4;                   // Asertiva
                }, 0);
                generalAverage = generalSum / totalAnswers.length;
            }

            // Calcular promedios y convertir a porcentajes
            const finalScores = {};
            Object.entries(dimensionScores).forEach(([dimension, scores]) => {
                if (scores.length > 0) {
                    const average = scores.reduce((sum, score) => sum + score, 0) / scores.length;
                    finalScores[dimension] = Math.round((average / 4) * 100); // Convertir a porcentaje
                } else {
                    // Si no hay preguntas espec√≠ficas para esta dimensi√≥n, usar promedio general
                    finalScores[dimension] = Math.round((generalAverage / 4) * 100);
                }
            });

            return finalScores;
        }

        // Variable global para almacenar la instancia del gr√°fico
        window.radarChartInstance = null;

        // Funci√≥n para crear el gr√°fico de radar
        function createRadarChart(dimensionalScores) {
            try {
                // Destruir gr√°fico anterior si existe
                if (window.radarChartInstance) {
                    window.radarChartInstance.destroy();
                }

                const ctx = document.getElementById('radarChart').getContext('2d');
                
                const data = {
                    labels: [
                        'Comunicaci√≥n\nDirecta',
                        'Defensa de\nDerechos', 
                        'Expresi√≥n de\nOpiniones',
                        'Manejo de\nConflictos',
                        'Autoconfianza'
                    ],
                    datasets: [{
                        label: 'Nivel de Asertividad',
                        data: [
                            dimensionalScores.comunicacion,
                            dimensionalScores.derechos,
                            dimensionalScores.opiniones,
                            dimensionalScores.conflictos,
                            dimensionalScores.autoconfianza
                        ],
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                };

                const config = {
                    type: 'radar',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            r: {
                                angleLines: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                },
                                pointLabels: {
                                    font: {
                                        size: 12,
                                        weight: 'bold'
                                    },
                                    color: '#4a5568'
                                },
                                ticks: {
                                    beginAtZero: true,
                                    max: 100,
                                    stepSize: 20,
                                    color: '#718096',
                                    backdropColor: 'transparent'
                                }
                            }
                        }
                    }
                };

                window.radarChartInstance = new Chart(ctx, config);
                console.log('‚úÖ Gr√°fico de radar creado exitosamente');

            } catch (error) {
                console.error('‚ùå Error creando gr√°fico de radar:', error);
            }
        }

        // Reiniciar evaluaci√≥n
        function restartAssessment() {
            // Limpiar datos
            currentUser = null;
            questions = [];
            currentQuestionIndex = 0;
            answers = {};
            
            // Destruir gr√°fico de radar si existe
            if (window.radarChartInstance) {
                window.radarChartInstance.destroy();
                window.radarChartInstance = null;
            }
            
            // Limpiar formulario
            document.getElementById('name').value = '';
            document.getElementById('email').value = '';
            document.getElementById('age').value = '';
            document.getElementById('gender').value = '';
            
            // Volver al formulario inicial
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('loginForm').classList.add('active');
            
            // Limpiar mensajes
            document.getElementById('messageContainer').innerHTML = '';
        }

        // Verificar conexi√≥n con el API al cargar la p√°gina
        window.addEventListener('load', async function() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`, { timeout: 5000 });
                if (response.ok) {
                    console.log('‚úÖ Conexi√≥n con API establecida');
                    showMessage('Conectado al servidor. Funcionalidad completa disponible.', 'success');
                } else {
                    throw new Error('API no disponible');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è API no disponible - Modo offline activo');
                showMessage('Modo offline activo. La evaluaci√≥n funcionar√° normalmente.', 'info');
            }
        });
        
        // √öltima sincronizaci√≥n: 2025-06-14 - Radar Chart integrado con 10 preguntas
        console.log('‚úÖ Plataforma sincronizada con gr√°fico de radar - Versi√≥n: 2025-06-14');
    </script>
</body>
</html>
